[{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\.eslintrc.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\config\\app.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\admin\\departments.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":246,"column":10,"nodeType":"CallExpression","messageId":"unexpected","endLine":246,"endColumn":77}],"suppressedMessages":[{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":149,"column":16,"nodeType":"Literal","endLine":149,"endColumn":69,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":162,"column":16,"nodeType":"Literal","endLine":162,"endColumn":69,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":167,"column":16,"nodeType":"Literal","endLine":167,"endColumn":63,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import apiClient from \"../config/apiClient.js\";\r\nimport showMessage from \"../components/toast.js\";\r\n\r\nclass DepartmentManager {\r\n\r\n  constructor() {\r\n    this.departments = [];\r\n    this.currentDepartment = null;\r\n    this.init();\r\n  }\r\n  async init() {\r\n    await this.loadDepartments();\r\n    this.setupEventListeners();\r\n    this.startStatusRefresh();\r\n  }\r\n  setupEventListeners() {\r\n    const form = document.getElementById(\"departmentForm\");\r\n    if (form) {\r\n      form.addEventListener(\"submit\", (e) => this.handleSubmit(e));\r\n    }\r\n    // Auto-format department code\r\n    const codeInput = document.getElementById(\"departmentCode\");\r\n    if (codeInput) {\r\n      codeInput.addEventListener(\"input\", (e) => {\r\n        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9_]/g, \"\");\r\n      });\r\n    }\r\n  }\r\n  async loadDepartments() {\r\n    try {\r\n      const response = await apiClient.get(\"/api/departments/active\");\r\n      if (response.success) {\r\n        this.departments = response.data;\r\n        // Load officers for each department\r\n        await this.loadOfficersForAllDepartments();\r\n        this.renderDepartments();\r\n        this.updateStats();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to load departments:\", error);\r\n      showMessage(\"error\", \"Failed to load departments\");\r\n    }\r\n  }\r\n  async loadOfficersForAllDepartments() {\r\n    const promises = this.departments.map(async (dept) => {\r\n      try {\r\n        const response = await apiClient.getDepartmentOfficers(dept.id);\r\n        if (response.success) {\r\n          dept.officers = response.data.map(officer => ({\r\n            ...officer,\r\n            lastSeenText: this.getLastSeenText(officer.last_sign_in_at),\r\n            statusClass: this.getStatusClass(officer.is_online, officer.last_sign_in_at)\r\n          }));\r\n          dept.officersVisible = false; // Initially hidden\r\n        } else {\r\n          dept.officers = [];\r\n          dept.officersVisible = false;\r\n        }\r\n      } catch (error) {\r\n        console.error(`Failed to load officers for department ${dept.name}:`, error);\r\n        dept.officers = [];\r\n        dept.officersVisible = false;\r\n      }\r\n    });\r\n    await Promise.all(promises);\r\n  }\r\n  renderDepartments() {\r\n    const grid = document.getElementById(\"departmentGrid\");\r\n    if (!grid) return;\r\n    // Use safer DOM manipulation instead of innerHTML\r\n    grid.innerHTML = \"\";\r\n    const safeHtml = this.departments.map(dept => `\r\n      <div class=\"department-card\">\r\n        <div class=\"department-header\">\r\n          <span class=\"department-code\">${dept.code}</span>\r\n          <span class=\"status-badge ${dept.is_active ? \"status-active\" : \"status-inactive\"}\">\r\n            ${dept.is_active ? \"Active\" : \"Inactive\"}\r\n          </span>\r\n        </div>\r\n        <h3>${dept.name}</h3>\r\n        <p>${dept.description || \"No description provided\"}</p>\r\n\r\n        <div class=\"officers-section\" id=\"officers-${dept.id}\">\r\n          <div class=\"officers-header\">\r\n            <h4>Officers (${dept.officers ? dept.officers.length : 0})</h4>\r\n            <button class=\"toggle-officers\" onclick=\"departmentManager.toggleOfficers(${dept.id})\">\r\n              ${dept.officersVisible ? \"Hide\" : \"Show\"} Officers\r\n            </button>\r\n          </div>\r\n          <div class=\"officers-list\" style=\"display: ${dept.officersVisible ? \"grid\" : \"none\"}\">\r\n            ${dept.officers && dept.officers.length > 0 ?\r\n    dept.officers.map(officer => `\r\n                <div class=\"officer-item\">\r\n                  <div class=\"officer-status\">\r\n                    <div class=\"officer-avatar\">${officer.name.charAt(0).toUpperCase()}</div>\r\n                    <div class=\"status-indicator ${officer.statusClass}\"></div>\r\n                  </div>\r\n                  <div class=\"officer-info\">\r\n                    <p class=\"officer-name\">${officer.name}</p>\r\n                    <p class=\"officer-role\">${officer.role || \"Officer\"}</p>\r\n                    <p class=\"officer-status-text ${officer.statusClass}-text\">\r\n                      ${officer.is_online ? \"Online\" : \"Offline\"}\r\n                    </p>\r\n                    <p class=\"officer-last-seen\">${officer.lastSeenText}</p>\r\n                  </div>\r\n                </div>\r\n              `).join(\"\") :\r\n    '<div class=\"no-officers\">No officers assigned to this department</div>'\r\n}\r\n          </div>\r\n        </div>\r\n        <div class=\"department-actions\">\r\n          <button class=\"btn btn-sm btn-primary\" onclick=\"departmentManager.editDepartment(${dept.id})\">\r\n            Edit\r\n          </button>\r\n          <button class=\"btn btn-sm ${dept.is_active ? \"btn-warning\" : \"btn-success\"}\"\r\n                  onclick=\"departmentManager.toggleStatus(${dept.id})\">\r\n            ${dept.is_active ? \"Deactivate\" : \"Activate\"}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    `).join(\"\");\r\n\r\n    // Use safer approach - create elements directly\r\n    const parser = new DOMParser();\r\n    const doc = parser.parseFromString(this.sanitizeHtml(safeHtml), \"text/html\");\r\n    const fragment = document.createDocumentFragment();\r\n    Array.from(doc.body.children).forEach(child => fragment.appendChild(child.cloneNode(true)));\r\n    grid.appendChild(fragment);\r\n  }\r\n  // Enhanced HTML sanitization function\r\n  sanitizeHtml(html) {\r\n    if (!html || typeof html !== \"string\") return \"\";\r\n    // Use DOMPurify for comprehensive sanitization\r\n    if (typeof DOMPurify !== \"undefined\") {\r\n      return DOMPurify.sanitize(html, {\r\n        ALLOWED_TAGS: [\"div\", \"span\", \"p\", \"h1\", \"h2\", \"h3\", \"h4\", \"h5\", \"h6\", \"strong\", \"em\", \"b\", \"i\", \"u\", \"br\", \"hr\", \"ul\", \"ol\", \"li\", \"a\", \"img\"],\r\n        ALLOWED_ATTR: [\"class\", \"id\", \"style\", \"href\", \"src\", \"alt\", \"title\", \"data-*\"],\r\n        ALLOW_DATA_ATTR: true,\r\n        ALLOW_UNKNOWN_PROTOCOLS: false,\r\n        SANITIZE_DOM: true,\r\n        KEEP_CONTENT: true\r\n      });\r\n    }\r\n    // Fallback sanitization if DOMPurify is not available\r\n    return html\r\n      // Remove script tags and their content\r\n      // eslint-disable-next-line security/detect-unsafe-regex\r\n      .replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, \"\")\r\n      // Remove event handlers\r\n      .replace(/on\\w+\\s*=\\s*[\"'][^\"']*[\"']/gi, \"\")\r\n      // Remove javascript: URLs\r\n      .replace(/javascript\\s*:/gi, \"\")\r\n      // Remove vbscript: URLs\r\n      .replace(/vbscript\\s*:/gi, \"\")\r\n      // Remove data: URLs (except safe image types)\r\n      .replace(/data\\s*:(?!image\\/(png|jpg|jpeg|gif|svg|webp))/gi, \"\")\r\n      // Remove iframe tags\r\n      .replace(/<iframe\\b[^<]*>.*?<\\/iframe>/gi, \"\")\r\n      // Remove object tags\r\n      // eslint-disable-next-line security/detect-unsafe-regex\r\n      .replace(/<object\\b[^<]*(?:(?!<\\/object>)<[^<]*)*<\\/object>/gi, \"\")\r\n      // Remove embed tags\r\n      .replace(/<embed\\b[^<]*>/gi, \"\")\r\n      // Remove form tags\r\n      // eslint-disable-next-line security/detect-unsafe-regex\r\n      .replace(/<form\\b[^<]*(?:(?!<\\/form>)<[^<]*)*<\\/form>/gi, \"\")\r\n      // Remove input tags\r\n      .replace(/<input\\b[^<]*>/gi, \"\")\r\n      // Remove button tags with onclick\r\n      .replace(/<button\\b[^<]*onclick[^<]*>/gi, \"<button>\")\r\n      // Remove style attributes with javascript\r\n      .replace(/style\\s*=\\s*[\"'][^\"']*javascript[^\"']*[\"']/gi, \"\")\r\n      // Remove href with javascript\r\n      .replace(/href\\s*=\\s*[\"']javascript[^\"']*[\"']/gi, 'href=\"#\"')\r\n      // Remove src with javascript\r\n      .replace(/src\\s*=\\s*[\"']javascript[^\"']*[\"']/gi, \"\");\r\n  }\r\n  updateStats() {\r\n    const totalElement = document.getElementById(\"totalCount\");\r\n    const activeElement = document.getElementById(\"activeCount\");\r\n    if (totalElement) totalElement.textContent = this.departments.length;\r\n    if (activeElement) {\r\n      activeElement.textContent = this.departments.filter(d => d.is_active).length;\r\n    }\r\n  }\r\n  async handleSubmit(e) {\r\n    e.preventDefault();\r\n    const formData = new FormData(e.target);\r\n    const data = {\r\n      name: formData.get(\"name\"),\r\n      code: formData.get(\"code\"),\r\n      description: formData.get(\"description\"),\r\n      is_active: formData.has(\"is_active\")\r\n    };\r\n    try {\r\n      let response;\r\n      if (this.currentDepartment) {\r\n        response = await apiClient.put(`/api/departments/${this.currentDepartment.id}`, data);\r\n      } else {\r\n        response = await apiClient.post(\"/api/departments\", data);\r\n      }\r\n      if (response.success) {\r\n        showMessage(\"success\", response.message);\r\n        this.closeModal();\r\n        await this.loadDepartments();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Department operation failed:\", error);\r\n      showMessage(\"error\", error.message || \"Operation failed\");\r\n    }\r\n  }\r\n  openModal(mode = \"add\", department = null) {\r\n    this.currentDepartment = department;\r\n    const modal = document.getElementById(\"departmentModal\");\r\n    const title = document.getElementById(\"modalTitle\");\r\n    const form = document.getElementById(\"departmentForm\");\r\n    if (mode === \"edit\" && department) {\r\n      title.textContent = \"Edit Department\";\r\n      document.getElementById(\"departmentName\").value = department.name;\r\n      document.getElementById(\"departmentCode\").value = department.code;\r\n      document.getElementById(\"departmentDescription\").value = department.description || \"\";\r\n      document.getElementById(\"departmentActive\").checked = department.is_active;\r\n    } else {\r\n      title.textContent = \"Add Department\";\r\n      form.reset();\r\n    }\r\n    modal.style.display = \"block\";\r\n  }\r\n  closeModal() {\r\n    const modal = document.getElementById(\"departmentModal\");\r\n    modal.style.display = \"none\";\r\n    this.currentDepartment = null;\r\n  }\r\n  editDepartment(id) {\r\n    const department = this.departments.find(d => d.id === id);\r\n    if (department) {\r\n      this.openModal(\"edit\", department);\r\n    }\r\n  }\r\n  async toggleStatus(id) {\r\n    const department = this.departments.find(d => d.id === id);\r\n    if (!department) return;\r\n    const newStatus = !department.is_active;\r\n    const action = newStatus ? \"activate\" : \"deactivate\";\r\n    if (!confirm(`Are you sure you want to ${action} \"${department.name}\"?`)) {\r\n      return;\r\n    }\r\n    try {\r\n      const response = await apiClient.put(`/api/departments/${id}`, {\r\n        is_active: newStatus\r\n      });\r\n      if (response.success) {\r\n        showMessage(\"success\", `Department ${action}d successfully`);\r\n        await this.loadDepartments();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Status toggle failed:\", error);\r\n      showMessage(\"error\", error.message || \"Operation failed\");\r\n    }\r\n  }\r\n  toggleOfficers(departmentId) {\r\n    const department = this.departments.find(d => d.id === departmentId);\r\n    if (!department) return;\r\n    department.officersVisible = !department.officersVisible;\r\n    this.renderDepartments();\r\n  }\r\n  getLastSeenText(lastSignInAt) {\r\n    if (!lastSignInAt) return \"Never\";\r\n    const lastSignIn = new Date(lastSignInAt);\r\n    const now = new Date();\r\n    const diffInMinutes = Math.floor((now - lastSignIn) / (1000 * 60));\r\n    if (diffInMinutes < 1) return \"Just now\";\r\n    if (diffInMinutes < 60) return `${diffInMinutes}m ago`;\r\n    const diffInHours = Math.floor(diffInMinutes / 60);\r\n    if (diffInHours < 24) return `${diffInHours}h ago`;\r\n    const diffInDays = Math.floor(diffInHours / 24);\r\n    if (diffInDays < 7) return `${diffInDays}d ago`;\r\n    return lastSignIn.toLocaleDateString();\r\n  }\r\n  getStatusClass(isOnline, lastSignInAt) {\r\n    if (isOnline) return \"status-online\";\r\n    if (!lastSignInAt) return \"status-offline\";\r\n    const lastSignIn = new Date(lastSignInAt);\r\n    const now = new Date();\r\n    const diffInMinutes = (now - lastSignIn) / (1000 * 60);\r\n\r\n    // Consider \"away\" if last seen within 1 hour but not online\r\n    if (diffInMinutes < 60) return \"status-away\";\r\n    return \"status-offline\";\r\n  }\r\n  startStatusRefresh() {\r\n    // Refresh status every 2 minutes\r\n    setInterval(() => {\r\n      this.refreshOfficerStatus();\r\n    }, 2 * 60 * 1000);\r\n  }\r\n  async refreshOfficerStatus() {\r\n    // Only refresh if officers are visible\r\n    const hasVisibleOfficers = this.departments.some(dept => dept.officersVisible);\r\n    if (!hasVisibleOfficers) return;\r\n    try {\r\n      // Reload officers for all departments\r\n      await this.loadOfficersForAllDepartments();\r\n      this.renderDepartments();\r\n    } catch (error) {\r\n      console.error(\"Failed to refresh officer status:\", error);\r\n    }\r\n  }\r\n}\r\n// Global functions for onclick handlers\r\nwindow.openModal = (mode) => {\r\n  if (window.departmentManager) {\r\n    window.departmentManager.openModal(mode);\r\n  }\r\n};\r\nwindow.closeModal = () => {\r\n  if (window.departmentManager) {\r\n    window.departmentManager.closeModal();\r\n  }\r\n};\r\nwindow.toggleOfficers = (departmentId) => {\r\n  if (window.departmentManager) {\r\n    window.departmentManager.toggleOfficers(departmentId);\r\n  }\r\n};\r\n// Initialize when DOM is loaded\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  window.departmentManager = new DepartmentManager();\r\n});\r\n// Close modal when clicking outside\r\nwindow.addEventListener(\"click\", (e) => {\r\n  const modal = document.getElementById(\"departmentModal\");\r\n  if (e.target === modal) {\r\n    window.departmentManager?.closeModal();\r\n  }\r\n});\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\auth\\auth.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'addCsrfTokenToForm' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":28},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":466,"column":15,"nodeType":"CallExpression","messageId":"returnsValue","endLine":466,"endColumn":80,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[16798,16863],"text":"{setTimeout(() => reject(new Error(\"Session sync timeout\")), 3000)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":490,"column":38,"nodeType":"CallExpression","messageId":"returnsValue","endLine":490,"endColumn":56,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[17809,17827],"text":"{setTimeout(r, 100)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":502,"column":32,"nodeType":"CallExpression","messageId":"returnsValue","endLine":502,"endColumn":51,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[18264,18283],"text":"{setTimeout(r, 2000)}"},"desc":"Wrap the expression in `{}`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// login, register, change pass, and additional social media\r\nimport { supabase } from \"../config/config.js\";\r\nimport showMessage from \"../components/toast.js\";\r\nimport {\r\n  saveUserMeta,\r\n  getOAuthContext,\r\n  setOAuthContext,\r\n} from \"./authChecker.js\";\r\nimport { setButtonLoading, temporarilyMark } from \"../utils/buttonState.js\";\r\nimport { addCsrfTokenToForm } from \"../utils/csrf.js\";\r\nimport { validateAndSanitizeForm, isValidEmail } from \"../utils/validation.js\";\r\n\r\n// Show toast on login page if redirected due to missing auth\r\ntry {\r\n  const isLoginPage = /\\/login(?:$|\\?)/.test(\r\n    window.location.pathname + window.location.search\r\n  );\r\n  if (isLoginPage) {\r\n    const params = new URLSearchParams(window.location.search);\r\n    const err = params.get(\"err\");\r\n    if (err === \"not_authenticated\") {\r\n      showMessage(\"error\", \"Please log in to continue\");\r\n    }\r\n  }\r\n} catch {}\r\n\r\nexport const retrieveUserRole = async () => {};\r\n\r\n// reCAPTCHA setup\r\nlet loginCaptchaWidgetId = null;\r\nlet registerCaptchaWidgetId = null;\r\nlet siteKey = \"\";\r\n// Fetch CAPTCHA key securely from server\r\nasync function getCaptchaKey() {\r\n  try {\r\n    const response = await fetch(\"/api/captcha/key\");\r\n    const data = await response.json();\r\n    return data.key || \"\";\r\n  } catch (error) {\r\n    console.error(\"Failed to fetch CAPTCHA key:\", error);\r\n    return \"\";\r\n  }\r\n}\r\nasync function renderCaptchaWidgetsIfAny() {\r\n  // Skip reCAPTCHA in development mode\r\n  if (\r\n    window.location.hostname === \"localhost\" ||\r\n    window.location.hostname === \"127.0.0.1\"\r\n  ) {\r\n    // console.log removed for security\r\n    return;\r\n  }\r\n  if (!window.grecaptcha) return;\r\n  // Fetch CAPTCHA key if not already loaded\r\n  if (!siteKey) {\r\n    siteKey = await getCaptchaKey();\r\n  }\r\n  if (!siteKey) return;\r\n  window.grecaptcha.ready(() => {\r\n    const loginEl = document.getElementById(\"login-captcha\");\r\n    if (loginEl && loginCaptchaWidgetId === null) {\r\n      loginCaptchaWidgetId = window.grecaptcha.render(loginEl, {\r\n        sitekey: siteKey,\r\n      });\r\n    }\r\n    const regEl = document.getElementById(\"register-captcha\");\r\n    if (regEl && registerCaptchaWidgetId === null) {\r\n      registerCaptchaWidgetId = window.grecaptcha.render(regEl, {\r\n        sitekey: siteKey,\r\n      });\r\n    }\r\n  });\r\n}\r\n// Try render on load and after a short delay to cover async script load\r\nrenderCaptchaWidgetsIfAny();\r\nsetTimeout(renderCaptchaWidgetsIfAny, 500);\r\nasync function verifyCaptchaOrFail(widgetId) {\r\n  // Skip reCAPTCHA verification in development mode\r\n  if (\r\n    window.location.hostname === \"localhost\" ||\r\n    window.location.hostname === \"127.0.0.1\"\r\n  ) {\r\n    // console.log removed for security\r\n    return { ok: true };\r\n  }\r\n  if (!widgetId && widgetId !== 0) {\r\n    showMessage(\"error\", \"Captcha not ready. Please wait and try again.\");\r\n    return { ok: false };\r\n  }\r\n  const token = window.grecaptcha\r\n    ? window.grecaptcha.getResponse(widgetId)\r\n    : \"\";\r\n  if (!token) {\r\n    showMessage(\"error\", \"Please complete the captcha.\");\r\n    return { ok: false };\r\n  }\r\n  try {\r\n    const res = await fetch(\"/api/captcha/verify\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ token }),\r\n    });\r\n    const json = await res.json();\r\n    if (json && json.success) {\r\n      return { ok: true };\r\n    }\r\n    showMessage(\"error\", \"Captcha verification failed. Please try again.\");\r\n    return { ok: false };\r\n  } catch (_err) {\r\n    showMessage(\"error\", \"Captcha verification error. Please try again.\");\r\n    return { ok: false };\r\n  } finally {\r\n    if (window.grecaptcha) {\r\n      try {\r\n        window.grecaptcha.reset(widgetId);\r\n      } catch (_e) {}\r\n    }\r\n  }\r\n}\r\nconst regFormEl = document.getElementById(\"regForm\");\r\n\r\n// Form persistence logic for registration\r\nconst REG_FORM_STORAGE_KEY = \"cl_reg_form_data\";\r\n\r\nfunction saveRegFormData() {\r\n  if (!regFormEl) return;\r\n\r\n  const formData = new FormData(regFormEl);\r\n  const dataToSave = {};\r\n\r\n  for (const [key, value] of formData.entries()) {\r\n    // Don't save sensitive fields\r\n    if (key !== \"regPassword\" && key !== \"reRegPassword\") {\r\n      dataToSave[key] = value;\r\n    }\r\n  }\r\n\r\n  try {\r\n    sessionStorage.setItem(REG_FORM_STORAGE_KEY, JSON.stringify(dataToSave));\r\n  } catch (e) {\r\n    console.warn(\"Failed to save registration form data:\", e);\r\n  }\r\n}\r\n\r\nfunction loadRegFormData() {\r\n  if (!regFormEl) return;\r\n\r\n  try {\r\n    const savedData = sessionStorage.getItem(REG_FORM_STORAGE_KEY);\r\n    if (!savedData) return;\r\n\r\n    const parsedData = JSON.parse(savedData);\r\n\r\n    Object.keys(parsedData).forEach((key) => {\r\n      const input = regFormEl.querySelector(`[name=\"${key}\"]`);\r\n      if (input && input.type !== \"file\") {\r\n        // Skip file inputs\r\n        input.value = parsedData[key];\r\n        // Trigger input event to ensure UI updates (like floating labels)\r\n        input.dispatchEvent(new Event(\"input\", { bubbles: true }));\r\n      }\r\n    });\r\n  } catch (e) {\r\n    console.warn(\"Failed to load registration form data:\", e);\r\n  }\r\n}\r\n\r\nfunction clearRegFormData() {\r\n  try {\r\n    sessionStorage.removeItem(REG_FORM_STORAGE_KEY);\r\n    sessionStorage.removeItem(\"cl_signup_step_index\"); // Clear step index too\r\n  } catch (e) {\r\n    console.warn(\"Failed to clear registration form data:\", e);\r\n  }\r\n}\r\n\r\n// Initialize persistence if form exists\r\nif (regFormEl) {\r\n  // Load saved data on init\r\n  loadRegFormData();\r\n\r\n  // Save data on input changes\r\n  regFormEl.addEventListener(\"input\", (e) => {\r\n    // Debounce saving if needed, but for now direct save is fine for simple text\r\n    if (e.target.name !== \"regPassword\" && e.target.name !== \"reRegPassword\") {\r\n      saveRegFormData();\r\n    }\r\n  });\r\n\r\n  regFormEl.addEventListener(\"submit\", async (e) => {\r\n    e.preventDefault(); // prevent page refresh\r\n    regFormEl.classList.add(\"was-validated\");\r\n    const firstName = document.getElementById(\"firstName\")?.value.trim() || \"\";\r\n    const middleName =\r\n      document.getElementById(\"middleName\")?.value.trim() || \"\";\r\n    const lastName = document.getElementById(\"lastName\")?.value.trim() || \"\";\r\n    const email = document.getElementById(\"email\").value.trim();\r\n    const mobile = document.getElementById(\"mobile\").value.trim();\r\n    const addressLine1 =\r\n      document.getElementById(\"addressLine1\")?.value.trim() || \"\";\r\n    const addressLine2 =\r\n      document.getElementById(\"addressLine2\")?.value.trim() || \"\";\r\n    const barangay = document.getElementById(\"barangay\")?.value.trim() || \"\";\r\n    const gender = document.getElementById(\"gender\")?.value || \"\";\r\n    const regPass = document.getElementById(\"regPassword\").value;\r\n    const reRegPass = document.getElementById(\"reRegPassword\").value;\r\n    // Early password length checks\r\n    if (!regPass || regPass.length < 8) {\r\n      showMessage(\"error\", \"Password must be at least 8 characters long\");\r\n      return;\r\n    }\r\n    // Validate form data\r\n    const validationRules = {\r\n      firstName: { required: true, minLength: 1, maxLength: 100 },\r\n      middleName: { required: false, minLength: 0, maxLength: 100 },\r\n      lastName: { required: true, minLength: 1, maxLength: 100 },\r\n      email: { required: true, type: \"email\" },\r\n      mobile: { required: true, type: \"mobile\" },\r\n      regPassword: { required: true, type: \"password\" },\r\n      addressLine1: { required: false, minLength: 0, maxLength: 255 },\r\n      addressLine2: { required: false, minLength: 0, maxLength: 255 },\r\n      barangay: { required: false, minLength: 0, maxLength: 100 },\r\n      gender: { required: false },\r\n    };\r\n    const formData = {\r\n      firstName,\r\n      middleName,\r\n      lastName,\r\n      email,\r\n      mobile,\r\n      regPassword: regPass,\r\n      addressLine1,\r\n      addressLine2,\r\n      barangay,\r\n      gender,\r\n    };\r\n    const validation = validateAndSanitizeForm(formData, validationRules);\r\n    if (!validation.isValid) {\r\n      showMessage(\"error\", validation.errors.join(\", \"));\r\n      return;\r\n    }\r\n    // Additional password confirmation check\r\n    if (reRegPass !== regPass) {\r\n      showMessage(\"error\", \"Passwords don't match\");\r\n      return;\r\n    }\r\n\r\n    // verify captcha\r\n    const captchaResult = await verifyCaptchaOrFail(registerCaptchaWidgetId);\r\n    if (!captchaResult.ok) return;\r\n\r\n    try {\r\n      const submitBtn = regFormEl.querySelector(\r\n        'button[type=\"submit\"], .btn-primary, .btn'\r\n      );\r\n      const resetBtn = setButtonLoading(submitBtn, \"Creating account...\");\r\n      // Build JSON payload (role defaults to 'citizen' on backend)\r\n      const payload = {\r\n        email: validation.sanitizedData.email,\r\n        password: regPass,\r\n        confirmPassword: reRegPass,\r\n        firstName: validation.sanitizedData.firstName,\r\n        middleName: validation.sanitizedData.middleName || \"\",\r\n        lastName: validation.sanitizedData.lastName,\r\n        mobileNumber: `+63${validation.sanitizedData.mobile}`,\r\n        gender: validation.sanitizedData.gender || \"\",\r\n        address: {\r\n          line1: validation.sanitizedData.addressLine1 || \"\",\r\n          line2: validation.sanitizedData.addressLine2 || \"\",\r\n          barangay: validation.sanitizedData.barangay || \"\",\r\n        },\r\n        // role: 'citizen', // backend defaults to citizen\r\n        agreedToTerms: true,\r\n        isOAuth: false, // Regular signup\r\n        verificationToken: sessionStorage.getItem(\"cl_verification_token\"), // Send proof of ID verification\r\n      };\r\n      // Submit via API instead of direct Supabase call\r\n      const response = await fetch(\"/api/auth/signup\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      const result = await response.json();\r\n      // Be tolerant of API variations: treat 2xx with clear success message as success\r\n      const successMessage =\r\n        result && result.message ? String(result.message) : \"\";\r\n      const isHttpSuccess = response.ok; // includes 201\r\n      const isApiSuccess = result && result.success === true;\r\n      const looksLikeSuccess =\r\n        /account created|verify your email|verification email/i.test(\r\n          successMessage\r\n        );\r\n      if (isHttpSuccess && (isApiSuccess || looksLikeSuccess)) {\r\n        // SECURITY: Tokens are no longer in response, Supabase session is managed server-side\r\n        // Server sets HttpOnly cookie, client relies on that for authentication\r\n        // No need to manually set session here as server handles it\r\n        showMessage(\r\n          \"success\",\r\n          \"Successfully registered. Please confirm via the email we sent.\"\r\n        );\r\n        clearRegFormData(); // Clear saved form data\r\n        temporarilyMark(submitBtn, \"Success\", \"btn-success\");\r\n        resetBtn();\r\n        setTimeout(() => {\r\n          window.location.href = \"/login\";\r\n        }, 3000);\r\n      } else {\r\n        const errMsg = (\r\n          result && result.error ? String(result.error) : \"\"\r\n        ).toLowerCase();\r\n        if (\r\n          errMsg.includes(\"already registered\") ||\r\n          errMsg.includes(\"already exists\") ||\r\n          errMsg.includes(\"duplicate\") ||\r\n          errMsg.includes(\"email is used\") ||\r\n          errMsg.includes(\"email taken\") ||\r\n          errMsg.includes(\"email already exist\")\r\n        ) {\r\n          showMessage(\"error\", \"Email already exist\");\r\n        } else {\r\n          showMessage(\r\n            \"error\",\r\n            result.error || successMessage || \"Registration failed\"\r\n          );\r\n        }\r\n        temporarilyMark(submitBtn, \"Failed\", \"btn-danger\");\r\n        resetBtn();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Registration error:\", error);\r\n      showMessage(\"error\", \"Registration failed. Please try again.\");\r\n      try {\r\n        const submitBtn = regFormEl.querySelector(\r\n          'button[type=\"submit\"], .btn-primary, .btn'\r\n        );\r\n        temporarilyMark(submitBtn, \"Failed\", \"btn-danger\");\r\n      } catch {}\r\n      try {\r\n        const _submitBtn = regFormEl.querySelector(\r\n          'button[type=\"submit\"], .btn-primary, .btn'\r\n        );\r\n      } catch {}\r\n    }\r\n  });\r\n}\r\nconst loginFormEl = document.getElementById(\"login\");\r\nif (loginFormEl)\r\n  loginFormEl.addEventListener(\"submit\", async (e) => {\r\n    e.preventDefault();\r\n    loginFormEl.classList.add(\"was-validated\");\r\n    const email = document.getElementById(\"email\").value;\r\n    const pass = document.getElementById(\"password\").value;\r\n    const remember = document.getElementById(\"remember-me\")?.checked || false;\r\n\r\n    // Store device trust preference\r\n    try {\r\n      const { setDeviceTrusted } = await import(\"./authChecker.js\");\r\n      setDeviceTrusted(remember);\r\n    } catch (error) {\r\n      console.error(\"[AUTH] Failed to set device trust preference:\", error);\r\n    }\r\n    // Get login button elements\r\n    const loginBtn = document.getElementById(\"login-submit-btn\");\r\n    const loginBtnIcon = document.getElementById(\"login-btn-icon\");\r\n    const loginBtnText = document.getElementById(\"login-btn-text\");\r\n    // Function to show loading state\r\n    const showLoading = () => {\r\n      if (!loginBtn || !loginBtnIcon) return;\r\n\r\n      // Store original icon HTML only if not already stored\r\n      // This prevents overwriting with the spinner if called multiple times\r\n      if (!loginBtn.dataset.originalIcon) {\r\n        const originalIcon = loginBtnIcon.outerHTML;\r\n        loginBtn.dataset.originalIcon = originalIcon;\r\n      }\r\n\r\n      // Replace icon with loading spinner (CSS animation will handle rotation)\r\n      loginBtnIcon.innerHTML = `\r\n      <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"2\" fill=\"none\" opacity=\"0.3\"/>\r\n      <path d=\"M12 2 A10 10 0 0 1 22 12\" stroke=\"currentColor\" stroke-width=\"2\" fill=\"none\" stroke-linecap=\"round\" stroke-dasharray=\"15 10\"/>\r\n    `;\r\n      loginBtnIcon.classList.add(\"spinning\");\r\n      // Disable button\r\n      loginBtn.disabled = true;\r\n      loginBtnText.textContent = \"Signing in...\";\r\n    };\r\n\r\n    // Function to hide loading state\r\n    const hideLoading = () => {\r\n      if (!loginBtn) return;\r\n\r\n      // Get current icon element (might have been replaced)\r\n      const currentIcon = document.getElementById(\"login-btn-icon\");\r\n      if (currentIcon && loginBtn.dataset.originalIcon) {\r\n        // Restore original icon\r\n        const originalIconHtml = loginBtn.dataset.originalIcon;\r\n        const tempDiv = document.createElement(\"div\");\r\n        tempDiv.innerHTML = originalIconHtml;\r\n        const restoredIcon = tempDiv.firstElementChild;\r\n        if (restoredIcon) {\r\n          currentIcon.parentNode.replaceChild(restoredIcon, currentIcon);\r\n        }\r\n        // Clear the stored icon so we can capture it fresh next time if needed\r\n        // (though keeping it is also fine, clearing is safer for state resets)\r\n        delete loginBtn.dataset.originalIcon;\r\n      }\r\n\r\n      // Remove spinning class if it exists\r\n      if (currentIcon) {\r\n        currentIcon.classList.remove(\"spinning\");\r\n      }\r\n\r\n      // Re-enable button\r\n      loginBtn.disabled = false;\r\n      if (loginBtnText) {\r\n        loginBtnText.textContent = \"Sign in\";\r\n      }\r\n    };\r\n\r\n    // Basic validation\r\n    if (!email || !pass) {\r\n      showMessage(\"error\", \"Email and password are required\");\r\n      return;\r\n    }\r\n\r\n    if (!isValidEmail(email)) {\r\n      showMessage(\"error\", \"Please enter a valid email address\");\r\n      return;\r\n    }\r\n\r\n    // Show loading state\r\n    showLoading();\r\n\r\n    // verify captcha\r\n    const captchaResult = await verifyCaptchaOrFail(loginCaptchaWidgetId);\r\n    if (!captchaResult.ok) {\r\n      hideLoading();\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Submit via API with JSON body\r\n      const response = await fetch(\"/api/auth/login\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ email, password: pass, remember }),\r\n      });\r\n\r\n      const result = await response.json();\r\n\r\n      if (result.success) {\r\n        // SECURITY: Server handles all authentication and sets HttpOnly cookie\r\n        // Client syncs Supabase session state using refresh token from server response\r\n        try {\r\n          // Server already authenticated and set cookie, now sync client-side Supabase session\r\n          const refreshToken = result.data?.refresh_token;\r\n\r\n          if (refreshToken) {\r\n            // Use refresh token to get full Supabase session without re-authenticating\r\n            // Wrap in timeout to prevent hanging\r\n            const syncPromise = supabase.auth.refreshSession({\r\n              refresh_token: refreshToken,\r\n            });\r\n\r\n            const timeoutPromise = new Promise((_, reject) =>\r\n              setTimeout(() => reject(new Error(\"Session sync timeout\")), 3000)\r\n            );\r\n\r\n            const { data: sessionData, error: refreshError } =\r\n              await Promise.race([syncPromise, timeoutPromise]).catch(\r\n                (err) => ({ error: err })\r\n              );\r\n\r\n            if (refreshError || !sessionData?.session) {\r\n              console.warn(\r\n                \"[CLIENT AUTH] ⚠️ Failed to sync Supabase session:\",\r\n                refreshError?.message || \"Unknown error\"\r\n              );\r\n              // Server cookie is still valid, continue with server-side auth only\r\n            }\r\n          } else {\r\n            console.warn(\r\n              \"[CLIENT AUTH] ⚠️ No refresh token in response, client-side Supabase features may be limited\"\r\n            );\r\n          }\r\n\r\n          // Verify session by hitting a protected endpoint\r\n          // Also wrapped in timeout/race to prevent blocking\r\n          const verifyPromise = async () => {\r\n            await new Promise((r) => setTimeout(r, 100)); // Brief wait for cookie\r\n            const resp = await fetch(\"/api/user/role\", {\r\n              method: \"GET\",\r\n              credentials: \"include\",\r\n              headers: { \"Content-Type\": \"application/json\" },\r\n            });\r\n            if (!resp.ok) throw new Error(\"Role check failed\");\r\n            return resp;\r\n          };\r\n\r\n          await Promise.race([\r\n            verifyPromise(),\r\n            new Promise((r) => setTimeout(r, 2000)), // 2s max wait for verification\r\n          ]).catch((err) =>\r\n            console.warn(\r\n              \"[CLIENT AUTH] ⚠️ Session verification skipped:\",\r\n              err.message\r\n            )\r\n          );\r\n        } catch (error) {\r\n          console.error(\"[CLIENT AUTH] Error in session sync:\", error);\r\n          // Don't fail login if session sync fails - server cookie is still valid\r\n        }\r\n\r\n        showMessage(\"success\", \"Logged in successfully\");\r\n\r\n        // SECURITY: Use user data from server response (server is source of truth)\r\n        const serverUser = result.data?.user;\r\n        let role = serverUser?.role || serverUser?.normalizedRole || null;\r\n        let name = serverUser?.name || serverUser?.fullName || null;\r\n\r\n        // If server data is incomplete, try to get from Supabase session\r\n        if (!role || !name) {\r\n          try {\r\n            const {\r\n              data: { session: clientSession },\r\n            } = await supabase.auth.getSession();\r\n            if (clientSession?.user) {\r\n              const userMetadata = clientSession.user.user_metadata || {};\r\n              const rawUserMetaData =\r\n                clientSession.user.raw_user_meta_data || {};\r\n              const combinedMetadata = { ...userMetadata, ...rawUserMetaData };\r\n              role =\r\n                role ||\r\n                combinedMetadata.role ||\r\n                combinedMetadata.normalized_role ||\r\n                null;\r\n              name = name || combinedMetadata.name || null;\r\n            }\r\n          } catch (e) {\r\n            console.warn(\"Failed to fetch client session metadata:\", e);\r\n          }\r\n        }\r\n\r\n        // Save user metadata for client-side use\r\n        if (role || name) {\r\n          saveUserMeta({ role, name });\r\n        }\r\n\r\n        // Check if user has completed registration\r\n        if (!role || !name) {\r\n          showMessage(\"error\", \"Please complete your profile first\");\r\n          hideLoading(); // Ensure button is reset\r\n          setTimeout(() => {\r\n            window.location.href = \"/OAuthContinuation\";\r\n          }, 2000);\r\n          return;\r\n        }\r\n\r\n        // Redirect to dashboard based on role\r\n        try {\r\n          hideLoading();\r\n        } catch (e) {}\r\n\r\n        setTimeout(() => {\r\n          try {\r\n            window.location.href = \"/dashboard\";\r\n          } catch (e) {\r\n            /* ignore */\r\n          }\r\n        }, 1500);\r\n\r\n        // Safety fallback: if navigation hasn't started after 7s, clear loading state\r\n        setTimeout(() => {\r\n          try {\r\n            const stillOnLogin =\r\n              window.location.pathname &&\r\n              window.location.pathname.toLowerCase().includes(\"/login\");\r\n            if (stillOnLogin) {\r\n              try {\r\n                hideLoading();\r\n              } catch (e) {}\r\n              showMessage(\r\n                \"info\",\r\n                \"Login appears to be taking longer than usual. If you are not redirected, please refresh the page.\"\r\n              );\r\n            }\r\n          } catch (_) {}\r\n        }, 7000);\r\n      } else {\r\n        // Login failed - hide loading state\r\n        hideLoading();\r\n        showMessage(\"error\", result.error || \"Login failed\");\r\n\r\n        // If OAuth context suggests provider was intended but failed, route to signup\r\n        const ctx = getOAuthContext();\r\n        if (ctx && ctx.provider) {\r\n          window.location.href = \"/signup\";\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Login error:\", error);\r\n      // Hide loading state on error\r\n      hideLoading();\r\n      showMessage(\"error\", \"Login failed. Please try again.\");\r\n    }\r\n  });\r\n// OAuth sign-in buttons (popup-based)\r\nconst oauthButtons = [\r\n  { id: \"login-google\", provider: \"google\" },\r\n  { id: \"login-facebook\", provider: \"facebook\" },\r\n];\r\n\r\noauthButtons.forEach(({ id, provider }) => {\r\n  const btn = document.getElementById(id);\r\n  if (!btn) return;\r\n  btn.addEventListener(\"click\", () => startOAuthPopup(provider));\r\n});\r\n\r\nasync function startOAuthPopup(provider) {\r\n  const scopes =\r\n    provider === \"google\"\r\n      ? \"email profile https://www.googleapis.com/auth/user.phonenumbers.read\"\r\n      : \"email public_profile\";\r\n  try {\r\n    // Determine intent based on current page\r\n    const isSignupPage = window.location.pathname.includes(\"/signup\");\r\n    const intent = isSignupPage ? \"signup\" : \"login\";\r\n\r\n    // Set OAuth context to track the flow\r\n    setOAuthContext({\r\n      provider,\r\n      intent,\r\n      status: \"pending\",\r\n      startedAt: Date.now(),\r\n    });\r\n\r\n    console.log(\"[OAUTH] Starting OAuth flow:\", { provider, intent });\r\n\r\n    // Direct redirect (no popup) - simpler and more reliable\r\n    const { data, error } = await supabase.auth.signInWithOAuth({\r\n      provider,\r\n      options: {\r\n        redirectTo: `${window.location.origin}/oauth-callback`,\r\n        scopes,\r\n      },\r\n    });\r\n\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    // If URL is returned, redirect to it\r\n    if (data?.url) {\r\n      window.location.href = data.url;\r\n    }\r\n  } catch (error) {\r\n    console.error(`[OAUTH] ${provider} OAuth error:`, error);\r\n    showMessage(\"error\", error.message || `${provider} sign-in failed`);\r\n    // Clear OAuth context on error\r\n    try {\r\n      clearOAuthContext();\r\n    } catch {}\r\n  }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\auth\\authChecker.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\auth\\complete-position-signup-page.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\auth\\complete-position-signup.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'renderPrivacyNotice' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from \"../config/config.js\";\r\nimport showMessage from \"../components/toast.js\";\r\nimport { renderPrivacyNotice } from \"../utils/privacyContent.js\";\r\n\r\n// Get signup code from URL parameters\r\nconst urlParams = new URLSearchParams(window.location.search);\r\nconst signupCode = urlParams.get(\"code\");\r\n// reCAPTCHA setup\r\nconst positionSignupCaptchaWidgetId = 0;\r\n// Wait for captcha to be ready\r\nconst waitForCaptcha = () => {\r\n\r\n  if (window.grecaptcha && window.grecaptcha.getResponse) {\r\n    // console.log removed for security\r\n    return true;\r\n  }\r\n  return false;\r\n};\r\n// Check if captcha is ready, retry if not\r\nconst checkCaptchaReady = () => {\r\n  if (waitForCaptcha()) {\r\n    // console.log removed for security\r\n  } else {\r\n    // console.log removed for security\r\n    setTimeout(checkCaptchaReady, 500);\r\n  }\r\n};\r\n// Start checking for captcha readiness\r\ncheckCaptchaReady();\r\nasync function verifyCaptchaOrFail(widgetId) {\r\n  // console.log removed for security\r\n  if (widgetId === null || widgetId === void 0) {\r\n    // console.log removed for security\r\n    showMessage(\"error\", \"Captcha not ready. Please wait and try again.\");\r\n    return { ok: false };\r\n  }\r\n  if (!window.grecaptcha) {\r\n    // console.log removed for security\r\n    showMessage(\"error\", \"reCAPTCHA not loaded. Please refresh the page.\");\r\n    return { ok: false };\r\n  }\r\n  const token = window.grecaptcha.getResponse(widgetId);\r\n  // console.log removed for security\r\n  if (!token) {\r\n    showMessage(\"error\", \"Please complete the captcha.\");\r\n    return { ok: false };\r\n  }\r\n  try {\r\n    const res = await fetch(\"/api/captcha/verify\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ token })\r\n    });\r\n    const json = await res.json();\r\n    if (json && json.success) {\r\n      return { ok: true };\r\n    }\r\n    showMessage(\"error\", \"Captcha verification failed. Please try again.\");\r\n    return { ok: false };\r\n  } catch (_err) {\r\n    showMessage(\"error\", \"Captcha verification error. Please try again.\");\r\n    return { ok: false };\r\n  } finally {\r\n    if (window.grecaptcha) {\r\n      try { window.grecaptcha.reset(widgetId); } catch (_e) {}\r\n    }\r\n  }\r\n}\r\n// Validate signup code and get role/department info\r\nconst validateSignupCode = async (code) => {\r\n  try {\r\n    const response = await fetch(`/api/hr/validate-signup-code/${code}`);\r\n    const result = await response.json();\r\n    if (result && result.valid) {\r\n      return {\r\n        valid: true,\r\n        role: result.data?.role,\r\n        department: result.data?.department_code\r\n      };\r\n    }\r\n    showMessage(\"error\", result.error || \"Invalid signup code\");\r\n    return { valid: false };\r\n  } catch (error) {\r\n    console.error(\"Code validation error:\", error);\r\n    showMessage(\"error\", \"Failed to validate signup code\");\r\n    return { valid: false };\r\n  }\r\n};\r\n// Prefill OAuth data from provider\r\nconst prefillOAuthData = async () => {\r\n  try {\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    const user = session?.user;\r\n    if (user) {\r\n      // Extract name from various OAuth provider sources\r\n      const name = user.user_metadata?.name ||\r\n                   (user.user_metadata?.first_name && user.user_metadata?.last_name ?\r\n                     `${user.user_metadata.first_name} ${user.user_metadata.last_name}` : \"\") ||\r\n                   \"\";\r\n      // Prefill name (read-only)\r\n      const nameInput = document.getElementById(\"name\");\r\n      if (nameInput && name) {\r\n        nameInput.value = name.trim();\r\n      }\r\n      // Prefill email (read-only)\r\n      const emailInput = document.getElementById(\"email\");\r\n      if (emailInput && user.email) {\r\n        emailInput.value = user.email;\r\n      }\r\n      // Try to get phone from OAuth provider\r\n      const oauthPhone = user.user_metadata?.phone_number ||\r\n                        user.user_metadata?.phone ||\r\n                        user.user_metadata?.mobile ||\r\n                        null;\r\n      const mobileInput = document.getElementById(\"mobile\");\r\n      if (mobileInput) {\r\n\r\n        if (oauthPhone) {\r\n          // Extract digits only\r\n          let digits = oauthPhone.replace(/\\D/g, \"\");\r\n          // Handle Philippines mobile format\r\n          if (digits.startsWith(\"63\") && digits.length >= 12) {\r\n            digits = digits.substring(2, 12);\r\n          } else if (digits.length === 10) {\r\n            // Already 10 digits, use as is\r\n          } else if (digits.length > 10) {\r\n            digits = digits.substring(digits.length - 10);\r\n          }\r\n          mobileInput.value = digits;\r\n          mobileInput.readOnly = true;\r\n          mobileInput.style.background = \"#f5f5f5\";\r\n          mobileInput.style.cursor = \"not-allowed\";\r\n        } else {\r\n          // No phone from OAuth - keep field editable\r\n          mobileInput.readOnly = false;\r\n          mobileInput.style.background = \"\";\r\n          mobileInput.style.cursor = \"\";\r\n          mobileInput.required = true;\r\n        }\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error prefilling OAuth data:\", error);\r\n  }\r\n};\r\n// Prefill signup code and role/department info\r\nconst prefillSignupInfo = async () => {\r\n\r\n  if (!signupCode) {\r\n    showMessage(\"error\", \"No signup code provided\");\r\n    return;\r\n  }\r\n  // Prefill signup code\r\n  const codeInput = document.getElementById(\"signupCode\");\r\n  if (codeInput) {\r\n    codeInput.value = signupCode;\r\n  }\r\n  // Validate code and get role/department\r\n  const validation = await validateSignupCode(signupCode);\r\n  if (validation.valid) {\r\n    const roleInput = document.getElementById(\"role\");\r\n    const departmentInput = document.getElementById(\"department\");\r\n    if (roleInput) {\r\n      roleInput.value = validation.role;\r\n    }\r\n    if (departmentInput) {\r\n      departmentInput.value = validation.department;\r\n    }\r\n  }\r\n};\r\n// Handle form submission\r\nconst positionSignupForm = document.getElementById(\"positionSignupForm\");\r\n\r\n// Form persistence logic for OAuth completion\r\nconst OAUTH_FORM_STORAGE_KEY = \"cl_oauth_form_data\";\r\n\r\nfunction saveOAuthFormData() {\r\n  if (!positionSignupForm) return;\r\n\r\n  const formData = new FormData(positionSignupForm);\r\n  const dataToSave = {};\r\n\r\n  for (const [key, value] of formData.entries()) {\r\n    // Save all fields including hidden ones if needed, but exclude sensitive if any (none here really)\r\n    // We want to save name, email, mobile, signupCode\r\n    dataToSave[key] = value;\r\n  }\r\n\r\n  try {\r\n    localStorage.setItem(OAUTH_FORM_STORAGE_KEY, JSON.stringify(dataToSave));\r\n  } catch (e) {\r\n    console.warn(\"Failed to save OAuth form data:\", e);\r\n  }\r\n}\r\n\r\nfunction loadOAuthFormData() {\r\n  if (!positionSignupForm) return;\r\n\r\n  try {\r\n    const savedData = localStorage.getItem(OAUTH_FORM_STORAGE_KEY);\r\n    if (!savedData) return;\r\n\r\n    const parsedData = JSON.parse(savedData);\r\n\r\n    Object.keys(parsedData).forEach(key => {\r\n      const input = positionSignupForm.querySelector(`[name=\"${key}\"]`);\r\n      // Only restore if input is empty or editable (don't overwrite read-only prefilled data unless it matches)\r\n      // Actually, we should be careful. If OAuth prefilled it, we might want to keep that.\r\n      // But if user edited it and refreshed, we want their edit.\r\n      // Strategy: Restore everything, but maybe check if readOnly?\r\n      if (input && !input.readOnly) {\r\n        input.value = parsedData[key];\r\n        input.dispatchEvent(new Event(\"input\", { bubbles: true }));\r\n      }\r\n    });\r\n  } catch (e) {\r\n    console.warn(\"Failed to load OAuth form data:\", e);\r\n  }\r\n}\r\n\r\nfunction clearOAuthFormData() {\r\n  try {\r\n    localStorage.removeItem(OAUTH_FORM_STORAGE_KEY);\r\n  } catch (e) {\r\n    console.warn(\"Failed to clear OAuth form data:\", e);\r\n  }\r\n}\r\n\r\nif (positionSignupForm) {\r\n  // Load saved data on init - AFTER prefill logic runs?\r\n  // We should probably run this after prefill to overwrite with user edits if any\r\n  // But prefill is async. Let's hook into the prefill completion or just run it with a delay/check.\r\n  // Actually, prefill runs on load. We can run this after.\r\n\r\n  // Wait a tick for prefill to potentially happen, then load user saved data on top\r\n  setTimeout(loadOAuthFormData, 500);\r\n\r\n  // Save data on input changes\r\n  positionSignupForm.addEventListener(\"input\", () => {\r\n    saveOAuthFormData();\r\n  });\r\n\r\n  positionSignupForm.addEventListener(\"submit\", async (e) => {\r\n    e.preventDefault();\r\n    const name = document.getElementById(\"name\").value.trim();\r\n    const email = document.getElementById(\"email\").value.trim();\r\n    const mobile = document.getElementById(\"mobile\").value.trim();\r\n    const code = document.getElementById(\"signupCode\").value.trim();\r\n    if (!name) {\r\n      showMessage(\"error\", \"Name is required\");\r\n      return;\r\n    }\r\n    if (!email) {\r\n      showMessage(\"error\", \"Email is required\");\r\n      return;\r\n    }\r\n    if (!mobile || !/^[0-9]{10}$/.test(mobile)) {\r\n      showMessage(\"error\", \"Please enter a valid 10-digit mobile number\");\r\n      return;\r\n    }\r\n    if (!code) {\r\n      showMessage(\"error\", \"Signup code is required\");\r\n      return;\r\n    }\r\n    // Show loading state\r\n    const submitButton = e.target.querySelector('button[type=\"submit\"]');\r\n    const buttonText = submitButton.querySelector(\".button-text\");\r\n    const buttonLoading = submitButton.querySelector(\".button-loading\");\r\n    buttonText.style.display = \"none\";\r\n    buttonLoading.style.display = \"flex\";\r\n    submitButton.disabled = true;\r\n    // Verify captcha (skip if not available)\r\n    if (positionSignupCaptchaWidgetId !== null) {\r\n      const captchaResult = await verifyCaptchaOrFail(positionSignupCaptchaWidgetId);\r\n      if (!captchaResult.ok) {\r\n        // Reset button state\r\n        buttonText.style.display = \"block\";\r\n        buttonLoading.style.display = \"none\";\r\n        submitButton.disabled = false;\r\n        return;\r\n      }\r\n    } else {\r\n      // console.log removed for security\r\n    }\r\n    // Complete OAuth registration with HR signup code\r\n    try {\r\n      const response = await fetch(\"/api/auth/complete-oauth-hr\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        body: JSON.stringify({\r\n          name,\r\n          mobile,\r\n          signupCode: code\r\n        })\r\n      });\r\n      const result = await response.json();\r\n      if (!result.success) {\r\n        showMessage(\"error\", result.error || \"Failed to complete registration\");\r\n        return;\r\n      }\r\n      showMessage(\"success\", \"Registration completed successfully! Redirecting to dashboard...\");\r\n      clearOAuthFormData(); // Clear saved data\r\n      setTimeout(() => {\r\n        window.location.href = \"/dashboard\";\r\n      }, 2000);\r\n    } catch (err) {\r\n      console.error(\"HR OAuth completion error:\", err);\r\n      showMessage(\"error\", \"Registration failed. Please try again.\");\r\n    } finally {\r\n      // Reset button state\r\n      buttonText.style.display = \"block\";\r\n      buttonLoading.style.display = \"none\";\r\n      submitButton.disabled = false;\r\n    }\r\n  });\r\n}\r\n// Terms and Privacy handlers\r\ndocument.getElementById(\"toc\")?.addEventListener(\"click\", () => {\r\n  document.getElementById(\"terms\").innerHTML = \"<h3>Terms and Conditions</h3><p>Your terms content here...</p>\";\r\n});\r\n// Privacy Notice link now opens in new tab - no modal needed\r\n// Privacy content is available at /privacy-notice\r\n// Prefill data on page load\r\nprefillOAuthData();\r\nprefillSignupInfo();\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\auth\\index-page.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'clearOAuthContext' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":52},{"ruleId":"no-unused-vars","severity":1,"message":"'suppressAuthErrorNotifications' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":84}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Index/landing page specific functionality\nimport { supabase } from \"../config/config.js\";\nimport { logout, getOAuthContext, clearOAuthContext, suppressAuthErrorNotifications } from \"./authChecker.js\";\nimport { shouldSkipAuthCheck } from \"../utils/oauth-cleanup.js\";\n\n// Track if logout event listener has been added\nlet logoutListenerAdded = false;\n\n// Global Guard handles all cleanup now - redundant code removed\n\n// Check authentication status and update UI\nconst checkAuthenticationAndUpdateUI = async () => {\n  try {\n    // Global Guard already ran at init\n    // await clearOAuthContextOnLanding();\n\n    // Check for incomplete OAuth signup - if pending or handoff, don't show authenticated UI\n    const ctx = getOAuthContext();\n    const hasIncompleteOAuth = ctx && ctx.intent === \"signup\" && (ctx.status === \"pending\" || ctx.status === \"handoff\");\n    const hasPendingOAuth = shouldSkipAuthCheck() || hasIncompleteOAuth;\n\n    // Get current session\n    const { data: { session }, error } = await supabase.auth.getSession();\n    const unauthenticatedButtons = document.getElementById(\"unauthenticated-buttons\");\n    const authenticatedButtons = document.getElementById(\"authenticated-buttons\");\n    const logoutBtn = document.getElementById(\"logout-btn\");\n\n    // If there's an incomplete OAuth signup, always show unauthenticated buttons\n    if (hasPendingOAuth || hasIncompleteOAuth) {\n      if (unauthenticatedButtons) unauthenticatedButtons.classList.remove(\"hidden\");\n      if (authenticatedButtons) authenticatedButtons.classList.add(\"hidden\");\n      return;\n    }\n\n    if (session && !error) {\n      // Get user metadata\n      const {user} = session;\n      const role = user?.user_metadata?.role || user?.raw_user_meta_data?.role || \"\";\n      const name = user?.user_metadata?.name || user?.raw_user_meta_data?.name || \"\";\n      const hasMobile = user?.user_metadata?.mobile_number ||\n                       user?.user_metadata?.mobile ||\n                       user?.phone;\n\n      // Check if user has completed registration (must have role, name, AND mobile)\n      if (role && name && hasMobile) {\n        // Hide login/signup buttons, show dashboard button\n        if (unauthenticatedButtons) unauthenticatedButtons.classList.add(\"hidden\");\n        if (authenticatedButtons) authenticatedButtons.classList.remove(\"hidden\");\n        // Add logout functionality (only once)\n        if (logoutBtn && !logoutListenerAdded) {\n          logoutBtn.addEventListener(\"click\", async () => {\n            await logout();\n          });\n          logoutListenerAdded = true;\n        }\n      } else {\n        // Profile incomplete, keep showing login/signup for profile completion\n        if (unauthenticatedButtons) unauthenticatedButtons.classList.remove(\"hidden\");\n        if (authenticatedButtons) authenticatedButtons.classList.add(\"hidden\");\n      }\n    } else {\n      // Show login/signup buttons, hide dashboard button\n      if (unauthenticatedButtons) unauthenticatedButtons.classList.remove(\"hidden\");\n      if (authenticatedButtons) authenticatedButtons.classList.add(\"hidden\");\n    }\n  } catch (error) {\n    console.error(\"💥 Authentication check failed:\", error);\n    // On error, default to showing login/signup buttons\n    const unauthenticatedButtons = document.getElementById(\"unauthenticated-buttons\");\n    const authenticatedButtons = document.getElementById(\"authenticated-buttons\");\n    if (unauthenticatedButtons) unauthenticatedButtons.classList.remove(\"hidden\");\n    if (authenticatedButtons) authenticatedButtons.classList.add(\"hidden\");\n  }\n};\n// Initialize index page\nconst initializeIndexPage = async () => {\n  // CRITICAL: Run Global OAuth Guard FIRST to wipe stale state\n  const { initGlobalOAuthGuard } = await import(\"../utils/global-oauth-guard.js\");\n  await initGlobalOAuthGuard();\n\n  // Setup navigation cleanup for login/signup buttons and brand logo\n  const { setupNavigationCleanup } = await import(\"../utils/navigation.js\");\n  setupNavigationCleanup();\n\n  // Run authentication check when page loads\n  checkAuthenticationAndUpdateUI();\n  // Also run immediately in case DOMContentLoaded already fired\n  checkAuthenticationAndUpdateUI();\n};\n// Initialize when DOM is ready\nif (document.readyState === \"loading\") {\n  document.addEventListener(\"DOMContentLoaded\", initializeIndexPage);\n} else {\n  initializeIndexPage();\n}\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\auth\\login-page.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\auth\\oauth-callback.js","messages":[{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":17,"column":34,"nodeType":"CallExpression","messageId":"returnsValue","endLine":17,"endColumn":59,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[800,825],"text":"{setTimeout(resolve, 1000)}"},"desc":"Wrap the expression in `{}`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// OAuth callback handler - processes OAuth redirect and determines next step\nimport { supabase } from \"../config/config.js\";\nimport { setOAuthContext, clearOAuthContext, getOAuthContext, suppressAuthErrorNotifications } from \"./authChecker.js\";\n\nconsole.log(\"[OAUTH_CALLBACK] OAuth callback page loaded\");\n\nconst processOAuthCallback = async () => {\n  // Suppress auth error notifications while OAuth flow settles\n  suppressAuthErrorNotifications();\n  try {\n    console.log(\"[OAUTH_CALLBACK] Processing OAuth callback...\");\n    console.log(\"[OAUTH_CALLBACK] URL:\", window.location.href);\n    console.log(\"[OAUTH_CALLBACK] Hash:\", window.location.hash);\n\n    // Wait for Supabase to process the OAuth callback\n    // Supabase automatically handles tokens in URL hash\n    await new Promise(resolve => setTimeout(resolve, 1000));\n\n    // Get the session\n    const { data: { session }, error: sessionError } = await supabase.auth.getSession();\n\n    if (sessionError || !session) {\n      console.error(\"[OAUTH_CALLBACK] No session found:\", sessionError);\n      window.location.href = \"/login?err=oauth_failed\";\n      return;\n    }\n\n    console.log(\"[OAUTH_CALLBACK] Session found, user ID:\", session.user?.id);\n\n    // Set server-side session cookie\n    try {\n      const cookieResponse = await fetch(\"/auth/session\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ access_token: session.access_token })\n      });\n\n      if (!cookieResponse.ok) {\n        console.warn(\"[OAUTH_CALLBACK] Failed to set server cookie\");\n      }\n    } catch (cookieError) {\n      console.warn(\"[OAUTH_CALLBACK] Error setting server cookie:\", cookieError);\n    }\n\n    // Get OAuth intent from context (set when user clicked OAuth button)\n    const oauthContext = getOAuthContext();\n    const intent = oauthContext?.intent || \"login\"; // Default to login for safety\n\n    console.log(\"[OAUTH_CALLBACK] OAuth intent:\", intent);\n    console.log(\"[OAUTH_CALLBACK] OAuth context:\", oauthContext);\n\n    // Check user status on server (pass intent to help determine new vs existing)\n    try {\n      const statusResponse = await fetch(`/api/auth/oauth-status?intent=${intent}`, {\n        method: \"GET\",\n        headers: {\n          \"Authorization\": `Bearer ${session.access_token}`,\n          \"X-OAuth-Intent\": intent\n        }\n      });\n\n      if (!statusResponse.ok) {\n        throw new Error(\"Failed to check user status\");\n      }\n\n      const statusData = await statusResponse.json();\n      console.log(\"[OAUTH_CALLBACK] User status:\", statusData);\n\n      if (statusData.complete) {\n        // User is fully registered - go to dashboard\n        console.log(\"[OAUTH_CALLBACK] User is complete, redirecting to dashboard\");\n        console.log(\"[OAUTH_CALLBACK] User type:\", statusData.userType);\n        console.log(\"[OAUTH_CALLBACK] Message:\", statusData.message);\n\n        // Clear OAuth context since we're done\n        clearOAuthContext();\n\n        // Store a success message if available\n        if (statusData.message) {\n          sessionStorage.setItem(\"oauth_success_message\", statusData.message);\n        }\n\n        window.location.href = \"/dashboard\";\n      } else {\n        // User needs to complete profile - go to continuation\n        const isNewSignup = statusData.isNewSignup || intent === \"signup\";\n        const isExistingIncomplete = statusData.isExistingIncomplete || (intent === \"login\" && !statusData.isNewSignup);\n\n        console.log(\"[OAUTH_CALLBACK] User is incomplete, redirecting to continuation\");\n        console.log(\"[OAUTH_CALLBACK] Is new signup:\", isNewSignup);\n        console.log(\"[OAUTH_CALLBACK] Is existing incomplete:\", isExistingIncomplete);\n        console.log(\"[OAUTH_CALLBACK] User type:\", statusData.userType);\n\n        // Set OAuth context for continuation page\n        const provider = session.user?.identities?.[0]?.provider || \"oauth\";\n        setOAuthContext({\n          provider,\n          email: session.user?.email,\n          intent,\n          status: \"handoff\",\n          startedAt: Date.now(),\n          userType: statusData.userType,\n          isNewSignup,\n          message: statusData.message\n        });\n\n        window.location.href = \"/oauth-continuation\";\n      }\n    } catch (statusError) {\n      console.error(\"[OAUTH_CALLBACK] Error checking user status:\", statusError);\n      // Fallback: redirect to continuation with default signup intent\n      const provider = session.user?.identities?.[0]?.provider || \"oauth\";\n      setOAuthContext({\n        provider,\n        email: session.user?.email,\n        intent: intent || \"signup\",\n        status: \"handoff\",\n        startedAt: Date.now()\n      });\n      window.location.href = \"/oauth-continuation\";\n    }\n  } catch (error) {\n    console.error(\"[OAUTH_CALLBACK] Error processing callback:\", error);\n    window.location.href = \"/login?err=oauth_failed\";\n  }\n};\n\n// Process callback when page loads\nif (document.readyState === \"loading\") {\n  document.addEventListener(\"DOMContentLoaded\", processOAuthCallback);\n} else {\n  processOAuthCallback();\n}\n\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\auth\\oauth-complete.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'renderPrivacyNotice' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from \"../config/config.js\";\r\nimport showMessage from \"../components/toast.js\";\r\nimport { validateAndSanitizeForm } from \"../utils/validation.js\";\r\nimport { renderPrivacyNotice } from \"../utils/privacyContent.js\";\r\nimport { getOAuthContext } from \"./authChecker.js\";\r\n\r\n// reCAPTCHA setup - using auto-rendered captcha from HTML\r\nconst oauthCompleteCaptchaWidgetId = 0; // Default ID for auto-rendered captchas\r\n// Wait for captcha to be ready\r\nconst waitForCaptcha = () => {\r\n\r\n  if (window.grecaptcha && window.grecaptcha.getResponse) {\r\n    // console.log removed for security\r\n    return true;\r\n  }\r\n  return false;\r\n};\r\n// Check if captcha is ready, retry if not\r\nconst checkCaptchaReady = () => {\r\n  if (waitForCaptcha()) {\r\n    // console.log removed for security\r\n  } else {\r\n    // console.log removed for security\r\n    setTimeout(checkCaptchaReady, 500);\r\n  }\r\n};\r\n// Start checking for captcha readiness\r\ncheckCaptchaReady();\r\nasync function verifyCaptchaOrFail(widgetId) {\r\n  // console.log removed for security\r\n  if (widgetId === null || widgetId === void 0) {\r\n    // console.log removed for security\r\n    showMessage(\"error\", \"Captcha not ready. Please wait and try again.\");\r\n    return { ok: false };\r\n  }\r\n  if (!window.grecaptcha) {\r\n    // console.log removed for security\r\n    showMessage(\"error\", \"reCAPTCHA not loaded. Please refresh the page.\");\r\n    return { ok: false };\r\n  }\r\n  const token = window.grecaptcha.getResponse(widgetId);\r\n  // console.log removed for security\r\n  if (!token) {\r\n    showMessage(\"error\", \"Please complete the captcha.\");\r\n    return { ok: false };\r\n  }\r\n  try {\r\n    const res = await fetch(\"/api/captcha/verify\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ token })\r\n    });\r\n    const json = await res.json();\r\n    if (json && json.success) {\r\n      return { ok: true };\r\n    }\r\n    showMessage(\"error\", \"Captcha verification failed. Please try again.\");\r\n    return { ok: false };\r\n  } catch (_err) {\r\n    showMessage(\"error\", \"Captcha verification error. Please try again.\");\r\n    return { ok: false };\r\n  } finally {\r\n    if (window.grecaptcha) {\r\n      try { window.grecaptcha.reset(widgetId); } catch (_e) {}\r\n    }\r\n  }\r\n}\r\n// Form persistence logic\r\nconst OAUTH_FORM_STORAGE_KEY = \"cl_oauth_complete_form_data\";\r\n\r\nfunction saveOAuthFormData() {\r\n  const form = document.getElementById(\"oauthCompleteForm\");\r\n  if (!form) return;\r\n\r\n  const formData = new FormData(form);\r\n  const dataToSave = {};\r\n\r\n  for (const [key, value] of formData.entries()) {\r\n    // Don't save sensitive fields\r\n    if (key !== \"regPassword\" && key !== \"reRegPassword\") {\r\n      dataToSave[key] = value;\r\n    }\r\n  }\r\n\r\n  try {\r\n    localStorage.setItem(OAUTH_FORM_STORAGE_KEY, JSON.stringify(dataToSave));\r\n  } catch (e) {\r\n    console.warn(\"Failed to save OAuth form data:\", e);\r\n  }\r\n}\r\n\r\nfunction loadOAuthFormData() {\r\n  try {\r\n    const savedData = localStorage.getItem(OAUTH_FORM_STORAGE_KEY);\r\n    if (!savedData) return;\r\n\r\n    const parsedData = JSON.parse(savedData);\r\n    const form = document.getElementById(\"oauthCompleteForm\");\r\n    if (!form) return;\r\n\r\n    Object.keys(parsedData).forEach(key => {\r\n      const input = form.querySelector(`[name=\"${key}\"]`);\r\n      if (input && input.type !== \"file\") {\r\n        input.value = parsedData[key];\r\n        input.dispatchEvent(new Event(\"input\", { bubbles: true }));\r\n      }\r\n    });\r\n  } catch (e) {\r\n    console.warn(\"Failed to load OAuth form data:\", e);\r\n  }\r\n}\r\n\r\nfunction clearOAuthFormData() {\r\n  try {\r\n    localStorage.removeItem(OAUTH_FORM_STORAGE_KEY);\r\n    localStorage.removeItem(\"cl_signup_step_index\"); // Also clear step index\r\n  } catch (e) {\r\n    console.warn(\"Failed to clear OAuth form data:\", e);\r\n  }\r\n}\r\n\r\n// Prefill OAuth data from provider\r\nconst prefillOAuthData = async () => {\r\n  try {\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    const user = session?.user;\r\n    if (user) {\r\n      const identityData = user.identities?.[0]?.identity_data || {};\r\n      const meta = user.user_metadata || {};\r\n      const rawMeta = user.raw_user_meta_data || {};\r\n      const combined = { ...identityData, ...meta, ...rawMeta };\r\n      const fullName = combined.full_name || combined.name || \"\";\r\n\r\n      // Prioritize explicit fields\r\n      let firstName = combined.given_name || combined.first_name || \"\";\r\n      let lastName = combined.family_name || combined.last_name || \"\";\r\n      const middleName = combined.middle_name || \"\";\r\n\r\n      // If explicit fields are missing, try to parse from full name\r\n      if (!firstName && !lastName && fullName) {\r\n        const nameParts = fullName.trim().split(\" \");\r\n        if (nameParts.length === 1) {\r\n          firstName = nameParts[0];\r\n        } else if (nameParts.length > 1) {\r\n          // Assume last word is last name, everything else is first name\r\n          // Do NOT infer middle name automatically to avoid splitting multi-word first names\r\n          lastName = nameParts.pop();\r\n          firstName = nameParts.join(\" \");\r\n        }\r\n      }\r\n\r\n      // Prefill firstName\r\n      const firstNameInput = document.getElementById(\"firstName\");\r\n      if (firstNameInput && firstName && !firstNameInput.value) {\r\n        firstNameInput.value = firstName;\r\n      }\r\n\r\n      const middleNameInput = document.getElementById(\"middleName\");\r\n      if (middleNameInput) {\r\n        if (middleName && !middleNameInput.value) {\r\n          middleNameInput.value = middleName;\r\n        } else if (!middleName && !middleNameInput.value) {\r\n          // Enable if empty so user can enter it or leave it blank\r\n          middleNameInput.removeAttribute(\"readonly\");\r\n          middleNameInput.removeAttribute(\"disabled\");\r\n          middleNameInput.removeAttribute(\"aria-disabled\");\r\n          middleNameInput.removeAttribute(\"title\");\r\n        }\r\n      }\r\n\r\n      // Prefill lastName\r\n      const lastNameInput = document.getElementById(\"lastName\");\r\n      if (lastNameInput && lastName && !lastNameInput.value) {\r\n        lastNameInput.value = lastName;\r\n      }\r\n\r\n      // Prefill email (read-only)\r\n      const emailInput = document.getElementById(\"email\");\r\n      if (emailInput && user.email) {\r\n        emailInput.value = user.email;\r\n      }\r\n\r\n      // Try to get phone from OAuth provider (Google, Facebook, etc.)\r\n      const oauthPhone = user.user_metadata?.phone_number ||\r\n                        user.user_metadata?.phone ||\r\n                        user.user_metadata?.mobile ||\r\n                        null;\r\n      const mobileInput = document.getElementById(\"mobile\");\r\n      if (mobileInput && !mobileInput.value) {\r\n        if (oauthPhone) {\r\n          // Extract digits only (handle various formats: +63XXX, +1XXX, etc.)\r\n          let digits = oauthPhone.replace(/\\D/g, \"\");\r\n          // If it starts with country code, try to extract Philippines mobile\r\n          if (digits.startsWith(\"63\") && digits.length >= 12) {\r\n            // Remove country code 63 and keep 10 digits\r\n            digits = digits.substring(2, 12);\r\n          } else if (digits.length === 10) {\r\n            // Already 10 digits, use as is\r\n          } else if (digits.length > 10) {\r\n            // Take last 10 digits\r\n            digits = digits.substring(digits.length - 10);\r\n          }\r\n          mobileInput.value = digits;\r\n        }\r\n        // Mobile is always editable for OAuth continuation\r\n        mobileInput.required = true;\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error prefilling OAuth data:\", error);\r\n  } finally {\r\n    // Load saved data AFTER prefill to ensure user edits are preserved\r\n    loadOAuthFormData();\r\n  }\r\n};\r\n\r\n// Handle form submission\r\nconst oauthCompleteForm = document.getElementById(\"oauthCompleteForm\");\r\nif (oauthCompleteForm) {\r\n  // Save on input\r\n  oauthCompleteForm.addEventListener(\"input\", (e) => {\r\n    if (e.target.name !== \"regPassword\" && e.target.name !== \"reRegPassword\") {\r\n      saveOAuthFormData();\r\n    }\r\n  });\r\n\r\n  oauthCompleteForm.addEventListener(\"submit\", async (e) => {\r\n    e.preventDefault();\r\n    const firstName = document.getElementById(\"firstName\")?.value.trim() || \"\";\r\n    const middleName = document.getElementById(\"middleName\")?.value.trim() || \"\";\r\n    const lastName = document.getElementById(\"lastName\")?.value.trim() || \"\";\r\n    const email = document.getElementById(\"email\").value.trim();\r\n    const mobile = document.getElementById(\"mobile\").value.trim();\r\n    const addressLine1 = document.getElementById(\"addressLine1\")?.value.trim() || \"\";\r\n    const gender = document.getElementById(\"gender\")?.value || \"\";\r\n    const passwordInput = document.getElementById(\"regPassword\");\r\n    const confirmPasswordInput = document.getElementById(\"reRegPassword\");\r\n    const regPass = passwordInput ? passwordInput.value : \"\";\r\n    const reRegPass = confirmPasswordInput ? confirmPasswordInput.value : \"\";\r\n    const passwordProvided = Boolean(passwordInput && regPass);\r\n\r\n    // Early password length checks (only if password field exists)\r\n    if (passwordProvided && regPass.length < 8) {\r\n      showMessage(\"error\", \"Password must be at least 8 characters long\");\r\n      return;\r\n    }\r\n\r\n    // Validate form data\r\n    const validationRules = {\r\n      firstName: { required: true, minLength: 1, maxLength: 100 },\r\n      middleName: { required: false, minLength: 0, maxLength: 100 },\r\n      lastName: { required: true, minLength: 1, maxLength: 100 },\r\n      email: { required: true, type: \"email\" },\r\n      mobile: { required: true, type: \"mobile\" },\r\n      addressLine1: { required: false, minLength: 0, maxLength: 255 },\r\n      gender: { required: false }\r\n    };\r\n    if (passwordProvided) {\r\n      validationRules.regPassword = { required: true, type: \"password\" };\r\n    }\r\n    const formData = { firstName, middleName, lastName, email, mobile, addressLine1, gender };\r\n    if (passwordProvided) {\r\n      formData.regPassword = regPass;\r\n    }\r\n    const validation = validateAndSanitizeForm(formData, validationRules);\r\n    if (!validation.isValid) {\r\n      showMessage(\"error\", validation.errors.join(\", \"));\r\n      return;\r\n    }\r\n\r\n    // Additional password confirmation check (only if password provided)\r\n    if (passwordProvided && reRegPass !== regPass) {\r\n      showMessage(\"error\", \"Passwords don't match\");\r\n      return;\r\n    }\r\n\r\n    // verify captcha (skip if not available)\r\n    if (oauthCompleteCaptchaWidgetId !== null) {\r\n      const captchaResult = await verifyCaptchaOrFail(oauthCompleteCaptchaWidgetId);\r\n      if (!captchaResult.ok) return;\r\n    } else {\r\n      // console.log removed for security\r\n    }\r\n\r\n    // Build JSON payload matching signup structure\r\n    const payload = {\r\n      email: validation.sanitizedData.email,\r\n      firstName: validation.sanitizedData.firstName,\r\n      middleName: validation.sanitizedData.middleName || \"\",\r\n      lastName: validation.sanitizedData.lastName,\r\n      mobileNumber: `+63${validation.sanitizedData.mobile}`,\r\n      gender: validation.sanitizedData.gender || \"\",\r\n      address: { line1: validation.sanitizedData.addressLine1 || \"\" },\r\n      agreedToTerms: true,\r\n      isOAuth: true // OAuth continuation\r\n    };\r\n    if (passwordProvided) {\r\n      payload.password = regPass;\r\n      payload.confirmPassword = reRegPass;\r\n    }\r\n\r\n    // Update user metadata and complete profile via backend\r\n    try {\r\n      // Get access token from current session\r\n      const { data: { session } } = await supabase.auth.getSession();\r\n      const accessToken = session?.access_token;\r\n\r\n      const headers = {\r\n        \"Content-Type\": \"application/json\"\r\n      };\r\n\r\n      // Add Authorization header if we have a token\r\n      if (accessToken) {\r\n        headers[\"Authorization\"] = `Bearer ${accessToken}`;\r\n        // Also include in body as fallback\r\n        payload.access_token = accessToken;\r\n      }\r\n\r\n      const response = await fetch(\"/api/auth/complete-oauth\", {\r\n        method: \"POST\",\r\n        headers,\r\n        body: JSON.stringify(payload)\r\n      });\r\n      const result = await response.json();\r\n      if (!result.success) {\r\n        const errMsg = (result && result.error ? String(result.error) : \"\").toLowerCase();\r\n        if (errMsg.includes(\"already registered\") || errMsg.includes(\"already exists\") || errMsg.includes(\"duplicate\") || errMsg.includes(\"email is used\") || errMsg.includes(\"email taken\") || errMsg.includes(\"email already exist\")) {\r\n          showMessage(\"error\", \"Email already exist\");\r\n        } else {\r\n          showMessage(\"error\", result.error || \"Failed to complete registration\");\r\n        }\r\n        return;\r\n      }\r\n      // Mark OAuth signup as completed to prevent cleanup\r\n      try {\r\n        const { setOAuthContext, clearOAuthContext } = await import(\"./authChecker.js\");\r\n        const ctx = getOAuthContext();\r\n        if (ctx) {\r\n          setOAuthContext({ ...ctx, status: \"completed\" });\r\n        }\r\n        // Clear context after a short delay to allow redirect\r\n        setTimeout(() => {\r\n          clearOAuthContext();\r\n        }, 1000);\r\n      } catch (error) {\r\n        console.warn(\"[OAUTH_COMPLETE] Error updating OAuth context:\", error);\r\n      }\r\n\r\n      showMessage(\"success\", \"Profile completed successfully! Redirecting to dashboard...\");\r\n      clearOAuthFormData(); // Clear saved form data\r\n\r\n      // Clear OAuth context since signup is complete\r\n      try {\r\n        const { clearOAuthContext } = await import(\"./authChecker.js\");\r\n        clearOAuthContext();\r\n      } catch {}\r\n\r\n      // Redirect immediately to dashboard\r\n      setTimeout(() => {\r\n        window.location.href = \"/dashboard\";\r\n      }, 1000);\r\n    } catch (err) {\r\n      console.error(\"OAuth completion error:\", err);\r\n      showMessage(\"error\", \"Registration failed. Please try again.\");\r\n    }\r\n  });\r\n}\r\n// Terms and Privacy handlers\r\ndocument.getElementById(\"toc\").addEventListener(\"click\", (event) => {\r\n  event.preventDefault();\r\n  document.getElementById(\"terms\").innerHTML = \"<h3>Terms and Conditions</h3><p>Your terms content here...</p>\";\r\n});\r\n// Privacy Notice link now opens in new tab - no modal needed\r\n// Privacy content is available at /privacy-notice\r\n// Prefill data on page load\r\nprefillOAuthData();\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\auth\\oauth-continuation-page.js","messages":[{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":110,"column":7,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":110,"endColumn":27},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":119,"column":38,"nodeType":"CallExpression","messageId":"returnsValue","endLine":119,"endColumn":62,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[4231,4255],"text":"{setTimeout(resolve, 500)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":352,"column":34,"nodeType":"CallExpression","messageId":"returnsValue","endLine":352,"endColumn":58,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[13331,13355],"text":"{setTimeout(resolve, 500)}"},"desc":"Wrap the expression in `{}`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// OAuth continuation page specific functionality\r\n// console.log('[OAUTH_CONT] Script file loaded at:', new Date().toISOString());\r\n// console.log('[OAUTH_CONT] Current URL:', window.location.href);\r\n\r\nimport { supabase } from \"../config/config.js\";\r\nimport { getOAuthContext, clearOAuthContext, setOAuthContext, suppressAuthErrorNotifications } from \"./authChecker.js\";\r\nimport showMessage from \"../components/toast.js\";\r\n\r\n// console.log('[OAUTH_CONT] Imports completed');\r\n\r\n// Cleanup incomplete OAuth signup on interruption\r\nconst cleanupIncompleteOAuthSignup = async (_reason = \"OAuth signup was interrupted\") => {\r\n  suppressAuthErrorNotifications();\r\n  try {\r\n    const ctx = getOAuthContext();\r\n    // Only cleanup if this is an incomplete NEW signup (not existing user login)\r\n    // Don't cleanup if:\r\n    // 1. No context\r\n    // 2. Intent is 'login' (existing user)\r\n    // 3. Status is 'completed' (already done)\r\n    // 4. User type is 'existing' (existing user with incomplete profile)\r\n    if (!ctx ||\r\n        ctx.intent !== \"signup\" ||\r\n        ctx.status === \"completed\" ||\r\n        ctx.userType === \"existing\" ||\r\n        ctx.isExistingIncomplete) {\r\n      /* console.log('[OAUTH_CONT] Skipping cleanup - not a new signup:', {\r\n        hasContext: !!ctx,\r\n        intent: ctx?.intent,\r\n        status: ctx?.status,\r\n        userType: ctx?.userType,\r\n        isExistingIncomplete: ctx?.isExistingIncomplete\r\n      }); */\r\n      return;\r\n    }\r\n\r\n    // Get user ID before signing out\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    const userId = session?.user?.id;\r\n\r\n    // Delete incomplete OAuth signup from database\r\n    if (userId && session?.access_token) {\r\n      try {\r\n        const token = session.access_token;\r\n        const headers = {\r\n          \"Authorization\": `Bearer ${token}`\r\n        };\r\n\r\n        const deleteResponse = await fetch(\"/api/auth/oauth-incomplete\", {\r\n          method: \"DELETE\",\r\n          headers,\r\n          credentials: \"include\"\r\n        });\r\n\r\n        if (!deleteResponse.ok) {\r\n          const errorData = await deleteResponse.json().catch(() => ({}));\r\n          const {status} = deleteResponse;\r\n          // Don't log auth errors - they're expected for incomplete signups\r\n          if (status !== 401 && status !== 403) {\r\n            console.warn(\"[OAUTH_CONT] Failed to delete incomplete OAuth signup:\", errorData.error || \"Unknown error\");\r\n          }\r\n        } else {\r\n          // console.log('[OAUTH_CONT] Incomplete OAuth signup deleted successfully');\r\n        }\r\n      } catch (deleteError) {\r\n        console.warn(\"[OAUTH_CONT] Error deleting incomplete signup:\", deleteError);\r\n      }\r\n    }\r\n\r\n    // Sign out and clear session\r\n    try {\r\n      await supabase.auth.signOut();\r\n    } catch {}\r\n\r\n    try {\r\n      await fetch(\"/auth/session\", { method: \"DELETE\" });\r\n    } catch {}\r\n\r\n    // Clear OAuth context\r\n    clearOAuthContext();\r\n\r\n    // Clear Supabase storage\r\n    try {\r\n      const keys = Object.keys(localStorage);\r\n      keys.forEach(key => {\r\n        if (key.startsWith(\"sb-\") || key.includes(\"supabase\")) {\r\n          localStorage.removeItem(key);\r\n        }\r\n      });\r\n    } catch {}\r\n  } catch (error) {\r\n    console.warn(\"[OAUTH_CONT] Error cleaning up incomplete OAuth signup:\", error);\r\n  }\r\n};\r\n\r\n// Validate that user should be on this page\r\nconst validateOAuthContinuation = async () => {\r\n  // console.log('[OAUTH_CONT_VALIDATE] Starting validation...');\r\n  try {\r\n    // First check if user has a session (this is the primary requirement)\r\n    // Retry a few times in case session is still being set\r\n    let session = null;\r\n    let error = null;\r\n    let retries = 3;\r\n\r\n    while (retries > 0 && !session) {\r\n      // console.log(`[OAUTH_CONT_VALIDATE] Checking session (${4 - retries}/3)...`);\r\n      const result = await supabase.auth.getSession();\r\n      session = result.data?.session;\r\n      error = result.error;\r\n\r\n      if (session) {\r\n        // console.log('[OAUTH_CONT_VALIDATE] ✅ Session found!');\r\n        break;\r\n      }\r\n\r\n      if (retries > 1) {\r\n        // console.log('[OAUTH_CONT_VALIDATE] ⏳ Session not found, retrying in 500ms...');\r\n        await new Promise(resolve => setTimeout(resolve, 500));\r\n      }\r\n      retries--;\r\n    }\r\n\r\n    /* console.log('[OAUTH_CONT_VALIDATE] Session check result:', {\r\n      hasSession: !!session,\r\n      hasError: !!error,\r\n      error: error?.message,\r\n      userId: session?.user?.id\r\n    }); */\r\n\r\n    if (!session || error) {\r\n      // No session - user shouldn't be here\r\n      console.warn(\"[OAUTH_CONT_VALIDATE] ❌ No session found after retries:\", error);\r\n      // console.log('[OAUTH_CONT_VALIDATE] Checking localStorage for session data...');\r\n\r\n      // Check if there's any session data in localStorage\r\n      const storageKeys = Object.keys(localStorage);\r\n      const _supabaseKeys = storageKeys.filter(k => k.includes(\"supabase\") || k.startsWith(\"sb-\"));\r\n      // console.log('[OAUTH_CONT_VALIDATE] Supabase storage keys:', supabaseKeys);\r\n\r\n      // console.log('[OAUTH_CONT_VALIDATE] Redirecting to signup...');\r\n      showMessage(\"error\", \"Session expired. Please start over.\");\r\n      cleanupIncompleteOAuthSignup(\"Session expired\");\r\n      setTimeout(() => {\r\n        window.location.href = \"/signup\";\r\n      }, 2000);\r\n      return false;\r\n    }\r\n\r\n    // console.log('[OAUTH_CONT_VALIDATE] ✅ Session exists');\r\n\r\n    // Check if user is already fully registered\r\n    // console.log('[OAUTH_CONT_VALIDATE] Checking registration status...');\r\n    const {user} = session;\r\n    const role = user?.user_metadata?.role || user?.raw_user_meta_data?.role;\r\n    const name = user?.user_metadata?.name || user?.raw_user_meta_data?.name;\r\n    const hasMobile = user?.user_metadata?.mobile_number ||\r\n                     user?.user_metadata?.mobile ||\r\n                     user?.phone;\r\n\r\n    /* console.log('[OAUTH_CONT_VALIDATE] Registration check:', {\r\n      role: role || 'missing',\r\n      name: name || 'missing',\r\n      hasMobile: !!hasMobile,\r\n      isFullyRegistered: !!(role && name && hasMobile)\r\n    }); */\r\n\r\n    if (role && name && hasMobile) {\r\n      // User is already fully registered - redirect to dashboard\r\n      console.log(\"[OAUTH_CONT_VALIDATE] ❌ User already fully registered, redirecting to dashboard\");\r\n      clearOAuthContext();\r\n      window.location.href = \"/dashboard\";\r\n      return false;\r\n    }\r\n\r\n    // console.log('[OAUTH_CONT_VALIDATE] ✅ User is not fully registered');\r\n\r\n    // Check if there's a valid OAuth context\r\n    // console.log('[OAUTH_CONT_VALIDATE] Checking OAuth context...');\r\n    let ctx = getOAuthContext();\r\n    // console.log('[OAUTH_CONT_VALIDATE] OAuth context:', ctx);\r\n\r\n    if (!ctx || ctx.intent !== \"signup\") {\r\n      // Context might be missing if page was refreshed or context was cleared\r\n      // Check if user has OAuth identity to determine if this is an OAuth signup\r\n      const provider = user?.identities?.[0]?.provider;\r\n      // console.log('[OAUTH_CONT_VALIDATE] Context missing or wrong intent, checking provider:', provider);\r\n\r\n      if (provider) {\r\n        // User has OAuth identity but no context - recreate context\r\n        // console.log('[OAUTH_CONT_VALIDATE] ✅ OAuth context missing, recreating from session');\r\n        ctx = {\r\n          provider,\r\n          email: user.email,\r\n          intent: \"signup\",\r\n          status: \"handoff\",\r\n          startedAt: Date.now()\r\n        };\r\n        setOAuthContext(ctx);\r\n        // console.log('[OAUTH_CONT_VALIDATE] Recreated context:', ctx);\r\n      } else {\r\n        // No OAuth identity - user shouldn't be here\r\n        console.warn(\"[OAUTH_CONT_VALIDATE] ❌ No OAuth context and no OAuth identity found\");\r\n        showMessage(\"error\", \"No active OAuth signup found. Redirecting to signup...\");\r\n        setTimeout(() => {\r\n          window.location.href = \"/signup\";\r\n        }, 2000);\r\n        return false;\r\n      }\r\n    } else {\r\n      // console.log('[OAUTH_CONT_VALIDATE] ✅ OAuth context exists');\r\n    }\r\n\r\n    // User should be here - update context status if needed\r\n    if (ctx.status !== \"handoff\" && ctx.status !== \"completed\") {\r\n      // console.log('[OAUTH_CONT_VALIDATE] Updating context status to handoff');\r\n      setOAuthContext({ ...ctx, status: \"handoff\" });\r\n    }\r\n\r\n    // console.log('[OAUTH_CONT_VALIDATE] ✅ Validation passed, showing form');\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"[OAUTH_CONT] Validation error:\", error);\r\n    return false;\r\n  }\r\n};\r\n\r\nconst CAPTCHA_RENDER_FLAG = \"__oauthCaptchaRendered\";\r\n\r\n// Fetch CAPTCHA key for OAuth continuation\r\nconst fetchCaptchaKey = async () => {\r\n  try {\r\n    const response = await fetch(\"/api/captcha/oauth-key\");\r\n    const data = await response.json();\r\n    if (data.success && data.key) {\r\n      return data.key;\r\n    }\r\n    console.error(\"Failed to fetch CAPTCHA key:\", data.error);\r\n    return null;\r\n  } catch (error) {\r\n    console.error(\"Error fetching CAPTCHA key:\", error);\r\n    return null;\r\n  }\r\n};\r\n\r\n// Initialize CAPTCHA on OAuth continuation page\r\nconst initializeCaptcha = async () => {\r\n  const captchaContainer = document.getElementById(\"oauth-complete-captcha\");\r\n  if (!captchaContainer || !window.grecaptcha) {\r\n    console.warn(\"CAPTCHA not available\");\r\n    return;\r\n  }\r\n\r\n  if (captchaContainer.dataset.rendered === \"true\" || window[CAPTCHA_RENDER_FLAG]) {\r\n    // console.log('[OAUTH_CONT] CAPTCHA already rendered, skipping re-render');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const siteKey = await fetchCaptchaKey();\r\n    if (siteKey) {\r\n      window.grecaptcha.ready(() => {\r\n        if (captchaContainer.dataset.rendered === \"true\" || window[CAPTCHA_RENDER_FLAG]) {\r\n          // console.log('[OAUTH_CONT] CAPTCHA rendered during wait, skipping');\r\n          return;\r\n        }\r\n        window.grecaptcha.render(captchaContainer, {\r\n          sitekey: siteKey\r\n        });\r\n        captchaContainer.dataset.rendered = \"true\";\r\n        window[CAPTCHA_RENDER_FLAG] = true;\r\n        // console.log('[OAUTH_CONT] CAPTCHA rendered successfully');\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Failed to initialize CAPTCHA:\", error);\r\n  }\r\n};\r\n\r\n// Setup interruption handlers\r\nconst setupInterruptionHandlers = () => {\r\n  // Handle tab close / navigation away\r\n  const handleBeforeUnload = (_e) => {\r\n    const ctx = getOAuthContext();\r\n    if (ctx && ctx.intent === \"signup\" && ctx.status !== \"completed\") {\r\n      // Cleanup on page unload (but don't block navigation)\r\n      cleanupIncompleteOAuthSignup(\"User closed tab or navigated away\");\r\n    }\r\n  };\r\n\r\n  // Handle visibility change (user switches tabs)\r\n  const handleVisibilityChange = () => {\r\n    if (document.visibilityState === \"hidden\") {\r\n      const ctx = getOAuthContext();\r\n      if (ctx && ctx.intent === \"signup\" && ctx.status !== \"completed\") {\r\n        // Mark as potentially abandoned\r\n        setOAuthContext({ ...ctx, lastActivity: Date.now() });\r\n      }\r\n    } else if (document.visibilityState === \"visible\") {\r\n      // Check if OAuth signup is stale (abandoned for more than 5 minutes)\r\n      const ctx = getOAuthContext();\r\n      if (ctx && ctx.intent === \"signup\" && ctx.status !== \"completed\") {\r\n        const lastActivity = ctx.lastActivity || ctx.startedAt || 0;\r\n        const elapsed = Date.now() - lastActivity;\r\n        const STALE_TIMEOUT = 60 * 60 * 1000; // 60 minutes\r\n\r\n        if (elapsed > STALE_TIMEOUT) {\r\n          showMessage(\"error\", \"OAuth signup session expired. Please start over.\");\r\n          cleanupIncompleteOAuthSignup(\"Session expired due to inactivity\");\r\n          setTimeout(() => {\r\n            window.location.href = \"/signup\";\r\n          }, 2000);\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  // Handle page hide (navigation away)\r\n  const handlePageHide = () => {\r\n    const ctx = getOAuthContext();\r\n    if (ctx && ctx.intent === \"signup\" && ctx.status !== \"completed\") {\r\n      cleanupIncompleteOAuthSignup(\"User navigated away\");\r\n    }\r\n  };\r\n\r\n  window.addEventListener(\"beforeunload\", handleBeforeUnload);\r\n  document.addEventListener(\"visibilitychange\", handleVisibilityChange);\r\n  window.addEventListener(\"pagehide\", handlePageHide);\r\n\r\n  // Return cleanup function\r\n  return () => {\r\n    window.removeEventListener(\"beforeunload\", handleBeforeUnload);\r\n    document.removeEventListener(\"visibilitychange\", handleVisibilityChange);\r\n    window.removeEventListener(\"pagehide\", handlePageHide);\r\n  };\r\n};\r\n\r\n// Initialize OAuth continuation page\r\nconst initializeOAuthContinuationPage = async () => {\r\n  suppressAuthErrorNotifications();\r\n  // console.log('[OAUTH_CONT] ========================================');\r\n  // console.log('[OAUTH_CONT] Initializing OAuth continuation page...');\r\n  // console.log('[OAUTH_CONT] URL:', window.location.href);\r\n  // console.log('[OAUTH_CONT] URL Hash:', window.location.hash);\r\n  // console.log('[OAUTH_CONT] Timestamp:', new Date().toISOString());\r\n\r\n  // Check if there are tokens in the URL hash (from Supabase redirect)\r\n  if (window.location.hash) {\r\n    // console.log('[OAUTH_CONT] URL hash detected, Supabase may extract session from it');\r\n    // Supabase will automatically handle tokens in URL hash\r\n    // Wait a moment for Supabase to process the hash\r\n    await new Promise(resolve => setTimeout(resolve, 500));\r\n  }\r\n\r\n  // Check OAuth context\r\n  const ctx = getOAuthContext();\r\n  // console.log('[OAUTH_CONT] OAuth Context:', ctx);\r\n\r\n  // Update page title and subtitle based on user type\r\n  const updatePageMessages = () => {\r\n    const isNewSignup = ctx?.isNewSignup || ctx?.intent === \"signup\";\r\n    const _userType = ctx?._userType || (isNewSignup ? \"new\" : \"existing\");\r\n    const customMessage = ctx?.message;\r\n\r\n    // Update page title\r\n    const titleElement = document.querySelector(\".auth-title\");\r\n    if (titleElement) {\r\n      if (isNewSignup) {\r\n        titleElement.textContent = \"Complete Your Registration\";\r\n      } else {\r\n        titleElement.textContent = \"Complete Your Profile\";\r\n      }\r\n    }\r\n\r\n    // Update subtitle\r\n    const subtitleElement = document.querySelector(\".auth-subtitle\");\r\n    if (subtitleElement) {\r\n      if (customMessage) {\r\n        subtitleElement.textContent = customMessage;\r\n      } else if (isNewSignup) {\r\n        subtitleElement.textContent = \"Please provide your information to complete your registration.\";\r\n      } else {\r\n        subtitleElement.textContent = \"Your profile is incomplete. Please provide the missing information to continue.\";\r\n      }\r\n    }\r\n\r\n    // Update submit button text\r\n    const submitButton = document.getElementById(\"signup-submit-btn\");\r\n    if (submitButton) {\r\n      if (isNewSignup) {\r\n        submitButton.textContent = \"Complete Registration\";\r\n      } else {\r\n        submitButton.textContent = \"Update Profile\";\r\n      }\r\n    }\r\n\r\n    /* console.log('[OAUTH_CONT] Updated page messages:', {\r\n      isNewSignup,\r\n      userType,\r\n      customMessage\r\n    }); */\r\n  };\r\n\r\n  // Update messages if context is available\r\n  if (ctx) {\r\n    updatePageMessages();\r\n  }\r\n\r\n  // Check session\r\n  const { data: { session }, error: _sessionError } = await supabase.auth.getSession();\r\n  // console.log('[OAUTH_CONT] Session exists:', !!session);\r\n  // console.log('[OAUTH_CONT] Session error:', sessionError);\r\n  if (session?.user) {\r\n    /* console.log('[OAUTH_CONT] User ID:', session.user.id);\r\n    console.log('[OAUTH_CONT] User email:', session.user.email);\r\n    console.log('[OAUTH_CONT] User metadata:', {\r\n      role: session.user.user_metadata?.role || session.user.raw_user_meta_data?.role,\r\n      name: session.user.user_metadata?.name || session.user.raw_user_meta_data?.name,\r\n      mobile: session.user.user_metadata?.mobile_number || session.user.user_metadata?.mobile,\r\n      provider: session.user.identities?.[0]?.provider\r\n    }); */\r\n  }\r\n\r\n  const form = document.getElementById(\"oauthCompleteForm\");\r\n  const _steps = document.getElementById(\"signup-_steps\");\r\n  const step1 = document.querySelector('.signup-step[data-step=\"1\"]');\r\n  // console.log('[OAUTH_CONT] Form element exists:', !!form);\r\n  // console.log('[OAUTH_CONT] Steps container exists:', !!steps);\r\n  // console.log('[OAUTH_CONT] Step 1 exists:', !!step1);\r\n\r\n  // First, validate that user should be here\r\n  // console.log('[OAUTH_CONT] Starting validation...');\r\n  const isValid = await validateOAuthContinuation();\r\n  // console.log('[OAUTH_CONT] Validation result:', isValid);\r\n\r\n  // Re-check context after validation (it might have been updated)\r\n  const updatedCtx = getOAuthContext();\r\n  if (updatedCtx && updatedCtx !== ctx) {\r\n    updatePageMessages();\r\n  }\r\n\r\n  if (!isValid) {\r\n    // console.log('[OAUTH_CONT] ❌ Validation failed, redirecting...');\r\n    // console.log('[OAUTH_CONT] ========================================');\r\n    return; // Validation failed, redirect will happen\r\n  }\r\n\r\n  // console.log('[OAUTH_CONT] ✅ Validation passed, setting up page...');\r\n\r\n  // Setup interruption handlers\r\n  // console.log('[OAUTH_CONT] Setting up interruption handlers...');\r\n  setupInterruptionHandlers();\r\n\r\n  // Prefill OAuth data manually (oauth-complete.js handles form submission)\r\n  // console.log('[OAUTH_CONT] Prefilling OAuth data...');\r\n  try {\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    const user = session?.user;\r\n    if (user) {\r\n      const identityData = user.identities?.[0]?.identity_data || {};\r\n      const meta = user.user_metadata || {};\r\n      const rawMeta = user.raw_user_meta_data || {};\r\n      const combined = { ...identityData, ...meta, ...rawMeta };\r\n      const fullName = combined.full_name || combined.name || \"\";\r\n\r\n      // Prioritize explicit fields\r\n      let firstName = combined.given_name || combined.first_name || \"\";\r\n      let lastName = combined.family_name || combined.last_name || \"\";\r\n      const middleName = combined.middle_name || \"\";\r\n\r\n      // If explicit fields are missing, try to parse from full name\r\n      if (!firstName && !lastName && fullName) {\r\n        const nameParts = fullName.trim().split(\" \");\r\n        if (nameParts.length === 1) {\r\n          firstName = nameParts[0];\r\n        } else if (nameParts.length > 1) {\r\n          // Assume last word is last name, everything else is first name\r\n          // Do NOT infer middle name automatically to avoid splitting multi-word first names\r\n          lastName = nameParts.pop();\r\n          firstName = nameParts.join(\" \");\r\n        }\r\n      }\r\n\r\n      const firstNameInput = document.getElementById(\"firstName\");\r\n      if (firstNameInput && firstName) {\r\n        firstNameInput.value = firstName;\r\n        // console.log('[OAUTH_CONT] Prefilled firstName:', firstName);\r\n      }\r\n      const middleNameInput = document.getElementById(\"middleName\");\r\n      if (middleNameInput) {\r\n        if (middleName) {\r\n          middleNameInput.value = middleName;\r\n          // console.log('[OAUTH_CONT] Prefilled middleName:', middleName);\r\n        } else {\r\n          // Enable if empty so user can enter it or leave it blank\r\n          middleNameInput.removeAttribute(\"readonly\");\r\n          middleNameInput.removeAttribute(\"disabled\");\r\n          middleNameInput.removeAttribute(\"aria-disabled\");\r\n          middleNameInput.removeAttribute(\"title\");\r\n        }\r\n      }\r\n      const lastNameInput = document.getElementById(\"lastName\");\r\n      if (lastNameInput && lastName) {\r\n        lastNameInput.value = lastName;\r\n        // console.log('[OAUTH_CONT] Prefilled lastName:', lastName);\r\n      }\r\n      const emailInput = document.getElementById(\"email\");\r\n      if (emailInput && user.email) {\r\n        emailInput.value = user.email;\r\n        // console.log('[OAUTH_CONT] Prefilled email:', user.email);\r\n      }\r\n\r\n      // Try to get phone from OAuth provider\r\n      const oauthPhone = user.user_metadata?.phone_number ||\r\n                        user.user_metadata?.phone ||\r\n                        user.user_metadata?.mobile ||\r\n                        null;\r\n      const mobileInput = document.getElementById(\"mobile\");\r\n      if (mobileInput && oauthPhone) {\r\n        let digits = oauthPhone.replace(/\\D/g, \"\");\r\n        if (digits.startsWith(\"63\") && digits.length >= 12) {\r\n          digits = digits.substring(2, 12);\r\n        } else if (digits.length > 10) {\r\n          digits = digits.substring(digits.length - 10);\r\n        }\r\n        if (digits.length === 10) {\r\n          mobileInput.value = digits;\r\n          // console.log('[OAUTH_CONT] Prefilled mobile:', digits);\r\n        }\r\n      }\r\n    }\r\n  } catch (prefillError) {\r\n    console.warn(\"[OAUTH_CONT] Prefill failed:\", prefillError);\r\n  }\r\n\r\n  // Initialize CAPTCHA\r\n  // console.log('[OAUTH_CONT] Initializing CAPTCHA...');\r\n  initializeCaptcha();\r\n\r\n  // Re-initialize CAPTCHA after a delay to handle async script loading\r\n  setTimeout(initializeCaptcha, 1000);\r\n\r\n  // Verify form is visible\r\n  const _formVisible = form && form.offsetParent !== null;\r\n  const _step1Visible = step1 && step1.offsetParent !== null;\r\n  /* console.log('[OAUTH_CONT] Form visibility check:', {\r\n    formExists: !!form,\r\n    formVisible: formVisible,\r\n    step1Exists: !!step1,\r\n    step1Visible: step1Visible,\r\n    step1Hidden: step1?.hasAttribute('hidden')\r\n  }); */\r\n\r\n\r\n  // console.log('[OAUTH_CONT] ✅ Page initialization complete');\r\n  // console.log('[OAUTH_CONT] ========================================');\r\n};\r\n\r\n// Global handler for ID verification success (called by signup-id-verify.js)\r\nwindow.handleVerificationSuccess = (data) => {\r\n  console.log(\"[OAUTH_CONT] Handling verification success:\", data);\r\n\r\n  if (!data) return;\r\n\r\n  // Populate form fields with OCR data\r\n  const fields = {\r\n    firstName: data.firstName,\r\n    lastName: data.lastName,\r\n    middleName: data.middleName,\r\n    addressLine1: data.address,\r\n    // Map other fields if needed\r\n  };\r\n\r\n  let updatedCount = 0;\r\n\r\n  Object.entries(fields).forEach(([id, value]) => {\r\n    if (value) {\r\n      const input = document.getElementById(id);\r\n      if (input) {\r\n        // Only update if empty or user explicitly wants to overwrite (for now just update)\r\n        // Or maybe highlight matches?\r\n        // User said: \"if it matches the field in both the id and the form\"\r\n        // This implies validation. But prefilling is a good first step.\r\n        if (input.value !== value) {\r\n          input.value = value;\r\n          input.dispatchEvent(new Event(\"input\", { bubbles: true }));\r\n          updatedCount++;\r\n        }\r\n      }\r\n    }\r\n  });\r\n\r\n  if (updatedCount > 0) {\r\n    showMessage(\"success\", \"Form updated with ID information.\");\r\n  } else {\r\n    showMessage(\"success\", \"ID verified. Information matches form.\");\r\n  }\r\n\r\n  // Unlock next step if needed (handled by signup-progressive.js usually)\r\n  const nextBtn = document.getElementById(\"signup-next-btn\");\r\n  if (nextBtn) {\r\n    nextBtn.removeAttribute(\"disabled\");\r\n  }\r\n};\r\n\r\n// Initialize when DOM is ready\r\n// Initialize when DOM is ready\r\n// console.log('[OAUTH_CONT] Setting up initialization, document.readyState:', document.readyState);\r\n\r\nif (document.readyState === \"loading\") {\r\n  // console.log('[OAUTH_CONT] Document still loading, waiting for DOMContentLoaded...');\r\n  document.addEventListener(\"DOMContentLoaded\", () => {\r\n    // console.log('[OAUTH_CONT] DOMContentLoaded fired, initializing...');\r\n    initializeOAuthContinuationPage();\r\n  });\r\n} else {\r\n  // console.log('[OAUTH_CONT] Document already ready, initializing immediately...');\r\n  initializeOAuthContinuationPage();\r\n}\r\n\r\n// Also try immediate execution as fallback\r\nsetTimeout(() => {\r\n  // console.log('[OAUTH_CONT] Fallback timeout check, readyState:', document.readyState);\r\n  if (document.readyState === \"complete\" || document.readyState === \"interactive\") {\r\n    // console.log('[OAUTH_CONT] Fallback: Attempting initialization...');\r\n    initializeOAuthContinuationPage();\r\n  }\r\n}, 100);\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\auth\\roleToggle.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\auth\\signup-page.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'suppressAuthErrorNotifications' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":63,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":93},{"ruleId":"no-unused-vars","severity":1,"message":"'shouldSkipAuthCheck' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":29},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":389,"column":36,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":389,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Signup page specific functionality\r\nimport { supabase } from \"../config/config.js\";\r\nimport showMessage from \"../components/toast.js\";\r\nimport { renderPrivacyNotice } from \"../utils/privacyContent.js\";\r\nimport { getOAuthContext, setOAuthContext, clearOAuthContext, suppressAuthErrorNotifications } from \"../auth/authChecker.js\";\r\nimport { shouldSkipAuthCheck } from \"../utils/oauth-cleanup.js\";\r\n\r\n// Check if user is already logged in and redirect to dashboard\r\nconst shouldDeferAuthRedirect = () => {\r\n  try {\r\n    const ctx = getOAuthContext();\r\n    return ctx && ctx.intent === \"signup\" && ctx.status === \"pending\";\r\n  } catch {\r\n    return false;\r\n  }\r\n};\r\n\r\n// Global Guard handles all cleanup now - redundant code removed\r\n\r\nconst checkAuthentication = async () => {\r\n  try {\r\n    // Global Guard already ran at init\r\n    // await clearOAuthContextOnLanding();\r\n\r\n    // Check if we just cleaned up OAuth - skip redirects\r\n    let oauthCleanupFlag = false;\r\n    try {\r\n      oauthCleanupFlag = sessionStorage.getItem(\"cl_oauth_cleanup\") === \"true\";\r\n      if (oauthCleanupFlag) {\r\n        sessionStorage.removeItem(\"cl_oauth_cleanup\");\r\n      }\r\n    } catch {}\r\n\r\n    // If we just cleaned up, don't redirect - let user proceed with signup\r\n    if (oauthCleanupFlag) {\r\n      return;\r\n    }\r\n\r\n    // Check for pending OAuth - if exists and user explicitly navigated, don't redirect\r\n    // But allow legitimate OAuth continuation redirects\r\n    const oauthCtx = getOAuthContext();\r\n    const hasPendingOAuth = oauthCtx && oauthCtx.status === \"pending\";\r\n\r\n    // Only skip redirect if user explicitly navigated (not from OAuth redirect)\r\n    if (hasPendingOAuth) {\r\n      const urlParams = new URLSearchParams(window.location.search);\r\n      const isOAuthRedirect = urlParams.get(\"code\") || urlParams.get(\"error\") || urlParams.get(\"popup\") === \"1\";\r\n      // If user explicitly navigated (not from OAuth), don't redirect\r\n      if (!isOAuthRedirect) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    // console.log removed for security\r\n    // Get current session\r\n    const { data: { session }, error } = await supabase.auth.getSession();\r\n    if (session && !error) {\r\n      // console.log removed for security\r\n      // Get user metadata\r\n      const {user} = session;\r\n      const role = user?.user_metadata?.role || \"\";\r\n      const name = user?.user_metadata?.name || \"\";\r\n      // Check if user has completed registration\r\n      if (role && name) {\r\n        // console.log removed for security\r\n        if (shouldDeferAuthRedirect()) return;\r\n        window.location.href = \"/dashboard\";\r\n      } else {\r\n        // User has incomplete registration - redirect to continuation\r\n        // This is the normal flow after OAuth signup\r\n        // Only defer if there's a pending OAuth and user explicitly navigated\r\n        if (shouldDeferAuthRedirect()) {\r\n          const urlParams = new URLSearchParams(window.location.search);\r\n          const isOAuthRedirect = urlParams.get(\"code\") || urlParams.get(\"error\") || urlParams.get(\"popup\") === \"1\";\r\n          // If not from OAuth redirect, don't redirect to continuation\r\n          if (!isOAuthRedirect) {\r\n            return;\r\n          }\r\n        }\r\n        // console.log removed for security\r\n        window.location.href = \"/oauth-continuation\";\r\n      }\r\n    } else {\r\n      // console.log removed for security\r\n    }\r\n  } catch (error) {\r\n    console.error(\"💥 Authentication check failed:\", error);\r\n    // If there's an error, let the user proceed with signup\r\n  }\r\n};\r\n\r\nlet resetSignupStateHandler = null;\r\nlet oauthAbortWatcherInstalled = false;\r\n\r\n// Initialize signup page\r\nconst initializeSignupPage = async () => {\r\n  // CRITICAL: Run Global OAuth Guard FIRST to wipe stale state\r\n  const { initGlobalOAuthGuard } = await import(\"../utils/global-oauth-guard.js\");\r\n  await initGlobalOAuthGuard();\r\n\r\n  // Setup navigation cleanup for login/signup buttons and brand logo\r\n  const { setupNavigationCleanup } = await import(\"../utils/navigation.js\");\r\n  setupNavigationCleanup();\r\n\r\n  // Run authentication check when page loads\r\n  checkAuthentication();\r\n\r\n  // Wire password strength meter\r\n  attachPasswordStrengthMeter();\r\n\r\n  // Listen for auth state changes to update UI dynamically\r\n  supabase.auth.onAuthStateChange((event, session) => {\r\n    // console.log removed for security\r\n    if (event === \"SIGNED_IN\" && session) {\r\n      checkAuthentication();\r\n    }\r\n  });\r\n  // Terms & Privacy Modals are now handled by the SimpleModal component\r\n  // Listen for acceptance events to update the checkbox\r\n  document.addEventListener(\"termsAccepted\", () => {\r\n    const termsCheckbox = document.getElementById(\"terms-checkbox\");\r\n    if (termsCheckbox) termsCheckbox.checked = true;\r\n  });\r\n  document.addEventListener(\"privacyAccepted\", () => {\r\n    const termsCheckbox = document.getElementById(\"terms-checkbox\");\r\n    if (termsCheckbox) termsCheckbox.checked = true;\r\n  });\r\n  renderPrivacyNotice(\"#privacyModalContent\", { headingTag: \"h4\" });\r\n  setupSignupMethodSelector();\r\n  setupOAuthPopupBridge();\r\n  setupOAuthAbortWatcher();\r\n};\r\n// --- Live password strength meter wiring ---\r\nfunction attachPasswordStrengthMeter() {\r\n  try {\r\n    const passwordInput = document.getElementById(\"regPassword\");\r\n    const strengthFill = document.getElementById(\"strength-fill\");\r\n    const strengthText = document.getElementById(\"strength-text\");\r\n    if (!passwordInput || !strengthFill || !strengthText) return;\r\n    const _classList = [\"weak\", \"fair\", \"good\", \"strong\"];\r\n    const calcScore = (pwd) => {\r\n      let score = 0;\r\n      if (!pwd) return 0;\r\n      if (pwd.length >= 8) score++;\r\n      if (pwd.length >= 12) score++;\r\n      if (/[a-z]/.test(pwd)) score++;\r\n      if (/[A-Z]/.test(pwd)) score++;\r\n      if (/\\d/.test(pwd)) score++;\r\n      if (/[!@#$%^&*()_+\\-=[\\]{};':\"\\\\|,.<>/?]/.test(pwd)) score++;\r\n      // penalties\r\n      if (/(.)\\1{2,}/.test(pwd)) score -= 1;\r\n      if (/123456|abcdef|qwerty|asdfgh|zxcvbn/i.test(pwd)) score -= 2;\r\n      return Math.max(0, Math.min(4, score));\r\n    };\r\n\r\n    const labelFor = (score) => {\r\n      switch (true) {\r\n        case score <= 1: return \"Weak\";\r\n        case score === 2: return \"Fair\";\r\n        case score === 3: return \"Good\";\r\n        default: return \"Strong\";\r\n      }\r\n    };\r\n    const classFor = (score) => {\r\n      if (score <= 1) return \"weak\";\r\n      if (score === 2) return \"fair\";\r\n      if (score === 3) return \"good\";\r\n      return \"strong\";\r\n    };\r\n    const update = () => {\r\n      const pwd = passwordInput.value || \"\";\r\n      // Do not evaluate if empty or less than 8 chars\r\n      if (pwd.length < 8) {\r\n        strengthFill.classList.remove(\"weak\",\"fair\",\"good\",\"strong\");\r\n        strengthText.classList.remove(\"weak\",\"fair\",\"good\",\"strong\");\r\n        strengthFill.style.width = \"0%\";\r\n        strengthText.textContent = \"Password strength\";\r\n        return;\r\n      }\r\n      const score = calcScore(pwd);\r\n      const cls = classFor(score);\r\n      // reset\r\n      strengthFill.classList.remove(\"weak\",\"fair\",\"good\",\"strong\");\r\n      strengthText.classList.remove(\"weak\",\"fair\",\"good\",\"strong\");\r\n      // Apply base width 0 first\r\n      strengthFill.style.width = \"0%\";\r\n      // apply classes\r\n      strengthFill.classList.add(cls);\r\n      strengthText.classList.add(cls);\r\n      // Map class to width explicitly in case CSS not applied yet\r\n      const widthMap = { weak: \"25%\", fair: \"50%\", good: \"75%\", strong: \"100%\" };\r\n      strengthFill.style.width = widthMap[cls];\r\n      strengthText.textContent = `Password strength: ${labelFor(score)}`;\r\n    };\r\n    passwordInput.addEventListener(\"input\", update);\r\n    update();\r\n  } catch (_) {}\r\n}\r\n// Initialize when DOM is ready\r\nif (document.readyState === \"loading\") {\r\n  document.addEventListener(\"DOMContentLoaded\", initializeSignupPage);\r\n} else {\r\n  initializeSignupPage();\r\n}\r\n\r\n// --- Signup method selector ---\r\nconst METHOD_STORAGE_KEY = \"cl_signup_method\";\r\n\r\nfunction setupSignupMethodSelector() {\r\n  const regForm = document.getElementById(\"regForm\");\r\n  const emailFlow = document.getElementById(\"signup-email-flow\");\r\n  const placeholder = document.getElementById(\"signup-flow-placeholder\");\r\n  const methodSection = document.getElementById(\"signup-method-section\");\r\n  const methodBackBtn = document.getElementById(\"signup-method-back\");\r\n  const buttons = document.querySelectorAll(\"[data-signup-method]\");\r\n  if (!regForm || !emailFlow) return;\r\n\r\n  const selectMethod = (method, { persist = false } = {}) => {\r\n    regForm.dataset.method = method;\r\n    buttons.forEach((btn) => {\r\n      const isActive = btn.dataset.signupMethod === method;\r\n      btn.setAttribute(\"aria-pressed\", isActive ? \"true\" : \"false\");\r\n    });\r\n    if (method === \"email\") {\r\n      methodSection?.setAttribute(\"hidden\", \"\");\r\n      methodBackBtn?.removeAttribute(\"hidden\");\r\n      emailFlow.hidden = false;\r\n      placeholder?.setAttribute(\"hidden\", \"\");\r\n    } else {\r\n      methodSection?.removeAttribute(\"hidden\");\r\n      methodBackBtn?.setAttribute(\"hidden\", \"\");\r\n      emailFlow.hidden = true;\r\n      if (method === \"none\") {\r\n        placeholder?.removeAttribute(\"hidden\");\r\n      } else {\r\n        placeholder?.setAttribute(\"hidden\", \"\");\r\n      }\r\n    }\r\n    if (persist) {\r\n      try {\r\n        if (method === \"email\") {\r\n          localStorage.setItem(METHOD_STORAGE_KEY, \"email\");\r\n        } else {\r\n          localStorage.removeItem(METHOD_STORAGE_KEY);\r\n        }\r\n      } catch {}\r\n    }\r\n  };\r\n\r\n  const resetSignupState = ({ persist = true } = {}) => {\r\n    if (regForm) {\r\n      regForm.reset();\r\n      regForm.dataset.method = \"none\";\r\n    }\r\n    selectMethod(\"none\", { persist });\r\n    clearOAuthContext();\r\n    try { localStorage.removeItem(\"cl_signup_step_index\"); } catch {} // Reset step index storage\r\n    document.dispatchEvent(new Event(\"signup-reset\")); // Reset UI step to 0\r\n  };\r\n  resetSignupStateHandler = resetSignupState;\r\n\r\n  buttons.forEach((btn) => {\r\n    btn.addEventListener(\"click\", () => {\r\n      const method = btn.dataset.signupMethod || \"email\";\r\n      selectMethod(method, { persist: true });\r\n    });\r\n  });\r\n\r\n  // Restore last method if it was email to keep the form open\r\n  let cachedMethod = null;\r\n  try {\r\n    cachedMethod = localStorage.getItem(METHOD_STORAGE_KEY);\r\n  } catch {}\r\n  if (cachedMethod === \"email\") {\r\n    selectMethod(\"email\");\r\n  } else {\r\n    selectMethod(\"none\");\r\n  }\r\n\r\n  methodBackBtn?.addEventListener(\"click\", () => {\r\n    resetSignupState({ persist: true });\r\n    const methodTop = methodSection?.offsetTop || 0;\r\n    window.scrollTo({ top: methodTop - 40, behavior: \"smooth\" });\r\n  });\r\n\r\n  // Removed handlePageExit to allow persistence across refreshes\r\n  // window.addEventListener('pagehide', handlePageExit);\r\n  // window.addEventListener('beforeunload', handlePageExit);\r\n}\r\n\r\nfunction setupOAuthPopupBridge() {\r\n  window.addEventListener(\"message\", async (event) => {\r\n    if (event.origin !== window.location.origin) return;\r\n\r\n    // Log the full event data to debug\r\n    // console.log('[SIGNUP] Received message from popup:', event.data); // Redacted for security\r\n    console.log(\"[SIGNUP] Full event:\", {\r\n      type: event.data?.type,\r\n      redirectTo: event.data?.redirectTo,\r\n      incomplete: event.data?.incomplete,\r\n      // payload: event.data?.payload, // Redacted for security\r\n      // fullData: event.data // Redacted for security\r\n    });\r\n\r\n    const { type, payload, redirectTo, incomplete } = event.data || {};\r\n\r\n    if (type === \"oauth-signup-success\") {\r\n      const provider = (payload?.provider || \"OAuth\").replace(/^\\w/, (c) => c.toUpperCase());\r\n      console.log(\"[SIGNUP] ✅ OAuth signup success, provider:\", provider);\r\n      console.log(\"[SIGNUP] Message details:\", {\r\n        redirectTo,\r\n        incomplete,\r\n        hasPayload: Boolean(payload)\r\n      });\r\n\r\n      try {\r\n        const ctx = getOAuthContext() || {};\r\n        setOAuthContext({ ...ctx, status: \"handoff\" });\r\n        console.log(\"[SIGNUP] OAuth context updated to handoff\");\r\n      } catch (e) {\r\n        console.error(\"[SIGNUP] Error updating OAuth context:\", e);\r\n      }\r\n\r\n      // CRITICAL: Set the session in this window before redirecting\r\n      // Supabase sessions are window-specific, so we need to sync it from popup\r\n      const accessToken = event.data?.accessToken;\r\n      const refreshToken = event.data?.refreshToken;\r\n\r\n      if (accessToken && refreshToken) {\r\n        try {\r\n          console.log(\"[SIGNUP] Setting session in main window...\");\r\n          console.log(\"[SIGNUP] Access token length:\", accessToken.length);\r\n          console.log(\"[SIGNUP] Refresh token length:\", refreshToken.length);\r\n\r\n          // Set the session using setSession\r\n          const { _data, error } = await supabase.auth.setSession({\r\n            access_token: accessToken,\r\n            refresh_token: refreshToken\r\n          });\r\n\r\n          if (error) {\r\n            console.error(\"[SIGNUP] ❌ Error setting session:\", error);\r\n            console.error(\"[SIGNUP] Error details:\", error.message, error.status);\r\n          } else {\r\n            console.log(\"[SIGNUP] ✅ Session set successfully in main window\");\r\n\r\n            // Verify session is actually set\r\n            const { data: { session: verifySession }, error: verifyError } = await supabase.auth.getSession();\r\n            if (verifySession) {\r\n              console.log(\"[SIGNUP] ✅ Session verified - user ID:\", verifySession.user?.id);\r\n            } else {\r\n              console.error(\"[SIGNUP] ❌ Session verification failed:\", verifyError);\r\n            }\r\n\r\n            // Also set server-side cookie\r\n            try {\r\n              const cookieResponse = await fetch(\"/auth/session\", {\r\n                method: \"POST\",\r\n                headers: { \"Content-Type\": \"application/json\" },\r\n                body: JSON.stringify({ access_token: accessToken })\r\n              });\r\n              if (cookieResponse.ok) {\r\n                console.log(\"[SIGNUP] ✅ Server session cookie set\");\r\n              } else {\r\n                console.warn(\"[SIGNUP] ⚠️ Server session cookie not set:\", cookieResponse.status);\r\n              }\r\n            } catch (cookieError) {\r\n              console.warn(\"[SIGNUP] ⚠️ Error setting server cookie:\", cookieError);\r\n            }\r\n          }\r\n        } catch (sessionError) {\r\n          console.error(\"[SIGNUP] ❌ Error setting session:\", sessionError);\r\n          console.error(\"[SIGNUP] Error stack:\", sessionError.stack);\r\n        }\r\n      } else {\r\n        console.warn(\"[SIGNUP] ⚠️ No access/refresh tokens in message\");\r\n        console.warn(\"[SIGNUP] Access token:\", Boolean(accessToken), \"Refresh token:\", Boolean(refreshToken));\r\n      }\r\n\r\n      showMessage(\"success\", `${provider} connected. Finishing setup...`);\r\n\r\n      // CRITICAL: Always redirect to continuation for OAuth signups\r\n      // Extract redirectTo from event.data if not in destructured variables\r\n      const actualRedirectTo = redirectTo || event.data?.redirectTo || \"/oauth-continuation\";\r\n\r\n      console.log(\"[SIGNUP] Redirect decision:\", {\r\n        willRedirect: true,\r\n        redirectTo: actualRedirectTo,\r\n        incomplete: incomplete !== undefined ? incomplete : event.data?.incomplete,\r\n        eventDataKeys: Object.keys(event.data || {}),\r\n        hasAccessToken: Boolean(accessToken),\r\n        hasRefreshToken: Boolean(refreshToken)\r\n      });\r\n\r\n      console.log(\"[SIGNUP] ✅ REDIRECTING TO:\", actualRedirectTo);\r\n\r\n      // CRITICAL: If we have tokens, pass them in URL hash for Supabase to pick up\r\n      // This is how Supabase normally handles OAuth redirects\r\n      let redirectUrl = actualRedirectTo;\r\n      if (accessToken && refreshToken) {\r\n        // Add tokens to URL hash - Supabase will automatically extract and set them\r\n        const hashParams = new URLSearchParams();\r\n        hashParams.set(\"access_token\", accessToken);\r\n        hashParams.set(\"refresh_token\", refreshToken);\r\n        hashParams.set(\"type\", \"recovery\"); // This tells Supabase to set the session\r\n        redirectUrl = `${actualRedirectTo}#${hashParams.toString()}`;\r\n        console.log(\"[SIGNUP] Adding session tokens to URL hash for Supabase\");\r\n      }\r\n\r\n      // Increased delay to ensure session is fully set and persisted before redirect\r\n      setTimeout(async () => {\r\n        // Double-check session before redirect\r\n        const { data: { session: finalCheck }, error: _finalError } = await supabase.auth.getSession();\r\n        if (finalCheck) {\r\n          console.log(\"[SIGNUP] ✅ Final session check passed - user ID:\", finalCheck.user?.id);\r\n          console.log(\"[SIGNUP] Executing redirect now...\");\r\n          window.location.href = redirectUrl;\r\n        } else {\r\n          console.warn(\"[SIGNUP] ⚠️ Session check failed, but redirecting anyway with tokens in URL\");\r\n          console.warn(\"[SIGNUP] Supabase will extract tokens from URL hash\");\r\n          // Redirect anyway - Supabase will extract tokens from URL hash\r\n          window.location.href = redirectUrl;\r\n        }\r\n      }, 800); // Increased delay to ensure session is fully persisted\r\n    }\r\n    if (type === \"oauth-user-exists\") {\r\n      cleanupPendingOAuth(\"User already exist\");\r\n    }\r\n    if (type === \"oauth-signup-error\" && payload?.message) {\r\n      cleanupPendingOAuth(payload.message);\r\n    }\r\n  });\r\n}\r\n\r\nconst OAUTH_STALE_TIMEOUT_MS = 3000;\r\n\r\nasync function cleanupPendingOAuth(message = \"OAuth signup was cancelled. Please try again.\") {\r\n  try {\r\n    // Get user ID before signing out\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    const userId = session?.user?.id;\r\n\r\n    // Delete user from database if user exists and has valid session\r\n    if (userId && session?.access_token) {\r\n      try {\r\n        // Get auth token for the delete request\r\n        const token = session.access_token;\r\n        const headers = { \"Content-Type\": \"application/json\" };\r\n        headers[\"Authorization\"] = `Bearer ${token}`;\r\n\r\n        // Delete user data (this will also delete from auth.users)\r\n        // If this fails, we'll still proceed with sign out and context clearing\r\n        const deleteResponse = await fetch(\"/api/compliance/delete\", {\r\n          method: \"DELETE\",\r\n          headers,\r\n          credentials: \"include\",\r\n          body: JSON.stringify({\r\n            userId,\r\n            confirm: true,\r\n            reason: \"Incomplete OAuth signup cancelled by user\"\r\n          })\r\n        });\r\n\r\n        // Only log if it's not a 401/403 (expected for invalid sessions)\r\n        if (!deleteResponse.ok) {\r\n          const errorData = await deleteResponse.json().catch(() => ({}));\r\n          const {status} = deleteResponse;\r\n          // Don't log auth errors - they're expected for incomplete signups\r\n          if (status !== 401 && status !== 403) {\r\n            console.warn(\"[SIGNUP] Failed to delete incomplete OAuth user:\", errorData.error || \"Unknown error\");\r\n          }\r\n        }\r\n      } catch (deleteError) {\r\n        // Silently fail - incomplete signups may not have valid sessions\r\n        // The sign out below will still clear the session\r\n      }\r\n    }\r\n\r\n    // Sign out after deletion attempt\r\n    await supabase.auth.signOut();\r\n  } catch {}\r\n\r\n  try { await fetch(\"/auth/session\", { method: \"DELETE\" }); } catch {}\r\n  clearOAuthContext();\r\n  resetSignupStateHandler?.({ persist: true });\r\n  if (message) {\r\n    showMessage(\"error\", message);\r\n  }\r\n}\r\n\r\nfunction setupOAuthAbortWatcher() {\r\n  if (oauthAbortWatcherInstalled) return;\r\n  oauthAbortWatcherInstalled = true;\r\n\r\n  const checkPendingOAuth = async () => {\r\n    try {\r\n      const ctx = getOAuthContext();\r\n      if (ctx && ctx.intent === \"signup\" && ctx.status === \"pending\") {\r\n        const startedAt = Number(ctx.startedAt) || 0;\r\n        const elapsed = Date.now() - startedAt;\r\n        if (elapsed > OAUTH_STALE_TIMEOUT_MS) {\r\n          await cleanupPendingOAuth(\"OAuth signup did not finish. Please try again.\");\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn(\"[SIGNUP] OAuth abort watcher error:\", error);\r\n    }\r\n  };\r\n\r\n  // Handle tab close / navigation away\r\n  const handleBeforeUnload = async () => {\r\n    const ctx = getOAuthContext();\r\n    if (ctx && ctx.intent === \"signup\" && ctx.status === \"pending\") {\r\n      // Cleanup on page unload (silently)\r\n      await cleanupPendingOAuth(null);\r\n    }\r\n  };\r\n\r\n  // Handle visibility change (user switches tabs)\r\n  const handleVisibilityChange = () => {\r\n    if (document.visibilityState === \"visible\") {\r\n      checkPendingOAuth();\r\n    } else if (document.visibilityState === \"hidden\") {\r\n      // Mark as potentially abandoned\r\n      const ctx = getOAuthContext();\r\n      if (ctx && ctx.intent === \"signup\" && ctx.status === \"pending\") {\r\n        setOAuthContext({ ...ctx, lastActivity: Date.now() });\r\n      }\r\n    }\r\n  };\r\n\r\n  // Handle page hide (navigation away)\r\n  const handlePageHide = async () => {\r\n    const ctx = getOAuthContext();\r\n    if (ctx && ctx.intent === \"signup\" && ctx.status === \"pending\") {\r\n      await cleanupPendingOAuth(null);\r\n    }\r\n  };\r\n\r\n  window.addEventListener(\"focus\", checkPendingOAuth, true);\r\n  window.addEventListener(\"beforeunload\", handleBeforeUnload);\r\n  document.addEventListener(\"visibilitychange\", handleVisibilityChange);\r\n  window.addEventListener(\"pagehide\", handlePageHide);\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\auth\\signup-progressive.js","messages":[{"ruleId":"no-use-before-define","severity":1,"message":"'updateProgress' was used before it was defined.","line":144,"column":7,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":144,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import showMessage from \"../components/toast.js\";\n\n// Lightweight progressive signup step manager\nconst BARANGAY_LIST = [\n  \"Aplaya\",\n  \"Balabag\",\n  \"Binaton\",\n  \"Cogon\",\n  \"Colorado\",\n  \"Dawis\",\n  \"Dulangan\",\n  \"Goma\",\n  \"Igpit\",\n  \"Kiagot\",\n  \"Lungag\",\n  \"Mahayahay\",\n  \"Matti\",\n  \"Kapatagan (Rizal)\",\n  \"Ruparan\",\n  \"San Agustin\",\n  \"San Jose (Balutakay)\",\n  \"San Miguel (Odaca)\",\n  \"San Roque\",\n  \"Sinawilan\",\n  \"Soong\",\n  \"Tiguman\",\n  \"Tres de Mayo\",\n  \"Zone 1 (Pob.)\",\n  \"Zone 2 (Pob.)\",\n  \"Zone 3 (Pob.)\",\n];\n\nconst STEP_STORAGE_KEY = \"cl_signup_step_index\";\nconst FORM_DATA_KEY = \"cl_signup_form_data\";\nconst FLOW_ACTIVE_KEY = \"cl_signup_flow_active\";\n\nconst resetSignupData = () => {\n  sessionStorage.removeItem(STEP_STORAGE_KEY);\n  sessionStorage.removeItem(FORM_DATA_KEY);\n  sessionStorage.removeItem(FLOW_ACTIVE_KEY);\n  sessionStorage.removeItem(\"cl_verification_complete\");\n\n  const emailFlow = document.getElementById(\"signup-email-flow\");\n  if (emailFlow) {\n    emailFlow.querySelectorAll(\"input, select, textarea\").forEach((i) => {\n      if (i.type === \"checkbox\" || i.type === \"radio\") i.checked = false;\n      else i.value = \"\";\n    });\n  }\n};\n\nconst initBarangaySelect = () => {\n  const select = document.getElementById(\"barangay\");\n  if (!select || select.dataset.populated === \"true\") return;\n\n  const currentValue = select.value;\n  select.innerHTML = '<option value=\"\" selected>Select barangay</option>';\n  BARANGAY_LIST.forEach((name) => {\n    const option = document.createElement(\"option\");\n    option.value = name;\n    option.textContent = name;\n    select.appendChild(option);\n  });\n  if (currentValue) {\n    const match = BARANGAY_LIST.find(\n      (b) => b.toLowerCase() === currentValue.toLowerCase()\n    );\n    if (match) {\n      select.value = match;\n    }\n  }\n  select.dataset.populated = \"true\";\n};\n\ndocument.addEventListener(\"DOMContentLoaded\", () => {\n  initBarangaySelect();\n\n  // Method Selection Logic\n  const methodSection = document.getElementById(\"signup-method-section\");\n  const emailFlow = document.getElementById(\"signup-email-flow\");\n  const emailMethodBtn = document.querySelector('[data-signup-method=\"email\"]');\n  const backToMethodsBtn = document.getElementById(\"signup-method-back\");\n\n  if (emailMethodBtn && methodSection && emailFlow) {\n    emailMethodBtn.addEventListener(\"click\", () => {\n      methodSection.hidden = true;\n      emailFlow.hidden = false;\n      sessionStorage.setItem(FLOW_ACTIVE_KEY, \"true\");\n      // focus first input\n      setTimeout(() => {\n        const firstInput = emailFlow.querySelector(\"input\");\n        if (firstInput) firstInput.focus();\n      }, 50);\n    });\n  }\n\n  if (backToMethodsBtn && methodSection && emailFlow) {\n    backToMethodsBtn.addEventListener(\"click\", () => {\n      resetSignupData();\n      emailFlow.hidden = true;\n      methodSection.hidden = false;\n    });\n  }\n\n  // Clear data when navigating away to other pages\n  document.addEventListener(\"click\", (e) => {\n    const link = e.target.closest(\"a\");\n    if (link && link.href) {\n      try {\n        const url = new URL(link.href);\n        if (\n          url.origin === window.location.origin &&\n          !url.pathname.includes(\"/signup\") &&\n          !link.hasAttribute(\"data-skip-signup-cleanup\")\n        ) {\n          resetSignupData();\n        }\n      } catch (err) {}\n    }\n  });\n\n  // Steps UI logic\n  const stepsRoot = document.getElementById(\"signup-steps\");\n  if (stepsRoot) {\n    const steps = Array.from(stepsRoot.querySelectorAll(\".signup-step\"));\n    const nextBtn = document.getElementById(\"signup-next-btn\");\n    const prevBtn = document.getElementById(\"signup-prev-btn\");\n    const submitBtn = document.getElementById(\"signup-submit-btn\");\n    const progressFill = document.getElementById(\"signup-progress-fill\");\n    const progressLabel = document.getElementById(\"signup-progress-label\");\n    const progressBar = progressFill ? progressFill.parentElement : null;\n    let current = 0;\n\n    const showStep = (index) => {\n      steps.forEach((s, i) => {\n        s.hidden = i !== index;\n      });\n      current = index;\n      // Controls\n      if (prevBtn) prevBtn.hidden = index === 0;\n      const isLast = index === steps.length - 1;\n      if (nextBtn) nextBtn.hidden = isLast;\n      if (submitBtn) submitBtn.hidden = !isLast;\n      updateProgress();\n      // focus first input in step\n      const first = steps[index].querySelector(\"input,select,textarea,button\");\n      if (first) first.focus();\n\n      // Save current step\n      try {\n        sessionStorage.setItem(STEP_STORAGE_KEY, String(current));\n      } catch (e) {}\n    };\n\n    const updateProgress = () => {\n      const pct =\n        steps.length > 1 ? Math.round((current / (steps.length - 1)) * 100) : 0;\n      if (progressFill) progressFill.style.width = `${pct}%`;\n      if (progressBar) {\n        progressBar.setAttribute(\"aria-valuenow\", String(pct));\n      }\n      if (progressLabel) {\n        progressLabel.textContent = `Step ${current + 1} of ${\n          steps.length\n        } · ${pct}% complete`;\n      }\n    };\n\n    const validateCurrentStep = () => {\n      const inputs = Array.from(\n        steps[current].querySelectorAll(\"input,select,textarea\")\n      ).filter((i) => i.closest(\"form\"));\n      for (const el of inputs) {\n        // skip disabled or hidden fields\n        if (el.disabled || el.hidden) continue;\n        if (el.hasAttribute(\"required\")) {\n          if (!el.checkValidity()) {\n            el.reportValidity && el.reportValidity();\n            el.focus();\n            return false;\n          }\n        }\n      }\n\n      // Check for ID verification step\n      const idPlaceholder = steps[current].querySelector(\n        \"#id-step-placeholder\"\n      );\n      if (idPlaceholder) {\n        const passed =\n          sessionStorage.getItem(\"cl_verification_complete\") === \"true\";\n        if (!passed) {\n          showMessage(\n            \"error\",\n            \"Verification failed. Please ensure your ID matches your profile information before proceeding.\"\n          );\n          return false;\n        }\n      }\n\n      return true;\n    };\n\n    if (nextBtn) {\n      nextBtn.addEventListener(\"click\", () => {\n        if (!validateCurrentStep()) return;\n        showStep(Math.min(current + 1, steps.length - 1));\n      });\n    }\n\n    if (prevBtn) {\n      prevBtn.addEventListener(\"click\", () => {\n        showStep(Math.max(current - 1, 0));\n      });\n    }\n\n    // keyboard: Enter should move to next only when not on final step\n    stepsRoot.addEventListener(\"keydown\", (e) => {\n      if (e.key === \"Enter\") {\n        const active = document.activeElement;\n        if (\n          active &&\n          (active.tagName === \"INPUT\" ||\n            active.tagName === \"SELECT\" ||\n            active.tagName === \"TEXTAREA\")\n        ) {\n          // prevent form submit on Enter in steps (except final)\n          if (current < steps.length - 1) {\n            e.preventDefault();\n            nextBtn && nextBtn.click();\n          }\n        }\n      }\n    });\n\n    const saveFormData = () => {\n      const formData = {};\n      const inputs = stepsRoot.querySelectorAll(\"input, select, textarea\");\n      inputs.forEach((input) => {\n        if (input.name) {\n          if (input.type === \"checkbox\" || input.type === \"radio\") {\n            if (input.checked) {\n              formData[input.name] = input.value;\n            }\n          } else {\n            formData[input.name] = input.value;\n          }\n        }\n      });\n      try {\n        sessionStorage.setItem(FORM_DATA_KEY, JSON.stringify(formData));\n      } catch (e) {\n        console.warn(\"Failed to save form data:\", e);\n      }\n    };\n\n    const restoreFormData = () => {\n      try {\n        const saved = sessionStorage.getItem(FORM_DATA_KEY);\n        if (saved) {\n          const formData = JSON.parse(saved);\n          Object.entries(formData).forEach(([name, value]) => {\n            const input = stepsRoot.querySelector(`[name=\"${name}\"]`);\n            if (input) {\n              if (input.type === \"checkbox\" || input.type === \"radio\") {\n                if (input.value === value) input.checked = true;\n              } else {\n                input.value = value;\n              }\n            }\n          });\n        } else {\n          // If no saved data, ensure DOM fields are empty\n          // This prevents browser-native form state restoration from re-filling fields\n          // after they were cleared via resetSignupData() in a previous interaction.\n          stepsRoot.querySelectorAll(\"input, select, textarea\").forEach((i) => {\n            if (i.type === \"checkbox\" || i.type === \"radio\") i.checked = false;\n            else if (i.tagName !== \"BUTTON\") i.value = \"\";\n          });\n        }\n      } catch (e) {\n        console.warn(\"Failed to restore form data:\", e);\n      }\n    };\n\n    // Listen for changes\n    stepsRoot.addEventListener(\"input\", saveFormData);\n    stepsRoot.addEventListener(\"change\", saveFormData); // For select/checkbox\n\n    // initialize\n    let initialStep = 0;\n    try {\n      // Check for reload\n      const navEntries = performance.getEntriesByType(\"navigation\");\n      const navType = navEntries.length > 0 ? navEntries[0].type : null;\n      const isReload =\n        navType === \"reload\" ||\n        navType === \"back_forward\" ||\n        (performance.navigation && performance.navigation.type === 1);\n\n      if (!isReload) {\n        // Check if we arrived from a different page or direct entry\n        const {referrer} = document;\n        const isInternal =\n          referrer && referrer.includes(window.location.hostname);\n        const isSignupUrl = referrer && referrer.includes(\"/signup\");\n\n        // If from outside, from a different internal page, or if referrer is missing\n        if (!isInternal || !isSignupUrl) {\n          resetSignupData();\n        }\n      }\n\n      const saved = sessionStorage.getItem(STEP_STORAGE_KEY);\n      if (saved !== null) {\n        initialStep = parseInt(saved, 10);\n        if (\n          isNaN(initialStep) ||\n          initialStep < 0 ||\n          initialStep >= steps.length\n        ) {\n          initialStep = 0;\n        }\n      }\n    } catch (e) {\n      console.warn(\"Persistent signup init error:\", e);\n    }\n\n    // Restore data before showing step\n    restoreFormData();\n\n    // If flow was active, ensure the email flow is visible\n    const isFlowActive = sessionStorage.getItem(FLOW_ACTIVE_KEY) === \"true\";\n    if (initialStep > 0 || isFlowActive) {\n      if (methodSection && emailFlow) {\n        methodSection.hidden = true;\n        emailFlow.hidden = false;\n      }\n    }\n\n    showStep(initialStep);\n\n    // Listen for reset event from other scripts\n    document.addEventListener(\"signup-reset\", () => {\n      resetSignupData();\n      showStep(0);\n      if (emailFlow && methodSection) {\n        emailFlow.hidden = true;\n        methodSection.hidden = false;\n      }\n    });\n\n    // Global click listener for Sign Up buttons to trigger reset if already on page\n    document.addEventListener(\"click\", (e) => {\n      const signupBtn = e.target.closest(\"#signup-btn\");\n      if (signupBtn) {\n        // If clicking \"Sign up\" while already on signup page, reset flow\n        if (window.location.pathname.includes(\"/signup\")) {\n          document.dispatchEvent(new CustomEvent(\"signup-reset\"));\n        }\n      }\n    });\n\n    // Password Toggle Logic\n    const toggleButtons = document.querySelectorAll(\".password-toggle\");\n    toggleButtons.forEach((button) => {\n      button.addEventListener(\"click\", () => {\n        const input = button.parentElement.querySelector(\"input\");\n        const icon = button.querySelector(\"svg\");\n\n        if (input.type === \"password\") {\n          input.type = \"text\";\n          // Switch to eye-off icon\n          icon.innerHTML = `\n            <path d=\"M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24\"></path>\n            <line x1=\"1\" y1=\"1\" x2=\"23\" y2=\"23\"></line>\n          `;\n        } else {\n          input.type = \"password\";\n          // Switch back to eye icon\n          icon.innerHTML = `\n            <path d=\"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z\"></path>\n            <circle cx=\"12\" cy=\"12\" r=\"3\"></circle>\n          `;\n        }\n      });\n    });\n  }\n});\n\nexport {};\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\auth\\signupWithCode.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'supabase' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":18},{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":28,"column":9,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":28,"endColumn":39},{"ruleId":"no-lonely-if","severity":1,"message":"Unexpected if as the only statement in an else block.","line":284,"column":9,"nodeType":"IfStatement","messageId":"unexpectedLonelyIf","endLine":296,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from \"../config/config.js\";\r\nimport showMessage from \"../components/toast.js\";\r\nimport { validateAndSanitizeForm } from \"../utils/validation.js\";\r\nimport { renderPrivacyNotice } from \"../utils/privacyContent.js\";\r\n\r\n// Add spinner animation if not present\r\nif (!document.getElementById(\"spinner-animation\")) {\r\n  const style = document.createElement(\"style\");\r\n  style.id = \"spinner-animation\";\r\n  style.textContent = \"@keyframes spin{to{transform:rotate(360deg)}}\";\r\n  document.head.appendChild(style);\r\n}\r\n\r\n// Get signup code from URL parameters\r\nconst urlParams = new URLSearchParams(window.location.search);\r\nlet signupCode = urlParams.get(\"code\");\r\n\r\n// Form persistence logic\r\nconst FORM_STORAGE_KEY = \"cl_signup_form_data\";\r\n\r\n// Try to recover signup code from storage if missing\r\nif (!signupCode) {\r\n  try {\r\n    const savedData = localStorage.getItem(FORM_STORAGE_KEY);\r\n    if (savedData) {\r\n      const parsed = JSON.parse(savedData);\r\n      if (parsed.signupCode) {\r\n        signupCode = parsed.signupCode;\r\n        console.log(\"Restored signup code from storage:\", signupCode);\r\n\r\n        // Update URL to reflect code\r\n        const newUrl = new URL(window.location.href);\r\n        newUrl.searchParams.set(\"code\", signupCode);\r\n        window.history.replaceState({}, \"\", newUrl);\r\n      }\r\n    }\r\n  } catch (e) {\r\n    console.warn(\"Failed to recover signup code:\", e);\r\n  }\r\n}\r\n\r\n// Pre-fill the signup code if provided in URL or recovered\r\nif (signupCode) {\r\n  const codeInput = document.getElementById(\"signupCode\");\r\n  if (codeInput) {\r\n    codeInput.value = signupCode;\r\n  }\r\n}\r\n\r\n// OAuth signup function\r\nasync function signupWithOAuth(provider) {\r\n  try {\r\n    const { supabase } = await import(\"../config/config.js\");\r\n    // Get OAuth URL with signup code in state parameter\r\n    const options = {\r\n      redirectTo: `${window.location.origin}/complete-position-signup?code=${signupCode}`,\r\n      queryParams: {\r\n        access_type: \"offline\",\r\n        prompt: \"consent\",\r\n      }\r\n    };\r\n\r\n    // Set valid scopes for Facebook (avoid invalid user_mobile_phone scope)\r\n    if (provider === \"facebook\") {\r\n      options.scopes = \"email public_profile\";\r\n    }\r\n\r\n    const { data, error } = await supabase.auth.signInWithOAuth({\r\n      provider,\r\n      options\r\n    });\r\n    if (error) {\r\n      console.error(\"OAuth error:\", error);\r\n      showMessage(\"error\", `Failed to sign in with ${provider}`);\r\n      return;\r\n    }\r\n    // Redirect to OAuth provider\r\n    window.location.href = data.url;\r\n  } catch (error) {\r\n    console.error(\"OAuth signup error:\", error);\r\n    showMessage(\"error\", `Failed to sign in with ${provider}`);\r\n  }\r\n}\r\n\r\n// Function to initialize signup code validation\r\nfunction initializeSignupCodeValidation() {\r\n  // Check if signup code is provided in URL\r\n  if (!signupCode) {\r\n    showMessage(\"error\", \"No signup code provided in URL\");\r\n    // Disable form if no code\r\n    const form = document.getElementById(\"signup-form\");\r\n    if (form) {\r\n      form.style.opacity = \"0.5\";\r\n      form.style.pointerEvents = \"none\";\r\n    }\r\n  } else {\r\n    // Validate signup code automatically on page load\r\n    validateSignupCode(signupCode);\r\n  }\r\n}\r\n\r\n// Attach OAuth button listeners (no inline handlers for CSP)\r\ndocument.getElementById(\"oauth-google\")?.addEventListener(\"click\", () => signupWithOAuth(\"google\"));\r\ndocument.getElementById(\"oauth-facebook\")?.addEventListener(\"click\", () => signupWithOAuth(\"facebook\"));\r\n\r\nasync function validateSignupCode(code) {\r\n  try {\r\n    const response = await fetch(`/api/hr/validate-signup-code/${code}?t=${Date.now()}`);\r\n    const result = await response.json();\r\n    if (result.valid) {\r\n      showMessage(\"success\", `Valid signup code for ${result.data.role} role`);\r\n    } else {\r\n      // Check if it's an expired code\r\n      if (result.error && result.error.toLowerCase().includes(\"expired\")) {\r\n        showMessage(\"error\", \"This signup code has expired. Please contact HR for a new link.\");\r\n        // Redirect to landing page after 3 seconds\r\n        setTimeout(() => {\r\n          window.location.href = \"/\";\r\n        }, 3000);\r\n      } else {\r\n        showMessage(\"error\", result.error || \"Invalid signup code\");\r\n      }\r\n      // Disable form if code is invalid\r\n      const form = document.getElementById(\"signup-form\");\r\n      if (form) {\r\n        form.style.opacity = \"0.5\";\r\n        form.style.pointerEvents = \"none\";\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Code validation error:\", error);\r\n    showMessage(\"error\", \"Failed to validate signup code\");\r\n  }\r\n}\r\n\r\n// Handle form submission and persistence\r\nfunction setupFormPersistence() {\r\n  const signupForm = document.getElementById(\"signup-form\");\r\n  if (!signupForm) return;\r\n\r\n  // Form persistence logic\r\n  const FORM_STORAGE_KEY = \"cl_signup_form_data\";\r\n\r\n  function saveFormData() {\r\n    const formData = new FormData(signupForm);\r\n    const dataToSave = {};\r\n\r\n    for (const [key, value] of formData.entries()) {\r\n      // Don't save sensitive fields\r\n      // Save signupCode to allow session recovery\r\n      if (key !== \"password\" && key !== \"confirmPassword\" && key !== \"agreedToTerms\") {\r\n        dataToSave[key] = value;\r\n      }\r\n    }\r\n\r\n    try {\r\n      localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(dataToSave));\r\n    } catch (e) {\r\n      console.warn(\"Failed to save form data:\", e);\r\n    }\r\n  }\r\n\r\n  function loadFormData() {\r\n    try {\r\n      const savedData = localStorage.getItem(FORM_STORAGE_KEY);\r\n      console.log(\"Loading form data from storage:\", savedData ? \"Found data\" : \"No data\");\r\n\r\n      if (!savedData) return;\r\n\r\n      const parsedData = JSON.parse(savedData);\r\n\r\n      Object.keys(parsedData).forEach(key => {\r\n        const input = signupForm.querySelector(`[name=\"${key}\"]`);\r\n        if (input) {\r\n          input.value = parsedData[key];\r\n          // Trigger input event to ensure UI updates (like floating labels)\r\n          input.dispatchEvent(new Event(\"input\", { bubbles: true }));\r\n        }\r\n      });\r\n    } catch (e) {\r\n      console.warn(\"Failed to load form data:\", e);\r\n    }\r\n  }\r\n\r\n  function clearFormData() {\r\n    try {\r\n      localStorage.removeItem(FORM_STORAGE_KEY);\r\n    } catch (e) {\r\n      console.warn(\"Failed to clear form data:\", e);\r\n    }\r\n  }\r\n\r\n  // Load saved data on init\r\n  console.log(\"Initializing form persistence...\");\r\n  loadFormData();\r\n\r\n  // Save data on input changes\r\n  signupForm.addEventListener(\"input\", (e) => {\r\n    // Debounce saving if needed, but for now direct save is fine for simple text\r\n    if (e.target.name !== \"password\" && e.target.name !== \"confirmPassword\") {\r\n      saveFormData();\r\n    }\r\n  });\r\n\r\n  signupForm.addEventListener(\"submit\", async (e) => {\r\n    e.preventDefault();\r\n    const formData = new FormData(e.target);\r\n    const data = {\r\n      name: formData.get(\"name\"),\r\n      addressLine1: formData.get(\"addressLine1\") || \"\",\r\n      addressLine2: formData.get(\"addressLine2\") || \"\",\r\n      barangay: formData.get(\"barangay\") || \"\",\r\n      gender: formData.get(\"gender\"),\r\n      email: formData.get(\"email\"),\r\n      mobile: formData.get(\"mobile\"),\r\n      password: formData.get(\"password\"),\r\n      confirmPassword: formData.get(\"confirmPassword\"),\r\n      signupCode: formData.get(\"signupCode\"),\r\n      agreedToTerms: formData.get(\"agreedToTerms\") === \"on\"\r\n    };\r\n\r\n    // Validation rules\r\n    const validationRules = {\r\n      name: { required: true, minLength: 2, maxLength: 100 },\r\n      email: { required: true, type: \"email\" },\r\n      mobile: { required: true, type: \"mobile\" },\r\n      password: { required: true, type: \"password\" }\r\n    };\r\n    const validation = validateAndSanitizeForm(data, validationRules);\r\n    if (!validation.isValid) {\r\n      showMessage(\"error\", validation.errors.join(\", \"));\r\n      return;\r\n    }\r\n\r\n    // Check if ID verification is complete\r\n    let verificationComplete = false;\r\n    try {\r\n      verificationComplete = sessionStorage.getItem(\"cl_verification_complete\") === \"true\";\r\n    } catch (e) {\r\n      console.warn(\"Could not check verification status:\", e);\r\n    }\r\n\r\n    if (!verificationComplete) {\r\n      showMessage(\"error\", \"Please complete ID verification before signing up.\");\r\n      return;\r\n    }\r\n\r\n    // Show loading state\r\n    const submitButton = e.target.querySelector('button[type=\"submit\"]');\r\n    const originalHTML = submitButton.innerHTML;\r\n    submitButton.disabled = true;\r\n    submitButton.innerHTML = '<span class=\"spinner\" style=\"display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:white;border-radius:50%;vertical-align:middle;margin-right:8px;animation:spin 0.8s linear infinite\"></span>Creating Account...';\r\n    try {\r\n      // Submit via API\r\n      const response = await fetch(\"/api/auth/signup-with-code\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          name: validation.sanitizedData.name,\r\n          address: {\r\n            line1: data.addressLine1 || \"\",\r\n            line2: data.addressLine2 || \"\",\r\n            barangay: data.barangay || \"\"\r\n          },\r\n          gender: data.gender || \"\",\r\n          email: validation.sanitizedData.email,\r\n          mobileNumber: `+63${validation.sanitizedData.mobile}`,\r\n          password: data.password,\r\n          confirmPassword: data.confirmPassword,\r\n          signupCode: data.signupCode,\r\n          agreedToTerms: true,\r\n          isOAuth: false\r\n        })\r\n      });\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        showMessage(\"success\", \"Account created successfully! Redirecting to dashboard...\");\r\n        clearFormData(); // Clear saved form data\r\n        setTimeout(() => {\r\n          window.location.href = \"/dashboard\";\r\n        }, 3000);\r\n      } else {\r\n        // Check if it's an expired code\r\n        if (result.error && result.error.toLowerCase().includes(\"expired\")) {\r\n          showMessage(\"error\", \"This signup code has expired. Please contact HR for a new link.\");\r\n          setTimeout(() => {\r\n            window.location.href = \"/\";\r\n          }, 3000);\r\n        } else {\r\n          const errMsg = (result && result.error ? String(result.error) : \"\").toLowerCase();\r\n          if (errMsg.includes(\"already registered\") || errMsg.includes(\"already exists\") || errMsg.includes(\"duplicate\") || errMsg.includes(\"email is used\") || errMsg.includes(\"email taken\") || errMsg.includes(\"email already exist\")) {\r\n            showMessage(\"error\", \"Email already exist\");\r\n          } else {\r\n            showMessage(\"error\", result.error || \"Registration failed\");\r\n          }\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Registration error:\", error);\r\n      showMessage(\"error\", \"Registration failed. Please try again.\");\r\n    } finally {\r\n      // Reset button state\r\n      submitButton.innerHTML = originalHTML;\r\n      submitButton.disabled = false;\r\n    }\r\n  });\r\n}\r\n\r\n// Initialize when DOM is ready\r\nif (document.readyState === \"loading\") {\r\n  document.addEventListener(\"DOMContentLoaded\", () => {\r\n    initializeSignupCodeValidation();\r\n    renderPrivacyNotice(\"#privacyModalContent\", { headingTag: \"h4\" });\r\n    setupFormPersistence();\r\n  });\r\n} else {\r\n  // DOM is already loaded, run immediately\r\n  initializeSignupCodeValidation();\r\n  renderPrivacyNotice(\"#privacyModalContent\", { headingTag: \"h4\" });\r\n  setupFormPersistence();\r\n}\r\n// Code validation removed - no automatic validation on blur\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\complaint\\complaintMap.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\complaint\\evidencePreview.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\complaint\\falseComplaintMarker.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'originalText' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":215,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":215,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * False Complaint Marker Component\r\n * Handles marking complaints as false with reasons and evidence\r\n */\r\nimport { supabase } from \"/js/config/config.js\";\r\n\r\nclass FalseComplaintMarker {\r\n\r\n  constructor() {\r\n    this.modal = null;\r\n    this.complaintId = null;\r\n    this.callback = null;\r\n  }\r\n  /**\r\n   * Show the false complaint marker modal\r\n   * @param {string} complaintId - The ID of the complaint to mark as false\r\n   * @param {Function} callback - Callback function to execute after marking\r\n   */\r\n  show(complaintId, callback = null) {\r\n    this.complaintId = complaintId;\r\n    this.callback = callback;\r\n    this.createModal();\r\n    this.attachEventListeners();\r\n    document.body.appendChild(this.modal);\r\n    // Trigger animation\r\n    requestAnimationFrame(() => {\r\n      this.modal.style.opacity = \"1\";\r\n    });\r\n  }\r\n  /**\r\n   * Create the modal HTML structure\r\n   */\r\n  createModal() {\r\n    this.modal = document.createElement(\"div\");\r\n    this.modal.className = \"false-complaint-modal\";\r\n    this.modal.style.opacity = \"0\";\r\n    this.modal.style.transition = \"opacity 0.3s ease\";\r\n    this.modal.innerHTML = `\r\n      <div class=\"false-complaint-content\">\r\n        <div class=\"false-complaint-header\">\r\n          <div class=\"false-complaint-icon\">⚠️</div>\r\n          <div class=\"false-complaint-title\">Mark as False Complaint</div>\r\n        </div>\r\n        \r\n        <div class=\"warning-message\">\r\n          <span class=\"warning-icon\">⚠️</span>\r\n          <strong>Warning:</strong> Marking a complaint as false is a serious action that cannot be undone. \r\n          Please ensure you have sufficient evidence to support this decision.\r\n        </div>\r\n        \r\n        <form class=\"false-complaint-form\" id=\"false-complaint-form\">\r\n          <div class=\"form-group\">\r\n            <label class=\"form-label\" for=\"false-reason\">Reason for marking as false *</label>\r\n            <select class=\"form-select\" id=\"false-reason\" required>\r\n              <option value=\"\">Select a reason...</option>\r\n              <option value=\"duplicate\">Duplicate complaint</option>\r\n              <option value=\"spam\">Spam or irrelevant content</option>\r\n              <option value=\"false-information\">False or misleading information</option>\r\n              <option value=\"prank\">Prank or hoax</option>\r\n              <option value=\"malicious\">Malicious intent</option>\r\n              <option value=\"other\">Other (specify in notes)</option>\r\n            </select>\r\n          </div>\r\n          \r\n          <div class=\"form-group\">\r\n            <label class=\"form-label\" for=\"false-notes\">Additional Notes</label>\r\n            <textarea \r\n              class=\"form-textarea\" \r\n              id=\"false-notes\" \r\n              placeholder=\"Provide additional details about why this complaint is false...\"\r\n              rows=\"4\"\r\n            ></textarea>\r\n          </div>\r\n          \r\n          <div class=\"form-group\">\r\n            <label class=\"form-label\">Evidence of False Complaint</label>\r\n            <div class=\"false-complaint-reasons\">\r\n              <label class=\"reason-option\">\r\n                <input type=\"checkbox\" class=\"reason-radio\" value=\"duplicate-check\">\r\n                <div>\r\n                  <div class=\"reason-text\">Verified duplicate of existing complaint</div>\r\n                  <div class=\"reason-description\">Same issue reported by same or different user</div>\r\n                </div>\r\n              </label>\r\n              <label class=\"reason-option\">\r\n                <input type=\"checkbox\" class=\"reason-radio\" value=\"location-false\">\r\n                <div>\r\n                  <div class=\"reason-text\">False location information</div>\r\n                  <div class=\"reason-description\">Complaint location does not exist or is incorrect</div>\r\n                </div>\r\n              </label>\r\n              <label class=\"reason-option\">\r\n                <input type=\"checkbox\" class=\"reason-radio\" value=\"spam-content\">\r\n                <div>\r\n                  <div class=\"reason-text\">Spam or inappropriate content</div>\r\n                  <div class=\"reason-description\">Content violates community guidelines</div>\r\n                </div>\r\n              </label>\r\n              <label class=\"reason-option\">\r\n                <input type=\"checkbox\" class=\"reason-radio\" value=\"verified-false\">\r\n                <div>\r\n                  <div class=\"reason-text\">Verified as false by investigation</div>\r\n                  <div class=\"reason-description\">On-site investigation confirmed false information</div>\r\n                </div>\r\n              </label>\r\n            </div>\r\n          </div>\r\n          \r\n          <div class=\"false-complaint-actions\">\r\n            <button type=\"button\" class=\"btn btn-secondary\" id=\"cancel-false-complaint\">Cancel</button>\r\n            <button type=\"submit\" class=\"btn btn-danger\" id=\"confirm-false-complaint\">\r\n              Mark as False Complaint\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    `;\r\n  }\r\n  /**\r\n   * Attach event listeners to the modal\r\n   */\r\n  attachEventListeners() {\r\n    const form = this.modal.querySelector(\"#false-complaint-form\");\r\n    const cancelBtn = this.modal.querySelector(\"#cancel-false-complaint\");\r\n    const reasonOptions = this.modal.querySelectorAll(\".reason-option\");\r\n    // Handle form submission\r\n    form.addEventListener(\"submit\", (e) => {\r\n      e.preventDefault();\r\n      this.handleSubmit();\r\n    });\r\n    // Handle cancel button\r\n    cancelBtn.addEventListener(\"click\", () => {\r\n      this.hide();\r\n    });\r\n    // Handle reason option selection\r\n    reasonOptions.forEach(option => {\r\n      option.addEventListener(\"click\", () => {\r\n        const radio = option.querySelector(\".reason-radio\");\r\n        radio.checked = !radio.checked;\r\n        option.classList.toggle(\"selected\", radio.checked);\r\n      });\r\n    });\r\n    // Handle clicking outside modal to close\r\n    this.modal.addEventListener(\"click\", (e) => {\r\n      if (e.target === this.modal) {\r\n        this.hide();\r\n      }\r\n    });\r\n    // Handle escape key\r\n    document.addEventListener(\"keydown\", (e) => {\r\n      if (e.key === \"Escape\" && this.modal && this.modal.parentNode) {\r\n        this.hide();\r\n      }\r\n    });\r\n  }\r\n  /**\r\n   * Handle form submission\r\n   */\r\n  async handleSubmit() {\r\n    const form = this.modal.querySelector(\"#false-complaint-form\");\r\n    const formData = new FormData(form);\r\n    const reason = formData.get(\"false-reason\");\r\n    const notes = formData.get(\"false-notes\");\r\n    const evidence = Array.from(this.modal.querySelectorAll(\".reason-radio:checked\"))\r\n      .map(radio => radio.value);\r\n    if (!reason) {\r\n      this.showError(\"Please select a reason for marking this complaint as false.\");\r\n      return;\r\n    }\r\n    try {\r\n      // Show loading state\r\n      this.showLoading();\r\n      // SECURITY: Use Supabase session token, never localStorage\r\n      const { data: { session } } = await supabase.auth.getSession();\r\n      const token = session?.access_token;\r\n      const headers = { \"Content-Type\": \"application/json\" };\r\n      if (token) {\r\n        headers[\"Authorization\"] = `Bearer ${token}`;\r\n      }\r\n      // Submit the false complaint marking\r\n      const response = await fetch(`/api/complaints/${this.complaintId}/mark-false`, {\r\n        method: \"POST\",\r\n        headers,\r\n        body: JSON.stringify({\r\n          reason,\r\n          notes,\r\n          evidence,\r\n          marked_at: new Date().toISOString()\r\n        })\r\n      });\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        this.showSuccess(\"Complaint marked as false successfully.\");\r\n        // Execute callback if provided\r\n        if (this.callback && typeof this.callback === \"function\") {\r\n          this.callback(result);\r\n        }\r\n        // Close modal after a short delay\r\n        setTimeout(() => {\r\n          this.hide();\r\n        }, 1500);\r\n      } else {\r\n        this.showError(result.error || \"Failed to mark complaint as false.\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error marking complaint as false:\", error);\r\n      this.showError(\"An error occurred while marking the complaint as false.\");\r\n    }\r\n  }\r\n  /**\r\n   * Show loading state\r\n   */\r\n  showLoading() {\r\n    const submitBtn = this.modal.querySelector(\"#confirm-false-complaint\");\r\n    const originalText = submitBtn.textContent;\r\n    submitBtn.innerHTML = '<div class=\"spinner\"></div> Processing...';\r\n    submitBtn.disabled = true;\r\n  }\r\n  /**\r\n   * Show error message\r\n   */\r\n  showError(message) {\r\n    this.showMessage(message, \"error\");\r\n  }\r\n  /**\r\n   * Show success message\r\n   */\r\n  showSuccess(message) {\r\n    this.showMessage(message, \"success\");\r\n  }\r\n  /**\r\n   * Show message in modal\r\n   */\r\n  showMessage(message, type) {\r\n    // Remove existing messages\r\n    const existingMessage = this.modal.querySelector(\".modal-message\");\r\n    if (existingMessage) {\r\n      existingMessage.remove();\r\n    }\r\n    const messageDiv = document.createElement(\"div\");\r\n    messageDiv.className = `modal-message ${type === \"error\" ? \"error-message\" : \"success-message\"}`;\r\n    messageDiv.textContent = message;\r\n    const form = this.modal.querySelector(\"#false-complaint-form\");\r\n    form.insertBefore(messageDiv, form.firstChild);\r\n    // Auto-remove after 5 seconds\r\n    setTimeout(() => {\r\n      if (messageDiv.parentNode) {\r\n        messageDiv.remove();\r\n      }\r\n    }, 5000);\r\n  }\r\n  /**\r\n   * Hide the modal\r\n   */\r\n  hide() {\r\n\r\n    if (this.modal && this.modal.parentNode) {\r\n      this.modal.style.opacity = \"0\";\r\n      setTimeout(() => {\r\n        if (this.modal && this.modal.parentNode) {\r\n          this.modal.parentNode.removeChild(this.modal);\r\n        }\r\n        this.modal = null;\r\n      }, 300);\r\n    }\r\n  }\r\n}\r\n// Export the class\r\n\r\nexport default FalseComplaintMarker;\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\form\\complaintForm.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\form\\complaintFormHierarchical.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\form\\formSubmission.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\header.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'closeNotificationPanel' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":62}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { brandConfig } from \"../config/index.js\";\r\nimport { initializeNotificationButton, closeNotificationPanel } from \"./notification.js\";\r\n\r\n// Header component for easy modification\r\n\r\nexport function createHeader() {\r\n  return `\r\n    <div class=\"header-content\">\r\n      <div class=\"header-left\">\r\n        <button id=\"menu-toggle\" class=\"menu-toggle\" aria-label=\"Toggle sidebar\" title=\"Toggle menu\">\r\n          <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\"></line>\r\n            <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\"></line>\r\n            <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\"></line>\r\n          </svg>\r\n        </button>\r\n        <a href=\"${brandConfig.dashboardUrl}\" class=\"brand-logo\">\r\n          <div class=\"brand-icon\"></div>\r\n          <span class=\"brand-text\">${brandConfig.name}</span>\r\n        </a>\r\n      </div>\r\n\r\n      <div class=\"header-right\">\r\n        <button id=\"theme-toggle\" class=\"header-action theme-toggle\" aria-label=\"Toggle dark mode\" title=\"Toggle theme\">\r\n          <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <circle cx=\"12\" cy=\"12\" r=\"5\"></circle>\r\n            <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\"></line>\r\n            <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\"></line>\r\n            <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\"></line>\r\n            <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\"></line>\r\n            <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\"></line>\r\n            <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\"></line>\r\n            <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\"></line>\r\n            <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\"></line>\r\n          </svg>\r\n        </button>\r\n\r\n        <div class=\"notification-container\">\r\n          <button id=\"notification-btn\" class=\"header-action notification-btn\" title=\"Notifications\">\r\n            <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n              <path d=\"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9\"></path>\r\n              <path d=\"M13.73 21a2 2 0 0 1-3.46 0\"></path>\r\n            </svg>\r\n            <span id=\"notification-badge\" class=\"notification-badge hidden\">0</span>\r\n          </button>\r\n          <div id=\"notification-panel\" class=\"header-dropdown notification-panel\">\r\n            <div class=\"dropdown-header\">\r\n              <h3 class=\"dropdown-title\">Notifications</h3>\r\n              <button id=\"close-notifications\" class=\"dropdown-close\" aria-label=\"Close notifications\">\r\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"></line>\r\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"></line>\r\n                </svg>\r\n              </button>\r\n            </div>\r\n            <div id=\"notification-content\" class=\"dropdown-content\">\r\n              <div class=\"no-notifications\">No notifications yet</div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"profile-container\">\r\n          <button id=\"profile-btn\" class=\"header-action profile-btn\" title=\"Profile\">\r\n            <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n              <path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"></path>\r\n              <circle cx=\"12\" cy=\"7\" r=\"4\"></circle>\r\n            </svg>\r\n          </button>\r\n          <div id=\"profile-panel\" class=\"header-dropdown profile-panel\">\r\n            <div class=\"dropdown-header\">\r\n              <h3 class=\"dropdown-title\">Profile</h3>\r\n            </div>\r\n            <div class=\"dropdown-content\">\r\n              <a href=\"/myProfile\" class=\"dropdown-item\">\r\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n                    <path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"></path>\r\n                    <circle cx=\"12\" cy=\"7\" r=\"4\"></circle>\r\n                  </svg>\r\n                My Profile\r\n              </a>\r\n              <a href=\"/fileComplaint\" class=\"dropdown-item\">\r\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n                  <path d=\"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\"></path>\r\n                  <polyline points=\"14,2 14,8 20,8\"></polyline>\r\n                  <line x1=\"16\" y1=\"13\" x2=\"8\" y2=\"13\"></line>\r\n                  <line x1=\"16\" y1=\"17\" x2=\"8\" y2=\"17\"></line>\r\n                  <polyline points=\"10,9 9,9 8,9\"></polyline>\r\n                </svg>\r\n                File Complaint\r\n              </a>\r\n              <button id=\"logout-btn\" class=\"dropdown-item logout-btn\">\r\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n                    <path d=\"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4\"></path>\r\n                    <polyline points=\"16,17 21,12 16,7\"></polyline>\r\n                    <line x1=\"21\" y1=\"12\" x2=\"9\" y2=\"12\"></line>\r\n                  </svg>\r\n                Logout\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n// Initialize global click handler to close dropdowns\r\nfunction initializeGlobalClickHandler() {\r\n  // console.log removed for security\r\n  document.addEventListener(\"click\", (e) => {\r\n    const notificationPanel = document.getElementById(\"notification-panel\");\r\n    const profilePanel = document.getElementById(\"profile-panel\");\r\n    const notificationBtn = document.getElementById(\"notification-btn\");\r\n    const profileBtn = document.getElementById(\"profile-btn\");\r\n    // Close notification panel if clicking outside\r\n    if (notificationPanel && notificationPanel.classList.contains(\"show\")) {\r\n      if (!notificationPanel.contains(e.target) && !notificationBtn.contains(e.target)) {\r\n        notificationPanel.classList.remove(\"show\");\r\n        notificationPanel.style.opacity = \"0\";\r\n        notificationPanel.style.transform = \"translateY(-10px)\";\r\n        setTimeout(() => {\r\n          notificationPanel.style.display = \"none\";\r\n        }, 300);\r\n      }\r\n    }\r\n    // Close profile panel if clicking outside\r\n    if (profilePanel && profilePanel.classList.contains(\"show\")) {\r\n      if (!profilePanel.contains(e.target) && !profileBtn.contains(e.target)) {\r\n        profilePanel.classList.remove(\"show\");\r\n        profilePanel.style.opacity = \"0\";\r\n        profilePanel.style.transform = \"translateY(-10px)\";\r\n        setTimeout(() => {\r\n          profilePanel.style.display = \"none\";\r\n        }, 300);\r\n      }\r\n    }\r\n  });\r\n}\r\n// Initialize notification button - using imported function from notification.js\r\n// Initialize profile button\r\nfunction initializeProfileButton() {\r\n  // console.log removed for security\r\n  const profileBtn = document.getElementById(\"profile-btn\");\r\n  if (!profileBtn) {\r\n    console.warn(\"[HEADER] Profile button not found\");\r\n    return;\r\n  }\r\n  profileBtn.addEventListener(\"click\", (e) => {\r\n    e.stopPropagation();\r\n    const notificationPanel = document.getElementById(\"notification-panel\");\r\n    if (notificationPanel && notificationPanel.classList.contains(\"show\")) {\r\n      notificationPanel.classList.remove(\"show\");\r\n      notificationPanel.style.opacity = \"0\";\r\n      notificationPanel.style.transform = \"translateY(-10px)\";\r\n      setTimeout(() => { notificationPanel.style.display = \"none\"; }, 300);\r\n    }\r\n    const profilePanel = document.getElementById(\"profile-panel\");\r\n    if (profilePanel.classList.contains(\"show\")) {\r\n      profilePanel.classList.remove(\"show\");\r\n      profilePanel.style.opacity = \"0\";\r\n      profilePanel.style.transform = \"translateY(-10px)\";\r\n      setTimeout(() => { profilePanel.style.display = \"none\"; }, 300);\r\n    } else {\r\n      profilePanel.classList.add(\"show\");\r\n      profilePanel.style.display = \"block\";\r\n      setTimeout(() => {\r\n        profilePanel.style.opacity = \"1\";\r\n        profilePanel.style.transform = \"translateY(0)\";\r\n      }, 10);\r\n    }\r\n  });\r\n}\r\n// Initialize menu toggle\r\nfunction initializeMenuToggle() {\r\n  // console.log removed for security\r\n  const menuToggle = document.getElementById(\"menu-toggle\");\r\n  const sidebar = document.getElementById(\"sidebar\");\r\n  if (menuToggle && sidebar) {\r\n    menuToggle.addEventListener(\"click\", async () => {\r\n      // Import sidebar functions dynamically\r\n      try {\r\n        const { openSidebar, closeSidebar } = await import(\"./sidebar.js\");\r\n        const isOpen = sidebar.classList.contains(\"open\");\r\n        if (isOpen) {\r\n          closeSidebar();\r\n        } else {\r\n          openSidebar();\r\n        }\r\n        menuToggle.classList.toggle(\"active\");\r\n        // Update aria-expanded on menu toggle after a brief delay to ensure state is updated\r\n        setTimeout(() => {\r\n          menuToggle.setAttribute(\"aria-expanded\", sidebar.classList.contains(\"open\") ? \"true\" : \"false\");\r\n        }, 50);\r\n      } catch (error) {\r\n        // Fallback to direct class toggle if import fails\r\n        console.warn(\"Failed to import sidebar functions, using fallback:\", error);\r\n        sidebar.classList.toggle(\"open\");\r\n        menuToggle.classList.toggle(\"active\");\r\n        menuToggle.setAttribute(\"aria-expanded\", sidebar.classList.contains(\"open\") ? \"true\" : \"false\");\r\n      }\r\n    });\r\n    // Set initial aria-expanded state\r\n    menuToggle.setAttribute(\"aria-expanded\", \"false\");\r\n  } else {\r\n    console.warn(\"⚠️ Menu toggle or sidebar not found:\", { menuToggle: Boolean(menuToggle), sidebar: Boolean(sidebar) });\r\n  }\r\n}\r\n// Initialize theme toggle\r\nfunction initializeThemeToggle() {\r\n  // console.log removed for security\r\n  const themeToggleBtn = document.getElementById(\"theme-toggle\");\r\n  if (!themeToggleBtn) {\r\n    console.warn(\"[HEADER] Theme toggle button not found\");\r\n    return;\r\n  }\r\n  // Load saved theme\r\n  const savedTheme = localStorage.getItem(\"theme\") || \"light\";\r\n  applyTheme(savedTheme);\r\n  themeToggleBtn.addEventListener(\"click\", () => {\r\n    const rootElement = document.documentElement;\r\n    const isDark = rootElement.classList.contains(\"dark\");\r\n    const newTheme = isDark ? \"light\" : \"dark\";\r\n    applyTheme(newTheme);\r\n    localStorage.setItem(\"theme\", newTheme);\r\n    // Update button appearance\r\n    themeToggleBtn.title = isDark ? \"Switch to light mode\" : \"Switch to dark mode\";\r\n    themeToggleBtn.textContent = isDark ? \"🌙\" : \"☀️\";\r\n  });\r\n  function applyTheme(theme) {\r\n    const rootElement = document.documentElement;\r\n    if (theme === \"dark\") {\r\n      rootElement.classList.add(\"dark\");\r\n    } else {\r\n      rootElement.classList.remove(\"dark\");\r\n    }\r\n  }\r\n}\r\n// Initialize header scroll behavior\r\nfunction initializeHeaderScroll() {\r\n  // console.log removed for security\r\n  let lastScrollY = window.scrollY;\r\n  window.addEventListener(\"scroll\", () => {\r\n    const currentScrollY = window.scrollY;\r\n    const header = document.querySelector(\".header-content\");\r\n    if (header) {\r\n\r\n      if (currentScrollY > lastScrollY && currentScrollY > 100) {\r\n        // Scrolling down\r\n        header.style.transform = \"translateY(-100%)\";\r\n      } else {\r\n        // Scrolling up\r\n        header.style.transform = \"translateY(0)\";\r\n      }\r\n    }\r\n    lastScrollY = currentScrollY;\r\n  });\r\n}\r\n// Initialize dropdowns\r\nfunction initializeDropdowns() {\r\n  // console.log removed for security\r\n  // Move dropdowns to body to avoid container issues\r\n  const notificationPanel = document.getElementById(\"notification-panel\");\r\n  const profilePanel = document.getElementById(\"profile-panel\");\r\n  if (notificationPanel) {\r\n    notificationPanel.remove();\r\n    document.body.appendChild(notificationPanel);\r\n    // CSS classes will handle the styling now\r\n  }\r\n  if (profilePanel) {\r\n    profilePanel.remove();\r\n    document.body.appendChild(profilePanel);\r\n    // CSS classes will handle the styling now\r\n  }\r\n}\r\n// Initialize header when DOM is loaded\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  // Add a small delay to ensure all elements are ready\r\n  setTimeout(() => {\r\n    // console.log removed for security\r\n    const headerContainer = document.querySelector(\".header-container\");\r\n    const headerElement = document.querySelector(\"#header\");\r\n    // console.log removed for security\r\n    // console.log removed for security\r\n    // Try .header-container first, then fall back to #header\r\n    if (headerContainer) {\r\n      // console.log removed for security\r\n      const headerHTML = createHeader();\r\n      // console.log removed for security\r\n      headerContainer.innerHTML = headerHTML;\r\n    } else if (headerElement) {\r\n      // console.log removed for security\r\n      const headerHTML = createHeader();\r\n      // console.log removed for security\r\n      headerElement.innerHTML = headerHTML;\r\n    } else {\r\n      console.warn(\"[HEADER] No header container or header element found!\");\r\n      // Try to create a header container as a fallback\r\n      const {body} = document;\r\n      if (body) {\r\n        // console.log removed for security\r\n        const fallbackHeader = document.createElement(\"div\");\r\n        fallbackHeader.className = \"header-container\";\r\n        fallbackHeader.style.cssText = \"position: fixed; top: 0; left: 0; right: 0; z-index: 1000;\";\r\n        body.insertBefore(fallbackHeader, body.firstChild);\r\n        const headerHTML = createHeader();\r\n        fallbackHeader.innerHTML = headerHTML;\r\n        // console.log removed for security\r\n      } else {\r\n        console.error(\"[HEADER] Cannot create fallback header - body not found\");\r\n        return;\r\n      }\r\n    }\r\n    // Test if buttons were created\r\n    const _testNotificationBtn = document.getElementById(\"notification-btn\");\r\n    const _testProfileBtn = document.getElementById(\"profile-btn\");\r\n    // console.log removed for security\r\n    // Fix dropdown positioning by ensuring parent containers have relative positioning\r\n    const notificationContainer = document.querySelector(\".notification-container\");\r\n    const profileContainer = document.querySelector(\".profile-container\");\r\n    if (notificationContainer) {\r\n      notificationContainer.style.position = \"relative\";\r\n    }\r\n    if (profileContainer) {\r\n      profileContainer.style.position = \"relative\";\r\n    }\r\n    // Move dashboard clock into header-right to align with buttons (put it first)\r\n    try {\r\n      const headerRight = document.querySelector(\".header-right\");\r\n      const clockEl = document.getElementById(\"dashboard-clock\");\r\n      if (headerRight && clockEl) {\r\n        headerRight.insertBefore(clockEl, headerRight.firstChild);\r\n      }\r\n    } catch (e) {\r\n      console.warn(\"[HEADER] Clock positioning failed:\", e);\r\n    }\r\n    // Add a small delay to ensure DOM is fully updated\r\n    setTimeout(() => {\r\n      initializeNotificationButton();\r\n      initializeProfileButton();\r\n      initializeMenuToggle(); // Initialize menu toggle after header HTML is created\r\n      initializeThemeToggle();\r\n      initializeHeaderScroll();\r\n      initializeDropdowns();\r\n      initializeGlobalClickHandler();\r\n    }, 50);\r\n  }, 100); // Close setTimeout\r\n}); // Close DOMContentLoaded\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\map\\boundaryGenerator.js","messages":[{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":7,"column":36,"nodeType":"CallExpression","messageId":"returnsValue","endLine":7,"endColumn":60,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[281,305],"text":"{setTimeout(resolve, 200)}"},"desc":"Wrap the expression in `{}`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"async function loadBoundaries() {\r\n  try {\r\n    // Wait for map instance to be available with shorter intervals\r\n    const maxAttempts = 50; // Increased attempts\r\n    let attempts = 0;\r\n    while (!window.simpleMap && attempts < maxAttempts) {\r\n      await new Promise(resolve => setTimeout(resolve, 200)); // Increased delay to 200ms\r\n      attempts++;\r\n    }\r\n    const M = window.simpleMap;\r\n    if (!M) {\r\n      console.warn(\"[BOUNDARY] Map not available yet, skipping boundary loading\");\r\n      return; // Don't throw error, just skip if map isn't ready\r\n    }\r\n    // Fetch boundaries data\r\n    const response = await fetch(\"/api/boundaries\");\r\n    if (!response.ok) {\r\n      throw new Error(`HTTP error! status: ${response.status}`);\r\n    }\r\n    const brgyData = await response.json();\r\n    // Check if brgyData is an array\r\n    if (!Array.isArray(brgyData)) {\r\n      throw new Error(\"Boundary data is not in correct format\");\r\n    }\r\n    // Store boundaries globally for boundary checking\r\n    window.cityBoundaries = brgyData;\r\n\r\n    // Add each barangay boundary to the map\r\n    brgyData.forEach((barangay) => {\r\n      const geojsonLayer = L.geoJSON(barangay.geojson, {\r\n        style: {\r\n          color: \"#3388ff\",\r\n          weight: 2,\r\n          opacity: 1,\r\n          fillOpacity: 0, // Slight fill for better visibility\r\n        },\r\n      });\r\n      geojsonLayer.addTo(M);\r\n    });\r\n    // Don't auto-fit bounds - let the heatmap control the view\r\n    // const bounds = L.geoJSON(brgyData.map(b => b.geojson)).getBounds();\r\n    // M.fitBounds(bounds, { padding: [20, 20] }); // Add padding for better view\r\n    // console.log removed for security\r\n  } catch (err) {\r\n    console.error(\"Error loading boundaries:\", err.message);\r\n    console.error(\"Stack:\", err.stack);\r\n  }\r\n}\r\n// Initialize boundaries when DOM is ready\r\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\r\n  try {\r\n    // Load boundaries immediately - no delay\r\n    await loadBoundaries();\r\n\r\n    // If heatmap visualization exists, reload data to apply boundary filtering\r\n    if (window.heatmapViz && typeof window.heatmapViz.loadComplaintData === \"function\") {\r\n      console.log(\"[BOUNDARY] Boundaries loaded, reloading heatmap data with boundary filter\");\r\n      const currentFilters = window.heatmapViz.currentFilters || {};\r\n      await window.heatmapViz.loadComplaintData(currentFilters);\r\n\r\n      // Recreate heatmap and markers with filtered data\r\n      if (window.heatmapViz.heatmapLayer) {\r\n        window.heatmapViz.hideHeatmap();\r\n      }\r\n      window.heatmapViz.createHeatmapLayer();\r\n      window.heatmapViz.showHeatmap();\r\n\r\n      if (window.heatmapViz.markerLayer) {\r\n        window.heatmapViz.hideMarkers();\r\n      }\r\n      window.heatmapViz.createMarkerLayer();\r\n      window.heatmapViz.showMarkers();\r\n\r\n      // Update statistics if function exists\r\n      if (typeof window.updateStatistics === \"function\") {\r\n        window.updateStatistics();\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Failed to load boundaries:\", error);\r\n  }\r\n});\r\n/**\r\n * Create an inverted city boundary mask that fills everything OUTSIDE the city\r\n * @param {L.Map} map - Leaflet map instance\r\n * @param {Array} brgyData - Array of barangay data\r\n */\r\nasync function _addCityBoundary(map, brgyData) {\r\n  try {\r\n    // console.log removed for security\r\n    // Create a feature collection from all barangay geojson\r\n    const allFeatures = brgyData.map(barangay => barangay.geojson);\r\n    // Calculate the convex hull (outer boundary) of all barangays\r\n    const cityBoundary = calculateConvexHull(allFeatures);\r\n    if (cityBoundary) {\r\n      // Create a world rectangle that covers the entire map\r\n      const _worldBounds = L.latLngBounds([-90, -180], [90, 180]);\r\n      const worldRectangle = {\r\n        type: \"Feature\",\r\n        properties: { name: \"World\" },\r\n        geometry: {\r\n          type: \"Polygon\",\r\n          coordinates: [[\r\n            [-180, -90], [-180, 90], [180, 90], [180, -90], [-180, -90]\r\n          ]]\r\n        }\r\n      };\r\n      // Create the inverted mask using a \"donut\" polygon\r\n      const invertedMask = {\r\n        type: \"Feature\",\r\n        properties: { name: \"Digos City Inverted Mask\" },\r\n        geometry: {\r\n          type: \"Polygon\",\r\n          coordinates: [\r\n            worldRectangle.geometry.coordinates[0], // Outer ring (world)\r\n            cityBoundary.geometry.coordinates[0]    // Inner ring (city boundary - creates the \"hole\")\r\n          ]\r\n        }\r\n      };\r\n      // Create the inverted mask layer\r\n      const maskLayer = L.geoJSON(invertedMask, {\r\n        style: {\r\n          color: \"transparent\",     // No border\r\n          weight: 0,\r\n          opacity: 0,\r\n          fillOpacity: 0.3,         // Semi-transparent fill\r\n          fillColor: \"#000000\"      // Black mask\r\n        },\r\n        onEachFeature(feature, layer) {\r\n          layer.bindPopup(`\r\n            <div>\r\n              <h4>🏙️ Digos City Area</h4>\r\n              <p>Highlighted area shows the city limits</p>\r\n            </div>\r\n          `);\r\n        }\r\n      });\r\n      // Add inverted mask to map\r\n      maskLayer.addTo(map);\r\n      // console.log removed for security\r\n    }\r\n  } catch (error) {\r\n    console.error(\"❌ Error creating inverted city boundary:\", error);\r\n  }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\map\\complaintLocationPicker.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\map\\complaintMap.js","messages":[],"suppressedMessages":[{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":120,"column":18,"nodeType":"Literal","endLine":120,"endColumn":47,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\map\\dbscan.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\map\\heatmapController.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":163,"column":44,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":163,"endColumn":45},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":163,"column":58,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":163,"endColumn":59},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":164,"column":39,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":164,"endColumn":40},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":164,"column":53,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":164,"endColumn":54}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Heatmap Controller - Main controller for complaint heatmap functionality\n * Integrates map, visualization, and controls\n */\nclass HeatmapController {\n  constructor() {\n    this.map = null;\n    this.heatmapViz = null;\n    this.controls = null;\n    this.isInitialized = false;\n    this.zoomThreshold = 14; // Show markers only when zoomed in\n  }\n  /**\n   * Initialize the heatmap controller\n   * @param {string} mapContainerId - ID of the map container element\n   */\n  async initialize(mapContainerId = \"map\") {\n    try {\n      // console.log removed for security\n      // Initialize map\n      this.map = await initializeSimpleMap(mapContainerId, {\n        center: [6.7492, 125.3571], // Digos City, Philippines\n        zoom: 12,\n      });\n      if (!this.map) {\n        throw new Error(\"Failed to initialize map\");\n      }\n      // Initialize heatmap visualization\n      this.heatmapViz = new HeatmapVisualization(this.map);\n      // Initialize controls (skip if enhanced controls exist on the page)\n      const existingControls = document.getElementById(\"heatmap-controls\");\n      const hasEnhancedControls =\n        existingControls &&\n        existingControls.classList.contains(\"enhanced-controls\");\n      if (!hasEnhancedControls && !window.enhancedHeatmapController) {\n        this.controls = new HeatmapControls(this);\n      } else {\n        // Use existing enhanced controls panel; do not create legacy controls\n        this.controls = null;\n      }\n      // Load initial data\n      await this.loadData();\n      // Set up event listeners\n      this.setupEventListeners();\n      this.isInitialized = true;\n      // console.log removed for security\n    } catch (error) {\n      console.error(\"[HEATMAP-CONTROLLER] Initialization failed:\", error);\n      throw error;\n    }\n  }\n  /**\n   * Load complaint data with current filters\n   */\n  async loadData() {\n    try {\n      const filters = this.controls ? this.controls.getCurrentFilters() : {};\n      await this.heatmapViz.loadComplaintData(filters);\n      this.refreshVisualization();\n    } catch (error) {\n      console.error(\"[HEATMAP-CONTROLLER] Failed to load data:\", error);\n      this.showError(\"Failed to load complaint data\");\n    }\n  }\n  /**\n   * Refresh the visualization based on current view\n   */\n  refreshVisualization() {\n    if (!this.heatmapViz) return;\n    // Clear all layers first\n    this.heatmapViz.clearAllLayers();\n    // Show heatmap always, markers only when zoomed in\n    this.heatmapViz.createHeatmapLayer();\n    this.heatmapViz.showHeatmap();\n    const zoom = this.map ? this.map.getZoom() : 0;\n    if (zoom >= this.zoomThreshold) {\n      this.heatmapViz.createMarkerLayer();\n      this.heatmapViz.showMarkers();\n    }\n    // Update statistics\n    this.updateStatistics();\n  }\n  /**\n   * Toggle clustering on/off\n   * @param {boolean} enabled - Whether clustering should be enabled\n   */\n  toggleClustering(enabled) {\n    if (this.heatmapViz) {\n      this.heatmapViz.toggleClustering(enabled);\n      this.updateStatistics();\n    }\n  }\n  /**\n   * Update clustering parameters\n   * @param {number} eps - Epsilon parameter\n   * @param {number} minPts - Minimum points parameter\n   */\n  updateClusteringParameters(eps, minPts) {\n    if (this.heatmapViz) {\n      this.heatmapViz.updateClusteringParameters(eps, minPts);\n      this.updateStatistics();\n    }\n  }\n  /**\n   * Apply filters and reload data\n   * @param {Object} filters - Filter options\n   */\n  async applyFilters(filters) {\n    try {\n      await this.heatmapViz.loadComplaintData(filters);\n      this.refreshVisualization();\n    } catch (error) {\n      console.error(\"[HEATMAP-CONTROLLER] Failed to apply filters:\", error);\n      this.showError(\"Failed to apply filters\");\n    }\n  }\n  /**\n   * Update statistics display\n   */\n  updateStatistics() {\n    if (!this.heatmapViz || !this.controls) return;\n    const stats = {\n      totalComplaints: this.heatmapViz.complaintData.length,\n      clusteringStats: this.heatmapViz.getClusteringStatistics(),\n    };\n    this.controls.updateStatistics(stats);\n  }\n  /**\n   * Show error message\n   * @param {string} message - Error message\n   */\n  showError(message) {\n    if (this.controls) {\n      this.controls.showError(message);\n    } else {\n      console.error(\"[HEATMAP-CONTROLLER] Error:\", message);\n    }\n  }\n  /**\n   * Set up event listeners\n   */\n  setupEventListeners() {\n    // Map events\n    if (this.map) {\n      this.map.on(\"zoomend\", () => {\n        this.updateHeatmapIntensity();\n        this.updateViewBasedOnZoom();\n      });\n      this.map.on(\"zoomstart\", () => {\n        this.handleZoomStart();\n      });\n    }\n  }\n  /**\n   * Update heatmap intensity based on zoom level\n   */\n  updateHeatmapIntensity() {\n    if (!this.heatmapViz || !this.map) return;\n    const zoom = this.map.getZoom();\n    const baseRadius = 25;\n    const baseBlur = 15;\n    // Scale down when zoomed out, scale up when zoomed in\n    const radius = Math.max(10, baseRadius - (zoom - 10) * 2);\n    const blur = Math.max(5, baseBlur - (zoom - 10) * 1.5);\n    this.heatmapViz.heatmapConfig.radius = radius;\n    this.heatmapViz.heatmapConfig.blur = blur;\n    // Refresh heatmap\n    this.heatmapViz.hideHeatmap();\n    this.heatmapViz.createHeatmapLayer();\n    this.heatmapViz.showHeatmap();\n  }\n  /**\n   * Handle zoom start event\n   */\n  handleZoomStart() {\n    // Store current state before zoom changes\n    this.preZoomView =\n      this.map.getZoom() >= this.zoomThreshold ? \"markers\" : \"heatmap\";\n  }\n  /**\n   * Update view based on zoom level\n   */\n  updateViewBasedOnZoom() {\n    if (!this.map || !this.heatmapViz) return;\n    const zoom = this.map.getZoom();\n    // console.log removed for security\n    if (zoom >= this.zoomThreshold) {\n      // Zoomed in - show markers\n      // console.log removed for security\n      this.heatmapViz.createMarkerLayer();\n      this.heatmapViz.showMarkers();\n      this.showZoomNotification(\"📍 Markers visible (zoomed in)\");\n    } else {\n      // Zoomed out - hide markers, show only heatmap\n      // console.log removed for security\n      this.heatmapViz.hideMarkers();\n      this.showZoomNotification(\"🗺️ Heatmap only (zoomed out)\");\n    }\n  }\n  /**\n   * Show zoom notification\n   */\n  showZoomNotification(message) {\n    // Create or update notification element\n    let notification = document.getElementById(\"zoom-notification\");\n    if (!notification) {\n      notification = document.createElement(\"div\");\n      notification.id = \"zoom-notification\";\n      notification.className = \"zoom-notification\";\n      // Insert after the map container\n      const mapContainer = document.getElementById(\"map\");\n      if (mapContainer && mapContainer.parentNode) {\n        mapContainer.parentNode.appendChild(notification);\n      }\n    }\n    notification.textContent = message;\n    notification.style.display = \"block\";\n    // Auto-hide after 2 seconds\n    setTimeout(() => {\n      if (notification) {\n        notification.style.display = \"none\";\n      }\n    }, 2000);\n  }\n  /**\n   * Get current map bounds\n   * @returns {L.LatLngBounds} Current map bounds\n   */\n  getMapBounds() {\n    return this.map ? this.map.getBounds() : null;\n  }\n  /**\n   * Fit map to show all complaints\n   */\n  fitToComplaints() {\n    if (\n      !this.heatmapViz ||\n      !this.map ||\n      this.heatmapViz.complaintData.length === 0\n    ) {\n      return;\n    }\n    const group = new L.featureGroup();\n    this.heatmapViz.complaintData.forEach((complaint) => {\n      group.addLayer(L.marker([complaint.lat, complaint.lng]));\n    });\n    this.map.fitBounds(group.getBounds().pad(0.1));\n  }\n  /**\n   * Export current view as image\n   * @returns {Promise<string>} Data URL of the exported image\n   */\n  async exportMap() {\n    if (!this.map) return null;\n    return new Promise((resolve) => {\n      // Use leaflet-image plugin if available, otherwise fallback\n      if (typeof L.Util.extend === \"function\" && this.map.getContainer) {\n        // Simple canvas export (basic implementation)\n        const canvas = document.createElement(\"canvas\");\n        const ctx = canvas.getContext(\"2d\");\n        const container = this.map.getContainer();\n        canvas.width = container.offsetWidth;\n        canvas.height = container.offsetHeight;\n        // This is a basic implementation - in production, use a proper map export library\n        ctx.fillStyle = \"#f0f0f0\";\n        ctx.fillRect(0, 0, canvas.width, canvas.height);\n        ctx.fillStyle = \"#333\";\n        ctx.font = \"16px Arial\";\n        ctx.textAlign = \"center\";\n        ctx.fillText(\"Map Export\", canvas.width / 2, canvas.height / 2);\n        resolve(canvas.toDataURL());\n      } else {\n        resolve(null);\n      }\n    });\n  }\n  /**\n   * Set zoom threshold for marker visibility\n   * @param {number} threshold - Zoom level threshold\n   */\n  setZoomThreshold(threshold) {\n    this.zoomThreshold = threshold;\n    // console.log removed for security\n    // Refresh view to apply new threshold\n    this.refreshVisualization();\n  }\n  /**\n   * Set heatmap intensity\n   * @param {number} intensity - Heatmap intensity multiplier\n   */\n  setHeatmapIntensity(intensity) {\n    if (this.heatmapViz) {\n      this.heatmapViz.heatmapConfig.intensity = intensity;\n      // Refresh heatmap with new intensity\n      this.heatmapViz.hideHeatmap();\n      this.heatmapViz.createHeatmapLayer();\n      this.heatmapViz.showHeatmap();\n    }\n  }\n  /**\n   * Get current state for debugging\n   * @returns {Object} Current state\n   */\n  getState() {\n    return {\n      isInitialized: this.isInitialized,\n      complaintCount: this.heatmapViz\n        ? this.heatmapViz.complaintData.length\n        : 0,\n      clusteringEnabled: this.heatmapViz\n        ? this.heatmapViz.isClusteringEnabled\n        : false,\n      mapCenter: this.map ? this.map.getCenter() : null,\n      mapZoom: this.map ? this.map.getZoom() : null,\n      zoomThreshold: this.zoomThreshold,\n    };\n  }\n}\n// Export for use in other modules\nif (typeof module !== \"undefined\" && module.exports) {\n  module.exports = HeatmapController;\n} else {\n  window.HeatmapController = HeatmapController;\n}\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\map\\heatmapControls.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":452,"column":54,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":452,"endColumn":55},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":452,"column":69,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":452,"endColumn":70},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":455,"column":44,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":455,"endColumn":45},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":455,"column":63,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":455,"endColumn":64},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":459,"column":44,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":459,"endColumn":45},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":459,"column":64,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":459,"endColumn":65},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":463,"column":44,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":463,"endColumn":45},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":463,"column":64,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":463,"endColumn":65}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Heatmap Controls - UI controls for heatmap functionality\r\n * Handles filters, clustering parameters, and view switching\r\n */\r\nclass HeatmapControls {\r\n  constructor(controller) {\r\n    this.controller = controller;\r\n    this.currentFilters = {\r\n      status: \"\",\r\n      category: \"\",\r\n      subcategory: \"\",\r\n      department: \"\",\r\n      timeRange: \"\",\r\n      startDate: \"\",\r\n      endDate: \"\",\r\n      includeResolved: true,\r\n    };\r\n    this.clusteringParams = {\r\n      eps: 0.01,\r\n      minPts: 3,\r\n    };\r\n    this.isVisible = true;\r\n    this.userRole = null;\r\n    this.userDepartmentCode = null;\r\n    this.isDepartmentLocked = false;\r\n    this.loadDepartmentsPromise = null;\r\n    this.loadCategoriesPromise = null;\r\n    this.createControls();\r\n    this.initializeUserContext();\r\n  }\r\n  /**\r\n   * Create the controls UI\r\n   */\r\n  createControls() {\r\n    const controlsContainer = document.createElement(\"div\");\r\n    controlsContainer.id = \"heatmap-controls\";\r\n    controlsContainer.className = \"map-controls\";\r\n    controlsContainer.innerHTML = this.getControlsHTML();\r\n    // Insert after the map container\r\n    const mapContainer = document.getElementById(\"map\");\r\n    if (mapContainer && mapContainer.parentNode) {\r\n      mapContainer.parentNode.insertBefore(\r\n        controlsContainer,\r\n        mapContainer.nextSibling\r\n      );\r\n    }\r\n    this.setupEventListeners();\r\n    this.loadCategoriesPromise = this.loadCategories();\r\n    this.loadDepartmentsPromise = this.loadDepartments();\r\n  }\r\n  /**\r\n   * Get HTML for controls\r\n   * @returns {string} HTML content\r\n   */\r\n  getControlsHTML() {\r\n    return `\r\n      <div class=\"control-section\">\r\n        <h3>🗺️ Heatmap Controls</h3>\r\n\r\n        <!-- Filters -->\r\n        <div class=\"control-group\">\r\n          <label>Status Filter:</label>\r\n          <select id=\"status-filter\">\r\n            <option value=\"\">All Statuses</option>\r\n            <optgroup label=\"Standard Status\">\r\n              <option value=\"new\">New</option>\r\n              <option value=\"pending\">Pending</option>\r\n              <option value=\"in progress\">In Progress</option>\r\n              <option value=\"resolved\">Resolved</option>\r\n              <option value=\"completed\">Completed</option>\r\n              <option value=\"closed\">Closed</option>\r\n              <option value=\"rejected\">Rejected</option>\r\n              <option value=\"cancelled\">Cancelled</option>\r\n            </optgroup>\r\n            <optgroup label=\"Workflow Status\">\r\n              <option value=\"new\">New</option>\r\n              <option value=\"assigned\">Assigned</option>\r\n              <option value=\"in_progress\">In Progress (Workflow)</option>\r\n              <option value=\"pending_approval\">Pending Approval</option>\r\n            </optgroup>\r\n            <optgroup label=\"Confirmation Status\">\r\n              <option value=\"waiting_for_responders\">Waiting for Responders</option>\r\n              <option value=\"waiting_for_complainant\">Waiting for Complainant</option>\r\n              <option value=\"confirmed\">Confirmed</option>\r\n              <option value=\"disputed\">Disputed</option>\r\n            </optgroup>\r\n          </select>\r\n        </div>\r\n\r\n        <div class=\"control-group\">\r\n          <label>Category Filter:</label>\r\n          <select id=\"category-filter\">\r\n            <option value=\"\">All Categories</option>\r\n            <div id=\"category-options-loading\">Loading categories...</div>\r\n          </select>\r\n        </div>\r\n\r\n        <div class=\"control-group\">\r\n          <label>Subcategory Filter:</label>\r\n          <select id=\"subcategory-filter\" disabled>\r\n            <option value=\"\">Select a category first</option>\r\n          </select>\r\n        </div>\r\n\r\n        <div class=\"control-group\" id=\"department-filter-control\">\r\n          <label>Department Filter:</label>\r\n          <select id=\"department-filter\">\r\n            <option value=\"\">All Departments</option>\r\n            <div id=\"department-options-loading\">Loading departments...</div>\r\n          </select>\r\n        </div>\r\n\r\n        <div class=\"control-group\">\r\n          <label>Time Range:</label>\r\n          <select id=\"time-range-filter\">\r\n            <option value=\"\">All Time</option>\r\n            <option value=\"today\">Today</option>\r\n            <option value=\"yesterday\">Yesterday</option>\r\n            <option value=\"last7days\">Last 7 Days</option>\r\n            <option value=\"last30days\">Last 30 Days</option>\r\n            <option value=\"last90days\">Last 90 Days</option>\r\n            <option value=\"custom\">Custom Range</option>\r\n          </select>\r\n        </div>\r\n\r\n        <div class=\"control-group\" id=\"custom-date-range\" style=\"display: none;\">\r\n          <label>Custom Date Range:</label>\r\n          <input type=\"date\" id=\"start-date\" placeholder=\"Start Date\">\r\n          <input type=\"date\" id=\"end-date\" placeholder=\"End Date\">\r\n        </div>\r\n\r\n        <div class=\"control-group\">\r\n          <label>\r\n            <input type=\"checkbox\" id=\"include-resolved\" checked>\r\n            Include Resolved Complaints\r\n          </label>\r\n        </div>\r\n\r\n        <!-- Clustering Controls -->\r\n        <div class=\"control-group clustering-controls\">\r\n          <label>Clustering:</label>\r\n          <div class=\"clustering-toggle\">\r\n            <label>\r\n              <input type=\"checkbox\" id=\"enable-clustering\">\r\n              Enable DBSCAN Clustering\r\n            </label>\r\n          </div>\r\n\r\n          <div class=\"clustering-params\" id=\"clustering-params\" style=\"display: none;\">\r\n            <label>Epsilon (km):</label>\r\n            <input type=\"range\" id=\"eps-slider\" min=\"0.005\" max=\"0.05\" step=\"0.005\" value=\"0.01\">\r\n            <span id=\"eps-value\">0.01</span>\r\n\r\n            <label>Min Points:</label>\r\n            <input type=\"range\" id=\"minpts-slider\" min=\"2\" max=\"10\" step=\"1\" value=\"3\">\r\n            <span id=\"minpts-value\">3</span>\r\n\r\n            <button id=\"suggest-params\" class=\"btn-small\">Suggest Parameters</button>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Zoom Controls -->\r\n        <div class=\"control-group\">\r\n          <label>Zoom Threshold:</label>\r\n          <input type=\"range\" id=\"zoom-threshold\" min=\"10\" max=\"18\" step=\"1\" value=\"14\">\r\n          <span id=\"zoom-threshold-value\">14</span>\r\n          <small>Show markers at this zoom level</small>\r\n        </div>\r\n\r\n        <!-- Heatmap Intensity -->\r\n        <div class=\"control-group\">\r\n          <label>Heatmap Intensity:</label>\r\n          <input type=\"range\" id=\"heatmap-intensity\" min=\"0.1\" max=\"2.0\" step=\"0.1\" value=\"1.0\">\r\n          <span id=\"heatmap-intensity-value\">1.0</span>\r\n          <small>Adjust heatmap visibility</small>\r\n        </div>\r\n\r\n        <!-- Action Buttons -->\r\n        <div class=\"control-group\">\r\n          <button id=\"apply-filters\" class=\"btn-primary\">Apply Filters</button>\r\n          <button id=\"reset-filters\" class=\"btn-secondary\">Reset</button>\r\n          <button id=\"fit-to-complaints\" class=\"btn-secondary\">Fit to Complaints</button>\r\n        </div>\r\n\r\n        <!-- Statistics -->\r\n        <div class=\"control-group stats-section\">\r\n          <h4>Statistics</h4>\r\n          <div id=\"stats-display\">\r\n            <p>Total Complaints: <span id=\"total-complaints\">0</span></p>\r\n            <p>Clusters: <span id=\"cluster-count\">0</span></p>\r\n            <p>Noise Points: <span id=\"noise-count\">0</span></p>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Error Display -->\r\n        <div id=\"error-display\" class=\"error\" style=\"display: none;\"></div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Initialize user role context for role-based UI adjustments\r\n   */\r\n  async initializeUserContext() {\r\n    try {\r\n      const { getUserRole } = await import(\"../../auth/authChecker.js\");\r\n      this.userRole = await getUserRole();\r\n    } catch (error) {\r\n      console.warn(\"[HEATMAP_CONTROLS] Failed to determine user role:\", error);\r\n    }\r\n\r\n    if (this.userRole === \"lgu-admin\") {\r\n      try {\r\n        this.userDepartmentCode = (await this.getUserDepartment()) || null;\r\n      } catch (error) {\r\n        console.warn(\r\n          \"[HEATMAP_CONTROLS] Unable to load user department:\",\r\n          error\r\n        );\r\n      }\r\n\r\n      if (this.userDepartmentCode) {\r\n        try {\r\n          await this.loadDepartmentsPromise;\r\n        } catch (_) {\r\n          // Ignore loading errors here; we still lock the UI\r\n        }\r\n        this.lockDepartmentFilterToUserOffice();\r\n        this.currentFilters.department = this.userDepartmentCode;\r\n        this.applyFilters();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Hide department filter and show notice for LGU admins\r\n   */\r\n  lockDepartmentFilterToUserOffice() {\r\n    this.isDepartmentLocked = true;\r\n    const deptSelect = document.getElementById(\"department-filter\");\r\n    if (deptSelect) {\r\n      deptSelect.value = this.userDepartmentCode || \"\";\r\n      deptSelect.disabled = true;\r\n    }\r\n\r\n    const deptGroup = document.getElementById(\"department-filter-control\");\r\n    if (deptGroup) {\r\n      deptGroup.style.display = \"none\";\r\n    }\r\n\r\n    let notice = document.getElementById(\"department-locked-notice\");\r\n    if (!notice) {\r\n      notice = document.createElement(\"div\");\r\n      notice.id = \"department-locked-notice\";\r\n      notice.className = \"control-group department-locked-notice\";\r\n      notice.innerHTML = `\r\n        <label>Office Scope:</label>\r\n        <p style=\"margin: 0; font-size: 12px; color: #374151;\">\r\n          Complaints are limited to your assigned office\r\n          <strong class=\"locked-office-code\">${this.userDepartmentCode}</strong>.\r\n        </p>\r\n      `;\r\n      const controls = document.querySelector(\r\n        \"#heatmap-controls .control-section\"\r\n      );\r\n      if (controls && deptGroup && deptGroup.parentNode) {\r\n        deptGroup.parentNode.insertBefore(notice, deptGroup.nextSibling);\r\n      } else if (controls) {\r\n        controls.appendChild(notice);\r\n      }\r\n    } else {\r\n      const codeSpan = notice.querySelector(\".locked-office-code\");\r\n      if (codeSpan) {\r\n        codeSpan.textContent = this.userDepartmentCode;\r\n      }\r\n    }\r\n  }\r\n  /**\r\n   * Set up event listeners\r\n   */\r\n  setupEventListeners() {\r\n    // Filter controls\r\n    document.getElementById(\"apply-filters\")?.addEventListener(\"click\", () => {\r\n      this.applyFilters();\r\n    });\r\n    document.getElementById(\"reset-filters\")?.addEventListener(\"click\", () => {\r\n      this.resetFilters();\r\n    });\r\n    document\r\n      .getElementById(\"fit-to-complaints\")\r\n      ?.addEventListener(\"click\", () => {\r\n        this.controller.fitToComplaints();\r\n      });\r\n    // Clustering controls\r\n    document\r\n      .getElementById(\"enable-clustering\")\r\n      ?.addEventListener(\"change\", (e) => {\r\n        this.toggleClustering(e.target.checked);\r\n      });\r\n    // Auto-switch toggle\r\n    document.getElementById(\"eps-slider\")?.addEventListener(\"input\", (e) => {\r\n      this.updateEpsValue(e.target.value);\r\n    });\r\n    document.getElementById(\"minpts-slider\")?.addEventListener(\"input\", (e) => {\r\n      this.updateMinPtsValue(e.target.value);\r\n    });\r\n    document.getElementById(\"suggest-params\")?.addEventListener(\"click\", () => {\r\n      this.suggestParameters();\r\n    });\r\n    // Real-time updates for sliders\r\n    document.getElementById(\"eps-slider\")?.addEventListener(\"input\", (_e) => {\r\n      this.updateClusteringParams();\r\n    });\r\n    document\r\n      .getElementById(\"minpts-slider\")\r\n      ?.addEventListener(\"input\", (_e) => {\r\n        this.updateClusteringParams();\r\n      });\r\n    // Zoom threshold slider\r\n    document\r\n      .getElementById(\"zoom-threshold\")\r\n      ?.addEventListener(\"input\", (e) => {\r\n        const threshold = parseInt(e.target.value);\r\n        this.updateZoomThresholdValue(threshold);\r\n        this.controller.setZoomThreshold(threshold);\r\n      });\r\n    // Heatmap intensity slider\r\n    document\r\n      .getElementById(\"heatmap-intensity\")\r\n      ?.addEventListener(\"input\", (e) => {\r\n        const intensity = parseFloat(e.target.value);\r\n        this.updateHeatmapIntensityValue(intensity);\r\n        this.controller.setHeatmapIntensity(intensity);\r\n      });\r\n    // Filter change listeners\r\n    document.getElementById(\"status-filter\")?.addEventListener(\"change\", () => {\r\n      this.applyFilters();\r\n    });\r\n    document\r\n      .getElementById(\"category-filter\")\r\n      ?.addEventListener(\"change\", async (e) => {\r\n        const categoryId = e.target.value;\r\n        await this.loadSubcategories(categoryId);\r\n        this.currentFilters.category = categoryId;\r\n        this.currentFilters.subcategory = \"\"; // Reset subcategory when category changes\r\n        this.applyFilters();\r\n      });\r\n    document\r\n      .getElementById(\"subcategory-filter\")\r\n      ?.addEventListener(\"change\", (e) => {\r\n        this.currentFilters.subcategory = e.target.value;\r\n        this.applyFilters();\r\n      });\r\n    document\r\n      .getElementById(\"department-filter\")\r\n      ?.addEventListener(\"change\", () => {\r\n        this.applyFilters();\r\n      });\r\n    document\r\n      .getElementById(\"time-range-filter\")\r\n      ?.addEventListener(\"change\", (e) => {\r\n        const timeRange = e.target.value;\r\n        this.currentFilters.timeRange = timeRange;\r\n        // Show/hide custom date range\r\n        const customDateRange = document.getElementById(\"custom-date-range\");\r\n        if (timeRange === \"custom\") {\r\n          customDateRange.style.display = \"block\";\r\n        } else {\r\n          customDateRange.style.display = \"none\";\r\n          // Set date range based on selection\r\n          this.setDateRangeFromTimeRange(timeRange);\r\n        }\r\n        this.applyFilters();\r\n      });\r\n    document.getElementById(\"start-date\")?.addEventListener(\"change\", () => {\r\n      this.applyFilters();\r\n    });\r\n    document.getElementById(\"end-date\")?.addEventListener(\"change\", () => {\r\n      this.applyFilters();\r\n    });\r\n    document\r\n      .getElementById(\"include-resolved\")\r\n      ?.addEventListener(\"change\", () => {\r\n        this.applyFilters();\r\n      });\r\n  }\r\n  /**\r\n   * Apply current filters\r\n   */\r\n  async applyFilters() {\r\n    const filters = this.getCurrentFilters();\r\n    await this.controller.applyFilters(filters);\r\n  }\r\n  /**\r\n   * Reset all filters\r\n   */\r\n  resetFilters() {\r\n    // Reset form values\r\n    const statusFilter = document.getElementById(\"status-filter\");\r\n    if (statusFilter) statusFilter.value = \"\";\r\n    const typeFilter = document.getElementById(\"type-filter\");\r\n    if (typeFilter) typeFilter.value = \"\";\r\n    const departmentFilter = document.getElementById(\"department-filter\");\r\n    if (departmentFilter) {\r\n      departmentFilter.value = this.isDepartmentLocked\r\n        ? this.userDepartmentCode || \"\"\r\n        : \"\";\r\n    }\r\n    const startDate = document.getElementById(\"start-date\");\r\n    if (startDate) startDate.value = \"\";\r\n    const endDate = document.getElementById(\"end-date\");\r\n    if (endDate) endDate.value = \"\";\r\n    const includeResolved = document.getElementById(\"include-resolved\");\r\n    if (includeResolved) includeResolved.checked = true;\r\n    // Reset clustering\r\n    document.getElementById(\"enable-clustering\").checked = false;\r\n    this.toggleClustering(false);\r\n    // Apply reset filters\r\n    this.currentFilters = {\r\n      status: \"\",\r\n      type: \"\",\r\n      department: this.isDepartmentLocked ? this.userDepartmentCode || \"\" : \"\",\r\n      startDate: \"\",\r\n      endDate: \"\",\r\n      includeResolved: true,\r\n    };\r\n    this.applyFilters();\r\n  }\r\n  /**\r\n   * Set date range based on time range selection\r\n   * @param {string} timeRange - Selected time range\r\n   */\r\n  setDateRangeFromTimeRange(timeRange) {\r\n    const now = new Date();\r\n    const startDateInput = document.getElementById(\"start-date\");\r\n    const endDateInput = document.getElementById(\"end-date\");\r\n    if (!startDateInput || !endDateInput) return;\r\n    const clearDates = () => {\r\n      startDateInput.value = \"\";\r\n      endDateInput.value = \"\";\r\n    };\r\n    if (!timeRange) {\r\n      clearDates();\r\n      return;\r\n    }\r\n    let startDate, endDate;\r\n    switch (timeRange) {\r\n      case \"today\":\r\n        startDate = endDate = now;\r\n        break;\r\n      case \"yesterday\":\r\n        startDate = endDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);\r\n        break;\r\n      case \"last7days\":\r\n        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\r\n        endDate = now;\r\n        break;\r\n      case \"last30days\":\r\n        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\r\n        endDate = now;\r\n        break;\r\n      case \"last90days\":\r\n        startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);\r\n        endDate = now;\r\n        break;\r\n      default:\r\n        clearDates();\r\n        return;\r\n    }\r\n    startDateInput.value = startDate.toISOString().split(\"T\")[0];\r\n    endDateInput.value = endDate.toISOString().split(\"T\")[0];\r\n  }\r\n  /**\r\n   * Get current filter values\r\n   * @returns {Object} Current filters\r\n   */\r\n  getCurrentFilters() {\r\n    const selectedDepartment =\r\n      document.getElementById(\"department-filter\")?.value || \"\";\r\n    const enforcedDepartment = this.isDepartmentLocked\r\n      ? this.userDepartmentCode || \"\"\r\n      : selectedDepartment;\r\n    return {\r\n      status: document.getElementById(\"status-filter\")?.value || \"\",\r\n      category: this.currentFilters.category || \"\",\r\n      subcategory: this.currentFilters.subcategory || \"\",\r\n      department: enforcedDepartment,\r\n      timeRange: this.currentFilters.timeRange || \"\",\r\n      startDate: document.getElementById(\"start-date\")?.value || \"\",\r\n      endDate: document.getElementById(\"end-date\")?.value || \"\",\r\n      includeResolved:\r\n        document.getElementById(\"include-resolved\")?.checked || true,\r\n    };\r\n  }\r\n  /**\r\n   * Toggle clustering on/off\r\n   * @param {boolean} enabled - Whether clustering is enabled\r\n   */\r\n  toggleClustering(enabled) {\r\n    const paramsDiv = document.getElementById(\"clustering-params\");\r\n    if (paramsDiv) {\r\n      paramsDiv.style.display = enabled ? \"block\" : \"none\";\r\n    }\r\n    this.controller.toggleClustering(enabled);\r\n  }\r\n  /**\r\n   * Update epsilon value display\r\n   * @param {string} value - Epsilon value\r\n   */\r\n  updateEpsValue(value) {\r\n    const display = document.getElementById(\"eps-value\");\r\n    if (display) {\r\n      display.textContent = value;\r\n    }\r\n    this.clusteringParams.eps = parseFloat(value);\r\n  }\r\n  /**\r\n   * Update min points value display\r\n   * @param {string} value - Min points value\r\n   */\r\n  updateMinPtsValue(value) {\r\n    const display = document.getElementById(\"minpts-value\");\r\n    if (display) {\r\n      display.textContent = value;\r\n    }\r\n    this.clusteringParams.minPts = parseInt(value);\r\n  }\r\n  /**\r\n   * Update clustering parameters\r\n   */\r\n  updateClusteringParams() {\r\n    const eps = parseFloat(\r\n      document.getElementById(\"eps-slider\")?.value || 0.01\r\n    );\r\n    const minPts = parseInt(\r\n      document.getElementById(\"minpts-slider\")?.value || 3\r\n    );\r\n    this.clusteringParams.eps = eps;\r\n    this.clusteringParams.minPts = minPts;\r\n    this.controller.updateClusteringParameters(eps, minPts);\r\n  }\r\n  /**\r\n   * Suggest optimal clustering parameters\r\n   */\r\n  suggestParameters() {\r\n    if (\r\n      !this.controller.heatmapViz ||\r\n      this.controller.heatmapViz.complaintData.length === 0\r\n    ) {\r\n      this.showError(\"No complaint data available for parameter suggestion\");\r\n      return;\r\n    }\r\n    const points = this.controller.heatmapViz.complaintData.map((c) => ({\r\n      lat: c.lat,\r\n      lng: c.lng,\r\n    }));\r\n    const suggested =\r\n      this.controller.heatmapViz.dbscan.suggestParameters(points);\r\n    // Update sliders\r\n    const epsSlider = document.getElementById(\"eps-slider\");\r\n    const minPtsSlider = document.getElementById(\"minpts-slider\");\r\n    if (epsSlider) {\r\n      epsSlider.value = suggested.eps;\r\n      this.updateEpsValue(suggested.eps);\r\n    }\r\n    if (minPtsSlider) {\r\n      minPtsSlider.value = suggested.minPts;\r\n      this.updateMinPtsValue(suggested.minPts);\r\n    }\r\n    // Update clustering\r\n    this.updateClusteringParams();\r\n  }\r\n  /**\r\n   * Update zoom threshold value display\r\n   * @param {number} value - Zoom threshold value\r\n   */\r\n  updateZoomThresholdValue(value) {\r\n    const thresholdValue = document.getElementById(\"zoom-threshold-value\");\r\n    if (thresholdValue) {\r\n      thresholdValue.textContent = value;\r\n    }\r\n  }\r\n  /**\r\n   * Update heatmap intensity value display\r\n   * @param {number} value - Heatmap intensity value\r\n   */\r\n  updateHeatmapIntensityValue(value) {\r\n    const intensityValue = document.getElementById(\"heatmap-intensity-value\");\r\n    if (intensityValue) {\r\n      intensityValue.textContent = value.toFixed(1);\r\n    }\r\n  }\r\n  /**\r\n   * Update statistics display\r\n   * @param {Object} stats - Statistics object\r\n   */\r\n  updateStatistics(stats) {\r\n    const totalComplaints = document.getElementById(\"total-complaints\");\r\n    const clusterCount = document.getElementById(\"cluster-count\");\r\n    const noiseCount = document.getElementById(\"noise-count\");\r\n    if (totalComplaints) {\r\n      totalComplaints.textContent = stats.totalComplaints || 0;\r\n    }\r\n    if (stats.clusteringStats) {\r\n      if (clusterCount) {\r\n        clusterCount.textContent = stats.clusteringStats.numClusters || 0;\r\n      }\r\n      if (noiseCount) {\r\n        noiseCount.textContent = stats.clusteringStats.numNoise || 0;\r\n      }\r\n    } else {\r\n      if (clusterCount) clusterCount.textContent = \"0\";\r\n      if (noiseCount) noiseCount.textContent = \"0\";\r\n    }\r\n  }\r\n  /**\r\n   * Show error message\r\n   * @param {string} message - Error message\r\n   */\r\n  showError(message) {\r\n    const errorDiv = document.getElementById(\"error-display\");\r\n    if (errorDiv) {\r\n      errorDiv.textContent = message;\r\n      errorDiv.style.display = \"block\";\r\n      // Hide after 5 seconds\r\n      setTimeout(() => {\r\n        errorDiv.style.display = \"none\";\r\n      }, 5000);\r\n    }\r\n  }\r\n  /**\r\n   * Toggle controls visibility\r\n   */\r\n  toggleVisibility() {\r\n    const controls = document.getElementById(\"heatmap-controls\");\r\n    if (controls) {\r\n      this.isVisible = !this.isVisible;\r\n      controls.style.display = this.isVisible ? \"block\" : \"none\";\r\n    }\r\n  }\r\n  /**\r\n   * Load categories dynamically\r\n   */\r\n  async loadCategories() {\r\n    try {\r\n      const apiClientModule = await import(\"../../config/apiClient.js\");\r\n      const apiClient = apiClientModule.default;\r\n      const { data, error } = await apiClient.get(\r\n        \"/api/department-structure/categories\"\r\n      );\r\n      if (error) throw error;\r\n      const categorySelect = document.getElementById(\"category-filter\");\r\n      if (categorySelect) {\r\n        // Remove loading placeholder\r\n        const loadingEl = document.getElementById(\"category-options-loading\");\r\n        if (loadingEl) {\r\n          loadingEl.remove();\r\n        }\r\n        // Add category options\r\n        if (data && data.length > 0) {\r\n          data.forEach((category) => {\r\n            const option = document.createElement(\"option\");\r\n            option.value = category.id;\r\n            option.textContent = `${category.icon} ${category.name}`;\r\n            categorySelect.appendChild(option);\r\n          });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error loading categories for heatmap:\", error);\r\n      const categorySelect = document.getElementById(\"category-filter\");\r\n      if (categorySelect) {\r\n        const loadingEl = document.getElementById(\"category-options-loading\");\r\n        if (loadingEl) {\r\n          loadingEl.innerHTML =\r\n            '<option value=\"\">Error loading categories</option>';\r\n        }\r\n      }\r\n    }\r\n  }\r\n  /**\r\n   * Load subcategories for selected category\r\n   */\r\n  async loadSubcategories(categoryId) {\r\n    const subcategorySelect = document.getElementById(\"subcategory-filter\");\r\n    if (!subcategorySelect) return;\r\n    try {\r\n      if (!categoryId) {\r\n        subcategorySelect.innerHTML =\r\n          '<option value=\"\">Select a category first</option>';\r\n        subcategorySelect.disabled = true;\r\n        return;\r\n      }\r\n      subcategorySelect.innerHTML =\r\n        '<option value=\"\">Loading subcategories...</option>';\r\n      subcategorySelect.disabled = true;\r\n      const apiClientModule = await import(\"../../config/apiClient.js\");\r\n      const apiClient = apiClientModule.default;\r\n      const { data, error } = await apiClient.get(\r\n        `/api/department-structure/categories/${categoryId}/subcategories`\r\n      );\r\n      if (error) throw error;\r\n      subcategorySelect.innerHTML =\r\n        '<option value=\"\">All Subcategories</option>';\r\n      if (data && data.length > 0) {\r\n        data.forEach((subcategory) => {\r\n          const option = document.createElement(\"option\");\r\n          option.value = subcategory.id;\r\n          option.textContent = subcategory.name;\r\n          subcategorySelect.appendChild(option);\r\n        });\r\n        subcategorySelect.disabled = false;\r\n      } else {\r\n        subcategorySelect.innerHTML =\r\n          '<option value=\"\">No subcategories available</option>';\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error loading subcategories:\", error);\r\n      subcategorySelect.innerHTML =\r\n        '<option value=\"\">Error loading subcategories</option>';\r\n    }\r\n  }\r\n  /**\r\n   * Get user's department code\r\n   */\r\n  async getUserDepartment() {\r\n    try {\r\n      const apiClientModule = await import(\"../../config/apiClient.js\");\r\n      const apiClient = apiClientModule.default;\r\n      const response = await apiClient.get(\"/api/user/role-info\");\r\n      if (response.success && response.data) {\r\n        // Try multiple possible field names for department\r\n        const department =\r\n          response.data.department ||\r\n          response.data.dpt ||\r\n          response.data.metadata?.department ||\r\n          response.data.metadata?.dpt ||\r\n          response.data.raw_user_meta_data?.department ||\r\n          response.data.raw_user_meta_data?.dpt;\r\n        if (department) {\r\n          return department.toUpperCase();\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn(\"[HEATMAP_CONTROLS] Failed to get user department:\", error);\r\n    }\r\n    // Fallback: try Supabase session\r\n    try {\r\n      const { supabase } = await import(\"../../config/config.js\");\r\n      const {\r\n        data: { session },\r\n      } = await supabase.auth.getSession();\r\n      const metadata =\r\n        session?.user?.raw_user_meta_data || session?.user?.user_metadata || {};\r\n      const department = metadata.department || metadata.dpt;\r\n      if (department) {\r\n        return department.toUpperCase();\r\n      }\r\n    } catch (error) {\r\n      console.warn(\r\n        \"[HEATMAP_CONTROLS] Failed to get department from session:\",\r\n        error\r\n      );\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Load departments dynamically\r\n   */\r\n  async loadDepartments() {\r\n    try {\r\n      const { getDepartments } = await import(\"../../utils/departmentUtils.js\");\r\n      const departments = await getDepartments();\r\n\r\n      // Get user's department and sort departments to put user's office first\r\n      const userDepartmentCode =\r\n        this.userDepartmentCode || (await this.getUserDepartment());\r\n      if (userDepartmentCode && !this.userDepartmentCode) {\r\n        this.userDepartmentCode = userDepartmentCode;\r\n      }\r\n\r\n      if (userDepartmentCode && departments && departments.length > 0) {\r\n        // Sort: user's department first, then others\r\n        departments.sort((a, b) => {\r\n          const aCode = (a.code || \"\").toUpperCase();\r\n          const bCode = (b.code || \"\").toUpperCase();\r\n          const aIsUserDept = aCode === userDepartmentCode;\r\n          const bIsUserDept = bCode === userDepartmentCode;\r\n\r\n          if (aIsUserDept && !bIsUserDept) return -1;\r\n          if (!aIsUserDept && bIsUserDept) return 1;\r\n          return 0; // Keep original order for non-matching items\r\n        });\r\n      }\r\n\r\n      const departmentSelect = document.getElementById(\"department-filter\");\r\n      if (departmentSelect) {\r\n        // Remove loading placeholder\r\n        const loadingEl = document.getElementById(\"department-options-loading\");\r\n        if (loadingEl) {\r\n          loadingEl.remove();\r\n        }\r\n        // Add department options\r\n        departments.forEach((dept) => {\r\n          const option = document.createElement(\"option\");\r\n          option.value = dept.code;\r\n          const isUserDept =\r\n            userDepartmentCode &&\r\n            (dept.code || \"\").toUpperCase() === userDepartmentCode;\r\n          option.textContent = `${dept.name} (${dept.code})${\r\n            isUserDept ? \" ★\" : \"\"\r\n          }`;\r\n          if (isUserDept) {\r\n            option.style.fontWeight = \"bold\";\r\n          }\r\n          departmentSelect.appendChild(option);\r\n        });\r\n\r\n        if (this.isDepartmentLocked) {\r\n          this.lockDepartmentFilterToUserOffice();\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error loading departments for heatmap:\", error);\r\n      // Fallback to basic options\r\n      const departmentSelect = document.getElementById(\"department-filter\");\r\n      if (departmentSelect) {\r\n        const loadingEl = document.getElementById(\"department-options-loading\");\r\n        if (loadingEl) {\r\n          loadingEl.innerHTML =\r\n            '<option value=\"\">Error loading departments</option>';\r\n        }\r\n      }\r\n    }\r\n  }\r\n  /**\r\n   * Get current state\r\n   * @returns {Object} Current state\r\n   */\r\n  getState() {\r\n    return {\r\n      filters: this.getCurrentFilters(),\r\n      clusteringParams: this.clusteringParams,\r\n      isVisible: this.isVisible,\r\n    };\r\n  }\r\n}\r\n// Export for use in other modules\r\nif (typeof module !== \"undefined\" && module.exports) {\r\n  module.exports = HeatmapControls;\r\n} else {\r\n  window.HeatmapControls = HeatmapControls;\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\map\\heatmapVisualization.js","messages":[{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":13,"column":5,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":13,"endColumn":32},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '>' and '!=='. Use parentheses to clarify the intended order of operations.","line":75,"column":29,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":75,"endColumn":30},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '>' and '!=='. Use parentheses to clarify the intended order of operations.","line":75,"column":35,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":75,"endColumn":38},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '!==' and '>'. Use parentheses to clarify the intended order of operations.","line":75,"column":35,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":75,"endColumn":38},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '!==' and '>'. Use parentheses to clarify the intended order of operations.","line":75,"column":44,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":75,"endColumn":45},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":79,"column":40,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":79,"endColumn":41},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":79,"column":56,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":79,"endColumn":57},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '>' and '!=='. Use parentheses to clarify the intended order of operations.","line":101,"column":31,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":101,"endColumn":32},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '>' and '!=='. Use parentheses to clarify the intended order of operations.","line":101,"column":37,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":101,"endColumn":40},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '!==' and '>'. Use parentheses to clarify the intended order of operations.","line":101,"column":37,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":101,"endColumn":40},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '!==' and '>'. Use parentheses to clarify the intended order of operations.","line":101,"column":46,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":101,"endColumn":47},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":105,"column":42,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":105,"endColumn":43},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":105,"column":58,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":105,"endColumn":59},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":660,"column":25,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":660,"endColumn":26},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":660,"column":41,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":660,"endColumn":42},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":660,"column":41,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":660,"endColumn":42},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":661,"column":31,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":661,"endColumn":32},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '/'. Use parentheses to clarify the intended order of operations.","line":914,"column":43,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":914,"endColumn":44},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '/'. Use parentheses to clarify the intended order of operations.","line":914,"column":65,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":914,"endColumn":66},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":1314,"column":26,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":1314,"endColumn":27},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":1314,"column":34,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":1314,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":21,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Heatmap Visualization Component for Complaint Locations\r\n * Integrates with Leaflet maps and DBSCAN clustering\r\n */\r\n\r\n// Helper function to check if a point is inside a GeoJSON polygon\r\nfunction isPointInPolygon(lat, lng, geojson) {\r\n  if (!geojson) return false;\r\n\r\n  // Handle case where geojson is already a geometry object\r\n  let geometry = geojson;\r\n  if (geojson.geometry) {\r\n    geometry = geojson.geometry;\r\n  }\r\n\r\n  if (!geometry || !geometry.coordinates) return false;\r\n\r\n  if (geometry.type === \"Polygon\") {\r\n    return isPointInPolygonCoords(lat, lng, geometry.coordinates);\r\n  } else if (geometry.type === \"MultiPolygon\") {\r\n    // MultiPolygon coordinates: [[[ring1], [ring2]], ...] where each outer element is a polygon\r\n    // Check if point is in any of the polygons\r\n    return geometry.coordinates.some((polygon) =>\r\n      isPointInPolygonCoords(lat, lng, polygon)\r\n    );\r\n  }\r\n  return false;\r\n}\r\n\r\n// Ray casting algorithm for point-in-polygon check\r\n// coordinates can be:\r\n// - Polygon: [outerRing, innerRing1, ...] where each ring is [[lng, lat], [lng, lat], ...]\r\n// - MultiPolygon polygon: [[ring1], [ring2], ...] where each ring is [[lng, lat], [lng, lat], ...]\r\nfunction isPointInPolygonCoords(lat, lng, coordinates) {\r\n  if (!coordinates || coordinates.length === 0) return false;\r\n\r\n  // Check if this is a MultiPolygon structure (nested deeper)\r\n  // MultiPolygon coordinates structure: [[[ring1], [ring2]], ...]\r\n  // If coordinates[0][0] is an array of arrays (not just numbers), it's a MultiPolygon polygon\r\n  if (\r\n    Array.isArray(coordinates[0]) &&\r\n    Array.isArray(coordinates[0][0]) &&\r\n    Array.isArray(coordinates[0][0][0])\r\n  ) {\r\n    // This is a MultiPolygon polygon: [[[ring1]], [[ring2]], ...]\r\n    // Each element is a polygon with rings\r\n    return coordinates.some((polygon) =>\r\n      isPointInPolygonCoords(lat, lng, polygon)\r\n    );\r\n  }\r\n\r\n  // Single polygon: coordinates is [outerRing, innerRing1, innerRing2, ...]\r\n  // Each ring is [[lng, lat], [lng, lat], ...]\r\n  const outerRing = coordinates[0];\r\n  if (!outerRing || !Array.isArray(outerRing) || outerRing.length === 0)\r\n    return false;\r\n\r\n  let inside = false;\r\n\r\n  // Ray casting algorithm: cast a horizontal ray from (lat, lng) going right (increasing longitude)\r\n  // GeoJSON coordinates are [longitude, latitude]\r\n  for (let i = 0, j = outerRing.length - 1; i < outerRing.length; j = i++) {\r\n    const lng1 = outerRing[i][0]; // longitude of point i\r\n    const lat1 = outerRing[i][1]; // latitude of point i\r\n    const lng2 = outerRing[j][0]; // longitude of point j\r\n    const lat2 = outerRing[j][1]; // latitude of point j\r\n\r\n    // Skip horizontal edges (they don't contribute to the intersection count)\r\n    if (Math.abs(lat2 - lat1) < 1e-10) continue;\r\n\r\n    // Check if the horizontal ray from (lat, lng) intersects the edge from (lat1, lng1) to (lat2, lng2)\r\n    // The ray intersects if:\r\n    // 1. The point's latitude is between the edge's latitudes (or the edge crosses the point's latitude)\r\n    // 2. The intersection longitude is to the right of the point's longitude\r\n    const latBetween = lat1 > lat !== lat2 > lat;\r\n    if (latBetween) {\r\n      // Calculate the longitude where the edge crosses the point's latitude\r\n      const intersectLng =\r\n        ((lat - lat1) * (lng2 - lng1)) / (lat2 - lat1) + lng1;\r\n      // If the intersection is to the right of the point, count it\r\n      if (lng < intersectLng) {\r\n        inside = !inside;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Check if point is in any inner rings (holes)\r\n  for (let ringIndex = 1; ringIndex < coordinates.length; ringIndex++) {\r\n    const innerRing = coordinates[ringIndex];\r\n    let inHole = false;\r\n\r\n    for (let i = 0, j = innerRing.length - 1; i < innerRing.length; j = i++) {\r\n      const lng1 = innerRing[i][0]; // longitude of point i\r\n      const lat1 = innerRing[i][1]; // latitude of point i\r\n      const lng2 = innerRing[j][0]; // longitude of point j\r\n      const lat2 = innerRing[j][1]; // latitude of point j\r\n\r\n      // Skip horizontal edges\r\n      if (Math.abs(lat2 - lat1) < 1e-10) continue;\r\n\r\n      const latBetween = lat1 > lat !== lat2 > lat;\r\n      if (latBetween) {\r\n        // Calculate the longitude where the edge crosses the point's latitude\r\n        const intersectLng =\r\n          ((lat - lat1) * (lng2 - lng1)) / (lat2 - lat1) + lng1;\r\n        if (lng < intersectLng) {\r\n          inHole = !inHole;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (inHole) {\r\n      inside = false; // Point is in a hole, so it's outside\r\n      break;\r\n    }\r\n  }\r\n\r\n  return inside;\r\n}\r\n\r\n// Check if coordinates are within any barangay boundary\r\nfunction isWithinCityBoundary(lat, lng) {\r\n  if (typeof lat !== \"number\" || typeof lng !== \"number\") return false;\r\n\r\n  // Check if boundaries are loaded\r\n  if (!window.cityBoundaries || !Array.isArray(window.cityBoundaries)) {\r\n    // Fallback to bounding box if boundaries not loaded\r\n    const minLat = 6.6;\r\n    const maxLat = 7.0;\r\n    const minLng = 125.0;\r\n    const maxLng = 125.7;\r\n    return lat >= minLat && lat <= maxLat && lng >= minLng && lng <= maxLng;\r\n  }\r\n\r\n  // Debug: Log boundary structure once\r\n  if (!window._boundaryDebugged && window.cityBoundaries.length > 0) {\r\n    window._boundaryDebugged = true;\r\n    const _firstBoundary = window.cityBoundaries[0];\r\n\r\n    // Test with a known point inside Digos City (approximate center)\r\n    const testLat = 6.85;\r\n    const testLng = 125.35;\r\n    let _testResult = false;\r\n    for (const boundary of window.cityBoundaries) {\r\n      if (\r\n        boundary &&\r\n        boundary.geojson &&\r\n        isPointInPolygon(testLat, testLng, boundary.geojson)\r\n      ) {\r\n        _testResult = true;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Check if point is within any barangay boundary\r\n  for (const boundary of window.cityBoundaries) {\r\n    if (boundary && boundary.geojson) {\r\n      if (isPointInPolygon(lat, lng, boundary.geojson)) {\r\n        return true;\r\n      }\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nclass HeatmapVisualization {\r\n  constructor(map) {\r\n    this.map = map;\r\n    this.complaintData = [];\r\n    this.allComplaintData = []; // Store all complaints for client-side filtering\r\n    this.roleScopedCache = null; // Cache filtered complaints per role for this tick\r\n    this.markerMap = new Map(); // Map complaint ID to marker for quick lookup\r\n    this.clusters = [];\r\n    this.heatmapLayer = null;\r\n    this.markerLayer = null;\r\n    this.clusterLayer = null;\r\n    this.dbscan = new DBSCAN();\r\n    this.isClusteringEnabled = false;\r\n    this.currentFilters = {};\r\n    this.filterByBoundary = true; // Enable boundary filtering by default\r\n    this.userRole = null; // Will be set when role is determined\r\n    this.userDepartment = null; // Will be set for LGU admins\r\n    // Dynamic heatmap scaling configuration\r\n    this.dynamicScaling = {\r\n      enabled: true, // Enable dynamic scaling by default\r\n      maxDensity: 1.0, // Current maximum density value\r\n      smoothedMaxDensity: 1.0, // Smoothed maximum for preventing flickering\r\n      smoothingFactor: 0.3, // Smoothing factor (0-1): lower = more smoothing, higher = more responsive\r\n      minMaxDensity: 0.1, // Minimum max density to prevent division by zero\r\n      densityHistory: [], // History for rolling average (optional)\r\n      historySize: 5, // Number of previous max densities to keep for smoothing\r\n    };\r\n    // Heatmap configuration\r\n    this.heatmapConfig = {\r\n      radius: 30,\r\n      blur: 15,\r\n      maxZoom: 18,\r\n      max: 1.0,\r\n      intensity: 1.0,\r\n      gradient: {\r\n        0.0: \"transparent\",\r\n        0.2: \"blue\",\r\n        0.4: \"cyan\",\r\n        0.6: \"lime\",\r\n        0.7: \"yellow\",\r\n        0.8: \"orange\",\r\n        1.0: \"red\",\r\n      },\r\n    };\r\n    // Cluster configuration\r\n    this.clusterConfig = {\r\n      eps: 0.1, // ~10km (increased from 0.01)\r\n      minPts: 5,\r\n      clusterColors: [\r\n        \"#FF6B6B\",\r\n        \"#4ECDC4\",\r\n        \"#45B7D1\",\r\n        \"#96CEB4\",\r\n        \"#FFEAA7\",\r\n        \"#DDA0DD\",\r\n        \"#98D8C8\",\r\n        \"#F7DC6F\",\r\n        \"#BB8FCE\",\r\n        \"#85C1E9\",\r\n      ],\r\n    };\r\n    // Setup zoom listener for dynamic marker sizing\r\n    if (this.map) {\r\n      this.map.on(\"zoomend\", () => {\r\n        this.updateMarkerSizes();\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Normalize all department sources for a complaint into uppercase codes\r\n   * @param {Object} complaint\r\n   * @returns {string[]} department codes\r\n   */\r\n  getComplaintDepartments(complaint) {\r\n    if (!complaint) return [];\r\n\r\n    const rawEntries = [];\r\n    const pushValue = (value) => {\r\n      if (value === null || typeof value === \"undefined\") return;\r\n      if (Array.isArray(value)) {\r\n        value.forEach(pushValue);\r\n        return;\r\n      }\r\n      rawEntries.push(value);\r\n    };\r\n\r\n    pushValue(complaint.departments);\r\n    pushValue(complaint.department_r);\r\n    pushValue(complaint.secondaryDepartments);\r\n    pushValue(complaint.department);\r\n    pushValue(complaint.departmentCode || complaint.department_code);\r\n\r\n    const normalized = rawEntries\r\n      .map((entry) => {\r\n        if (!entry) return \"\";\r\n        if (typeof entry === \"string\") return entry;\r\n        if (typeof entry === \"object\") {\r\n          return (\r\n            entry.code ||\r\n            entry.department_code ||\r\n            entry.departmentCode ||\r\n            entry.value ||\r\n            entry.name ||\r\n            \"\"\r\n          );\r\n        }\r\n        return String(entry || \"\");\r\n      })\r\n      .flatMap((value) => value.split(\",\"))\r\n      .map((value) => value.toUpperCase().trim())\r\n      .filter(Boolean);\r\n\r\n    return [...new Set(normalized)];\r\n  }\r\n\r\n  /**\r\n   * Scope visible complaints based on role\r\n   * @returns {Array} complaints limited to current user's access\r\n   */\r\n  getRoleScopedComplaints() {\r\n    if (!Array.isArray(this.allComplaintData)) return [];\r\n\r\n    const cacheHit =\r\n      this.roleScopedCache &&\r\n      this.roleScopedCache.role === this.userRole &&\r\n      this.roleScopedCache.department === this.userDepartment &&\r\n      this.roleScopedCache.sourceSize === this.allComplaintData.length;\r\n\r\n    if (cacheHit) {\r\n      return this.roleScopedCache.data;\r\n    }\r\n\r\n    const scoped = this.filterComplaintsByRole(this.allComplaintData);\r\n    this.roleScopedCache = {\r\n      role: this.userRole,\r\n      department: this.userDepartment,\r\n      sourceSize: this.allComplaintData.length,\r\n      data: scoped,\r\n    };\r\n\r\n    return scoped;\r\n  }\r\n  /**\r\n   * Initialize user role and department for role-based filtering\r\n   */\r\n  async initializeUserRole() {\r\n    try {\r\n      const { getUserRole } = await import(\"../../auth/authChecker.js\");\r\n      this.userRole = await getUserRole();\r\n\r\n      // Get department for LGU admins\r\n      if (\r\n        this.userRole &&\r\n        [\"lgu\", \"lgu-admin\", \"lgu-hr\"].includes(this.userRole)\r\n      ) {\r\n        try {\r\n          const { supabase } = await import(\"../../config/config.js\");\r\n          const {\r\n            data: { session },\r\n          } = await supabase.auth.getSession();\r\n          const metadata =\r\n            session?.user?.raw_user_meta_data ||\r\n            session?.user?.user_metadata ||\r\n            {};\r\n          this.userDepartment = metadata.dpt || metadata.department;\r\n        } catch (error) {\r\n          console.warn(\r\n            \"[HEATMAP] Failed to get department from metadata:\",\r\n            error\r\n          );\r\n        }\r\n      }\r\n\r\n      console.log(\"[HEATMAP] User role initialized:\", {\r\n        role: this.userRole,\r\n        department: this.userDepartment,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"[HEATMAP] Failed to initialize user role:\", error);\r\n      this.userRole = \"citizen\"; // Default fallback\r\n    }\r\n    // Clear scoped cache so new role context takes effect immediately\r\n    this.roleScopedCache = null;\r\n  }\r\n\r\n  /**\r\n   * Filter complaints based on user role\r\n   * @param {Array} complaints - Array of complaints to filter\r\n   * @returns {Array} Filtered complaints based on role\r\n   */\r\n  filterComplaintsByRole(complaints) {\r\n    if (!this.userRole) {\r\n      // If role not initialized, return all (will be filtered later)\r\n      return complaints;\r\n    }\r\n\r\n    // Citizens: Only see complaints within Digos City boundaries (already filtered)\r\n    // Heatmap shows all, but markers are hidden for citizens\r\n    if (this.userRole === \"citizen\") {\r\n      return complaints; // All complaints for heatmap, but markers won't be shown\r\n    }\r\n\r\n    // Complaint coordinators: See all complaints\r\n    if (\r\n      this.userRole === \"complaint-coordinator\" ||\r\n      this.userRole === \"super-admin\"\r\n    ) {\r\n      return complaints; // All complaints\r\n    }\r\n\r\n    // LGU Admins: See only complaints assigned to their department\r\n    if (this.userRole === \"lgu-admin\" && this.userDepartment) {\r\n      const targetDept = String(this.userDepartment || \"\")\r\n        .toUpperCase()\r\n        .trim();\r\n      return complaints.filter((complaint) => {\r\n        const complaintDepartments = this.getComplaintDepartments(complaint);\r\n        return complaintDepartments.includes(targetDept);\r\n      });\r\n    }\r\n\r\n    // Default: return all (fallback)\r\n    return complaints;\r\n  }\r\n\r\n  /**\r\n   * Load complaint data from API\r\n   * @param {Object} filters - Filter options\r\n   */\r\n  async loadComplaintData(filters = {}) {\r\n    try {\r\n      // console.log removed for security\r\n      this.currentFilters = filters;\r\n      // Reset filtered count for this load\r\n      this._filteredCount = 0;\r\n\r\n      // CRITICAL: Role-based filter handling\r\n      // - Coordinators and super-admins: Remove department filter (see all complaints)\r\n      // - LGU Admins: Add department filter if not present (see only their office)\r\n      const sanitizedFilters = { ...filters };\r\n      if (\r\n        this.userRole === \"complaint-coordinator\" ||\r\n        this.userRole === \"super-admin\"\r\n      ) {\r\n        delete sanitizedFilters.department;\r\n        console.log(\r\n          \"[HEATMAP] Coordinator/Super-admin detected - removing department filter from API request\"\r\n        );\r\n      } else if (\r\n        this.userRole === \"lgu-admin\" &&\r\n        this.userDepartment &&\r\n        !sanitizedFilters.department\r\n      ) {\r\n        // Automatically add department filter for LGU admins if not already present\r\n        sanitizedFilters.department = this.userDepartment;\r\n        console.log(\r\n          \"[HEATMAP] LGU Admin detected - adding department filter to API request:\",\r\n          this.userDepartment\r\n        );\r\n      }\r\n\r\n      const queryParams = new URLSearchParams();\r\n      // Explicitly include resolved complaints by default for heatmap\r\n      queryParams.append(\r\n        \"includeResolved\",\r\n        sanitizedFilters.includeResolved !== false ? \"true\" : \"false\"\r\n      );\r\n      Object.entries(sanitizedFilters).forEach(([key, value]) => {\r\n        // Skip includeResolved as we already set it above\r\n        if (key === \"includeResolved\") return;\r\n        if (value !== null && value !== void 0 && value !== \"\") {\r\n          // Handle array values (multiple selections)\r\n          if (Array.isArray(value) && value.length > 0) {\r\n            value.forEach((v) => queryParams.append(key, v));\r\n          } else if (!Array.isArray(value)) {\r\n            queryParams.append(key, value);\r\n          }\r\n        }\r\n      });\r\n\r\n      console.log(\"[HEATMAP] Loading complaint data with filters:\", {\r\n        role: this.userRole,\r\n        originalFilters: filters,\r\n        sanitizedFilters,\r\n        queryString: queryParams.toString(),\r\n      });\r\n      // console.log removed for security\r\n      // Use apiClient for authenticated requests\r\n      const apiClientModule = await import(\"../../config/apiClient.js\");\r\n      const apiClient = apiClientModule.default;\r\n      // console.log removed for security\r\n      const result = await apiClient.get(\r\n        `/api/complaints/locations?${queryParams}`\r\n      );\r\n      // Backend service already returns data with lat/lng fields correctly formatted\r\n      const raw = Array.isArray(result.data) ? result.data : [];\r\n      // console.log removed for security\r\n      // Log first item structure for debugging\r\n      if (raw.length > 0) {\r\n        // console.log removed for security\r\n        // console.log removed for security\r\n      }\r\n      // Debug: Check if we're only getting one complaint\r\n      if (raw.length === 1) {\r\n        console.warn(\r\n          \"[HEATMAP] ⚠️ WARNING: Only 1 complaint received from API!\"\r\n        );\r\n        console.warn(\"[HEATMAP] Filters applied:\", filters);\r\n        console.warn(\r\n          \"[HEATMAP] Check backend logs to see how many complaints exist in database.\"\r\n        );\r\n      }\r\n      // Backend already provides lat/lng, so we just need to validate\r\n      // Store all valid complaints (only filter by boundary, not by status/category/department)\r\n      // Debug: Log sample complaint to check department fields\r\n      if (raw.length > 0) {\r\n        console.log(\"[HEATMAP] Sample complaint data structure:\", {\r\n          id: raw[0].id,\r\n          title: raw[0].title,\r\n          departments: raw[0].departments,\r\n          department_r: raw[0].department_r,\r\n          departments_type: typeof raw[0].departments,\r\n          departments_isArray: Array.isArray(raw[0].departments),\r\n          allKeys: Object.keys(raw[0]),\r\n        });\r\n      }\r\n\r\n      const sanitizedData = raw\r\n        .map((item) => {\r\n          const lat =\r\n            typeof item.lat === \"number\" ? item.lat : parseFloat(item.lat);\r\n          const lng =\r\n            typeof item.lng === \"number\" ? item.lng : parseFloat(item.lng);\r\n          const isValid =\r\n            Number.isFinite(lat) &&\r\n            Number.isFinite(lng) &&\r\n            lat >= -90 &&\r\n            lat <= 90 &&\r\n            lng >= -180 &&\r\n            lng <= 180;\r\n\r\n          if (!isValid) {\r\n            console.warn(\r\n              \"[HEATMAP] Skipping complaint with invalid coordinates:\",\r\n              item.id,\r\n              { lat: item.lat, lng: item.lng }\r\n            );\r\n            return null;\r\n          }\r\n\r\n          return {\r\n            ...item,\r\n            lat,\r\n            lng,\r\n            priority: item.priority || \"medium\",\r\n            status: item.status || item.workflow_status || \"new\",\r\n            workflow_status: item.workflow_status || item.status || \"new\",\r\n            confirmation_status: item.confirmation_status || \"pending\",\r\n            title: item.title || \"Complaint\",\r\n            type: item.type || item.category || \"General\",\r\n            category: item.category || item.type || \"General\",\r\n            location: item.location || item.location_text || \"\",\r\n            submittedAt:\r\n              item.submittedAt || item.submitted_at || new Date().toISOString(),\r\n          };\r\n        })\r\n        .filter(Boolean);\r\n\r\n      this._filteredCount = 0;\r\n      const filteredByBoundary = [];\r\n      let withinBoundaryData = sanitizedData;\r\n\r\n      if (this.filterByBoundary) {\r\n        withinBoundaryData = sanitizedData.filter((item) => {\r\n          const withinBoundary = isWithinCityBoundary(item.lat, item.lng);\r\n          if (!withinBoundary) {\r\n            if (filteredByBoundary.length < 3) {\r\n              console.log(\r\n                \"[HEATMAP] Filtering out complaint outside city boundaries:\",\r\n                item.id,\r\n                {\r\n                  lat: item.lat,\r\n                  lng: item.lng,\r\n                }\r\n              );\r\n            }\r\n            filteredByBoundary.push(item);\r\n            this._filteredCount++;\r\n            return false;\r\n          }\r\n          return true;\r\n        });\r\n\r\n        if (this._filteredCount > 0) {\r\n          console.log(\r\n            `[HEATMAP] Filtered out ${this._filteredCount} complaints outside city boundaries based on strict filtering.`\r\n          );\r\n        }\r\n      }\r\n\r\n      this.allComplaintData = withinBoundaryData;\r\n\r\n      // Invalidate role cache when new data arrives\r\n      this.roleScopedCache = null;\r\n\r\n      // Initialize user role if not already done\r\n      if (!this.userRole) {\r\n        await this.initializeUserRole();\r\n      }\r\n\r\n      // Apply client-side filters to determine visible complaints\r\n      this.applyClientSideFilters(filters);\r\n\r\n      // Log summary of filtering\r\n      console.log(`[HEATMAP] Data loading summary:`);\r\n      console.log(`  - Raw data from API: ${raw.length} complaints`);\r\n      console.log(\r\n        `  - After coordinate validation: ${this.allComplaintData.length} complaints`\r\n      );\r\n      if (this.filterByBoundary && this._filteredCount > 0) {\r\n        console.log(\r\n          `  - Filtered out by boundary: ${this._filteredCount} complaint(s)`\r\n        );\r\n        console.log(\r\n          `  - Remaining within boundaries: ${this.allComplaintData.length} complaint(s)`\r\n        );\r\n      }\r\n      console.log(\r\n        `  - After client-side filters: ${this.complaintData.length} complaint(s) visible`\r\n      );\r\n      console.log(\r\n        `  - User role: ${this.userRole}, Department: ${\r\n          this.userDepartment || \"N/A\"\r\n        }`\r\n      );\r\n\r\n      // Debug: Check if we're missing complaints\r\n      if (raw.length > this.allComplaintData.length) {\r\n        const missing = raw.length - this.allComplaintData.length;\r\n        console.warn(\r\n          `[HEATMAP] ⚠️ WARNING: ${missing} complaint(s) were filtered out (invalid coordinates or outside boundaries)`\r\n        );\r\n      }\r\n\r\n      // console.log removed for security\r\n      // console.log removed for security\r\n      // console.log removed for security\r\n      return this.complaintData;\r\n    } catch (error) {\r\n      console.error(\"[HEATMAP] Error loading complaint data:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Calculate maximum density value from current complaint data\r\n   * @returns {number} Maximum intensity value\r\n   */\r\n  calculateMaxDensity() {\r\n    if (!this.complaintData || this.complaintData.length === 0) {\r\n      return this.dynamicScaling.minMaxDensity;\r\n    }\r\n\r\n    // Calculate raw intensity values for all complaints\r\n    const intensities = this.complaintData.map((complaint) =>\r\n      this.getIntensityValue(complaint)\r\n    );\r\n\r\n    // Find the maximum intensity\r\n    const maxIntensity = Math.max(...intensities);\r\n\r\n    // Ensure minimum value to prevent division by zero\r\n    return Math.max(maxIntensity, this.dynamicScaling.minMaxDensity);\r\n  }\r\n\r\n  /**\r\n   * Apply smoothing to maximum density to prevent flickering\r\n   * Uses exponential moving average (EMA) for smooth transitions\r\n   * Only applies smoothing when max increases (to prevent sudden jumps to red)\r\n   * When max decreases, use the new value immediately to ensure red appears\r\n   * @param {number} newMaxDensity - New maximum density value\r\n   * @returns {number} Smoothed maximum density\r\n   */\r\n  smoothMaxDensity(newMaxDensity) {\r\n    const { smoothedMaxDensity, smoothingFactor } = this.dynamicScaling;\r\n\r\n    // If new max is higher, apply smoothing to prevent sudden jumps to red\r\n    if (newMaxDensity > smoothedMaxDensity) {\r\n      // Exponential moving average: smoothed = α * new + (1 - α) * old\r\n      // Lower smoothingFactor = more smoothing (slower to change)\r\n      // Higher smoothingFactor = more responsive (faster to change)\r\n      const smoothed =\r\n        smoothingFactor * newMaxDensity +\r\n        (1 - smoothingFactor) * smoothedMaxDensity;\r\n      return Math.max(smoothed, this.dynamicScaling.minMaxDensity);\r\n    }\r\n    // If new max is lower or equal, use it immediately\r\n    // This ensures that when data changes, the highest point can still reach red\r\n    return Math.max(newMaxDensity, this.dynamicScaling.minMaxDensity);\r\n  }\r\n\r\n  /**\r\n   * Update dynamic scaling based on current data\r\n   * This should be called whenever complaint data changes\r\n   */\r\n  updateDynamicScaling() {\r\n    if (!this.dynamicScaling.enabled) {\r\n      return;\r\n    }\r\n\r\n    // Calculate new maximum density\r\n    const newMaxDensity = this.calculateMaxDensity();\r\n\r\n    // If this is the first calculation (maxDensity is still at initial value of 1.0)\r\n    // or if we have no history, reset to use the actual max immediately\r\n    const isFirstRun =\r\n      this.dynamicScaling.maxDensity === 1.0 &&\r\n      this.dynamicScaling.densityHistory.length === 0;\r\n\r\n    if (isFirstRun) {\r\n      // First run: use actual max immediately (no smoothing)\r\n      this.dynamicScaling.maxDensity = newMaxDensity;\r\n      this.dynamicScaling.smoothedMaxDensity = newMaxDensity;\r\n      console.log(\r\n        `[HEATMAP] Dynamic scaling initialized: max=${newMaxDensity.toFixed(3)}`\r\n      );\r\n    } else {\r\n      // Subsequent runs: store current max FIRST (this is what we use for normalization)\r\n      this.dynamicScaling.maxDensity = newMaxDensity;\r\n\r\n      // Update smoothed maximum density (only used for preventing flickering on increases)\r\n      this.dynamicScaling.smoothedMaxDensity =\r\n        this.smoothMaxDensity(newMaxDensity);\r\n    }\r\n\r\n    // Optional: Store in history for rolling average (alternative smoothing method)\r\n    this.dynamicScaling.densityHistory.push(newMaxDensity);\r\n    if (\r\n      this.dynamicScaling.densityHistory.length >\r\n      this.dynamicScaling.historySize\r\n    ) {\r\n      this.dynamicScaling.densityHistory.shift();\r\n    }\r\n\r\n    console.log(\r\n      `[HEATMAP] Dynamic scaling updated: max=${newMaxDensity.toFixed(\r\n        3\r\n      )}, smoothed=${this.dynamicScaling.smoothedMaxDensity.toFixed(\r\n        3\r\n      )}, usingMaxForNormalization=${this.dynamicScaling.maxDensity.toFixed(3)}`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Normalize intensity value relative to current maximum density\r\n   * Uses the actual maxDensity (not smoothed) to ensure highest point = red (1.0)\r\n   * @param {number} intensity - Raw intensity value\r\n   * @returns {number} Normalized intensity (0-1)\r\n   */\r\n  normalizeIntensity(intensity) {\r\n    if (!this.dynamicScaling.enabled) {\r\n      return Math.min(1.0, Math.max(0.0, intensity));\r\n    }\r\n\r\n    // Use actual maxDensity (not smoothed) for normalization\r\n    // This ensures the highest point always maps to red (1.0)\r\n    // Smoothing is only used to prevent flickering when max increases\r\n    const { maxDensity } = this.dynamicScaling;\r\n\r\n    // Prevent division by zero\r\n    if (maxDensity <= 0) {\r\n      return 0.0;\r\n    }\r\n\r\n    // Normalize: value / maxValue\r\n    // The highest intensity will always be maxDensity / maxDensity = 1.0 (red)\r\n    const normalized = intensity / maxDensity;\r\n\r\n    // Clamp to [0, 1] range\r\n    return Math.min(1.0, Math.max(0.0, normalized));\r\n  }\r\n\r\n  /**\r\n   * Reset dynamic scaling smoothing (useful when data changes dramatically)\r\n   * This will immediately use the new maximum density without smoothing\r\n   */\r\n  resetDynamicScaling() {\r\n    const newMaxDensity = this.calculateMaxDensity();\r\n    this.dynamicScaling.maxDensity = newMaxDensity;\r\n    // Reset smoothed to match actual max so normalization works correctly\r\n    this.dynamicScaling.smoothedMaxDensity = Math.max(\r\n      newMaxDensity,\r\n      this.dynamicScaling.minMaxDensity\r\n    );\r\n    this.dynamicScaling.densityHistory = [];\r\n    console.log(\r\n      `[HEATMAP] Dynamic scaling reset: max=${newMaxDensity.toFixed(\r\n        3\r\n      )}, smoothed=${this.dynamicScaling.smoothedMaxDensity.toFixed(3)}`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Enable or disable dynamic scaling\r\n   * @param {boolean} enabled - Whether to enable dynamic scaling\r\n   */\r\n  setDynamicScalingEnabled(enabled) {\r\n    this.dynamicScaling.enabled = enabled;\r\n    console.log(\r\n      `[HEATMAP] Dynamic scaling ${enabled ? \"enabled\" : \"disabled\"}`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Set smoothing factor for dynamic scaling\r\n   * @param {number} factor - Smoothing factor (0-1): lower = more smoothing, higher = more responsive\r\n   */\r\n  setSmoothingFactor(factor) {\r\n    this.dynamicScaling.smoothingFactor = Math.max(0, Math.min(1, factor));\r\n    console.log(\r\n      `[HEATMAP] Smoothing factor set to ${this.dynamicScaling.smoothingFactor}`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Create heatmap layer from complaint data\r\n   * For heatmap: Citizens see all Digos City complaints, Coordinators see all, Admins see all (for visualization)\r\n   * For markers: Role-based filtering applies\r\n   */\r\n  createHeatmapLayer() {\r\n    // Clear old heatmap layer before creating new one\r\n    if (this.heatmapLayer) {\r\n      // Remove from map if it's still attached\r\n      if (this.map && this.map.hasLayer(this.heatmapLayer)) {\r\n        this.map.removeLayer(this.heatmapLayer);\r\n      }\r\n      // Remove reference\r\n      this.heatmapLayer = null;\r\n    }\r\n\r\n    // Apply filters to determine which complaints should be visible\r\n    this.applyClientSideFilters(this.currentFilters || {});\r\n\r\n    // For heatmap visualization, use filtered complaintData\r\n    // markers use the same filtered data\r\n    const heatmapData = this.complaintData || [];\r\n\r\n    if (heatmapData.length === 0) {\r\n      console.warn(\"[HEATMAP] No complaint data available for heatmap\");\r\n      this.heatmapLayer = null;\r\n      return null;\r\n    }\r\n\r\n    // Update dynamic scaling based on current data\r\n    this.updateDynamicScaling();\r\n\r\n    // Convert complaint data to heatmap format with normalized intensities\r\n    const heatmapPoints = heatmapData.map((complaint) => {\r\n      const rawIntensity = this.getIntensityValue(complaint);\r\n      const normalizedIntensity = this.normalizeIntensity(rawIntensity);\r\n\r\n      return [complaint.lat, complaint.lng, normalizedIntensity];\r\n    });\r\n\r\n    // Debug: Log intensity statistics\r\n    const intensities = heatmapPoints.map((d) => d[2]);\r\n    const maxIntensity = Math.max(...intensities);\r\n    const minIntensity = Math.min(...intensities);\r\n    const _intensitiesAt1 = intensities.filter((i) => i >= 0.99).length;\r\n\r\n    // Ensure at least one point reaches 1.0 (red) by finding all max points and setting them to 1.0\r\n    if (maxIntensity < 0.99 && intensities.length > 0) {\r\n      console.warn(\r\n        `[HEATMAP] ⚠️ Max intensity (${maxIntensity.toFixed(\r\n          3\r\n        )}) is less than 1.0. Forcing highest point(s) to 1.0.`\r\n      );\r\n      // Find all indices with maximum intensity and set them to 1.0\r\n      let fixedCount = 0;\r\n      heatmapPoints.forEach((point, _index) => {\r\n        if (Math.abs(point[2] - maxIntensity) < 0.001) {\r\n          point[2] = 1.0;\r\n          fixedCount++;\r\n        }\r\n      });\r\n      console.log(\r\n        `[HEATMAP] ✓ Set ${fixedCount} point(s) with max intensity to 1.0 (red)`\r\n      );\r\n    }\r\n\r\n    console.log(\r\n      `[HEATMAP] Intensity stats: min=${minIntensity.toFixed(\r\n        3\r\n      )}, max=${Math.max(...heatmapPoints.map((d) => d[2])).toFixed(\r\n        3\r\n      )}, count at 1.0=${\r\n        intensities.filter((i) => i >= 0.99).length\r\n      }, maxDensity=${this.dynamicScaling.maxDensity.toFixed(3)}`\r\n    );\r\n\r\n    // Update heatmap config max value to ensure proper scaling\r\n    // Leaflet.heat uses the 'max' config to scale the gradient\r\n    const config = {\r\n      ...this.heatmapConfig,\r\n      max: 1.0, // Always use 1.0 since we're normalizing to [0, 1]\r\n    };\r\n\r\n    // console.log removed for security\r\n    // Create heatmap layer using Leaflet.heat\r\n    try {\r\n      this.heatmapLayer = L.heatLayer(heatmapPoints, config);\r\n      // console.log removed for security\r\n      return this.heatmapLayer;\r\n    } catch (error) {\r\n      console.error(\"[HEATMAP] Error creating heatmap layer:\", error);\r\n      return null;\r\n    }\r\n  }\r\n  /**\r\n   * Calculate intensity value for heatmap based on complaint properties\r\n   * @param {Object} complaint - Complaint data\r\n   * @returns {number} Intensity value (0-1)\r\n   */\r\n  getIntensityValue(complaint) {\r\n    let intensity = 0.5; // Base intensity\r\n    // Adjust based on priority\r\n    const priorityWeights = {\r\n      low: 0.3,\r\n      medium: 0.6,\r\n      high: 0.9,\r\n      urgent: 1.0,\r\n    };\r\n    intensity = priorityWeights[complaint.priority] || 0.5;\r\n    // Adjust based on status\r\n    const statusWeights = {\r\n      \"pending review\": 1.0,\r\n      \"in progress\": 0.8,\r\n      resolved: 0.3,\r\n      closed: 0.1,\r\n      rejected: 0.2,\r\n    };\r\n    intensity *= statusWeights[complaint.status] || 0.5;\r\n    // Adjust based on recency (more recent = higher intensity)\r\n    const daysSinceSubmission =\r\n      (Date.now() - new Date(complaint.submittedAt).getTime()) /\r\n      (1000 * 60 * 60 * 24);\r\n    const recencyFactor = Math.max(0.1, 1 - daysSinceSubmission / 30); // Decay over 30 days\r\n    intensity *= recencyFactor;\r\n    return Math.min(1.0, Math.max(0.1, intensity));\r\n  }\r\n  /**\r\n   * Apply client-side filters to determine which complaints should be visible\r\n   * @param {Object} filters - Filter criteria\r\n   */\r\n  applyClientSideFilters(filters = {}) {\r\n    const baseData = this.getRoleScopedComplaints();\r\n\r\n    if (!baseData || baseData.length === 0) {\r\n      this.complaintData = [];\r\n      return;\r\n    }\r\n\r\n    const effectiveFilters = { ...filters };\r\n    if (this.userRole === \"lgu-admin\" && this.userDepartment) {\r\n      effectiveFilters.department = this.userDepartment;\r\n    }\r\n\r\n    // Debug: Check sample complaints for department data\r\n\r\n    this.complaintData = baseData.filter((complaint) => {\r\n      // Filter by status\r\n      if (effectiveFilters.status && effectiveFilters.status !== \"\") {\r\n        const statusArray = Array.isArray(effectiveFilters.status)\r\n          ? effectiveFilters.status\r\n          : [effectiveFilters.status];\r\n        const complaintStatus = (\r\n          complaint.status ||\r\n          complaint.workflow_status ||\r\n          \"new\"\r\n        ).toLowerCase();\r\n        const complaintWorkflowStatus = (\r\n          complaint.workflow_status || \"new\"\r\n        ).toLowerCase();\r\n        const complaintConfirmationStatus = (\r\n          complaint.confirmation_status || \"pending\"\r\n        ).toLowerCase();\r\n\r\n        // Check if complaint matches any selected status\r\n        const matchesStatus = statusArray.some((filterStatus) => {\r\n          const filterLower = filterStatus.toLowerCase();\r\n          // Map legacy status to workflow status\r\n          const statusMap = {\r\n            \"pending review\": \"new\",\r\n            pending: \"new\",\r\n            \"in progress\": \"in_progress\",\r\n            resolved: \"completed\",\r\n            completed: \"completed\",\r\n            closed: \"cancelled\",\r\n            rejected: \"cancelled\",\r\n            cancelled: \"cancelled\",\r\n          };\r\n\r\n          const mappedStatus = statusMap[filterLower] || filterLower;\r\n\r\n          // Check workflow_status\r\n          if (mappedStatus === complaintWorkflowStatus) return true;\r\n          // Check confirmation_status\r\n          if (filterLower === complaintConfirmationStatus) return true;\r\n          // Check legacy status field\r\n          if (filterLower === complaintStatus) return true;\r\n\r\n          return false;\r\n        });\r\n\r\n        if (!matchesStatus) return false;\r\n      }\r\n\r\n      // Filter by category (UUIDs from categories table)\r\n      if (effectiveFilters.category && effectiveFilters.category !== \"\") {\r\n        const categoryArray = Array.isArray(effectiveFilters.category)\r\n          ? effectiveFilters.category\r\n          : [effectiveFilters.category];\r\n        // complaint.category should be a UUID that matches the filter UUIDs\r\n        const complaintCategory = complaint.category || \"\";\r\n        if (!complaintCategory || !categoryArray.includes(complaintCategory))\r\n          return false;\r\n      }\r\n\r\n      // Filter by subcategory (UUIDs from subcategories table)\r\n      if (effectiveFilters.subcategory && effectiveFilters.subcategory !== \"\") {\r\n        const subcategoryArray = Array.isArray(effectiveFilters.subcategory)\r\n          ? effectiveFilters.subcategory\r\n          : [effectiveFilters.subcategory];\r\n        // complaint.subcategory should be a UUID that matches the filter UUIDs\r\n        const complaintSubcategory = complaint.subcategory || \"\";\r\n        if (\r\n          !complaintSubcategory ||\r\n          !subcategoryArray.includes(complaintSubcategory)\r\n        )\r\n          return false;\r\n      }\r\n\r\n      // Filter by department - checks departments array (backend transforms department_r to departments)\r\n      if (effectiveFilters.department && effectiveFilters.department !== \"\") {\r\n        const departmentArray = Array.isArray(effectiveFilters.department)\r\n          ? effectiveFilters.department\r\n          : [effectiveFilters.department];\r\n        // Get complaint's assigned departments - backend returns as 'departments' field (from department_r)\r\n        // Fallback to department_r in case backend format changes\r\n        const complaintDepartments = this.getComplaintDepartments(complaint);\r\n\r\n        // Debug logging\r\n\r\n        // If complaint has no departments assigned, exclude it from results\r\n        if (complaintDepartments.length === 0) {\r\n          return false;\r\n        }\r\n\r\n        // Check if any selected department code matches any department in departments array\r\n        // Use case-insensitive comparison to handle any case variations\r\n        const matchesDepartment = departmentArray.some((filterDept) => {\r\n          const filterDeptUpper = String(filterDept || \"\")\r\n            .toUpperCase()\r\n            .trim();\r\n          return complaintDepartments.some((complaintDept) => {\r\n            const complaintDeptUpper = String(complaintDept || \"\")\r\n              .toUpperCase()\r\n              .trim();\r\n            return complaintDeptUpper === filterDeptUpper;\r\n          });\r\n        });\r\n\r\n        if (!matchesDepartment) {\r\n          return false;\r\n        }\r\n      }\r\n\r\n      // Filter by includeResolved\r\n      if (effectiveFilters.includeResolved === false) {\r\n        const workflowStatus = (\r\n          complaint.workflow_status || \"new\"\r\n        ).toLowerCase();\r\n        if (workflowStatus === \"completed\" || workflowStatus === \"cancelled\") {\r\n          return false;\r\n        }\r\n      }\r\n\r\n      // Filter by date range\r\n      if (effectiveFilters.startDate || effectiveFilters.endDate) {\r\n        const complaintDate = new Date(\r\n          complaint.submittedAt || complaint.submitted_at\r\n        );\r\n        if (isNaN(complaintDate.getTime())) {\r\n          return false; // Invalid date, exclude\r\n        }\r\n\r\n        if (effectiveFilters.startDate) {\r\n          const startDate = new Date(effectiveFilters.startDate);\r\n          startDate.setHours(0, 0, 0, 0);\r\n          if (complaintDate < startDate) {\r\n            return false;\r\n          }\r\n        }\r\n\r\n        if (effectiveFilters.endDate) {\r\n          const endDate = new Date(effectiveFilters.endDate);\r\n          endDate.setHours(23, 59, 59, 999);\r\n          if (complaintDate > endDate) {\r\n            return false;\r\n          }\r\n        }\r\n      }\r\n\r\n      return true;\r\n    });\r\n\r\n    // Debug logging after filtering\r\n  }\r\n\r\n  /**\r\n   * Create individual complaint markers (only called once on initial load)\r\n   * Role-based filtering: Citizens don't see markers, Coordinators see all, Admins see assigned only\r\n   */\r\n  createMarkerLayer() {\r\n    // Only create markers if they don't exist yet\r\n    if (this.markerLayer && this.markerLayer.getLayers().length > 0) {\r\n      console.log(\"[HEATMAP] Markers already exist, skipping recreation\");\r\n      // Don't update visibility here - let the caller handle it based on zoom level\r\n      return this.markerLayer;\r\n    }\r\n\r\n    if (!this.allComplaintData || this.allComplaintData.length === 0) {\r\n      console.warn(\"[HEATMAP] No complaint data to create markers from\");\r\n      this.markerLayer = null;\r\n      return null;\r\n    }\r\n\r\n    // Initialize user role if not already done\r\n    if (!this.userRole) {\r\n      // Synchronous fallback - role should be initialized in loadComplaintData\r\n      console.warn(\r\n        \"[HEATMAP] User role not initialized, defaulting to citizen\"\r\n      );\r\n      this.userRole = \"citizen\";\r\n    }\r\n\r\n    // Filter complaints for markers based on role\r\n    let complaintsForMarkers = this.getRoleScopedComplaints();\r\n\r\n    // Citizens: No markers (only heatmap)\r\n    if (this.userRole === \"citizen\") {\r\n      console.log(\r\n        \"[HEATMAP] Citizen role: Markers disabled, only heatmap shown\"\r\n      );\r\n      this.markerLayer = L.layerGroup(); // Empty layer group\r\n      this.markerMap.clear();\r\n      return this.markerLayer;\r\n    }\r\n\r\n    // Complaint coordinators and super-admin: All markers\r\n    if (\r\n      this.userRole === \"complaint-coordinator\" ||\r\n      this.userRole === \"super-admin\"\r\n    ) {\r\n      complaintsForMarkers = this.allComplaintData;\r\n      console.log(\"[HEATMAP] Coordinator/Super-admin: Showing all markers\");\r\n    }\r\n    // LGU Admins: Only complaints assigned to their office/department\r\n    else if (this.userRole === \"lgu-admin\" && this.userDepartment) {\r\n      complaintsForMarkers = this.getRoleScopedComplaints();\r\n      console.log(\r\n        `[HEATMAP] LGU Admin (${this.userDepartment}): Showing ${complaintsForMarkers.length} assigned complaints out of ${this.allComplaintData.length} total`\r\n      );\r\n    }\r\n    // Default: No markers\r\n    else {\r\n      console.log(`[HEATMAP] Role ${this.userRole}: Markers disabled`);\r\n      this.markerLayer = L.layerGroup(); // Empty layer group\r\n      this.markerMap.clear();\r\n      return this.markerLayer;\r\n    }\r\n\r\n    // Create marker layer and store all markers\r\n    // IMPORTANT: Do NOT add layer to map during creation - caller will handle visibility\r\n    this.markerLayer = L.layerGroup();\r\n    this.markerMap.clear();\r\n\r\n    complaintsForMarkers.forEach((complaint, index) => {\r\n      try {\r\n        const marker = this.createComplaintMarker(complaint, index);\r\n        // Add marker to layer group (but NOT to map)\r\n        this.markerLayer.addLayer(marker);\r\n        // Store marker reference by complaint ID for quick lookup\r\n        if (complaint.id) {\r\n          this.markerMap.set(complaint.id, marker);\r\n        }\r\n        // Ensure marker is NOT on the map (safety check)\r\n        if (this.map && this.map.hasLayer(marker)) {\r\n          this.map.removeLayer(marker);\r\n        }\r\n      } catch (error) {\r\n        console.error(\r\n          `[HEATMAP] Failed to create marker ${index + 1}:`,\r\n          error,\r\n          complaint\r\n        );\r\n      }\r\n    });\r\n\r\n    console.log(\r\n      `[HEATMAP] Created ${\r\n        this.markerLayer.getLayers().length\r\n      } marker(s) for all complaints`\r\n    );\r\n\r\n    // CRITICAL: Ensure marker layer is NOT on the map during creation\r\n    // The caller will handle adding/removing based on zoom level and initial load state\r\n    if (this.map && this.map.hasLayer(this.markerLayer)) {\r\n      this.map.removeLayer(this.markerLayer);\r\n    }\r\n\r\n    // Don't apply visibility here - let the caller handle it based on zoom level\r\n    // Markers will be shown/hidden by updateZoomBasedVisibility() in heatmap-init.js\r\n\r\n    return this.markerLayer;\r\n  }\r\n\r\n  /**\r\n   * Update marker visibility based on current filters (show/hide without removing)\r\n   */\r\n  updateMarkerVisibility() {\r\n    if (!this.markerLayer || !this.map) return;\r\n\r\n    // Check if we're in initial load mode (markers should stay hidden)\r\n    // This is a safety check - the caller should prevent this during initial load\r\n    if (window.isInitialLoad === true) {\r\n      // During initial load, don't show markers - just ensure they're hidden\r\n      this.markerLayer.eachLayer((marker) => {\r\n        if (this.map.hasLayer(marker)) {\r\n          this.map.removeLayer(marker);\r\n        }\r\n      });\r\n      if (this.map.hasLayer(this.markerLayer)) {\r\n        this.map.removeLayer(this.markerLayer);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Apply filters to determine which complaints should be visible\r\n    this.applyClientSideFilters(this.currentFilters || {});\r\n\r\n    const visibleComplaintIds = new Set(this.complaintData.map((c) => c.id));\r\n    let visibleCount = 0;\r\n    let hiddenCount = 0;\r\n\r\n    // Ensure marker layer is on the map first (only if not initial load)\r\n    if (!this.map.hasLayer(this.markerLayer)) {\r\n      this.markerLayer.addTo(this.map);\r\n    }\r\n\r\n    // Update visibility of each marker\r\n    this.markerLayer.eachLayer((marker) => {\r\n      // Get complaint ID from marker (try multiple ways)\r\n      const complaintId =\r\n        marker._complaintId ||\r\n        marker.options?.complaintId ||\r\n        (this.markerMap &&\r\n          Array.from(this.markerMap.entries()).find(\r\n            ([_id, m]) => m === marker\r\n          )?.[0]);\r\n\r\n      // Determine if marker should be visible\r\n      let shouldBeVisible = false;\r\n      if (complaintId) {\r\n        shouldBeVisible = visibleComplaintIds.has(complaintId);\r\n      } else {\r\n        // Fallback: check by coordinates (less reliable but works if ID is missing)\r\n        const latLng = marker.getLatLng();\r\n        shouldBeVisible = this.complaintData.some(\r\n          (c) =>\r\n            Math.abs(c.lat - latLng.lat) < 0.0001 &&\r\n            Math.abs(c.lng - latLng.lng) < 0.0001\r\n        );\r\n      }\r\n\r\n      // Show or hide marker based on filter match\r\n      // Note: Markers are part of markerLayer, so we manage visibility by adding/removing from layer\r\n      if (shouldBeVisible) {\r\n        // Show marker - ensure it's in the layer (it should be, but check anyway)\r\n        if (!this.markerLayer.hasLayer(marker)) {\r\n          this.markerLayer.addLayer(marker);\r\n        }\r\n        // Also ensure it's visible on the map\r\n        if (!this.map.hasLayer(marker)) {\r\n          marker.addTo(this.map);\r\n        }\r\n        visibleCount++;\r\n      } else {\r\n        // Hide marker by removing from map (but keep in layer for later)\r\n        if (this.map.hasLayer(marker)) {\r\n          this.map.removeLayer(marker);\r\n        }\r\n        hiddenCount++;\r\n      }\r\n    });\r\n\r\n    // Dispatch custom event for marker visibility update\r\n    if (typeof window !== \"undefined\" && window.dispatchEvent) {\r\n      const event = new CustomEvent(\"markerVisibilityUpdated\", {\r\n        detail: {\r\n          visibleCount,\r\n          hiddenCount,\r\n          totalCount: this.markerLayer.getLayers().length,\r\n        },\r\n      });\r\n      window.dispatchEvent(event);\r\n    }\r\n  }\r\n  /**\r\n   * Create clickable circles for complaints\r\n   */\r\n  createCircleLayer() {\r\n    if (!this.complaintData || this.complaintData.length === 0) {\r\n      return null;\r\n    }\r\n    this.circleLayer = L.layerGroup();\r\n    // console.log removed for security\r\n    this.complaintData.forEach((complaint, _index) => {\r\n      // console.log removed for security\r\n      const circle = this.createComplaintCircle(complaint);\r\n      this.circleLayer.addLayer(circle);\r\n    });\r\n    // console.log removed for security\r\n    return this.circleLayer;\r\n  }\r\n  /**\r\n   * Create individual complaint marker\r\n   * @param {Object} complaint - Complaint data\r\n   * @param {number} index - Index of the complaint (for unique styling)\r\n   * @returns {L.Marker} Leaflet marker\r\n   */\r\n  createComplaintMarker(complaint, index = 0) {\r\n    const icon = this.getComplaintIcon(complaint, index);\r\n    const marker = L.marker([complaint.lat, complaint.lng], {\r\n      icon,\r\n      // Add z-index offset to prevent stacking\r\n      zIndexOffset: 1000 + index * 10,\r\n      // Store complaint ID for filtering\r\n      complaintId: complaint.id,\r\n    });\r\n    // Also store directly on marker for quick access\r\n    marker._complaintId = complaint.id;\r\n    // Create popup content\r\n    const popupContent = this.createComplaintPopup(complaint);\r\n    marker.bindPopup(popupContent, {\r\n      maxWidth: 250,\r\n      className: \"complaint-popup\",\r\n    });\r\n    return marker;\r\n  }\r\n  /**\r\n   * Create clickable circle for complaint\r\n   * @param {Object} complaint - Complaint data\r\n   * @returns {L.Circle} Leaflet circle\r\n   */\r\n  createComplaintCircle(complaint) {\r\n    const priorityColors = {\r\n      low: \"#28a745\",\r\n      medium: \"#ffc107\",\r\n      high: \"#fd7e14\",\r\n      urgent: \"#dc3545\",\r\n    };\r\n    const statusColors = {\r\n      \"pending review\": \"#6c757d\",\r\n      \"in progress\": \"#17a2b8\",\r\n      resolved: \"#28a745\",\r\n      closed: \"#6c757d\",\r\n      rejected: \"#dc3545\",\r\n    };\r\n    // Use priority color for fill, status color for border\r\n    const fillColor = priorityColors[complaint.priority] || \"#6c757d\";\r\n    const borderColor = statusColors[complaint.status] || \"#6c757d\";\r\n    // Circle size based on priority\r\n    const radiusSizes = {\r\n      low: 50,\r\n      medium: 75,\r\n      high: 100,\r\n      urgent: 125,\r\n    };\r\n    const radius = radiusSizes[complaint.priority] || 75;\r\n    const circle = L.circle([complaint.lat, complaint.lng], {\r\n      radius,\r\n      color: borderColor,\r\n      weight: 3,\r\n      opacity: 0.8,\r\n      fillColor,\r\n      fillOpacity: 0.4,\r\n      className: \"complaint-circle\",\r\n    });\r\n    // Add hover effects\r\n    circle.on(\"mouseover\", function (_e) {\r\n      this.setStyle({\r\n        weight: 5,\r\n        fillOpacity: 0.6,\r\n      });\r\n    });\r\n    circle.on(\"mouseout\", function (_e) {\r\n      this.setStyle({\r\n        weight: 3,\r\n        fillOpacity: 0.4,\r\n      });\r\n    });\r\n    // Create detailed popup content (async)\r\n    circle.bindPopup(\r\n      async () => {\r\n        return await this.createDetailedComplaintPopup(complaint);\r\n      },\r\n      {\r\n        maxWidth: 280,\r\n        className: \"complaint-circle-popup\",\r\n        closeButton: true,\r\n        autoClose: false,\r\n        keepInView: true,\r\n      }\r\n    );\r\n    // Add click event for additional actions\r\n    circle.on(\"click\", (_e) => {\r\n      // console.log removed for security\r\n      // You can add additional click actions here\r\n    });\r\n    return circle;\r\n  }\r\n  /**\r\n   * Get appropriate icon for complaint\r\n   * @param {Object} complaint - Complaint data\r\n   * @param {number} index - Index of the complaint (for unique styling)\r\n   * @returns {L.Icon} Leaflet icon\r\n   */\r\n  getComplaintIcon(complaint, index = 0) {\r\n    // Color based on complaint status\r\n    // Handles both 'status' and 'workflow_status' fields\r\n    const statusColors = {\r\n      // Standard status values\r\n      \"pending review\": \"#6c757d\", // Gray\r\n      pending: \"#6c757d\", // Gray\r\n      \"in progress\": \"#17a2b8\", // Cyan/Teal\r\n      in_progress: \"#17a2b8\", // Cyan/Teal (workflow_status format)\r\n      resolved: \"#28a745\", // Green\r\n      closed: \"#6c757d\", // Gray\r\n      rejected: \"#dc3545\", // Red\r\n      cancelled: \"#6c757d\", // Gray\r\n      completed: \"#28a745\", // Green\r\n      // Workflow status values\r\n      new: \"#6c757d\", // Gray\r\n      assigned: \"#ffc107\", // Yellow\r\n      pending_approval: \"#fd7e14\", // Orange\r\n      // Confirmation status values\r\n      waiting_for_responders: \"#17a2b8\", // Cyan\r\n      waiting_for_complainant: \"#ffc107\", // Yellow\r\n      confirmed: \"#28a745\", // Green\r\n      disputed: \"#dc3545\", // Red\r\n    };\r\n\r\n    // Check both status and workflow_status fields\r\n    let status = (\r\n      complaint.status ||\r\n      complaint.workflow_status ||\r\n      \"pending review\"\r\n    ).toLowerCase();\r\n\r\n    // If status is not found, try confirmation_status\r\n    if (!statusColors[status] && complaint.confirmation_status) {\r\n      status = complaint.confirmation_status.toLowerCase();\r\n    }\r\n\r\n    const color = statusColors[status] || \"#6c757d\"; // Default to gray if status unknown\r\n\r\n    // Dynamic sizing based on zoom level\r\n    const currentZoom = this.map ? this.map.getZoom() : 12;\r\n    const baseSize = 12; // Base size in pixels\r\n    const zoomFactor = Math.max(0.7, Math.min(1.5, currentZoom / 12)); // Scale between 0.7x and 1.5x\r\n    const size = Math.round(baseSize * zoomFactor);\r\n    const borderWidth = Math.max(2, Math.round(2 * zoomFactor));\r\n\r\n    // Add a small border color based on priority for additional visual distinction\r\n    const priorityBorderColors = {\r\n      low: \"#28a745\", // Green border\r\n      medium: \"#ffc107\", // Yellow border\r\n      high: \"#fd7e14\", // Orange border\r\n      urgent: \"#dc3545\", // Red border\r\n    };\r\n    const priority = (complaint.priority || \"medium\").toLowerCase();\r\n    const borderColor = priorityBorderColors[priority] || \"#ffffff\";\r\n\r\n    return L.divIcon({\r\n      html: `<div style=\"\r\n        background-color: ${color};\r\n        color: white;\r\n        border-radius: 50%;\r\n        width: ${size}px;\r\n        height: ${size}px;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        border: ${borderWidth}px solid ${borderColor};\r\n        box-shadow: 0 2px 6px rgba(0,0,0,0.4);\r\n        z-index: ${1000 + index};\r\n        position: relative;\r\n        cursor: pointer;\r\n        transition: all 0.2s ease;\r\n      \"></div>`,\r\n      className: \"complaint-marker\",\r\n      iconSize: [size, size],\r\n      iconAnchor: [size / 2, size / 2],\r\n    });\r\n  }\r\n  /**\r\n   * Create popup content for complaint\r\n   * @param {Object} complaint - Complaint data\r\n   * @returns {string} HTML content\r\n   */\r\n  createComplaintPopup(complaint) {\r\n    const submittedDate = new Date(complaint.submittedAt).toLocaleDateString();\r\n    const priorityClass = complaint.priority.replace(\" \", \"-\").toLowerCase();\r\n    const assignedOffices =\r\n      complaint.departments && complaint.departments.length > 0\r\n        ? complaint.departments.join(\", \")\r\n        : complaint.department || \"Not assigned\";\r\n\r\n    return `\r\n      <div class=\"complaint-popup-content\" style=\"padding: 8px; font-size: 12px; line-height: 1.3;\">\r\n        <h4 style=\"margin: 0 0 6px 0; font-size: 13px; font-weight: bold;\">${\r\n  complaint.title\r\n}</h4>\r\n        <div class=\"complaint-details\" style=\"margin: 0; padding: 0;\">\r\n          <p style=\"margin: 2px 0; font-size: 11px;\"><strong>Type:</strong> ${\r\n  complaint.type\r\n}</p>\r\n          <p style=\"margin: 2px 0; font-size: 11px;\"><strong>Status:</strong> <span class=\"status-${complaint.status.replace(\r\n    \" \",\r\n    \"-\"\r\n  )}\">${complaint.status}</span></p>\r\n          <p style=\"margin: 2px 0; font-size: 11px;\"><strong>Priority:</strong> <span class=\"priority-${priorityClass}\">${\r\n  complaint.priority\r\n}</span></p>\r\n          <p style=\"margin: 2px 0; font-size: 11px;\"><strong>Location:</strong> ${\r\n  complaint.location\r\n}</p>\r\n          <p style=\"margin: 2px 0; font-size: 11px;\"><strong>Submitted:</strong> ${submittedDate}</p>\r\n          <p style=\"margin: 2px 0; font-size: 11px;\"><strong>Assigned Offices:</strong> ${assignedOffices}</p>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Create detailed popup content for complaint circles\r\n   * @param {Object} complaint - Complaint data\r\n   * @returns {string} HTML content\r\n   */\r\n  async createDetailedComplaintPopup(complaint) {\r\n    const submittedDate = new Date(complaint.submittedAt).toLocaleDateString();\r\n    const _submittedTime = new Date(complaint.submittedAt).toLocaleTimeString();\r\n    const priorityClass = complaint.priority.replace(\" \", \"-\").toLowerCase();\r\n    const statusClass = complaint.status.replace(\" \", \"-\").toLowerCase();\r\n    const assignedOffices =\r\n      complaint.departments && complaint.departments.length > 0\r\n        ? complaint.departments.join(\", \")\r\n        : complaint.department || \"Not assigned\";\r\n\r\n    // Calculate days since submission\r\n    const daysSinceSubmission = Math.floor(\r\n      (Date.now() - new Date(complaint.submittedAt).getTime()) /\r\n        (1000 * 60 * 60 * 24)\r\n    );\r\n\r\n    // Check if user has access to this complaint\r\n    const hasAccess = await this.checkComplaintAccess(complaint);\r\n\r\n    if (!hasAccess) {\r\n      return `\r\n        <div class=\"complaint-detail-popup\" style=\"padding: 8px; font-size: 12px; line-height: 1.3; max-width: 280px;\">\r\n          <div class=\"popup-header\" style=\"margin: 0 0 6px 0; padding: 0;\">\r\n            <h3 style=\"margin: 0 0 4px 0; font-size: 13px; font-weight: bold;\">${\r\n  complaint.title\r\n}</h3>\r\n            <div class=\"complaint-badges\" style=\"display: flex; gap: 4px; margin: 0;\">\r\n              <span class=\"badge priority-${priorityClass}\" style=\"font-size: 9px; padding: 2px 4px;\">${complaint.priority.toUpperCase()}</span>\r\n              <span class=\"badge status-${statusClass}\" style=\"font-size: 9px; padding: 2px 4px;\">${complaint.status.toUpperCase()}</span>\r\n            </div>\r\n          </div>\r\n          <div class=\"popup-content\" style=\"margin: 0; padding: 0;\">\r\n            <div class=\"complaint-info\" style=\"margin: 0; padding: 0;\">\r\n              <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n                <span class=\"label\" style=\"font-weight: bold;\">Type:</span>\r\n                <span class=\"value\">${complaint.type}</span>\r\n              </div>\r\n              <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n                <span class=\"label\" style=\"font-weight: bold;\">Location:</span>\r\n                <span class=\"value\" style=\"text-align: right; max-width: 60%;\">${\r\n  complaint.location\r\n}</span>\r\n              </div>\r\n              <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n                <span class=\"label\" style=\"font-weight: bold;\">Assigned Offices:</span>\r\n                <span class=\"value\" style=\"text-align: right; max-width: 60%;\">${assignedOffices}</span>\r\n              </div>\r\n              <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n                <span class=\"label\" style=\"font-weight: bold;\">Submitted:</span>\r\n                <span class=\"value\">${submittedDate}</span>\r\n              </div>\r\n              <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n                <span class=\"label\" style=\"font-weight: bold;\">Days Open:</span>\r\n                <span class=\"value\">${daysSinceSubmission} day${\r\n  daysSinceSubmission !== 1 ? \"s\" : \"\"\r\n}</span>\r\n              </div>\r\n            </div>\r\n            <div class=\"popup-actions\" style=\"margin-top: 6px; padding-top: 6px; border-top: 1px solid #ddd;\">\r\n              <div class=\"access-denied\" style=\"font-size: 10px; color: #dc3545; text-align: center; padding: 4px;\">\r\n                <p style=\"margin: 0;\">🔒 Access restricted to assigned office</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      `;\r\n    }\r\n\r\n    return `\r\n      <div class=\"complaint-detail-popup\" style=\"padding: 8px; font-size: 12px; line-height: 1.3; max-width: 280px;\">\r\n        <div class=\"popup-header\" style=\"margin: 0 0 6px 0; padding: 0;\">\r\n          <h3 style=\"margin: 0 0 4px 0; font-size: 13px; font-weight: bold;\">${\r\n  complaint.title\r\n}</h3>\r\n          <div class=\"complaint-badges\" style=\"display: flex; gap: 4px; margin: 0;\">\r\n            <span class=\"badge priority-${priorityClass}\" style=\"font-size: 9px; padding: 2px 4px;\">${complaint.priority.toUpperCase()}</span>\r\n            <span class=\"badge status-${statusClass}\" style=\"font-size: 9px; padding: 2px 4px;\">${complaint.status.toUpperCase()}</span>\r\n          </div>\r\n        </div>\r\n        <div class=\"popup-content\" style=\"margin: 0; padding: 0;\">\r\n          <div class=\"complaint-info\" style=\"margin: 0; padding: 0;\">\r\n            <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n              <span class=\"label\" style=\"font-weight: bold;\">Type:</span>\r\n              <span class=\"value\">${complaint.type}</span>\r\n            </div>\r\n            <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n              <span class=\"label\" style=\"font-weight: bold;\">Location:</span>\r\n              <span class=\"value\" style=\"text-align: right; max-width: 60%;\">${\r\n  complaint.location\r\n}</span>\r\n            </div>\r\n            <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n              <span class=\"label\" style=\"font-weight: bold;\">Assigned Offices:</span>\r\n              <span class=\"value\" style=\"text-align: right; max-width: 60%;\">${assignedOffices}</span>\r\n            </div>\r\n            <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n              <span class=\"label\" style=\"font-weight: bold;\">Submitted:</span>\r\n              <span class=\"value\">${submittedDate}</span>\r\n            </div>\r\n            <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n              <span class=\"label\" style=\"font-weight: bold;\">Days Open:</span>\r\n              <span class=\"value\">${daysSinceSubmission} day${\r\n  daysSinceSubmission !== 1 ? \"s\" : \"\"\r\n}</span>\r\n            </div>\r\n          </div>\r\n          <div class=\"popup-actions\" style=\"margin-top: 6px; padding-top: 6px; border-top: 1px solid #ddd; display: flex; gap: 4px;\">\r\n            <button class=\"btn-details\" onclick=\"viewComplaintDetails('${\r\n  complaint.id\r\n}')\" style=\"font-size: 10px; padding: 4px 8px; flex: 1;\">\r\n              📋 Details\r\n            </button>\r\n            <button class=\"btn-location\" onclick=\"centerOnComplaint(${\r\n  complaint.lat\r\n}, ${\r\n  complaint.lng\r\n})\" style=\"font-size: 10px; padding: 4px 8px; flex: 1;\">\r\n              📍 Center\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Check if user has access to view full details of a complaint\r\n   * @param {Object} complaint - Complaint data\r\n   * @returns {boolean} True if user has access\r\n   */\r\n  async checkComplaintAccess(complaint) {\r\n    try {\r\n      // Import getUserRole function\r\n      const { getUserRole } = await import(\"../../auth/authChecker.js\");\r\n      const userRole = await getUserRole();\r\n\r\n      // console.log removed for security\r\n      // console.log removed for security\r\n      // console.log removed for security\r\n\r\n      // Super admin has access to everything\r\n      if (userRole === \"super-admin\") {\r\n        // console.log removed for security\r\n        return true;\r\n      }\r\n\r\n      // Complaint coordinator has access to everything\r\n      if (userRole === \"complaint-coordinator\") {\r\n        // console.log removed for security\r\n        return true;\r\n      }\r\n\r\n      // With simplified roles, department is stored separately in metadata\r\n      let userDepartment = null;\r\n      if (userRole && [\"lgu\", \"lgu-admin\", \"lgu-hr\"].includes(userRole)) {\r\n        // Get department from user metadata\r\n        try {\r\n          const { supabase } = await import(\"../../config/config.js\");\r\n          const {\r\n            data: { session },\r\n          } = await supabase.auth.getSession();\r\n          const metadata =\r\n            session?.user?.raw_user_meta_data ||\r\n            session?.user?.user_metadata ||\r\n            {};\r\n          userDepartment = metadata.dpt || metadata.department;\r\n        } catch (error) {\r\n          console.warn(\"Failed to get department from metadata:\", error);\r\n        }\r\n      }\r\n\r\n      // console.log removed for security\r\n\r\n      if (!userDepartment) {\r\n        // console.log removed for security\r\n        return false;\r\n      }\r\n\r\n      // Check if complaint is assigned to user's department\r\n      const complaintDepartment = complaint.department?.toUpperCase();\r\n      const complaintDepartments = complaint.departments || [];\r\n      const secondaryDepartments = complaint.secondaryDepartments || [];\r\n\r\n      // Check primary department\r\n      if (complaintDepartment === userDepartment) {\r\n        // console.log removed for security\r\n        return true;\r\n      }\r\n\r\n      // Check if user's department is in the departments array\r\n      if (complaintDepartments.includes(userDepartment)) {\r\n        // console.log removed for security\r\n        return true;\r\n      }\r\n\r\n      // Check if user's department is in secondary departments\r\n      if (secondaryDepartments.includes(userDepartment)) {\r\n        // console.log removed for security\r\n        return true;\r\n      }\r\n\r\n      // Check if it's a joint/forced complaint (multiple departments)\r\n      if (complaintDepartment && complaintDepartment.includes(\",\")) {\r\n        const assignedDepartments = complaintDepartment\r\n          .split(\",\")\r\n          .map((dept) => dept.trim().toUpperCase());\r\n        if (assignedDepartments.includes(userDepartment)) {\r\n          // console.log removed for security\r\n          return true;\r\n        }\r\n      }\r\n\r\n      // console.log removed for security\r\n      return false;\r\n    } catch (error) {\r\n      console.error(\"[HEATMAP] Error checking complaint access:\", error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Perform DBSCAN clustering on complaint data\r\n   */\r\n  performClustering() {\r\n    try {\r\n      if (!this.complaintData || this.complaintData.length === 0) {\r\n        console.warn(\"[HEATMAP] No complaint data available for clustering\");\r\n        return { clusters: [], noise: [] };\r\n      }\r\n\r\n      // Ensure DBSCAN is initialized\r\n      if (!this.dbscan) {\r\n        console.error(\"[HEATMAP] DBSCAN not initialized\");\r\n        return { clusters: [], noise: [] };\r\n      }\r\n\r\n      // Update DBSCAN parameters\r\n      this.dbscan.eps = this.clusterConfig.eps;\r\n      this.dbscan.minPts = this.clusterConfig.minPts;\r\n\r\n      // Prepare points for clustering - filter out invalid coordinates\r\n      const points = this.complaintData\r\n        .filter((complaint) => {\r\n          const lat = parseFloat(complaint.lat);\r\n          const lng = parseFloat(complaint.lng);\r\n          return (\r\n            !isNaN(lat) &&\r\n            !isNaN(lng) &&\r\n            lat >= -90 &&\r\n            lat <= 90 &&\r\n            lng >= -180 &&\r\n            lng <= 180\r\n          );\r\n        })\r\n        .map((complaint) => ({\r\n          lat: parseFloat(complaint.lat),\r\n          lng: parseFloat(complaint.lng),\r\n          data: complaint,\r\n        }));\r\n\r\n      if (points.length === 0) {\r\n        console.warn(\"[HEATMAP] No valid coordinates for clustering\");\r\n        return { clusters: [], noise: [] };\r\n      }\r\n\r\n      // Perform clustering\r\n      const clusteringResult = this.dbscan.cluster(points);\r\n      this.clusters = clusteringResult.clusters || [];\r\n\r\n      return clusteringResult;\r\n    } catch (error) {\r\n      console.error(\"[HEATMAP] Clustering failed:\", error);\r\n      return { clusters: [], noise: [] };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create cluster visualization layer\r\n   */\r\n  createClusterLayer() {\r\n    if (!this.clusters || this.clusters.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    this.clusterLayer = L.layerGroup();\r\n\r\n    this.clusters.forEach((cluster, index) => {\r\n      const clusterPoints = cluster.map((i) => this.complaintData[i]);\r\n      const clusterCenter = this.calculateClusterCenter(clusterPoints);\r\n      const clusterRadius = this.calculateClusterRadius(\r\n        clusterPoints,\r\n        clusterCenter\r\n      );\r\n\r\n      // Create cluster circle\r\n      const clusterCircle = L.circle(clusterCenter, {\r\n        radius: clusterRadius * 1000, // Convert km to meters\r\n        color:\r\n          this.clusterConfig.clusterColors[\r\n            index % this.clusterConfig.clusterColors.length\r\n          ],\r\n        weight: 2,\r\n        opacity: 0.8,\r\n        fillOpacity: 0.2,\r\n      });\r\n\r\n      // Create cluster marker\r\n      const clusterMarker = L.marker(clusterCenter, {\r\n        icon: L.divIcon({\r\n          html: `<div style=\"\r\n            background-color: ${\r\n  this.clusterConfig.clusterColors[\r\n    index % this.clusterConfig.clusterColors.length\r\n  ]\r\n};\r\n            color: white;\r\n            border-radius: 50%;\r\n            width: 40px;\r\n            height: 40px;\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            font-weight: bold;\r\n            font-size: 16px;\r\n            border: 3px solid white;\r\n            box-shadow: 0 2px 6px rgba(0,0,0,0.3);\r\n          \">${cluster.length}</div>`,\r\n          className: \"cluster-marker\",\r\n          iconSize: [40, 40],\r\n          iconAnchor: [20, 20],\r\n        }),\r\n      });\r\n\r\n      // Create cluster popup\r\n      const popupContent = this.createClusterPopup(clusterPoints, index);\r\n      clusterMarker.bindPopup(popupContent, {\r\n        maxWidth: 400,\r\n        className: \"cluster-popup\",\r\n      });\r\n\r\n      this.clusterLayer.addLayer(clusterCircle);\r\n      this.clusterLayer.addLayer(clusterMarker);\r\n    });\r\n\r\n    // console.log removed for security\r\n    return this.clusterLayer;\r\n  }\r\n\r\n  /**\r\n   * Calculate cluster center (centroid)\r\n   * @param {Array} points - Array of complaint points\r\n   * @returns {Object} Center coordinates\r\n   */\r\n  calculateClusterCenter(points) {\r\n    const lat = points.reduce((sum, p) => sum + p.lat, 0) / points.length;\r\n    const lng = points.reduce((sum, p) => sum + p.lng, 0) / points.length;\r\n    return { lat, lng };\r\n  }\r\n\r\n  /**\r\n   * Calculate cluster radius\r\n   * @param {Array} points - Array of complaint points\r\n   * @param {Object} center - Cluster center\r\n   * @returns {number} Radius in kilometers\r\n   */\r\n  calculateClusterRadius(points, center) {\r\n    let maxDistance = 0;\r\n    points.forEach((point) => {\r\n      const distance = this.dbscan.calculateDistance(center, point);\r\n      maxDistance = Math.max(maxDistance, distance);\r\n    });\r\n    return maxDistance;\r\n  }\r\n\r\n  /**\r\n   * Create cluster popup content\r\n   * @param {Array} clusterPoints - Points in the cluster\r\n   * @param {number} clusterIndex - Cluster index\r\n   * @returns {string} HTML content\r\n   */\r\n  createClusterPopup(clusterPoints, clusterIndex) {\r\n    const statusCounts = {};\r\n    const typeCounts = {};\r\n    const priorityCounts = {};\r\n\r\n    clusterPoints.forEach((complaint) => {\r\n      statusCounts[complaint.status] =\r\n        (statusCounts[complaint.status] || 0) + 1;\r\n      typeCounts[complaint.type] = (typeCounts[complaint.type] || 0) + 1;\r\n      priorityCounts[complaint.priority] =\r\n        (priorityCounts[complaint.priority] || 0) + 1;\r\n    });\r\n\r\n    return `\r\n      <div class=\"cluster-popup-content\">\r\n        <h4>Cluster ${clusterIndex + 1} (${\r\n  clusterPoints.length\r\n} complaints)</h4>\r\n        <div class=\"cluster-stats\">\r\n          <h5>Status Distribution:</h5>\r\n          <ul>\r\n            ${Object.entries(statusCounts)\r\n    .map(([status, count]) => `<li>${status}: ${count}</li>`)\r\n    .join(\"\")}\r\n          </ul>\r\n          <h5>Type Distribution:</h5>\r\n          <ul>\r\n            ${Object.entries(typeCounts)\r\n    .map(([type, count]) => `<li>${type}: ${count}</li>`)\r\n    .join(\"\")}\r\n          </ul>\r\n          <h5>Priority Distribution:</h5>\r\n          <ul>\r\n            ${Object.entries(priorityCounts)\r\n    .map(([priority, count]) => `<li>${priority}: ${count}</li>`)\r\n    .join(\"\")}\r\n          </ul>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Show heatmap on map\r\n   */\r\n  showHeatmap() {\r\n    if (!this.heatmapLayer || !this.map) {\r\n      console.warn(\"[HEATMAP] Cannot show heatmap: layer or map is null\");\r\n      return;\r\n    }\r\n\r\n    const container =\r\n      typeof this.map.getContainer === \"function\"\r\n        ? this.map.getContainer()\r\n        : null;\r\n    const width = container?.offsetWidth || 0;\r\n    const height = container?.offsetHeight || 0;\r\n\r\n    // If the map container hasn't been laid out yet, retry shortly\r\n    if (width === 0 || height === 0) {\r\n      setTimeout(() => this.showHeatmap(), 150);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Ensure Leaflet recalculates sizes before drawing the heat canvas\r\n      this.map.invalidateSize();\r\n      this.heatmapLayer.addTo(this.map);\r\n      // console.log removed for security\r\n\r\n      // Verify it's actually on the map\r\n      setTimeout(() => {\r\n        const _hasLayer = this.map._hasLayer(this.heatmapLayer);\r\n        // console.log removed for security\r\n      }, 100);\r\n    } catch (e) {\r\n      console.error(\"[HEATMAP] Error showing heatmap:\", e);\r\n      // Fallback: retry once after a brief delay if canvas was still 0-sized\r\n      setTimeout(() => {\r\n        try {\r\n          this.map.invalidateSize();\r\n          this.heatmapLayer.addTo(this.map);\r\n          // console.log removed for security\r\n        } catch (error) {\r\n          console.error(\"[HEATMAP] Failed to show heatmap on retry:\", error);\r\n        }\r\n      }, 200);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Hide heatmap from map\r\n   */\r\n  hideHeatmap() {\r\n    if (this.heatmapLayer && this.map.hasLayer(this.heatmapLayer)) {\r\n      this.map.removeLayer(this.heatmapLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show markers on map\r\n   */\r\n  showMarkers() {\r\n    if (!this.markerLayer) {\r\n      console.warn(\"[HEATMAP] Cannot show markers: markerLayer is null\");\r\n      return;\r\n    }\r\n\r\n    if (!this.map) {\r\n      console.warn(\"[HEATMAP] Cannot show markers: map is null\");\r\n      return;\r\n    }\r\n\r\n    // console.log removed for security\r\n    this.markerLayer.addTo(this.map);\r\n\r\n    // Verify markers are actually on the map\r\n    setTimeout(() => {\r\n      const hasLayer = this.map.hasLayer(this.markerLayer);\r\n      const layerCount = this.markerLayer.getLayers().length;\r\n      // console.log removed for security\r\n\r\n      if (hasLayer && layerCount > 0) {\r\n        // Get bounds of all markers to verify they're valid\r\n        try {\r\n          const layers = this.markerLayer.getLayers();\r\n          if (layers.length > 0) {\r\n            const firstMarker = layers[0];\r\n            if (firstMarker && firstMarker.getLatLng) {\r\n              const _latLng = firstMarker.getLatLng();\r\n              // console.log removed for security\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.warn(\"[HEATMAP] Could not get marker bounds:\", error);\r\n        }\r\n      }\r\n    }, 100);\r\n  }\r\n\r\n  /**\r\n   * Hide markers from map (but keep them in the layer for later use)\r\n   */\r\n  hideMarkers() {\r\n    if (this.markerLayer && this.markerLayer.getLayers) {\r\n      try {\r\n        // Remove each marker individually from map (but keep in layer)\r\n        const layers = this.markerLayer.getLayers();\r\n        layers.forEach((layer) => {\r\n          if (\r\n            layer &&\r\n            this.map &&\r\n            this.map.hasLayer &&\r\n            this.map.hasLayer(layer)\r\n          ) {\r\n            this.map.removeLayer(layer);\r\n          }\r\n        });\r\n        // Remove the layer group from map if attached\r\n        if (\r\n          this.map &&\r\n          this.map.hasLayer &&\r\n          this.map.hasLayer(this.markerLayer)\r\n        ) {\r\n          this.map.removeLayer(this.markerLayer);\r\n        }\r\n        // DO NOT clear markers from the layer - we want to keep them for when zoom > 11\r\n        // this.markerLayer.clearLayers(); // REMOVED - this was causing markers to disappear\r\n      } catch (error) {\r\n        console.warn(\"[HEATMAP] Error hiding markers:\", error);\r\n        // Fallback: just remove the layer from map\r\n        if (this.map && this.map.removeLayer) {\r\n          try {\r\n            this.map.removeLayer(this.markerLayer);\r\n          } catch (e) {\r\n            // Ignore if already removed\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update marker sizes and colors based on current zoom level and complaint data\r\n   * This ensures markers reflect current status and priority\r\n   */\r\n  updateMarkerSizes() {\r\n    if (!this.markerLayer || !this.map) return;\r\n\r\n    const markers = this.markerLayer.getLayers();\r\n    markers.forEach((marker, index) => {\r\n      // Get the original complaint data from marker's lat/lng\r\n      const latLng = marker.getLatLng();\r\n      const complaint = this.complaintData.find(\r\n        (c) =>\r\n          Math.abs(c.lat - latLng.lat) < 0.0001 &&\r\n          Math.abs(c.lng - latLng.lng) < 0.0001\r\n      );\r\n\r\n      if (complaint) {\r\n        // Create new icon with updated size and color based on current zoom and complaint status\r\n        const newIcon = this.getComplaintIcon(complaint, index);\r\n        marker.setIcon(newIcon);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update a specific marker's appearance when complaint data changes\r\n   * @param {string} complaintId - ID of the complaint to update\r\n   */\r\n  updateMarker(complaintId) {\r\n    if (!this.markerLayer || !this.map) return;\r\n\r\n    const complaint = this.complaintData.find((c) => c.id === complaintId);\r\n    if (!complaint) return;\r\n\r\n    const markers = this.markerLayer.getLayers();\r\n    const marker = markers.find((m) => {\r\n      const latLng = m.getLatLng();\r\n      return (\r\n        Math.abs(complaint.lat - latLng.lat) < 0.0001 &&\r\n        Math.abs(complaint.lng - latLng.lng) < 0.0001\r\n      );\r\n    });\r\n\r\n    if (marker) {\r\n      const index = markers.indexOf(marker);\r\n      const newIcon = this.getComplaintIcon(complaint, index);\r\n      marker.setIcon(newIcon);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Refresh all markers to reflect current complaint data (status, priority, etc.)\r\n   * Useful when complaint data is updated externally\r\n   */\r\n  refreshMarkers() {\r\n    if (!this.markerLayer || !this.map) return;\r\n\r\n    // Hide and recreate marker layer to ensure all markers reflect current data\r\n    this.hideMarkers();\r\n    this.createMarkerLayer();\r\n    this.showMarkers();\r\n  }\r\n\r\n  /**\r\n   * Show circles on map\r\n   */\r\n  showCircles() {\r\n    if (this.circleLayer) {\r\n      this.circleLayer.addTo(this.map);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Hide circles from map\r\n   */\r\n  hideCircles() {\r\n    if (this.circleLayer && this.map.hasLayer(this.circleLayer)) {\r\n      this.map.removeLayer(this.circleLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show clusters on map\r\n   */\r\n  showClusters() {\r\n    if (this.clusterLayer) {\r\n      this.clusterLayer.addTo(this.map);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Hide clusters from map\r\n   */\r\n  hideClusters() {\r\n    if (this.clusterLayer && this.map.hasLayer(this.clusterLayer)) {\r\n      this.map.removeLayer(this.clusterLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update clustering parameters\r\n   * @param {number} eps - Epsilon parameter\r\n   * @param {number} minPts - Minimum points parameter\r\n   */\r\n  updateClusteringParameters(eps, minPts) {\r\n    this.clusterConfig.eps = eps;\r\n    this.clusterConfig.minPts = minPts;\r\n\r\n    // Re-cluster if clustering is enabled\r\n    if (this.isClusteringEnabled) {\r\n      this.performClustering();\r\n      this.hideClusters();\r\n      this.createClusterLayer();\r\n      this.showClusters();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Toggle clustering on/off\r\n   * @param {boolean} enabled - Whether clustering should be enabled\r\n   */\r\n  toggleClustering(enabled) {\r\n    this.isClusteringEnabled = enabled;\r\n\r\n    if (enabled) {\r\n      this.performClustering();\r\n      this.createClusterLayer();\r\n      this.showClusters();\r\n    } else {\r\n      this.hideClusters();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get clustering statistics\r\n   * @returns {Object} Statistics about current clustering\r\n   */\r\n  getClusteringStatistics() {\r\n    if (!this.clusters || this.clusters.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    return this.dbscan.calculateStatistics(\r\n      this.complaintData.map((c) => ({ lat: c.lat, lng: c.lng })),\r\n      { clusters: this.clusters, noise: [] }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Clear all layers from map\r\n   */\r\n  clearAllLayers() {\r\n    this.hideHeatmap();\r\n    this.hideMarkers();\r\n    this.hideCircles();\r\n    this.hideClusters();\r\n  }\r\n\r\n  /**\r\n   * Refresh visualization with current data\r\n   */\r\n  refresh() {\r\n    this.clearAllLayers();\r\n\r\n    if (this.complaintData.length > 0) {\r\n      this.createHeatmapLayer();\r\n      this.createMarkerLayer();\r\n\r\n      if (this.isClusteringEnabled) {\r\n        this.performClustering();\r\n        this.createClusterLayer();\r\n        this.showClusters();\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Export for use in other modules\r\nif (typeof module !== \"undefined\" && module.exports) {\r\n  module.exports = HeatmapVisualization;\r\n} else {\r\n  window.HeatmapVisualization = HeatmapVisualization;\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\map\\map-generator.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\notification.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\sidebar.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\success.js","messages":[{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":108,"column":27,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":110,"endColumn":49},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":109,"column":11,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":110,"endColumn":49},{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":277,"column":13,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":277,"endColumn":27},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":282,"column":36,"nodeType":"CallExpression","messageId":"returnsValue","endLine":282,"endColumn":54,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[11417,11435],"text":"{setTimeout(r, 300)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":285,"column":15,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":285,"endColumn":29},{"ruleId":"no-unreachable","severity":2,"message":"Unreachable code.","line":438,"column":7,"nodeType":"IfStatement","messageId":"unreachableCode","endLine":452,"endColumn":15},{"ruleId":"no-unreachable","severity":2,"message":"Unreachable code.","line":453,"column":7,"nodeType":"ReturnStatement","messageId":"unreachableCode","endLine":453,"endColumn":14},{"ruleId":"no-alert","severity":1,"message":"Unexpected alert.","line":533,"column":9,"nodeType":"CallExpression","messageId":"unexpected","endLine":533,"endColumn":63},{"ruleId":"no-alert","severity":1,"message":"Unexpected alert.","line":541,"column":5,"nodeType":"CallExpression","messageId":"unexpected","endLine":541,"endColumn":53}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// IMMEDIATE LOGGING - Should run before any imports\nconsole.log(\"========================================\");\nconsole.log(\"[SUCCESS] ✅ MODULE FILE LOADED\");\nconsole.log(\"[SUCCESS] Script file loaded at:\", new Date().toISOString());\nconsole.log(\"[SUCCESS] Current URL:\", window.location.href);\nconsole.log(\"[SUCCESS] Pathname:\", window.location.pathname);\nconsole.log(\"[SUCCESS] Search:\", window.location.search);\nconsole.log(\"[SUCCESS] Hash:\", window.location.hash);\nconsole.log(\"========================================\");\n\nimport { supabase } from \"../config/config.js\";\nimport { saveUserMeta, setOAuthContext, clearOAuthContext, getOAuthContext } from \"../auth/authChecker.js\";\n\nconsole.log(\"[SUCCESS] ✅ Imports completed successfully\");\n\nconst run = async () => {\n  console.log(\"[SUCCESS] ========================================\");\n  console.log(\"[SUCCESS] Success page loaded\");\n  console.log(\"[SUCCESS] URL:\", window.location.href);\n  console.log(\"[SUCCESS] Timestamp:\", new Date().toISOString());\n\n  const urlParams = new URLSearchParams(window.location.search);\n  const isPopupFlow = urlParams.get(\"popup\") === \"1\" || Boolean(window.opener);\n  const oauthContext = getOAuthContext() || {};\n\n  console.log(\"[SUCCESS] Flow check:\", {\n    isPopupFlow,\n    hasOpener: Boolean(window.opener),\n    oauthContext,\n    localStorageOAuth: localStorage.getItem(\"cl_oauth_context\")\n  });\n\n  const notifyExistingUser = async () => {\n    try {\n      await supabase.auth.signOut();\n    } catch {}\n    try {\n      await fetch(\"/auth/session\", { method: \"DELETE\" });\n    } catch {}\n    clearOAuthContext();\n    if (window.opener) {\n      window.opener.postMessage({ type: \"oauth-user-exists\" }, window.location.origin);\n      setTimeout(() => {\n        try { window.close(); } catch {}\n      }, 200);\n    } else {\n      window.location.href = \"/login?err=user_exists\";\n    }\n  };\n  try {\n    // Check for error or success messages in URL hash\n    if (window.location.hash) {\n      const hashParams = new URLSearchParams(window.location.hash.substring(1));\n      const error = hashParams.get(\"error\");\n      const errorCode = hashParams.get(\"error_code\");\n      const errorDescription = hashParams.get(\"error_description\");\n      const message = hashParams.get(\"message\");\n      const type = hashParams.get(\"type\") || (error || errorCode ? \"error\" : \"success\");\n\n      // Import toast module\n      const { default: showMessage } = await import(\"./toast.js\");\n\n      // Handle error messages\n      if (error || errorCode) {\n        // Determine error message based on error code\n        let errorMessage = \"An error occurred\";\n        if (errorCode === \"otp_expired\") {\n          errorMessage = \"The email link has expired. Please request a new one.\";\n        } else if (errorCode === \"access_denied\") {\n          errorMessage = \"Access denied. The link may be invalid or expired.\";\n        } else if (errorDescription) {\n          // Decode URL-encoded description\n          errorMessage = decodeURIComponent(errorDescription.replace(/\\+/g, \" \"));\n        } else if (error) {\n          errorMessage = `Authentication error: ${error}`;\n        }\n\n        // Show error toast\n        showMessage(\"error\", errorMessage, 8000);\n\n        // Clean up URL hash\n        window.history.replaceState({}, document.title, window.location.pathname + window.location.search);\n\n        // Redirect to appropriate page based on error\n        if (errorCode === \"otp_expired\") {\n          // For expired OTP, redirect to login or appropriate page\n          setTimeout(() => {\n            window.location.href = \"/login\";\n          }, 3000);\n        } else {\n          // For other errors, redirect to login\n          setTimeout(() => {\n            window.location.href = \"/login\";\n          }, 3000);\n        }\n        return; // Exit early, don't process success flow\n      }\n\n      // Handle success messages\n      if (message) {\n        // Decode URL-encoded message (handle both + and %20 for spaces)\n        let decodedMessage = decodeURIComponent(message.replace(/\\+/g, \" \"));\n\n        // Clean up any trailing delimiters (pipe, semicolon, etc.)\n        decodedMessage = decodedMessage.replace(/[|;]$/, \"\").trim();\n\n        // Determine toast type (success, info, warning, error)\n        const toastType = type === \"error\" ? \"error\" :\n          type === \"warning\" ? \"warning\" :\n            type === \"info\" ? \"info\" : \"success\";\n\n        // Show success/info toast\n        showMessage(toastType, decodedMessage, 8000);\n\n        // Clean up URL hash\n        window.history.replaceState({}, document.title, window.location.pathname + window.location.search);\n\n        // Don't return here - continue with normal flow to process session\n      }\n    }\n\n    // After OAuth or email confirmation, Supabase sets a session\n    console.log(\"[SUCCESS] Checking session...\");\n\n    // CRITICAL: Check OAuth context BEFORE processing - it might be lost during redirect\n    let oauthContext = getOAuthContext() || {};\n    console.log(\"[SUCCESS] Initial OAuth context check (before session):\", oauthContext);\n    console.log(\"[SUCCESS] localStorage OAuth context:\", localStorage.getItem(\"cl_oauth_context\"));\n\n    const { data: { session }, error: sessionError } = await supabase.auth.getSession();\n    console.log(\"[SUCCESS] Session check:\", {\n      hasSession: Boolean(session),\n      hasError: Boolean(sessionError),\n      error: sessionError?.message\n    });\n\n    const user = session?.user;\n    const accessToken = session?.access_token || null;\n    const role = user?.user_metadata?.role || user?.raw_user_meta_data?.role || null;\n    const name = user?.user_metadata?.name || user?.raw_user_meta_data?.name || null;\n    const email = user?.email || null;\n\n    console.log(\"[SUCCESS] User data:\", {\n      userId: user?.id,\n      email,\n      role: role || \"missing\",\n      name: name || \"missing\",\n      hasAccessToken: Boolean(accessToken)\n    });\n\n    if (role || name) saveUserMeta({ role, name });\n    // Track provider\n    const provider = user?.identities?.[0]?.provider || null;\n    console.log(\"[SUCCESS] OAuth provider:\", provider);\n\n    if (provider) {\n      console.log(\"[SUCCESS] Updating OAuth context with provider:\", provider);\n      // Preserve existing OAuth context (especially intent) if it exists\n      const existingContext = getOAuthContext() || {};\n      const updatedContext = {\n        ...existingContext,\n        provider,\n        email: email || existingContext.email,\n        // Preserve intent if it exists, otherwise we'll infer it later\n        intent: existingContext.intent,\n        status: existingContext.status || \"pending\"\n      };\n      console.log(\"[SUCCESS] Updated OAuth context:\", updatedContext);\n      setOAuthContext(updatedContext);\n\n      // merge into oauth_providers array\n      try {\n        const currentProviders = Array.isArray(user?.user_metadata?.oauth_providers)\n          ? user.user_metadata.oauth_providers\n          : [];\n        const nextProviders = Array.from(new Set([...currentProviders, provider]));\n        await supabase.auth.updateUser({ data: { oauth_providers: nextProviders } });\n        console.log(\"[SUCCESS] Updated OAuth providers:\", nextProviders);\n      } catch (error) {\n        console.error(\"[SUCCESS] Error updating OAuth providers:\", error);\n      }\n    }\n    const userMetadata = user?.user_metadata || {};\n    const rawMetadata = user?.raw_user_meta_data || {};\n    const combinedMetadata = { ...userMetadata, ...rawMetadata };\n\n    const hasFullProfile = Boolean(\n      (combinedMetadata.mobile_number || combinedMetadata.mobile || user?.phone) &&\n      (role || combinedMetadata.role)\n    );\n\n    // Check if user has completed registration\n    const hasMobile = combinedMetadata.mobile_number ||\n                     combinedMetadata.mobile ||\n                     userMetadata.mobile ||\n                     userMetadata.phone ||\n                     userMetadata.phone_number ||\n                     user?.phone;\n    const isFullyRegistered = role && name && hasMobile;\n\n    // Re-read OAuth context after potential updates\n    oauthContext = getOAuthContext() || {};\n\n    // CRITICAL: If OAuth context is missing intent but we have a provider,\n    // we need to determine if this is a signup or login\n    // Heuristic: If user is NOT fully registered AND has OAuth provider, it's likely a signup\n    if (!oauthContext.intent && provider) {\n      if (!isFullyRegistered) {\n        // Incomplete registration + OAuth = new signup\n        console.log(\"[SUCCESS] OAuth context missing intent, inferring SIGNUP from incomplete registration\");\n        oauthContext = {\n          ...oauthContext,\n          provider: provider || oauthContext.provider,\n          email: email || oauthContext.email,\n          intent: \"signup\",\n          status: \"pending\"\n        };\n        setOAuthContext(oauthContext);\n      } else {\n        // Fully registered + OAuth = login\n        console.log(\"[SUCCESS] OAuth context missing intent, inferring LOGIN from complete registration\");\n        oauthContext = {\n          ...oauthContext,\n          provider: provider || oauthContext.provider,\n          email: email || oauthContext.email,\n          intent: \"login\",\n          status: \"completed\"\n        };\n        setOAuthContext(oauthContext);\n      }\n    }\n\n    const cameFromSignup = oauthContext.intent === \"signup\";\n\n    console.log(\"[SUCCESS] ========================================\");\n    console.log(\"[SUCCESS] FINAL DECISION POINT:\");\n    console.log(\"[SUCCESS] OAuth context:\", oauthContext);\n    console.log(\"[SUCCESS] Provider:\", provider);\n    console.log(\"[SUCCESS] isFullyRegistered:\", isFullyRegistered);\n    console.log(\"[SUCCESS] cameFromSignup:\", cameFromSignup);\n    console.log(\"[SUCCESS] Registration details:\", {\n      role: role || \"MISSING\",\n      name: name || \"MISSING\",\n      hasMobile: Boolean(hasMobile),\n      mobile: hasMobile || \"MISSING\"\n    });\n    console.log(\"[SUCCESS] ========================================\");\n\n    console.log(\"[SUCCESS] Registration status check:\", {\n      hasFullProfile,\n      cameFromSignup,\n      hasMobile: Boolean(hasMobile),\n      isFullyRegistered,\n      role: role || \"missing\",\n      name: name || \"missing\",\n      mobile: hasMobile || \"missing\"\n    });\n\n    // CRITICAL: Only set session cookie if user has completed registration\n    // For incomplete OAuth signups, NEVER set the cookie - this prevents marking as logged in\n    // IMPORTANT: OAuth login users (intent === 'login') are always fully registered and should always get session cookie\n    const isOAuthLogin = !cameFromSignup; // OAuth login has intent === 'login'\n\n    if (isFullyRegistered && accessToken) {\n      // User is fully registered - set session cookie (applies to both login and completed signup)\n      try {\n        const resp = await fetch(\"/auth/session\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ access_token: accessToken })\n        });\n        // Verify cookie by hitting a protected endpoint before redirecting\n        if (resp.ok) {\n          let ok = false;\n          try {\n            const check1 = await fetch(\"/api/user/role\", { method: \"GET\" });\n            ok = check1.ok;\n          } catch (error) {\n            console.error(\"[SUCCESS] First role check error:\", error);\n          }\n          if (!ok) {\n            await new Promise(r => setTimeout(r, 300));\n            try {\n              const check2 = await fetch(\"/api/user/role\", { method: \"GET\" });\n              ok = check2.ok;\n            } catch (error) {\n              console.error(\"[SUCCESS] Second role check error:\", error);\n            }\n          }\n          if (!ok) {\n            // If cannot verify, stay on page and let user refresh\n            return;\n          }\n        }\n      } catch (error) {\n        console.error(\"[SUCCESS] Session persistence error:\", error);\n      }\n    } else if (!isOAuthLogin && cameFromSignup) {\n      // ONLY for incomplete OAuth signups (not login), explicitly clear any existing session cookie\n      // to prevent being marked as logged in\n      // OAuth login users are always fully registered, so this branch never executes for them\n      // CRITICAL: DO NOT clear Supabase session - we need it for the continuation page!\n      // Only clear the server-side cookie to prevent being marked as logged in\n      console.log(\"[SUCCESS] Clearing server-side session cookie (but keeping Supabase session for continuation)\");\n      try {\n        await fetch(\"/auth/session\", { method: \"DELETE\" });\n        console.log(\"[SUCCESS] Server session cookie cleared\");\n      } catch (error) {\n        console.warn(\"[SUCCESS] Error clearing server session cookie:\", error);\n        // Silently fail - cookie might not exist\n      }\n\n      // DO NOT sign out from Supabase - we need the session for the continuation page!\n      // The continuation page will validate the session and complete the registration\n      console.log(\"[SUCCESS] Keeping Supabase session for OAuth continuation page\");\n    }\n    // If isOAuthLogin but !isFullyRegistered, this is an edge case (shouldn't happen)\n    // But we don't clear session to be safe - let the user proceed\n\n    // Check if user already exists (has full profile but came from signup)\n    if (cameFromSignup && hasFullProfile) {\n      await notifyExistingUser();\n      return;\n    }\n\n    // For incomplete OAuth signups, set context to 'handoff' (not 'pending')\n    // This allows continuation page to load but prevents auth checks\n    console.log(\"[SUCCESS] Final OAuth context decision...\");\n    console.log(\"[SUCCESS] Context decision:\", {\n      cameFromSignup,\n      isFullyRegistered,\n      hasProvider: Boolean(provider),\n      willSetContext: cameFromSignup && !isFullyRegistered && provider\n    });\n\n    if (cameFromSignup && !isFullyRegistered && provider) {\n      const newContext = {\n        provider,\n        email: email || oauthContext.email,\n        intent: \"signup\",\n        status: \"handoff\", // Changed from 'pending' to allow continuation page\n        startedAt: oauthContext.startedAt || Date.now()\n      };\n      console.log(\"[SUCCESS] ✅ Setting OAuth context to handoff:\", newContext);\n      setOAuthContext(newContext);\n      console.log(\"[SUCCESS] OAuth context after setting:\", getOAuthContext());\n    } else if (isFullyRegistered) {\n      console.log(\"[SUCCESS] User fully registered, clearing OAuth context\");\n      clearOAuthContext();\n    } else {\n      console.log(\"[SUCCESS] Keeping existing OAuth context:\", oauthContext);\n    }\n\n    if (isPopupFlow) {\n      console.log(\"[SUCCESS] 🔵 POPUP FLOW DETECTED\");\n      console.log(\"[SUCCESS] Popup flow - checking registration status...\");\n      console.log(\"[SUCCESS] isFullyRegistered:\", isFullyRegistered);\n      console.log(\"[SUCCESS] cameFromSignup:\", cameFromSignup);\n\n      const identityData = user?.identities?.[0]?.identity_data || {};\n      const userMeta = user?.user_metadata || {};\n      const rawMeta = user?.raw_user_meta_data || {};\n      const combined = {\n        ...rawMeta,\n        ...userMeta,\n        ...identityData\n      };\n      const fullName = combined.full_name || combined.name || \"\";\n      const splitName = fullName ? fullName.trim().split(\" \") : [];\n      const firstName = combined.given_name || combined.first_name || splitName[0] || \"\";\n      const lastName = combined.family_name || combined.last_name || splitName.slice(1).join(\" \") || \"\";\n      const middleName = combined.middle_name || splitName.slice(1, -1).join(\" \") || \"\";\n      const payload = { provider, email, firstName, middleName, lastName };\n\n      // CRITICAL: Always send message for OAuth signups (both complete and incomplete)\n      // The signup page will handle the redirect\n      console.log(\"[SUCCESS] 🔵 Sending message to opener window\");\n      console.log(\"[SUCCESS] Registration status:\", {\n        isFullyRegistered,\n        role: role || \"missing\",\n        name: name || \"missing\",\n        hasMobile: Boolean(hasMobile)\n      });\n\n      if (window.opener) {\n        try {\n          // CRITICAL: Get the session token to pass to main window\n          // Supabase stores sessions in localStorage which is window-specific\n          // We need to pass the token so main window can set it\n          const { data: { session: currentSession } } = await supabase.auth.getSession();\n          const accessToken = currentSession?.access_token;\n          const refreshToken = currentSession?.refresh_token;\n\n          console.log(\"[SUCCESS] Session token available:\", Boolean(accessToken));\n\n          // Always send message with redirectTo for OAuth signups\n          // If incomplete, mark it explicitly\n          const message = {\n            type: \"oauth-signup-success\",\n            payload,\n            redirectTo: \"/oauth-continuation\",\n            incomplete: !isFullyRegistered,\n            // CRITICAL: Pass session tokens so main window can set them\n            accessToken,\n            refreshToken\n          };\n          console.log(\"[SUCCESS] Sending message to opener:\", JSON.stringify({\n            ...message,\n            accessToken: accessToken ? \"***\" : null,\n            refreshToken: refreshToken ? \"***\" : null\n          }, null, 2));\n          window.opener.postMessage(message, window.location.origin);\n          console.log(\"[SUCCESS] ✅ Message sent to opener\");\n\n          // Wait a bit to ensure message is received, then close\n          setTimeout(() => {\n            try {\n              console.log(\"[SUCCESS] Closing popup...\");\n              window.close();\n            } catch (closeError) {\n              console.warn(\"[SUCCESS] Could not close popup:\", closeError);\n              // If popup can't close, redirect in popup itself\n              window.location.href = \"/oauth-continuation\";\n            }\n          }, 800); // Increased delay to ensure message is received and processed\n        } catch (postError) {\n          console.error(\"[SUCCESS] ❌ Failed to notify opener:\", postError);\n          // Fallback: redirect in popup\n          window.location.href = \"/oauth-continuation\";\n        }\n      } else {\n        console.warn(\"[SUCCESS] No opener window found, redirecting in popup...\");\n        window.location.href = \"/oauth-continuation\";\n      }\n      return;\n\n      // Fully registered - normal popup flow\n      if (window.opener) {\n        try {\n          window.opener.postMessage({ type: \"oauth-signup-success\", payload }, window.location.origin);\n        } catch (postError) {\n          console.error(\"[SUCCESS] Failed to notify opener:\", postError);\n        }\n      }\n      setTimeout(() => {\n        try {\n          window.close();\n        } catch {\n          // If popup can't close, redirect to continuation\n          window.location.href = \"/oauth-continuation\";\n        }\n      }, 200);\n      return;\n    }\n\n    // Redirect based on registration status\n    console.log(\"[SUCCESS] Determining redirect destination...\");\n    console.log(\"[SUCCESS] Redirect check:\", {\n      hasProvider: Boolean(provider),\n      isFullyRegistered,\n      cameFromSignup,\n      provider\n    });\n\n    // CRITICAL: Redirect logic - must check all conditions\n    // If user has OAuth provider but is NOT fully registered, they need to complete signup\n    // Even if cameFromSignup is false (context lost), we should still redirect if incomplete\n    // SIMPLIFIED: If provider exists and user is incomplete, redirect (regardless of context)\n    const shouldRedirectToContinuation = provider && !isFullyRegistered;\n\n    console.log(\"[SUCCESS] ========================================\");\n    console.log(\"[SUCCESS] REDIRECT DECISION:\");\n    console.log(\"[SUCCESS] shouldRedirectToContinuation:\", shouldRedirectToContinuation);\n    console.log(\"[SUCCESS] Conditions:\", {\n      hasProvider: Boolean(provider),\n      notFullyRegistered: !isFullyRegistered,\n      cameFromSignup,\n      // Fallback: if incomplete and has provider, assume signup\n      fallbackCheck: !isFullyRegistered && Boolean(provider)\n    });\n    console.log(\"[SUCCESS] ========================================\");\n\n    if (shouldRedirectToContinuation) {\n      // Incomplete OAuth signup - redirect to continuation\n      console.log(\"[SUCCESS] ✅ REDIRECTING TO OAUTH CONTINUATION\");\n      const finalContext = getOAuthContext();\n      console.log(\"[SUCCESS] OAuth context before redirect:\", finalContext);\n      console.log(\"[SUCCESS] Session exists:\", Boolean(session));\n      console.log(\"[SUCCESS] About to set window.location.href...\");\n\n      // Force redirect immediately (no setTimeout)\n      console.log(\"[SUCCESS] EXECUTING REDIRECT NOW...\");\n      window.location.href = \"/oauth-continuation\";\n      // Add a fallback in case redirect fails\n      setTimeout(() => {\n        if (window.location.pathname !== \"/oauth-continuation\") {\n          console.error(\"[SUCCESS] Redirect failed! Trying again...\");\n          window.location.replace(\"/oauth-continuation\");\n        }\n      }, 500);\n      // Exit early to prevent any other redirects\n    } else if (isFullyRegistered) {\n      // Complete registration - redirect to dashboard\n      console.log(\"[SUCCESS] ✅ Redirecting to dashboard (fully registered)\");\n      clearOAuthContext();\n      window.location.href = \"/dashboard\";\n    } else {\n      // Fallback - should not happen\n      console.log(\"[SUCCESS] ⚠️ Fallback redirect to login\");\n      clearOAuthContext();\n      window.location.href = \"/login\";\n    }\n  } catch (error) {\n    console.error(\"[SUCCESS] Main error:\", error);\n    console.error(\"[SUCCESS] Error stack:\", error.stack);\n    // Fallback: redirect to dashboard anyway\n    window.location.href = \"/dashboard\";\n  }\n};\n\nconsole.log(\"[SUCCESS] About to call run() function\");\nconsole.log(\"[SUCCESS] run function type:\", typeof run);\n\n// Wrap in try-catch with detailed error logging\ntry {\n  const result = run();\n  if (result && typeof result.then === \"function\") {\n    // It's a promise\n    result.catch((error) => {\n      console.error(\"[SUCCESS] ❌ Promise rejection in run():\", error);\n      console.error(\"[SUCCESS] Error stack:\", error.stack);\n      if (window.location.search.includes(\"debug\")) {\n        alert(`ERROR in success.js run(): ${  error.message}`);\n      }\n    });\n  }\n} catch (error) {\n  console.error(\"[SUCCESS] ❌ Error calling run():\", error);\n  console.error(\"[SUCCESS] Error stack:\", error.stack);\n  if (window.location.search.includes(\"debug\")) {\n    alert(`ERROR calling run(): ${  error.message}`);\n  }\n}\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\components\\toast.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\config\\apiClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\config\\brand.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\config\\config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\config\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\coordinator\\dashboard.js","messages":[{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":277,"column":3,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":281,"endColumn":13},{"ruleId":"no-alert","severity":1,"message":"Unexpected alert.","line":535,"column":5,"nodeType":"CallExpression","messageId":"unexpected","endLine":535,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Coordinator Dashboard JavaScript\r\n * Handles API calls and dashboard functionality\r\n */\r\nclass CoordinatorDashboard {\r\n  constructor() {\r\n    this.statsInterval = null;\r\n    this.queueInterval = null;\r\n    this.activityInterval = null;\r\n    this.init();\r\n  }\r\n\r\n  async init() {\r\n    try {\r\n      await this.checkCoordinatorStatus();\r\n      await this.loadDashboardData();\r\n      this.setupEventListeners();\r\n      this.startAutoRefresh();\r\n    } catch (error) {\r\n      // Continue with basic functionality even if initialization fails\r\n      this.setupEventListeners();\r\n      this.setDefaultStats();\r\n    }\r\n  }\r\n\r\n  async checkCoordinatorStatus() {\r\n    try {\r\n      const response = await fetch(\"/api/coordinator/status\");\r\n      if (!response.ok) {\r\n        return;\r\n      }\r\n      const result = await response.json();\r\n      if (!result.success) {\r\n        // Error handled by caller\r\n      }\r\n    } catch (error) {\r\n      // Silently catch error\r\n    }\r\n  }\r\n\r\n  async loadDashboardData() {\r\n    try {\r\n      // Load dashboard statistics\r\n      await this.loadStats();\r\n      // Load recent review queue (only 5 complaints)\r\n      await this.loadRecentQueue();\r\n      // Load recent activity\r\n      await this.loadActivity();\r\n      // Fallback: Update stats with default values if API fails\r\n      setTimeout(() => {\r\n        this.updateStatCard(\"stat-pending\", 0);\r\n        this.updateStatCard(\"stat-reviews\", 0);\r\n        this.updateStatCard(\"stat-duplicates\", 0);\r\n        this.updateStatCard(\"stat-assignments\", 0);\r\n      }, 5000);\r\n    } catch (error) {\r\n      console.error(\r\n        \"[COORDINATOR DASHBOARD] Failed to load dashboard data:\",\r\n        error\r\n      );\r\n    }\r\n  }\r\n\r\n  async loadStats() {\r\n    try {\r\n      // Check if we're authenticated first\r\n      const authResponse = await fetch(\"/api/coordinator/status\");\r\n      if (!authResponse.ok) {\r\n        this.setDefaultStats();\r\n        return;\r\n      }\r\n      const response = await fetch(\"/api/coordinator/dashboard\");\r\n      if (!response.ok) {\r\n        this.setDefaultStats();\r\n        return;\r\n      }\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        const { data } = result;\r\n        // Update statistics cards only - don't update queue or clusters here\r\n        // Queue and clusters are handled by separate methods to avoid conflicts\r\n        this.updateStatCard(\"stat-pending\", data.pending_reviews || 0);\r\n        this.updateStatCard(\"stat-reviews\", data.stats?.total_reviews || 0);\r\n        this.updateStatCard(\r\n          \"stat-duplicates\",\r\n          data.stats?.duplicates_merged || 0\r\n        );\r\n        this.updateStatCard(\r\n          \"stat-assignments\",\r\n          data.stats?.assignments_made || 0\r\n        );\r\n      } else {\r\n        this.setDefaultStats();\r\n      }\r\n    } catch (error) {\r\n      this.setDefaultStats();\r\n    }\r\n  }\r\n\r\n  setDefaultStats() {\r\n    this.updateStatCard(\"stat-pending\", 0);\r\n    this.updateStatCard(\"stat-reviews\", 0);\r\n    this.updateStatCard(\"stat-duplicates\", 0);\r\n    this.updateStatCard(\"stat-assignments\", 0);\r\n  }\r\n\r\n  async loadRecentQueue() {\r\n    try {\r\n      const response = await fetch(\"/api/coordinator/review-queue?limit=5\");\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        this.updateRecentQueuePreview(result.data);\r\n      } else {\r\n        this.updateRecentQueuePreview([]);\r\n      }\r\n    } catch (error) {\r\n      this.updateRecentQueuePreview([]);\r\n    }\r\n  }\r\n\r\n  async loadActivity() {\r\n    try {\r\n      const response = await fetch(\"/api/coordinator/dashboard\");\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        // Get recent activity from dashboard data or generate from stats\r\n        const activities = this.generateActivityFromStats(result.data);\r\n        this.updateActivityPreview(activities);\r\n      } else {\r\n        this.updateActivityPreview([]);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR DASHBOARD] Failed to load activity:\", error);\r\n      this.updateActivityPreview([]);\r\n    }\r\n  }\r\n\r\n  generateActivityFromStats(data) {\r\n    const activities = [];\r\n    const _now = new Date();\r\n\r\n    // Add activity for pending reviews\r\n    if (data.pending_reviews > 0) {\r\n      activities.push({\r\n        icon: \"⏰\",\r\n        text: `${data.pending_reviews} complaint${\r\n          data.pending_reviews !== 1 ? \"s\" : \"\"\r\n        } pending review`,\r\n        time: \"Just now\",\r\n        type: \"pending\",\r\n      });\r\n    }\r\n\r\n    // Add activity for recent reviews\r\n    if (data.stats?.total_reviews > 0) {\r\n      activities.push({\r\n        icon: \"📊\",\r\n        text: `${data.stats.total_reviews} review${\r\n          data.stats.total_reviews !== 1 ? \"s\" : \"\"\r\n        } completed in last 7 days`,\r\n        time: \"This week\",\r\n        type: \"review\",\r\n      });\r\n    }\r\n\r\n    // Add activity for assignments\r\n    if (data.stats?.assignments_made > 0) {\r\n      activities.push({\r\n        icon: \"📤\",\r\n        text: `${data.stats.assignments_made} assignment${\r\n          data.stats.assignments_made !== 1 ? \"s\" : \"\"\r\n        } made this week`,\r\n        time: \"This week\",\r\n        type: \"assignment\",\r\n      });\r\n    }\r\n\r\n    // Add activity for duplicates merged\r\n    if (data.stats?.duplicates_merged > 0) {\r\n      activities.push({\r\n        icon: \"🔗\",\r\n        text: `${data.stats.duplicates_merged} duplicate${\r\n          data.stats.duplicates_merged !== 1 ? \"s\" : \"\"\r\n        } merged this week`,\r\n        time: \"This week\",\r\n        type: \"duplicate\",\r\n      });\r\n    }\r\n\r\n    // If no activities, add a default message\r\n    if (activities.length === 0) {\r\n      activities.push({\r\n        icon: \"📋\",\r\n        text: \"No recent activity\",\r\n        time: \"—\",\r\n        type: \"empty\",\r\n      });\r\n    }\r\n\r\n    return activities.slice(0, 5); // Limit to 5 most recent\r\n  }\r\n\r\n  updateActivityPreview(activities) {\r\n    const container = document.getElementById(\"activity-container\");\r\n    if (!container) return;\r\n\r\n    if (!activities || activities.length === 0) {\r\n      container.innerHTML = `\r\n        <div class=\"activity-list\">\r\n          <div class=\"no-data\">\r\n            <div class=\"no-data-icon\">🕒</div>\r\n            <div class=\"no-data-text\">No recent activity</div>\r\n            <div class=\"no-data-subtext\">Activity will appear here</div>\r\n          </div>\r\n        </div>\r\n      `;\r\n      return;\r\n    }\r\n\r\n    const activitiesList = activities\r\n      .map(\r\n        (activity) => `\r\n      <div class=\"activity-item\" data-type=\"${activity.type}\">\r\n        <div class=\"activity-icon\">${activity.icon}</div>\r\n        <div class=\"activity-content\">\r\n          <div class=\"activity-text\">${activity.text}</div>\r\n          <div class=\"activity-time\">${activity.time}</div>\r\n        </div>\r\n      </div>\r\n    `\r\n      )\r\n      .join(\"\");\r\n\r\n    container.innerHTML = `\r\n      <div class=\"activity-list\">\r\n        ${activitiesList}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  updateStatCard(elementId, value) {\r\n    const element = document.getElementById(elementId);\r\n    if (element) {\r\n      element.textContent = value;\r\n      element.classList.add(\"loaded\");\r\n    } else {\r\n      console.error(\r\n        `[COORDINATOR DASHBOARD] Element ${elementId} not found in DOM`\r\n      );\r\n    }\r\n  }\r\n\r\n  updateRecentQueuePreview(complaints) {\r\n    const container = document.getElementById(\"review-queue-container\");\r\n    if (!container) {\r\n      console.warn(\"[COORDINATOR DASHBOARD] review-queue-container not found\");\r\n      return;\r\n    }\r\n    if (!complaints || complaints.length === 0) {\r\n      container.innerHTML = `\r\n                <div class=\"no-data\">\r\n                    <div class=\"no-data-icon\">📋</div>\r\n                    <div class=\"no-data-text\">No complaints in review queue</div>\r\n                    <div class=\"no-data-subtext\">New complaints will appear here</div>\r\n                </div>\r\n            `;\r\n      return;\r\n    }\r\n    // Always limit to 5 complaints for preview\r\n    const displayedComplaints = complaints.slice(0, 5);\r\n    const complaintsList = displayedComplaints\r\n      .map(\r\n        (complaint) => `\r\n            <div class=\"queue-item\">\r\n                <div class=\"queue-item-icon\">\r\n                    ${\r\n  complaint.priority === \"urgent\"\r\n    ? \"🚨\"\r\n    : complaint.priority === \"high\"\r\n      ? \"⚠️\"\r\n      : \"📋\"\r\n}\r\n                </div>\r\n                <div class=\"queue-item-content\">\r\n                    <div class=\"queue-item-title\">${complaint.title}</div>\r\n                    <div class=\"queue-item-details\">\r\n                        <span class=\"priority-${\r\n  complaint.urgency_level || \"medium\"\r\n} urgency-badge\">${\r\n  complaint.urgency_level || \"medium\"\r\n}</span>\r\n                        <span class=\"separator\">•</span>\r\n                        <span class=\"category\">${\r\n  complaint.category || \"General\"\r\n}</span>\r\n                        ${\r\n  complaint.submitted_by_profile\r\n    ? `<span class=\"separator\">•</span>\r\n                             <span class=\"submitter\">${\r\n  complaint.submitted_by_profile.name || \"Unknown\"\r\n}</span>`\r\n    : \"\"\r\n}\r\n                    </div>\r\n                </div>\r\n                <div class=\"queue-item-actions\">\r\n                    <button class=\"btn btn-sm btn-secondary js-quick-action-btn\" data-complaint-id=\"${\r\n  complaint.id\r\n}\" data-citizen-urgency=\"${\r\n  complaint.urgency_level || \"medium\"\r\n}\">\r\n                        ⚡ Quick\r\n                    </button>\r\n                    <button class=\"btn btn-sm btn-primary js-review-btn\" data-complaint-id=\"${\r\n  complaint.id\r\n}\">\r\n                        Review\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        `\r\n      )\r\n      .join(\"\");\r\n\r\n    container.innerHTML = `\r\n            <div class=\"queue-header\">\r\n                <h3>Recent Complaints (${displayedComplaints.length})</h3>\r\n                <button class=\"btn btn-secondary btn-sm\" id=\"js-view-all-queue\">\r\n                    View All\r\n                </button>\r\n            </div>\r\n            <div class=\"queue-items\">\r\n                ${complaintsList}\r\n            </div>\r\n        `;\r\n\r\n    // Attach event listeners instead of inline handlers (CSP compliant)\r\n    const reviewButtons = container.querySelectorAll(\".js-review-btn\");\r\n    reviewButtons.forEach((btn) => {\r\n      const id = btn.getAttribute(\"data-complaint-id\");\r\n      btn.addEventListener(\"click\", () => {\r\n        if (id) window.location.href = `/coordinator/review/${id}`;\r\n      });\r\n    });\r\n\r\n    const viewAllBtn = container.querySelector(\"#js-view-all-queue\");\r\n    if (viewAllBtn) {\r\n      viewAllBtn.addEventListener(\"click\", () => {\r\n        window.location.href = \"/coordinator/review-queue\";\r\n      });\r\n    }\r\n\r\n    // Attach event listeners to Quick Action buttons\r\n    const quickActionBtns = container.querySelectorAll(\".js-quick-action-btn\");\r\n    quickActionBtns.forEach((btn) => {\r\n      btn.addEventListener(\"click\", (e) => {\r\n        e.stopPropagation();\r\n        const id = btn.dataset.complaintId;\r\n        const {citizenUrgency} = btn.dataset;\r\n        this.openQuickActionModal(id, citizenUrgency);\r\n      });\r\n    });\r\n  }\r\n\r\n  setupEventListeners() {\r\n    // Quick action buttons\r\n    const reviewQueueBtn = document.getElementById(\"review-queue-btn\");\r\n    if (reviewQueueBtn) {\r\n      reviewQueueBtn.addEventListener(\"click\", () => {\r\n        window.location.href = \"/review-queue\";\r\n      });\r\n    }\r\n\r\n    const bulkAssignBtn = document.getElementById(\"bulk-assign-btn\");\r\n    if (bulkAssignBtn) {\r\n      bulkAssignBtn.addEventListener(\"click\", () =>\r\n        this.bulkAssignComplaints()\r\n      );\r\n    }\r\n\r\n    const generateReportBtn = document.getElementById(\"generate-report-btn\");\r\n    if (generateReportBtn) {\r\n      generateReportBtn.addEventListener(\"click\", () => this.generateReport());\r\n    }\r\n\r\n    const manageDepartmentsBtn = document.getElementById(\r\n      \"manage-departments-btn\"\r\n    );\r\n    if (manageDepartmentsBtn) {\r\n      manageDepartmentsBtn.addEventListener(\"click\", () =>\r\n        this.manageDepartments()\r\n      );\r\n    }\r\n\r\n    const viewFullQueueBtn = document.getElementById(\"view-full-queue-btn\");\r\n    if (viewFullQueueBtn) {\r\n      viewFullQueueBtn.addEventListener(\"click\", () => {\r\n        window.location.href = \"/review-queue\";\r\n      });\r\n    }\r\n\r\n    const refreshActivityBtn = document.getElementById(\"refresh-activity-btn\");\r\n    if (refreshActivityBtn) {\r\n      refreshActivityBtn.addEventListener(\"click\", () => this.loadActivity());\r\n    }\r\n\r\n    // Queue filter selector\r\n    const queueFilter = document.getElementById(\"queue-filter\");\r\n    if (queueFilter) {\r\n      queueFilter.addEventListener(\"change\", (e) => {\r\n        this.filterQueue(e.target.value);\r\n      });\r\n    }\r\n\r\n    // Modal listeners\r\n    const closeModalBtn = document.getElementById(\"close-modal-btn\");\r\n    if (closeModalBtn) {\r\n      closeModalBtn.addEventListener(\"click\", () =>\r\n        this.closeQuickActionModal()\r\n      );\r\n    }\r\n\r\n    const quickActionForm = document.getElementById(\"quick-action-form\");\r\n    if (quickActionForm) {\r\n      quickActionForm.addEventListener(\"submit\", (e) =>\r\n        this.handleQuickActionSubmit(e)\r\n      );\r\n    }\r\n  }\r\n\r\n  async openQuickActionModal(complaintId, citizenUrgency = \"medium\") {\r\n    const modal = document.getElementById(\"quick-action-modal\");\r\n    const idInput = document.getElementById(\"modal-complaint-id\");\r\n    const urgencyDisplay = document.getElementById(\"modal-citizen-urgency\");\r\n    if (!modal || !idInput) return;\r\n\r\n    idInput.value = complaintId;\r\n    if (urgencyDisplay) {\r\n      urgencyDisplay.textContent = citizenUrgency;\r\n      urgencyDisplay.className = `text-lg font-bold capitalize priority-${citizenUrgency}`;\r\n    }\r\n    modal.classList.remove(\"hidden\");\r\n\r\n    // Load departments/officers if not already loaded\r\n    await this.loadAssignmentTargets();\r\n  }\r\n\r\n  closeQuickActionModal() {\r\n    const modal = document.getElementById(\"quick-action-modal\");\r\n    if (modal) modal.classList.add(\"hidden\");\r\n  }\r\n\r\n  async loadAssignmentTargets() {\r\n    const select = document.getElementById(\"modal-assignment\");\r\n    if (!select || select.options.length > 1) return;\r\n\r\n    try {\r\n      const response = await fetch(\"/api/departments\");\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        result.data.forEach((dept) => {\r\n          const option = document.createElement(\"option\");\r\n          option.value = dept.code;\r\n          option.textContent = dept.name;\r\n          select.appendChild(option);\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to load departments:\", error);\r\n    }\r\n  }\r\n\r\n  async handleQuickActionSubmit(e) {\r\n    e.preventDefault();\r\n    const id = document.getElementById(\"modal-complaint-id\").value;\r\n    const category = document.getElementById(\"modal-category\").value;\r\n    const urgency = document.querySelector(\r\n      'input[name=\"urgency\"]:checked'\r\n    ).value;\r\n    const department = document.getElementById(\"modal-assignment\").value;\r\n    const deadline = document.getElementById(\"modal-deadline\").value;\r\n    const remarks = document.getElementById(\"modal-remarks\").value;\r\n\r\n    try {\r\n      // 1. Update Classification & Priority\r\n      const updateResponse = await fetch(`/api/complaints/${id}/status`, {\r\n        method: \"PATCH\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ category, priority: urgency, notes: remarks }),\r\n      });\r\n\r\n      // 2. Assign to Department\r\n      const assignResponse = await fetch(\r\n        `/api/complaints/${id}/assign-coordinator`,\r\n        {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({ coordinator_id: department, deadline }), // Assuming coordinator_id can be a dept code for routing\r\n        }\r\n      );\r\n\r\n      if (updateResponse.ok && assignResponse.ok) {\r\n        if (window.showMessage) {\r\n          window.showMessage(\"success\", \"Complaint classified and assigned!\");\r\n        } else {\r\n          const { default: showMsg } = await import(\"../components/toast.js\");\r\n          showMsg(\"success\", \"Complaint classified and assigned!\");\r\n        }\r\n        this.closeQuickActionModal();\r\n        this.loadDashboardData();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Quick action failed:\", error);\r\n    }\r\n  }\r\n\r\n  async bulkAssignComplaints() {\r\n    // Implementation for bulk assignment\r\n    // This would open a modal or redirect to bulk assign page\r\n    window.location.href = \"/coordinator/review-queue?bulk=true\";\r\n  }\r\n\r\n  async generateReport() {\r\n    // Implementation for report generation\r\n    window.location.href = \"/coordinator/review-queue?report=true\";\r\n  }\r\n\r\n  async manageDepartments() {\r\n    // Implementation for department management\r\n    window.location.href = \"/departments\";\r\n  }\r\n\r\n  async getHelp() {\r\n    // Implementation for help\r\n    alert(\"Help documentation coming soon!\");\r\n  }\r\n\r\n  async filterQueue(_filter) {\r\n    // Implementation for queue filtering\r\n    await this.loadRecentQueue();\r\n  }\r\n\r\n  startAutoRefresh() {\r\n    // Refresh stats every 30 seconds\r\n    this.statsInterval = setInterval(() => {\r\n      this.loadStats();\r\n    }, 30000);\r\n    // Refresh queue every 60 seconds\r\n    this.queueInterval = setInterval(() => {\r\n      this.loadRecentQueue();\r\n    }, 60000);\r\n    // Refresh activity every 60 seconds\r\n    this.activityInterval = setInterval(() => {\r\n      this.loadActivity();\r\n    }, 60000);\r\n  }\r\n\r\n  destroy() {\r\n    if (this.statsInterval) {\r\n      clearInterval(this.statsInterval);\r\n    }\r\n    if (this.queueInterval) {\r\n      clearInterval(this.queueInterval);\r\n    }\r\n    if (this.activityInterval) {\r\n      clearInterval(this.activityInterval);\r\n    }\r\n  }\r\n}\r\n// Global functions for quick actions\r\nasync function _bulkAssignComplaints() {\r\n  window.coordinatorDashboard?.bulkAssignComplaints();\r\n}\r\n\r\nasync function _refreshActivity() {\r\n  window.coordinatorDashboard?.loadRecentQueue();\r\n}\r\n// Manual test function for debugging\r\nasync function testCoordinatorStats() {\r\n  try {\r\n    // Test authentication\r\n    const _authResponse = await fetch(\"/api/coordinator/status\");\r\n    // Test dashboard API\r\n    const dashboardResponse = await fetch(\"/api/coordinator/dashboard\");\r\n    const dashboardData = await dashboardResponse.json();\r\n    // Manually update stats\r\n    if (dashboardData.success) {\r\n      const { data } = dashboardData;\r\n      const updateStatCard = (id, value) => {\r\n        const element = document.getElementById(id);\r\n        if (element) {\r\n          element.textContent = value;\r\n          element.classList.add(\"loaded\");\r\n        } else {\r\n          console.error(`[COORDINATOR TEST] Element ${id} not found`);\r\n        }\r\n      };\r\n      updateStatCard(\"stat-pending\", data.pending_reviews || 0);\r\n      updateStatCard(\"stat-reviews\", data.stats?.total_reviews || 0);\r\n      updateStatCard(\"stat-duplicates\", data.stats?.duplicates_merged || 0);\r\n      updateStatCard(\"stat-assignments\", data.stats?.assignments_made || 0);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[COORDINATOR TEST] Manual test failed:\", error);\r\n  }\r\n}\r\n// Make test function globally available\r\nwindow.testCoordinatorStats = testCoordinatorStats;\r\n// Initialize when DOM is ready\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  // Check if required elements exist\r\n  const requiredElements = [\r\n    \"stat-pending\",\r\n    \"stat-reviews\",\r\n    \"review-queue-container\",\r\n  ];\r\n  requiredElements.forEach((id) => {\r\n    const _element = document.getElementById(id);\r\n  });\r\n  // Immediate fallback: Set stats to 0 so user sees dashboard is working\r\n  setTimeout(() => {\r\n    const fallbackUpdate = (id, value) => {\r\n      const element = document.getElementById(id);\r\n      if (element) {\r\n        element.textContent = value;\r\n        element.classList.add(\"loaded\");\r\n      }\r\n    };\r\n    fallbackUpdate(\"stat-pending\", \"0\");\r\n    fallbackUpdate(\"stat-reviews\", \"0\");\r\n    fallbackUpdate(\"stat-duplicates\", \"0\");\r\n    fallbackUpdate(\"stat-assignments\", \"0\");\r\n  }, 1000);\r\n  try {\r\n    window.coordinatorDashboard = new CoordinatorDashboard();\r\n  } catch (error) {\r\n    // Continue with basic stats display even if dashboard fails\r\n    setTimeout(() => {\r\n      const fallbackUpdate = (id, value) => {\r\n        const element = document.getElementById(id);\r\n        if (element) {\r\n          element.textContent = value;\r\n          element.classList.add(\"loaded\");\r\n        }\r\n      };\r\n      fallbackUpdate(\"stat-pending\", \"0\");\r\n      fallbackUpdate(\"stat-reviews\", \"0\");\r\n      fallbackUpdate(\"stat-duplicates\", \"0\");\r\n      fallbackUpdate(\"stat-assignments\", \"0\");\r\n    }, 2000);\r\n  }\r\n});\r\n// Clean up on page unload\r\nwindow.addEventListener(\"beforeunload\", () => {\r\n  if (window.coordinatorDashboard) {\r\n    window.coordinatorDashboard.destroy();\r\n  }\r\n});\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\coordinator\\department-selection-modal.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected alert.","line":132,"column":7,"nodeType":"CallExpression","messageId":"unexpected","endLine":132,"endColumn":49},{"ruleId":"no-alert","severity":1,"message":"Unexpected alert.","line":174,"column":7,"nodeType":"CallExpression","messageId":"unexpected","endLine":174,"endColumn":63}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Office Selection Modal for Coordinator Approval\nclass DepartmentSelectionModal {\n\n  constructor() {\n    this.modal = null;\n    this.selectedDepartments = [];\n    this.preferredDepartments = [];\n    this.complaintId = null;\n    this.callback = null;\n  }\n  async show(complaintId, preferredDepartments = [], callback) {\n    this.complaintId = complaintId;\n    this.preferredDepartments = preferredDepartments || [];\n    this.callback = callback;\n    this.selectedDepartments = [...this.preferredDepartments]; // Pre-select preferred\n    await this.createModal();\n    this.attachEventListeners();\n    this.modal.style.display = \"flex\";\n  }\n  async createModal() {\n    // Remove existing modal if any\n    if (this.modal) {\n      this.modal.remove();\n    }\n    // Get departments from API\n    const departments = await this.fetchDepartments();\n    this.modal = document.createElement(\"div\");\n    this.modal.className = \"modal-overlay\";\n    this.modal.innerHTML = `\n      <div class=\"modal-content department-selection-modal\">\n        <div class=\"modal-header\">\n          <h3>Approve Complaint & Assign Offices</h3>\n          <button class=\"modal-close\" type=\"button\">&times;</button>\n        </div>\n        <div class=\"modal-body\">\n          <p>Select the office(s) to assign this complaint to:</p>\n          <div class=\"department-list\">\n            ${departments.map(dept => `\n              <label class=\"department-item ${this.preferredDepartments.includes(dept.code) ? \"preferred\" : \"\"}\">\n                <input type=\"checkbox\" \n                       value=\"${dept.code}\" \n                       ${this.selectedDepartments.includes(dept.code) ? \"checked\" : \"\"}\n                       class=\"department-checkbox\">\n                <div class=\"department-info\">\n                  <div class=\"department-name\">${dept.name}</div>\n                  <div class=\"department-code\">${dept.code}</div>\n                  ${this.preferredDepartments.includes(dept.code) ? '<span class=\"preferred-badge\">Citizen Preferred</span>' : \"\"}\n                </div>\n              </label>\n            `).join(\"\")}\n          </div>\n          <div class=\"selected-summary\">\n            <strong>Selected: <span id=\"selected-count\">${this.selectedDepartments.length}</span> office(s)</strong>\n          </div>\n        </div>\n        <div class=\"modal-footer\">\n          <button type=\"button\" class=\"btn btn-secondary\" id=\"cancel-approval\">Cancel</button>\n          <button type=\"button\" class=\"btn btn-primary\" id=\"confirm-approval\" disabled>\n            Approve & Assign\n          </button>\n        </div>\n      </div>\n    `;\n\n    document.body.appendChild(this.modal);\n    this.updateSelectedCount();\n  }\n\n  async fetchDepartments() {\n    try {\n      const response = await fetch(\"/api/departments\", {\n        method: \"GET\",\n        headers: {\n          \"Content-Type\": \"application/json\"\n        },\n        credentials: \"include\"\n      });\n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n      const data = await response.json();\n      return data.data || data.departments || [];\n    } catch (error) {\n      console.error(\"Error fetching departments:\", error);\n      return [];\n    }\n  }\n  attachEventListeners() {\n    // Close modal\n    this.modal.querySelector(\".modal-close\").addEventListener(\"click\", () => this.hide());\n    this.modal.querySelector(\"#cancel-approval\").addEventListener(\"click\", () => this.hide());\n    // Close on overlay click\n    this.modal.addEventListener(\"click\", (e) => {\n      if (e.target === this.modal) {\n        this.hide();\n      }\n    });\n    // Department checkboxes\n    this.modal.querySelectorAll(\".department-checkbox\").forEach(checkbox => {\n      checkbox.addEventListener(\"change\", (e) => {\n        const deptCode = e.target.value;\n        if (e.target.checked) {\n          if (!this.selectedDepartments.includes(deptCode)) {\n            this.selectedDepartments.push(deptCode);\n          }\n        } else {\n          this.selectedDepartments = this.selectedDepartments.filter(d => d !== deptCode);\n        }\n        this.updateSelectedCount();\n        this.updateConfirmButton();\n      });\n    });\n    // Confirm approval\n    this.modal.querySelector(\"#confirm-approval\").addEventListener(\"click\", () => {\n      this.confirmApproval();\n    });\n  }\n  updateSelectedCount() {\n    const countElement = this.modal.querySelector(\"#selected-count\");\n    if (countElement) {\n      countElement.textContent = this.selectedDepartments.length;\n    }\n  }\n  updateConfirmButton() {\n    const confirmBtn = this.modal.querySelector(\"#confirm-approval\");\n    if (confirmBtn) {\n      confirmBtn.disabled = this.selectedDepartments.length === 0;\n    }\n  }\n  async confirmApproval() {\n    if (this.selectedDepartments.length === 0) {\n      alert(\"Please select at least one office\");\n      return;\n    }\n    try {\n      const confirmBtn = this.modal.querySelector(\"#confirm-approval\");\n      confirmBtn.disabled = true;\n      confirmBtn.textContent = \"Processing...\";\n      const response = await fetch(`/api/coordinator/review-queue/${this.complaintId}/decide`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\"\n        },\n        credentials: \"include\",\n        body: JSON.stringify({\n          decision: \"approve\",\n          data: {\n            departments: this.selectedDepartments,\n            options: {\n              notes: \"Approved by coordinator\"\n            }\n          }\n        })\n      });\n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n      const result = await response.json();\n      if (result.success) {\n        // Show success message\n        if (typeof showToast === \"function\") {\n          showToast(\"success\", result.message || \"Complaint approved successfully\");\n        }\n        // Call callback to refresh the queue\n        if (this.callback) {\n          this.callback();\n        }\n        this.hide();\n      } else {\n        throw new Error(result.error || \"Failed to approve complaint\");\n      }\n    } catch (error) {\n      console.error(\"Error approving complaint:\", error);\n      alert(`Failed to approve complaint: ${  error.message}`);\n      // Re-enable button\n      const confirmBtn = this.modal.querySelector(\"#confirm-approval\");\n      confirmBtn.disabled = false;\n      confirmBtn.textContent = \"Approve & Assign\";\n    }\n  }\n  hide() {\n\n    if (this.modal) {\n      this.modal.remove();\n      this.modal = null;\n    }\n  }\n}\n// Export for use in other files\nwindow.DepartmentSelectionModal = DepartmentSelectionModal;\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\coordinator\\review-init.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\coordinator\\review-queue.js","messages":[{"ruleId":"no-lonely-if","severity":1,"message":"Unexpected if as the only statement in an else block.","line":386,"column":7,"nodeType":"IfStatement","messageId":"unexpectedLonelyIf","endLine":391,"endColumn":8},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":497,"column":71,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":497,"endColumn":72},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":497,"column":91,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":497,"endColumn":92},{"ruleId":"no-alert","severity":1,"message":"Unexpected prompt.","line":601,"column":20,"nodeType":"CallExpression","messageId":"unexpected","endLine":601,"endColumn":68}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Coordinator Review Queue JavaScript\r\nimport showToast from \"../components/toast.js\";\r\nimport BarangayPrioritization from \"../components/barangay-prioritization.js\";\r\n\r\nclass ReviewQueue {\r\n\r\n  constructor() {\r\n    this.complaints = [];\r\n    this.currentPage = 1;\r\n    this.itemsPerPage = 10;\r\n    this.filters = {\r\n      priority: \"\",\r\n      category: \"\",\r\n      duplicates: \"\",\r\n      search: \"\",\r\n      prioritization: \"\"\r\n    };\r\n    this.barangayPrioritization = null;\r\n    this.barangayPrioritizationComponent = null;\r\n    this.init();\r\n  }\r\n  async init() {\r\n    this.setupEventListeners();\r\n    this.setupRejectedSection();\r\n    // Load prioritization first, then complaints\r\n    await this.initBarangayPrioritization();\r\n    await this.loadComplaints();\r\n  }\r\n\r\n  async initBarangayPrioritization() {\r\n    try {\r\n      this.barangayPrioritizationComponent = new BarangayPrioritization(\"barangay-prioritization-container\");\r\n      await this.barangayPrioritizationComponent.loadInsights();\r\n      // Update prioritization map for filtering\r\n      if (this.barangayPrioritizationComponent.insightsData) {\r\n        this.barangayPrioritization = this.buildBarangayMap(this.barangayPrioritizationComponent.insightsData.barangays);\r\n        console.log(\"[REVIEW_QUEUE] Barangay prioritization loaded:\", this.barangayPrioritization.size, \"barangays\");\r\n        // Enhance complaints if they're already loaded\r\n        if (this.complaints.length > 0) {\r\n          this.enhanceComplaintsWithPrioritization();\r\n          this.renderComplaints();\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[REVIEW_QUEUE] Error initializing prioritization:\", error);\r\n    }\r\n  }\r\n\r\n  setupRejectedSection() {\r\n    const toggleBtn = document.getElementById(\"toggle-rejected-btn\");\r\n    const rejectedContainer = document.getElementById(\"rejected-container\");\r\n    let isExpanded = false;\r\n    let rejectedComplaints = [];\r\n\r\n    if (toggleBtn && rejectedContainer) {\r\n      toggleBtn.addEventListener(\"click\", async () => {\r\n        if (!isExpanded) {\r\n          // Load rejected complaints\r\n          const loading = document.getElementById(\"rejected-loading\");\r\n          const rejectedList = document.getElementById(\"rejected-list\");\r\n\r\n          if (loading) loading.style.display = \"block\";\r\n          if (rejectedList) rejectedList.innerHTML = \"\";\r\n\r\n          try {\r\n            const response = await fetch(\"/api/coordinator/rejected\", {\r\n              method: \"GET\",\r\n              headers: { \"Content-Type\": \"application/json\" },\r\n              credentials: \"include\"\r\n            });\r\n\r\n            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);\r\n\r\n            const data = await response.json();\r\n            rejectedComplaints = data.data || [];\r\n\r\n            if (rejectedList) {\r\n              if (rejectedComplaints.length === 0) {\r\n                rejectedList.innerHTML = '<div class=\"empty-state\"><p>No rejected complaints</p></div>';\r\n              } else {\r\n                rejectedList.innerHTML = rejectedComplaints.map(complaint => this.createComplaintCard(complaint, true)).join(\"\");\r\n                this.attachRejectedEventListeners();\r\n              }\r\n            }\r\n\r\n            toggleBtn.textContent = \"Hide Rejected\";\r\n            rejectedContainer.style.display = \"block\";\r\n            isExpanded = true;\r\n          } catch (error) {\r\n            console.error(\"Error loading rejected complaints:\", error);\r\n            showToast(\"Failed to load rejected complaints\", \"error\");\r\n            if (rejectedList) {\r\n              rejectedList.innerHTML = '<div class=\"empty-state\"><p>Error loading rejected complaints</p></div>';\r\n            }\r\n          } finally {\r\n            if (loading) loading.style.display = \"none\";\r\n          }\r\n        } else {\r\n          toggleBtn.textContent = \"Show Rejected\";\r\n          rejectedContainer.style.display = \"none\";\r\n          isExpanded = false;\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  attachRejectedEventListeners() {\r\n    document.querySelectorAll(\"#rejected-list .view-btn\").forEach(btn => {\r\n      btn.addEventListener(\"click\", (e) => {\r\n        const complaintId = e.target.getAttribute(\"data-complaint-id\");\r\n        this.viewComplaint(complaintId);\r\n      });\r\n    });\r\n  }\r\n  setupEventListeners() {\r\n    // Filter controls\r\n    const priorityFilter = document.getElementById(\"filter-priority\");\r\n    const categoryFilter = document.getElementById(\"filter-type\");\r\n    const duplicateFilter = document.getElementById(\"filter-similar\");\r\n    const searchInput = document.getElementById(\"search-input\");\r\n    if (priorityFilter) {\r\n      priorityFilter.addEventListener(\"change\", (e) => {\r\n        this.filters.priority = e.target.value;\r\n        this.applyFilters();\r\n      });\r\n    }\r\n    if (categoryFilter) {\r\n      categoryFilter.addEventListener(\"change\", (e) => {\r\n        this.filters.category = e.target.value;\r\n        this.applyFilters();\r\n      });\r\n    }\r\n    if (duplicateFilter) {\r\n      duplicateFilter.addEventListener(\"change\", (e) => {\r\n        this.filters.duplicates = e.target.value;\r\n        this.applyFilters();\r\n      });\r\n    }\r\n\r\n    const prioritizationFilter = document.getElementById(\"filter-prioritization\");\r\n    if (prioritizationFilter) {\r\n      prioritizationFilter.addEventListener(\"change\", (e) => {\r\n        this.filters.prioritization = e.target.value;\r\n        this.applyFilters();\r\n      });\r\n    }\r\n    if (searchInput) {\r\n      searchInput.addEventListener(\"input\", (e) => {\r\n        this.filters.search = e.target.value;\r\n        this.debounce(() => this.applyFilters(), 300)();\r\n      });\r\n    }\r\n    // Pagination\r\n    const prevBtn = document.getElementById(\"prev-page\");\r\n    const nextBtn = document.getElementById(\"next-page\");\r\n    if (prevBtn) {\r\n      prevBtn.addEventListener(\"click\", () => this.previousPage());\r\n    }\r\n    if (nextBtn) {\r\n      nextBtn.addEventListener(\"click\", () => this.nextPage());\r\n    }\r\n  }\r\n  applyFilters() {\r\n    this.currentPage = 1; // Reset to first page when filtering\r\n    this.renderComplaints();\r\n  }\r\n  async loadComplaints() {\r\n    try {\r\n      this.showLoading();\r\n\r\n      const complaintsResponse = await fetch(\"/api/coordinator/review-queue\", {\r\n        method: \"GET\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        credentials: \"include\"\r\n      });\r\n\r\n      if (!complaintsResponse.ok) {\r\n        throw new Error(`HTTP error! status: ${complaintsResponse.status}`);\r\n      }\r\n\r\n      const complaintsData = await complaintsResponse.json();\r\n      this.complaints = complaintsData.data || complaintsData.complaints || [];\r\n\r\n      console.log(`[REVIEW_QUEUE] Loaded ${this.complaints.length} complaints`);\r\n      if (this.complaints.length > 0) {\r\n        const sample = this.complaints[0];\r\n        console.log(\"[REVIEW_QUEUE] Sample complaint:\", {\r\n          id: sample.id,\r\n          barangay: sample.barangay,\r\n          hasBarangay: Boolean(sample.barangay),\r\n          latitude: sample.latitude,\r\n          longitude: sample.longitude\r\n        });\r\n      }\r\n\r\n      // Enhance complaints with prioritization if available\r\n      if (this.barangayPrioritization) {\r\n        this.enhanceComplaintsWithPrioritization();\r\n      } else if (this.barangayPrioritizationComponent && this.barangayPrioritizationComponent.insightsData) {\r\n        // Build map if not already built\r\n        this.barangayPrioritization = this.buildBarangayMap(this.barangayPrioritizationComponent.insightsData.barangays);\r\n        this.enhanceComplaintsWithPrioritization();\r\n      } else {\r\n        console.warn(\"[REVIEW_QUEUE] Prioritization not available yet, complaints will be enhanced when prioritization loads\");\r\n      }\r\n\r\n      this.renderComplaints();\r\n    } catch (error) {\r\n      console.error(\"Error loading complaints:\", error);\r\n      this.showError(\"Failed to load complaints. Please try again.\");\r\n    }\r\n  }\r\n\r\n  buildBarangayMap(barangays) {\r\n    const map = new Map();\r\n    barangays.forEach(barangay => {\r\n      map.set(barangay.barangay, barangay.prioritizationScore);\r\n    });\r\n    return map;\r\n  }\r\n\r\n  enhanceComplaintsWithPrioritization() {\r\n    if (!this.barangayPrioritization) {\r\n      console.warn(\"[REVIEW_QUEUE] Cannot enhance complaints: prioritization map not available\");\r\n      return;\r\n    }\r\n\r\n    let enhancedCount = 0;\r\n    // Enhance each complaint with its barangay prioritization score\r\n    this.complaints.forEach(complaint => {\r\n      if (complaint.barangay && this.barangayPrioritization.has(complaint.barangay)) {\r\n        complaint.prioritizationScore = this.barangayPrioritization.get(complaint.barangay);\r\n        complaint.priorityLevel = this.getPriorityLevelFromScore(complaint.prioritizationScore);\r\n        enhancedCount++;\r\n      } else {\r\n        complaint.prioritizationScore = 0;\r\n        complaint.priorityLevel = \"low\";\r\n        if (complaint.barangay) {\r\n          console.warn(`[REVIEW_QUEUE] Barangay \"${complaint.barangay}\" not found in prioritization map`);\r\n        }\r\n      }\r\n    });\r\n    console.log(`[REVIEW_QUEUE] Enhanced ${enhancedCount} out of ${this.complaints.length} complaints with prioritization scores`);\r\n  }\r\n\r\n  getPriorityLevelFromScore(score) {\r\n    if (score >= 50) return \"critical\";\r\n    if (score >= 30) return \"high\";\r\n    if (score >= 15) return \"medium\";\r\n    return \"low\";\r\n  }\r\n  renderComplaints() {\r\n    const complaintList = document.getElementById(\"complaint-list\");\r\n    const loading = document.getElementById(\"loading\");\r\n    const emptyState = document.getElementById(\"empty-state\");\r\n    if (!complaintList) {\r\n      console.error(\"complaint-list element not found\");\r\n      return;\r\n    }\r\n    console.log(\"Rendering complaints, total count:\", this.complaints.length);\r\n    const filteredComplaints = this.getFilteredComplaints();\r\n    console.log(\"Filtered complaints:\", filteredComplaints.length);\r\n    const paginatedComplaints = this.getPaginatedComplaints(filteredComplaints);\r\n    console.log(\"Paginated complaints:\", paginatedComplaints.length);\r\n    // Hide loading state\r\n    if (loading) loading.style.display = \"none\";\r\n    if (paginatedComplaints.length === 0) {\r\n      complaintList.style.display = \"none\";\r\n      if (emptyState) {\r\n        emptyState.style.display = \"block\";\r\n        emptyState.innerHTML = `\r\n                    <h2>No complaints found</h2>\r\n                    <p>No complaints match your current filters.</p>\r\n                `;\r\n      }\r\n      return;\r\n    }\r\n    // Show complaint list and hide empty state\r\n    complaintList.style.display = \"block\";\r\n    if (emptyState) emptyState.style.display = \"none\";\r\n    // Reset debug flag for this render\r\n    this._lastLoggedCardId = null;\r\n    complaintList.innerHTML = paginatedComplaints.map(complaint => this.createComplaintCard(complaint)).join(\"\");\r\n    this.updatePagination(filteredComplaints.length);\r\n    this.attachEventListeners();\r\n  }\r\n  attachEventListeners() {\r\n    // View buttons\r\n    document.querySelectorAll(\".view-btn\").forEach(btn => {\r\n      btn.addEventListener(\"click\", (e) => {\r\n        const complaintId = e.target.getAttribute(\"data-complaint-id\");\r\n        this.viewComplaint(complaintId);\r\n      });\r\n    });\r\n    // Reject buttons\r\n    document.querySelectorAll(\".reject-btn\").forEach(btn => {\r\n      btn.addEventListener(\"click\", (e) => {\r\n        const complaintId = e.target.getAttribute(\"data-complaint-id\");\r\n        this.rejectComplaint(complaintId);\r\n      });\r\n    });\r\n  }\r\n  createComplaintCard(complaint, isRejected = false) {\r\n    const priorityBadge = this.getPriorityBadgeClass(complaint.priority);\r\n    const algorithmFlags = complaint.algorithm_flags || {};\r\n    const prioritizationScore = complaint.prioritizationScore || 0;\r\n    const priorityLevel = complaint.priorityLevel || \"low\";\r\n    const barangay = complaint.barangay || null;\r\n\r\n    // Debug: Log first complaint being rendered\r\n    const isFirstCard = !this._lastLoggedCardId;\r\n    if (isFirstCard) {\r\n      this._lastLoggedCardId = complaint.id;\r\n      console.log(\"[REVIEW_QUEUE] Creating card for complaint:\", {\r\n        id: complaint.id.substring(0, 8),\r\n        barangay,\r\n        prioritizationScore,\r\n        priorityLevel,\r\n        hasBarangay: Boolean(barangay)\r\n      });\r\n    }\r\n\r\n    let flagHTML = \"\";\r\n    if (algorithmFlags.high_confidence_duplicate) {\r\n      flagHTML = `\r\n                <div class=\"algorithm-flag high-confidence\">\r\n                    <span class=\"flag-icon\">⚠️</span>\r\n                    <span class=\"flag-text\">\r\n                        <strong>HIGH CONFIDENCE DUPLICATE DETECTED</strong>\r\n                        <span class=\"flag-subtext\">Similarity score ≥85% - Review required</span>\r\n                    </span>\r\n                </div>\r\n            `;\r\n    } else if (algorithmFlags.has_duplicates) {\r\n      flagHTML = `\r\n                <div class=\"algorithm-flag\">\r\n                    <span class=\"flag-icon\">🔍</span>\r\n                    <span class=\"flag-text\">\r\n                        ${algorithmFlags.similarity_count} potential duplicate(s) found\r\n                    </span>\r\n                </div>\r\n            `;\r\n    }\r\n\r\n    // Add prioritization suggestion badge\r\n    let prioritizationSuggestionHTML = \"\";\r\n\r\n    // Show suggestion for any complaint with a barangay\r\n    if (barangay) {\r\n      const suggestionClass = `prioritization-suggestion ${priorityLevel}`;\r\n      let suggestionText = \"\";\r\n\r\n      // Determine suggestion text based on priority level\r\n      if (priorityLevel === \"critical\") {\r\n        suggestionText = \"🚨 Critical Priority Barangay - Assign First!\";\r\n      } else if (priorityLevel === \"high\") {\r\n        suggestionText = \"⚡ High Priority Barangay - Recommended\";\r\n      } else if (priorityLevel === \"medium\") {\r\n        suggestionText = \"📊 Medium Priority Barangay\";\r\n      } else {\r\n        // Show for all barangays, even low priority\r\n        suggestionText = \"📍 Barangay Prioritization\";\r\n      }\r\n\r\n      // Always show suggestion if barangay exists\r\n      prioritizationSuggestionHTML = `\r\n                <div class=\"${suggestionClass}\">\r\n                    ${suggestionText}\r\n                    <span class=\"barangay-name\">${this.escapeHtml(barangay)}</span>\r\n                    ${prioritizationScore > 0 ? `<span class=\"priority-score\">Score: ${prioritizationScore}</span>` : \"\"}\r\n                </div>\r\n            `;\r\n\r\n      // Debug: Log when suggestion is added (for first card only)\r\n      if (isFirstCard) {\r\n        console.log(\"[REVIEW_QUEUE] ✓ Added suggestion badge:\", {\r\n          barangay,\r\n          priorityLevel,\r\n          score: prioritizationScore,\r\n          htmlLength: prioritizationSuggestionHTML.length,\r\n          htmlPreview: prioritizationSuggestionHTML.substring(0, 100)\r\n        });\r\n      }\r\n    } else {\r\n      // Debug: Log when no suggestion (for first card only)\r\n      if (isFirstCard) {\r\n        console.log(\"[REVIEW_QUEUE] ✗ No suggestion - no barangay:\", {\r\n          id: complaint.id.substring(0, 8),\r\n          hasBarangay: Boolean(complaint.barangay)\r\n        });\r\n      }\r\n    }\r\n\r\n    return `\r\n            <div class=\"complaint-card ${complaint.priority?.toLowerCase() || \"medium\"} ${priorityLevel === \"critical\" || priorityLevel === \"high\" ? \"high-priority-barangay\" : \"\"}\" data-complaint-id=\"${complaint.id}\" data-priority-score=\"${prioritizationScore}\">\r\n                ${prioritizationSuggestionHTML}\r\n                <div class=\"complaint-header\">\r\n                    <div>\r\n                        <div class=\"complaint-id\">#${complaint.id}</div>\r\n                        <h3 class=\"complaint-title\">${complaint.title || \"Untitled Complaint\"}</h3>\r\n                    </div>\r\n                    <div class=\"complaint-status status-${complaint.workflow_status?.toLowerCase() || complaint.status?.toLowerCase() || \"pending\"}\">\r\n                        ${complaint.workflow_status || complaint.status || \"Pending\"}\r\n                    </div>\r\n                </div>\r\n                <div class=\"complaint-content\">\r\n                    <p class=\"complaint-description\">${complaint.descriptive_su || complaint.description || \"No description provided\"}</p>\r\n                    <div class=\"complaint-meta\">\r\n                        <span class=\"badge ${priorityBadge}\">${complaint.priority || \"Medium\"}</span>\r\n                        <span class=\"badge badge-medium\">${complaint.category || \"General\"}</span>\r\n                        ${barangay ? `<span class=\"badge badge-info\">📍 ${barangay}</span>` : \"\"}\r\n                        <span class=\"complaint-date\">${this.formatTimeAgo(complaint.submitted_at || complaint.created_at)}</span>\r\n                    </div>\r\n                    ${flagHTML}\r\n                </div>\r\n                <div class=\"complaint-actions\">\r\n                    <button class=\"btn btn-primary view-btn\" data-complaint-id=\"${complaint.id}\">\r\n                        View Details\r\n                    </button>\r\n                    ${!isRejected ? `<button class=\"btn btn-danger reject-btn\" data-complaint-id=\"${complaint.id}\">\r\n                        Reject\r\n                    </button>` : `<span class=\"badge badge-danger\" style=\"padding: 8px 12px;\">Rejected</span>`}\r\n                    ${isRejected && complaint.coordinator_notes ? `<div style=\"margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px;\">\r\n                        <strong>Rejection Reason:</strong> ${complaint.coordinator_notes}\r\n                    </div>` : \"\"}\r\n                </div>\r\n            </div>\r\n        `;\r\n  }\r\n  getFilteredComplaints() {\r\n    let filtered = this.complaints.filter(complaint => {\r\n      // Priority filter\r\n      const matchesPriority = !this.filters.priority || this.filters.priority === \"\" ||\r\n                                  complaint.priority?.toLowerCase() === this.filters.priority.toLowerCase();\r\n      // Category filter\r\n      const matchesCategory = !this.filters.category || this.filters.category === \"\" ||\r\n                                  complaint.category?.toLowerCase() === this.filters.category.toLowerCase();\r\n      // Duplicate filter\r\n      const matchesDuplicates = !this.filters.duplicates || this.filters.duplicates === \"\" ||\r\n                                    (this.filters.duplicates === \"yes\" && complaint.algorithm_flags?.has_duplicates) ||\r\n                                    (this.filters.duplicates === \"no\" && !complaint.algorithm_flags?.has_duplicates);\r\n      // Search filter\r\n      const matchesSearch = !this.filters.search || this.filters.search === \"\" ||\r\n                                complaint.title?.toLowerCase().includes(this.filters.search.toLowerCase()) ||\r\n                                (complaint.descriptive_su || complaint.description)?.toLowerCase().includes(this.filters.search.toLowerCase());\r\n      return matchesPriority && matchesCategory && matchesDuplicates && matchesSearch;\r\n    });\r\n\r\n    // Sort by prioritization if filter is set, otherwise default to highest priority first\r\n    if (this.barangayPrioritization) {\r\n      filtered = filtered.sort((a, b) => {\r\n        const scoreA = a.prioritizationScore || this.barangayPrioritization.get(a.barangay || \"\") || 0;\r\n        const scoreB = b.prioritizationScore || this.barangayPrioritization.get(b.barangay || \"\") || 0;\r\n\r\n        if (this.filters.prioritization) {\r\n          // Use filter setting\r\n          return this.filters.prioritization === \"desc\" ? scoreB - scoreA : scoreA - scoreB;\r\n        }\r\n        // Default: highest priority first\r\n        return scoreB - scoreA;\r\n\r\n      });\r\n    }\r\n\r\n    return filtered;\r\n  }\r\n  getPaginatedComplaints(complaints) {\r\n\r\n    const startIndex = (this.currentPage - 1) * this.itemsPerPage;\r\n    const endIndex = startIndex + this.itemsPerPage;\r\n    return complaints.slice(startIndex, endIndex);\r\n  }\r\n  updatePagination(totalItems) {\r\n    const totalPages = Math.ceil(totalItems / this.itemsPerPage);\r\n    const paginationContainer = document.getElementById(\"pagination-container\");\r\n    const pageInfo = document.getElementById(\"page-info\");\r\n    const itemsInfo = document.getElementById(\"items-info\");\r\n    const prevBtn = document.getElementById(\"prev-page\");\r\n    const nextBtn = document.getElementById(\"next-page\");\r\n    const pageNumbers = document.getElementById(\"page-numbers\");\r\n\r\n    // Show/hide pagination container\r\n    if (totalPages > 1) {\r\n      if (paginationContainer) paginationContainer.style.display = \"flex\";\r\n    } else {\r\n      if (paginationContainer) paginationContainer.style.display = \"none\";\r\n      return;\r\n    }\r\n\r\n    // Update page info\r\n    if (pageInfo) {\r\n      pageInfo.textContent = `Page ${this.currentPage} of ${totalPages}`;\r\n    }\r\n\r\n    // Update items info\r\n    if (itemsInfo) {\r\n      const startItem = totalItems === 0 ? 0 : (this.currentPage - 1) * this.itemsPerPage + 1;\r\n      const endItem = Math.min(this.currentPage * this.itemsPerPage, totalItems);\r\n      itemsInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems} complaints`;\r\n    }\r\n\r\n    // Update prev/next buttons\r\n    if (prevBtn) {\r\n      prevBtn.disabled = this.currentPage === 1;\r\n    }\r\n    if (nextBtn) {\r\n      nextBtn.disabled = this.currentPage === totalPages || totalPages === 0;\r\n    }\r\n\r\n    // Generate page numbers\r\n    if (pageNumbers) {\r\n      pageNumbers.innerHTML = \"\";\r\n      const maxVisiblePages = 7;\r\n      let startPage = Math.max(1, this.currentPage - Math.floor(maxVisiblePages / 2));\r\n      const endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);\r\n\r\n      // Adjust start page if we're near the end\r\n      if (endPage - startPage < maxVisiblePages - 1) {\r\n        startPage = Math.max(1, endPage - maxVisiblePages + 1);\r\n      }\r\n\r\n      // First page\r\n      if (startPage > 1) {\r\n        const firstBtn = document.createElement(\"button\");\r\n        firstBtn.className = \"page-number\";\r\n        firstBtn.textContent = \"1\";\r\n        firstBtn.addEventListener(\"click\", () => this.goToPage(1));\r\n        pageNumbers.appendChild(firstBtn);\r\n\r\n        if (startPage > 2) {\r\n          const ellipsis = document.createElement(\"span\");\r\n          ellipsis.className = \"page-number ellipsis\";\r\n          ellipsis.textContent = \"...\";\r\n          pageNumbers.appendChild(ellipsis);\r\n        }\r\n      }\r\n\r\n      // Page numbers\r\n      for (let i = startPage; i <= endPage; i++) {\r\n        const pageBtn = document.createElement(\"button\");\r\n        pageBtn.className = \"page-number\";\r\n        if (i === this.currentPage) {\r\n          pageBtn.classList.add(\"active\");\r\n        }\r\n        pageBtn.textContent = i.toString();\r\n        pageBtn.addEventListener(\"click\", () => this.goToPage(i));\r\n        pageNumbers.appendChild(pageBtn);\r\n      }\r\n\r\n      // Last page\r\n      if (endPage < totalPages) {\r\n        if (endPage < totalPages - 1) {\r\n          const ellipsis = document.createElement(\"span\");\r\n          ellipsis.className = \"page-number ellipsis\";\r\n          ellipsis.textContent = \"...\";\r\n          pageNumbers.appendChild(ellipsis);\r\n        }\r\n\r\n        const lastBtn = document.createElement(\"button\");\r\n        lastBtn.className = \"page-number\";\r\n        lastBtn.textContent = totalPages.toString();\r\n        lastBtn.addEventListener(\"click\", () => this.goToPage(totalPages));\r\n        pageNumbers.appendChild(lastBtn);\r\n      }\r\n    }\r\n  }\r\n\r\n  goToPage(page) {\r\n    const totalPages = Math.ceil(this.getFilteredComplaints().length / this.itemsPerPage);\r\n    if (page >= 1 && page <= totalPages) {\r\n      this.currentPage = page;\r\n      this.renderComplaints();\r\n      // Scroll to top of complaint list\r\n      const complaintList = document.getElementById(\"complaint-list\");\r\n      if (complaintList) {\r\n        complaintList.scrollIntoView({ behavior: \"smooth\", block: \"start\" });\r\n      }\r\n    }\r\n  }\r\n  previousPage() {\r\n    if (this.currentPage > 1) {\r\n      this.goToPage(this.currentPage - 1);\r\n    }\r\n  }\r\n  nextPage() {\r\n    const totalPages = Math.ceil(this.getFilteredComplaints().length / this.itemsPerPage);\r\n    if (this.currentPage < totalPages) {\r\n      this.goToPage(this.currentPage + 1);\r\n    }\r\n  }\r\n  async viewComplaint(complaintId) {\r\n    try {\r\n      // Redirect to the dedicated complaint review page\r\n      window.location.href = `/coordinator/review/${complaintId}`;\r\n    } catch (error) {\r\n      console.error(\"Error redirecting to complaint details:\", error);\r\n      this.showError(\"Failed to navigate to complaint details.\");\r\n    }\r\n  }\r\n  async rejectComplaint(complaintId) {\r\n    const reason = prompt(\"Please provide a reason for rejection:\");\r\n    if (!reason) return;\r\n    try {\r\n      const response = await fetch(`/api/coordinator/review-queue/${complaintId}/decide`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        credentials: \"include\",\r\n        body: JSON.stringify({\r\n          decision: \"reject\",\r\n          data: { reason }\r\n        })\r\n      });\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      showToast(\"Complaint rejected successfully\", \"success\");\r\n      this.loadComplaints();\r\n    } catch (error) {\r\n      console.error(\"Error rejecting complaint:\", error);\r\n      this.showError(\"Failed to reject complaint.\");\r\n    }\r\n  }\r\n  showLoading() {\r\n    const loading = document.getElementById(\"loading\");\r\n    const complaintList = document.getElementById(\"complaint-list\");\r\n    const emptyState = document.getElementById(\"empty-state\");\r\n    if (loading) loading.style.display = \"block\";\r\n    if (complaintList) complaintList.style.display = \"none\";\r\n    if (emptyState) emptyState.style.display = \"none\";\r\n  }\r\n  showError(message) {\r\n    showToast(message, \"error\");\r\n  }\r\n  getPriorityBadgeClass(priority) {\r\n    const map = {\r\n      \"urgent\": \"badge-urgent\",\r\n      \"high\": \"badge-high\",\r\n      \"medium\": \"badge-medium\",\r\n      \"low\": \"badge-low\"\r\n    };\r\n    return map[priority] || \"badge-medium\";\r\n  }\r\n  formatTimeAgo(dateString) {\r\n    if (!dateString) return \"N/A\";\r\n    const date = new Date(dateString);\r\n    const now = new Date();\r\n    const seconds = Math.floor((now - date) / 1000);\r\n    if (seconds < 60) return \"Just now\";\r\n    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;\r\n    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;\r\n    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;\r\n    return date.toLocaleDateString();\r\n  }\r\n  formatDate(dateString) {\r\n    if (!dateString) return \"N/A\";\r\n    const date = new Date(dateString);\r\n    return `${date.toLocaleDateString()  } ${  date.toLocaleTimeString()}`;\r\n  }\r\n  debounce(func, wait) {\r\n    let timeout;\r\n    return function executedFunction(...args) {\r\n      const later = () => {\r\n        clearTimeout(timeout);\r\n        func(...args);\r\n      };\r\n      clearTimeout(timeout);\r\n      timeout = setTimeout(later, wait);\r\n    };\r\n  }\r\n  escapeHtml(text) {\r\n    if (!text) return \"\";\r\n    const div = document.createElement(\"div\");\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n}\r\n// Initialize when DOM is loaded\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  window.reviewQueue = new ReviewQueue();\r\n});\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\coordinator\\review.js","messages":[{"ruleId":"no-use-before-define","severity":1,"message":"'handleEscape' was used before it was defined.","line":664,"column":45,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":664,"endColumn":57},{"ruleId":"no-use-before-define","severity":1,"message":"'filteredDepartments' was used before it was defined.","line":787,"column":3,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":787,"endColumn":22},{"ruleId":"no-use-before-define","severity":1,"message":"'allDepartments' was used before it was defined.","line":787,"column":25,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":787,"endColumn":39},{"ruleId":"no-use-before-define","severity":1,"message":"'allDepartments' was used before it was defined.","line":787,"column":57,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":787,"endColumn":71}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Coordinator Complaint Review Page\r\n * Handles loading and reviewing individual complaints\r\n */\r\nimport { Toast } from \"../components/toast.js\";\r\nimport { getDepartmentNameByIdOrCode, getActiveDepartments } from \"../utils/departmentUtils.js\";\r\n\r\nlet currentComplaint = null;\r\nlet complaintId = null;\r\nlet complaintMapInstance = null;\r\nlet boundaryToggleBtn = null;\r\nlet boundaryVisible = false;\r\nlet boundaryDataCache = null;\r\nlet reviewBoundaryLayer = null;\r\n/**\r\n * Clean up any stuck modal overlays\r\n */\r\nfunction cleanupStuckModals() {\r\n  // Remove any stuck modal overlays\r\n  const stuckModals = document.querySelectorAll('.modal.active, .modal-overlay.active, [id^=\"modal-\"]');\r\n  stuckModals.forEach(modal => {\r\n    if (modal.id !== \"modal-overlay\" || modal.classList.contains(\"active\")) {\r\n      modal.classList.remove(\"active\");\r\n      modal.style.display = \"none\";\r\n      modal.style.visibility = \"hidden\";\r\n      modal.style.opacity = \"0\";\r\n      // Only remove if it's not the main modal-overlay managed by ModalManager\r\n      if (modal.id !== \"modal-overlay\") {\r\n        modal.remove();\r\n      }\r\n    }\r\n  });\r\n\r\n  // Remove body modal-open class\r\n  document.body.classList.remove(\"modal-open\");\r\n\r\n  // Clean up ModalManager state if it exists\r\n  if (window.modalManager) {\r\n    window.modalManager.activeModal = null;\r\n    const overlay = window.modalManager.modalOverlay;\r\n    if (overlay) {\r\n      overlay.classList.remove(\"active\");\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Initialize the review page\r\n */\r\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\r\n  // Clean up any stuck modal overlays first\r\n  cleanupStuckModals();\r\n\r\n  // Get complaint ID from URL\r\n  const pathParts = window.location.pathname.split(\"/\");\r\n  complaintId = pathParts[pathParts.length - 1];\r\n  if (!complaintId || complaintId === \"review\") {\r\n    showError(\"No complaint ID provided\");\r\n    return;\r\n  }\r\n  setupEventListeners();\r\n  await loadComplaint();\r\n});\r\n\r\n/**\r\n * Setup event listeners for all buttons and forms\r\n */\r\nfunction setupEventListeners() {\r\n  // Return to dashboard button\r\n  const returnDashboardBtn = document.getElementById(\"return-dashboard-btn\");\r\n  if (returnDashboardBtn) {\r\n    returnDashboardBtn.addEventListener(\"click\", () => {\r\n      window.location.href = \"/dashboard\";\r\n    });\r\n  }\r\n\r\n  // Action buttons\r\n  const assignBtn = document.getElementById(\"assign-btn\");\r\n  if (assignBtn) {\r\n    assignBtn.addEventListener(\"click\", () => window.openAssignModal());\r\n  }\r\n\r\n  const duplicateBtn = document.getElementById(\"duplicate-btn\");\r\n  if (duplicateBtn) {\r\n    duplicateBtn.addEventListener(\"click\", () => window.openDuplicateModal());\r\n  }\r\n\r\n  const relatedBtn = document.getElementById(\"related-btn\");\r\n  if (relatedBtn) {\r\n    relatedBtn.addEventListener(\"click\", () => window.linkRelatedComplaints());\r\n  }\r\n\r\n  const rejectBtn = document.getElementById(\"reject-btn\");\r\n  if (rejectBtn) {\r\n    rejectBtn.addEventListener(\"click\", () => window.showRejectModal());\r\n  }\r\n\r\n  const falseComplaintBtn = document.getElementById(\"false-complaint-btn\");\r\n  if (falseComplaintBtn) {\r\n    falseComplaintBtn.addEventListener(\"click\", () => window.openFalseComplaintModal());\r\n  }\r\n\r\n  const uniqueBtn = document.getElementById(\"unique-btn\");\r\n  if (uniqueBtn) {\r\n    uniqueBtn.addEventListener(\"click\", () => window.markAsUnique());\r\n  }\r\n\r\n  // Modal close buttons\r\n  const closeAssignModal = document.getElementById(\"close-assign-modal\");\r\n  if (closeAssignModal) {\r\n    closeAssignModal.addEventListener(\"click\", () => window.closeModal(\"assign-modal\"));\r\n  }\r\n\r\n  const closeDuplicateModal = document.getElementById(\"close-duplicate-modal\");\r\n  if (closeDuplicateModal) {\r\n    closeDuplicateModal.addEventListener(\"click\", () => window.closeModal(\"duplicate-modal\"));\r\n  }\r\n\r\n  const closeRejectModal = document.getElementById(\"close-reject-modal\");\r\n  if (closeRejectModal) {\r\n    closeRejectModal.addEventListener(\"click\", () => window.closeModal(\"reject-modal\"));\r\n  }\r\n\r\n  const closeFalseComplaintModal = document.getElementById(\"close-false-complaint-modal\");\r\n  if (closeFalseComplaintModal) {\r\n    closeFalseComplaintModal.addEventListener(\"click\", () => window.closeModal(\"false-complaint-modal\"));\r\n  }\r\n\r\n  // Cancel buttons\r\n  const cancelAssignBtn = document.getElementById(\"cancel-assign-btn\");\r\n  if (cancelAssignBtn) {\r\n    cancelAssignBtn.addEventListener(\"click\", () => window.closeModal(\"assign-modal\"));\r\n  }\r\n\r\n  const cancelDuplicateBtn = document.getElementById(\"cancel-duplicate-btn\");\r\n  if (cancelDuplicateBtn) {\r\n    cancelDuplicateBtn.addEventListener(\"click\", () => window.closeModal(\"duplicate-modal\"));\r\n  }\r\n\r\n  const cancelRejectBtn = document.getElementById(\"cancel-reject-btn\");\r\n  if (cancelRejectBtn) {\r\n    cancelRejectBtn.addEventListener(\"click\", () => window.closeModal(\"reject-modal\"));\r\n  }\r\n\r\n  const cancelFalseComplaintBtn = document.getElementById(\"cancel-false-complaint-btn\");\r\n  if (cancelFalseComplaintBtn) {\r\n    cancelFalseComplaintBtn.addEventListener(\"click\", () => window.closeModal(\"false-complaint-modal\"));\r\n  }\r\n\r\n  // Form submissions\r\n  const assignForm = document.getElementById(\"assign-form\");\r\n  if (assignForm) {\r\n    assignForm.addEventListener(\"submit\", (e) => {\r\n      e.preventDefault();\r\n      window.handleAssign(e);\r\n    });\r\n  }\r\n\r\n  const duplicateForm = document.getElementById(\"duplicate-form\");\r\n  if (duplicateForm) {\r\n    duplicateForm.addEventListener(\"submit\", (e) => {\r\n      e.preventDefault();\r\n      window.handleDuplicate(e);\r\n    });\r\n  }\r\n\r\n  const rejectForm = document.getElementById(\"reject-form\");\r\n  if (rejectForm) {\r\n    rejectForm.addEventListener(\"submit\", (e) => {\r\n      e.preventDefault();\r\n      window.handleReject(e);\r\n    });\r\n  }\r\n\r\n  const falseComplaintForm = document.getElementById(\"false-complaint-form\");\r\n  if (falseComplaintForm) {\r\n    falseComplaintForm.addEventListener(\"submit\", (e) => {\r\n      e.preventDefault();\r\n      window.handleFalseComplaint(e);\r\n    });\r\n  }\r\n}\r\n/**\r\n * Load complaint details\r\n */\r\nasync function loadComplaint() {\r\n  try {\r\n    const response = await fetch(`/api/coordinator/review-queue/${complaintId}`);\r\n    if (!response.ok) {\r\n      throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n    }\r\n    const result = await response.json();\r\n    if (!result.success) {\r\n      throw new Error(result.error || \"Failed to load complaint\");\r\n    }\r\n    currentComplaint = result.data;\r\n    renderComplaint();\r\n  } catch (error) {\r\n    console.error(\"[REVIEW] Load error:\", error);\r\n    showError(error.message);\r\n  }\r\n}\r\n/**\r\n * Render complaint details\r\n */\r\nasync function renderComplaint() {\r\n  // The service returns complaint in nested structure\r\n  const {complaint} = currentComplaint;\r\n  const similarities = currentComplaint.analysis?.duplicate_candidates ||\r\n                     currentComplaint.analysis?.similar_complaints ||\r\n                     currentComplaint.similarities || [];\r\n  // Hide loading, show content\r\n  document.getElementById(\"loading\").style.display = \"none\";\r\n  document.getElementById(\"complaint-content\").style.display = \"block\";\r\n  // Header\r\n  document.getElementById(\"complaint-title\").textContent = complaint.title;\r\n  document.getElementById(\"complaint-id\").textContent = complaint.id;\r\n  document.getElementById(\"submitted-date\").textContent = formatDate(complaint.submitted_at);\r\n  document.getElementById(\"submitter-name\").textContent =\r\n    complaint.submitted_by_profile?.name || complaint.submitted_by_profile?.email || \"Unknown\";\r\n  // Render complainant info panel\r\n  renderComplainantInfo(complaint.submitted_by_profile);\r\n  // Status badge\r\n  const statusEl = document.getElementById(\"complaint-status\");\r\n  const status = complaint.workflow_status || complaint.status || \"unknown\";\r\n  statusEl.innerHTML = `<span class=\"badge status-${status.replace(\" \", \"-\")}\">${status}</span>`;\r\n  // Priority badge\r\n  const priorityEl = document.getElementById(\"complaint-priority\");\r\n  priorityEl.innerHTML = `<span class=\"badge priority-${complaint.priority}\">${complaint.priority}</span>`;\r\n  // Details - Handle both old and new hierarchical form structure\r\n  const typeText = complaint.type || complaint.category || \"Not specified\";\r\n  const subcategoryText = complaint.subcategory || \"\";\r\n  document.getElementById(\"complaint-type\").textContent = typeText;\r\n  const subtypeEl = document.getElementById(\"complaint-subtype\");\r\n  if (subcategoryText) {\r\n    subtypeEl.textContent = ` - ${subcategoryText}`;\r\n  } else {\r\n    subtypeEl.textContent = \"\";\r\n  }\r\n  document.getElementById(\"complaint-description\").textContent = complaint.descriptive_su;\r\n  document.getElementById(\"complaint-location\").textContent = complaint.location_text;\r\n  // Show preferred departments in main details\r\n  const preferredDeptsEl = document.getElementById(\"preferred-departments-list\");\r\n  if (preferredDeptsEl) {\r\n    const departments = complaint.preferred_departments || [];\r\n    if (departments.length > 0) {\r\n      // Load department names dynamically\r\n      const displayNames = await Promise.all(\r\n        departments.map(dept => getDepartmentNameByIdOrCode(dept))\r\n      );\r\n      preferredDeptsEl.innerHTML = displayNames.map(name => `<span class=\"dept-badge\">${name}</span>`).join(\" \");\r\n    } else {\r\n      preferredDeptsEl.textContent = \"No departments selected by citizen\";\r\n    }\r\n  }\r\n  // Show complainant's department preference\r\n  const preferenceEl = document.getElementById(\"complainant-preference\");\r\n  if (preferenceEl) {\r\n    const departments = complaint.preferred_departments || [];\r\n    if (departments.length > 0) {\r\n      // Load department names dynamically\r\n      const displayNames = await Promise.all(\r\n        departments.map(dept => getDepartmentNameByIdOrCode(dept))\r\n      );\r\n      preferenceEl.textContent = displayNames.join(\", \");\r\n    } else {\r\n      preferenceEl.textContent = \"No preference specified\";\r\n    }\r\n  }\r\n  // Reset map helpers before rendering\r\n  complaintMapInstance = null;\r\n  reviewBoundaryLayer = null;\r\n  boundaryVisible = false;\r\n  updateBoundaryButtonText();\r\n  setupMapControlButtons(complaint);\r\n\r\n  // Map preview using ComplaintMap component\r\n  try {\r\n    const mapEl = document.getElementById(\"location-map\");\r\n    const hasLat = complaint.latitude !== null && complaint.latitude !== void 0;\r\n    const hasLng = complaint.longitude !== null && complaint.longitude !== void 0;\r\n    console.log(\"[REVIEW] Map setup:\", {\r\n      mapEl: Boolean(mapEl),\r\n      hasLat,\r\n      hasLng,\r\n      lat: complaint.latitude,\r\n      lng: complaint.longitude,\r\n      latType: typeof complaint.latitude,\r\n      lngType: typeof complaint.longitude\r\n    });\r\n    if (mapEl && (hasLat || hasLng)) {\r\n      // Use ComplaintMap component\r\n      if (window.ComplaintMap) {\r\n        const complaintMap = new window.ComplaintMap(\"location-map\");\r\n        if (hasLat && hasLng) {\r\n          // Wait for map to be fully initialized and container to be visible\r\n          const initMap = () => {\r\n            const mapEl = document.getElementById(\"location-map\");\r\n            if (mapEl && mapEl.offsetWidth > 0 && mapEl.offsetHeight > 0) {\r\n              complaintMapInstance = complaintMap;\r\n              reviewBoundaryLayer = null;\r\n              boundaryVisible = false;\r\n              updateBoundaryButtonText();\r\n              complaintMap.setLocation(\r\n                complaint.latitude,\r\n                complaint.longitude,\r\n                complaint.title || \"Complaint Location\",\r\n                complaint.location_text || \"\"\r\n              );\r\n              // Invalidate size after setting location\r\n              setTimeout(() => {\r\n                if (complaintMap.map) {\r\n                  complaintMap.map.invalidateSize();\r\n                }\r\n              }, 300);\r\n            } else {\r\n              // Retry if container not ready\r\n              setTimeout(initMap, 100);\r\n            }\r\n          };\r\n          // Start initialization after a short delay\r\n          setTimeout(initMap, 300);\r\n        }\r\n      } else {\r\n        console.warn(\"[REVIEW] ComplaintMap component not loaded, trying fallback...\");\r\n        // Fallback to basic Leaflet map\r\n        try {\r\n          if (typeof L !== \"undefined\") {\r\n            const lat = Number(complaint.latitude);\r\n            const lng = Number(complaint.longitude);\r\n            const center = [lat, lng];\r\n            const map = L.map(\"location-map\").setView(center, 15);\r\n            L.tileLayer(\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\", {\r\n              attribution: \"© OpenStreetMap contributors\"\r\n            }).addTo(map);\r\n            const marker = L.marker(center).addTo(map);\r\n            marker.bindPopup(`<b>${complaint.title || \"Complaint Location\"}</b><br>${complaint.location_text || \"\"}`);\r\n            complaintMapInstance = { map };\r\n            reviewBoundaryLayer = null;\r\n            boundaryVisible = false;\r\n            updateBoundaryButtonText();\r\n          } else {\r\n            console.warn(\"[REVIEW] Leaflet not available for fallback\");\r\n          }\r\n        } catch (fallbackError) {\r\n          console.error(\"[REVIEW] Fallback map failed:\", fallbackError);\r\n        }\r\n      }\r\n    } else if (mapEl) {\r\n      mapEl.innerHTML = '<div style=\"padding: 20px; text-align: center; color: #666;\">No location coordinates available</div>';\r\n    }\r\n  } catch (e) {\r\n    console.warn(\"[REVIEW] Map init failed:\", e);\r\n  }\r\n  // Evidence (always show section with fallback)\r\n  const evidenceSection = document.getElementById(\"evidence-section\");\r\n  const evidenceEmpty = document.getElementById(\"evidence-empty\");\r\n  // Handle different evidence field structures\r\n  let evidenceList = [];\r\n  if (complaint.evidence && Array.isArray(complaint.evidence)) {\r\n    evidenceList = complaint.evidence;\r\n  } else if (complaint.evidence_files && Array.isArray(complaint.evidence_files)) {\r\n    evidenceList = complaint.evidence_files;\r\n  } else if (complaint.files && Array.isArray(complaint.files)) {\r\n    evidenceList = complaint.files;\r\n  }\r\n  if (evidenceList.length > 0) {\r\n    if (evidenceSection) evidenceSection.style.display = \"block\";\r\n    if (evidenceEmpty) evidenceEmpty.style.display = \"none\";\r\n    renderEvidence(evidenceList);\r\n  } else {\r\n    if (evidenceSection) evidenceSection.style.display = \"block\";\r\n    if (evidenceEmpty) evidenceEmpty.style.display = \"block\";\r\n    const grid = document.getElementById(\"evidence-grid\");\r\n    if (grid) grid.innerHTML = \"\";\r\n  }\r\n  // Check for high confidence duplicates (similarity score >= 0.85)\r\n  const duplicateCandidates = currentComplaint.analysis?.duplicate_candidates || [];\r\n  const hasHighConfidenceDuplicate = duplicateCandidates.length > 0 ||\r\n    (similarities && similarities.some(s => (s.similarity_score || s.score || 0) >= 0.85));\r\n\r\n  // Show/hide high confidence duplicate alert\r\n  const duplicateAlert = document.getElementById(\"high-confidence-duplicate-alert\");\r\n  if (duplicateAlert) {\r\n    if (hasHighConfidenceDuplicate && !complaint.is_duplicate) {\r\n      duplicateAlert.style.display = \"block\";\r\n    } else {\r\n      duplicateAlert.style.display = \"none\";\r\n    }\r\n  }\r\n\r\n  // Similar complaints\r\n  if (similarities && similarities.length > 0) {\r\n    document.getElementById(\"similar-section\").style.display = \"block\";\r\n    document.getElementById(\"duplicate-btn\").style.display = \"block\";\r\n    document.getElementById(\"related-btn\").style.display = \"block\";\r\n    document.getElementById(\"unique-btn\").style.display = \"block\";\r\n    renderSimilarComplaints(similarities);\r\n  } else {\r\n    // Hide similar complaints section if no similarities\r\n    document.getElementById(\"similar-section\").style.display = \"none\";\r\n    document.getElementById(\"duplicate-btn\").style.display = \"none\";\r\n    document.getElementById(\"related-btn\").style.display = \"none\";\r\n    document.getElementById(\"unique-btn\").style.display = \"none\";\r\n  }\r\n}\r\n/**\r\n * Render evidence images with preview functionality\r\n */\r\nfunction renderEvidence(evidence) {\r\n  const grid = document.getElementById(\"evidence-grid\");\r\n  const normalize = (item) => {\r\n    // Support both DB_FORMAT.sql (snake_case) and existing code (camelCase)\r\n    // Also support signedUrl from coordinator repository\r\n    const url = item.publicUrl || item.signedUrl || item.url || item.public_url || null;\r\n    const fileName = item.fileName || item.file_name || item.name || \"file\";\r\n    const filePath = item.filePath || item.file_path || item.path || null;\r\n    const fileType = item.fileType || item.file_type || item.type || \"\";\r\n    const fileSize = item.fileSize || item.file_size || item.size || null;\r\n    const mimeType = item.mimeType || item.mime_type || item.fileType || \"\";\r\n    return { url, fileName, filePath, fileType, fileSize, mimeType };\r\n  };\r\n  const isImage = (type, name) => {\r\n    if (type && type.startsWith(\"image/\")) return true;\r\n    const n = (name || \"\").toLowerCase();\r\n    return n.endsWith(\".jpg\") || n.endsWith(\".jpeg\") || n.endsWith(\".png\") || n.endsWith(\".webp\");\r\n  };\r\n  const isVideo = (type, name) => {\r\n    if (type && type.startsWith(\"video/\")) return true;\r\n    const n = (name || \"\").toLowerCase();\r\n    return n.endsWith(\".mp4\") || n.endsWith(\".mov\") || n.endsWith(\".webm\");\r\n  };\r\n  const isPdf = (type, name) => {\r\n    return (type === \"application/pdf\") || (name || \"\").toLowerCase().endsWith(\".pdf\");\r\n  };\r\n  const formatSize = (bytes) => {\r\n    if (!bytes || isNaN(bytes)) return \"\";\r\n    const units = [\"B\",\"KB\",\"MB\",\"GB\"];\r\n    let i = 0; let n = Number(bytes);\r\n    while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }\r\n    return `${n.toFixed(n >= 10 || i === 0 ? 0 : 1)} ${units[i]}`;\r\n  };\r\n  const getFileIcon = (type, name) => {\r\n    if (isImage(type, name)) return \"🖼️\";\r\n    if (isVideo(type, name)) return \"🎥\";\r\n    if (isPdf(type, name)) return \"📄\";\r\n    if (type && type.startsWith(\"audio/\")) return \"🎵\";\r\n    return \"📎\";\r\n  };\r\n  grid.innerHTML = evidence.map((raw, index) => {\r\n    const item = normalize(raw);\r\n    const sizeText = item.fileSize ? ` · ${formatSize(item.fileSize)}` : \"\";\r\n    const icon = getFileIcon(item.fileType, item.fileName);\r\n    return `\r\n      <div class=\"evidence-item\" data-evidence-index=\"${index}\" style=\"cursor: pointer;\">\r\n        <div class=\"evidence-preview\">\r\n          ${isImage(item.fileType, item.fileName) && item.url ?\r\n    `<img src=\"${item.url}\" alt=\"${item.fileName}\" style=\"width: 100%; height: 120px; object-fit: cover; border-radius: 8px;\">` :\r\n    `<div class=\"evidence-icon\" style=\"display: flex; align-items: center; justify-content: center; height: 120px; font-size: 48px; background: #f3f4f6; border-radius: 8px;\">${icon}</div>`\r\n}\r\n          <div class=\"evidence-info\" style=\"padding: 8px;\">\r\n            <div class=\"evidence-name\" style=\"font-weight: 500; font-size: 14px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;\" title=\"${item.fileName}\">${item.fileName}</div>\r\n            <div class=\"evidence-meta\" style=\"font-size: 12px; color: #6b7280;\">${item.fileType || \"Unknown type\"}${sizeText}</div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }).join(\"\");\r\n\r\n  // Store evidence data globally for preview\r\n  window.evidenceData = evidence.map(normalize);\r\n\r\n  // Attach event listeners for evidence items\r\n  document.querySelectorAll(\".evidence-item\").forEach(item => {\r\n    const index = parseInt(item.getAttribute(\"data-evidence-index\"));\r\n    item.addEventListener(\"click\", () => {\r\n      window.openEvidencePreview(index);\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Open evidence preview modal\r\n */\r\nwindow.openEvidencePreview = function(index) {\r\n  console.log(\"[REVIEW] Opening evidence preview:\", {\r\n    index,\r\n    hasPreview: Boolean(window.evidencePreview),\r\n    hasData: Boolean(window.evidenceData),\r\n    dataLength: window.evidenceData?.length,\r\n    evidence: window.evidenceData?.[index]\r\n  });\r\n\r\n  if (window.evidencePreview && window.evidenceData && window.evidenceData[index]) {\r\n    window.evidencePreview.show(window.evidenceData[index]);\r\n  } else {\r\n    console.error(\"[REVIEW] Cannot open evidence preview - missing components or data\");\r\n  }\r\n};\r\n\r\n/**\r\n * Map helper controls\r\n */\r\nfunction setupMapControlButtons(complaint) {\r\n  const boundaryBtn = document.getElementById(\"toggle-boundary-btn\");\r\n  const fullscreenBtn = document.getElementById(\"map-fullscreen-btn\");\r\n  if (!boundaryBtn || !fullscreenBtn) return;\r\n\r\n  const hasLatitude = complaint.latitude !== null && complaint.latitude !== void 0;\r\n  const hasLongitude = complaint.longitude !== null && complaint.longitude !== void 0;\r\n  const hasCoordinates = hasLatitude && hasLongitude;\r\n\r\n  if (!hasCoordinates) {\r\n    boundaryBtn.style.display = \"none\";\r\n    fullscreenBtn.style.display = \"none\";\r\n    boundaryToggleBtn = null;\r\n    return;\r\n  }\r\n\r\n  boundaryBtn.style.display = \"inline-flex\";\r\n  fullscreenBtn.style.display = \"inline-flex\";\r\n  boundaryToggleBtn = boundaryBtn;\r\n  updateBoundaryButtonText();\r\n\r\n  boundaryBtn.removeEventListener(\"click\", handleBoundaryToggle);\r\n  boundaryBtn.addEventListener(\"click\", handleBoundaryToggle);\r\n  fullscreenBtn.onclick = () => openFullscreenMap(complaint);\r\n}\r\n\r\nfunction updateBoundaryButtonText() {\r\n  if (!boundaryToggleBtn) return;\r\n  boundaryToggleBtn.textContent = boundaryVisible ? \"Hide Digos City Boundary\" : \"Show Digos City Boundary\";\r\n  boundaryToggleBtn.setAttribute(\"aria-pressed\", boundaryVisible ? \"true\" : \"false\");\r\n}\r\n\r\nasync function handleBoundaryToggle() {\r\n  if (!boundaryToggleBtn) return;\r\n\r\n  if (!complaintMapInstance || !complaintMapInstance.map) {\r\n    Toast.info(\"Map is still initializing. Please try again shortly.\");\r\n    return;\r\n  }\r\n\r\n  boundaryToggleBtn.disabled = true;\r\n  try {\r\n    if (!reviewBoundaryLayer) {\r\n      await ensureBoundaryData();\r\n      reviewBoundaryLayer = createBoundaryLayer(complaintMapInstance.map);\r\n    }\r\n\r\n    if (!reviewBoundaryLayer) {\r\n      throw new Error(\"Boundary data is unavailable.\");\r\n    }\r\n\r\n    if (complaintMapInstance.map.hasLayer(reviewBoundaryLayer)) {\r\n      complaintMapInstance.map.removeLayer(reviewBoundaryLayer);\r\n      boundaryVisible = false;\r\n      Toast.info(\"Digos City boundary hidden.\");\r\n    } else {\r\n      reviewBoundaryLayer.addTo(complaintMapInstance.map);\r\n      boundaryVisible = true;\r\n      Toast.success(\"Digos City boundary displayed.\");\r\n    }\r\n    updateBoundaryButtonText();\r\n  } catch (error) {\r\n    console.error(\"[REVIEW] Boundary toggle error:\", error);\r\n    Toast.error(error.message || \"Unable to toggle the boundary.\");\r\n  } finally {\r\n    boundaryToggleBtn.disabled = false;\r\n  }\r\n}\r\n\r\nasync function ensureBoundaryData() {\r\n  if (Array.isArray(boundaryDataCache) && boundaryDataCache.length > 0) {\r\n    return boundaryDataCache;\r\n  }\r\n\r\n  const response = await fetch(\"/api/boundaries\");\r\n  if (!response.ok) {\r\n    throw new Error(\"Failed to load boundary data.\");\r\n  }\r\n  const data = await response.json();\r\n  if (!Array.isArray(data) || data.length === 0) {\r\n    throw new Error(\"Boundary data is not available.\");\r\n  }\r\n\r\n  boundaryDataCache = data.filter(item => item && item.geojson);\r\n  if (boundaryDataCache.length === 0) {\r\n    throw new Error(\"Boundary GeoJSON data is missing.\");\r\n  }\r\n  return boundaryDataCache;\r\n}\r\n\r\nfunction createBoundaryLayer(map) {\r\n  if (!Array.isArray(boundaryDataCache) || boundaryDataCache.length === 0 || !map) {\r\n    return null;\r\n  }\r\n\r\n  const layerGroup = L.layerGroup();\r\n  boundaryDataCache.forEach(barangay => {\r\n    if (!barangay?.geojson) return;\r\n    const geoLayer = L.geoJSON(barangay.geojson, {\r\n      style: {\r\n        color: \"#3b82f6\",\r\n        weight: 1.5,\r\n        opacity: 0.8,\r\n        dashArray: \"6,4\",\r\n        fillOpacity: 0\r\n      },\r\n      interactive: false\r\n    });\r\n\r\n    if (barangay.name) {\r\n      geoLayer.bindTooltip(barangay.name, {\r\n        permanent: false,\r\n        direction: \"center\",\r\n        className: \"boundary-tooltip\",\r\n        interactive: false\r\n      });\r\n    }\r\n\r\n    geoLayer.addTo(layerGroup);\r\n  });\r\n\r\n  return layerGroup;\r\n}\r\n\r\nfunction openFullscreenMap(complaint) {\r\n  const hasLatitude = complaint.latitude !== null && complaint.latitude !== void 0;\r\n  const hasLongitude = complaint.longitude !== null && complaint.longitude !== void 0;\r\n  if (!hasLatitude || !hasLongitude) {\r\n    Toast.error(\"No coordinates available for this complaint.\");\r\n    return;\r\n  }\r\n\r\n  const existingModal = document.getElementById(\"review-map-modal\");\r\n  if (existingModal) {\r\n    existingModal.remove();\r\n  }\r\n\r\n  const modal = document.createElement(\"div\");\r\n  modal.id = \"review-map-modal\";\r\n  modal.className = \"modal active\";\r\n  modal.style.cssText = \"position:fixed; inset:0; z-index:10000; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px);\";\r\n  modal.innerHTML = `\r\n    <div class=\"modal-content\" style=\"max-width: 90vw; width: 960px; background: #fff; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;\">\r\n      <div class=\"modal-header\" style=\"display:flex; justify-content:space-between; align-items:center; padding:1.25rem; border-bottom:1px solid #e5e7eb;\">\r\n        <h2 style=\"margin:0; font-size:1.1rem;\">📍 Complaint Location</h2>\r\n        <button id=\"close-review-map-modal\" class=\"modal-close\" style=\"font-size:1.5rem;\">&times;</button>\r\n      </div>\r\n      <div class=\"modal-body\" style=\"padding:1.25rem;\">\r\n        <div id=\"review-fullscreen-map\" style=\"width:100%; height:70vh; border-radius:10px; overflow:hidden; background:#f3f4f6;\"></div>\r\n        <div style=\"margin-top:1rem; font-size:0.95rem;\">\r\n          <strong>Address:</strong> ${complaint.location_text || \"N/A\"}<br>\r\n          <strong>Coordinates:</strong> ${complaint.latitude}, ${complaint.longitude}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  `;\r\n  document.body.appendChild(modal);\r\n\r\n  const closeModal = () => {\r\n    modal.remove();\r\n    document.removeEventListener(\"keydown\", handleEscape);\r\n  };\r\n\r\n  document.getElementById(\"close-review-map-modal\").addEventListener(\"click\", (e) => {\r\n    e.stopPropagation();\r\n    closeModal();\r\n  });\r\n\r\n  modal.addEventListener(\"click\", (e) => {\r\n    if (e.target === modal) {\r\n      closeModal();\r\n    }\r\n  });\r\n\r\n  const handleEscape = (e) => {\r\n    if (e.key === \"Escape\") {\r\n      closeModal();\r\n    }\r\n  };\r\n  document.addEventListener(\"keydown\", handleEscape);\r\n\r\n  setTimeout(() => initializeFullscreenMap(complaint), 100);\r\n}\r\n\r\nasync function initializeFullscreenMap(complaint) {\r\n  const mapContainer = document.getElementById(\"review-fullscreen-map\");\r\n  if (!mapContainer) return;\r\n\r\n  try {\r\n    await ensureLeafletLoaded();\r\n\r\n    const lat = Number(complaint.latitude);\r\n    const lng = Number(complaint.longitude);\r\n    const map = L.map(\"review-fullscreen-map\").setView([lat, lng], 15);\r\n    L.tileLayer(\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\", {\r\n      attribution: \"© OpenStreetMap contributors\",\r\n      maxZoom: 19\r\n    }).addTo(map);\r\n\r\n    L.marker([lat, lng])\r\n      .addTo(map)\r\n      .bindPopup(`<strong>${complaint.title || \"Complaint Location\"}</strong><br>${complaint.location_text || \"\"}`)\r\n      .openPopup();\r\n\r\n    if (Array.isArray(boundaryDataCache) && boundaryDataCache.length > 0) {\r\n      const layer = createBoundaryLayer(map);\r\n      if (layer) {\r\n        layer.addTo(map);\r\n      }\r\n    }\r\n\r\n    setTimeout(() => map.invalidateSize(), 200);\r\n  } catch (error) {\r\n    console.error(\"[REVIEW] Fullscreen map error:\", error);\r\n    mapContainer.innerHTML = '<p style=\"padding: 1rem; color: #b91c1c;\">Unable to load map preview.</p>';\r\n  }\r\n}\r\n\r\nasync function ensureLeafletLoaded() {\r\n  if (typeof L !== \"undefined\") {\r\n    return;\r\n  }\r\n\r\n  await new Promise((resolve, reject) => {\r\n    const existingScript = document.querySelector(\"script[data-leaflet]\");\r\n    if (existingScript) {\r\n      existingScript.addEventListener(\"load\", resolve);\r\n      existingScript.addEventListener(\"error\", () => reject(new Error(\"Failed to load Leaflet.\")));\r\n      return;\r\n    }\r\n\r\n    const script = document.createElement(\"script\");\r\n    script.src = \"https://unpkg.com/leaflet@1.9.4/dist/leaflet.js\";\r\n    script.integrity = \"sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=\";\r\n    script.crossOrigin = \"\";\r\n    script.dataset.leaflet = \"true\";\r\n    script.onload = () => resolve();\r\n    script.onerror = () => reject(new Error(\"Failed to load Leaflet.\"));\r\n    document.head.appendChild(script);\r\n  });\r\n}\r\n\r\n/**\r\n * Render similar complaints\r\n */\r\nfunction renderSimilarComplaints(similarities) {\r\n  const list = document.getElementById(\"similar-list\");\r\n  const masterSelect = document.getElementById(\"master-complaint\");\r\n\r\n  list.innerHTML = similarities.map(sim => `\r\n    <div class=\"similar-item\">\r\n      <h4>${sim.similar_complaint?.title || \"Unknown\"}</h4>\r\n      <div class=\"similar-meta\">\r\n        ${sim.similar_complaint?.category || sim.similar_complaint?.type || \"\"} | \r\n        ${sim.similar_complaint?.workflow_status || sim.similar_complaint?.status || \"\"} | \r\n        ${formatDate(sim.similar_complaint?.submitted_at)}\r\n        <span class=\"similarity-score\">${Math.round(sim.similarity_score * 100)}% match</span>\r\n      </div>\r\n    </div>\r\n  `).join(\"\");\r\n\r\n  // Populate master complaint dropdown\r\n  masterSelect.innerHTML = `<option value=\"\">Select master complaint...</option>${\r\n    similarities.map(sim => `\r\n      <option value=\"${sim.similar_complaint_id}\">\r\n        ${sim.similar_complaint?.title} (${Math.round(sim.similarity_score * 100)}% match)\r\n      </option>\r\n    `).join(\"\")}`;\r\n}\r\n/**\r\n * Modal functions\r\n */\r\nwindow.openAssignModal = function() {\r\n  document.getElementById(\"assign-modal\").classList.add(\"active\");\r\n  // Pre-fill priority from complaint\r\n  const {complaint} = currentComplaint;\r\n  document.getElementById(\"assign-priority\").value = complaint.priority || \"medium\";\r\n  // Reset search input\r\n  const searchInput = document.getElementById(\"department-search-input\");\r\n  if (searchInput) {\r\n    searchInput.value = \"\";\r\n  }\r\n  // Reset filtered departments\r\n  filteredDepartments = allDepartments.length > 0 ? [...allDepartments] : [];\r\n  // Load departments dynamically\r\n  loadDepartmentsForAssignment();\r\n};\r\nwindow.openDuplicateModal = function() {\r\n  document.getElementById(\"duplicate-modal\").classList.add(\"active\");\r\n};\r\nwindow.linkRelatedComplaints = function() {\r\n  Toast.info(\"Link related complaints feature coming soon\");\r\n};\r\nwindow.showRejectModal = function() {\r\n  document.getElementById(\"reject-modal\").classList.add(\"active\");\r\n};\r\nwindow.openFalseComplaintModal = function() {\r\n  document.getElementById(\"false-complaint-modal\").classList.add(\"active\");\r\n};\r\nwindow.closeModal = function(modalId) {\r\n  document.getElementById(modalId).classList.remove(\"active\");\r\n};\r\n/**\r\n * Handle assign to department\r\n */\r\nwindow.handleAssign = async function(event) {\r\n  event.preventDefault();\r\n  const selectedDepartments = Array.from(document.querySelectorAll(\".dept-check:checked\")).map(el => el.value);\r\n  const priority = document.getElementById(\"assign-priority\").value;\r\n  const deadline = document.getElementById(\"deadline\").value;\r\n  const notes = document.getElementById(\"notes\").value;\r\n  try {\r\n    const response = await fetch(`/api/coordinator/review-queue/${complaintId}/decide`, {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({\r\n        decision: \"assign_department\",\r\n        data: {\r\n          departments: selectedDepartments,\r\n          options: {\r\n            priority,\r\n            deadline: deadline || null,\r\n            notes: notes || null\r\n          }\r\n        }\r\n      })\r\n    });\r\n    const result = await response.json();\r\n    if (!result.success) {\r\n      throw new Error(result.error || \"Failed to assign complaint\");\r\n    }\r\n    Toast.success(\"Complaint assigned successfully!\");\r\n    setTimeout(() => {\r\n      window.location.href = \"/dashboard\";\r\n    }, 1500);\r\n  } catch (error) {\r\n    console.error(\"[REVIEW] Assign error:\", error);\r\n    Toast.error(error.message);\r\n  }\r\n};\r\n/**\r\n * Handle mark as duplicate\r\n */\r\nwindow.handleDuplicate = async function(event) {\r\n  event.preventDefault();\r\n  const masterComplaintId = document.getElementById(\"master-complaint\").value;\r\n  const reason = document.getElementById(\"duplicate-reason\").value;\r\n  try {\r\n    const response = await fetch(`/api/coordinator/review-queue/${complaintId}/decide`, {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({\r\n        decision: \"mark_duplicate\",\r\n        data: {\r\n          masterComplaintId,\r\n          reason\r\n        }\r\n      })\r\n    });\r\n    const result = await response.json();\r\n    if (!result.success) {\r\n      throw new Error(result.error || \"Failed to mark as duplicate\");\r\n    }\r\n    Toast.success(\"Complaint marked as duplicate\");\r\n    setTimeout(() => {\r\n      window.location.href = \"/dashboard\";\r\n    }, 1500);\r\n  } catch (error) {\r\n    console.error(\"[REVIEW] Duplicate error:\", error);\r\n    Toast.error(error.message);\r\n  }\r\n};\r\n/**\r\n * Handle reject complaint\r\n */\r\nwindow.handleReject = async function(event) {\r\n  event.preventDefault();\r\n  const reason = document.getElementById(\"reject-reason\").value;\r\n  try {\r\n    const response = await fetch(`/api/coordinator/review-queue/${complaintId}/decide`, {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({\r\n        decision: \"reject\",\r\n        data: {\r\n          reason\r\n        }\r\n      })\r\n    });\r\n    const result = await response.json();\r\n    if (!result.success) {\r\n      throw new Error(result.error || \"Failed to reject complaint\");\r\n    }\r\n    Toast.success(\"Complaint rejected\");\r\n    setTimeout(() => {\r\n      window.location.href = \"/dashboard\";\r\n    }, 1500);\r\n  } catch (error) {\r\n    console.error(\"[REVIEW] Reject error:\", error);\r\n    Toast.error(error.message);\r\n  }\r\n};\r\n/**\r\n * Handle mark as false complaint\r\n */\r\nwindow.handleFalseComplaint = async function(event) {\r\n  event.preventDefault();\r\n  const reason = document.getElementById(\"false-complaint-reason\").value;\r\n  const notes = document.getElementById(\"false-complaint-notes\").value;\r\n  // Validate that a reason is selected\r\n  if (!reason) {\r\n    Toast.error(\"Please select a reason for marking this complaint as false.\");\r\n    return;\r\n  }\r\n  // Combine reason and notes\r\n  const fullReason = notes ? `${reason}: ${notes}` : reason;\r\n  try {\r\n    const response = await fetch(`/api/coordinator/review-queue/${complaintId}/decide`, {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({\r\n        decision: \"mark_false\",\r\n        data: {\r\n          reason: fullReason\r\n        }\r\n      })\r\n    });\r\n    const result = await response.json();\r\n    if (!result.success) {\r\n      throw new Error(result.error || \"Failed to mark as false complaint\");\r\n    }\r\n    Toast.success(\"Complaint marked as false\");\r\n    setTimeout(() => {\r\n      window.location.href = \"/dashboard\";\r\n    }, 1500);\r\n  } catch (error) {\r\n    console.error(\"[REVIEW] False complaint error:\", error);\r\n    Toast.error(error.message);\r\n  }\r\n};\r\n/**\r\n * Mark complaint as unique (no duplicates)\r\n */\r\nwindow.markAsUnique = async function() {\r\n  try {\r\n    const response = await fetch(`/api/coordinator/review-queue/${complaintId}/decide`, {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({\r\n        decision: \"mark_unique\",\r\n        data: {}\r\n      })\r\n    });\r\n    const result = await response.json();\r\n    if (!result.success) {\r\n      throw new Error(result.error || \"Failed to mark as unique\");\r\n    }\r\n    Toast.success(\"Complaint marked as unique\");\r\n    // Hide similar complaints section\r\n    document.getElementById(\"similar-section\").style.display = \"none\";\r\n    document.getElementById(\"duplicate-btn\").style.display = \"none\";\r\n    document.getElementById(\"related-btn\").style.display = \"none\";\r\n    document.getElementById(\"unique-btn\").style.display = \"none\";\r\n  } catch (error) {\r\n    console.error(\"[REVIEW] Unique error:\", error);\r\n    Toast.error(error.message);\r\n  }\r\n};\r\n/**\r\n * Load departments for assignment modal\r\n */\r\nlet allDepartments = [];\r\nlet filteredDepartments = [];\r\n\r\nasync function loadDepartmentsForAssignment() {\r\n  try {\r\n    allDepartments = await getActiveDepartments();\r\n    filteredDepartments = [...allDepartments];\r\n\r\n    if (allDepartments && allDepartments.length > 0) {\r\n      renderDepartmentsList();\r\n      setupDepartmentSearch();\r\n      updateSelectedCount();\r\n    } else {\r\n      throw new Error(\"No departments available\");\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error loading departments:\", error);\r\n    const departmentsList = document.getElementById(\"departments-list\");\r\n    if (departmentsList) {\r\n      departmentsList.innerHTML = '<p style=\"color: #e74c3c; padding: 10px;\">Failed to load departments. Please refresh the page or contact support.</p>';\r\n    }\r\n  }\r\n}\r\n\r\nfunction renderDepartmentsList() {\r\n  const departmentsList = document.getElementById(\"departments-list\");\r\n  if (!departmentsList) return;\r\n\r\n  if (filteredDepartments.length === 0) {\r\n    departmentsList.innerHTML = '<div class=\"no-results\">No departments match your search</div>';\r\n    return;\r\n  }\r\n\r\n  // Get currently selected departments before re-rendering\r\n  const selectedDepts = new Set(\r\n    Array.from(document.querySelectorAll(\".dept-check:checked\")).map(cb => cb.value)\r\n  );\r\n\r\n  departmentsList.innerHTML = filteredDepartments.map(dept => {\r\n    const deptId = dept.code || dept.id;\r\n    const isChecked = selectedDepts.has(deptId);\r\n    return `\r\n      <label class=\"department-checkbox-label\">\r\n        <input type=\"checkbox\" class=\"dept-check\" value=\"${deptId}\" data-dept-name=\"${escapeHtml(dept.name)}\" ${isChecked ? \"checked\" : \"\"}>\r\n        <span class=\"department-checkbox-text\">\r\n          <span class=\"dept-name\">${escapeHtml(dept.name)}</span>\r\n          ${dept.code ? `<span class=\"dept-code\">${escapeHtml(dept.code)}</span>` : \"\"}\r\n        </span>\r\n      </label>\r\n    `;\r\n  }).join(\"\");\r\n\r\n  // Attach change listeners\r\n  document.querySelectorAll(\".dept-check\").forEach(checkbox => {\r\n    checkbox.addEventListener(\"change\", () => {\r\n      updateSelectedCount();\r\n    });\r\n  });\r\n}\r\n\r\nfunction setupDepartmentSearch() {\r\n  const searchInput = document.getElementById(\"department-search-input\");\r\n  if (!searchInput) return;\r\n\r\n  searchInput.addEventListener(\"input\", (e) => {\r\n    const searchTerm = e.target.value.toLowerCase().trim();\r\n\r\n    if (searchTerm === \"\") {\r\n      filteredDepartments = [...allDepartments];\r\n    } else {\r\n      filteredDepartments = allDepartments.filter(dept => {\r\n        const name = (dept.name || \"\").toLowerCase();\r\n        const code = (dept.code || \"\").toLowerCase();\r\n        return name.includes(searchTerm) || code.includes(searchTerm);\r\n      });\r\n    }\r\n\r\n    renderDepartmentsList();\r\n    updateSelectedCount();\r\n  });\r\n}\r\n\r\nfunction updateSelectedCount() {\r\n  const selectedCheckboxes = document.querySelectorAll(\".dept-check:checked\");\r\n  const count = selectedCheckboxes.length;\r\n  const countEl = document.getElementById(\"selected-departments-count\");\r\n  const countTextEl = document.getElementById(\"selected-count-text\");\r\n\r\n  if (countEl && countTextEl) {\r\n    if (count > 0) {\r\n      countEl.style.display = \"block\";\r\n      countTextEl.textContent = count;\r\n    } else {\r\n      countEl.style.display = \"none\";\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Show error message\r\n */\r\nfunction showError(message) {\r\n  document.getElementById(\"loading\").style.display = \"none\";\r\n  document.getElementById(\"error-message\").style.display = \"block\";\r\n  document.getElementById(\"error-text\").textContent = message;\r\n}\r\n/**\r\n * Render complainant information panel\r\n */\r\nfunction renderComplainantInfo(profile) {\r\n  const contentEl = document.getElementById(\"complainant-info-content\");\r\n  if (!contentEl) return;\r\n\r\n  if (!profile) {\r\n    contentEl.innerHTML = '<div class=\"complainant-empty\">No complainant information available</div>';\r\n    return;\r\n  }\r\n\r\n  const name = profile.name || profile.email || \"Unknown\";\r\n  const email = profile.email || \"Not provided\";\r\n  const firstName = profile.firstName || \"\";\r\n  const lastName = profile.lastName || \"\";\r\n\r\n  // Get phone number from multiple possible fields\r\n  const rawMeta = profile.raw_user_meta_data || {};\r\n  const phoneNumber = profile.mobileNumber ||\r\n                     profile.mobile ||\r\n                     rawMeta.mobile_number ||\r\n                     rawMeta.mobile ||\r\n                     rawMeta.phone_number ||\r\n                     rawMeta.phone ||\r\n                     null;\r\n\r\n  // Get address from metadata - check multiple formats\r\n  const address = rawMeta.address || {};\r\n  const addressParts = [];\r\n\r\n  // Check for address_line_1, address_line_2 format\r\n  if (rawMeta.address_line_1) addressParts.push(rawMeta.address_line_1);\r\n  if (rawMeta.address_line_2) addressParts.push(rawMeta.address_line_2);\r\n\r\n  // Check for nested address object\r\n  if (address.line1) addressParts.push(address.line1);\r\n  if (address.line2) addressParts.push(address.line2);\r\n\r\n  // Check for old format\r\n  if (rawMeta.addressLine1 && !addressParts.includes(rawMeta.addressLine1)) {\r\n    addressParts.push(rawMeta.addressLine1);\r\n  }\r\n  if (rawMeta.addressLine2 && !addressParts.includes(rawMeta.addressLine2)) {\r\n    addressParts.push(rawMeta.addressLine2);\r\n  }\r\n\r\n  // Add city, province, barangay, postal code if available\r\n  if (rawMeta.city || address.city) addressParts.push(rawMeta.city || address.city);\r\n  if (rawMeta.barangay || address.barangay) addressParts.push(rawMeta.barangay || address.barangay);\r\n  if (rawMeta.province || address.province) addressParts.push(rawMeta.province || address.province);\r\n  if (rawMeta.postal_code || address.postalCode) addressParts.push(rawMeta.postal_code || address.postalCode);\r\n\r\n  const fullAddress = addressParts.filter(Boolean).join(\", \") || null;\r\n\r\n  contentEl.innerHTML = `\r\n    <div class=\"complainant-details\">\r\n      <div class=\"complainant-field\">\r\n        <div class=\"complainant-label\">Name</div>\r\n        <div class=\"complainant-value\">${escapeHtml(name)}</div>\r\n      </div>\r\n      ${firstName || lastName ? `\r\n      <div class=\"complainant-field\">\r\n        <div class=\"complainant-label\">Full Name</div>\r\n        <div class=\"complainant-value\">${escapeHtml(`${firstName} ${lastName}`.trim() || name)}</div>\r\n      </div>\r\n      ` : \"\"}\r\n      <div class=\"complainant-field\">\r\n        <div class=\"complainant-label\">Email</div>\r\n        <div class=\"complainant-value\">\r\n          <a href=\"mailto:${escapeHtml(email)}\" class=\"complainant-link\">${escapeHtml(email)}</a>\r\n        </div>\r\n      </div>\r\n      <div class=\"complainant-field\">\r\n        <div class=\"complainant-label\">Phone Number</div>\r\n        <div class=\"complainant-value\">\r\n          ${phoneNumber ? `\r\n          <a href=\"tel:${escapeHtml(phoneNumber)}\" class=\"complainant-link\">${escapeHtml(phoneNumber)}</a>\r\n          ` : '<span style=\"color: #9ca3af;\">Not provided</span>'}\r\n        </div>\r\n      </div>\r\n      <div class=\"complainant-field\">\r\n        <div class=\"complainant-label\">Address</div>\r\n        <div class=\"complainant-value\">\r\n          ${fullAddress ? escapeHtml(fullAddress) : '<span style=\"color: #9ca3af;\">Not provided</span>'}\r\n        </div>\r\n      </div>\r\n      ${profile.id ? `\r\n      <div class=\"complainant-field\">\r\n        <div class=\"complainant-label\">User ID</div>\r\n        <div class=\"complainant-value complainant-id\">${escapeHtml(profile.id.substring(0, 8))}...</div>\r\n      </div>\r\n      ` : \"\"}\r\n    </div>\r\n  `;\r\n}\r\n\r\n/**\r\n * Escape HTML to prevent XSS\r\n */\r\nfunction escapeHtml(text) {\r\n  if (!text) return \"\";\r\n  const div = document.createElement(\"div\");\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n\r\n/**\r\n * Format date\r\n */\r\nfunction formatDate(dateString) {\r\n  if (!dateString) return \"N/A\";\r\n  const date = new Date(dateString);\r\n  const now = new Date();\r\n  const diff = now - date;\r\n  const minutes = Math.floor(diff / 60000);\r\n  const hours = Math.floor(diff / 3600000);\r\n  const days = Math.floor(diff / 86400000);\r\n  if (minutes < 60) return `${minutes} minute${minutes !== 1 ? \"s\" : \"\"} ago`;\r\n  if (hours < 24) return `${hours} hour${hours !== 1 ? \"s\" : \"\"} ago`;\r\n  if (days < 7) return `${days} day${days !== 1 ? \"s\" : \"\"} ago`;\r\n  return date.toLocaleDateString(\"en-US\", {\r\n    year: \"numeric\",\r\n    month: \"short\",\r\n    day: \"numeric\"\r\n  });\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\hr\\dashboard.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":338,"column":10,"nodeType":"CallExpression","messageId":"unexpected","endLine":340,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * HR Dashboard\n * Role management interface for HR personnel\n */\nimport showMessage from \"../components/toast.js\";\n\n// Check for OAuth success message\nconst oauthSuccessMessage = sessionStorage.getItem(\"oauth_success_message\");\nif (oauthSuccessMessage) {\n  sessionStorage.removeItem(\"oauth_success_message\");\n  showMessage(\"success\", oauthSuccessMessage, 5000);\n}\n\n// Initialize dashboard\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\n  await loadDashboardData();\n  await loadDepartmentStats();\n  await loadRoleDistribution();\n  await loadPerformanceData();\n  await loadWorkloadDistribution();\n  await loadBottleneckAlerts();\n  setupFormHandlers();\n  setupUserSearch();\n\n  // Setup refresh button event listener\n  const refreshRoleDistributionBtn = document.getElementById(\n    \"refresh-role-distribution-btn\"\n  );\n  if (refreshRoleDistributionBtn) {\n    refreshRoleDistributionBtn.addEventListener(\"click\", loadRoleDistribution);\n  }\n\n  // Setup quick action buttons (placeholders for future implementation)\n  const promoteUserBtn = document.getElementById(\"promote-user-btn\");\n  if (promoteUserBtn) {\n    promoteUserBtn.addEventListener(\"click\", () => {\n      showMessage(\n        \"info\",\n        \"Please use the User Management section to promote users\"\n      );\n    });\n  }\n\n  const demoteUserBtn = document.getElementById(\"demote-user-btn\");\n  if (demoteUserBtn) {\n    demoteUserBtn.addEventListener(\"click\", () => {\n      showMessage(\n        \"info\",\n        \"Please use the User Management section to demote users\"\n      );\n    });\n  }\n\n  const getHelpBtn = document.getElementById(\"get-help-btn\");\n  if (getHelpBtn) {\n    getHelpBtn.addEventListener(\"click\", () => {\n      showMessage(\"info\", \"Help feature coming soon\");\n    });\n  }\n});\n\n// Chart instance for role distribution\nlet roleDistributionChart = null;\n/**\n * Load dashboard data\n */\nasync function loadDashboardData() {\n  try {\n    const response = await fetch(\"/api/hr/dashboard\");\n    const result = await response.json();\n    if (result.success) {\n      updateStatistics(result.data.statistics);\n    }\n  } catch (error) {\n    console.error(\"[HR] Load dashboard error:\", error);\n  }\n}\n/**\n * Update statistics display\n */\nfunction updateStatistics(stats) {\n  document.getElementById(\"stat-officers\").textContent =\n    stats.total_officers || 0;\n  document.getElementById(\"stat-admins\").textContent = stats.total_admins || 0;\n  document.getElementById(\"stat-promotions\").textContent =\n    stats.promotions_this_month || 0;\n  document.getElementById(\"stat-demotions\").textContent =\n    stats.demotions_this_month || 0;\n}\n/**\n * Load department statistics\n */\nasync function loadDepartmentStats() {\n  try {\n    const response = await fetch(\"/api/hr/users?limit=1000\");\n    const result = await response.json();\n    if (result.success && result.data) {\n      const users = result.data;\n      const departmentStats = calculateDepartmentStats(users);\n      renderDepartmentStats(departmentStats);\n    } else {\n      renderDepartmentStats([]);\n    }\n  } catch (error) {\n    console.error(\"[HR] Load department stats error:\", error);\n    renderDepartmentStats([]);\n  }\n}\n/**\n * Calculate department statistics from user data\n */\nfunction calculateDepartmentStats(users) {\n  const deptMap = new Map();\n  const seenUserIds = new Set();\n  users.forEach((user) => {\n    if (user && user.id) {\n      if (seenUserIds.has(user.id)) return; // avoid double counting same user\n      seenUserIds.add(user.id);\n    }\n    const role = String(user.role || \"\").toLowerCase();\n    // Derive department from multiple sources; skip if missing\n    const department =\n      user.department ||\n      user.dpt ||\n      user?.raw_user_meta_data?.department ||\n      user?.raw_user_meta_data?.dpt ||\n      user?.user_metadata?.department ||\n      user?.user_metadata?.dpt ||\n      null;\n    if (!department) return; // Ignore records without an office to avoid 'Unknown'\n\n    if (!deptMap.has(department)) {\n      deptMap.set(department, { admins: 0, officers: 0 });\n    }\n    const deptStats = deptMap.get(department);\n    // Count admins (lgu-admin-* roles)\n    if (role === \"lgu-admin\" || /^lgu-admin-/.test(role)) {\n      deptStats.admins++;\n      return;\n    }\n    // Count officers: include simplified 'lgu' and legacy lgu-* except admin/hr\n    if (role === \"lgu\" || /^lgu-(?!admin|hr)/.test(role)) {\n      deptStats.officers++;\n    }\n  });\n  return Array.from(deptMap.entries())\n    .map(([dept, stats]) => ({\n      department: dept,\n      admins: stats.admins,\n      officers: stats.officers,\n      total: stats.admins + stats.officers,\n    }))\n    .sort((a, b) => b.total - a.total);\n}\n/**\n * Load role distribution and render pie chart\n */\nwindow.loadRoleDistribution = async function loadRoleDistribution() {\n  try {\n    const response = await fetch(\"/api/hr/role-distribution\");\n    const result = await response.json();\n\n    if (!result.success || !result.distribution) {\n      console.error(\"[HR] Failed to load role distribution:\", result.error);\n      return;\n    }\n\n    const { hr, officers, admins } = result.distribution;\n    renderRoleDistributionChart({ hr, officers, admins });\n  } catch (error) {\n    console.error(\"[HR] Load role distribution error:\", error);\n  }\n};\n\n/**\n * Render role distribution pie chart (HR)\n */\nfunction renderRoleDistributionChart(data) {\n  const canvas = document.getElementById(\"role-distribution-chart\");\n  if (!canvas) return;\n\n  const ctx = canvas.getContext(\"2d\");\n\n  // Destroy existing chart if it exists\n  if (roleDistributionChart) {\n    roleDistributionChart.destroy();\n  }\n\n  const values = [data.hr || 0, data.officers || 0, data.admins || 0];\n  const total = values.reduce((a, b) => a + b, 0);\n\n  const chartData = {\n    labels: [\n      `HR (${values[0]})`,\n      `Officers (${values[1]})`,\n      `Admins (${values[2]})`,\n    ],\n    datasets: [\n      {\n        data: values,\n        backgroundColor: [\n          \"#10b981\", // Green for HR\n          \"#f59e0b\", // Orange for Officers\n          \"#8b5cf6\", // Purple for Admins\n        ],\n        borderColor: \"#ffffff\",\n        borderWidth: 2,\n      },\n    ],\n  };\n\n  roleDistributionChart = new Chart(ctx, {\n    type: \"pie\",\n    data: chartData,\n    options: {\n      responsive: true,\n      maintainAspectRatio: true,\n      plugins: {\n        legend: {\n          position: \"bottom\",\n          labels: {\n            padding: 15,\n            font: {\n              size: 14,\n            },\n            generateLabels(chart) {\n              const { data } = chart;\n              if (data.labels.length && data.datasets.length) {\n                return data.labels.map((label, i) => {\n                  const value = data.datasets[0].data[i];\n                  const percentage =\n                    total > 0 ? ((value / total) * 100).toFixed(1) : 0;\n                  return {\n                    text: `${label} - ${percentage}%`,\n                    fillStyle: data.datasets[0].backgroundColor[i],\n                    strokeStyle: data.datasets[0].borderColor,\n                    lineWidth: data.datasets[0].borderWidth,\n                    hidden: false,\n                    index: i,\n                  };\n                });\n              }\n              return [];\n            },\n          },\n        },\n        tooltip: {\n          callbacks: {\n            label(context) {\n              const label = context.label || \"\";\n              const value = context.parsed || 0;\n              const total = context.dataset.data.reduce((a, b) => a + b, 0);\n              const percentage =\n                total > 0 ? ((value / total) * 100).toFixed(1) : 0;\n              return `${label.split(\" (\")[0]}: ${value} users (${percentage}%)`;\n            },\n          },\n        },\n      },\n    },\n  });\n}\n\n/**\n * Render department statistics\n */\nfunction renderDepartmentStats(stats) {\n  const container = document.getElementById(\"department-stats\");\n  if (!container) return;\n  if (!stats.length) {\n    container.innerHTML =\n      '<p style=\"color: #7f8c8d; text-align: center; padding: 20px;\">No department data available.</p>';\n    return;\n  }\n  const html = stats\n    .map(\n      (dept) => `\n    <div class=\"dept-stat-card\">\n      <h3>${escapeHtml(dept.department)}</h3>\n      <div class=\"dept-counts\">\n        <div class=\"dept-count\">\n          <div class=\"dept-count-value\">${dept.admins}</div>\n          <div class=\"dept-count-label\">Admins</div>\n        </div>\n        <div class=\"dept-count\">\n          <div class=\"dept-count-value\">${dept.officers}</div>\n          <div class=\"dept-count-label\">Officers</div>\n        </div>\n        <div class=\"dept-count\">\n          <div class=\"dept-count-value\">${dept.total}</div>\n          <div class=\"dept-count-label\">Total</div>\n        </div>\n      </div>\n    </div>\n  `\n    )\n    .join(\"\");\n  container.innerHTML = html;\n}\n/**\n * Setup form handlers\n */\nfunction setupFormHandlers() {\n  // Forms are optional (they may be removed from the page)\n  const promoteOfficerForm = document.getElementById(\"promote-officer-form\");\n  if (promoteOfficerForm)\n    promoteOfficerForm.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const userId = document.getElementById(\"promote-officer-user\").value;\n      const department = document.getElementById(\"promote-officer-dept\").value;\n      const reason = document.getElementById(\"promote-officer-reason\").value;\n      await promoteToOfficer(userId, department, reason);\n    });\n  const promoteAdminForm = document.getElementById(\"promote-admin-form\");\n  if (promoteAdminForm)\n    promoteAdminForm.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const userId = document.getElementById(\"promote-admin-user\").value;\n      const department = document.getElementById(\"promote-admin-dept\").value;\n      const reason = document.getElementById(\"promote-admin-reason\").value;\n      await promoteToAdmin(userId, department, reason);\n    });\n  const demoteOfficerForm = document.getElementById(\"demote-officer-form\");\n  if (demoteOfficerForm)\n    demoteOfficerForm.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const userId = document.getElementById(\"demote-officer-user\").value;\n      const reason = document.getElementById(\"demote-officer-reason\").value;\n      await demoteToOfficer(userId, reason);\n    });\n  const stripTitlesForm = document.getElementById(\"strip-titles-form\");\n  if (stripTitlesForm)\n    stripTitlesForm.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const userId = document.getElementById(\"strip-titles-user\").value;\n      const reason = document.getElementById(\"strip-titles-reason\").value;\n      if (\n        !confirm(\n          \"Are you sure you want to strip all titles from this user? This will revert them to citizen status.\"\n        )\n      ) {\n        return;\n      }\n      await stripTitles(userId, reason);\n    });\n  const assignDeptForm = document.getElementById(\"assign-dept-form\");\n  if (assignDeptForm)\n    assignDeptForm.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const userId = document.getElementById(\"assign-dept-user\").value;\n      const departmentId = document.getElementById(\"assign-dept-id\").value;\n      await assignDepartment(userId, departmentId);\n    });\n  const roleHistoryForm = document.getElementById(\"role-history-form\");\n  if (roleHistoryForm)\n    roleHistoryForm.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const userId = document.getElementById(\"role-history-user\").value;\n      await viewRoleHistory(userId);\n    });\n}\n\n// Pending Signup Approvals Panel\nasync function loadPendingSignups() {\n  try {\n    const res = await fetch(\"/api/hr/pending-signups\");\n    const json = await res.json();\n    const container = document.getElementById(\"pending-signups\");\n    if (!container) return;\n    if (!json.success) {\n      container.innerHTML =\n        '<p style=\"color:#7f8c8d;\">Failed to load pending signups</p>';\n      return;\n    }\n    const users = json.data || [];\n    if (users.length === 0) {\n      container.innerHTML = '<p style=\"color:#7f8c8d;\">No pending signups.</p>';\n      return;\n    }\n    container.innerHTML = users\n      .map((u) => {\n        const name = u.name || u.fullName || u.email || u.id;\n        const dept =\n          u?.raw_user_meta_data?.pending_department ||\n          u?.user_metadata?.pending_department ||\n          \"-\";\n        const role =\n          u?.raw_user_meta_data?.pending_role ||\n          u?.user_metadata?.pending_role ||\n          \"-\";\n        return `\n        <div class=\"user-item\">\n          <div class=\"user-item-name\">${escapeHtml(name)}</div>\n          <div class=\"user-item-email\">${escapeHtml(u.email || \"\")}</div>\n          <div class=\"user-item-role\">Requested: ${escapeHtml(\n    role\n  )} @ ${escapeHtml(String(dept))}</div>\n          <div style=\"margin-top:8px; display:flex; gap:8px;\">\n            <button class=\"btn btn-success btn-sm\" data-approve=\"${\n  u.id\n}\">Approve</button>\n            <button class=\"btn btn-danger btn-sm\" data-reject=\"${\n  u.id\n}\">Reject</button>\n          </div>\n        </div>`;\n      })\n      .join(\"\");\n    // Bind actions\n    container.querySelectorAll(\"[data-approve]\").forEach((btn) => {\n      btn.addEventListener(\"click\", async () => {\n        const id = btn.getAttribute(\"data-approve\");\n        await approvePending(id);\n      });\n    });\n    container.querySelectorAll(\"[data-reject]\").forEach((btn) => {\n      btn.addEventListener(\"click\", async () => {\n        const id = btn.getAttribute(\"data-reject\");\n        await rejectPending(id);\n      });\n    });\n  } catch (e) {\n    const container = document.getElementById(\"pending-signups\");\n    if (container)\n      container.innerHTML =\n        '<p style=\"color:#7f8c8d;\">Failed to load pending signups</p>';\n  }\n}\n\nasync function approvePending(userId) {\n  try {\n    const res = await fetch(\n      `/api/hr/pending-signups/${encodeURIComponent(userId)}/approve`,\n      { method: \"POST\" }\n    );\n    const json = await res.json();\n    if (json.success) {\n      showMessage(\"success\", \"Approved\");\n      await loadPendingSignups();\n      await loadDashboardData();\n    } else {\n      showMessage(\"error\", json.error || \"Failed to approve\");\n    }\n  } catch (e) {\n    showMessage(\"error\", \"Failed to approve\");\n  }\n}\n\nasync function rejectPending(userId) {\n  try {\n    const res = await fetch(\n      `/api/hr/pending-signups/${encodeURIComponent(userId)}/reject`,\n      { method: \"POST\" }\n    );\n    const json = await res.json();\n    if (json.success) {\n      showMessage(\"success\", \"Rejected\");\n      await loadPendingSignups();\n      await loadDashboardData();\n    } else {\n      showMessage(\"error\", json.error || \"Failed to reject\");\n    }\n  } catch (e) {\n    showMessage(\"error\", \"Failed to reject\");\n  }\n}\n\n// Kick-off pending list load when dashboard is ready\ntry {\n  loadPendingSignups();\n} catch {}\n/**\n * User search & detail wiring\n */\nfunction setupUserSearch() {\n  const searchBtn = document.getElementById(\"user-search-btn\");\n  const searchInput = document.getElementById(\"user-search-input\");\n  const barangayInput = document.getElementById(\"user-filter-barangay\");\n  async function runSearch() {\n    const q = encodeURIComponent(searchInput.value || \"\");\n    const brgy = encodeURIComponent(barangayInput.value || \"\");\n    const url = `/api/hr/users?search=${q}${brgy ? `&barangay=${brgy}` : \"\"}`;\n    try {\n      const res = await fetch(url);\n      const result = await res.json();\n      if (result.success) {\n        renderUserList(result.data || []);\n      } else {\n        renderUserList([]);\n      }\n    } catch (err) {\n      console.error(\"[HR] user search error:\", err);\n      renderUserList([]);\n    }\n  }\n  if (searchBtn) searchBtn.addEventListener(\"click\", runSearch);\n  if (searchInput)\n    searchInput.addEventListener(\"keypress\", (e) => {\n      if (e.key === \"Enter\") runSearch();\n    });\n}\nfunction renderUserList(users) {\n  const list = document.getElementById(\"user-list\");\n  if (!list) return;\n  if (!users.length) {\n    list.innerHTML =\n      '<p style=\"color:#7f8c8d; padding:8px;\">No users found.</p>';\n    return;\n  }\n  list.innerHTML = users\n    .map(\n      (u) =>\n        `<div class=\"user-item\" data-user-id=\"${u.id}\">\n      <div><strong>${escapeHtml(u.fullName || u.name || u.email)}</strong></div>\n      <div class=\"user-meta\">${escapeHtml(u.email || \"\")}</div>\n      <div class=\"user-meta\">Role: ${escapeHtml(\n    u.role || \"\"\n  )} | Brgy: ${escapeHtml(u.address?.barangay || \"-\")}</div>\n    </div>`\n    )\n    .join(\"\");\n\n  // Click to load details\n  list.querySelectorAll(\".user-item\").forEach((el) => {\n    el.addEventListener(\"click\", async () => {\n      const id = el.getAttribute(\"data-user-id\");\n      await loadUserDetails(id);\n      await loadUserComplaints(id);\n    });\n  });\n}\n\nasync function loadUserDetails(userId) {\n  try {\n    const res = await fetch(`/api/hr/users/${userId}`);\n    const result = await res.json();\n    const container = document.getElementById(\"user-details\");\n    if (!container) return;\n    if (result.success && result.data) {\n      const u = result.data;\n      container.innerHTML = `\n        <div style=\"display:flex; gap:16px; align-items:center;\">\n          <div style=\"width:48px; height:48px; border-radius:50%; background:#eee;\"></div>\n          <div>\n            <div style=\"font-weight:700; font-size:1.1rem;\">${escapeHtml(\n    u.fullName || u.name || u.email\n  )}</div>\n            <div class=\"user-meta\">${escapeHtml(u.email || \"\")}</div>\n          </div>\n        </div>\n        <div style=\"margin-top:12px; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px;\">\n          <div><strong>Role:</strong> ${escapeHtml(u.role || \"\")}</div>\n          <div><strong>Department:</strong> ${escapeHtml(\n    u.department || \"-\"\n  )}</div>\n          <div><strong>Barangay:</strong> ${escapeHtml(\n    u.address?.barangay || \"-\"\n  )}</div>\n          <div><strong>City:</strong> ${escapeHtml(\n    u.address?.city || \"-\"\n  )}</div>\n          <div><strong>Mobile:</strong> ${escapeHtml(\n    u.mobileNumber || \"-\"\n  )}</div>\n        </div>\n      `;\n    } else {\n      container.innerHTML =\n        '<p style=\"color:#e74c3c;\">Failed to load user.</p>';\n    }\n  } catch (err) {\n    console.error(\"[HR] load user details error:\", err);\n  }\n}\nasync function loadUserComplaints(userId) {\n  try {\n    const res = await fetch(`/api/hr/users/${userId}/complaints?limit=10`);\n    const result = await res.json();\n    const container = document.getElementById(\"user-complaints\");\n    if (!container) return;\n    if (result.success) {\n      const complaints = result.data || [];\n      if (!complaints.length) {\n        container.innerHTML =\n          '<p style=\"color:#7f8c8d;\">No complaints found.</p>';\n        return;\n      }\n      container.innerHTML = complaints\n        .map(\n          (c) => `\n        <div style=\"padding:12px; border:1px solid #eee; border-radius:6px; margin-bottom:8px; background:#fafafa;\">\n          <div style=\"display:flex; justify-content:space-between;\">\n            <strong>${escapeHtml(c.title || \"Untitled\")}</strong>\n            <span class=\"user-meta\">${escapeHtml(c.status || \"\")}</span>\n          </div>\n          <div class=\"user-meta\">Type: ${escapeHtml(c.type || \"-\")}</div>\n          ${\n  c.location_text\n    ? `<div class=\"user-meta\">${escapeHtml(c.location_text)}</div>`\n    : \"\"\n}\n        </div>\n      `\n        )\n        .join(\"\");\n    } else {\n      container.innerHTML =\n        '<p style=\"color:#e74c3c;\">Failed to load complaints.</p>';\n    }\n  } catch (err) {\n    console.error(\"[HR] load user complaints error:\", err);\n  }\n}\nfunction escapeHtml(s) {\n  if (s == null) return \"\";\n  return String(s)\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/'/g, \"&#39;\");\n}\n/**\n * Promote to Officer\n */\nasync function promoteToOfficer(userId, department, reason) {\n  try {\n    const response = await fetch(\"/api/hr/promote-to-officer\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        user_id: userId,\n        department,\n        reason,\n      }),\n    });\n    const result = await response.json();\n    if (result.success) {\n      showMessage(\"success\", result.message);\n      document.getElementById(\"promote-officer-form\").reset();\n      await loadDashboardData();\n    } else {\n      showMessage(\"error\", result.error);\n    }\n  } catch (error) {\n    console.error(\"[HR] Promote to officer error:\", error);\n    showMessage(\"error\", \"Failed to promote user\");\n  }\n}\n/**\n * Promote to Admin\n */\nasync function promoteToAdmin(userId, department, reason) {\n  try {\n    const response = await fetch(\"/api/hr/promote-to-admin\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        user_id: userId,\n        department,\n        reason,\n      }),\n    });\n    const result = await response.json();\n    if (result.success) {\n      showMessage(\"success\", result.message);\n      document.getElementById(\"promote-admin-form\").reset();\n      await loadDashboardData();\n    } else {\n      showMessage(\"error\", result.error);\n    }\n  } catch (error) {\n    console.error(\"[HR] Promote to admin error:\", error);\n    showMessage(\"error\", \"Failed to promote user\");\n  }\n}\n/**\n * Demote to Officer\n */\nasync function demoteToOfficer(userId, reason) {\n  try {\n    const response = await fetch(\"/api/hr/demote-to-officer\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        user_id: userId,\n        reason,\n      }),\n    });\n    const result = await response.json();\n    if (result.success) {\n      showMessage(\"success\", result.message);\n      document.getElementById(\"demote-officer-form\").reset();\n      await loadDashboardData();\n    } else {\n      showMessage(\"error\", result.error);\n    }\n  } catch (error) {\n    console.error(\"[HR] Demote to officer error:\", error);\n    showMessage(\"error\", \"Failed to demote user\");\n  }\n}\n/**\n * Strip Titles\n */\nasync function stripTitles(userId, reason) {\n  try {\n    const response = await fetch(\"/api/hr/strip-titles\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        user_id: userId,\n        reason,\n      }),\n    });\n    const result = await response.json();\n    if (result.success) {\n      showMessage(\"success\", result.message);\n      document.getElementById(\"strip-titles-form\").reset();\n      await loadDashboardData();\n    } else {\n      showMessage(\"error\", result.error);\n    }\n  } catch (error) {\n    console.error(\"[HR] Strip titles error:\", error);\n    showMessage(\"error\", \"Failed to strip titles\");\n  }\n}\n/**\n * Assign Department\n */\nasync function assignDepartment(userId, departmentId) {\n  try {\n    const response = await fetch(\"/api/hr/assign-department\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        user_id: userId,\n        department_id: departmentId,\n      }),\n    });\n    const result = await response.json();\n    if (result.success) {\n      showMessage(\"success\", result.message);\n      document.getElementById(\"assign-dept-form\").reset();\n    } else {\n      showMessage(\"error\", result.error);\n    }\n  } catch (error) {\n    console.error(\"[HR] Assign department error:\", error);\n    showMessage(\"error\", \"Failed to assign department\");\n  }\n}\n/**\n * View Role History\n */\nasync function viewRoleHistory(userId) {\n  try {\n    const response = await fetch(`/api/hr/role-history/${userId}`);\n    const result = await response.json();\n    const container = document.getElementById(\"role-history-results\");\n    if (result.success && result.history) {\n      if (result.history.length === 0) {\n        container.innerHTML =\n          '<p style=\"color: #7f8c8d;\">No role history found for this user.</p>';\n        return;\n      }\n      const html = `\n        <div style=\"margin-top: 20px;\">\n          <h4>Role Change History</h4>\n          <div style=\"max-height: 400px; overflow-y: auto;\">\n            ${result.history\n    .map(\n      (entry) => `\n              <div style=\"padding: 15px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; background: #f9f9f9;\">\n                <div style=\"display: flex; justify-content: space-between; margin-bottom: 8px;\">\n                  <strong>${entry.old_role} → ${entry.new_role}</strong>\n                  <span style=\"color: #7f8c8d; font-size: 0.9rem;\">${new Date(\n    entry.created_at\n  ).toLocaleString()}</span>\n                </div>\n                ${\n  entry.metadata && entry.metadata.reason\n    ? `<div style=\"color: #555;\">Reason: ${entry.metadata.reason}</div>`\n    : \"\"\n}\n              </div>\n            `\n    )\n    .join(\"\")}\n          </div>\n        </div>\n      `;\n      container.innerHTML = html;\n    } else {\n      container.innerHTML =\n        '<p style=\"color: #e74c3c;\">Failed to load role history.</p>';\n    }\n  } catch (error) {\n    console.error(\"[HR] View role history error:\", error);\n    showMessage(\"error\", \"Failed to load role history\");\n  }\n}\n\n/**\n * Load and render performance data\n */\nwindow.refreshPerformance = async function refreshPerformance() {\n  await loadPerformanceData();\n  await loadWorkloadDistribution();\n  await loadBottleneckAlerts();\n};\n\nasync function loadPerformanceData() {\n  try {\n    const response = await fetch(\"/api/hr/performance-summary\");\n    const result = await response.json();\n    if (result.success) {\n      const stats = result.data;\n      document.getElementById(\"hr-total-handled\").textContent =\n        stats.total_handled || 0;\n      document.getElementById(\"hr-resolution-rate\").textContent = `${\n        stats.resolution_rate || 0\n      }%`;\n      document.getElementById(\"hr-avg-time\").textContent =\n        stats.avg_resolution_time || \"N/A\";\n    }\n  } catch (error) {\n    console.error(\"[HR] Load performance data error:\", error);\n  }\n}\n\n/**\n * Load and render workload distribution chart\n */\nlet workloadChart = null;\nasync function loadWorkloadDistribution() {\n  try {\n    const response = await fetch(\"/api/hr/workload-distribution\");\n    const result = await response.json();\n    if (result.success) {\n      renderWorkloadChart(result.data);\n    }\n  } catch (error) {\n    console.error(\"[HR] Load workload distribution error:\", error);\n  }\n}\n\nfunction renderWorkloadChart(data) {\n  const canvas = document.getElementById(\"workload-chart\");\n  if (!canvas) return;\n  const ctx = canvas.getContext(\"2d\");\n  if (workloadChart) workloadChart.destroy();\n\n  workloadChart = new Chart(ctx, {\n    type: \"bar\",\n    data: {\n      labels: data.map((d) => d.name),\n      datasets: [\n        {\n          label: \"Current Tasks\",\n          data: data.map((d) => d.task_count),\n          backgroundColor: \"#3b82f6\",\n          borderRadius: 4,\n        },\n      ],\n    },\n    options: {\n      responsive: true,\n      plugins: { legend: { display: false } },\n      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },\n    },\n  });\n}\n\n/**\n * Load and render bottleneck alerts\n */\nasync function loadBottleneckAlerts() {\n  const container = document.getElementById(\"bottleneck-alerts\");\n  if (!container) return;\n  try {\n    const response = await fetch(\"/api/hr/bottlenecks\");\n    const result = await response.json();\n    if (result.success && result.data.length > 0) {\n      container.innerHTML = result.data\n        .map(\n          (alert) => `\n        <div class=\"alert-item p-3 border-l-4 border-yellow-400 bg-yellow-50 rounded flex justify-between items-center animate-fade-in\">\n          <div>\n            <div class=\"font-bold text-yellow-800\">${escapeHtml(\n    alert.message\n  )}</div>\n            <div class=\"text-xs text-yellow-600\">${escapeHtml(\n    alert.department\n  )} - ${alert.count} overdue tasks</div>\n          </div>\n          <button class=\"btn btn-sm btn-outline-warning\" onclick=\"escalateBottleneck('${\n  alert.department\n}')\">Escalate</button>\n        </div>\n      `\n        )\n        .join(\"\");\n    } else {\n      container.innerHTML =\n        '<p class=\"text-sm text-gray-500 text-center p-4\">No significant bottlenecks detected at this time.</p>';\n    }\n  } catch (error) {\n    console.error(\"[HR] Load bottlenecks error:\", error);\n    container.innerHTML =\n      '<p class=\"text-sm text-red-500 text-center p-4\">Failed to check for bottlenecks.</p>';\n  }\n}\n\nwindow.escalateBottleneck = function (dept) {\n  showMessage(\"info\", `Escalating bottleneck in ${dept}...`);\n  // Mock escalate API call\n  setTimeout(\n    () => showMessage(\"success\", `Escalation notice sent to ${dept} Admin`),\n    1000\n  );\n};\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\hr\\linkGenerator.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":405,"column":10,"nodeType":"CallExpression","messageId":"unexpected","endLine":405,"endColumn":67}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * HR Link Generator\r\n * Handles signup link generation and management\r\n */\r\nimport apiClient from \"../config/apiClient.js\";\r\nimport showMessage from \"../components/toast.js\";\r\n\r\nclass LinkGenerator {\r\n\r\n  constructor() {\r\n    this.links = [];\r\n    this.departments = [];\r\n    this.init();\r\n  }\r\n  async init() {\r\n    await this.loadDepartments();\r\n    await this.loadLinks();\r\n    this.setupEventListeners();\r\n  }\r\n  setupEventListeners() {\r\n    const form = document.getElementById(\"linkForm\");\r\n    if (form) {\r\n      form.addEventListener(\"submit\", (e) => this.handleSubmit(e));\r\n    }\r\n\r\n    // Generate New Link button\r\n    const generateBtn = document.getElementById(\"generateNewLinkBtn\");\r\n    if (generateBtn) {\r\n      generateBtn.addEventListener(\"click\", () => this.generateLink());\r\n    }\r\n\r\n    // Cancel button\r\n    const cancelBtn = document.getElementById(\"cancelGenerateBtn\");\r\n    if (cancelBtn) {\r\n      cancelBtn.addEventListener(\"click\", () => this.cancelGenerate());\r\n    }\r\n\r\n    // Copy link button\r\n    const copyBtn = document.getElementById(\"copyLinkBtn\");\r\n    if (copyBtn) {\r\n      copyBtn.addEventListener(\"click\", () => this.copyLink());\r\n    }\r\n\r\n    // Filter selects\r\n    const roleFilter = document.getElementById(\"roleFilter\");\r\n    if (roleFilter) {\r\n      roleFilter.addEventListener(\"change\", () => this.filterLinks());\r\n    }\r\n\r\n    const statusFilter = document.getElementById(\"statusFilter\");\r\n    if (statusFilter) {\r\n      statusFilter.addEventListener(\"change\", () => this.filterLinks());\r\n    }\r\n  }\r\n  async loadDepartments() {\r\n    try {\r\n      const response = await apiClient.getActiveDepartments();\r\n      if (response.success) {\r\n        this.departments = response.data;\r\n        // Get user role to determine department restrictions\r\n        const userRole = await this.getUserRole();\r\n        await this.filterDepartmentsByRole(userRole);\r\n        this.populateDepartmentSelect();\r\n        await this.setupRoleRestrictions(userRole);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to load departments:\", error);\r\n    }\r\n  }\r\n  async getUserRole() {\r\n    try {\r\n      const response = await apiClient.get(\"/api/user/role-info\");\r\n      return response.data?.role || \"citizen\";\r\n    } catch (error) {\r\n      console.error(\"Failed to get user role:\", error);\r\n      return \"citizen\";\r\n    }\r\n  }\r\n  async getHRDepartment(userRole) {\r\n    if (userRole && userRole === \"lgu-hr\") {\r\n      // Get department from API endpoint which has complete metadata\r\n      try {\r\n        const response = await apiClient.get(\"/api/user/role-info\");\r\n        if (response.success && response.data) {\r\n          // First try direct department field from API response\r\n          if (response.data.department) {\r\n            return response.data.department.toUpperCase();\r\n          }\r\n          // Then try metadata fields\r\n          const metadata = response.data.metadata || response.data;\r\n          const department = metadata.department ||\r\n                             metadata.dpt ||\r\n                             metadata.raw_user_meta_data?.department ||\r\n                             metadata.raw_user_meta_data?.dpt ||\r\n                             metadata.user_metadata?.department ||\r\n                             metadata.user_metadata?.dpt;\r\n          if (department) {\r\n            return department.toUpperCase();\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.warn(\"Failed to get department from API:\", error);\r\n      }\r\n      // Fallback: try Supabase session metadata\r\n      try {\r\n        const { supabase } = await import(\"../../config/config.js\");\r\n        const { data: { session } } = await supabase.auth.getSession();\r\n        const metadata = session?.user?.raw_user_meta_data || session?.user?.user_metadata || {};\r\n        const department = metadata.department || metadata.dpt;\r\n        if (department) {\r\n          return department.toUpperCase();\r\n        }\r\n      } catch (error) {\r\n        console.warn(\"Failed to get department from session:\", error);\r\n      }\r\n      // Last resort: return null instead of hardcoded 'WST'\r\n      console.warn(\"No department found in user metadata\");\r\n      return null;\r\n    }\r\n    return null;\r\n  }\r\n  async filterDepartmentsByRole(userRole) {\r\n    // If user is LGU-HR, filter to only their department\r\n    if (userRole === \"lgu-hr\") {\r\n      const userDepartment = await this.getHRDepartment(userRole);\r\n      this.departments = this.departments.filter(dept =>\r\n        dept.code === userDepartment.toUpperCase()\r\n      );\r\n    }\r\n    // Coordinators and super-admin can see all departments\r\n  }\r\n  async setupRoleRestrictions(userRole) {\r\n    // console.log removed for security\r\n    const roleSelect = document.getElementById(\"role\");\r\n    const roleInfo = document.getElementById(\"role-info\");\r\n    const roleDescription = document.getElementById(\"role-description\");\r\n    if (userRole === \"lgu-hr\") {\r\n      // LGU-HR can only create officer or admin roles\r\n      const options = roleSelect.querySelectorAll(\"option\");\r\n      options.forEach(option => {\r\n        if (![\"lgu-officer\", \"lgu-admin\"].includes(option.value)) {\r\n          option.style.display = \"none\";\r\n        }\r\n      });\r\n      // Get HR user's department dynamically from metadata\r\n      const hrDepartment = await this.getHRDepartment(userRole);\r\n      if (!hrDepartment) {\r\n        // If no department found, show a generic message\r\n        if (roleInfo && roleDescription) {\r\n          roleDescription.textContent = \"As an LGU-HR, you can only create signup links for your assigned department with officer or admin roles. Please contact your administrator if your department is not set.\";\r\n          roleInfo.style.display = \"block\";\r\n        }\r\n        return;\r\n      }\r\n      const departmentName = this.getDepartmentName(hrDepartment);\r\n      // console.log removed for security\r\n      // Hide the department field completely for LGU-HR\r\n      const departmentField = document.querySelector(\".form-group:has(#department)\");\r\n      if (departmentField) {\r\n        departmentField.style.display = \"none\";\r\n      }\r\n      // Show role info with dynamic department\r\n      if (roleInfo && roleDescription) {\r\n        // Only show department code if name lookup failed\r\n        const displayText = departmentName && departmentName !== hrDepartment\r\n          ? `${departmentName} (${hrDepartment})`\r\n          : hrDepartment;\r\n        roleDescription.textContent = `As an LGU-HR, you can only create signup links for ${displayText} department with officer or admin roles.`;\r\n        roleInfo.style.display = \"block\";\r\n      }\r\n    } else if (userRole === \"complaint-coordinator\") {\r\n      // Show coordinator info\r\n      if (roleInfo && roleDescription) {\r\n        roleDescription.textContent = \"As a Complaint Coordinator, you can create signup links for any department and any position.\";\r\n        roleInfo.style.display = \"block\";\r\n      }\r\n    } else if (userRole === \"super-admin\") {\r\n      // Show super admin info\r\n      if (roleInfo && roleDescription) {\r\n        roleDescription.textContent = \"As a Super Admin, you have full access to create signup links for any department and any position.\";\r\n        roleInfo.style.display = \"block\";\r\n      }\r\n    }\r\n  }\r\n  getDepartmentName(departmentCode) {\r\n    if (!departmentCode) return null;\r\n    // Try to find department name from loaded departments\r\n    const dept = this.departments.find(d =>\r\n      d.code === departmentCode ||\r\n      d.code === departmentCode.toUpperCase() ||\r\n      d.code?.toUpperCase() === departmentCode.toUpperCase()\r\n    );\r\n    if (dept && dept.name) {\r\n      return dept.name;\r\n    }\r\n    // Return null if not found (not the code itself)\r\n    return null;\r\n  }\r\n  populateDepartmentSelect() {\r\n    const select = document.getElementById(\"department\");\r\n    if (!select) return;\r\n    select.innerHTML = '<option value=\"\">Select Department (Optional)</option>';\r\n    this.departments.forEach(dept => {\r\n      const option = document.createElement(\"option\");\r\n      option.value = dept.code;\r\n      option.textContent = `${dept.name} (${dept.code})`;\r\n      select.appendChild(option);\r\n    });\r\n  }\r\n  async loadLinks() {\r\n    try {\r\n      const response = await apiClient.getSignupLinks();\r\n      if (response.success) {\r\n        // console.log removed for security\r\n        this.links = response.data;\r\n        this.renderLinks();\r\n        this.updateStats();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to load links:\", error);\r\n      showMessage(\"error\", \"Failed to load signup links\");\r\n    }\r\n  }\r\n  renderLinks() {\r\n    const container = document.getElementById(\"linksList\");\r\n    if (!container) return;\r\n    if (this.links.length === 0) {\r\n      container.innerHTML = '<div class=\"no-links\">No signup links generated yet</div>';\r\n      return;\r\n    }\r\n    container.innerHTML = this.links.map((link, _index) => {\r\n      // console.log removed for security\r\n      return `\r\n      <div class=\"link-item ${link.is_expired ? \"expired\" : \"\"} ${link.is_used ? \"used\" : \"\"}\" data-link-id=\"${link.id}\">\r\n        <div class=\"link-item-header\">\r\n          <span class=\"link-role\">${this.getRoleDisplayName(link.role)}</span>\r\n          <span class=\"link-status ${this.getStatusClass(link)}\">${this.getStatusText(link)}</span>\r\n        </div>\r\n        <div class=\"link-details\">\r\n          <div><strong>Department:</strong> ${link.department_code || \"Any\"}</div>\r\n          <div><strong>Created:</strong> ${this.formatDate(link.created_at)}</div>\r\n          <div><strong>Expires:</strong> ${link.expires_at ? this.formatDate(link.expires_at) : \"Never\"}</div>\r\n        </div>\r\n        <div class=\"link-details\">\r\n          <div><strong>Code:</strong> ${link.code}</div>\r\n          <div><strong>Used:</strong> ${link.used_at ? this.formatDate(link.used_at) : \"Not used\"}</div>\r\n          <div><strong>URL:</strong> ${!link.is_used ? `<a href=\"${link.url}\" target=\"_blank\">Open Link</a>` : '<span style=\"color: #9ca3af; font-style: italic;\">Link used</span>'}</div>\r\n        </div>\r\n        <div class=\"link-actions\">\r\n          ${!link.is_used ? `\r\n          <button class=\"btn btn-sm btn-primary copy-link-url-btn\" data-link-url=\"${encodeURIComponent(link.url)}\">\r\n            Copy URL\r\n          </button>\r\n          ` : \"\"}\r\n          ${!link.is_used && !link.is_expired ? `\r\n            <button class=\"btn btn-sm btn-warning deactivate-link-btn\" data-link-id=\"${link.id}\">\r\n              Deactivate\r\n            </button>\r\n          ` : \"\"}\r\n        </div>\r\n      </div>\r\n    `;\r\n    }).join(\"\");\r\n\r\n    // Attach event listeners to dynamically generated buttons\r\n    this.attachLinkEventListeners(container);\r\n  }\r\n  attachLinkEventListeners(container) {\r\n    // Copy URL buttons\r\n    container.querySelectorAll(\".copy-link-url-btn\").forEach(btn => {\r\n      btn.addEventListener(\"click\", (_e) => {\r\n        const url = btn.getAttribute(\"data-link-url\");\r\n        if (url) {\r\n          this.copyLinkUrl(decodeURIComponent(url));\r\n        }\r\n      });\r\n    });\r\n\r\n    // Deactivate buttons\r\n    container.querySelectorAll(\".deactivate-link-btn\").forEach(btn => {\r\n      btn.addEventListener(\"click\", (_e) => {\r\n        const linkId = btn.getAttribute(\"data-link-id\");\r\n        if (linkId) {\r\n          this.deactivateLink(linkId);\r\n        }\r\n      });\r\n    });\r\n  }\r\n  escapeHtml(text) {\r\n    const div = document.createElement(\"div\");\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n  updateStats() {\r\n    const totalElement = document.getElementById(\"totalLinks\");\r\n    const activeElement = document.getElementById(\"activeLinks\");\r\n    const usedElement = document.getElementById(\"usedLinks\");\r\n    if (totalElement) totalElement.textContent = this.links.length;\r\n    if (activeElement) activeElement.textContent = this.links.filter(l => !l.is_used && !l.is_expired).length;\r\n    if (usedElement) usedElement.textContent = this.links.filter(l => l.is_used).length;\r\n  }\r\n  getRoleDisplayName(role) {\r\n    const roleMap = {\r\n      \"lgu-officer\": \"LGU Officer\",\r\n      \"lgu-admin\": \"LGU Admin\",\r\n      \"lgu-hr\": \"LGU HR\"\r\n    };\r\n    return roleMap[role] || role;\r\n  }\r\n  getStatusClass(link) {\r\n    if (link.is_used) return \"status-used\";\r\n    if (link.is_expired) return \"status-expired\";\r\n    return \"status-active\";\r\n  }\r\n  getStatusText(link) {\r\n    if (link.is_used) return \"Used\";\r\n    if (link.is_expired) return \"Expired\";\r\n    return \"Active\";\r\n  }\r\n  formatDate(dateString) {\r\n    const date = new Date(dateString);\r\n    return `${date.toLocaleDateString()  } ${  date.toLocaleTimeString()}`;\r\n  }\r\n  generateLink() {\r\n    const form = document.getElementById(\"generatorForm\");\r\n    if (form) {\r\n      form.style.display = \"block\";\r\n      form.scrollIntoView({ behavior: \"smooth\" });\r\n    }\r\n  }\r\n  cancelGenerate() {\r\n    const form = document.getElementById(\"generatorForm\");\r\n    const generatedLink = document.getElementById(\"generatedLink\");\r\n    if (form) form.style.display = \"none\";\r\n    if (generatedLink) generatedLink.style.display = \"none\";\r\n    document.getElementById(\"linkForm\").reset();\r\n  }\r\n  async handleSubmit(e) {\r\n    e.preventDefault();\r\n    const formData = new FormData(e.target);\r\n    const userRole = await this.getUserRole();\r\n    // Automatically get department based on user role\r\n    let departmentCode = null;\r\n    if (userRole === \"lgu-hr\") {\r\n      departmentCode = await this.getHRDepartment(userRole);\r\n      // console.log removed for security\r\n    } else {\r\n      // For coordinators and super-admin, use form data\r\n      departmentCode = formData.get(\"department_code\") || null;\r\n    }\r\n    const data = {\r\n      role: formData.get(\"role\"),\r\n      department_code: departmentCode,\r\n      expires_in_hours: parseInt(formData.get(\"expires_in_hours\")) || 1\r\n    };\r\n    // console.log removed for security\r\n    try {\r\n      const response = await apiClient.generateSignupLink(data);\r\n      if (response.success) {\r\n        this.showGeneratedLink(response.data);\r\n        await this.loadLinks(); // Refresh the list\r\n        this.cancelGenerate();\r\n        showMessage(\"success\", \"Signup link generated successfully\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to generate link:\", error);\r\n      showMessage(\"error\", error.message || \"Failed to generate signup link\");\r\n    }\r\n  }\r\n  showGeneratedLink(linkData) {\r\n    const generatedLink = document.getElementById(\"generatedLink\");\r\n    const linkInput = document.getElementById(\"linkInput\");\r\n    const expiryTime = document.getElementById(\"expiryTime\");\r\n    if (linkInput) linkInput.value = linkData.url;\r\n    if (expiryTime) {\r\n      const expiryDate = new Date(linkData.expires_at);\r\n      expiryTime.textContent = expiryDate.toLocaleString();\r\n    }\r\n    if (generatedLink) generatedLink.style.display = \"block\";\r\n  }\r\n  copyLink() {\r\n    const linkInput = document.getElementById(\"linkInput\");\r\n    if (linkInput) {\r\n      linkInput.select();\r\n      document.execCommand(\"copy\");\r\n      showMessage(\"success\", \"Link copied to clipboard\");\r\n    }\r\n  }\r\n  copyLinkUrl(url) {\r\n    navigator.clipboard.writeText(url).then(() => {\r\n      showMessage(\"success\", \"URL copied to clipboard\");\r\n    }).catch(() => {\r\n      // Fallback for older browsers\r\n      const textArea = document.createElement(\"textarea\");\r\n      textArea.value = url;\r\n      document.body.appendChild(textArea);\r\n      textArea.select();\r\n      document.execCommand(\"copy\");\r\n      document.body.removeChild(textArea);\r\n      showMessage(\"success\", \"URL copied to clipboard\");\r\n    });\r\n  }\r\n  async deactivateLink(linkId) {\r\n    // console.log removed for security\r\n    if (!confirm(\"Are you sure you want to deactivate this link?\")) {\r\n      return;\r\n    }\r\n    try {\r\n      // console.log removed for security\r\n      const response = await apiClient.deactivateSignupLink(linkId);\r\n      // console.log removed for security\r\n      if (response.success) {\r\n        showMessage(\"success\", \"Link deactivated successfully\");\r\n        await this.loadLinks();\r\n      } else {\r\n        showMessage(\"error\", response.error || \"Failed to deactivate link\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[LINK-GENERATOR] Failed to deactivate link:\", error);\r\n      showMessage(\"error\", error.message || \"Failed to deactivate link\");\r\n    }\r\n  }\r\n  filterLinks() {\r\n    const roleFilter = document.getElementById(\"roleFilter\")?.value;\r\n    const statusFilter = document.getElementById(\"statusFilter\")?.value;\r\n    let filteredLinks = this.links;\r\n    if (roleFilter) {\r\n      filteredLinks = filteredLinks.filter(link => link.role === roleFilter);\r\n    }\r\n    if (statusFilter) {\r\n\r\n      if (statusFilter === \"active\") {\r\n        filteredLinks = filteredLinks.filter(link => !link.is_used && !link.is_expired);\r\n      } else if (statusFilter === \"expired\") {\r\n        filteredLinks = filteredLinks.filter(link => link.is_expired);\r\n      } else if (statusFilter === \"used\") {\r\n        filteredLinks = filteredLinks.filter(link => link.is_used);\r\n      }\r\n    }\r\n    // Temporarily replace links array for rendering\r\n    const originalLinks = this.links;\r\n    this.links = filteredLinks;\r\n    this.renderLinks();\r\n    this.links = originalLinks;\r\n  }\r\n}\r\n// Global functions for onclick handlers\r\nwindow.generateLink = () => {\r\n  if (window.linkGenerator) {\r\n    window.linkGenerator.generateLink();\r\n  }\r\n};\r\nwindow.copyLink = () => {\r\n  if (window.linkGenerator) {\r\n    window.linkGenerator.copyLink();\r\n  }\r\n};\r\nwindow.copyLinkUrl = (url) => {\r\n  if (window.linkGenerator) {\r\n    window.linkGenerator.copyLinkUrl(url);\r\n  }\r\n};\r\nwindow.deactivateLink = (linkId) => {\r\n  if (window.linkGenerator) {\r\n    window.linkGenerator.deactivateLink(linkId);\r\n  }\r\n};\r\nwindow.filterLinks = () => {\r\n  if (window.linkGenerator) {\r\n    window.linkGenerator.filterLinks();\r\n  }\r\n};\r\n// Initialize when DOM is loaded\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  window.linkGenerator = new LinkGenerator();\r\n});\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\lgu-admin\\department-queue.js","messages":[{"ruleId":"no-prototype-builtins","severity":2,"message":"Do not access Object.prototype method 'hasOwnProperty' from target object.","line":511,"column":18,"nodeType":"CallExpression","messageId":"prototypeBuildIn","endLine":511,"endColumn":32,"suggestions":[{"messageId":"callObjectPrototype","data":{"prop":"hasOwnProperty"},"fix":{"range":[20441,20463],"text":"Object.prototype.hasOwnProperty.call(counts, "},"desc":"Call Object.prototype.hasOwnProperty explicitly."}]},{"ruleId":"no-prototype-builtins","severity":2,"message":"Do not access Object.prototype method 'hasOwnProperty' from target object.","line":526,"column":18,"nodeType":"CallExpression","messageId":"prototypeBuildIn","endLine":526,"endColumn":32,"suggestions":[{"messageId":"callObjectPrototype","data":{"prop":"hasOwnProperty"},"fix":{"range":[20865,20887],"text":"Object.prototype.hasOwnProperty.call(counts, "},"desc":"Call Object.prototype.hasOwnProperty explicitly."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// LGU Admin Department Queue JavaScript\r\nimport showToast from \"../components/toast.js\";\r\n\r\nclass DepartmentQueue {\r\n\r\n  constructor() {\r\n    this.complaints = [];\r\n    this.department = null;\r\n    this.currentPage = 1;\r\n    this.itemsPerPage = 10;\r\n    this.filters = {\r\n      status: \"\",\r\n      priority: \"\",\r\n      search: \"\"\r\n    };\r\n    this.statusPalette = [\r\n      { key: \"approved\", label: \"Approved\", color: \"#3b82f6\" },\r\n      { key: \"assigned\", label: \"Assigned\", color: \"#6366f1\" },\r\n      { key: \"assigned to officer\", label: \"With Officer\", color: \"#f97316\" },\r\n      { key: \"in progress\", label: \"In Progress\", color: \"#facc15\" },\r\n      { key: \"resolved\", label: \"Resolved\", color: \"#22c55e\" },\r\n      { key: \"closed\", label: \"Closed\", color: \"#0ea5e9\" },\r\n      { key: \"other\", label: \"Other\", color: \"#94a3b8\" }\r\n    ];\r\n    this.priorityPalette = [\r\n      { key: \"urgent\", label: \"Urgent\", color: \"#dc2626\", track: \"#fee2e2\" },\r\n      { key: \"high\", label: \"High\", color: \"#ea580c\", track: \"#ffedd5\" },\r\n      { key: \"medium\", label: \"Medium\", color: \"#d97706\", track: \"#fef3c7\" },\r\n      { key: \"low\", label: \"Low\", color: \"#059669\", track: \"#d1fae5\" },\r\n      { key: \"other\", label: \"Unlabeled\", color: \"#64748b\", track: \"#e5e7eb\" }\r\n    ];\r\n    this.init();\r\n  }\r\n  init() {\r\n    this.setupEventListeners();\r\n    this.loadComplaints();\r\n  }\r\n  setupEventListeners() {\r\n    // Filter controls\r\n    const statusFilter = document.getElementById(\"status-filter\");\r\n    const priorityFilter = document.getElementById(\"priority-filter\");\r\n    const searchInput = document.getElementById(\"search-input\");\r\n    if (statusFilter) {\r\n      statusFilter.addEventListener(\"change\", (e) => {\r\n        this.filters.status = e.target.value;\r\n        this.loadComplaints();\r\n      });\r\n    }\r\n    if (priorityFilter) {\r\n      priorityFilter.addEventListener(\"change\", (e) => {\r\n        this.filters.priority = e.target.value;\r\n        this.loadComplaints();\r\n      });\r\n    }\r\n    if (searchInput) {\r\n      searchInput.addEventListener(\"input\", (e) => {\r\n        this.filters.search = e.target.value;\r\n        this.debounce(() => this.loadComplaints(), 300)();\r\n      });\r\n    }\r\n    // Modal controls\r\n    this.setupModalEventListeners();\r\n  }\r\n  setupModalEventListeners() {\r\n    const modal = document.getElementById(\"officer-assignment-modal\");\r\n    const closeBtn = modal?.querySelector(\".modal-close\");\r\n    const cancelBtn = document.getElementById(\"cancel-assignment\");\r\n    const confirmBtn = document.getElementById(\"confirm-assignment\");\r\n    if (closeBtn) {\r\n      closeBtn.addEventListener(\"click\", () => this.hideModal());\r\n    }\r\n    if (cancelBtn) {\r\n      cancelBtn.addEventListener(\"click\", () => this.hideModal());\r\n    }\r\n    if (confirmBtn) {\r\n      confirmBtn.addEventListener(\"click\", () => this.confirmAssignment());\r\n    }\r\n    // Close modal on overlay click\r\n    if (modal) {\r\n      modal.addEventListener(\"click\", (e) => {\r\n        if (e.target === modal) {\r\n          this.hideModal();\r\n        }\r\n      });\r\n    }\r\n  }\r\n  async loadComplaints() {\r\n    try {\r\n      this.showLoading();\r\n      const queryParams = new URLSearchParams();\r\n      if (this.filters.status) queryParams.append(\"status\", this.filters.status);\r\n      if (this.filters.priority) queryParams.append(\"priority\", this.filters.priority);\r\n      if (this.filters.search) queryParams.append(\"search\", this.filters.search);\r\n      queryParams.append(\"limit\", this.itemsPerPage);\r\n      const response = await fetch(`/api/lgu-admin/department-queue?${queryParams}`, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        credentials: \"include\"\r\n      });\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      const data = await response.json();\r\n      if (!data.success) {\r\n        throw new Error(data.error || \"Failed to load complaints\");\r\n      }\r\n      this.complaints = data.data || [];\r\n      this.department = data.department;\r\n      this.renderComplaints();\r\n      this.updateStats();\r\n      this.updateDepartmentName();\r\n    } catch (error) {\r\n      console.error(\"Error loading complaints:\", error);\r\n      this.showError(`Failed to load complaints: ${  error.message}`);\r\n    } finally {\r\n      this.hideLoading();\r\n    }\r\n  }\r\n  renderComplaints() {\r\n    const complaintsList = document.getElementById(\"complaints-list\");\r\n    const loading = document.getElementById(\"loading\");\r\n    const emptyState = document.getElementById(\"empty-state\");\r\n    if (!complaintsList) return;\r\n    const filteredComplaints = this.getFilteredComplaints();\r\n    const paginatedComplaints = this.getPaginatedComplaints(filteredComplaints);\r\n    // Hide loading state\r\n    if (loading) loading.style.display = \"none\";\r\n    if (paginatedComplaints.length === 0) {\r\n      complaintsList.style.display = \"none\";\r\n      if (emptyState) {\r\n        emptyState.style.display = \"block\";\r\n        emptyState.innerHTML = `\r\n                    <h2>No complaints found</h2>\r\n                    <p>No complaints match your current filters.</p>\r\n                `;\r\n      }\r\n      return;\r\n    }\r\n    // Show complaint list and hide empty state\r\n    complaintsList.style.display = \"block\";\r\n    if (emptyState) emptyState.style.display = \"none\";\r\n    complaintsList.innerHTML = paginatedComplaints.map(complaint => `\r\n            <div class=\"complaint-card\">\r\n                <div class=\"complaint-header\">\r\n                    <div class=\"complaint-title-section\">\r\n                        <h3 class=\"complaint-title\">${complaint.title || \"Untitled Complaint\"}</h3>\r\n                        <div class=\"complaint-meta\">\r\n                            <span class=\"complaint-id\">#${complaint.id}</span>\r\n                            <span class=\"complaint-status status-${complaint.status?.toLowerCase().replace(\" \", \"-\") || \"pending\"}\">\r\n                                ${complaint.status || \"Pending\"}\r\n                            </span>\r\n                            <span class=\"complaint-priority priority-${complaint.priority?.toLowerCase() || \"medium\"}\">\r\n                                ${complaint.priority || \"Medium\"}\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"complaint-actions\">\r\n                        ${this.getActionButtons(complaint)}\r\n                    </div>\r\n                </div>\r\n                \r\n                <div class=\"complaint-content\">\r\n                    <p class=\"complaint-description\">${complaint.descriptive_su || complaint.description || \"No description provided\"}</p>\r\n                    ${!complaint.is_assigned_to_department ? `\r\n                        <div class=\"info-banner\" style=\"background-color: #fff3cd; border: 1px solid #ffc107; padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem; font-size: 0.875rem; color: #856404;\">\r\n                            ⚠️ This complaint is not assigned to your department. Limited information only.\r\n                        </div>\r\n                    ` : \"\"}\r\n                    <div class=\"complaint-details\">\r\n                        <div class=\"complaint-detail\">\r\n                            <span>📅</span>\r\n                            <span>${this.formatDate(complaint.submitted_at || complaint.created_at)}</span>\r\n                        </div>\r\n                        <div class=\"complaint-detail\">\r\n                            <span>📍</span>\r\n                            <span>${complaint.location_text || \"No location\"}</span>\r\n                        </div>\r\n                        <div class=\"complaint-detail\">\r\n                            <span>🏷️</span>\r\n                            <span>${complaint.type || \"General\"}</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                ${this.renderDepartmentsInfo(complaint)}\r\n                ${this.renderAssignmentInfo(complaint)}\r\n            </div>\r\n        `).join(\"\");\r\n    this.attachActionEventListeners();\r\n  }\r\n  getActionButtons(complaint) {\r\n    const buttons = [];\r\n    // View details button - ONLY show if complaint is assigned to this admin's department\r\n    if (complaint.is_assigned_to_department) {\r\n      buttons.push(`\r\n                <button class=\"btn btn-primary\" data-action=\"view\" data-complaint-id=\"${complaint.id}\">\r\n                    View Assigned Complaint\r\n                </button>\r\n            `);\r\n    }\r\n    // Assign to officer button (if not already assigned)\r\n    if (complaint.status === \"approved\" || complaint.status === \"assigned\") {\r\n      buttons.push(`\r\n                <button class=\"btn btn-outline\" data-action=\"assign\" data-complaint-id=\"${complaint.id}\">\r\n                    Assign to Officer\r\n                </button>\r\n            `);\r\n    }\r\n    return buttons.join(\"\");\r\n  }\r\n  renderDepartmentsInfo(complaint) {\r\n    const departments = complaint.assigned_departments || complaint.primary_department || [];\r\n    const preferredDepartments = complaint.preferred_departments || [];\r\n    if (!departments || departments.length === 0) {\r\n      return \"\";\r\n    }\r\n    const departmentArray = Array.isArray(departments) ? departments : [departments];\r\n    return `\r\n            <div class=\"departments-info\">\r\n                <strong>Assigned Departments:</strong>\r\n                <div class=\"departments-list\">\r\n                    ${departmentArray.map(dept => `\r\n                        <div class=\"department-badge ${preferredDepartments.includes(dept) ? \"preferred\" : \"\"}\">\r\n                            ${dept}\r\n                        </div>\r\n                    `).join(\"\")}\r\n                </div>\r\n            </div>\r\n        `;\r\n  }\r\n\r\n  renderAssignmentInfo(complaint) {\r\n    if (!complaint.assignments || complaint.assignments.length === 0) {\r\n      return `\r\n                <div class=\"assignment-info pending\">\r\n                    <strong>Status:</strong> Pending assignment to officer\r\n                </div>\r\n            `;\r\n    }\r\n\r\n    const assignment = complaint.assignments[0];\r\n    return `\r\n            <div class=\"assignment-info assigned\">\r\n                <strong>Assigned to Officer:</strong> ${assignment.assigned_to || \"Unknown\"}\r\n                <br>\r\n                <strong>Status:</strong> ${assignment.status || \"Unknown\"}\r\n                <br>\r\n                <strong>Assigned:</strong> ${this.formatDate(assignment.assigned_at)}\r\n            </div>\r\n        `;\r\n  }\r\n\r\n  attachActionEventListeners() {\r\n    // View details buttons\r\n    document.querySelectorAll('[data-action=\"view\"]').forEach(btn => {\r\n      btn.addEventListener(\"click\", (e) => {\r\n        const complaintId = e.target.getAttribute(\"data-complaint-id\");\r\n        this.viewComplaint(complaintId);\r\n      });\r\n    });\r\n\r\n    // Assign to officer buttons\r\n    document.querySelectorAll('[data-action=\"assign\"]').forEach(btn => {\r\n      btn.addEventListener(\"click\", (e) => {\r\n        const complaintId = e.target.getAttribute(\"data-complaint-id\");\r\n        this.showAssignmentModal(complaintId);\r\n      });\r\n    });\r\n  }\r\n\r\n  async viewComplaint(complaintId) {\r\n    // Redirect to complaint details page\r\n    window.location.href = `/complaint-details?id=${complaintId}`;\r\n  }\r\n  async showAssignmentModal(complaintId) {\r\n    try {\r\n      // Load officers for this department\r\n      await this.loadOfficers();\r\n      // Set complaint ID\r\n      document.getElementById(\"assignment-complaint-id\").value = complaintId;\r\n      // Show modal\r\n      const modal = document.getElementById(\"officer-assignment-modal\");\r\n      if (modal) {\r\n        modal.style.display = \"flex\";\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error showing assignment modal:\", error);\r\n      showToast(`Failed to load officers: ${  error.message}`, \"error\");\r\n    }\r\n  }\r\n  async loadOfficers() {\r\n    try {\r\n      const response = await fetch(\"/api/lgu-admin/department-officers\", {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        credentials: \"include\"\r\n      });\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      const data = await response.json();\r\n      if (!data.success) {\r\n        throw new Error(data.error || \"Failed to load officers\");\r\n      }\r\n      const officerSelect = document.getElementById(\"officer-select\");\r\n      if (officerSelect) {\r\n        officerSelect.innerHTML = `<option value=\"\">Choose an officer...</option>${\r\n          (data.data || []).map(officer => `\r\n                        <option value=\"${officer.id}\">${officer.name || officer.email}</option>\r\n                    `).join(\"\")}`;\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error loading officers:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  async confirmAssignment() {\r\n    const complaintId = document.getElementById(\"assignment-complaint-id\").value;\r\n    const officerId = document.getElementById(\"officer-select\").value;\r\n    const priority = document.getElementById(\"assignment-priority\").value;\r\n    const deadline = document.getElementById(\"assignment-deadline\").value;\r\n    const notes = document.getElementById(\"assignment-notes\").value;\r\n    if (!officerId) {\r\n      showToast(\"Please select an officer\", \"error\");\r\n      return;\r\n    }\r\n    try {\r\n      const response = await fetch(`/api/lgu-admin/complaints/${complaintId}/assign`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        credentials: \"include\",\r\n        body: JSON.stringify({\r\n          officerId,\r\n          priority,\r\n          deadline: deadline || null,\r\n          notes: notes || null\r\n        })\r\n      });\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        showToast(\"Complaint assigned to officer successfully\", \"success\");\r\n        this.hideModal();\r\n        this.loadComplaints(); // Refresh the list\r\n      } else {\r\n        throw new Error(result.error || \"Failed to assign complaint\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error assigning complaint:\", error);\r\n      showToast(`Failed to assign complaint: ${  error.message}`, \"error\");\r\n    }\r\n  }\r\n  hideModal() {\r\n    const modal = document.getElementById(\"officer-assignment-modal\");\r\n    if (modal) {\r\n      modal.style.display = \"none\";\r\n    }\r\n    // Reset form\r\n    const form = document.getElementById(\"officer-assignment-form\");\r\n    if (form) {\r\n      form.reset();\r\n    }\r\n  }\r\n  getFilteredComplaints() {\r\n    let filtered = [...this.complaints];\r\n    if (this.filters.search) {\r\n      const searchTerm = this.filters.search.toLowerCase();\r\n      filtered = filtered.filter(complaint =>\r\n        complaint.title?.toLowerCase().includes(searchTerm) ||\r\n                complaint.description?.toLowerCase().includes(searchTerm) ||\r\n                complaint.id?.toString().includes(searchTerm)\r\n      );\r\n    }\r\n    return filtered;\r\n  }\r\n  getPaginatedComplaints(complaints) {\r\n\r\n    const startIndex = (this.currentPage - 1) * this.itemsPerPage;\r\n    const endIndex = startIndex + this.itemsPerPage;\r\n    return complaints.slice(startIndex, endIndex);\r\n  }\r\n  updateStats() {\r\n    const total = this.complaints.length;\r\n    const pendingAssignment = this.complaints.filter(c =>\r\n      c.status === \"approved\" || c.status === \"assigned\"\r\n    ).length;\r\n    const inProgress = this.complaints.filter(c =>\r\n      c.status === \"assigned to officer\" || c.status === \"in progress\"\r\n    ).length;\r\n    const resolved = this.complaints.filter(c =>\r\n      c.status === \"resolved\" || c.status === \"closed\"\r\n    ).length;\r\n    document.getElementById(\"total-complaints\").textContent = total;\r\n    document.getElementById(\"pending-assignment\").textContent = pendingAssignment;\r\n    document.getElementById(\"in-progress\").textContent = inProgress;\r\n    document.getElementById(\"resolved\").textContent = resolved;\r\n    this.updateVisualizations();\r\n  }\r\n  updateVisualizations() {\r\n    this.renderStatusVisualization();\r\n    this.renderPriorityBars();\r\n    this.updateInsightsTimestamp();\r\n  }\r\n  renderStatusVisualization() {\r\n    const svg = document.getElementById(\"complaint-status-chart\");\r\n    const legend = document.getElementById(\"complaint-status-legend\");\r\n    const donutTotal = document.getElementById(\"donut-total\");\r\n    if (!svg || !legend || !donutTotal) return;\r\n    const total = this.complaints.length;\r\n    donutTotal.textContent = total;\r\n    svg.innerHTML = \"\";\r\n    const radius = 60;\r\n    const circumference = 2 * Math.PI * radius;\r\n    const statusCounts = this.getStatusCounts();\r\n    const visibleStatuses = this.statusPalette\r\n      .map(item => ({ ...item, count: statusCounts[item.key] || 0 }))\r\n      .filter(item => item.count > 0);\r\n    const track = document.createElementNS(\"http://www.w3.org/2000/svg\", \"circle\");\r\n    track.setAttribute(\"cx\", \"80\");\r\n    track.setAttribute(\"cy\", \"80\");\r\n    track.setAttribute(\"r\", radius);\r\n    track.classList.add(\"donut-track\");\r\n    svg.appendChild(track);\r\n    if (total === 0 || visibleStatuses.length === 0) {\r\n      legend.innerHTML = '<p class=\"legend-empty\">No complaints to visualize.</p>';\r\n      return;\r\n    }\r\n    let offset = 0;\r\n    visibleStatuses.forEach(item => {\r\n      const slice = document.createElementNS(\"http://www.w3.org/2000/svg\", \"circle\");\r\n      slice.setAttribute(\"cx\", \"80\");\r\n      slice.setAttribute(\"cy\", \"80\");\r\n      slice.setAttribute(\"r\", radius);\r\n      slice.classList.add(\"donut-slice\");\r\n      slice.setAttribute(\"stroke\", item.color);\r\n      const dash = (item.count / total) * circumference;\r\n      slice.setAttribute(\"stroke-dasharray\", `${dash} ${circumference}`);\r\n      slice.setAttribute(\"stroke-dashoffset\", `${-offset}`);\r\n      offset += dash;\r\n      svg.appendChild(slice);\r\n    });\r\n    legend.innerHTML = visibleStatuses.map(item => {\r\n      const percent = Math.round((item.count / total) * 100);\r\n      return `\r\n        <div class=\"legend-row\">\r\n          <div class=\"legend-row-info\">\r\n            <span class=\"legend-swatch\" style=\"background:${item.color};\"></span>\r\n            <div>\r\n              <div class=\"legend-label\">${item.label}</div>\r\n              <div class=\"legend-percent\">${percent}% of queue</div>\r\n            </div>\r\n          </div>\r\n          <div class=\"legend-count\">${item.count}</div>\r\n        </div>\r\n      `;\r\n    }).join(\"\");\r\n  }\r\n  renderPriorityBars() {\r\n    const container = document.getElementById(\"priority-bars\");\r\n    const totalLabel = document.getElementById(\"priority-total-label\");\r\n    if (!container || !totalLabel) return;\r\n    const total = this.complaints.length;\r\n    totalLabel.textContent = `${total} complaint${total === 1 ? \"\" : \"s\"}`;\r\n    const priorityCounts = this.getPriorityCounts();\r\n    if (total === 0) {\r\n      container.innerHTML = '<p class=\"legend-empty\">No priority data available yet.</p>';\r\n      return;\r\n    }\r\n    container.innerHTML = this.priorityPalette.map(item => {\r\n      const count = priorityCounts[item.key] || 0;\r\n      const percent = total ? Math.round((count / total) * 100) : 0;\r\n      return `\r\n        <div class=\"priority-row\">\r\n          <div class=\"priority-row-head\">\r\n            <div class=\"priority-label\">\r\n              <span class=\"priority-dot\" style=\"background:${item.color};\"></span>\r\n              ${item.label}\r\n            </div>\r\n            <div class=\"priority-value\">\r\n              ${count} <span>${percent}%</span>\r\n            </div>\r\n          </div>\r\n          <div class=\"priority-progress\">\r\n            <span style=\"width:${percent}%; background:${item.color};\"></span>\r\n          </div>\r\n        </div>\r\n      `;\r\n    }).join(\"\");\r\n  }\r\n  updateInsightsTimestamp() {\r\n    const element = document.getElementById(\"insights-updated-text\");\r\n    if (!element) return;\r\n    const now = new Date();\r\n    element.textContent = `Updated ${now.toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" })}`;\r\n  }\r\n  getStatusCounts() {\r\n    const counts = this.statusPalette.reduce((acc, item) => {\r\n      acc[item.key] = 0;\r\n      return acc;\r\n    }, {});\r\n    this.complaints.forEach(complaint => {\r\n      const status = (complaint.status || \"other\").toLowerCase();\r\n      if (counts.hasOwnProperty(status)) {\r\n        counts[status] += 1;\r\n      } else {\r\n        counts.other += 1;\r\n      }\r\n    });\r\n    return counts;\r\n  }\r\n  getPriorityCounts() {\r\n    const counts = this.priorityPalette.reduce((acc, item) => {\r\n      acc[item.key] = 0;\r\n      return acc;\r\n    }, {});\r\n    this.complaints.forEach(complaint => {\r\n      const priority = (complaint.priority || \"other\").toLowerCase();\r\n      if (counts.hasOwnProperty(priority)) {\r\n        counts[priority] += 1;\r\n      } else {\r\n        counts.other += 1;\r\n      }\r\n    });\r\n    return counts;\r\n  }\r\n  updateDepartmentName() {\r\n    const departmentNameElement = document.getElementById(\"department-name\");\r\n    if (departmentNameElement && this.department) {\r\n      departmentNameElement.textContent = `${this.department.name} (${this.department.code})`;\r\n    }\r\n  }\r\n  showLoading() {\r\n    const loading = document.getElementById(\"loading\");\r\n    const complaintsList = document.getElementById(\"complaints-list\");\r\n    const emptyState = document.getElementById(\"empty-state\");\r\n    if (loading) loading.style.display = \"block\";\r\n    if (complaintsList) complaintsList.style.display = \"none\";\r\n    if (emptyState) emptyState.style.display = \"none\";\r\n  }\r\n  hideLoading() {\r\n    const loading = document.getElementById(\"loading\");\r\n    if (loading) loading.style.display = \"none\";\r\n  }\r\n  showError(message) {\r\n    const emptyState = document.getElementById(\"empty-state\");\r\n    if (emptyState) {\r\n      emptyState.style.display = \"block\";\r\n      emptyState.innerHTML = `\r\n                <h2>Error Loading Complaints</h2>\r\n                <p>${message}</p>\r\n                <button class=\"btn btn-primary\" onclick=\"location.reload()\">Retry</button>\r\n            `;\r\n    }\r\n  }\r\n  formatDate(dateString) {\r\n    if (!dateString) return \"Unknown date\";\r\n    try {\r\n      const date = new Date(dateString);\r\n      return `${date.toLocaleDateString()  } ${  date.toLocaleTimeString()}`;\r\n    } catch (error) {\r\n      return \"Invalid date\";\r\n    }\r\n  }\r\n  debounce(func, wait) {\r\n    let timeout;\r\n    return function executedFunction(...args) {\r\n      const later = () => {\r\n        clearTimeout(timeout);\r\n        func(...args);\r\n      };\r\n      clearTimeout(timeout);\r\n      timeout = setTimeout(later, wait);\r\n    };\r\n  }\r\n}\r\n// Initialize when DOM is loaded\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  new DepartmentQueue();\r\n});\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\lgu-officer\\assigned-tasks.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\404.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\500.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\admin\\department-structure.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":291,"column":8,"nodeType":"CallExpression","messageId":"unexpected","endLine":291,"endColumn":131},{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":305,"column":8,"nodeType":"CallExpression","messageId":"unexpected","endLine":305,"endColumn":116},{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":319,"column":8,"nodeType":"CallExpression","messageId":"unexpected","endLine":319,"endColumn":67}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Department Structure Management\r\n * Admin interface for managing categories, subcategories, and departments\r\n */\r\nimport showMessage from \"../../components/toast.js\";\r\nimport { apiClient } from \"../../config/apiClient.js\";\r\n\r\nlet categories = [];\r\nconst _subcategories = [];\r\nconst _departments = [];\r\n// Initialize the page\r\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\r\n  await loadAllData();\r\n  setupEventListeners();\r\n});\r\n/**\r\n * Load all department structure data\r\n */\r\nasync function loadAllData() {\r\n  try {\r\n    // Load categories with their subcategories and departments\r\n    const { data, error } = await apiClient.get(\"/api/department-structure/categories\");\r\n    if (error) throw error;\r\n    categories = data || [];\r\n    renderCategories();\r\n    updateStats();\r\n  } catch (error) {\r\n    console.error(\"Error loading department structure:\", error);\r\n    showMessage(\"error\", \"Failed to load department structure\");\r\n  }\r\n}\r\n/**\r\n * Render categories with their subcategories and departments\r\n */\r\nfunction renderCategories() {\r\n  const container = document.getElementById(\"categories-container\");\r\n  if (!container) return;\r\n  if (categories.length === 0) {\r\n    container.innerHTML = '<div class=\"loading\">No categories found</div>';\r\n    return;\r\n  }\r\n  container.innerHTML = categories.map(category => `\r\n        <div class=\"category-item\">\r\n            <div class=\"category-header\" onclick=\"toggleCategory('${category.id}')\">\r\n                <h3 class=\"category-title\">${category.icon} ${category.name}</h3>\r\n                <div class=\"category-actions\">\r\n                    <button class=\"btn-sm btn-edit\" onclick=\"editCategory('${category.id}')\">Edit</button>\r\n                    <button class=\"btn-sm btn-delete\" onclick=\"deleteCategory('${category.id}')\">Delete</button>\r\n                </div>\r\n            </div>\r\n            <div class=\"subcategories-container\" id=\"subcategories-${category.id}\">\r\n                ${category.subcategories ? category.subcategories.map(subcategory => `\r\n                    <div class=\"subcategory-item\">\r\n                        <div class=\"subcategory-header\" onclick=\"toggleSubcategory('${subcategory.id}')\">\r\n                            <h4 class=\"subcategory-title\">${subcategory.name}</h4>\r\n                            <div class=\"category-actions\">\r\n                                <button class=\"btn-sm btn-edit\" onclick=\"editSubcategory('${subcategory.id}')\">Edit</button>\r\n                                <button class=\"btn-sm btn-delete\" onclick=\"deleteSubcategory('${subcategory.id}')\">Delete</button>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"departments-container\" id=\"departments-${subcategory.id}\">\r\n                            ${subcategory.departments ? subcategory.departments.map(department => `\r\n                                <div class=\"department-item\">\r\n                                    <div class=\"department-info\">\r\n                                        <div class=\"department-name\">${department.name}</div>\r\n                                        <div class=\"department-details\">\r\n                                            ${department.code} | ${department.level} | ${department.response_time_hours}h response\r\n                                        </div>\r\n                                    </div>\r\n                                    <div class=\"category-actions\">\r\n                                        <button class=\"btn-sm btn-edit\" onclick=\"editDepartment('${department.id}')\">Edit</button>\r\n                                        <button class=\"btn-sm btn-delete\" onclick=\"deleteDepartment('${department.id}')\">Delete</button>\r\n                                    </div>\r\n                                </div>\r\n                            `).join(\"\") : '<div class=\"loading\">No departments</div>'}\r\n                        </div>\r\n                    </div>\r\n                `).join(\"\") : '<div class=\"loading\">No subcategories</div>'}\r\n            </div>\r\n        </div>\r\n    `).join(\"\");\r\n}\r\n/**\r\n * Update statistics\r\n */\r\nfunction updateStats() {\r\n  let totalSubcategories = 0;\r\n  let totalDepartments = 0;\r\n  let activeDepartments = 0;\r\n  categories.forEach(category => {\r\n    if (category.subcategories) {\r\n      totalSubcategories += category.subcategories.length;\r\n      category.subcategories.forEach(subcategory => {\r\n        if (subcategory.departments) {\r\n          totalDepartments += subcategory.departments.length;\r\n          activeDepartments += subcategory.departments.filter(dept => dept.is_active).length;\r\n        }\r\n      });\r\n    }\r\n  });\r\n  document.getElementById(\"total-categories\").textContent = categories.length;\r\n  document.getElementById(\"total-subcategories\").textContent = totalSubcategories;\r\n  document.getElementById(\"total-departments\").textContent = totalDepartments;\r\n  document.getElementById(\"active-departments\").textContent = activeDepartments;\r\n}\r\n/**\r\n * Setup event listeners\r\n */\r\nfunction setupEventListeners() {\r\n  // Category form\r\n  document.getElementById(\"category-form\").addEventListener(\"submit\", handleCategorySubmit);\r\n  // Subcategory form\r\n  document.getElementById(\"subcategory-form\").addEventListener(\"submit\", handleSubcategorySubmit);\r\n  // Department form\r\n  document.getElementById(\"department-form\").addEventListener(\"submit\", handleDepartmentSubmit);\r\n}\r\n/**\r\n * Toggle category expansion\r\n */\r\nwindow.toggleCategory = function(categoryId) {\r\n  const container = document.getElementById(`subcategories-${categoryId}`);\r\n  if (container) {\r\n    container.classList.toggle(\"expanded\");\r\n  }\r\n};\r\n/**\r\n * Toggle subcategory expansion\r\n */\r\nwindow.toggleSubcategory = function(subcategoryId) {\r\n  const container = document.getElementById(`departments-${subcategoryId}`);\r\n  if (container) {\r\n    container.classList.toggle(\"expanded\");\r\n  }\r\n};\r\n/**\r\n * Open modal for adding/editing\r\n */\r\nwindow.openModal = function(type, editId = null) {\r\n  const modal = document.getElementById(`${type}-modal`);\r\n  if (!modal) return;\r\n  // Reset form\r\n  const form = document.getElementById(`${type}-form`);\r\n  if (form) {\r\n    form.reset();\r\n  }\r\n  // Set modal title\r\n  const title = document.getElementById(`${type}-modal-title`);\r\n  if (title) {\r\n    title.textContent = editId ? `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}` : `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;\r\n  }\r\n  // Populate dropdowns\r\n  if (type === \"subcategory\") {\r\n    populateCategoryDropdown();\r\n  } else if (type === \"department\") {\r\n    populateSubcategoryDropdown();\r\n  }\r\n  // If editing, populate form with existing data\r\n  if (editId) {\r\n    populateFormForEdit(type, editId);\r\n  }\r\n  modal.classList.add(\"show\");\r\n};\r\n/**\r\n * Close modal\r\n */\r\nwindow.closeModal = function(type) {\r\n  const modal = document.getElementById(`${type}-modal`);\r\n  if (modal) {\r\n    modal.classList.remove(\"show\");\r\n  }\r\n};\r\n/**\r\n * Populate category dropdown\r\n */\r\nfunction populateCategoryDropdown() {\r\n  const select = document.getElementById(\"subcategory-category\");\r\n  if (!select) return;\r\n  select.innerHTML = '<option value=\"\">Select a category</option>';\r\n  categories.forEach(category => {\r\n    const option = document.createElement(\"option\");\r\n    option.value = category.id;\r\n    option.textContent = `${category.icon} ${category.name}`;\r\n    select.appendChild(option);\r\n  });\r\n}\r\n/**\r\n * Populate subcategory dropdown\r\n */\r\nfunction populateSubcategoryDropdown() {\r\n  const select = document.getElementById(\"department-subcategory\");\r\n  if (!select) return;\r\n  select.innerHTML = '<option value=\"\">Select a subcategory</option>';\r\n  categories.forEach(category => {\r\n    if (category.subcategories) {\r\n      category.subcategories.forEach(subcategory => {\r\n        const option = document.createElement(\"option\");\r\n        option.value = subcategory.id;\r\n        option.textContent = `${category.name} - ${subcategory.name}`;\r\n        select.appendChild(option);\r\n      });\r\n    }\r\n  });\r\n}\r\n/**\r\n * Handle category form submission\r\n */\r\nasync function handleCategorySubmit(e) {\r\n  e.preventDefault();\r\n  const formData = {\r\n    name: document.getElementById(\"category-name\").value,\r\n    code: document.getElementById(\"category-code\").value,\r\n    description: document.getElementById(\"category-description\").value,\r\n    icon: document.getElementById(\"category-icon\").value,\r\n    sort_order: parseInt(document.getElementById(\"category-sort-order\").value) || 0\r\n  };\r\n  try {\r\n    const { _data, error } = await apiClient.post(\"/api/department-structure/admin/categories\", formData);\r\n    if (error) throw error;\r\n    showMessage(\"success\", \"Category created successfully\");\r\n    closeModal(\"category\");\r\n    await loadAllData();\r\n  } catch (error) {\r\n    console.error(\"Error creating category:\", error);\r\n    showMessage(\"error\", \"Failed to create category\");\r\n  }\r\n}\r\n/**\r\n * Handle subcategory form submission\r\n */\r\nasync function handleSubcategorySubmit(e) {\r\n  e.preventDefault();\r\n  const formData = {\r\n    category_id: document.getElementById(\"subcategory-category\").value,\r\n    name: document.getElementById(\"subcategory-name\").value,\r\n    code: document.getElementById(\"subcategory-code\").value,\r\n    description: document.getElementById(\"subcategory-description\").value,\r\n    sort_order: parseInt(document.getElementById(\"subcategory-sort-order\").value) || 0\r\n  };\r\n  try {\r\n    const { _data, error } = await apiClient.post(\"/api/department-structure/admin/subcategories\", formData);\r\n    if (error) throw error;\r\n    showMessage(\"success\", \"Subcategory created successfully\");\r\n    closeModal(\"subcategory\");\r\n    await loadAllData();\r\n  } catch (error) {\r\n    console.error(\"Error creating subcategory:\", error);\r\n    showMessage(\"error\", \"Failed to create subcategory\");\r\n  }\r\n}\r\n/**\r\n * Handle department form submission\r\n */\r\nasync function handleDepartmentSubmit(e) {\r\n  e.preventDefault();\r\n  const formData = {\r\n    subcategory_id: document.getElementById(\"department-subcategory\").value,\r\n    name: document.getElementById(\"department-name\").value,\r\n    code: document.getElementById(\"department-code\").value,\r\n    description: document.getElementById(\"department-description\").value,\r\n    level: document.getElementById(\"department-level\").value,\r\n    response_time_hours: parseInt(document.getElementById(\"department-response-time\").value) || 24,\r\n    escalation_time_hours: parseInt(document.getElementById(\"department-escalation-time\").value) || 72\r\n  };\r\n  try {\r\n    const { _data, error } = await apiClient.post(\"/api/department-structure/admin/departments\", formData);\r\n    if (error) throw error;\r\n    showMessage(\"success\", \"Department created successfully\");\r\n    closeModal(\"department\");\r\n    await loadAllData();\r\n  } catch (error) {\r\n    console.error(\"Error creating department:\", error);\r\n    showMessage(\"error\", \"Failed to create department\");\r\n  }\r\n}\r\n/**\r\n * Edit functions (placeholder - would need to implement edit functionality)\r\n */\r\nwindow.editCategory = function(_id) {\r\n  showMessage(\"info\", \"Edit functionality coming soon\");\r\n};\r\nwindow.editSubcategory = function(_id) {\r\n  showMessage(\"info\", \"Edit functionality coming soon\");\r\n};\r\nwindow.editDepartment = function(_id) {\r\n  showMessage(\"info\", \"Edit functionality coming soon\");\r\n};\r\n/**\r\n * Delete functions\r\n */\r\nwindow.deleteCategory = async function(id) {\r\n  if (!confirm(\"Are you sure you want to delete this category? This will also delete all subcategories and departments under it.\")) {\r\n    return;\r\n  }\r\n  try {\r\n    const { error } = await apiClient.delete(`/api/department-structure/admin/categories/${id}`);\r\n    if (error) throw error;\r\n    showMessage(\"success\", \"Category deleted successfully\");\r\n    await loadAllData();\r\n  } catch (error) {\r\n    console.error(\"Error deleting category:\", error);\r\n    showMessage(\"error\", \"Failed to delete category\");\r\n  }\r\n};\r\nwindow.deleteSubcategory = async function(id) {\r\n  if (!confirm(\"Are you sure you want to delete this subcategory? This will also delete all departments under it.\")) {\r\n    return;\r\n  }\r\n  try {\r\n    const { error } = await apiClient.delete(`/api/department-structure/admin/subcategories/${id}`);\r\n    if (error) throw error;\r\n    showMessage(\"success\", \"Subcategory deleted successfully\");\r\n    await loadAllData();\r\n  } catch (error) {\r\n    console.error(\"Error deleting subcategory:\", error);\r\n    showMessage(\"error\", \"Failed to delete subcategory\");\r\n  }\r\n};\r\nwindow.deleteDepartment = async function(id) {\r\n  if (!confirm(\"Are you sure you want to delete this department?\")) {\r\n    return;\r\n  }\r\n  try {\r\n    const { error } = await apiClient.delete(`/api/department-structure/admin/departments/${id}`);\r\n    if (error) throw error;\r\n    showMessage(\"success\", \"Department deleted successfully\");\r\n    await loadAllData();\r\n  } catch (error) {\r\n    console.error(\"Error deleting department:\", error);\r\n    showMessage(\"error\", \"Failed to delete department\");\r\n  }\r\n};\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\citizen-dashboard.js","messages":[{"ruleId":"no-lonely-if","severity":1,"message":"Unexpected if as the only statement in an else block.","line":324,"column":9,"nodeType":"IfStatement","messageId":"unexpectedLonelyIf","endLine":326,"endColumn":10},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":848,"column":21,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":852,"endColumn":10},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":872,"column":23,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":876,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Enhanced Citizen Dashboard\r\n * Comprehensive citizen engagement and complaint management\r\n */\r\nimport showMessage from \"../components/toast.js\";\r\nimport { initializeRoleToggle } from \"../auth/roleToggle.js\";\r\n\r\n// Check for OAuth success message\r\nconst oauthSuccessMessage = sessionStorage.getItem(\"oauth_success_message\");\r\nif (oauthSuccessMessage) {\r\n  sessionStorage.removeItem(\"oauth_success_message\");\r\n  showMessage(\"success\", oauthSuccessMessage, 5000);\r\n}\r\n\r\n// Priority scoring system\r\nconst PRIORITY_SCORES = {\r\n  urgent: 4,\r\n  high: 3,\r\n  medium: 2,\r\n  normal: 1,\r\n  low: 0,\r\n};\r\n// Content type icons\r\nconst CONTENT_TYPE_ICONS = {\r\n  notice: \"📢\",\r\n  news: \"📰\",\r\n  event: \"📅\",\r\n};\r\nclass ContentBannerManager {\r\n  constructor() {\r\n    // Separate queues for each content type\r\n    this.queues = {\r\n      notice: [],\r\n      news: [],\r\n      event: [],\r\n    };\r\n    // Current index for each content type\r\n    this.currentIndices = {\r\n      notice: 0,\r\n      news: 0,\r\n      event: 0,\r\n    };\r\n    this.scrollInterval = null;\r\n    this.fetchInterval = null;\r\n    this.displayDuration = 20000; // 20 seconds\r\n    this.fetchIntervalMs = 30000; // Fetch new content every 30 seconds\r\n    // Track currently displayed items to avoid unnecessary updates\r\n    this.currentlyDisplayed = {\r\n      notice: null,\r\n      news: null,\r\n      event: null,\r\n    };\r\n    this.init();\r\n  }\r\n  async init() {\r\n    // Load initial content\r\n    await this.fetchLatestContent();\r\n    // Set up periodic fetching (no automatic rotation)\r\n    this.fetchInterval = setInterval(() => {\r\n      this.fetchLatestContent();\r\n    }, this.fetchIntervalMs);\r\n    // Listen for visibility changes\r\n    document.addEventListener(\"visibilitychange\", () => {\r\n      if (!document.hidden) {\r\n        this.fetchLatestContent();\r\n      }\r\n    });\r\n  }\r\n  // Priority scoring function\r\n  getPriorityScore(item) {\r\n    const priority = item.priority || \"normal\";\r\n    return PRIORITY_SCORES[priority.toLowerCase()] || PRIORITY_SCORES.normal;\r\n  }\r\n  // Compare function for sorting - prioritize latest items first, then by priority\r\n  compareItems(a, b) {\r\n    // First sort by date (newest first)\r\n    const dateA = new Date(a.created_at || a.published_at || a.event_date || 0);\r\n    const dateB = new Date(b.created_at || b.published_at || b.event_date || 0);\r\n    const dateDiff = dateB - dateA; // Newer dates first (positive if B is newer)\r\n    // Always prioritize newest first - if dates differ significantly, use date\r\n    // Only use priority as tie-breaker for items created on the same day\r\n    const oneDay = 24 * 60 * 60 * 1000;\r\n    if (Math.abs(dateDiff) > oneDay) {\r\n      // More than 1 day difference - newest always wins\r\n      return dateDiff;\r\n    }\r\n    // Same day or very close - check priority for urgent items\r\n    // But still prefer newer if there's any date difference\r\n    const scoreA = this.getPriorityScore(a);\r\n    const scoreB = this.getPriorityScore(b);\r\n\r\n    // If one is urgent and other is not, and dates are same day, prioritize urgent\r\n    if (Math.abs(dateDiff) <= oneDay && scoreA !== scoreB) {\r\n      // If urgent (score 4), it can override same-day items\r\n      if (\r\n        scoreA === PRIORITY_SCORES.urgent &&\r\n        scoreB < PRIORITY_SCORES.urgent\r\n      ) {\r\n        return -1; // A (urgent) comes first\r\n      }\r\n      if (\r\n        scoreB === PRIORITY_SCORES.urgent &&\r\n        scoreA < PRIORITY_SCORES.urgent\r\n      ) {\r\n        return 1; // B (urgent) comes first\r\n      }\r\n      // For non-urgent priorities, still prefer newer\r\n      return dateDiff;\r\n    }\r\n\r\n    // Same priority or not urgent, newest first\r\n    return dateDiff;\r\n  }\r\n\r\n  // Add item to queue with priority-based insertion\r\n  addToQueue(newItem) {\r\n    const contentType = newItem.content_type;\r\n    // Validate content type to prevent object injection\r\n    const validContentTypes = [\"notice\", \"news\", \"event\"];\r\n    if (!validContentTypes.includes(contentType)) return;\r\n    if (!this.queues[contentType]) return;\r\n\r\n    const queue = this.queues[contentType];\r\n    const currentIndex = this.currentIndices[contentType];\r\n    const newScore = this.getPriorityScore(newItem);\r\n\r\n    // Check if item already exists (avoid duplicates)\r\n    const exists = queue.some((item) => item.id === newItem.id);\r\n    if (exists) return;\r\n\r\n    // If queue is empty, just add it\r\n    if (queue.length === 0) {\r\n      queue.push(newItem);\r\n      this.currentIndices[contentType] = 0;\r\n      return;\r\n    }\r\n\r\n    const currentDisplaying = queue[currentIndex];\r\n    const currentScore = currentDisplaying\r\n      ? this.getPriorityScore(currentDisplaying)\r\n      : 0;\r\n\r\n    // If urgent and higher than current, replace current immediately\r\n    if (newScore === PRIORITY_SCORES.urgent && newScore > currentScore) {\r\n      // Save current item to re-insert later\r\n      const currentItem = currentDisplaying;\r\n\r\n      // Remove current item temporarily\r\n      if (currentItem) {\r\n        queue.splice(currentIndex, 1);\r\n      }\r\n\r\n      // Insert urgent item at current position\r\n      queue.splice(currentIndex, 0, newItem);\r\n\r\n      // Re-insert current item after urgent (maintain position)\r\n      if (currentItem && queue.length > currentIndex + 1) {\r\n        queue.splice(currentIndex + 1, 0, currentItem);\r\n      } else if (currentItem) {\r\n        // If queue was empty, just add it\r\n        queue.push(currentItem);\r\n      }\r\n\r\n      // Keep current index pointing to urgent item\r\n      this.currentIndices[contentType] = currentIndex;\r\n      this.updateDisplay();\r\n      return;\r\n    }\r\n\r\n    // If high priority, insert right after current item\r\n    if (newScore === PRIORITY_SCORES.high && currentDisplaying) {\r\n      const insertIndex = (currentIndex + 1) % (queue.length + 1);\r\n      queue.splice(insertIndex, 0, newItem);\r\n      return;\r\n    }\r\n\r\n    // Normal insertion with priority sorting\r\n    const insertIndex = this.findInsertPosition(queue, newItem, newScore);\r\n    queue.splice(insertIndex, 0, newItem);\r\n\r\n    // Adjust current index if item was inserted before it\r\n    if (insertIndex <= currentIndex) {\r\n      this.currentIndices[contentType] = currentIndex + 1;\r\n    }\r\n  }\r\n\r\n  // Find position to insert item based on priority\r\n  findInsertPosition(queue, item, score) {\r\n    if (queue.length === 0) return 0;\r\n\r\n    for (let i = 0; i < queue.length; i++) {\r\n      const itemScore = this.getPriorityScore(queue[i]);\r\n      if (score > itemScore) {\r\n        return i;\r\n      } else if (score === itemScore) {\r\n        // Same priority, check date (newer first)\r\n        const itemDate = new Date(\r\n          queue[i].created_at ||\r\n            queue[i].published_at ||\r\n            queue[i].event_date ||\r\n            0\r\n        );\r\n        const newDate = new Date(\r\n          item.created_at || item.published_at || item.event_date || 0\r\n        );\r\n        if (newDate < itemDate) {\r\n          return i;\r\n        }\r\n      }\r\n    }\r\n\r\n    return queue.length;\r\n  }\r\n\r\n  // Fetch latest content from all types\r\n  async fetchLatestContent() {\r\n    try {\r\n      const [noticesRes, newsRes, eventsRes] = await Promise.all([\r\n        fetch(\"/api/content/notices?limit=10&status=active\"),\r\n        fetch(\"/api/content/news?limit=10&status=published\"),\r\n        fetch(\"/api/content/events?limit=10&status=upcoming\"),\r\n      ]);\r\n      const [noticesData, newsData, eventsData] = await Promise.all([\r\n        noticesRes.json(),\r\n        newsRes.json(),\r\n        eventsRes.json(),\r\n      ]);\r\n      const allContent = [];\r\n      // Process notices\r\n      if (noticesData.success && noticesData.data) {\r\n        noticesData.data.forEach((notice) => {\r\n          allContent.push({\r\n            ...notice,\r\n            content_type: \"notice\",\r\n            display_title: notice.title,\r\n            display_date: notice.created_at || notice.valid_from,\r\n          });\r\n        });\r\n      }\r\n      // Process news\r\n      if (newsData.success && newsData.data) {\r\n        newsData.data.forEach((news) => {\r\n          allContent.push({\r\n            ...news,\r\n            content_type: \"news\",\r\n            display_title: news.title,\r\n            display_date: news.published_at || news.created_at,\r\n            priority: \"normal\", // News default priority\r\n          });\r\n        });\r\n      }\r\n      // Process events\r\n      if (eventsData.success && eventsData.data) {\r\n        eventsData.data.forEach((event) => {\r\n          allContent.push({\r\n            ...event,\r\n            content_type: \"event\",\r\n            display_title: event.title,\r\n            display_date: event.event_date || event.created_at,\r\n            priority: \"normal\", // Events default priority\r\n          });\r\n        });\r\n      }\r\n      // Add all items to their respective queues with priority handling\r\n      allContent.forEach((item) => {\r\n        this.addToQueue(item);\r\n      });\r\n      // Sort each queue by latest first (newest date, then priority)\r\n      Object.keys(this.queues).forEach((contentType) => {\r\n        this.queues[contentType].sort((a, b) => this.compareItems(a, b));\r\n        // Ensure latest item is at index 0\r\n        this.currentIndices[contentType] = 0;\r\n      });\r\n      // Check if content has changed and update only if different\r\n      const hasContent = Object.values(this.queues).some(\r\n        (queue) => queue.length > 0\r\n      );\r\n      if (hasContent) {\r\n        // Check if displayed items have changed before updating\r\n        if (this.hasContentChanged()) {\r\n          // Only update if content has changed (prevents unnecessary transitions/blinking)\r\n          this.updateDisplay();\r\n        }\r\n      } else {\r\n        // If no content, clear tracked items\r\n        this.currentlyDisplayed = {\r\n          notice: null,\r\n          news: null,\r\n          event: null,\r\n        };\r\n      }\r\n      // Show banner if we have content\r\n      const banner = document.getElementById(\"content-banner\");\r\n      if (banner) {\r\n        if (hasContent) {\r\n          banner.style.display = \"block\";\r\n        } else {\r\n          banner.style.display = \"none\";\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error fetching content:\", error);\r\n    }\r\n  }\r\n  // Check if the currently displayed content has changed\r\n  hasContentChanged() {\r\n    let changed = false;\r\n    [\"notice\", \"news\", \"event\"].forEach((contentType) => {\r\n      const queue = this.queues[contentType];\r\n      const currentIndex = this.currentIndices[contentType];\r\n      if (queue.length > 0) {\r\n        const index = currentIndex % queue.length;\r\n        const currentItem = queue[index];\r\n        const currentlyDisplayedItem = this.currentlyDisplayed[contentType];\r\n        // Check if item has changed (different ID or new item)\r\n        if (\r\n          !currentlyDisplayedItem ||\r\n          currentlyDisplayedItem.id !== currentItem.id\r\n        ) {\r\n          changed = true;\r\n        }\r\n      } else {\r\n        // If queue is empty but we had content before, it changed\r\n        if (this.currentlyDisplayed[contentType] !== null) {\r\n          changed = true;\r\n        }\r\n      }\r\n    });\r\n    return changed;\r\n  }\r\n  // Update the display with current items from each type's queue\r\n  // Only called when content has actually changed\r\n  updateDisplay() {\r\n    const track = document.querySelector(\".content-banner-track\");\r\n    if (!track) return;\r\n    // Get current item for each content type from their respective queues\r\n    const itemsToShow = [];\r\n    [\"notice\", \"news\", \"event\"].forEach((contentType) => {\r\n      const queue = this.queues[contentType];\r\n      const currentIndex = this.currentIndices[contentType];\r\n      if (queue.length > 0) {\r\n        // Get item at current index (with wrap-around)\r\n        const index = currentIndex % queue.length;\r\n        const item = queue[index];\r\n        itemsToShow.push(item);\r\n        // Track this item as currently displayed\r\n        this.currentlyDisplayed[contentType] = item;\r\n      } else {\r\n        this.currentlyDisplayed[contentType] = null;\r\n      }\r\n    });\r\n    // If no items to show, hide banner\r\n    if (itemsToShow.length === 0) {\r\n      const banner = document.getElementById(\"content-banner\");\r\n      if (banner) {\r\n        banner.style.display = \"none\";\r\n      }\r\n      return;\r\n    }\r\n    // Create content items HTML\r\n    let itemHTML = \"\";\r\n    itemsToShow.forEach((item, _idx) => {\r\n      // Determine badge based on content type\r\n      let badge = \"\";\r\n      if (item.content_type === \"event\") {\r\n        badge = '<span class=\"content-badge\">[Event]</span>';\r\n      } else if (item.content_type === \"news\") {\r\n        badge = '<span class=\"content-badge\">[News]</span>';\r\n      } else if (item.content_type === \"notice\") {\r\n        badge = '<span class=\"content-badge\">[Announcement]</span>';\r\n      }\r\n      const itemClass =\r\n        item.content_type === \"news\"\r\n          ? \"content-banner-item active news-item\"\r\n          : \"content-banner-item active\";\r\n      itemHTML += `\r\n        <div class=\"${itemClass}\">\r\n          <span class=\"content-icon\">${\r\n  CONTENT_TYPE_ICONS[item.content_type] || \"📢\"\r\n}</span>\r\n          ${badge}\r\n          <span class=\"content-text\">${this.escapeHtml(\r\n    item.display_title || item.title\r\n  )}</span>\r\n        </div>\r\n      `;\r\n    });\r\n    track.innerHTML = itemHTML;\r\n    // Add click handlers to navigate to content\r\n    track\r\n      .querySelectorAll(\".content-banner-item\")\r\n      .forEach((itemElement, idx) => {\r\n        const item = itemsToShow[idx];\r\n        itemElement.style.cursor = \"pointer\";\r\n        itemElement.addEventListener(\"click\", () => {\r\n          this.navigateToContent(item);\r\n        });\r\n      });\r\n  }\r\n  // Navigate to content detail page\r\n  navigateToContent(item) {\r\n    let url = \"\";\r\n    switch (item.content_type) {\r\n      case \"notice\":\r\n        url = `/publication#notices-${item.id}`;\r\n        break;\r\n      case \"news\":\r\n        url = `/publication#news-${item.id}`;\r\n        break;\r\n      case \"event\":\r\n        url = `/publication#events-${item.id}`;\r\n        break;\r\n      default:\r\n        url = \"/publication\";\r\n    }\r\n    window.location.href = url;\r\n  }\r\n  // Sort queues and update display only if content changed\r\n  sortAndUpdate() {\r\n    // Sort all queues by latest first (newest date, then priority)\r\n    Object.keys(this.queues).forEach((contentType) => {\r\n      this.queues[contentType].sort((a, b) => this.compareItems(a, b));\r\n      // Reset index to 0 to show the latest item first\r\n      this.currentIndices[contentType] = 0;\r\n    });\r\n    // Check if content has changed before updating\r\n    if (this.hasContentChanged()) {\r\n      this.updateDisplay();\r\n    }\r\n  }\r\n  // Cleanup\r\n  destroy() {\r\n    if (this.scrollInterval) {\r\n      clearInterval(this.scrollInterval);\r\n    }\r\n    if (this.fetchInterval) {\r\n      clearInterval(this.fetchInterval);\r\n    }\r\n  }\r\n  // Escape HTML to prevent XSS\r\n  escapeHtml(text) {\r\n    const div = document.createElement(\"div\");\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n}\r\n// Initialize on page load\r\nlet bannerManager;\r\n/**\r\n * Initialize dashboard\r\n */\r\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\r\n  // Initialize content banner manager\r\n  bannerManager = new ContentBannerManager();\r\n  // Load complaints\r\n  await loadMyComplaints();\r\n  // Setup feedback listeners\r\n  setupFeedbackListeners();\r\n  // Initialize role switcher for staff members\r\n  try {\r\n    await initializeRoleToggle();\r\n  } catch (error) {\r\n    console.error(\"[CITIZEN_DASHBOARD] Error initializing role toggle:\", error);\r\n  }\r\n\r\n  // Attach event listeners to buttons (replacing inline onclick handlers)\r\n  const viewMapBtn = document.getElementById(\"view-map-btn\");\r\n  if (viewMapBtn) {\r\n    viewMapBtn.addEventListener(\"click\", () => {\r\n      window.viewMap();\r\n    });\r\n  }\r\n\r\n  const viewAllComplaintsBtn = document.getElementById(\r\n    \"view-all-complaints-btn\"\r\n  );\r\n  if (viewAllComplaintsBtn) {\r\n    viewAllComplaintsBtn.addEventListener(\"click\", () => {\r\n      window.viewAllComplaints();\r\n    });\r\n  }\r\n});\r\n// Cleanup on page unload\r\nwindow.addEventListener(\"beforeunload\", () => {\r\n  if (bannerManager) {\r\n    bannerManager.destroy();\r\n  }\r\n});\r\n/**\r\n * Load my complaints\r\n */\r\nasync function loadMyComplaints() {\r\n  const container = document.getElementById(\"my-complaints-container\");\r\n  if (!container) {\r\n    console.error(\r\n      \"[CITIZEN_DASHBOARD] Container not found: my-complaints-container\"\r\n    );\r\n    return;\r\n  }\r\n\r\n  // Check if user has a session before making API call\r\n  try {\r\n    const { supabase } = await import(\"../config/config.js\");\r\n    const {\r\n      data: { session },\r\n    } = await supabase.auth.getSession();\r\n    if (!session) {\r\n      // No session, show message and stop\r\n      container.innerHTML = `\r\n        <div class=\"empty-state\">\r\n          <div class=\"empty-state-icon\">🔒</div>\r\n          <h3>Please Log In</h3>\r\n          <p>You need to be logged in to view your complaints.</p>\r\n          <a href=\"/login\" class=\"btn btn-primary\">Go to Login</a>\r\n        </div>\r\n      `;\r\n      return;\r\n    }\r\n  } catch (error) {\r\n    // If we can't check session, continue but handle 401 gracefully\r\n  }\r\n\r\n  // Show loading state\r\n  container.innerHTML = `\r\n    <div class=\"loading\">\r\n      <div class=\"spinner\"></div>\r\n      <p>Loading your complaints...</p>\r\n    </div>\r\n  `;\r\n  try {\r\n    const response = await fetch(\"/api/complaints/my?limit=5\", {\r\n      credentials: \"include\",\r\n    });\r\n    if (!response.ok) {\r\n      // Handle 401 gracefully - redirect to login page (not HTTPS)\r\n      if (response.status === 401) {\r\n        container.innerHTML = `\r\n          <div class=\"empty-state\">\r\n            <div class=\"empty-state-icon\">🔒</div>\r\n            <h3>Session Expired</h3>\r\n            <p>Your session has expired. Please log in again.</p>\r\n            <a href=\"/login\" class=\"btn btn-primary\">Go to Login</a>\r\n          </div>\r\n        `;\r\n        return;\r\n      }\r\n      throw new Error(`Failed to load complaints: ${response.status}`);\r\n    }\r\n    const result = await response.json();\r\n    console.debug(\"[CITIZEN_DASHBOARD] Complaints fetch summary\", {\r\n      success: result.success,\r\n      complaintsCount: result.data?.length || 0,\r\n      total: result.pagination?.total || 0,\r\n      page: result.pagination?.page,\r\n      totalPages: result.pagination?.totalPages,\r\n      data: result.data?.map((c) => ({\r\n        id: c.id,\r\n        title: c.title,\r\n        status: c.workflow_status,\r\n        is_duplicate: c.is_duplicate,\r\n        cancelled_at: c.cancelled_at,\r\n      })),\r\n    });\r\n    if (result.success) {\r\n      const totalComplaints =\r\n        result.pagination?.total || result.data?.length || 0;\r\n      renderMyComplaints(result.data || [], totalComplaints);\r\n    } else {\r\n      console.error(\r\n        \"[CITIZEN_DASHBOARD] Failed to load complaints:\",\r\n        result.error\r\n      );\r\n      renderMyComplaints([], 0);\r\n    }\r\n  } catch (error) {\r\n    // Handle network errors gracefully\r\n    if (error.message && error.message.includes(\"Failed to fetch\")) {\r\n      container.innerHTML = `\r\n        <div class=\"empty-state\">\r\n          <div class=\"empty-state-icon\">⚠️</div>\r\n          <h3>Connection Error</h3>\r\n          <p>Unable to connect to the server. Please check your internet connection and try again.</p>\r\n        </div>\r\n      `;\r\n    } else {\r\n      console.error(\"[CITIZEN_DASHBOARD] Load complaints error:\", error);\r\n      showMessage(\"error\", \"Failed to load complaints. Please try again.\");\r\n      renderMyComplaints([], 0);\r\n    }\r\n  }\r\n}\r\n/**\r\n * Update summary statistics\r\n */\r\nfunction updateSummaryStats(complaints) {\r\n  const stats = {\r\n    total: complaints.length,\r\n    pending: 0,\r\n    inProgress: 0,\r\n    resolved: 0,\r\n  };\r\n\r\n  complaints.forEach((c) => {\r\n    const status = (c.workflow_status || c.status || \"new\").toLowerCase();\r\n    if (status === \"new\" || status === \"submitted\") stats.pending++;\r\n    else if (status === \"assigned\" || status === \"in_progress\")\r\n      stats.inProgress++;\r\n    else if (\r\n      status === \"resolved\" ||\r\n      status === \"completed\" ||\r\n      status === \"confirmed\" ||\r\n      status === \"closed\"\r\n    )\r\n      stats.resolved++;\r\n  });\r\n\r\n  document.getElementById(\"stat-total-submitted\").textContent = stats.total;\r\n  document.getElementById(\"stat-pending\").textContent = stats.pending;\r\n  document.getElementById(\"stat-in-progress\").textContent = stats.inProgress;\r\n  document.getElementById(\"stat-resolved\").textContent = stats.resolved;\r\n\r\n  // Check for recently resolved complaints to show feedback section\r\n  checkForRecentlyResolved(complaints);\r\n}\r\n\r\n/**\r\n * Check for recently resolved complaints to show feedback section\r\n */\r\nfunction checkForRecentlyResolved(complaints) {\r\n  const recentlyResolved = complaints.find((c) => {\r\n    const status = (c.workflow_status || c.status || \"\").toLowerCase();\r\n    // Assuming we want to show feedback for 'completed' or 'resolved' that hasn't been feedback-ed yet\r\n    // For now, we'll just show it if there's any resolved complaint\r\n    return status === \"completed\" || status === \"resolved\";\r\n  });\r\n\r\n  const feedbackSection = document.getElementById(\"feedback-section\");\r\n  if (recentlyResolved && feedbackSection) {\r\n    feedbackSection.classList.remove(\"hidden\");\r\n    feedbackSection.dataset.complaintId = recentlyResolved.id;\r\n  }\r\n}\r\n\r\n/**\r\n * Setup feedback listeners\r\n */\r\nfunction setupFeedbackListeners() {\r\n  const ratingBtns = document.querySelectorAll(\".rating-btn\");\r\n  let selectedRating = 0;\r\n\r\n  ratingBtns.forEach((btn) => {\r\n    btn.addEventListener(\"click\", () => {\r\n      selectedRating = btn.dataset.rating;\r\n      ratingBtns.forEach((b) => (b.style.transform = \"scale(1)\"));\r\n      btn.style.transform = \"scale(1.4)\";\r\n    });\r\n  });\r\n\r\n  const submitBtn = document.getElementById(\"submit-feedback-btn\");\r\n  if (submitBtn) {\r\n    submitBtn.addEventListener(\"click\", async () => {\r\n      const {complaintId} = document.getElementById(\"feedback-section\").dataset;\r\n      const comment = document.getElementById(\"feedback-comment\").value;\r\n\r\n      if (!selectedRating) {\r\n        showMessage(\"warning\", \"Please select a rating\");\r\n        return;\r\n      }\r\n\r\n      try {\r\n        const response = await fetch(\r\n          `/api/complaints/${complaintId}/feedback`,\r\n          {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify({ rating: selectedRating, comment }),\r\n          }\r\n        );\r\n\r\n        if (response.ok) {\r\n          showMessage(\"success\", \"Thank you for your feedback!\");\r\n          document.getElementById(\"feedback-section\").classList.add(\"hidden\");\r\n        } else {\r\n          throw new Error(\"Failed to submit feedback\");\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Feedback error:\", error);\r\n        showMessage(\"error\", \"Failed to submit feedback\");\r\n      }\r\n    });\r\n  }\r\n}\r\n/**\r\n * Render my complaints\r\n */\r\nfunction renderMyComplaints(complaints, totalCount = null) {\r\n  const container = document.getElementById(\"my-complaints-container\");\r\n  if (!container) {\r\n    console.error(\r\n      \"[CITIZEN_DASHBOARD] Container not found: my-complaints-container\"\r\n    );\r\n    return;\r\n  }\r\n  console.debug(\"[CITIZEN_DASHBOARD] Render complaints inputs\", {\r\n    count: complaints.length,\r\n    totalCount,\r\n    complaints: complaints.map((c) => ({\r\n      id: c.id,\r\n      title: c.title,\r\n      status: c.workflow_status || c.status,\r\n      submitted_at: c.submitted_at,\r\n    })),\r\n  });\r\n  if (complaints.length === 0) {\r\n    container.innerHTML = `\r\n      <div class=\"empty-state\">\r\n        <div class=\"empty-state-icon\">📝</div>\r\n        <h3>No Complaints Yet</h3>\r\n        <p>You haven't filed any complaints yet. Click \"File Complaint\" to get started!</p>\r\n        <a href=\"/fileComplaint\" class=\"btn btn-primary\">File Your First Complaint</a>\r\n      </div>\r\n    `;\r\n    return;\r\n  }\r\n  // Show total count if available and different from displayed count\r\n  let countInfo = \"\";\r\n  if (totalCount !== null && totalCount > complaints.length) {\r\n    countInfo = `<div class=\"complaints-count-info\" style=\"margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem;\">\r\n      Showing ${complaints.length} of ${totalCount} complaints\r\n    </div>`;\r\n  }\r\n\r\n  // Filter out duplicate and cancelled complaints for display (but show them in count)\r\n  const filteredComplaints = complaints.filter((_complaint) => {\r\n    // Don't filter - show all complaints including duplicates and cancelled\r\n    // The user might want to see them\r\n    return true;\r\n  });\r\n\r\n  console.debug(\"[CITIZEN_DASHBOARD] Render complaints derived metrics\", {\r\n    total: complaints.length,\r\n    filtered: filteredComplaints.length,\r\n    duplicates: complaints.filter((c) => c.is_duplicate).length,\r\n    cancelled: complaints.filter((c) => c.cancelled_at).length,\r\n  });\r\n\r\n  const html = filteredComplaints\r\n    .map((complaint) => {\r\n      const status = complaint.workflow_status || complaint.status || \"new\";\r\n      const statusClass = status.toLowerCase().replace(/[_\\s]/g, \"-\");\r\n      const statusLabel = formatStatus(status);\r\n\r\n      // Add visual indicator for duplicates and cancelled\r\n      let statusBadge = \"\";\r\n      if (complaint.is_duplicate) {\r\n        statusBadge =\r\n          '<span style=\"font-size: 0.7rem; color: #f59e0b; margin-left: 0.5rem;\">(Duplicate)</span>';\r\n      }\r\n      if (complaint.cancelled_at) {\r\n        statusBadge =\r\n          '<span style=\"font-size: 0.7rem; color: #ef4444; margin-left: 0.5rem;\">(Cancelled)</span>';\r\n      }\r\n      return `\r\n    <div class=\"complaint-item\" data-complaint-id=\"${escapeHtml(complaint.id)}\">\r\n      <div class=\"complaint-header\">\r\n        <h4 class=\"complaint-title\">${escapeHtml(\r\n    complaint.title\r\n  )}${statusBadge}</h4>\r\n        <span class=\"complaint-status status-${statusClass}\">${statusLabel}</span>\r\n      </div>\r\n      <div class=\"complaint-meta\">\r\n        <span class=\"complaint-id\" style=\"font-size: 0.75rem; color: #9ca3af;\">${complaint.id.substring(\r\n    0,\r\n    8\r\n  )}...</span>\r\n        <span class=\"complaint-type\">${escapeHtml(\r\n    complaint.type || complaint.category || \"N/A\"\r\n  )}</span>\r\n        <span class=\"complaint-date\">${formatDate(\r\n    complaint.submitted_at\r\n  )}</span>\r\n      </div>\r\n      <div class=\"complaint-progress\">\r\n        ${renderCompactStepper(status, complaint.confirmed_by_citizen)}\r\n        <span class=\"progress-text\">${getProgressText(status)}</span>\r\n      </div>\r\n      ${\r\n  complaint.coordinator_notes\r\n    ? `\r\n      <div class=\"complaint-remarks animate-fade-in\" style=\"margin-top: 1rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.05); border-left: 3px solid #3b82f6; border-radius: 4px;\">\r\n        <div style=\"font-size: 0.75rem; font-weight: 600; color: #3b82f6; margin-bottom: 0.25rem;\">OFFICER REMARKS</div>\r\n        <p style=\"font-size: 0.875rem; color: #4b5563; margin: 0;\">${escapeHtml(\r\n    complaint.coordinator_notes\r\n  )}</p>\r\n      </div>\r\n      `\r\n    : \"\"\r\n}\r\n    </div>\r\n  `;\r\n    })\r\n    .join(\"\");\r\n  container.innerHTML = countInfo + html;\r\n\r\n  // Update summary stats\r\n  updateSummaryStats(complaints);\r\n\r\n  // Attach event listeners to complaint items using event delegation\r\n  container.querySelectorAll(\".complaint-item\").forEach((item) => {\r\n    item.addEventListener(\"click\", () => {\r\n      const complaintId = item.getAttribute(\"data-complaint-id\");\r\n      if (complaintId) {\r\n        window.viewComplaintDetail(complaintId);\r\n      }\r\n    });\r\n  });\r\n}\r\n/**\r\n * Helper functions\r\n */\r\nfunction formatStatus(status) {\r\n  if (!status) return \"New\";\r\n  return status\r\n    .split(\"_\")\r\n    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))\r\n    .join(\" \");\r\n}\r\nfunction renderCompactStepper(status, confirmedByCitizen = false) {\r\n  // Map workflow status to step number (0-4, with 5 as cancelled)\r\n  const workflowStatus = (status || \"new\").toLowerCase();\r\n  const isCancelled = workflowStatus === \"cancelled\";\r\n  const statusStepMap = {\r\n    new: 0,\r\n    assigned: 1,\r\n    in_progress: 2,\r\n    pending_approval: 3,\r\n    completed: 3, // Step 3: awaiting citizen confirmation, not fully completed yet\r\n    submitted: 0,\r\n    under_review: 1,\r\n    resolved: 3,\r\n    waiting_for_responders: 3,\r\n    waiting_for_complainant: 3,\r\n    confirmed: 4, // Step 4: citizen confirmed, fully completed\r\n    closed: 4,\r\n  };\r\n  // For cancelled complaints, don't show any active steps - gray everything out\r\n  // Otherwise, show progress up to the current step\r\n  let currentStep = isCancelled\r\n    ? -1\r\n    : statusStepMap[workflowStatus] !== void 0\r\n      ? statusStepMap[workflowStatus]\r\n      : 0;\r\n\r\n  // If citizen has confirmed, show step 4 (all circles completed) even if status is still 'completed'\r\n  if (\r\n    !isCancelled &&\r\n    confirmedByCitizen &&\r\n    (workflowStatus === \"completed\" || workflowStatus === \"resolved\")\r\n  ) {\r\n    currentStep = 4;\r\n  }\r\n\r\n  // Node colors for each step (orange → red → pink → purple)\r\n  const nodeColors = [\"#3b82f6\", \"#3b82f6\", \"#3b82f6\", \"#3b82f6\", \"#3b82f6\"];\r\n  // Build compact stepper HTML\r\n  let stepperHTML = '<div class=\"compact-stepper-container\">';\r\n  for (let i = 0; i < 5; i++) {\r\n    // If cancelled, all steps are inactive (grayed out)\r\n    // Otherwise, active steps are those up to currentStep (0-4)\r\n    const isActive = isCancelled ? false : i <= currentStep && i < 5;\r\n    // Get node color - if cancelled, everything is grey\r\n    const nodeColor = isCancelled\r\n      ? \"#9ca3af\"\r\n      : isActive\r\n        ? nodeColors[i]\r\n        : \"#9ca3af\";\r\n    // Determine connector line style\r\n    let connectorStyle = \"\";\r\n    if (i < 4) {\r\n      // If cancelled, all connectors are grey\r\n      // Otherwise, color connector through the current step as well (continuous bar effect)\r\n      const isConnectorActive = isCancelled ? false : i <= currentStep;\r\n      if (isConnectorActive) {\r\n        // Active connector solid blue\r\n        connectorStyle = \"#3b82f6\";\r\n      } else {\r\n        connectorStyle = \"#e5e7eb\";\r\n      }\r\n    }\r\n    // No glow/box-shadow for nodes\r\n    const boxShadow = \"none\";\r\n    stepperHTML += `\r\n      <div class=\"compact-stepper-step ${isActive ? \"active\" : \"\"}\">\r\n        <div class=\"compact-stepper-node\" style=\"background-color: ${nodeColor}; box-shadow: ${boxShadow};\"></div>\r\n        ${\r\n  i < 4\r\n    ? `\r\n        <div class=\"compact-stepper-connector\" style=\"background: ${connectorStyle};\"></div>\r\n        `\r\n    : \"\"\r\n}\r\n      </div>\r\n    `;\r\n  }\r\n  stepperHTML += \"</div>\";\r\n  // Labels row under the stepper, aligned with nodes\r\n  const stepLabels = [\r\n    \"New\",\r\n    \"Assigned\",\r\n    \"In Progress\",\r\n    \"Pending Approval\",\r\n    \"Completed\",\r\n  ];\r\n  stepperHTML += '<div class=\"compact-stepper-labels\">';\r\n  for (let i = 0; i < 5; i++) {\r\n    const isActive = !isCancelled && i <= currentStep;\r\n    stepperHTML += `\r\n      <div class=\"compact-stepper-label-item ${isActive ? \"active\" : \"\"}\">${\r\n  stepLabels[i]\r\n}</div>\r\n    `;\r\n  }\r\n  stepperHTML += \"</div>\";\r\n  return stepperHTML;\r\n}\r\nfunction _hexToRgb(hex) {\r\n  const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\r\n  return result\r\n    ? [\r\n      parseInt(result[1], 16),\r\n      parseInt(result[2], 16),\r\n      parseInt(result[3], 16),\r\n    ]\r\n    : [0, 0, 0];\r\n}\r\nfunction _getProgressWidth(status) {\r\n  // Deprecated - keeping for backward compatibility if needed elsewhere\r\n  const progressMap = {\r\n    new: 20,\r\n    assigned: 40,\r\n    in_progress: 75,\r\n    pending_approval: 85,\r\n    completed: 100,\r\n    cancelled: 0,\r\n    submitted: 25,\r\n    under_review: 50,\r\n    resolved: 90,\r\n    waiting_for_responders: 90,\r\n    waiting_for_complainant: 90,\r\n    confirmed: 100,\r\n    closed: 100,\r\n  };\r\n  return progressMap[status] || 20;\r\n}\r\nfunction getProgressText(status) {\r\n  const textMap = {\r\n    new: \"New Complaint\",\r\n    assigned: \"Assigned to Coordinator\",\r\n    in_progress: \"Being Processed by Officers\",\r\n    pending_approval: \"Pending Approval\",\r\n    completed: \"Completed - Awaiting Your Confirmation\",\r\n    cancelled: \"Cancelled\",\r\n    submitted: \"Submitted\",\r\n    under_review: \"Under Review\",\r\n    resolved: \"Resolved\",\r\n    closed: \"Closed\",\r\n    waiting_for_responders: \"Waiting for responders' confirmation\",\r\n    waiting_for_complainant: \"Waiting for your confirmation\",\r\n    confirmed: \"Confirmed by you - Resolution Complete\",\r\n  };\r\n  return textMap[status] || \"Unknown\";\r\n}\r\nfunction formatDate(dateString) {\r\n  if (!dateString) return \"N/A\";\r\n  const date = new Date(dateString);\r\n  const now = new Date();\r\n  const diff = now - date;\r\n  const minutes = Math.floor(diff / 60000);\r\n  const hours = Math.floor(diff / 3600000);\r\n  const days = Math.floor(diff / 86400000);\r\n  if (minutes < 60) return `${minutes}m ago`;\r\n  if (hours < 24) return `${hours}h ago`;\r\n  if (days < 7) return `${days}d ago`;\r\n  return date.toLocaleDateString();\r\n}\r\nfunction escapeHtml(text) {\r\n  if (!text) return \"\";\r\n  const div = document.createElement(\"div\");\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n/**\r\n * Global functions for onclick handlers\r\n */\r\nwindow.viewMyComplaints = function () {\r\n  showMessage(\"info\", \"Redirecting to complaints page...\");\r\n  window.location.href = \"/myProfile#complaints\";\r\n};\r\nwindow.viewMap = function () {\r\n  window.location.href = \"/heatmap\";\r\n};\r\nwindow.viewAllComplaints = function () {\r\n  window.location.href = \"/myProfile#complaints\";\r\n};\r\nwindow.viewComplaintDetail = function (complaintId) {\r\n  window.location.href = `/complaint-details/${complaintId}?from=dashboard`;\r\n};\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\citizen-file-complaint-access.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\complaint-details.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected alert.","line":693,"column":7,"nodeType":"CallExpression","messageId":"unexpected","endLine":693,"endColumn":59},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":860,"column":38,"nodeType":"CallExpression","messageId":"returnsValue","endLine":860,"endColumn":62,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[34499,34523],"text":"{setTimeout(resolve, 100)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1271,"column":25,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1271,"endColumn":122},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1298,"column":25,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1298,"endColumn":89},{"ruleId":"no-alert","severity":1,"message":"Unexpected prompt.","line":1516,"column":20,"nodeType":"CallExpression","messageId":"unexpected","endLine":1516,"endColumn":68},{"ruleId":"no-alert","severity":1,"message":"Unexpected prompt.","line":1550,"column":19,"nodeType":"CallExpression","messageId":"unexpected","endLine":1550,"endColumn":61},{"ruleId":"no-alert","severity":1,"message":"Unexpected prompt.","line":1579,"column":20,"nodeType":"CallExpression","messageId":"unexpected","endLine":1579,"endColumn":71},{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":1581,"column":10,"nodeType":"CallExpression","messageId":"unexpected","endLine":1581,"endColumn":68},{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":1611,"column":10,"nodeType":"CallExpression","messageId":"unexpected","endLine":1611,"endColumn":77}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Complaint Details Page JavaScript\r\nimport showToast from \"../components/toast.js\";\r\n\r\nclass ComplaintDetails {\r\n\r\n  constructor() {\r\n    this.complaintId = null;\r\n    this.complaint = null;\r\n    this.userRole = null;\r\n    this.map = null;\r\n    this.routingControl = null;\r\n    this.userLocation = null;\r\n    this.boundaryData = null;\r\n    this.boundaryLayer = null;\r\n    this.boundaryVisible = false;\r\n    this.boundaryToggleButton = null;\r\n    this.init();\r\n    // Cleanup map when page is unloaded\r\n    window.addEventListener(\"beforeunload\", () => {\r\n      if (this.map) {\r\n        this.map.remove();\r\n      }\r\n    });\r\n  }\r\n  async init() {\r\n    try {\r\n      // Clean up any stuck modal overlays\r\n      this.cleanupStuckModals();\r\n\r\n      // Show loading spinner immediately\r\n      this.showLoading();\r\n\r\n      // Hide complaint details container initially to prevent showing dummy content\r\n      const detailsContainer = document.getElementById(\"complaint-details\");\r\n      if (detailsContainer) {\r\n        detailsContainer.style.display = \"none\";\r\n      }\r\n\r\n      // Clear placeholder text immediately to prevent showing dummy content\r\n      const descriptionEl = document.getElementById(\"complaint-description\");\r\n      if (descriptionEl) {\r\n        descriptionEl.textContent = \"\";\r\n      }\r\n      const titleEl = document.getElementById(\"complaint-title\");\r\n      if (titleEl) {\r\n        titleEl.textContent = \"\";\r\n      }\r\n      const idEl = document.getElementById(\"complaint-id\");\r\n      if (idEl) {\r\n        idEl.textContent = \"\";\r\n      }\r\n      const statusEl = document.getElementById(\"complaint-status\");\r\n      if (statusEl) {\r\n        statusEl.textContent = \"\";\r\n      }\r\n      const priorityEl = document.getElementById(\"complaint-priority\");\r\n      if (priorityEl) {\r\n        priorityEl.textContent = \"\";\r\n      }\r\n      const locationEl = document.getElementById(\"complaint-location\");\r\n      if (locationEl) {\r\n        locationEl.innerHTML = \"\";\r\n      }\r\n      const attachmentsEl = document.getElementById(\"complaint-attachments\");\r\n      if (attachmentsEl) {\r\n        attachmentsEl.innerHTML = \"\";\r\n      }\r\n      const timelineEl = document.getElementById(\"timeline-items\");\r\n      if (timelineEl) {\r\n        timelineEl.innerHTML = \"\";\r\n      }\r\n\r\n      // Get complaint ID from URL - try both path parameter and query parameter\r\n      const pathParts = window.location.pathname.split(\"/\");\r\n      let complaintId = pathParts[pathParts.length - 1];\r\n      // If the last part is 'complaint-details', try query parameter\r\n      if (!complaintId || complaintId === \"complaint-details\") {\r\n        const urlParams = new URLSearchParams(window.location.search);\r\n        complaintId = urlParams.get(\"id\");\r\n      }\r\n      if (!complaintId || complaintId === \"complaint-details\") {\r\n        throw new Error(\"Invalid complaint ID\");\r\n      }\r\n      // Validate UUID format (basic check)\r\n      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\r\n      if (!uuidRegex.test(complaintId)) {\r\n        throw new Error(\"Invalid complaint ID format\");\r\n      }\r\n      this.complaintId = complaintId;\r\n      // Get user role\r\n      this.userRole = await this.getUserRole();\r\n      // Load complaint details\r\n      await this.loadComplaintDetails();\r\n      // Setup role-specific UI only if complaint was successfully loaded\r\n      if (this.complaint) {\r\n        this.setupRoleSpecificUI();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error initializing complaint details:\", error);\r\n      this.showError(`Failed to load complaint details: ${  error.message}`);\r\n    }\r\n  }\r\n  async getUserRole() {\r\n    try {\r\n      const response = await fetch(\"/api/user/role\", {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        credentials: \"include\"\r\n      });\r\n      if (!response.ok) {\r\n        throw new Error(\"Failed to get user role\");\r\n      }\r\n      const data = await response.json();\r\n      return data.data.role;\r\n    } catch (error) {\r\n      console.error(\"Error getting user role:\", error);\r\n      return \"citizen\"; // Default fallback\r\n    }\r\n  }\r\n  async loadComplaintDetails() {\r\n    try {\r\n      this.showLoading();\r\n      const response = await fetch(`/api/complaints/${this.complaintId}`, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        credentials: \"include\"\r\n      });\r\n      if (!response.ok) {\r\n        // Handle 404 specifically with a user-friendly message\r\n        if (response.status === 404) {\r\n          const errorData = await response.json().catch(() => ({}));\r\n          const errorMsg = errorData.error || \"Complaint not found\";\r\n          // Provide more context for 404 errors\r\n          if (errorMsg.toLowerCase().includes(\"not found\") || errorMsg.toLowerCase().includes(\"does not exist\")) {\r\n            throw new Error(\"The complaint you are looking for does not exist or may have been deleted. Please check the complaint ID and try again.\");\r\n          }\r\n          throw new Error(errorMsg);\r\n        }\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      const data = await response.json();\r\n      if (!data.success) {\r\n        throw new Error(data.error || \"Failed to load complaint\");\r\n      }\r\n      this.complaint = data.data;\r\n      // Load evidence/attachments separately\r\n      await this.loadComplaintEvidence();\r\n      this.renderComplaintDetails();\r\n    } catch (error) {\r\n      console.error(\"Error loading complaint details:\", error);\r\n      // Ensure complaint is null when load fails\r\n      this.complaint = null;\r\n      this.showError(`Failed to load complaint details: ${error.message}`);\r\n    } finally {\r\n      this.hideLoading();\r\n    }\r\n  }\r\n  async loadComplaintEvidence() {\r\n    // Return early if complaint is not loaded\r\n    if (!this.complaint) {\r\n      console.warn(\"Cannot load complaint evidence: complaint is null\");\r\n      return;\r\n    }\r\n    // Skip evidence loading if we're getting SSL errors to prevent infinite redirects\r\n    if (window.location.protocol === \"https:\" && window.location.hostname === \"localhost\") {\r\n      console.log(\"Skipping evidence loading due to HTTPS redirect issue\");\r\n      this.complaint.attachments = [];\r\n      return;\r\n    }\r\n    try {\r\n      // Use absolute HTTP URL to avoid any protocol issues\r\n      const baseUrl = \"http://localhost:3000\";\r\n      const response = await fetch(`${baseUrl}/api/complaints/${this.complaintId}/evidence`, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          \"Accept\": \"application/json\"\r\n        },\r\n        credentials: \"include\",\r\n        mode: \"cors\"\r\n      });\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        if (data.success) {\r\n          this.complaint.attachments = data.data || [];\r\n        } else {\r\n          console.log(\"Evidence API returned error:\", data.message);\r\n          this.complaint.attachments = [];\r\n        }\r\n      } else {\r\n        console.log(\"Evidence API request failed with status:\", response.status);\r\n        this.complaint.attachments = [];\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error loading complaint evidence:\", error);\r\n      // If the error is due to HTTPS redirect or SSL issues, try with relative URL\r\n      if (error.message.includes(\"SSL\") || error.message.includes(\"HTTPS\") || error.message.includes(\"ERR_SSL_PROTOCOL_ERROR\")) {\r\n        try {\r\n          console.log(\"Attempting fallback with relative URL...\");\r\n          const response = await fetch(`/api/complaints/${this.complaintId}/evidence`, {\r\n            method: \"GET\",\r\n            headers: {\r\n              \"Content-Type\": \"application/json\",\r\n              \"Accept\": \"application/json\"\r\n            },\r\n            credentials: \"include\"\r\n          });\r\n          if (response.ok) {\r\n            const data = await response.json();\r\n            if (data.success) {\r\n              this.complaint.attachments = data.data || [];\r\n              console.log(\"Fallback request successful\");\r\n            } else {\r\n              this.complaint.attachments = [];\r\n            }\r\n          } else {\r\n            this.complaint.attachments = [];\r\n          }\r\n        } catch (fallbackError) {\r\n          console.error(\"Fallback request also failed:\", fallbackError);\r\n          this.complaint.attachments = [];\r\n        }\r\n      } else {\r\n        this.complaint.attachments = [];\r\n      }\r\n    }\r\n  }\r\n  async renderComplaintDetails() {\r\n    const detailsContainer = document.getElementById(\"complaint-details\");\r\n    if (!detailsContainer) return;\r\n    // Return early if complaint is not loaded\r\n    if (!this.complaint) {\r\n      console.warn(\"Cannot render complaint details: complaint is null\");\r\n      return;\r\n    }\r\n    // Populate basic complaint info\r\n    document.getElementById(\"complaint-title\").textContent = this.complaint.title || \"Untitled Complaint\";\r\n    document.getElementById(\"complaint-id\").textContent = `#${this.complaint.id}`;\r\n    // Prefer workflow_status, then confirmation_status; map to user-friendly text\r\n    const wf = (this.complaint.workflow_status || \"\").toLowerCase();\r\n    let displayStatus;\r\n    if (this.complaint.confirmation_status && this.complaint.confirmation_status !== \"pending\") {\r\n      displayStatus = this.complaint.confirmation_status;\r\n    } else if (wf === \"completed\") {\r\n      displayStatus = \"resolved\";\r\n    } else if (wf === \"in_progress\" || wf === \"pending_approval\" || wf === \"assigned\") {\r\n      displayStatus = \"in progress\";\r\n    } else if (wf === \"cancelled\") {\r\n      displayStatus = \"cancelled\";\r\n    } else if (wf === \"rejected_false\") {\r\n      displayStatus = \"rejected\";\r\n    } else if (wf === \"new\") {\r\n      displayStatus = \"new\";\r\n    } else {\r\n      displayStatus = this.complaint.status || \"Unknown\";\r\n    }\r\n    const statusClass = this.getStatusClass(displayStatus);\r\n    document.getElementById(\"complaint-status\").textContent = this.getStatusDisplayText(displayStatus);\r\n    document.getElementById(\"complaint-status\").className = `complaint-status ${statusClass}`;\r\n    document.getElementById(\"complaint-priority\").textContent = this.complaint.priority || \"Medium\";\r\n    document.getElementById(\"complaint-priority\").className = `complaint-priority priority-${(this.complaint.priority || \"medium\").toLowerCase()}`;\r\n    document.getElementById(\"complaint-description\").textContent = this.complaint.descriptive_su || \"No description provided\";\r\n    // Display assignment progress if available\r\n    this.displayAssignmentProgress();\r\n    // Load and display confirmation message\r\n    await this.loadConfirmationMessage();\r\n    // Populate location\r\n    this.renderLocation();\r\n    // Populate complainant info (only for admin, officers, coordinators)\r\n    this.renderComplainantInfo();\r\n    // Populate attachments\r\n    this.renderAttachments();\r\n    // Populate timeline\r\n    this.renderTimeline();\r\n    // Show the details (ensure grid layout)\r\n    detailsContainer.style.display = \"grid\";\r\n  }\r\n  renderComplainantInfo() {\r\n    const complainantSection = document.getElementById(\"complainant-section\");\r\n    const complainantInfo = document.getElementById(\"complainant-info\");\r\n    if (!complainantSection || !complainantInfo) return;\r\n    // Show complainant info only for admin, officers, and complaint coordinator\r\n    const rolesThatCanSeeComplainant = [\"complaint-coordinator\", \"lgu-admin\", \"lgu\", \"lgu-officer\", \"super-admin\", \"hr\"];\r\n    const canSeeComplainant = rolesThatCanSeeComplainant.includes(this.userRole);\r\n    if (canSeeComplainant && this.complaint.submitted_by_profile) {\r\n      const profile = this.complaint.submitted_by_profile;\r\n      const name = profile.name || profile.email || \"Unknown\";\r\n      const email = profile.email || \"Not provided\";\r\n      const firstName = profile.firstName || \"\";\r\n      const lastName = profile.lastName || \"\";\r\n\r\n      // Get phone number from multiple possible fields\r\n      const rawMeta = profile.raw_user_meta_data || {};\r\n      const phoneNumber = profile.mobileNumber ||\r\n                         profile.mobile ||\r\n                         rawMeta.mobile_number ||\r\n                         rawMeta.mobile ||\r\n                         rawMeta.phone_number ||\r\n                         rawMeta.phone ||\r\n                         null;\r\n\r\n      // Get address from metadata - check multiple formats\r\n      const address = rawMeta.address || {};\r\n      const addressParts = [];\r\n\r\n      // Check for address_line_1, address_line_2 format\r\n      if (rawMeta.address_line_1) addressParts.push(rawMeta.address_line_1);\r\n      if (rawMeta.address_line_2) addressParts.push(rawMeta.address_line_2);\r\n\r\n      // Check for nested address object\r\n      if (address.line1) addressParts.push(address.line1);\r\n      if (address.line2) addressParts.push(address.line2);\r\n\r\n      // Check for old format\r\n      if (rawMeta.addressLine1 && !addressParts.includes(rawMeta.addressLine1)) {\r\n        addressParts.push(rawMeta.addressLine1);\r\n      }\r\n      if (rawMeta.addressLine2 && !addressParts.includes(rawMeta.addressLine2)) {\r\n        addressParts.push(rawMeta.addressLine2);\r\n      }\r\n\r\n      // Add city, province, barangay, postal code if available\r\n      if (rawMeta.city || address.city) addressParts.push(rawMeta.city || address.city);\r\n      if (rawMeta.barangay || address.barangay) addressParts.push(rawMeta.barangay || address.barangay);\r\n      if (rawMeta.province || address.province) addressParts.push(rawMeta.province || address.province);\r\n      if (rawMeta.postal_code || address.postalCode) addressParts.push(rawMeta.postal_code || address.postalCode);\r\n\r\n      const fullAddress = addressParts.filter(Boolean).join(\", \") || null;\r\n\r\n      complainantInfo.innerHTML = `\r\n                <div class=\"complainant-details\">\r\n                    <div class=\"complainant-field\">\r\n                        <span class=\"field-label\">Name:</span>\r\n                        <span class=\"field-value\">${this.escapeHtml(name)}</span>\r\n                    </div>\r\n                    ${firstName || lastName ? `\r\n                    <div class=\"complainant-field\">\r\n                        <span class=\"field-label\">Full Name:</span>\r\n                        <span class=\"field-value\">${this.escapeHtml(`${firstName} ${lastName}`.trim() || name)}</span>\r\n                    </div>\r\n                    ` : \"\"}\r\n                    <div class=\"complainant-field\">\r\n                        <span class=\"field-label\">Email:</span>\r\n                        <span class=\"field-value\">\r\n                            <a href=\"mailto:${this.escapeHtml(email)}\" class=\"complainant-link\">${this.escapeHtml(email)}</a>\r\n                        </span>\r\n                    </div>\r\n                    <div class=\"complainant-field\">\r\n                        <span class=\"field-label\">Phone Number:</span>\r\n                        <span class=\"field-value\">\r\n                            ${phoneNumber ? `\r\n                            <a href=\"tel:${this.escapeHtml(phoneNumber)}\" class=\"complainant-link\">${this.escapeHtml(phoneNumber)}</a>\r\n                            ` : '<span style=\"color: #9ca3af;\">Not provided</span>'}\r\n                        </span>\r\n                    </div>\r\n                    <div class=\"complainant-field\">\r\n                        <span class=\"field-label\">Address:</span>\r\n                        <span class=\"field-value\">\r\n                            ${fullAddress ? this.escapeHtml(fullAddress) : '<span style=\"color: #9ca3af;\">Not provided</span>'}\r\n                        </span>\r\n                    </div>\r\n                </div>\r\n            `;\r\n      complainantSection.style.display = \"block\";\r\n    } else {\r\n      complainantSection.style.display = \"none\";\r\n    }\r\n  }\r\n  escapeHtml(text) {\r\n    if (!text) return \"\";\r\n    const div = document.createElement(\"div\");\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n  getStatusClass(status) {\r\n    const statusMap = {\r\n      \"pending\": \"status-pending\",\r\n      \"waiting_for_responders\": \"status-warning\",\r\n      \"waiting_for_complainant\": \"status-info\",\r\n      \"confirmed\": \"status-success\",\r\n      \"disputed\": \"status-danger\",\r\n      \"in progress\": \"status-info\",\r\n      \"resolved\": \"status-success\",\r\n      \"cancelled\": \"status-secondary\",\r\n      \"rejected\": \"status-danger\"\r\n    };\r\n    return statusMap[status] || \"status-pending\";\r\n  }\r\n  getStatusDisplayText(status) {\r\n    const displayMap = {\r\n      \"pending\": \"Pending\",\r\n      \"waiting_for_responders\": \"Waiting for LGU Responders\",\r\n      \"waiting_for_complainant\": \"Ready for Your Confirmation\",\r\n      \"confirmed\": \"Resolution Confirmed by You\",\r\n      \"disputed\": \"Disputed\",\r\n      \"in progress\": \"In Progress\",\r\n      \"resolved\": \"Resolved\",\r\n      \"cancelled\": \"Cancelled\",\r\n      \"rejected\": \"Rejected\",\r\n      \"new\": \"New Complaint\",\r\n      \"assigned\": \"Assigned to Coordinator\",\r\n      \"completed\": \"Completed - Awaiting Confirmation\"\r\n    };\r\n    return displayMap[status] || status || \"Unknown\";\r\n  }\r\n  displayAssignmentProgress() {\r\n    const progress = this.complaint.assignment_progress;\r\n    if (!progress || progress.totalAssignments === 0) {\r\n      return; // No assignments to show progress for\r\n    }\r\n    // Find or create assignment progress element\r\n    let progressElement = document.getElementById(\"assignment-progress\");\r\n    if (!progressElement) {\r\n      const statusElement = document.getElementById(\"complaint-status\");\r\n      if (statusElement && statusElement.parentNode) {\r\n        progressElement = document.createElement(\"div\");\r\n        progressElement.id = \"assignment-progress\";\r\n        progressElement.className = \"assignment-progress\";\r\n        statusElement.parentNode.insertBefore(progressElement, statusElement.nextSibling);\r\n      }\r\n    }\r\n    if (progressElement) {\r\n      const isCompleted = progress.completedAssignments === progress.totalAssignments;\r\n      const progressBar = `\r\n                <div class=\"progress-container\">\r\n                    <div class=\"progress-info\">\r\n                        <span class=\"progress-text\">${progress.progressText}</span>\r\n                        <span class=\"progress-percentage\">${progress.progressPercentage}%</span>\r\n                    </div>\r\n                    <div class=\"progress-bar\">\r\n                        <div class=\"progress-fill ${isCompleted ? \"completed\" : \"\"}\"\r\n                             style=\"width: ${progress.progressPercentage}%\"></div>\r\n                    </div>\r\n                </div>\r\n            `;\r\n      progressElement.innerHTML = progressBar;\r\n    }\r\n  }\r\n  async loadConfirmationMessage() {\r\n    try {\r\n      const response = await fetch(`/api/complaints/${this.complaintId}/confirmation-message`, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        credentials: \"include\"\r\n      });\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        if (data.success && data.data.message) {\r\n          this.displayConfirmationMessage(data.data.message);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error loading confirmation message:\", error);\r\n    }\r\n  }\r\n  shouldShowConfirmationButton() {\r\n    // Match backend validation logic closely, but do not block on delayed confirmation_status updates\r\n    // Show confirmation button ONLY after coordinator has assigned to officers\r\n    // 1. Check if citizen already confirmed\r\n    if (this.complaint.confirmed_by_citizen) {\r\n      return false;\r\n    }\r\n    // 2. Check workflow status - show button after coordinator assigns to officers\r\n    const coordinatorAssignedStatuses = [\"assigned\", \"in_progress\", \"pending_approval\", \"completed\"];\r\n    if (!coordinatorAssignedStatuses.includes(this.complaint.workflow_status)) {\r\n      return false;\r\n    }\r\n    // 3. If assignments exist and all assignments are complete, show the button regardless of confirmation_status\r\n    const progress = this.complaint.assignment_progress;\r\n    if (progress && progress.totalAssignments > 0) {\r\n\r\n      if (progress.completedAssignments === progress.totalAssignments) {\r\n        return true;\r\n      }\r\n      // If not all completed, fall through to stricter checks\r\n      return false;\r\n    }\r\n    // 4. Fallback to confirmation_status gate when no assignment info is available\r\n    const validConfirmationStatuses = [\"waiting_for_complainant\", \"confirmed\", \"disputed\", \"pending\"];\r\n    if (!validConfirmationStatuses.includes(this.complaint.confirmation_status)) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n  displayConfirmationMessage(message) {\r\n    // Find or create confirmation status element\r\n    let confirmationElement = document.getElementById(\"confirmation-status\");\r\n    if (!confirmationElement) {\r\n      // Create confirmation status element after the complaint status\r\n      const statusElement = document.getElementById(\"complaint-status\");\r\n      if (statusElement && statusElement.parentNode) {\r\n        confirmationElement = document.createElement(\"div\");\r\n        confirmationElement.id = \"confirmation-status\";\r\n        confirmationElement.className = \"confirmation-status\";\r\n        statusElement.parentNode.insertBefore(confirmationElement, statusElement.nextSibling);\r\n      }\r\n    }\r\n    if (confirmationElement) {\r\n      confirmationElement.textContent = message;\r\n      // Add appropriate styling based on message content and complaint status\r\n      let cssClass = \"confirmation-status\";\r\n      if (message.includes(\"Please confirm\") || message.includes(\"Waiting for your\")) {\r\n        cssClass += \" action-required\";\r\n      } else if (message.includes(\"confirmed\") || message.includes(\"Completed\")) {\r\n        cssClass += \" confirmed\";\r\n      } else if (message.includes(\"Waiting for\")) {\r\n        cssClass += \" waiting\";\r\n      } else {\r\n        cssClass += \" info\";\r\n      }\r\n      confirmationElement.className = cssClass;\r\n    }\r\n  }\r\n  renderLocation() {\r\n    const locationContainer = document.getElementById(\"complaint-location\");\r\n    if (!locationContainer) return;\r\n    if (this.complaint.location_text) {\r\n      const hasCoordinates = this.complaint.latitude && this.complaint.longitude;\r\n      const canUseBoundaryToggle = this.canUseBoundaryToggle();\r\n      locationContainer.innerHTML = `\r\n        <div class=\"location-address\">${this.complaint.location_text}</div>\r\n        ${hasCoordinates ? `\r\n          <div class=\"location-coordinates\">${this.complaint.latitude}, ${this.complaint.longitude}</div>\r\n          <div class=\"location-actions\" style=\"display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;\">\r\n            ${canUseBoundaryToggle ? `\r\n              <button id=\"toggle-boundary-btn\" class=\"btn btn-secondary\" type=\"button\">\r\n                Show Digos City Boundary\r\n              </button>\r\n            ` : \"\"}\r\n            <button id=\"show-map-modal-btn\" class=\"btn btn-secondary\" type=\"button\">\r\n              📍 View on Map\r\n            </button>\r\n          </div>\r\n          <div id=\"complaint-map\" class=\"complaint-map\"></div>\r\n        ` : \"\"}\r\n      `;\r\n\r\n      // Initialize map if coordinates are available\r\n      if (hasCoordinates) {\r\n        this.initializeMap();\r\n        if (this.canUseBoundaryToggle()) {\r\n          this.setupBoundaryToggle();\r\n        }\r\n        // Setup map modal button\r\n        const mapModalBtn = document.getElementById(\"show-map-modal-btn\");\r\n        if (mapModalBtn) {\r\n          mapModalBtn.addEventListener(\"click\", () => {\r\n            this.showMapModal();\r\n          });\r\n        }\r\n      }\r\n    } else {\r\n      locationContainer.innerHTML = \"<p>No location information provided</p>\";\r\n    }\r\n  }\r\n\r\n  canUseBoundaryToggle() {\r\n    const allowedRoles = new Set([\r\n      \"lgu\",\r\n      \"lgu-admin\",\r\n      \"lgu-officer\",\r\n      \"complaint-coordinator\"\r\n    ]);\r\n    return allowedRoles.has(this.userRole);\r\n  }\r\n\r\n  setupBoundaryToggle() {\r\n    const toggleBtn = document.getElementById(\"toggle-boundary-btn\");\r\n    this.boundaryToggleButton = toggleBtn;\r\n    if (!toggleBtn) return;\r\n\r\n    this.updateBoundaryToggleText();\r\n\r\n    toggleBtn.addEventListener(\"click\", async () => {\r\n      if (toggleBtn.disabled) return;\r\n      toggleBtn.disabled = true;\r\n      try {\r\n        await this.handleBoundaryToggle();\r\n      } finally {\r\n        toggleBtn.disabled = false;\r\n      }\r\n    });\r\n  }\r\n\r\n  updateBoundaryToggleText() {\r\n    if (!this.boundaryToggleButton) return;\r\n    const label = this.boundaryVisible ? \"Hide Digos City Boundary\" : \"Show Digos City Boundary\";\r\n    this.boundaryToggleButton.textContent = label;\r\n    this.boundaryToggleButton.setAttribute(\"aria-pressed\", this.boundaryVisible ? \"true\" : \"false\");\r\n  }\r\n\r\n  async handleBoundaryToggle() {\r\n    if (!this.map) {\r\n      showToast(\"Map is still loading. Please try again in a moment.\", \"warning\");\r\n      return;\r\n    }\r\n\r\n    if (!this.boundaryLayer) {\r\n      try {\r\n        await this.ensureBoundaryData();\r\n        this.boundaryLayer = this.createBoundaryLayer(this.map);\r\n      } catch (error) {\r\n        console.error(\"[COMPLAINT_DETAILS] Failed to prepare boundary layer:\", error);\r\n        showToast(error.message || \"Unable to load city boundary.\", \"error\");\r\n        return;\r\n      }\r\n\r\n      if (!this.boundaryLayer) {\r\n        showToast(\"Boundary data is unavailable for this map.\", \"error\");\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (this.boundaryVisible) {\r\n      if (this.map.hasLayer(this.boundaryLayer)) {\r\n        this.map.removeLayer(this.boundaryLayer);\r\n      }\r\n      this.boundaryVisible = false;\r\n      showToast(\"Digos City boundary hidden.\", \"info\");\r\n    } else {\r\n      this.boundaryLayer.addTo(this.map);\r\n      this.boundaryVisible = true;\r\n      showToast(\"Digos City boundary displayed.\", \"success\");\r\n    }\r\n\r\n    this.updateBoundaryToggleText();\r\n  }\r\n\r\n  async ensureBoundaryData() {\r\n    if (Array.isArray(this.boundaryData) && this.boundaryData.length > 0) {\r\n      return this.boundaryData;\r\n    }\r\n\r\n    const response = await fetch(\"/api/boundaries\");\r\n    if (!response.ok) {\r\n      throw new Error(\"Failed to load Digos City boundary data.\");\r\n    }\r\n    const data = await response.json();\r\n    if (!Array.isArray(data) || data.length === 0) {\r\n      throw new Error(\"Digos City boundary data is not available.\");\r\n    }\r\n\r\n    this.boundaryData = data.filter(item => item && item.geojson);\r\n    if (this.boundaryData.length === 0) {\r\n      throw new Error(\"Boundary geo data is missing.\");\r\n    }\r\n\r\n    return this.boundaryData;\r\n  }\r\n\r\n  createBoundaryLayer(_map) {\r\n    if (!Array.isArray(this.boundaryData) || this.boundaryData.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    const layerGroup = L.layerGroup();\r\n    this.boundaryData.forEach((barangay) => {\r\n      if (!barangay?.geojson) return;\r\n      const geoLayer = L.geoJSON(barangay.geojson, {\r\n        style: {\r\n          color: \"#3b82f6\",\r\n          weight: 1.5,\r\n          opacity: 0.8,\r\n          dashArray: \"6, 4\",\r\n          fillOpacity: 0\r\n        },\r\n        interactive: false\r\n      });\r\n\r\n      if (barangay.name) {\r\n        geoLayer.bindTooltip(barangay.name, {\r\n          permanent: false,\r\n          direction: \"center\",\r\n          className: \"boundary-tooltip\",\r\n          interactive: false\r\n        });\r\n      }\r\n\r\n      geoLayer.addTo(layerGroup);\r\n    });\r\n\r\n    return layerGroup;\r\n  }\r\n\r\n  showMapModal() {\r\n    if (!this.complaint.latitude || !this.complaint.longitude) {\r\n      alert(\"No coordinates available for this complaint\");\r\n      return;\r\n    }\r\n\r\n    // Remove existing modal if present\r\n    const existingModal = document.getElementById(\"map-modal\");\r\n    if (existingModal) {\r\n      existingModal.remove();\r\n    }\r\n\r\n    // Create modal overlay\r\n    const modal = document.createElement(\"div\");\r\n    modal.className = \"modal active\";\r\n    modal.id = \"map-modal\";\r\n    modal.style.cssText = \"position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; display: flex; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);\";\r\n    modal.innerHTML = `\r\n      <div class=\"modal-content\" style=\"max-width: 90vw; max-height: 90vh; width: 800px; background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; overflow: hidden;\">\r\n        <div class=\"modal-header\" style=\"display: flex; align-items: center; justify-content: space-between; padding: 1.5rem; border-bottom: 1px solid #e5e7eb; background: #f9fafb;\">\r\n          <h2 style=\"margin: 0; font-size: 1.25rem; font-weight: 600; color: #1f2937;\">📍 Complaint Location</h2>\r\n          <button class=\"modal-close\" id=\"close-map-modal\" style=\"background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0.25rem; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; border-radius: 4px;\">&times;</button>\r\n        </div>\r\n        <div class=\"modal-body\" style=\"padding: 1.5rem; flex: 1; overflow-y: auto;\">\r\n          <div id=\"modal-map\" style=\"width: 100%; height: 500px; border-radius: 8px; margin-bottom: 1rem;\"></div>\r\n          <div style=\"margin-top: 10px; padding: 1rem; background: #f9fafb; border-radius: 8px;\">\r\n            <div style=\"margin-bottom: 0.5rem;\"><strong>Address:</strong> ${this.complaint.location_text || \"N/A\"}</div>\r\n            <div><strong>Coordinates:</strong> ${this.complaint.latitude}, ${this.complaint.longitude}</div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n    document.body.appendChild(modal);\r\n\r\n    // Close button handler\r\n    const closeBtn = document.getElementById(\"close-map-modal\");\r\n    if (closeBtn) {\r\n      closeBtn.addEventListener(\"click\", (e) => {\r\n        e.stopPropagation();\r\n        modal.remove();\r\n      });\r\n      // Add hover effect\r\n      closeBtn.addEventListener(\"mouseenter\", () => {\r\n        closeBtn.style.background = \"#f3f4f6\";\r\n        closeBtn.style.color = \"#374151\";\r\n      });\r\n      closeBtn.addEventListener(\"mouseleave\", () => {\r\n        closeBtn.style.background = \"none\";\r\n        closeBtn.style.color = \"#6b7280\";\r\n      });\r\n    }\r\n\r\n    // Close on backdrop click\r\n    modal.addEventListener(\"click\", (e) => {\r\n      if (e.target === modal) {\r\n        modal.remove();\r\n      }\r\n    });\r\n\r\n    // Close on Escape key\r\n    const handleEscape = (e) => {\r\n      if (e.key === \"Escape\" && document.getElementById(\"map-modal\")) {\r\n        modal.remove();\r\n        document.removeEventListener(\"keydown\", handleEscape);\r\n      }\r\n    };\r\n    document.addEventListener(\"keydown\", handleEscape);\r\n\r\n    // Initialize map in modal\r\n    setTimeout(async () => {\r\n      try {\r\n        if (typeof L === \"undefined\") {\r\n          await this.loadLeaflet();\r\n        }\r\n        const mapContainer = document.getElementById(\"modal-map\");\r\n        if (!mapContainer) return;\r\n\r\n        const lat = parseFloat(this.complaint.latitude);\r\n        const lng = parseFloat(this.complaint.longitude);\r\n\r\n        if (isNaN(lat) || isNaN(lng)) {\r\n          mapContainer.innerHTML = \"<p>Invalid coordinates</p>\";\r\n          return;\r\n        }\r\n\r\n        const map = L.map(\"modal-map\").setView([lat, lng], 15);\r\n        L.tileLayer(\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\", {\r\n          attribution: \"© OpenStreetMap contributors\",\r\n          maxZoom: 19\r\n        }).addTo(map);\r\n\r\n        // Load and display Digos City boundaries in modal\r\n        try {\r\n          const boundaryResponse = await fetch(\"/api/boundaries\");\r\n          if (boundaryResponse.ok) {\r\n            const brgyData = await boundaryResponse.json();\r\n            if (Array.isArray(brgyData)) {\r\n              // Add each barangay boundary to the map\r\n              brgyData.forEach((barangay) => {\r\n                if (barangay.geojson) {\r\n                  const geojsonLayer = L.geoJSON(barangay.geojson, {\r\n                    style: {\r\n                      color: \"#3b82f6\",\r\n                      weight: 1.5,\r\n                      opacity: 0.6,\r\n                      fillOpacity: 0,\r\n                      fillColor: \"transparent\",\r\n                      dashArray: \"5, 5\",\r\n                      interactive: false\r\n                    },\r\n                    interactive: false,\r\n                    onEachFeature(feature, layer) {\r\n                      // Disable all interactions to prevent black box on click\r\n                      layer.options.interactive = false;\r\n                      layer.off(\"click\");\r\n                      layer.off(\"mouseover\");\r\n                      layer.off(\"mouseout\");\r\n\r\n                      if (barangay.name) {\r\n                        layer.bindTooltip(barangay.name, {\r\n                          permanent: false,\r\n                          direction: \"center\",\r\n                          className: \"boundary-tooltip\",\r\n                          interactive: false\r\n                        });\r\n                      }\r\n                    }\r\n                  });\r\n                  geojsonLayer.addTo(map);\r\n                }\r\n              });\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.warn(\"[COMPLAINT_DETAILS] Failed to load boundaries in modal:\", error);\r\n        }\r\n\r\n        // Add marker\r\n        L.marker([lat, lng])\r\n          .addTo(map)\r\n          .bindPopup(`<strong>${this.complaint.title || \"Complaint\"}</strong><br>${this.complaint.location_text || \"\"}`)\r\n          .openPopup();\r\n      } catch (error) {\r\n        console.error(\"[COMPLAINT_DETAILS] Error initializing modal map:\", error);\r\n        const mapContainer = document.getElementById(\"modal-map\");\r\n        if (mapContainer) {\r\n          mapContainer.innerHTML = \"<p>Error loading map</p>\";\r\n        }\r\n      }\r\n    }, 100);\r\n  }\r\n\r\n  async initializeMap() {\r\n    // Wait a bit for the DOM to be ready\r\n    const mapContainer = document.getElementById(\"complaint-map\");\r\n    if (!mapContainer) {\r\n      console.warn(\"[COMPLAINT_DETAILS] Map container not found\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Ensure Leaflet is loaded\r\n      if (typeof L === \"undefined\") {\r\n        await this.loadLeaflet();\r\n      }\r\n\r\n      // Wait for container to have dimensions\r\n      let attempts = 0;\r\n      while ((mapContainer.offsetWidth === 0 || mapContainer.offsetHeight === 0) && attempts < 10) {\r\n        await new Promise(resolve => setTimeout(resolve, 100));\r\n        attempts++;\r\n      }\r\n\r\n      if (mapContainer.offsetWidth === 0 || mapContainer.offsetHeight === 0) {\r\n        console.warn(\"[COMPLAINT_DETAILS] Map container has no dimensions\");\r\n        return;\r\n      }\r\n\r\n      // Validate coordinates\r\n      const lat = parseFloat(this.complaint.latitude);\r\n      const lng = parseFloat(this.complaint.longitude);\r\n      if (isNaN(lat) || isNaN(lng)) {\r\n        console.warn(\"[COMPLAINT_DETAILS] Invalid coordinates:\", { lat, lng });\r\n        mapContainer.innerHTML = \"<p>Invalid coordinates provided</p>\";\r\n        return;\r\n      }\r\n\r\n      // Initialize the map\r\n\r\n      if (this.boundaryLayer && this.map && this.map.hasLayer(this.boundaryLayer)) {\r\n        this.map.removeLayer(this.boundaryLayer);\r\n      }\r\n      this.boundaryLayer = null;\r\n      this.boundaryVisible = false;\r\n      this.updateBoundaryToggleText();\r\n\r\n      const map = L.map(\"complaint-map\", {\r\n        zoomControl: true,\r\n        preferCanvas: false\r\n      }).setView([lat, lng], 15);\r\n\r\n      // Add OpenStreetMap tiles\r\n      L.tileLayer(\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\", {\r\n        attribution: '© <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors',\r\n        maxZoom: 19\r\n      }).addTo(map);\r\n\r\n      // Add a marker for the complaint location\r\n      const complaintMarker = L.marker([lat, lng]).addTo(map);\r\n\r\n      // Add popup with complaint information\r\n      complaintMarker.bindPopup(`\r\n                    <div class=\"map-popup\">\r\n          <h4>${this.escapeHtml(this.complaint.title || \"Complaint Location\")}</h4>\r\n          <p><strong>Address:</strong> ${this.escapeHtml(this.complaint.location_text || \"N/A\")}</p>\r\n          <p><strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>\r\n                    </div>\r\n                `).openPopup();\r\n\r\n      // Store map reference for potential cleanup\r\n      this.map = map;\r\n      this.updateBoundaryToggleText();\r\n\r\n      // Invalidate size after a short delay to ensure proper rendering\r\n      setTimeout(() => {\r\n        if (map) {\r\n          map.invalidateSize();\r\n        }\r\n      }, 200);\r\n    } catch (error) {\r\n      console.error(\"[COMPLAINT_DETAILS] Error initializing map:\", error);\r\n      const mapContainer = document.getElementById(\"complaint-map\");\r\n      if (mapContainer) {\r\n        mapContainer.innerHTML = `<p>Unable to load map. Error: ${error.message}</p>`;\r\n      }\r\n    }\r\n  }\r\n\r\n  async loadLeaflet() {\r\n    return new Promise((resolve, reject) => {\r\n      if (typeof L !== \"undefined\") {\r\n        resolve();\r\n        return;\r\n      }\r\n\r\n      // Check if Leaflet CSS is loaded\r\n      if (!document.querySelector('link[href*=\"leaflet\"]')) {\r\n        const cssLink = document.createElement(\"link\");\r\n        cssLink.rel = \"stylesheet\";\r\n        cssLink.href = \"https://unpkg.com/leaflet@1.9.4/dist/leaflet.css\";\r\n        cssLink.integrity = \"sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=\";\r\n        cssLink.crossOrigin = \"\";\r\n        document.head.appendChild(cssLink);\r\n      }\r\n\r\n      // Load Leaflet JS\r\n      const script = document.createElement(\"script\");\r\n      script.src = \"https://unpkg.com/leaflet@1.9.4/dist/leaflet.js\";\r\n      script.integrity = \"sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=\";\r\n      script.crossOrigin = \"\";\r\n      script.onload = () => resolve();\r\n      script.onerror = () => reject(new Error(\"Failed to load Leaflet\"));\r\n      document.head.appendChild(script);\r\n    });\r\n  }\r\n\r\n  addRouteControls(map) {\r\n    // Only show route controls for LGU users\r\n    if (this.userRole !== \"lgu\" && this.userRole !== \"lgu-admin\") {\r\n      return;\r\n    }\r\n    // Check if geolocation is supported\r\n    if (!navigator.geolocation) {\r\n      console.log(\"Geolocation not supported, skipping route controls\");\r\n      return;\r\n    }\r\n    // Create control container\r\n    const routeControlContainer = L.control({ position: \"topright\" });\r\n    routeControlContainer.onAdd = function(_map) {\r\n      const div = L.DomUtil.create(\"div\", \"route-controls\");\r\n      div.innerHTML = `\r\n                     <div class=\"route-control-panel\">\r\n                         <h4>Route Options</h4>\r\n                         <button id=\"get-route-btn\" class=\"route-btn\">\r\n                             <i class=\"icon-navigation\"></i> Get Route\r\n                         </button>\r\n                         <button id=\"clear-route-btn\" class=\"route-btn\" style=\"display: none;\">\r\n                             <i class=\"icon-close\"></i> Clear Route\r\n                         </button>\r\n                         <div id=\"route-info\" class=\"route-info\" style=\"display: none;\">\r\n                             <p id=\"route-distance\"></p>\r\n                             <p id=\"route-duration\"></p>\r\n                         </div>\r\n                         <div id=\"manual-location\" class=\"manual-location\" style=\"display: none;\">\r\n                             <p>Location not available. You can still view the complaint location on the map.</p>\r\n                         </div>\r\n                </div>\r\n            `;\r\n      return div;\r\n    };\r\n    routeControlContainer.addTo(map);\r\n    // Add event listeners with error handling\r\n    const getRouteBtn = document.getElementById(\"get-route-btn\");\r\n    const clearRouteBtn = document.getElementById(\"clear-route-btn\");\r\n    if (getRouteBtn) {\r\n      getRouteBtn.addEventListener(\"click\", () => {\r\n        this.getUserLocationAndShowRoute(map);\r\n      });\r\n    }\r\n    if (clearRouteBtn) {\r\n      clearRouteBtn.addEventListener(\"click\", () => {\r\n        this.clearRoute();\r\n      });\r\n    }\r\n  }\r\n  getUserLocationAndShowRoute(map) {\r\n\r\n    if (!navigator.geolocation) {\r\n      console.log(\"Geolocation is not supported by this browser\");\r\n      showToast(\"Geolocation is not supported by this browser.\", \"error\");\r\n      return;\r\n    }\r\n    const getRouteBtn = document.getElementById(\"get-route-btn\");\r\n    const clearRouteBtn = document.getElementById(\"clear-route-btn\");\r\n    const routeInfo = document.getElementById(\"route-info\");\r\n    if (getRouteBtn) {\r\n      getRouteBtn.textContent = \"Getting Location...\";\r\n      getRouteBtn.disabled = true;\r\n    }\r\n    // Check if geolocation is available and not blocked\r\n    if (navigator.permissions) {\r\n      navigator.permissions.query({name: \"geolocation\"}).then((result) => {\r\n        if (result.state === \"denied\") {\r\n          console.log(\"Geolocation permission denied\");\r\n          showToast(\"Location access is denied. Please enable location permissions in your browser settings.\", \"error\");\r\n          if (getRouteBtn) {\r\n            getRouteBtn.textContent = \"Get Route\";\r\n            getRouteBtn.disabled = false;\r\n          }\r\n          // Show manual location message\r\n          const manualLocation = document.getElementById(\"manual-location\");\r\n          if (manualLocation) {\r\n            manualLocation.style.display = \"block\";\r\n          }\r\n          return;\r\n        }\r\n        this.attemptGeolocation(map, getRouteBtn, clearRouteBtn, routeInfo);\r\n      }).catch(() => {\r\n        // Fallback if permissions API is not supported\r\n        this.attemptGeolocation(map, getRouteBtn, clearRouteBtn, routeInfo);\r\n      });\r\n    } else {\r\n      // Fallback if permissions API is not supported\r\n      this.attemptGeolocation(map, getRouteBtn, clearRouteBtn, routeInfo);\r\n    }\r\n  }\r\n  attemptGeolocation(map, getRouteBtn, clearRouteBtn, routeInfo) {\r\n    navigator.geolocation.getCurrentPosition(\r\n      (position) => {\r\n        console.log(\"Location obtained successfully\");\r\n        this.userLocation = {\r\n          lat: position.coords.latitude,\r\n          lng: position.coords.longitude\r\n        };\r\n        this.showRoute(map);\r\n        if (getRouteBtn) {\r\n          getRouteBtn.textContent = \"Update Route\";\r\n          getRouteBtn.disabled = false;\r\n        }\r\n        if (clearRouteBtn) clearRouteBtn.style.display = \"inline-block\";\r\n        if (routeInfo) routeInfo.style.display = \"block\";\r\n        showToast(\"Location obtained successfully!\", \"success\");\r\n      },\r\n      (error) => {\r\n        console.error(\"Error getting location:\", error);\r\n        let errorMessage = \"Unable to get your location. \";\r\n        switch(error.code) {\r\n          case error.PERMISSION_DENIED:\r\n            errorMessage += \"Location access was denied. Please enable location permissions in your browser settings and try again.\";\r\n            break;\r\n          case error.POSITION_UNAVAILABLE:\r\n            errorMessage += \"Location information is unavailable. This might be due to GPS being disabled, poor signal, or browser security policies.\";\r\n            break;\r\n          case error.TIMEOUT:\r\n            errorMessage += \"Location request timed out. Please try again.\";\r\n            break;\r\n          default:\r\n            errorMessage += \"An unknown error occurred. Please try again.\";\r\n            break;\r\n        }\r\n        showToast(errorMessage, \"error\");\r\n        if (getRouteBtn) {\r\n          getRouteBtn.textContent = \"Get Route\";\r\n          getRouteBtn.disabled = false;\r\n        }\r\n        // Show manual location message\r\n        const manualLocation = document.getElementById(\"manual-location\");\r\n        if (manualLocation) {\r\n          manualLocation.style.display = \"block\";\r\n        }\r\n      },\r\n      {\r\n        enableHighAccuracy: false, // Changed to false for better compatibility\r\n        timeout: 10000, // Reduced timeout\r\n        maximumAge: 60000 // 1 minute\r\n      }\r\n    );\r\n  }\r\n  showRoute(map) {\r\n\r\n    if (!this.userLocation || !this.complaint.latitude || !this.complaint.longitude) {\r\n      return;\r\n    }\r\n    // Clear existing route\r\n    this.clearRoute();\r\n    try {\r\n      // Create routing control\r\n      this.routingControl = L.Routing.control({\r\n        waypoints: [\r\n          L.latLng(this.userLocation.lat, this.userLocation.lng),\r\n          L.latLng(this.complaint.latitude, this.complaint.longitude)\r\n        ],\r\n        routeWhileDragging: false,\r\n        addWaypoints: false,\r\n        createMarker: function(i, waypoint, _n) {\r\n          // Custom markers\r\n          if (i === 0) {\r\n            // User location marker\r\n            return L.marker(waypoint.latLng, {\r\n              icon: L.divIcon({\r\n                className: \"user-location-marker\",\r\n                html: '<div class=\"marker-icon user-marker\">📍</div>',\r\n                iconSize: [30, 30],\r\n                iconAnchor: [15, 15]\r\n              })\r\n            }).bindPopup(\"Your Location\");\r\n          }\r\n          // Complaint location marker\r\n          return L.marker(waypoint.latLng, {\r\n            icon: L.divIcon({\r\n              className: \"complaint-location-marker\",\r\n              html: '<div class=\"marker-icon complaint-marker\">🚨</div>',\r\n              iconSize: [30, 30],\r\n              iconAnchor: [15, 15]\r\n            })\r\n          }).bindPopup(`\r\n                            <div class=\"map-popup\">\r\n                                <h4>${this.complaint.title || \"Complaint Location\"}</h4>\r\n                                <p><strong>Address:</strong> ${this.complaint.location_text}</p>\r\n                            </div>\r\n                        `);\r\n\r\n        }.bind(this),\r\n        lineOptions: {\r\n          styles: [\r\n            {\r\n              color: \"#3b82f6\",\r\n              weight: 6,\r\n              opacity: 0.8\r\n            }\r\n          ]\r\n        }\r\n      }).addTo(map);\r\n      // Listen for route calculation\r\n      this.routingControl.on(\"routesfound\", (e) => {\r\n        const {routes} = e;\r\n        const {summary} = routes[0];\r\n        // Update route info\r\n        const distanceEl = document.getElementById(\"route-distance\");\r\n        const durationEl = document.getElementById(\"route-duration\");\r\n        if (distanceEl) {\r\n          distanceEl.textContent = `Distance: ${(summary.totalDistance / 1000).toFixed(2)} km`;\r\n        }\r\n        if (durationEl) {\r\n          durationEl.textContent = `Duration: ${Math.round(summary.totalTime / 60)} minutes`;\r\n        }\r\n        showToast(\"Route calculated successfully!\", \"success\");\r\n      });\r\n      this.routingControl.on(\"routingerror\", (e) => {\r\n        console.error(\"Routing error:\", e);\r\n        showToast(\"Unable to calculate route. Please try again.\", \"error\");\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Error creating route:\", error);\r\n      showToast(\"Error creating route. Please try again.\", \"error\");\r\n    }\r\n  }\r\n  clearRoute() {\r\n\r\n    if (this.routingControl) {\r\n      this.map.removeControl(this.routingControl);\r\n      this.routingControl = null;\r\n    }\r\n    const clearRouteBtn = document.getElementById(\"clear-route-btn\");\r\n    const routeInfo = document.getElementById(\"route-info\");\r\n    if (clearRouteBtn) clearRouteBtn.style.display = \"none\";\r\n    if (routeInfo) routeInfo.style.display = \"none\";\r\n  }\r\n  renderAttachments() {\r\n    const attachmentsContainer = document.getElementById(\"complaint-attachments\");\r\n    if (!attachmentsContainer) return;\r\n    const attachments = this.complaint.attachments || [];\r\n    // Separate attachments by type\r\n    const initialEvidence = attachments.filter(att => att.type === \"initial\");\r\n    const completionEvidence = attachments.filter(att => att.type === \"completion\");\r\n    if (attachments.length === 0) {\r\n      attachmentsContainer.innerHTML = \"<p>No attachments</p>\";\r\n      return;\r\n    }\r\n    let html = \"\";\r\n    // Render Initial Evidence section\r\n    if (initialEvidence.length > 0) {\r\n      html += `\r\n                <div class=\"evidence-section\">\r\n                    <h4 class=\"evidence-type-title\">📎 Initial Evidence (Submitted with Complaint)</h4>\r\n                    <div class=\"evidence-list\">\r\n                        ${initialEvidence.map(attachment => `\r\n                            <a href=\"${attachment.url}\" class=\"attachment-item\" target=\"_blank\" rel=\"noopener noreferrer\">\r\n                                <span class=\"attachment-icon\">📎</span>\r\n                                <span class=\"attachment-name\">${attachment.name || \"Attachment\"}</span>\r\n                                <span class=\"attachment-size\">${this.formatFileSize(attachment.size || 0)}</span>\r\n                            </a>\r\n                        `).join(\"\")}\r\n                    </div>\r\n                </div>\r\n            `;\r\n    }\r\n\r\n    // Render Completion Evidence section\r\n    if (completionEvidence.length > 0) {\r\n      html += `\r\n                <div class=\"evidence-section\">\r\n                    <h4 class=\"evidence-type-title\">✅ Completion Evidence (Uploaded by Officers/Admins)</h4>\r\n                    <div class=\"evidence-list\">\r\n                        ${completionEvidence.map(attachment => `\r\n                            <a href=\"${attachment.url}\" class=\"attachment-item completion-evidence\" target=\"_blank\" rel=\"noopener noreferrer\">\r\n                                <span class=\"attachment-icon\">✅</span>\r\n                                <span class=\"attachment-name\">${attachment.name || \"Attachment\"}</span>\r\n                                <span class=\"attachment-size\">${this.formatFileSize(attachment.size || 0)}</span>\r\n                            </a>\r\n                        `).join(\"\")}\r\n                    </div>\r\n                </div>\r\n            `;\r\n    }\r\n\r\n    // If no attachments categorized, show all\r\n    if (html === \"\") {\r\n      html = attachments.map(attachment => `\r\n                <a href=\"${attachment.url}\" class=\"attachment-item\" target=\"_blank\" rel=\"noopener noreferrer\">\r\n                    <span class=\"attachment-icon\">📎</span>\r\n                    <span class=\"attachment-name\">${attachment.name || \"Attachment\"}</span>\r\n                    <span class=\"attachment-size\">${this.formatFileSize(attachment.size || 0)}</span>\r\n                </a>\r\n            `).join(\"\");\r\n    }\r\n    attachmentsContainer.innerHTML = html;\r\n  }\r\n  formatFileSize(bytes) {\r\n    if (bytes === 0) return \"0 B\";\r\n    const k = 1024;\r\n    const sizes = [\"B\", \"KB\", \"MB\", \"GB\"];\r\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n    return `${Math.round(bytes / Math.pow(k, i) * 100) / 100  } ${  sizes[i]}`;\r\n  }\r\n  renderTimeline() {\r\n    const timelineContainer = document.getElementById(\"timeline-items\");\r\n    if (!timelineContainer) return;\r\n    // Map workflow status to step number (0-4, with 5 as cancelled)\r\n    const workflowStatus = (this.complaint.workflow_status || \"new\").toLowerCase();\r\n    const isCancelled = workflowStatus === \"cancelled\";\r\n    const statusStepMap = {\r\n      \"new\": 0,\r\n      \"assigned\": 1,\r\n      \"in_progress\": 2,\r\n      \"pending_approval\": 3,\r\n      \"completed\": 4\r\n    };\r\n    // For cancelled complaints, don't show any active steps - gray everything out\r\n    // Otherwise, show progress up to the current step\r\n    const currentStep = isCancelled ? -1 : (statusStepMap[workflowStatus] !== void 0 ? statusStepMap[workflowStatus] : 0);\r\n\r\n    // Step labels\r\n    const stepLabels = [\r\n      \"New\",\r\n      \"Assigned\",\r\n      \"In Progress\",\r\n      \"Pending Approval\",\r\n      \"Completed\",\r\n      \"Cancelled\"\r\n    ];\r\n    // Node color (blue only for all active steps)\r\n    const nodeColors = [\r\n      \"#3b82f6\",\r\n      \"#3b82f6\",\r\n      \"#3b82f6\",\r\n      \"#3b82f6\",\r\n      \"#3b82f6\"\r\n    ];\r\n    // Build the stepper HTML\r\n    let stepperHTML = '<div class=\"stepper-container\">';\r\n    for (let i = 0; i < 5; i++) {\r\n      // If cancelled, all steps are inactive (grayed out)\r\n      // Otherwise, active steps are those up to currentStep (0-4)\r\n      // Step 5 is always inactive (grey) - represents unreached final state\r\n      const isActive = isCancelled ? false : (i <= currentStep && i < 5);\r\n      // Get node color - if cancelled, everything is grey\r\n      const nodeColor = isCancelled ? \"#9ca3af\" : (isActive ? nodeColors[i] : \"#9ca3af\");\r\n      // Determine connector line style\r\n      let connectorStyle = \"\";\r\n      if (i < 4) {\r\n        // If cancelled, all connectors are grey\r\n        // Otherwise, color connector through the current step as well (continuous bar effect)\r\n        const isConnectorActive = isCancelled ? false : (i <= currentStep);\r\n        if (isConnectorActive) {\r\n          // Active connector solid blue\r\n          connectorStyle = \"#3b82f6\";\r\n        } else {\r\n          connectorStyle = \"#e5e7eb\"; // Inactive grey\r\n        }\r\n      }\r\n      // No glow/box-shadow for nodes\r\n      const boxShadow = \"none\";\r\n      stepperHTML += `\r\n                <div class=\"stepper-step ${isActive ? \"active\" : \"\"}\">\r\n                    <div class=\"stepper-node\" style=\"background-color: ${nodeColor}; box-shadow: ${boxShadow};\"></div>\r\n                    ${i < 4 ? `\r\n                    <div class=\"stepper-connector\" style=\"background: ${connectorStyle};\"></div>\r\n                    ` : \"\"}\r\n                </div>\r\n            `;\r\n    }\r\n    stepperHTML += \"</div>\";\r\n    // Labels row under the stepper, aligned with nodes\r\n    stepperHTML += '<div class=\"stepper-labels\">';\r\n    for (let i = 0; i < 5; i++) {\r\n      const isActive = !isCancelled && i <= currentStep;\r\n      stepperHTML += `\r\n                <div class=\"stepper-label-item ${isActive ? \"active\" : \"\"}\">${stepLabels[i]}</div>\r\n            `;\r\n    }\r\n    stepperHTML += \"</div>\";\r\n    const displayLabel = isCancelled ? \"Cancelled\" : stepLabels[currentStep] || \"Unknown\";\r\n    stepperHTML += `<div class=\"stepper-current\">Current Status: <strong>${displayLabel}</strong></div>`;\r\n    timelineContainer.innerHTML = stepperHTML;\r\n  }\r\n  hexToRgb(hex) {\r\n    const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\r\n    return result ? [\r\n      parseInt(result[1], 16),\r\n      parseInt(result[2], 16),\r\n      parseInt(result[3], 16)\r\n    ] : [0, 0, 0];\r\n  }\r\n  getNextColor(currentColor) {\r\n    const colorMap = {\r\n      \"#f97316\": \"#ef4444\", // Orange -> Red\r\n      \"#ef4444\": \"#ec4899\", // Red -> Pink\r\n      \"#ec4899\": \"#9333ea\", // Pink -> Purple\r\n      \"#9333ea\": \"#9ca3af\"  // Purple -> Grey\r\n    };\r\n    return colorMap[currentColor] || currentColor;\r\n  }\r\n  setupRoleSpecificUI() {\r\n    this.setupReturnButton();\r\n    this.setupRoleSpecificActions();\r\n  }\r\n  setupReturnButton() {\r\n    const returnLink = document.getElementById(\"return-link\");\r\n    const returnText = document.getElementById(\"return-text\");\r\n    if (!returnLink || !returnText) return;\r\n\r\n    // Check URL parameter first (explicit flag)\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    const fromParam = urlParams.get(\"from\"); // e.g., ?from=dashboard or ?from=profile\r\n\r\n    // Check referrer to determine where user came from (fallback)\r\n    const {referrer} = document;\r\n    const isFromDashboard = fromParam === \"dashboard\" || referrer.includes(\"/dashboard\") || referrer.includes(\"/citizen/dashboard\");\r\n    const isFromProfile = fromParam === \"profile\" || referrer.includes(\"/myProfile\");\r\n    const isFromReviewQueue = referrer.includes(\"/coordinator/review-queue\") || referrer.includes(\"/review-queue\");\r\n    const isFromAssignments = referrer.includes(\"/assignments\");\r\n\r\n    // For citizens coming from dashboard or profile previews, always go to profile\r\n    if (this.userRole === \"citizen\") {\r\n      if (isFromDashboard) {\r\n        returnLink.href = \"/dashboard\";\r\n        returnText.textContent = \"Return to Dashboard\";\r\n      } else if (isFromProfile || !referrer) {\r\n        returnLink.href = \"/myProfile\";\r\n        returnText.textContent = \"Return to Your Profile\";\r\n      } else {\r\n        returnLink.href = \"/myProfile\";\r\n        returnText.textContent = \"Return to Your Profile\";\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Otherwise use role-based navigation\r\n    switch (this.userRole) {\r\n      case \"complaint-coordinator\":\r\n        returnLink.href = isFromReviewQueue ? \"/coordinator/review-queue\" : \"/dashboard\";\r\n        returnText.textContent = isFromReviewQueue ? \"Return to Review Queue\" : \"Return to Dashboard\";\r\n        break;\r\n      case \"lgu-admin\":\r\n        returnLink.href = isFromAssignments ? \"/lgu-admin/assignments\" : \"/dashboard\";\r\n        returnText.textContent = isFromAssignments ? \"Return to Assigned Complaints\" : \"Return to Dashboard\";\r\n        break;\r\n      case \"lgu\":\r\n      case \"lgu-officer\":\r\n        returnLink.href = \"/lgu-officer/assigned-tasks\";\r\n        returnText.textContent = \"Return to Assigned Tasks\";\r\n        break;\r\n      case \"citizen\":\r\n      default:\r\n        returnLink.href = \"/myProfile\";\r\n        returnText.textContent = \"Return to Your Profile\";\r\n        break;\r\n    }\r\n  }\r\n  setupRoleSpecificActions() {\r\n    const actionsContainer = document.getElementById(\"complaint-actions\");\r\n    if (!actionsContainer) return;\r\n    // Return early if complaint is not loaded\r\n    if (!this.complaint) return;\r\n    const actions = [];\r\n    switch (this.userRole) {\r\n      case \"complaint-coordinator\":\r\n        if (this.complaint.status === \"pending review\") {\r\n          actions.push(\r\n            { text: \"Approve\", class: \"btn btn-success\", action: \"approve\" },\r\n            { text: \"Reject\", class: \"btn btn-danger\", action: \"reject\" }\r\n          );\r\n        }\r\n        break;\r\n      case \"lgu-admin\":\r\n        if (this.complaint.status === \"approved\" || this.complaint.status === \"assigned\") {\r\n          actions.push(\r\n            { text: \"Assign to Officer\", class: \"btn btn-primary\", action: \"assign-officer\" }\r\n          );\r\n        }\r\n        break;\r\n      case \"lgu\":\r\n      case \"lgu-officer\":\r\n        if (this.complaint.status === \"assigned\" || this.complaint.status === \"in progress\") {\r\n          actions.push(\r\n            { text: \"Mark as Resolved\", class: \"btn btn-success\", action: \"mark-resolved\" }\r\n          );\r\n        }\r\n        break;\r\n      case \"citizen\":\r\n        if (this.complaint.status === \"pending review\" || this.complaint.status === \"approved\") {\r\n          actions.push(\r\n            { text: \"Cancel Complaint\", class: \"btn btn-warning\", action: \"cancel\" }\r\n          );\r\n        }\r\n        // Show confirmation button when all assignments are complete and citizen hasn't confirmed\r\n        if (this.shouldShowConfirmationButton()) {\r\n          actions.push(\r\n            { text: \"Confirm Resolution\", class: \"btn btn-success\", action: \"confirm-resolution\" }\r\n          );\r\n        }\r\n        if (this.complaint.status !== \"cancelled\" && this.complaint.status !== \"closed\") {\r\n          actions.push(\r\n            { text: \"Set Reminder\", class: \"btn btn-info\", action: \"remind\" }\r\n          );\r\n        }\r\n        break;\r\n    }\r\n    // Hide Confirm Resolution if already resolved/completed\r\n    const wf = (this.complaint.workflow_status || \"\").toLowerCase();\r\n    const confirmedByCitizen = Boolean(this.complaint.confirmed_by_citizen);\r\n    const filteredActions = actions.filter(a => {\r\n      if (a.action === \"confirm-resolution\") {\r\n        if (wf === \"completed\" || confirmedByCitizen) return false;\r\n      }\r\n      if (a.action === \"remind\") {\r\n        // Hide reminder when already resolved/completed or cancelled\r\n        if (wf === \"completed\" || wf === \"cancelled\") return false;\r\n      }\r\n      return true;\r\n    });\r\n    actionsContainer.innerHTML = filteredActions.map(action => `\r\n            <button class=\"${action.class}\" data-action=\"${action.action}\">\r\n                ${action.text}\r\n            </button>\r\n        `).join(\"\");\r\n    // Attach event listeners\r\n    actionsContainer.querySelectorAll(\"button[data-action]\").forEach(button => {\r\n      button.addEventListener(\"click\", (e) => {\r\n        const action = e.target.getAttribute(\"data-action\");\r\n        this.handleAction(action);\r\n      });\r\n    });\r\n  }\r\n  async handleAction(action) {\r\n    switch (action) {\r\n      case \"approve\":\r\n        await this.approveComplaint();\r\n        break;\r\n      case \"reject\":\r\n        await this.rejectComplaint();\r\n        break;\r\n      case \"assign-officer\":\r\n        await this.assignToOfficer();\r\n        break;\r\n      case \"mark-resolved\":\r\n        await this.markAsResolved();\r\n        break;\r\n      case \"cancel\":\r\n        await this.cancelComplaint();\r\n        break;\r\n      case \"confirm-resolution\":\r\n        await this.confirmResolution();\r\n        break;\r\n      case \"remind\":\r\n        await this.sendReminder();\r\n        break;\r\n    }\r\n  }\r\n  async approveComplaint() {\r\n    // Redirect to coordinator review queue with approval action\r\n    window.location.href = `/coordinator/review-queue?action=approve&id=${this.complaintId}`;\r\n  }\r\n  async rejectComplaint() {\r\n    const reason = prompt(\"Please provide a reason for rejection:\");\r\n    if (!reason) return;\r\n    try {\r\n      const response = await fetch(`/api/coordinator/review-queue/${this.complaintId}/decide`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        credentials: \"include\",\r\n        body: JSON.stringify({\r\n          decision: \"reject\",\r\n          data: { reason }\r\n        })\r\n      });\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        showToast(\"Complaint rejected successfully\", \"success\");\r\n        this.loadComplaintDetails(); // Refresh\r\n      } else {\r\n        throw new Error(result.error || \"Failed to reject complaint\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error rejecting complaint:\", error);\r\n      showToast(`Failed to reject complaint: ${  error.message}`, \"error\");\r\n    }\r\n  }\r\n  async assignToOfficer() {\r\n    // This would open a modal or redirect to assignment page\r\n    showToast(\"Officer assignment feature coming soon\", \"info\");\r\n  }\r\n  async markAsResolved() {\r\n    const notes = prompt(\"Please provide resolution notes:\");\r\n    if (!notes) return;\r\n    try {\r\n      const response = await fetch(`/api/lgu/complaints/${this.complaintId}/resolve`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        credentials: \"include\",\r\n        body: JSON.stringify({\r\n          resolution_notes: notes\r\n        })\r\n      });\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        showToast(\"Complaint marked as resolved\", \"success\");\r\n        this.loadComplaintDetails(); // Refresh\r\n      } else {\r\n        throw new Error(result.error || \"Failed to mark as resolved\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error marking as resolved:\", error);\r\n      showToast(`Failed to mark as resolved: ${  error.message}`, \"error\");\r\n    }\r\n  }\r\n  async cancelComplaint() {\r\n    const reason = prompt(\"Please provide a reason for cancellation:\");\r\n    if (!reason) return;\r\n    if (!confirm(\"Are you sure you want to cancel this complaint?\")) {\r\n      return;\r\n    }\r\n    try {\r\n      const response = await fetch(`/api/complaints/${this.complaintId}/cancel`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        credentials: \"include\",\r\n        body: JSON.stringify({\r\n          reason\r\n        })\r\n      });\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        showToast(\"Complaint cancelled successfully\", \"success\");\r\n        this.loadComplaintDetails(); // Refresh\r\n      } else {\r\n        throw new Error(result.error || \"Failed to cancel complaint\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error cancelling complaint:\", error);\r\n      showToast(`Failed to cancel complaint: ${  error.message}`, \"error\");\r\n    }\r\n  }\r\n  async confirmResolution() {\r\n    if (!confirm(\"Are you satisfied with the resolution of this complaint?\")) {\r\n      return;\r\n    }\r\n    try {\r\n      const response = await fetch(`/api/complaints/${this.complaintId}/confirm-resolution`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        credentials: \"include\",\r\n        body: JSON.stringify({\r\n          confirmed: true\r\n        })\r\n      });\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        showToast(\"Resolution confirmed successfully\", \"success\");\r\n        this.loadComplaintDetails(); // Refresh to update UI\r\n      } else {\r\n        // Show the specific backend validation error to the user\r\n        showToast(result.error || \"Failed to confirm resolution\", \"error\");\r\n        console.log(\"Backend validation error:\", result.error);\r\n        // Optionally refresh the complaint details to update the UI state\r\n        this.loadComplaintDetails();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error confirming resolution:\", error);\r\n      showToast(`Failed to confirm resolution: ${  error.message}`, \"error\");\r\n    }\r\n  }\r\n  async sendReminder() {\r\n    try {\r\n      const response = await fetch(`/api/complaints/${this.complaintId}/remind`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        credentials: \"include\"\r\n      });\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        showToast(\"Reminder sent successfully\", \"success\");\r\n      } else {\r\n        throw new Error(result.error || \"Failed to send reminder\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error sending reminder:\", error);\r\n      showToast(`Failed to send reminder: ${  error.message}`, \"error\");\r\n    }\r\n  }\r\n  showLoading() {\r\n    const loading = document.getElementById(\"loading\");\r\n    const details = document.getElementById(\"complaint-details\");\r\n    const error = document.getElementById(\"error-state\");\r\n    if (loading) loading.style.display = \"block\";\r\n    if (details) details.style.display = \"none\";\r\n    if (error) error.style.display = \"none\";\r\n  }\r\n  hideLoading() {\r\n    const loading = document.getElementById(\"loading\");\r\n    if (loading) loading.style.display = \"none\";\r\n  }\r\n  cleanupStuckModals() {\r\n    // Remove any stuck modal overlays\r\n    const stuckModals = document.querySelectorAll('.modal.active, .modal-overlay.active, #map-modal, [id^=\"modal-\"]');\r\n    stuckModals.forEach(modal => {\r\n      if (modal.id !== \"modal-overlay\" || modal.classList.contains(\"active\")) {\r\n        modal.classList.remove(\"active\");\r\n        modal.style.display = \"none\";\r\n        modal.style.visibility = \"hidden\";\r\n        modal.style.opacity = \"0\";\r\n        // Only remove if it's not the main modal-overlay managed by ModalManager\r\n        if (modal.id !== \"modal-overlay\" && modal.id !== \"map-modal\") {\r\n          modal.remove();\r\n        }\r\n      }\r\n    });\r\n\r\n    // Remove body modal-open class\r\n    document.body.classList.remove(\"modal-open\");\r\n\r\n    // Clean up ModalManager state if it exists\r\n    if (window.modalManager) {\r\n      window.modalManager.activeModal = null;\r\n      const overlay = window.modalManager.modalOverlay;\r\n      if (overlay) {\r\n        overlay.classList.remove(\"active\");\r\n      }\r\n    }\r\n  }\r\n\r\n  showError(message) {\r\n    const error = document.getElementById(\"error-state\");\r\n    const errorMessage = document.getElementById(\"error-message\");\r\n    const loading = document.getElementById(\"loading\");\r\n    const details = document.getElementById(\"complaint-details\");\r\n    if (error) {\r\n      error.style.display = \"block\";\r\n      if (errorMessage) errorMessage.textContent = message;\r\n    }\r\n    if (loading) loading.style.display = \"none\";\r\n    if (details) details.style.display = \"none\";\r\n  }\r\n  formatDate(dateString) {\r\n    if (!dateString) return \"Unknown date\";\r\n    try {\r\n      const date = new Date(dateString);\r\n      return `${date.toLocaleDateString()  } ${  date.toLocaleTimeString()}`;\r\n    } catch (error) {\r\n      return \"Invalid date\";\r\n    }\r\n  }\r\n}\r\n// Initialize when DOM is loaded\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  new ComplaintDetails();\r\n});\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\confirmPasswordChange.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\departments.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\digos-map.js","messages":[{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":8,"column":21,"nodeType":"ReturnStatement","messageId":"returnsValue","endLine":8,"endColumn":38}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// legacy block removed\r\n(function() {\r\n  const MAP_ID = \"digos-map\";\r\n  const DEFAULT_CENTER = [6.7497, 125.3570]; // Approx Digos City\r\n  const DEFAULT_ZOOM = 12;\r\n  function ensureLeafletLoaded() {\r\n    return new Promise((resolve, reject) => {\r\n      if (window.L) return resolve();\r\n      const check = setInterval(() => {\r\n        if (window.L) {\r\n          clearInterval(check);\r\n          resolve();\r\n        }\r\n      }, 50);\r\n      setTimeout(() => {\r\n        clearInterval(check);\r\n        if (!window.L) reject(new Error(\"Leaflet failed to load\"));\r\n      }, 5000);\r\n    });\r\n  }\r\n  async function fetchBoundaries() {\r\n    const res = await fetch(\"/api/boundaries\", { credentials: \"include\" });\r\n    if (!res.ok) throw new Error(\"Failed to load boundaries\");\r\n    return res.json();\r\n  }\r\n  function styleForBarangay(index) {\r\n    // Generate pleasant distinct colors\r\n    const hue = (index * 47) % 360;\r\n    return {\r\n      color: `hsl(${hue}, 70%, 40%)`,\r\n      weight: 2,\r\n      fillColor: `hsl(${hue}, 70%, 60%)`,\r\n      fillOpacity: 0.25\r\n    };\r\n  }\r\n  function addBarangayPolygons(map, boundaries) {\r\n    const group = L.featureGroup();\r\n    boundaries.forEach((item, idx) => {\r\n      const gj = item.geojson;\r\n      if (!gj) return;\r\n      try {\r\n        // Coordinates are [lng, lat]; Leaflet expects [lat, lng]\r\n        const layer = L.geoJSON(gj, {\r\n          style: styleForBarangay(idx),\r\n          coordsToLatLng(coords) {\r\n            return new L.LatLng(coords[1], coords[0]);\r\n          }\r\n        }).bindPopup(`<strong>${item.name || \"Barangay\"}</strong>`);\r\n        group.addLayer(layer);\r\n      } catch (e) {\r\n        console.warn(\"Failed to render polygon for\", item.name, e);\r\n      }\r\n    });\r\n    group.addTo(map);\r\n    try {\r\n      const b = group.getBounds();\r\n      if (b.isValid()) {\r\n        map.fitBounds(b, { padding: [20, 20] });\r\n      }\r\n    } catch {}\r\n  }\r\n  async function init() {\r\n    const container = document.getElementById(MAP_ID);\r\n    if (!container) return;\r\n    try {\r\n      await ensureLeafletLoaded();\r\n      const map = L.map(MAP_ID).setView(DEFAULT_CENTER, DEFAULT_ZOOM);\r\n      L.tileLayer(\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\", {\r\n        attribution: \"© OpenStreetMap contributors\",\r\n        maxZoom: 19\r\n      }).addTo(map);\r\n      const data = await fetchBoundaries();\r\n      if (Array.isArray(data)) {\r\n        addBarangayPolygons(map, data);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[Digos Map] Initialization failed:\", error);\r\n      container.innerHTML = '<div style=\"padding:1rem;color:#e74c3c;\">Failed to load map. Please try again later.</div>';\r\n    }\r\n  }\r\n  if (document.readyState === \"loading\") {\r\n    document.addEventListener(\"DOMContentLoaded\", init);\r\n  } else {\r\n    init();\r\n  }\r\n})();\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\email-verification-success.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\heatmap-enhanced.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\heatmap-init.js","messages":[{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":22,"column":38,"nodeType":"CallExpression","messageId":"returnsValue","endLine":22,"endColumn":61,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[580,603],"text":"{setTimeout(resolve, 50)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":164,"column":38,"nodeType":"CallExpression","messageId":"returnsValue","endLine":164,"endColumn":62,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[5774,5798],"text":"{setTimeout(resolve, 200)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'totalCount' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":312,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":312,"endColumn":21}],"suppressedMessages":[{"ruleId":"no-unmodified-loop-condition","severity":2,"message":"'L' is not modified in this loop.","line":21,"column":19,"nodeType":"Identifier","messageId":"loopConditionNotModified","endLine":21,"endColumn":20,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Heatmap initialization script\r\n// Moved from inline script to comply with CSP\r\n\r\n// Global references\r\nlet map = null;\r\nlet heatmapViz = null;\r\nlet currentFilters = {\r\n  status: \"\",\r\n  category: \"\",\r\n  department: \"\",\r\n  includeResolved: true,\r\n};\r\nlet isInitialLoad = true;\r\nwindow.isInitialLoad = true;\r\n\r\n// Simple initialization - map with heatmap and controls\r\n(async function () {\r\n  try {\r\n    // Wait for Leaflet to be available\r\n    // eslint-disable-next-line no-unmodified-loop-condition\r\n    while (typeof L === \"undefined\") {\r\n      await new Promise((resolve) => setTimeout(resolve, 50));\r\n    }\r\n\r\n    // Store original center point (origin) - calculated from brgy_boundaries_location.json\r\n    // Center calculated from all barangay boundaries: [6.854282, 125.318462]\r\n    const originCenter = [6.854282, 125.318462]; // Digos City center from JSON file\r\n    const originZoom = 11;\r\n\r\n    // Initialize map with increased zoom out level\r\n    map = await initializeSimpleMap(\"map\", {\r\n      center: originCenter,\r\n      zoom: originZoom,\r\n      minZoom: 8, // Allow zooming out further (lower = more zoom out)\r\n    });\r\n\r\n    if (!map) {\r\n      throw new Error(\"Failed to initialize map\");\r\n    }\r\n\r\n    // Store map globally for boundaryGenerator\r\n    window.simpleMap = map;\r\n\r\n    // --- Dark Mode Handler ---\r\n    // Function to check and update map theme\r\n    const updateMapTheme = () => {\r\n      const isDark = document.documentElement.classList.contains(\"dark\");\r\n      if (typeof window.switchTileLayer === \"function\") {\r\n        if (isDark) {\r\n          window.switchTileLayer(\"Standard Dark\");\r\n        } else {\r\n          // Switch back to default (OpenStreetMap or Standard Light)\r\n          // Check what was previous or default. usually OSM.\r\n          window.switchTileLayer(\"OpenStreetMap\");\r\n        }\r\n      }\r\n    };\r\n\r\n    // Initial check (delay slightly to ensure layers are init)\r\n    setTimeout(updateMapTheme, 100);\r\n\r\n    // Watch for theme changes\r\n    const themeObserver = new MutationObserver((mutations) => {\r\n      mutations.forEach((mutation) => {\r\n        if (\r\n          mutation.type === \"attributes\" &&\r\n          mutation.attributeName === \"class\"\r\n        ) {\r\n          updateMapTheme();\r\n        }\r\n      });\r\n    });\r\n    themeObserver.observe(document.documentElement, {\r\n      attributes: true,\r\n      attributeFilter: [\"class\"],\r\n    });\r\n    // -------------------------\r\n\r\n    // Ensure layer control (tile changer) stays below zoom controls\r\n    // It should remain in its default Leaflet position (.leaflet-top.leaflet-left)\r\n    // No need to move it - it's already positioned correctly below zoom controls\r\n\r\n    // Add zoom event listener for heatmap/marker visibility and origin reset\r\n    map.on(\"zoomend\", () => {\r\n      const currentZoom = map.getZoom();\r\n      const minZoom = map.getMinZoom();\r\n\r\n      // When zoomed out to minimum level, reset to origin\r\n      if (currentZoom <= minZoom) {\r\n        map.setView(originCenter, originZoom, { animate: true });\r\n      }\r\n\r\n      // Mark initial load as complete only when user zooms IN (zoom > 11)\r\n      // This ensures markers stay hidden until user manually zooms in\r\n      if (isInitialLoad && currentZoom > 11) {\r\n        isInitialLoad = false;\r\n        window.isInitialLoad = false;\r\n      }\r\n\r\n      // Zoom-based visibility: heatmap at zoom <= 11, markers at zoom > 11\r\n      updateZoomBasedVisibility(currentZoom);\r\n    });\r\n\r\n    // Also listen to zoom to update immediately\r\n    map.on(\"zoom\", () => {\r\n      const currentZoom = map.getZoom();\r\n\r\n      // Mark initial load as complete only when user zooms IN (zoom > 11)\r\n      // This ensures markers stay hidden until user manually zooms in\r\n      if (isInitialLoad && currentZoom > 11) {\r\n        isInitialLoad = false;\r\n        window.isInitialLoad = false;\r\n      }\r\n\r\n      updateZoomBasedVisibility(currentZoom);\r\n    });\r\n\r\n    // Initialize heatmap visualization\r\n    heatmapViz = new HeatmapVisualization(map);\r\n\r\n    // Initialize user role for role-based filtering\r\n    await heatmapViz.initializeUserRole();\r\n\r\n    // console.log(\"[HEATMAP] User role initialized:\", {\r\n    //   role: heatmapViz.userRole,\r\n    //   department: heatmapViz.userDepartment,\r\n    //   isCoordinator: heatmapViz.userRole === \"complaint-coordinator\",\r\n    //   isSuperAdmin: heatmapViz.userRole === \"super-admin\",\r\n    // });\r\n\r\n    // LGU Admins are always scoped to their assigned office\r\n    // Coordinators and super-admins should NOT have department filters applied\r\n    if (heatmapViz.userRole === \"lgu-admin\" && heatmapViz.userDepartment) {\r\n      currentFilters.department = heatmapViz.userDepartment;\r\n      // console.log(\r\n      //   \"[HEATMAP] LGU Admin detected - applying department filter:\",\r\n      //   heatmapViz.userDepartment\r\n      // );\r\n    } else if (\r\n      heatmapViz.userRole === \"complaint-coordinator\" ||\r\n      heatmapViz.userRole === \"super-admin\"\r\n    ) {\r\n      // Ensure coordinators and super-admins have NO department filter\r\n      currentFilters.department = \"\";\r\n      // console.log(\r\n      //   \"[HEATMAP] Coordinator/Super-admin detected - NO department filter applied\"\r\n      // );\r\n    }\r\n\r\n    // Store globally for boundaryGenerator to access\r\n    window.heatmapViz = heatmapViz;\r\n\r\n    // Setup control panel handlers\r\n    setupControlPanel();\r\n\r\n    // Setup sidebar toggle\r\n    setupSidebarToggle();\r\n\r\n    // Wait a bit for boundaries to load, then load complaint data\r\n    // This ensures boundary filtering works correctly\r\n    let boundaryWaitAttempts = 0;\r\n    const maxBoundaryWait = 20; // Wait up to 4 seconds (20 * 200ms)\r\n    while (!window.cityBoundaries && boundaryWaitAttempts < maxBoundaryWait) {\r\n      await new Promise((resolve) => setTimeout(resolve, 200));\r\n      boundaryWaitAttempts++;\r\n    }\r\n\r\n    if (window.cityBoundaries) {\r\n      // console.log(\r\n      //   \"[HEATMAP] Boundaries loaded, filtering complaints by boundary\"\r\n      // );\r\n    } else {\r\n      console.warn(\r\n        \"[HEATMAP] Boundaries not loaded yet, using bounding box fallback\"\r\n      );\r\n    }\r\n\r\n    // Load complaint data (but keep default Digos City view - don't auto-fit)\r\n    await loadComplaintData();\r\n\r\n    // Keep default Digos City view on initial load instead of auto-fitting\r\n    // Users can click \"Fit to All Markers\" button if they want to see all complaints\r\n  } catch (error) {\r\n    console.error(\"[HEATMAP] Initialization failed:\", error);\r\n  }\r\n})();\r\n\r\n// Calculate date range from complaint data\r\nfunction calculateDateRange(complaintData) {\r\n  if (!complaintData || complaintData.length === 0) {\r\n    return { oldest: null, latest: null };\r\n  }\r\n\r\n  let oldest = null;\r\n  let latest = null;\r\n\r\n  complaintData.forEach((complaint) => {\r\n    const complaintDate = new Date(\r\n      complaint.submittedAt || complaint.submitted_at\r\n    );\r\n    if (isNaN(complaintDate.getTime())) {\r\n      return; // Skip invalid dates\r\n    }\r\n\r\n    if (!oldest || complaintDate < oldest) {\r\n      oldest = new Date(complaintDate);\r\n    }\r\n    if (!latest || complaintDate > latest) {\r\n      latest = new Date(complaintDate);\r\n    }\r\n  });\r\n\r\n  return { oldest, latest };\r\n}\r\n\r\n// Setup date picker constraints based on complaint data and selected dates\r\nfunction setupDatePickerConstraints() {\r\n  const dateStart = document.getElementById(\"date-range-start\");\r\n  const dateEnd = document.getElementById(\"date-range-end\");\r\n\r\n  if (!dateStart || !dateEnd || !heatmapViz || !heatmapViz.allComplaintData) {\r\n    return;\r\n  }\r\n\r\n  const { oldest, latest } = calculateDateRange(heatmapViz.allComplaintData);\r\n\r\n  if (!oldest || !latest) {\r\n    console.warn(\r\n      \"[HEATMAP] No valid complaint dates found for date range restriction\"\r\n    );\r\n    return;\r\n  }\r\n\r\n  // Format dates as YYYY-MM-DD for HTML5 date inputs\r\n  const oldestDateStr = oldest.toISOString().split(\"T\")[0];\r\n  const todayStr = new Date().toISOString().split(\"T\")[0];\r\n\r\n  // Get currently selected dates\r\n  const selectedStartDate = dateStart.value;\r\n  const selectedEndDate = dateEnd.value;\r\n\r\n  // Set base min/max for both inputs (oldest to today)\r\n  dateStart.setAttribute(\"min\", oldestDateStr);\r\n  dateStart.setAttribute(\"max\", todayStr);\r\n  dateEnd.setAttribute(\"min\", oldestDateStr);\r\n  dateEnd.setAttribute(\"max\", todayStr);\r\n\r\n  // Apply dynamic constraints based on selected dates\r\n  updateDatePickerConstraints(selectedStartDate, selectedEndDate);\r\n}\r\n\r\n// Update date picker constraints dynamically when dates are selected\r\nfunction updateDatePickerConstraints(selectedStartDate, selectedEndDate) {\r\n  const dateStart = document.getElementById(\"date-range-start\");\r\n  const dateEnd = document.getElementById(\"date-range-end\");\r\n\r\n  if (!dateStart || !dateEnd || !heatmapViz || !heatmapViz.allComplaintData) {\r\n    return;\r\n  }\r\n\r\n  const { oldest } = calculateDateRange(heatmapViz.allComplaintData);\r\n  if (!oldest) {\r\n    return;\r\n  }\r\n\r\n  const oldestDateStr = oldest.toISOString().split(\"T\")[0];\r\n  const todayStr = new Date().toISOString().split(\"T\")[0];\r\n\r\n  // Start date: min = oldest, max = selected end date (or today if no end date selected)\r\n  if (selectedEndDate) {\r\n    dateStart.setAttribute(\"max\", selectedEndDate);\r\n  } else {\r\n    dateStart.setAttribute(\"max\", todayStr);\r\n  }\r\n  dateStart.setAttribute(\"min\", oldestDateStr);\r\n\r\n  // End date: min = selected start date (or oldest if no start date selected), max = today\r\n  if (selectedStartDate) {\r\n    dateEnd.setAttribute(\"min\", selectedStartDate);\r\n  } else {\r\n    dateEnd.setAttribute(\"min\", oldestDateStr);\r\n  }\r\n  dateEnd.setAttribute(\"max\", todayStr);\r\n\r\n  // Clear invalid selections\r\n  if (selectedStartDate && selectedEndDate) {\r\n    const startDate = new Date(selectedStartDate);\r\n    const endDate = new Date(selectedEndDate);\r\n\r\n    if (startDate > endDate) {\r\n      // Start date is after end date - clear the one that violates constraint\r\n      const startMax = new Date(dateStart.getAttribute(\"max\"));\r\n      const endMin = new Date(dateEnd.getAttribute(\"min\"));\r\n\r\n      if (startDate > startMax) {\r\n        dateStart.value = \"\";\r\n      }\r\n      if (endDate < endMin) {\r\n        dateEnd.value = \"\";\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Load complaint data (only called once on initial load, then filters are applied client-side)\r\nasync function loadComplaintData() {\r\n  try {\r\n    // Load ALL complaints (no filters) - we'll filter client-side\r\n    await heatmapViz.loadComplaintData({ includeResolved: true });\r\n\r\n    // Get the count of all complaints\r\n    const totalCount = heatmapViz.allComplaintData\r\n      ? heatmapViz.allComplaintData.length\r\n      : 0;\r\n    // console.log(`[HEATMAP] Loaded ${totalCount} total complaint(s)`);\r\n\r\n    // Setup date picker constraints based on loaded complaint data\r\n    setupDatePickerConstraints();\r\n\r\n    // Default to showing only Today's complaints\r\n    const dateStart = document.getElementById(\"date-range-start\");\r\n    const dateEnd = document.getElementById(\"date-range-end\");\r\n    if (dateStart && dateEnd) {\r\n      const today = new Date();\r\n      // Handle timezone offset to ensure we get the correct local date string\r\n      const offset = today.getTimezoneOffset() * 60000; // offset in milliseconds\r\n      const localToday = new Date(today.getTime() - offset);\r\n      const todayStr = localToday.toISOString().split(\"T\")[0];\r\n\r\n      dateStart.value = todayStr;\r\n      dateEnd.value = todayStr;\r\n\r\n      // Update constraints for the selected dates\r\n      updateDatePickerConstraints(todayStr, todayStr);\r\n      // console.log(`[HEATMAP] Defaulting filter to Today: ${todayStr}`);\r\n    }\r\n\r\n    // REMOVED: Redundant initial heatmap creation\r\n    // applyFiltersAndUpdate() below will create the heatmap with the \"Today\" filter applied\r\n\r\n    // IMPORTANT: Do NOT create markers during initial load\r\n    // Markers will be created lazily when user zooms in for the first time\r\n    // This prevents any flash of markers on page load\r\n    // Markers will be created in updateZoomBasedVisibility() when zoom > 11 and isInitialLoad becomes false\r\n\r\n    // Apply initial filters (markers don't exist yet, so this only affects heatmap)\r\n    applyFiltersAndUpdate();\r\n\r\n    // Apply initial zoom-based visibility (only heatmap will show)\r\n    const initialZoom = map ? map.getZoom() : 11;\r\n    updateZoomBasedVisibility(initialZoom);\r\n\r\n    // Update statistics\r\n    updateStatistics();\r\n  } catch (error) {\r\n    console.error(\"[HEATMAP] Failed to load data:\", error);\r\n  }\r\n}\r\n\r\n// Track if this is the initial load (show only heatmap regardless of zoom)\r\n// Moved to top of file\r\n// Make it globally accessible so heatmapVisualization can check it\r\n// Moved to top of file\r\n\r\n// Function to update visibility based on zoom level (must be global for zoom events)\r\nfunction updateZoomBasedVisibility(zoom) {\r\n  if (!heatmapViz) return;\r\n\r\n  const zoomThreshold = 11;\r\n  const heatmapToggle = document.getElementById(\"toggle-heatmap-btn\");\r\n  const isHeatmapForced =\r\n    heatmapToggle && heatmapToggle.classList.contains(\"forced-on\");\r\n\r\n  // On initial load, show only heatmap regardless of zoom\r\n  // Markers will remain hidden until user manually zooms in (zoom > 11)\r\n  if (isInitialLoad) {\r\n    if (heatmapViz.heatmapLayer) {\r\n      heatmapViz.showHeatmap();\r\n    }\r\n    if (heatmapViz.markerLayer) {\r\n      // Explicitly hide all markers - they won't show until user zooms in\r\n      heatmapViz.hideMarkers();\r\n    }\r\n    return; // Exit early - don't process zoom-based visibility during initial load\r\n  }\r\n\r\n  if (zoom <= zoomThreshold) {\r\n    // Show heatmap, hide markers (zoom <= 11)\r\n    if (heatmapViz.heatmapLayer) {\r\n      heatmapViz.showHeatmap();\r\n    }\r\n    if (heatmapViz.markerLayer) {\r\n      // Hide all markers when zoom <= 11\r\n      heatmapViz.hideMarkers();\r\n    }\r\n  } else {\r\n    // Zoom > 11: Show markers that pass filters, hide heatmap unless forced\r\n    // Role-based: Citizens don't see markers (only heatmap), others see markers based on role\r\n    const userRole = heatmapViz.userRole || \"citizen\";\r\n\r\n    // Citizens: Always show only heatmap, never markers\r\n    if (userRole === \"citizen\") {\r\n      if (heatmapViz.heatmapLayer) {\r\n        heatmapViz.showHeatmap();\r\n      }\r\n      if (heatmapViz.markerLayer) {\r\n        heatmapViz.hideMarkers();\r\n      }\r\n      // Hide toggle markers button for citizens\r\n      const toggleMarkersBtn = document.getElementById(\"toggle-markers-btn\");\r\n      if (toggleMarkersBtn) {\r\n        toggleMarkersBtn.style.display = \"none\";\r\n      }\r\n    } else {\r\n      // Non-citizens: Show markers based on zoom and filters\r\n      // Create markers lazily if they don't exist yet (first time user zooms in)\r\n      if (\r\n        !heatmapViz.markerLayer ||\r\n        heatmapViz.markerLayer.getLayers().length === 0\r\n      ) {\r\n        heatmapViz.createMarkerLayer();\r\n      }\r\n\r\n      if (\r\n        heatmapViz.markerLayer &&\r\n        heatmapViz.markerLayer.getLayers().length > 0\r\n      ) {\r\n        // First ensure the marker layer is on the map\r\n        if (!heatmapViz.map.hasLayer(heatmapViz.markerLayer)) {\r\n          heatmapViz.markerLayer.addTo(heatmapViz.map);\r\n        }\r\n\r\n        // Trigger marker visibility update based on current filters\r\n        // This ensures markers respect filter settings when zooming in\r\n        if (heatmapViz.updateMarkerVisibility) {\r\n          heatmapViz.updateMarkerVisibility();\r\n        } else {\r\n          // Fallback: show all markers if updateMarkerVisibility doesn't exist\r\n          heatmapViz.showMarkers();\r\n        }\r\n\r\n        // Update toggle button state\r\n        const toggleMarkersBtn = document.getElementById(\"toggle-markers-btn\");\r\n        if (toggleMarkersBtn) {\r\n          toggleMarkersBtn.textContent = \"Hide Markers\";\r\n          toggleMarkersBtn.classList.add(\"active\");\r\n          toggleMarkersBtn.style.display = \"block\";\r\n        }\r\n      }\r\n\r\n      // Hide heatmap unless forced on\r\n      if (heatmapViz.heatmapLayer) {\r\n        if (isHeatmapForced) {\r\n          heatmapViz.showHeatmap();\r\n        } else {\r\n          heatmapViz.hideHeatmap();\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Function to ensure menu toggle and reset view button are in horizontal row\r\nfunction positionResetViewButton() {\r\n  const customControlsRow = document.querySelector(\".map-custom-controls-row\");\r\n  const resetViewButton = document.getElementById(\"reset-view-btn\");\r\n  const menuToggle = document.getElementById(\"menu-toggle\");\r\n\r\n  if (!customControlsRow) return;\r\n\r\n  // Ensure menu toggle is in the row\r\n  if (menuToggle && menuToggle.parentElement !== customControlsRow) {\r\n    customControlsRow.insertBefore(menuToggle, customControlsRow.firstChild);\r\n  }\r\n\r\n  // Ensure reset view button is in the row (not positioned elsewhere)\r\n  if (resetViewButton) {\r\n    // Remove any absolute/fixed positioning that might have been set\r\n    resetViewButton.style.position = \"relative\";\r\n    resetViewButton.style.top = \"auto\";\r\n    resetViewButton.style.left = \"auto\";\r\n    resetViewButton.style.bottom = \"auto\";\r\n\r\n    // Ensure it's in the row container\r\n    if (resetViewButton.parentElement !== customControlsRow) {\r\n      customControlsRow.appendChild(resetViewButton);\r\n    }\r\n  }\r\n\r\n  // Layer control (tile changer) should stay in its default Leaflet position\r\n  // below the zoom controls - don't move it to the row\r\n}\r\n\r\n// Setup control panel event handlers\r\nfunction setupControlPanel() {\r\n  // New Dropdown Logic for Horizontal Toolbar\r\n  const dropdowns = [\r\n    { btnId: \"toolbar-display-btn\", dropdownId: \"toolbar-display-dropdown\" },\r\n    { btnId: \"toolbar-date-btn\", dropdownId: \"toolbar-date-dropdown\" },\r\n    { btnId: \"toolbar-status-btn\", dropdownId: \"toolbar-status-dropdown\" },\r\n    { btnId: \"toolbar-category-btn\", dropdownId: \"toolbar-category-dropdown\" },\r\n    { btnId: \"toolbar-office-btn\", dropdownId: \"toolbar-office-dropdown\" },\r\n    { btnId: \"toolbar-stats-btn\", dropdownId: \"toolbar-stats-dropdown\" },\r\n  ];\r\n\r\n  function closeAllDropdowns() {\r\n    dropdowns.forEach(({ dropdownId }) => {\r\n      const el = document.getElementById(dropdownId);\r\n      if (el) el.classList.add(\"hidden\");\r\n    });\r\n  }\r\n\r\n  dropdowns.forEach(({ btnId, dropdownId }) => {\r\n    const btn = document.getElementById(btnId);\r\n    const dropdown = document.getElementById(dropdownId);\r\n\r\n    if (btn && dropdown) {\r\n      btn.addEventListener(\"click\", (e) => {\r\n        e.stopPropagation();\r\n        const isHidden = dropdown.classList.contains(\"hidden\");\r\n        // Close others first\r\n        closeAllDropdowns();\r\n        // Toggle current\r\n        if (isHidden) {\r\n          dropdown.classList.remove(\"hidden\");\r\n        }\r\n      });\r\n\r\n      // Prevent closing when clicking inside dropdown\r\n      dropdown.addEventListener(\"click\", (e) => {\r\n        e.stopPropagation();\r\n      });\r\n    }\r\n  });\r\n\r\n  // Close on outside click\r\n  document.addEventListener(\"click\", () => {\r\n    closeAllDropdowns();\r\n  });\r\n\r\n  // Initial positioning - REMOVED\r\n\r\n  // Setup Back Button\r\n  const backBtn = document.getElementById(\"back-btn\");\r\n  if (backBtn) {\r\n    backBtn.addEventListener(\"click\", () => {\r\n      history.back();\r\n    });\r\n  }\r\n\r\n  // Also reposition on window resize - REMOVED\r\n\r\n  // Initialize reset view button positioning\r\n  setTimeout(() => {\r\n    positionResetViewButton();\r\n  }, 100);\r\n\r\n  // Ensure layer control is in row after everything loads\r\n  setTimeout(() => {\r\n    positionResetViewButton();\r\n  }, 500);\r\n\r\n  // Setup legend toggle (collapsible drawer)\r\n  const legendToggle = document.getElementById(\"legend-toggle\");\r\n  const mapLegend = document.getElementById(\"map-legend\");\r\n  if (legendToggle && mapLegend) {\r\n    legendToggle.addEventListener(\"click\", () => {\r\n      mapLegend.classList.toggle(\"collapsed\");\r\n      mapLegend.classList.toggle(\"expanded\");\r\n    });\r\n  }\r\n\r\n  // Helper function to get checked values from checkbox group\r\n  function getCheckedValues(checkboxClass) {\r\n    const checkboxes = document.querySelectorAll(`.${checkboxClass}:checked`);\r\n    return Array.from(checkboxes).map((cb) => cb.value);\r\n  }\r\n\r\n  // Helper function to reset checkboxes\r\n  function resetCheckboxes(checkboxClass) {\r\n    document\r\n      .querySelectorAll(`.${checkboxClass}`)\r\n      .forEach((cb) => (cb.checked = false));\r\n  }\r\n\r\n  // Debounce function to limit API calls\r\n  let filterDebounceTimer = null;\r\n  let isUpdating = false; // Prevent concurrent updates\r\n\r\n  function debounceFilterUpdate(callback, delay = 500) {\r\n    clearTimeout(filterDebounceTimer);\r\n    filterDebounceTimer = setTimeout(async () => {\r\n      if (!isUpdating) {\r\n        isUpdating = true;\r\n        try {\r\n          await callback();\r\n        } catch (error) {\r\n          console.error(\"[HEATMAP] Error in debounced update:\", error);\r\n        } finally {\r\n          // Always reset the flag after a short delay to allow UI to update\r\n          setTimeout(() => {\r\n            isUpdating = false;\r\n          }, 100);\r\n        }\r\n      } else {\r\n        console.log(\r\n          \"[HEATMAP] Update already in progress, will retry after current update completes\"\r\n        );\r\n      }\r\n    }, delay);\r\n  }\r\n\r\n  // Function to apply filters and update map visibility (client-side, no API call)\r\n  function applyFiltersAndUpdate() {\r\n    const statusValues = getCheckedValues(\"status-checkbox\");\r\n    const categoryValues = getCheckedValues(\"category-checkbox\");\r\n    // Only apply department filter for LGU admins, NOT for coordinators or super-admins\r\n    const userRestrictedDepartment =\r\n      heatmapViz?.userRole === \"lgu-admin\" && heatmapViz.userDepartment\r\n        ? heatmapViz.userDepartment\r\n        : null;\r\n\r\n    // Coordinators and super-admins should see all complaints (no department filter)\r\n    const isCoordinatorOrSuperAdmin =\r\n      heatmapViz?.userRole === \"complaint-coordinator\" ||\r\n      heatmapViz?.userRole === \"super-admin\";\r\n    const departmentValues = isCoordinatorOrSuperAdmin\r\n      ? null\r\n      : userRestrictedDepartment || getCheckedValues(\"department-checkbox\");\r\n\r\n    const startDate = document.getElementById(\"date-range-start\")?.value || \"\";\r\n    const endDate = document.getElementById(\"date-range-end\")?.value || \"\";\r\n\r\n    currentFilters = {\r\n      status: statusValues.length > 0 ? statusValues : \"\",\r\n      category: categoryValues.length > 0 ? categoryValues : \"\",\r\n      department:\r\n        departmentValues && departmentValues.length > 0 ? departmentValues : \"\",\r\n      includeResolved: document.getElementById(\"include-resolved\").checked,\r\n      startDate,\r\n      endDate,\r\n    };\r\n\r\n    // Update marker visibility without reloading data\r\n    if (heatmapViz) {\r\n      heatmapViz.currentFilters = currentFilters;\r\n\r\n      // Update heatmap layer with filtered data\r\n      if (heatmapViz.heatmapLayer) {\r\n        heatmapViz.hideHeatmap();\r\n      }\r\n      heatmapViz.createHeatmapLayer();\r\n\r\n      // Trigger marker visibility update if markers exist and are visible\r\n      if (\r\n        heatmapViz.markerLayer &&\r\n        map &&\r\n        map.hasLayer(heatmapViz.markerLayer)\r\n      ) {\r\n        // Markers are visible - update their visibility based on filters\r\n        if (heatmapViz.updateMarkerVisibility) {\r\n          heatmapViz.updateMarkerVisibility();\r\n        }\r\n      }\r\n\r\n      // Apply zoom-based visibility (this will handle both markers and heatmap)\r\n      // Don't call updateMarkerVisibility() directly - let updateZoomBasedVisibility handle it\r\n      const currentZoom = map ? map.getZoom() : 11;\r\n      updateZoomBasedVisibility(currentZoom);\r\n      updateStatistics();\r\n    }\r\n  }\r\n\r\n  // Make function and timer globally accessible for dynamically loaded checkboxes\r\n  window.applyFiltersAndUpdate = applyFiltersAndUpdate;\r\n  window.debounceFilterUpdate = debounceFilterUpdate;\r\n\r\n  // Apply Filters button removed - filtering is now automatic when checkboxes change\r\n\r\n  // Auto-apply filters when checkboxes change\r\n  function setupAutoFiltering() {\r\n    // Status checkboxes (already in HTML, attach listeners)\r\n    document.querySelectorAll(\".status-checkbox\").forEach((checkbox) => {\r\n      checkbox.addEventListener(\"change\", () => {\r\n        debounceFilterUpdate(applyFiltersAndUpdate, 500);\r\n      });\r\n    });\r\n\r\n    // Category and Department checkboxes are loaded dynamically,\r\n    // so listeners are attached in loadCategories() and loadDepartments()\r\n\r\n    // Include resolved checkbox\r\n    const includeResolvedCheckbox = document.getElementById(\"include-resolved\");\r\n    if (includeResolvedCheckbox) {\r\n      includeResolvedCheckbox.addEventListener(\"change\", () => {\r\n        debounceFilterUpdate(applyFiltersAndUpdate, 500);\r\n      });\r\n    }\r\n\r\n    // Date range filters\r\n    const dateStart = document.getElementById(\"date-range-start\");\r\n    const dateEnd = document.getElementById(\"date-range-end\");\r\n    const clearDateRange = document.getElementById(\"clear-date-range\");\r\n\r\n    if (dateStart) {\r\n      dateStart.addEventListener(\"change\", () => {\r\n        // Update constraints when start date changes\r\n        const selectedStartDate = dateStart.value;\r\n        const selectedEndDate = dateEnd ? dateEnd.value : \"\";\r\n        updateDatePickerConstraints(selectedStartDate, selectedEndDate);\r\n        debounceFilterUpdate(applyFiltersAndUpdate, 500);\r\n      });\r\n    }\r\n\r\n    if (dateEnd) {\r\n      dateEnd.addEventListener(\"change\", () => {\r\n        // Update constraints when end date changes\r\n        const selectedStartDate = dateStart ? dateStart.value : \"\";\r\n        const selectedEndDate = dateEnd.value;\r\n        updateDatePickerConstraints(selectedStartDate, selectedEndDate);\r\n        debounceFilterUpdate(applyFiltersAndUpdate, 500);\r\n      });\r\n    }\r\n\r\n    if (clearDateRange) {\r\n      clearDateRange.addEventListener(\"click\", () => {\r\n        if (dateStart) dateStart.value = \"\";\r\n        if (dateEnd) dateEnd.value = \"\";\r\n        // Reset constraints to base range\r\n        updateDatePickerConstraints(\"\", \"\");\r\n        debounceFilterUpdate(applyFiltersAndUpdate, 500);\r\n      });\r\n\r\n      // Add \"Today\" button dynamically if it doesn't exist\r\n      if (!document.getElementById(\"filter-today-btn\")) {\r\n        const todayBtn = document.createElement(\"button\");\r\n        todayBtn.id = \"filter-today-btn\";\r\n        todayBtn.className = \"btn btn-sm btn-outline-primary ms-1\";\r\n        todayBtn.textContent = \"Today\";\r\n        todayBtn.type = \"button\";\r\n\r\n        // Insert after clear button\r\n        clearDateRange.parentNode.insertBefore(\r\n          todayBtn,\r\n          clearDateRange.nextSibling\r\n        );\r\n\r\n        todayBtn.addEventListener(\"click\", () => {\r\n          const today = new Date();\r\n          const todayStr = today.toISOString().split(\"T\")[0];\r\n\r\n          if (dateStart) dateStart.value = todayStr;\r\n          if (dateEnd) dateEnd.value = todayStr;\r\n\r\n          // Update constraints\r\n          updateDatePickerConstraints(todayStr, todayStr);\r\n          debounceFilterUpdate(applyFiltersAndUpdate, 500);\r\n        });\r\n      }\r\n    }\r\n\r\n    // Toggle markers button (hidden for citizens)\r\n    const toggleMarkersBtn = document.getElementById(\"toggle-markers-btn\");\r\n    if (toggleMarkersBtn) {\r\n      // Hide toggle button for citizens (they only see heatmap)\r\n      const userRole = heatmapViz?.userRole || \"citizen\";\r\n      if (userRole === \"citizen\") {\r\n        toggleMarkersBtn.style.display = \"none\";\r\n      }\r\n\r\n      toggleMarkersBtn.addEventListener(\"click\", () => {\r\n        if (!heatmapViz) return;\r\n\r\n        // Citizens shouldn't be able to toggle markers\r\n        if (heatmapViz.userRole === \"citizen\") {\r\n          return;\r\n        }\r\n\r\n        // Check if markers are currently visible\r\n        const markersVisible =\r\n          heatmapViz.markerLayer && map && map.hasLayer(heatmapViz.markerLayer);\r\n\r\n        if (markersVisible) {\r\n          // Hide markers\r\n          heatmapViz.hideMarkers();\r\n          toggleMarkersBtn.textContent = \"Show Markers\";\r\n          toggleMarkersBtn.classList.remove(\"active\");\r\n          console.log(\"[HEATMAP] Markers hidden via toggle\");\r\n        } else {\r\n          // Show markers - ensure layer exists first\r\n          if (\r\n            !heatmapViz.markerLayer ||\r\n            heatmapViz.markerLayer.getLayers().length === 0\r\n          ) {\r\n            heatmapViz.createMarkerLayer();\r\n          }\r\n\r\n          // Apply current filters to determine which markers should be visible\r\n          if (heatmapViz.updateMarkerVisibility) {\r\n            heatmapViz.updateMarkerVisibility();\r\n          } else {\r\n            heatmapViz.showMarkers();\r\n          }\r\n\r\n          toggleMarkersBtn.textContent = \"Hide Markers\";\r\n          toggleMarkersBtn.classList.add(\"active\");\r\n          console.log(\"[HEATMAP] Markers shown via toggle\");\r\n        }\r\n      });\r\n    }\r\n\r\n    // Toggle heatmap button\r\n    const toggleHeatmapBtn = document.getElementById(\"toggle-heatmap-btn\");\r\n    if (toggleHeatmapBtn) {\r\n      toggleHeatmapBtn.addEventListener(\"click\", () => {\r\n        if (!heatmapViz) return;\r\n\r\n        const isForced = toggleHeatmapBtn.classList.contains(\"forced-on\");\r\n        const currentZoom = map ? map.getZoom() : 11;\r\n\r\n        if (isForced) {\r\n          // Turn off forced mode - return to zoom-based visibility\r\n          toggleHeatmapBtn.classList.remove(\"forced-on\");\r\n          toggleHeatmapBtn.textContent = \"Toggle Heatmap\";\r\n          updateZoomBasedVisibility(currentZoom);\r\n        } else {\r\n          // Force heatmap on\r\n          toggleHeatmapBtn.classList.add(\"forced-on\");\r\n          toggleHeatmapBtn.textContent = \"Heatmap: ON\";\r\n          if (heatmapViz.heatmapLayer) {\r\n            heatmapViz.showHeatmap();\r\n          }\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  // Reset filters\r\n  const resetFiltersBtn = document.getElementById(\"reset-filters-btn\");\r\n  if (resetFiltersBtn) {\r\n    resetFiltersBtn.addEventListener(\"click\", async () => {\r\n      resetCheckboxes(\"status-checkbox\");\r\n      resetCheckboxes(\"category-checkbox\");\r\n      resetCheckboxes(\"department-checkbox\");\r\n      document.getElementById(\"include-resolved\").checked = true;\r\n\r\n      // Clear date range\r\n      const dateStart = document.getElementById(\"date-range-start\");\r\n      const dateEnd = document.getElementById(\"date-range-end\");\r\n      if (dateStart) dateStart.value = \"\";\r\n      if (dateEnd) dateEnd.value = \"\";\r\n\r\n      // Reset heatmap toggle\r\n      const toggleHeatmapBtn = document.getElementById(\"toggle-heatmap-btn\");\r\n      if (toggleHeatmapBtn) {\r\n        toggleHeatmapBtn.classList.remove(\"forced-on\");\r\n        toggleHeatmapBtn.textContent = \"Toggle Heatmap\";\r\n      }\r\n\r\n      currentFilters = {\r\n        status: \"\",\r\n        category: \"\",\r\n        department:\r\n          heatmapViz?.userRole === \"lgu-admin\" && heatmapViz.userDepartment\r\n            ? heatmapViz.userDepartment\r\n            : \"\",\r\n        includeResolved: true,\r\n        startDate: \"\",\r\n        endDate: \"\",\r\n      };\r\n\r\n      await loadComplaintData();\r\n      fitToAllMarkers();\r\n    });\r\n  }\r\n\r\n  // Fit to bounds - check if button exists (might have been removed in redesign)\r\n  const fitBoundsBtn = document.getElementById(\"fit-bounds-btn\");\r\n  if (fitBoundsBtn) {\r\n    fitBoundsBtn.addEventListener(\"click\", () => {\r\n      fitToAllMarkers();\r\n    });\r\n  }\r\n\r\n  // Reset view button\r\n  const resetViewBtn = document.getElementById(\"reset-view-btn\");\r\n  if (resetViewBtn) {\r\n    resetViewBtn.addEventListener(\"click\", () => {\r\n      resetMapView();\r\n    });\r\n    // console.log(\"[HEATMAP] Reset view button initialized\");\r\n  } else {\r\n    console.warn(\"[HEATMAP] Reset view button not found in DOM\");\r\n  }\r\n\r\n  // Accordion functionality\r\n  const accordionHeaders = document.querySelectorAll(\".accordion-header\");\r\n  accordionHeaders.forEach((header) => {\r\n    header.addEventListener(\"click\", () => {\r\n      const section = header.parentElement;\r\n      const isActive = section.classList.contains(\"active\");\r\n\r\n      // Close all sections except the one clicked (if it was already active, we'll close it below)\r\n      document.querySelectorAll(\".accordion-section.active\").forEach((s) => {\r\n        if (s !== section) {\r\n          s.classList.remove(\"active\");\r\n        }\r\n      });\r\n\r\n      // Toggle clicked section\r\n      if (isActive) {\r\n        section.classList.remove(\"active\");\r\n      } else {\r\n        section.classList.add(\"active\");\r\n      }\r\n\r\n      // Reposition gear button after animation\r\n    });\r\n  });\r\n\r\n  // Fixed Heatmap Configuration\r\n  if (heatmapViz) {\r\n    heatmapViz.heatmapConfig.intensity = 1.0; // Fixed intensity\r\n    // Zoom threshold is handled in updateZoomBasedVisibility with fixed value 11\r\n  }\r\n\r\n  // Initial icon setup is no longer needed as CSS handles rotation\r\n  // but we ensure only one section is open initially (handled by HTML class=\"active\")\r\n\r\n  // Load categories, departments, and status filters\r\n  loadStatusFilters();\r\n  loadCategories();\r\n  loadDepartments();\r\n\r\n  // Setup auto-filtering immediately\r\n  setupAutoFiltering();\r\n}\r\n\r\n// Load status filters\r\nfunction loadStatusFilters() {\r\n  const group = document.getElementById(\"status-filters\");\r\n  if (!group) return;\r\n\r\n  const statuses = [\r\n    { label: \"New / Pending\", value: \"new,pending\", color: \"#6B7280\" }, // gray-500\r\n    { label: \"Assigned\", value: \"assigned\", color: \"#FBBF24\" }, // yellow-400\r\n    { label: \"In Progress\", value: \"in_progress\", color: \"#3B82F6\" }, // blue-500\r\n    { label: \"Completed\", value: \"resolved,closed\", color: \"#10B981\" }, // green-500\r\n  ];\r\n\r\n  statuses.forEach((status) => {\r\n    const label = document.createElement(\"label\");\r\n    // Use Tailwind classes used for better dark mode support\r\n    label.className =\r\n      \"flex items-center gap-1.5 font-normal py-0.5 cursor-pointer text-gray-700 dark:text-gray-300\";\r\n\r\n    const checkbox = document.createElement(\"input\");\r\n    checkbox.type = \"checkbox\";\r\n    checkbox.className = \"status-checkbox\";\r\n    checkbox.value = status.value;\r\n    checkbox.checked = true; // Default to checked\r\n\r\n    // Add color indicator\r\n    const indicator = document.createElement(\"span\");\r\n    indicator.style.cssText = `width: 8px; height: 8px; border-radius: 50%; background-color: ${status.color}; display: inline-block;`;\r\n\r\n    const text = document.createTextNode(status.label);\r\n\r\n    label.appendChild(checkbox);\r\n    label.appendChild(indicator);\r\n    label.appendChild(text);\r\n    group.appendChild(label);\r\n\r\n    // Add listener\r\n    checkbox.addEventListener(\"change\", () => {\r\n      if (window.debounceFilterUpdate && window.applyFiltersAndUpdate) {\r\n        window.debounceFilterUpdate(window.applyFiltersAndUpdate, 500);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\n// Load categories\r\n// Load categories\r\nasync function loadCategories() {\r\n  try {\r\n    const apiClientModule = await import(\"../../js/config/apiClient.js\");\r\n    const apiClient = apiClientModule.default;\r\n    const { data } = await apiClient.get(\r\n      \"/api/department-structure/categories\"\r\n    );\r\n\r\n    const group = document.getElementById(\"category-filter-group\");\r\n    const loading = document.getElementById(\"category-loading\");\r\n    if (loading) loading.remove();\r\n\r\n    if (data && data.length > 0) {\r\n      // Prioritization Logic for LGU Admins\r\n      let sortedData = [...data];\r\n      const userDepartmentCode = await getUserDepartment();\r\n      const isLguAdmin = heatmapViz?.userRole === \"lgu-admin\";\r\n\r\n      if (isLguAdmin && userDepartmentCode) {\r\n        // Mark categories as relevant if they map to the user's department\r\n        sortedData = sortedData.map((category) => {\r\n          const isRelevant = category.subcategories?.some((sub) =>\r\n            sub.departments?.some(\r\n              (dept) => (dept.code || \"\").toUpperCase() === userDepartmentCode\r\n            )\r\n          );\r\n          return { ...category, isRelevant };\r\n        });\r\n\r\n        // Sort: Relevant first\r\n        sortedData.sort((a, b) => {\r\n          if (a.isRelevant && !b.isRelevant) return -1;\r\n          if (!a.isRelevant && b.isRelevant) return 1;\r\n          return 0; // Maintain original order otherwise\r\n        });\r\n      }\r\n\r\n      sortedData.forEach((category) => {\r\n        const label = document.createElement(\"label\");\r\n        // Use Tailwind classes for styling instead of inline styles where possible for easier dark mode support\r\n        label.className =\r\n          \"flex items-center gap-1.5 font-normal py-0.5 cursor-pointer text-gray-700 dark:text-gray-300\";\r\n\r\n        const checkbox = document.createElement(\"input\");\r\n        checkbox.type = \"checkbox\";\r\n        checkbox.className = \"category-checkbox\";\r\n        checkbox.value = category.id;\r\n\r\n        // Auto-check relevant categories for LGU Admins\r\n        if (category.isRelevant) {\r\n          checkbox.checked = true;\r\n          // Use classes for bold/color instead of inline\r\n          label.classList.remove(\r\n            \"font-normal\",\r\n            \"text-gray-700\",\r\n            \"dark:text-gray-300\"\r\n          );\r\n          label.classList.add(\r\n            \"font-semibold\",\r\n            \"text-gray-900\",\r\n            \"dark:text-white\"\r\n          );\r\n        }\r\n\r\n        // Add change listener for auto-filtering\r\n        checkbox.addEventListener(\"change\", () => {\r\n          if (window.debounceFilterUpdate && window.applyFiltersAndUpdate) {\r\n            window.debounceFilterUpdate(window.applyFiltersAndUpdate, 500);\r\n          }\r\n        });\r\n\r\n        const text = document.createTextNode(\r\n          `${category.icon || \"\"} ${category.name}`\r\n        );\r\n        label.appendChild(checkbox);\r\n        label.appendChild(text);\r\n\r\n        // Visual indicator for relevant categories\r\n        if (category.isRelevant) {\r\n          const badge = document.createElement(\"span\");\r\n          badge.style.cssText =\r\n            \"width: 6px; height: 6px; background-color: #3B82F6; border-radius: 50%; margin-left: auto;\";\r\n          label.appendChild(badge);\r\n        }\r\n\r\n        group.appendChild(label);\r\n      });\r\n\r\n      // console.log(\r\n      //   `[HEATMAP] Loaded ${sortedData.length} categories (Prioritized for ${userDepartmentCode})`\r\n      // );\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[HEATMAP] Failed to load categories:\", error);\r\n  } finally {\r\n    // Reposition gear button after categories load (panel height might change)\r\n  }\r\n}\r\n\r\n// Get user's department code\r\nasync function getUserDepartment() {\r\n  try {\r\n    const apiClientModule = await import(\"../../js/config/apiClient.js\");\r\n    const apiClient = apiClientModule.default;\r\n    const response = await apiClient.get(\"/api/user/role-info\");\r\n    if (response.success && response.data) {\r\n      // Try multiple possible field names for department\r\n      const department =\r\n        response.data.department ||\r\n        response.data.dpt ||\r\n        response.data.metadata?.department ||\r\n        response.data.metadata?.dpt ||\r\n        response.data.raw_user_meta_data?.department ||\r\n        response.data.raw_user_meta_data?.dpt;\r\n      if (department) {\r\n        return department.toUpperCase();\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.warn(\"[HEATMAP] Failed to get user department:\", error);\r\n  }\r\n  // Fallback: try Supabase session\r\n  try {\r\n    const { supabase } = await import(\"../../js/config/config.js\");\r\n    const {\r\n      data: { session },\r\n    } = await supabase.auth.getSession();\r\n    const metadata =\r\n      session?.user?.raw_user_meta_data || session?.user?.user_metadata || {};\r\n    const department = metadata.department || metadata.dpt;\r\n    if (department) {\r\n      return department.toUpperCase();\r\n    }\r\n  } catch (error) {\r\n    console.warn(\"[HEATMAP] Failed to get department from session:\", error);\r\n  }\r\n  return null;\r\n}\r\n\r\n// Load departments\r\nasync function loadDepartments() {\r\n  try {\r\n    const group = document.getElementById(\"department-filter-group\");\r\n    const loading = document.getElementById(\"department-loading\");\r\n    if (loading) loading.remove();\r\n\r\n    const isLguAdmin = heatmapViz?.userRole === \"lgu-admin\";\r\n    const userDepartmentCode =\r\n      heatmapViz?.userDepartment || (await getUserDepartment());\r\n\r\n    if (isLguAdmin && userDepartmentCode) {\r\n      const notice = document.createElement(\"div\");\r\n      notice.style.cssText =\r\n        \"padding: 12px; background: #f9fafb; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px; color: #374151;\";\r\n      notice.innerHTML = `\r\n        <strong>Office Scope</strong>\r\n        <p style=\"margin: 6px 0 0 0; font-size: 12px;\">\r\n          Complaints are automatically filtered to your office\r\n          <span style=\"font-weight: 600;\">${userDepartmentCode}</span>.\r\n        </p>\r\n      `;\r\n      group.appendChild(notice);\r\n      currentFilters.department = userDepartmentCode;\r\n      return;\r\n    }\r\n\r\n    // Try using getActiveDepartments first (simpler endpoint)\r\n    let departments = [];\r\n    try {\r\n      const { getActiveDepartments } = await import(\r\n        \"../../js/utils/departmentUtils.js\"\r\n      );\r\n      departments = await getActiveDepartments();\r\n    } catch (e) {\r\n      console.warn(\r\n        \"[HEATMAP] getActiveDepartments failed, trying getDepartments:\",\r\n        e\r\n      );\r\n      // Fallback to getDepartments\r\n      const { getDepartments } = await import(\r\n        \"../../js/utils/departmentUtils.js\"\r\n      );\r\n      departments = await getDepartments();\r\n    }\r\n\r\n    // If still empty, try direct API call\r\n    if (!departments || departments.length === 0) {\r\n      try {\r\n        const response = await fetch(\"/api/departments/active\");\r\n        const result = await response.json();\r\n        if (result.success && result.data) {\r\n          departments = result.data;\r\n        }\r\n      } catch (e) {\r\n        console.error(\"[HEATMAP] Direct API call failed:\", e);\r\n      }\r\n    }\r\n\r\n    // Get user's department and sort departments to put user's office first\r\n    const resolvedUserDepartmentCode = userDepartmentCode;\r\n    if (resolvedUserDepartmentCode && departments && departments.length > 0) {\r\n      // Sort: user's department first, then others\r\n      departments.sort((a, b) => {\r\n        const aCode = (a.code || \"\").toUpperCase();\r\n        const bCode = (b.code || \"\").toUpperCase();\r\n        const aIsUserDept = aCode === resolvedUserDepartmentCode;\r\n        const bIsUserDept = bCode === resolvedUserDepartmentCode;\r\n\r\n        if (aIsUserDept && !bIsUserDept) return -1;\r\n        if (!aIsUserDept && bIsUserDept) return 1;\r\n        return 0; // Keep original order for non-matching items\r\n      });\r\n    }\r\n\r\n    if (departments && departments.length > 0) {\r\n      departments.forEach((dept) => {\r\n        const label = document.createElement(\"label\");\r\n        // Use Tailwind classes\r\n        label.className =\r\n          \"flex items-center gap-1.5 font-normal py-0.5 text-gray-700 dark:text-gray-300\";\r\n\r\n        const checkbox = document.createElement(\"input\");\r\n        checkbox.type = \"checkbox\";\r\n        checkbox.className = \"department-checkbox\";\r\n        checkbox.value = dept.code || dept.id;\r\n\r\n        // Add change listener for auto-filtering\r\n        checkbox.addEventListener(\"change\", () => {\r\n          if (window.debounceFilterUpdate && window.applyFiltersAndUpdate) {\r\n            window.debounceFilterUpdate(window.applyFiltersAndUpdate, 500);\r\n          }\r\n        });\r\n\r\n        const deptName = dept.name || `Department ${dept.code || dept.id}`;\r\n        const deptCode = dept.code ? `(${dept.code})` : \"\";\r\n        // Highlight user's department with bold text\r\n        const isUserDept =\r\n          resolvedUserDepartmentCode &&\r\n          (dept.code || \"\").toUpperCase() === resolvedUserDepartmentCode;\r\n        const text = document.createTextNode(`${deptName} ${deptCode}`);\r\n        label.appendChild(checkbox);\r\n        label.appendChild(text);\r\n        if (isUserDept) {\r\n          label.classList.remove(\r\n            \"font-normal\",\r\n            \"text-gray-700\",\r\n            \"dark:text-gray-300\"\r\n          );\r\n          label.classList.add(\"font-bold\", \"text-gray-900\", \"dark:text-white\");\r\n        }\r\n        group.appendChild(label);\r\n      });\r\n      console.log(\r\n        `[HEATMAP] Loaded ${departments.length} department(s) for filtering${\r\n          resolvedUserDepartmentCode\r\n            ? ` (user's office: ${resolvedUserDepartmentCode} at top)`\r\n            : \"\"\r\n        }`\r\n      );\r\n    } else {\r\n      const noDeptMsg = document.createElement(\"div\");\r\n      noDeptMsg.textContent = \"No departments available\";\r\n      noDeptMsg.className = \"text-gray-400 italic p-2 text-xs\";\r\n      group.appendChild(noDeptMsg);\r\n      console.warn(\"[HEATMAP] No departments loaded\");\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[HEATMAP] Failed to load departments:\", error);\r\n    const group = document.getElementById(\"department-filter-group\");\r\n    const errorMsg = document.createElement(\"div\");\r\n    errorMsg.textContent = \"Error loading departments\";\r\n    errorMsg.style.cssText = \"color: #dc3545; padding: 8px;\";\r\n    group.appendChild(errorMsg);\r\n  } finally {\r\n    // Reposition gear button after departments load (panel height might change)\r\n  }\r\n}\r\n\r\n// Update statistics display\r\nfunction updateStatistics() {\r\n  if (!heatmapViz) return;\r\n\r\n  const total = heatmapViz.complaintData ? heatmapViz.complaintData.length : 0;\r\n  const visible = heatmapViz.markerLayer\r\n    ? heatmapViz.markerLayer.getLayers().length\r\n    : 0;\r\n\r\n  document.getElementById(\"total-complaints-stat\").textContent = total;\r\n  document.getElementById(\"visible-markers-stat\").textContent = visible;\r\n\r\n  // Reposition gear button after stats update (panel height might change)\r\n}\r\n\r\n// Reset map view to original center and zoom\r\nfunction resetMapView() {\r\n  if (!map) return;\r\n\r\n  const originCenter = [6.854282, 125.318462]; // Digos City center\r\n  const originZoom = 11;\r\n\r\n  map.setView(originCenter, originZoom, { animate: true });\r\n}\r\n\r\n// Fit map to show all markers\r\n// This adjusts the map view to show all visible complaint markers\r\nfunction fitToAllMarkers() {\r\n  if (\r\n    !map ||\r\n    !heatmapViz ||\r\n    !heatmapViz.complaintData ||\r\n    heatmapViz.complaintData.length === 0\r\n  ) {\r\n    return;\r\n  }\r\n\r\n  // If only one complaint, don't zoom in too close - just center on it with a reasonable zoom\r\n  if (heatmapViz.complaintData.length === 1) {\r\n    const complaint = heatmapViz.complaintData[0];\r\n    map.setView([complaint.lat, complaint.lng], 14, { animate: false });\r\n    return;\r\n  }\r\n\r\n  const bounds = L.latLngBounds();\r\n  heatmapViz.complaintData.forEach((complaint) => {\r\n    bounds.extend([complaint.lat, complaint.lng]);\r\n  });\r\n\r\n  if (bounds.isValid()) {\r\n    // Calculate the size of the bounds\r\n    const northEast = bounds.getNorthEast();\r\n    const southWest = bounds.getSouthWest();\r\n    const latDiff = Math.abs(northEast.lat - southWest.lat);\r\n    const lngDiff = Math.abs(northEast.lng - southWest.lng);\r\n\r\n    // If bounds are too small (all complaints very close together), use minimum zoom\r\n    if (latDiff < 0.01 && lngDiff < 0.01) {\r\n      // All complaints are very close - center on them but don't zoom in too much\r\n      const center = bounds.getCenter();\r\n      map.setView([center.lat, center.lng], Math.min(map.getZoom(), 14), {\r\n        animate: false,\r\n      });\r\n    } else {\r\n      // Multiple complaints spread out - fit to bounds with padding\r\n      map.fitBounds(bounds, {\r\n        padding: [50, 50],\r\n        maxZoom: 16, // Prevent zooming in too close even if complaints are clustered\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n// Setup sidebar toggle\r\nfunction setupSidebarToggle() {\r\n  const menuToggle = document.getElementById(\"menu-toggle\");\r\n  const sidebar = document.getElementById(\"sidebar\");\r\n\r\n  if (menuToggle && sidebar) {\r\n    menuToggle.addEventListener(\"click\", () => {\r\n      sidebar.classList.toggle(\"open\");\r\n    });\r\n\r\n    // Ensure button is visible\r\n    menuToggle.style.display = \"flex\";\r\n    menuToggle.style.visibility = \"visible\";\r\n    menuToggle.style.opacity = \"1\";\r\n  } else {\r\n    console.error(\"[SIDEBAR] Menu toggle or sidebar not found!\", {\r\n      menuToggle,\r\n      sidebar,\r\n    });\r\n  }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\heatmap-leaflet-check.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\heatmap-tailwind-config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\lgu-admin-assignments.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\lgu-admin-heatmap.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\lgu-admin\\assignments.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'getCurrentUser' is defined but never used. Allowed unused vars must match /^_/u.","line":13,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":22},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":471,"column":60,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":471,"endColumn":61},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":471,"column":68,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":471,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'errorMessage' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":1152,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1152,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * LGU Admin Assignments Page\r\n * Handles viewing and managing complaint assignments for LGU admins\r\n */\r\nimport apiClient from \"../../config/apiClient.js\";\r\nimport showMessage from \"../../components/toast.js\";\r\nimport { escapeHtml } from \"../../utils/string.js\";\r\nimport {\r\n  getStatusText,\r\n  getStatusClass,\r\n  getPriorityClass,\r\n} from \"../../utils/complaint.js\";\r\nimport getCurrentUser from \"../../utils/authUtils.js\";\r\nimport { supabase } from \"../../config/config.js\";\r\n\r\nclass LguAdminAssignments {\r\n  constructor() {\r\n    this.assignments = [];\r\n    this.officers = [];\r\n    this.currentComplaintId = null;\r\n    this.selectedComplaint = null;\r\n    this.currentAssignmentFilter = \"all\"; // For client-side filtering (all, unassigned, assigned)\r\n    this.filters = {\r\n      status: \"all\",\r\n      priority: \"all\",\r\n      sub_type: \"all\",\r\n      date_start: \"\",\r\n      date_end: \"\",\r\n    };\r\n    this.currentPage = 1;\r\n    this.itemsPerPage = 10;\r\n    this.totalItems = 0;\r\n    this.stats = { unassigned: 0, urgent: 0, high: 0 };\r\n    this.uniqueSubcategories = new Set();\r\n    this.initialize();\r\n  }\r\n  async initialize() {\r\n    this.setupEventListeners();\r\n    // Show loading state initially\r\n    this.showLoadingState();\r\n    try {\r\n      // Load officers and assignments (paginated)\r\n      await this.loadOfficers();\r\n      await this.loadAssignments();\r\n      this.renderAssignments();\r\n    } catch (error) {\r\n      console.error(\"[LGU_ADMIN_ASSIGNMENTS] Initialization error:\", error);\r\n      this.hideLoadingState();\r\n      showMessage(\"error\", \"Failed to initialize assignments page\");\r\n    }\r\n  }\r\n  async loadAssignments() {\r\n    try {\r\n      const queryParams = new URLSearchParams();\r\n      if (this.filters.status !== \"all\")\r\n        queryParams.append(\"status\", this.filters.status);\r\n      if (this.filters.priority !== \"all\")\r\n        queryParams.append(\"priority\", this.filters.priority);\r\n      if (this.filters.sub_type !== \"all\")\r\n        queryParams.append(\"sub_type\", this.filters.sub_type);\r\n      if (this.filters.date_start)\r\n        queryParams.append(\"date_start\", this.filters.date_start);\r\n      if (this.filters.date_end)\r\n        queryParams.append(\"date_end\", this.filters.date_end);\r\n\r\n      // Add pagination params\r\n      queryParams.append(\"page\", this.currentPage);\r\n      queryParams.append(\"limit\", this.itemsPerPage);\r\n\r\n      // Add assignment filter (tabs)\r\n      if (this.currentAssignmentFilter) {\r\n        queryParams.append(\"assignment_filter\", this.currentAssignmentFilter);\r\n      }\r\n\r\n      const url = `/api/lgu-admin/department-assignments?${queryParams}`;\r\n\r\n      const response = await apiClient.get(url);\r\n      if (response && response.success) {\r\n        const newAssignments = response.data || [];\r\n        this.totalItems = response.pagination?.total || 0;\r\n        this.stats = response.stats || { unassigned: 0, urgent: 0, high: 0 };\r\n\r\n        // Populate dynamic subcategories from metadata if available, or accumulate from data\r\n        if (response.unique_subcategories) {\r\n          this.updateSubcategoryFilter(response.unique_subcategories);\r\n        } else {\r\n          // Fallback: extract from current page (less ideal but functional)\r\n          this.extractSubcategories(newAssignments);\r\n        }\r\n\r\n        // Append or Replace\r\n        if (this.currentPage === 1) {\r\n          this.assignments = newAssignments;\r\n        } else {\r\n          this.assignments = [...this.assignments, ...newAssignments];\r\n        }\r\n      } else {\r\n        throw new Error(response?.error || \"Failed to load assignments\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[LGU_ADMIN_ASSIGNMENTS] Load assignments error:\", error);\r\n      // Only hide loading state if it was blocking valid content\r\n      if (this.currentPage === 1) {\r\n        this.hideLoadingState();\r\n        this.assignments = [];\r\n        this.totalItems = 0;\r\n        showMessage(\"error\", \"Failed to load assignments\");\r\n      } else {\r\n        // Partial load failure\r\n        showMessage(\"error\", \"Failed to load more assignments\");\r\n      }\r\n    }\r\n  }\r\n\r\n  extractSubcategories(assignments) {\r\n    let hasNew = false;\r\n    assignments.forEach((a) => {\r\n      // Assuming 'subcategory' or 'complaint_type' field exists\r\n      const subtype = a.subcategory || a.complaint_type;\r\n      if (subtype && !this.uniqueSubcategories.has(subtype)) {\r\n        this.uniqueSubcategories.add(subtype);\r\n        hasNew = true;\r\n      }\r\n    });\r\n\r\n    if (hasNew) {\r\n      this.updateSubcategoryFilter(Array.from(this.uniqueSubcategories));\r\n    }\r\n  }\r\n\r\n  updateSubcategoryFilter(subtypes) {\r\n    const select = document.getElementById(\"subtype-filter\");\r\n    if (!select) return;\r\n\r\n    // Keep \"All\" option\r\n    const currentVal = select.value;\r\n\r\n    // Clear current options except \"All\"\r\n    while (select.options.length > 1) {\r\n      select.remove(1);\r\n    }\r\n\r\n    subtypes.sort().forEach((subtype) => {\r\n      const option = document.createElement(\"option\");\r\n      option.value = subtype;\r\n      option.textContent = subtype;\r\n      select.appendChild(option);\r\n    });\r\n\r\n    // Restore selection if valid\r\n    if (subtypes.includes(currentVal)) {\r\n      select.value = currentVal;\r\n    }\r\n  }\r\n\r\n  async loadOfficers() {\r\n    try {\r\n      const response = await apiClient.get(\r\n        \"/api/lgu-admin/department-officers\"\r\n      );\r\n      if (response && response.success) {\r\n        this.officers = response.data || [];\r\n      } else {\r\n        throw new Error(response?.error || \"Failed to load officers\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[LGU_ADMIN_ASSIGNMENTS] Load officers error:\", error);\r\n      this.hideLoadingState();\r\n      showMessage(\"error\", \"Failed to load officers\");\r\n      this.officers = [];\r\n    }\r\n  }\r\n  showLoadingState() {\r\n    const loadingState = document.getElementById(\"loading-state\");\r\n    const assignmentsList = document.getElementById(\"assignments-list\");\r\n    const assignmentsTable = document.getElementById(\r\n      \"assignments-table-container\"\r\n    );\r\n    const tableBody = document.getElementById(\"assignments-table-body\");\r\n    const emptyState = document.getElementById(\"empty-state\");\r\n\r\n    if (loadingState) loadingState.style.display = \"block\";\r\n    if (assignmentsList) assignmentsList.style.display = \"none\";\r\n    if (assignmentsTable) assignmentsTable.classList.add(\"hidden\");\r\n    if (tableBody) tableBody.innerHTML = \"\"; // Clear potential duplicate spinner\r\n    if (emptyState) emptyState.style.display = \"none\";\r\n  }\r\n  hideLoadingState() {\r\n    const loadingState = document.getElementById(\"loading-state\");\r\n    if (loadingState) loadingState.style.display = \"none\";\r\n  }\r\n  setupEventListeners() {\r\n    // Event delegation for complaint items - Navigate to complaint details (like coordinator review queue)\r\n    const assignmentsList = document.getElementById(\"assignments-list\");\r\n    if (assignmentsList) {\r\n      assignmentsList.addEventListener(\"click\", (event) => {\r\n        // Don't navigate if clicking on buttons\r\n        if (\r\n          event.target.tagName === \"BUTTON\" ||\r\n          event.target.closest(\"button\")\r\n        ) {\r\n          return;\r\n        }\r\n        const item = event.target.closest(\".assignment-card\");\r\n        if (item) {\r\n          const { complaintId } = item.dataset;\r\n          if (complaintId) {\r\n            // Navigate to complaint details page, similar to coordinator review queue\r\n            window.location.href = `/complaint-details/${complaintId}`;\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    // Filter button toggles (All, Unassigned, Assigned)\r\n    document.querySelectorAll(\".filter-btn\").forEach((btn) => {\r\n      btn.addEventListener(\"click\", (e) => {\r\n        const target = e.target.closest(\".filter-btn\");\r\n        if (!target) return;\r\n\r\n        // Remove active class from all filter buttons\r\n        document\r\n          .querySelectorAll(\".filter-btn\")\r\n          .forEach((b) => b.classList.remove(\"active\"));\r\n\r\n        // Add active class to clicked button\r\n        target.classList.add(\"active\");\r\n\r\n        // Get filter value\r\n        const filterValue = target.dataset.filter;\r\n\r\n        // Apply client-side filter for assignment status\r\n        this.currentAssignmentFilter = filterValue;\r\n\r\n        // Reload data from server (reset to page 1)\r\n        this.changePage(1);\r\n      });\r\n    });\r\n\r\n    // Filter controls\r\n    const statusFilter = document.getElementById(\"status-filter\");\r\n    const priorityFilter = document.getElementById(\"priority-filter\");\r\n    const subTypeFilter =\r\n      document.getElementById(\"subtype-filter\") ||\r\n      document.getElementById(\"sub-type-filter\");\r\n    const dateStart = document.getElementById(\"date-start\");\r\n    const dateEnd = document.getElementById(\"date-end\");\r\n    const refreshBtn = document.getElementById(\"refresh-btn\");\r\n\r\n    if (statusFilter) {\r\n      statusFilter.addEventListener(\"change\", (e) => {\r\n        this.filters.status = e.target.value;\r\n        this.applyFilters();\r\n      });\r\n    }\r\n    if (priorityFilter) {\r\n      priorityFilter.addEventListener(\"change\", (e) => {\r\n        this.filters.priority = e.target.value;\r\n        this.applyFilters();\r\n      });\r\n    }\r\n    if (subTypeFilter) {\r\n      subTypeFilter.addEventListener(\"change\", (e) => {\r\n        this.filters.sub_type = e.target.value;\r\n        this.applyFilters();\r\n      });\r\n    }\r\n    if (dateStart) {\r\n      dateStart.addEventListener(\"change\", (e) => {\r\n        this.filters.date_start = e.target.value;\r\n        this.applyFilters();\r\n      });\r\n    }\r\n    if (dateEnd) {\r\n      dateEnd.addEventListener(\"change\", (e) => {\r\n        this.filters.date_end = e.target.value;\r\n        this.applyFilters();\r\n      });\r\n    }\r\n    if (refreshBtn) {\r\n      refreshBtn.addEventListener(\"click\", () => {\r\n        this.refreshData();\r\n      });\r\n    }\r\n    // Assignment modal\r\n    this.setupAssignmentModal();\r\n    // Assignment button\r\n    const assignButton = document.getElementById(\"assign-button\");\r\n    if (assignButton !== null) {\r\n      assignButton.addEventListener(\"click\", () => {\r\n        if (!this.selectedComplaint) {\r\n          showMessage(\"error\", \"Please select a complaint first\");\r\n          return;\r\n        }\r\n        this.handleAssignment();\r\n      });\r\n    }\r\n  }\r\n  setupAssignmentModal() {\r\n    const assignmentModal = document.getElementById(\"assignment-modal\");\r\n    const assignmentForm = document.getElementById(\"assignment-form\");\r\n    const closeModal = document.getElementById(\"close-assignment-modal\");\r\n    const cancelBtn = document.getElementById(\"cancel-assignment\");\r\n    if (closeModal) {\r\n      closeModal.addEventListener(\"click\", () => {\r\n        this.closeAssignmentModal();\r\n      });\r\n    }\r\n    if (cancelBtn) {\r\n      cancelBtn.addEventListener(\"click\", () => {\r\n        this.closeAssignmentModal();\r\n      });\r\n    }\r\n    if (assignmentForm) {\r\n      assignmentForm.addEventListener(\"submit\", (e) => {\r\n        e.preventDefault();\r\n        this.handleAssignment();\r\n      });\r\n    }\r\n    // Close modal when clicking outside\r\n    if (assignmentModal) {\r\n      assignmentModal.addEventListener(\"click\", (e) => {\r\n        if (e.target === assignmentModal) {\r\n          this.closeAssignmentModal();\r\n        }\r\n      });\r\n    }\r\n  }\r\n  async applyFilters() {\r\n    await this.loadAssignments();\r\n    this.renderAssignments();\r\n  }\r\n  async refreshData() {\r\n    showMessage(\"info\", \"Refreshing assignments...\");\r\n    await this.loadAssignments();\r\n    await this.loadOfficers();\r\n    this.renderAssignments();\r\n    showMessage(\"success\", \"Assignments refreshed\");\r\n  }\r\n  renderAssignments() {\r\n    // Hide loading state\r\n    const loadingState = document.getElementById(\"loading-state\");\r\n    if (loadingState) {\r\n      loadingState.style.display = \"none\";\r\n    }\r\n\r\n    // Get table elements\r\n    const tableContainer = document.getElementById(\r\n      \"assignments-table-container\"\r\n    );\r\n    const tableBody = document.getElementById(\"assignments-table-body\");\r\n    const _paginationControls = document.getElementById(\"pagination-controls\");\r\n\r\n    if (tableContainer) {\r\n      tableContainer.classList.remove(\"hidden\");\r\n    }\r\n\r\n    // Legacy support (if elements missing)\r\n    const assignmentsList = document.getElementById(\"assignments-list\");\r\n\r\n    if (!tableContainer || !tableBody) {\r\n      // Fallback or error if table not found (during transition)\r\n      if (assignmentsList) {\r\n        assignmentsList.innerHTML =\r\n          '<div class=\"empty-state\">Error: Table not found. Please refresh.</div>';\r\n        assignmentsList.style.display = \"block\";\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Get data directly (already paginated by server)\r\n    const paginatedData = this.assignments;\r\n    const {totalItems} = this;\r\n\r\n    if (totalItems === 0 && paginatedData.length === 0) {\r\n      tableBody.innerHTML = `\r\n        <tr>\r\n          <td colspan=\"7\" class=\"text-center py-12\">\r\n            <div class=\"flex flex-col items-center gap-4\">\r\n                <div class=\"text-4xl\">📋</div>\r\n                <div class=\"text-gray-600 dark:text-gray-300 font-semibold\">No assignments found</div>\r\n                <div class=\"text-gray-500 dark:text-gray-400 text-sm\">Try adjusting your filters</div>\r\n            </div>\r\n          </td>\r\n        </tr>\r\n      `;\r\n      tableContainer.style.display = \"block\";\r\n      this.updatePaginationControls();\r\n      this.updateStats();\r\n      return;\r\n    }\r\n\r\n    // Render rows\r\n    tableBody.innerHTML = paginatedData\r\n      .map((assignment) => this.renderAssignmentRow(assignment))\r\n      .join(\"\");\r\n    tableContainer.style.display = \"block\";\r\n\r\n    // Update controls\r\n    this.updatePaginationControls();\r\n\r\n    // Update stats\r\n    this.updateStats();\r\n\r\n    // Add event listeners\r\n    this.setupAssignmentActionListeners();\r\n  }\r\n\r\n  getPaginatedData() {\r\n    // Deprecated for slicing, just passes thru data\r\n    return { paginatedData: this.assignments, totalItems: this.totalItems };\r\n  }\r\n\r\n  async loadMore() {\r\n    const btn = document.getElementById(\"load-more-btn\");\r\n    const spinner = document.getElementById(\"load-more-spinner\");\r\n    if (btn) btn.disabled = true;\r\n    if (spinner) spinner.style.display = \"inline-block\";\r\n\r\n    this.currentPage++;\r\n    await this.loadAssignments();\r\n    this.renderAssignments();\r\n\r\n    if (btn) btn.disabled = false;\r\n    if (spinner) spinner.style.display = \"none\";\r\n  }\r\n\r\n  setupInfiniteScroll() {\r\n    const loadMoreBtn = document.getElementById(\"load-more-btn\");\r\n    if (!loadMoreBtn) return;\r\n\r\n    // Disconnect old observer if exists\r\n    if (this.observer) {\r\n      this.observer.disconnect();\r\n    }\r\n\r\n    // Only set up observer if there are more items to load\r\n    if (this.assignments.length >= this.totalItems) return;\r\n\r\n    const options = {\r\n      root: null, // viewport\r\n      rootMargin: \"100px\", // trigger 100px before end\r\n      threshold: 0.1,\r\n    };\r\n\r\n    this.observer = new IntersectionObserver((entries) => {\r\n      entries.forEach((entry) => {\r\n        if (entry.isIntersecting && !loadMoreBtn.disabled) {\r\n          this.loadMore();\r\n        }\r\n      });\r\n    }, options);\r\n\r\n    this.observer.observe(loadMoreBtn);\r\n  }\r\n\r\n  updatePaginationControls() {\r\n    const container = document.getElementById(\"pagination-controls\");\r\n    if (!container) return;\r\n\r\n    // Show container if we have items or filters are active (to show 0 results)\r\n    container.classList.remove(\"hidden\");\r\n    container.style.display = \"flex\";\r\n\r\n    const {totalItems} = this;\r\n    const {currentPage} = this;\r\n    const limit = this.itemsPerPage;\r\n    const totalPages = Math.ceil(totalItems / limit);\r\n\r\n    // Calculate start and end\r\n    const start = totalItems === 0 ? 0 : (currentPage - 1) * limit + 1;\r\n    const end = Math.min(currentPage * limit, totalItems);\r\n\r\n    // Update text\r\n    const pageStartEl = document.getElementById(\"page-start\");\r\n    const pageEndEl = document.getElementById(\"page-end\");\r\n    const totalItemsEl = document.getElementById(\"total-items\");\r\n    const currentPageDisplay = document.getElementById(\"current-page-display\");\r\n\r\n    if (pageStartEl) pageStartEl.textContent = start;\r\n    if (pageEndEl) pageEndEl.textContent = end;\r\n    if (totalItemsEl) totalItemsEl.textContent = totalItems;\r\n    if (currentPageDisplay)\r\n      currentPageDisplay.textContent = `Page ${currentPage} of ${\r\n        totalPages || 1\r\n      }`;\r\n\r\n    // Update buttons\r\n    const prevBtn = document.getElementById(\"prev-btn\");\r\n    const nextBtn = document.getElementById(\"next-btn\");\r\n    const prevBtnMobile = document.getElementById(\"prev-btn-mobile\");\r\n    const nextBtnMobile = document.getElementById(\"next-btn-mobile\");\r\n\r\n    this.setupPaginationButton(prevBtn, currentPage > 1, currentPage - 1);\r\n    this.setupPaginationButton(\r\n      nextBtn,\r\n      currentPage < totalPages,\r\n      currentPage + 1\r\n    );\r\n    this.setupPaginationButton(prevBtnMobile, currentPage > 1, currentPage - 1);\r\n    this.setupPaginationButton(\r\n      nextBtnMobile,\r\n      currentPage < totalPages,\r\n      currentPage + 1\r\n    );\r\n  }\r\n\r\n  setupPaginationButton(btn, isEnabled, targetPage) {\r\n    if (!btn) return;\r\n\r\n    btn.disabled = !isEnabled;\r\n    if (isEnabled) {\r\n      // Remove old listeners to prevent duplicates\r\n      const newBtn = btn.cloneNode(true);\r\n      if (btn.parentNode) {\r\n        btn.parentNode.replaceChild(newBtn, btn);\r\n        newBtn.onclick = () => this.changePage(targetPage);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Legacy Loop/Load More - Removed\r\n  updateLoadMoreControls() {}\r\n\r\n  async changePage(newPage) {\r\n    if (newPage < 1) return;\r\n    this.currentPage = newPage;\r\n    this.assignments = []; // Clear current list\r\n\r\n    // Show spinner in table\r\n    const tableBody = document.getElementById(\"assignments-table-body\");\r\n    if (tableBody) {\r\n      tableBody.innerHTML = `<tr><td colspan=\"7\" class=\"text-center py-8\"><div class=\"loading-spinner\"></div></td></tr>`;\r\n    }\r\n\r\n    await this.loadAssignments();\r\n    this.renderAssignments();\r\n  }\r\n\r\n  updateStats() {\r\n    // Use stats from server\r\n    const { unassigned, urgent, high } = this.stats;\r\n\r\n    // Update stat elements\r\n    const unassignedEl = document.getElementById(\"stat-unassigned\");\r\n    const urgentEl = document.getElementById(\"stat-urgent\");\r\n    const highEl = document.getElementById(\"stat-high\");\r\n    if (unassignedEl) unassignedEl.textContent = unassigned;\r\n    if (urgentEl) urgentEl.textContent = urgent;\r\n    if (highEl) highEl.textContent = high;\r\n  }\r\n\r\n  renderAssignmentRow(assignment) {\r\n    const statusClass = getStatusClass(assignment.status);\r\n    const priorityClass = getPriorityClass(assignment.priority);\r\n    const _dateDisplay = assignment.assigned_at\r\n      ? new Date(assignment.assigned_at).toLocaleDateString()\r\n      : new Date(assignment.submitted_at).toLocaleDateString();\r\n\r\n    const isCompleted = [\"completed\", \"cancelled\"].includes(\r\n      assignment.status?.toLowerCase()\r\n    );\r\n    const disabledAttr = isCompleted ? \"disabled\" : \"\";\r\n    const disabledClass = isCompleted ? \"opacity-50 cursor-not-allowed\" : \"\";\r\n\r\n    return `\r\n      <tr class=\"border-b border-gray-100 dark:border-gray-700 transition-colors duration-200 hover:bg-gray-50 dark:hover:bg-gray-700/50\">\r\n        <td class=\"p-4 text-sm text-gray-500 dark:text-gray-400\">\r\n          #${\r\n  assignment.display_id ||\r\n            (assignment.complaint_id\r\n              ? assignment.complaint_id.slice(-8)\r\n              : \"N/A\")\r\n}\r\n        </td>\r\n        <td class=\"p-4\">\r\n          <div class=\"font-semibold text-gray-800 dark:text-gray-200 mb-1\">${escapeHtml(\r\n    assignment.title || \"Untitled\"\r\n  )}</div>\r\n          <div class=\"text-gray-500 dark:text-gray-400 text-xs max-w-[250px] truncate\">\r\n            ${escapeHtml(assignment.description || \"No description\")}\r\n          </div>\r\n        </td>\r\n        <td class=\"p-4\">\r\n           <div class=\"text-gray-700 dark:text-gray-300 text-sm\">${escapeHtml(\r\n    assignment.citizen_name || \"Unknown\"\r\n  )}</div>\r\n           <div class=\"text-gray-400 dark:text-gray-500 text-xs\">${escapeHtml(\r\n    assignment.location_text || \"No location\"\r\n  )}</div>\r\n        </td>\r\n        <td class=\"p-4\">\r\n           ${\r\n  assignment.officer_name\r\n    ? `<div class=\"flex items-center gap-2\">\r\n                    <div class=\"w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 flex items-center justify-center text-xs font-bold ring-2 ring-white dark:ring-gray-700\">\r\n                        ${assignment.officer_name.charAt(0)}\r\n                    </div>\r\n                    <div class=\"text-sm text-gray-700 dark:text-gray-300\">${escapeHtml(\r\n    assignment.officer_name\r\n  )}</div>\r\n                  </div>`\r\n    : '<span class=\"text-gray-400 dark:text-gray-500 italic text-sm\">Unassigned</span>'\r\n}\r\n        </td>\r\n        <td class=\"p-4\">\r\n          <span class=\"px-3 py-1 rounded-full text-xs font-semibold uppercase ${priorityClass}\">${\r\n  assignment.priority\r\n}</span>\r\n        </td>\r\n        <td class=\"p-4\">\r\n          <div class=\"flex flex-col items-start gap-1\">\r\n            <span class=\"px-3 py-1 rounded-full text-xs font-semibold ${statusClass}\">${getStatusText(\r\n  assignment.status\r\n)}</span>\r\n            ${\r\n  assignment.has_other_assignments && !assignment.assigned_to\r\n    ? `<span class=\"text-[10px] text-orange-600 dark:text-orange-400 font-medium bg-orange-50 dark:bg-orange-900/20 px-1.5 py-0.5 rounded border border-orange-100 dark:border-orange-800 whitespace-nowrap\">\r\n                     Assigned by others\r\n                   </span>`\r\n    : \"\"\r\n}\r\n          </div>\r\n        </td>\r\n        <td class=\"p-4 text-center\">\r\n          ${\r\n  assignment.status === \"unassigned\" || !assignment.assigned_to\r\n    ? `<button class=\"btn btn-primary btn-sm assign-btn ${disabledClass}\" data-complaint-id=\"${assignment.complaint_id}\" ${disabledAttr}>\r\n                   <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-3.5 h-3.5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 4v16m8-8H4\" /></svg>\r\n                   Assign\r\n                 </button>`\r\n    : `<button class=\"btn btn-secondary btn-sm reassign-btn ${disabledClass}\" data-complaint-id=\"${assignment.complaint_id}\" ${disabledAttr}>\r\n                   <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-3.5 h-3.5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z\" /></svg>\r\n                   Manage\r\n                 </button>`\r\n}\r\n        </td>\r\n      </tr>\r\n    `;\r\n  }\r\n\r\n  setupAssignmentActionListeners() {\r\n    // View Details buttons\r\n    document.querySelectorAll(\".view-details-btn\").forEach((btn) => {\r\n      btn.addEventListener(\"click\", (e) => {\r\n        e.stopPropagation();\r\n        const { complaintId } = e.target.dataset;\r\n        window.location.href = `/complaint-details/${complaintId}`;\r\n      });\r\n    });\r\n    // Assign buttons\r\n    document.querySelectorAll(\".assign-btn\").forEach((btn) => {\r\n      btn.addEventListener(\"click\", (e) => {\r\n        e.stopPropagation();\r\n        const { complaintId } = e.target.dataset;\r\n        this.openAssignmentModal(complaintId);\r\n      });\r\n    });\r\n    // Reassign buttons\r\n    document.querySelectorAll(\".reassign-btn\").forEach((btn) => {\r\n      btn.addEventListener(\"click\", (e) => {\r\n        e.stopPropagation();\r\n        const { complaintId } = e.target.dataset;\r\n        this.openAssignmentModal(complaintId, true);\r\n      });\r\n    });\r\n  }\r\n\r\n  openAssignmentModal(complaintId, isReassign = false) {\r\n    const modal = document.getElementById(\"assignment-modal\");\r\n    const form = document.getElementById(\"assignment-form\");\r\n    const modalTitle = modal?.querySelector(\"h2\");\r\n    const officerCheckboxes = document.getElementById(\"officer-checkboxes\");\r\n    const complaintSummary = document.getElementById(\"complaint-summary\");\r\n    if (!modal || !form || !officerCheckboxes) {\r\n      console.error(\"[LGU_ADMIN_ASSIGNMENTS] Modal elements not found:\", {\r\n        modal: Boolean(modal),\r\n        form: Boolean(form),\r\n        officerCheckboxes: Boolean(officerCheckboxes),\r\n      });\r\n      return;\r\n    }\r\n    // Set modal title\r\n    if (modalTitle) {\r\n      modalTitle.textContent = isReassign\r\n        ? \"Reassign Complaint\"\r\n        : \"Assign to Officer\";\r\n    }\r\n    // Set current complaint ID\r\n    this.currentComplaintId = complaintId;\r\n    // Find the complaint data\r\n    const complaint = this.assignments.find(\r\n      (a) => a.complaint_id === complaintId\r\n    );\r\n    if (complaint && complaintSummary) {\r\n      complaintSummary.dataset.complaintId = complaintId;\r\n      complaintSummary.innerHTML = `\r\n        <div class=\"complaint-summary-title font-semibold text-gray-900 dark:text-white mb-2\">${escapeHtml(\r\n    complaint.title || \"Untitled Complaint\"\r\n  )}</div>\r\n        <div class=\"complaint-summary-detail text-sm text-gray-600 dark:text-gray-300 mb-1\"><strong>ID:</strong> #${complaint.complaint_id.slice(\r\n    -8\r\n  )}</div>\r\n        <div class=\"complaint-summary-detail text-sm text-gray-600 dark:text-gray-300 mb-1\"><strong>Description:</strong> ${escapeHtml(\r\n    complaint.description || \"No description\"\r\n  )}</div>\r\n        <div class=\"complaint-summary-detail text-sm text-gray-600 dark:text-gray-300 mb-1\"><strong>Location:</strong> ${escapeHtml(\r\n    complaint.location_text || \"Not specified\"\r\n  )}</div>\r\n        <div class=\"complaint-summary-detail text-sm text-gray-600 dark:text-gray-300 mb-1\"><strong>Citizen:</strong> ${escapeHtml(\r\n    complaint.citizen_name || \"Unknown\"\r\n  )}</div>\r\n      `;\r\n    }\r\n    // Populate officer checkboxes\r\n    // officerCheckboxes already declared above\r\n    if (officerCheckboxes) {\r\n      officerCheckboxes.innerHTML = \"\";\r\n      if (this.officers.length === 0) {\r\n        officerCheckboxes.innerHTML =\r\n          '<div class=\"no-officers text-center text-gray-400 dark:text-gray-500 italic p-4\">No officers available</div>';\r\n      } else {\r\n        this.officers.forEach((officer, _index) => {\r\n          const checkboxItem = document.createElement(\"div\");\r\n          checkboxItem.className =\r\n            \"officer-checkbox-item flex items-center p-2 rounded transition-colors hover:bg-gray-100 dark:hover:bg-gray-700/50 cursor-pointer\";\r\n          checkboxItem.innerHTML = `\r\n            <input type=\"checkbox\" id=\"officer-${officer.id}\" value=\"${\r\n  officer.id\r\n}\" name=\"officers\" class=\"mr-3 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600\">\r\n            <label for=\"officer-${\r\n  officer.id\r\n}\" class=\"flex-1 cursor-pointer text-sm font-medium text-gray-900 dark:text-gray-300\">\r\n              <div class=\"officer-info flex flex-col gap-1\">\r\n                <div class=\"officer-name font-medium text-gray-800 dark:text-gray-200\">${escapeHtml(\r\n    officer.name\r\n  )}</div>\r\n                <div class=\"officer-details text-xs text-gray-500 dark:text-gray-400\">${escapeHtml(\r\n    officer.email\r\n  )} • ${officer.employee_id || \"No ID\"}</div>\r\n              </div>\r\n            </label>\r\n          `;\r\n          officerCheckboxes.appendChild(checkboxItem);\r\n        });\r\n      }\r\n    }\r\n    // Show modal\r\n    // Show modal\r\n    modal.classList.remove(\"hidden\");\r\n    modal.classList.add(\"flex\");\r\n    modal.style.display = \"\"; // cleared\r\n    modal.style.visibility = \"\";\r\n    modal.style.opacity = \"\";\r\n    modal.style.zIndex = \"\";\r\n    document.body.style.overflow = \"hidden\";\r\n  }\r\n  closeAssignmentModal() {\r\n    const modal = document.getElementById(\"assignment-modal\");\r\n    if (modal) {\r\n      modal.classList.add(\"hidden\");\r\n      modal.classList.remove(\"flex\");\r\n      modal.style.display = \"\";\r\n      document.body.style.overflow = \"\";\r\n    }\r\n  }\r\n  getSelectedOfficers() {\r\n    const checkboxes = document.querySelectorAll(\r\n      '#officer-checkboxes input[type=\"checkbox\"]:checked'\r\n    );\r\n    const selectedIds = Array.from(checkboxes).map(\r\n      (checkbox) => checkbox.value\r\n    );\r\n    return selectedIds;\r\n  }\r\n  openComplaintDetailsPanel(complaintId) {\r\n    // Find the complaint data\r\n    const complaint = this.assignments.find(\r\n      (a) => a.complaint_id === complaintId\r\n    );\r\n    if (!complaint) {\r\n      console.error(\r\n        \"[LGU_ADMIN_ASSIGNMENTS] Complaint not found:\",\r\n        complaintId\r\n      );\r\n      showMessage(\"error\", \"Complaint not found\");\r\n      return;\r\n    }\r\n    // Create details panel if it doesn't exist\r\n    let panel = document.getElementById(\"complaint-details-panel\");\r\n    if (!panel) {\r\n      panel = document.createElement(\"div\");\r\n      panel.id = \"complaint-details-panel\";\r\n      panel.className = \"complaint-details-panel\";\r\n      panel.innerHTML = `\r\n        <div class=\"details-panel-header\">\r\n          <h3>Complaint Details</h3>\r\n          <button class=\"close-details-panel\" id=\"close-details-panel\">&times;</button>\r\n        </div>\r\n        <div class=\"details-panel-content\" id=\"complaint-details-content\">\r\n          <!-- Content will be populated here -->\r\n        </div>\r\n        <div class=\"details-panel-footer\" id=\"complaint-details-footer\">\r\n          <!-- Action buttons will be populated here -->\r\n        </div>\r\n      `;\r\n      document.body.appendChild(panel);\r\n      // Add event listeners\r\n      document\r\n        .getElementById(\"close-details-panel\")\r\n        .addEventListener(\"click\", () => {\r\n          this.closeComplaintDetailsPanel();\r\n        });\r\n    }\r\n    // Populate panel content\r\n    const content = document.getElementById(\"complaint-details-content\");\r\n    const footer = document.getElementById(\"complaint-details-footer\");\r\n    content.innerHTML = this.generateComplaintDetailsHTML(complaint);\r\n    footer.innerHTML = this.generateComplaintDetailsFooter(complaint);\r\n    // Add event listeners for action buttons\r\n    const assignBtn = document.getElementById(\"assign-from-details\");\r\n    if (assignBtn) {\r\n      assignBtn.addEventListener(\"click\", () => {\r\n        this.closeComplaintDetailsPanel();\r\n        this.openAssignmentModal(complaintId);\r\n      });\r\n    }\r\n    // Show panel\r\n    panel.classList.add(\"active\");\r\n    document.body.classList.add(\"details-panel-open\");\r\n    // Load evidence after a short delay to ensure the panel is visible\r\n    setTimeout(() => {\r\n      this.loadComplaintEvidence(complaintId);\r\n    }, 100);\r\n  }\r\n  generateComplaintDetailsHTML(complaint) {\r\n    const submittedDate = new Date(complaint.submitted_at).toLocaleString();\r\n    const priorityClass = getPriorityClass(complaint.priority);\r\n    return `\r\n      <div class=\"complaint-details\">\r\n        <!-- Header Section -->\r\n        <div class=\"details-header\">\r\n          <div class=\"complaint-title-section\">\r\n            <h4>${escapeHtml(complaint.title || \"Untitled Complaint\")}</h4>\r\n            <div class=\"complaint-meta\">\r\n              <span class=\"complaint-id\">ID: #${complaint.complaint_id.slice(\r\n    -8\r\n  )}</span>\r\n              <span class=\"submission-date\">Submitted: ${submittedDate}</span>\r\n            </div>\r\n          </div>\r\n          <div class=\"complaint-status\">\r\n            <span class=\"status-badge ${getStatusClass(\r\n    complaint.status\r\n  )}\">${getStatusText(complaint.status)}</span>\r\n            <span class=\"priority-badge ${priorityClass}\">${\r\n  complaint.priority\r\n}</span>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Main Content Sections -->\r\n        <div class=\"details-sections\">\r\n          <!-- Description Section -->\r\n          <div class=\"details-section\">\r\n            <div class=\"section-header\">\r\n              <h5>📝 Description</h5>\r\n            </div>\r\n            <div class=\"section-content\">\r\n              <p>${escapeHtml(\r\n    complaint.description || \"No description provided\"\r\n  )}</p>\r\n            </div>\r\n          </div>\r\n\r\n          <!-- Location Section -->\r\n          <div class=\"details-section\">\r\n            <div class=\"section-header\">\r\n              <h5>📍 Location</h5>\r\n            </div>\r\n            <div class=\"section-content\">\r\n              <p>${escapeHtml(\r\n    complaint.location_text || \"Location not specified\"\r\n  )}</p>\r\n              ${\r\n  complaint.latitude && complaint.longitude\r\n    ? `\r\n                <div class=\"map-container\">\r\n                  <div id=\"complaint-map-${complaint.complaint_id}\" class=\"complaint-map\"></div>\r\n                </div>\r\n              `\r\n    : \"\"\r\n}\r\n            </div>\r\n          </div>\r\n\r\n          <!-- Complainant Section -->\r\n          <div class=\"details-section\">\r\n            <div class=\"section-header\">\r\n              <h5>👤 Complainant</h5>\r\n            </div>\r\n            <div class=\"section-content\">\r\n              <div class=\"complainant-info\">\r\n                <p><strong>Name:</strong> ${escapeHtml(\r\n    complaint.citizen_name || \"Unknown\"\r\n  )}</p>\r\n                ${\r\n  complaint.citizen_email\r\n    ? `<p><strong>Email:</strong> ${escapeHtml(\r\n      complaint.citizen_email\r\n    )}</p>`\r\n    : \"\"\r\n}\r\n                ${\r\n  complaint.citizen_mobile\r\n    ? `<p><strong>Mobile:</strong> ${escapeHtml(\r\n      complaint.citizen_mobile\r\n    )}</p>`\r\n    : \"\"\r\n}\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <!-- Evidence Section -->\r\n          <div class=\"details-section\">\r\n            <div class=\"section-header\">\r\n              <h5>📎 Evidence</h5>\r\n            </div>\r\n            <div class=\"section-content\">\r\n              <div class=\"evidence-container\" id=\"evidence-container-${\r\n  complaint.complaint_id\r\n}\">\r\n                <div class=\"evidence-loading\">Loading evidence...</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <!-- Assignment Status Section -->\r\n          <div class=\"details-section\">\r\n            <div class=\"section-header\">\r\n              <h5>📋 Assignment Status</h5>\r\n            </div>\r\n            <div class=\"section-content\">\r\n              <div class=\"status-info\">\r\n                <div class=\"status-item\">\r\n                  <span class=\"status-label\">Status:</span>\r\n                  <span class=\"status-value ${\r\n  complaint.status === \"unassigned\"\r\n    ? \"unassigned\"\r\n    : \"assigned\"\r\n}\">\r\n                    ${\r\n  complaint.status === \"unassigned\"\r\n    ? \"⏳ Unassigned\"\r\n    : \"✅ Assigned\"\r\n}\r\n                  </span>\r\n                </div>\r\n                ${\r\n  complaint.officer_name\r\n    ? `\r\n                  <div class=\"status-item\">\r\n                    <span class=\"status-label\">Assigned to:</span>\r\n                    <span class=\"status-value\">${escapeHtml(\r\n    complaint.officer_name\r\n  )}</span>\r\n                  </div>\r\n                `\r\n    : \"\"\r\n}\r\n                ${\r\n  complaint.assigned_at\r\n    ? `\r\n                  <div class=\"status-item\">\r\n                    <span class=\"status-label\">Assigned:</span>\r\n                    <span class=\"status-value\">${new Date(\r\n    complaint.assigned_at\r\n  ).toLocaleString()}</span>\r\n                  </div>\r\n                `\r\n    : \"\"\r\n}\r\n                ${\r\n  complaint.deadline\r\n    ? `\r\n                  <div class=\"status-item\">\r\n                    <span class=\"status-label\">Deadline:</span>\r\n                    <span class=\"status-value deadline\">${new Date(\r\n    complaint.deadline\r\n  ).toLocaleString()}</span>\r\n                  </div>\r\n                `\r\n    : \"\"\r\n}\r\n              </div>\r\n            </div>\r\n          </div>\r\n          ${\r\n  complaint.notes\r\n    ? `\r\n            <!-- Notes Section -->\r\n            <div class=\"details-section\">\r\n              <div class=\"section-header\">\r\n                <h5>📝 Notes</h5>\r\n              </div>\r\n              <div class=\"section-content\">\r\n                <p>${escapeHtml(complaint.notes)}</p>\r\n              </div>\r\n            </div>\r\n          `\r\n    : \"\"\r\n}\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  generateComplaintDetailsFooter(complaint) {\r\n    return `\r\n      <div class=\"flex gap-2 mt-4 pt-4 border-t border-gray-100 dark:border-gray-700 justify-end\">\r\n        <button type=\"button\" class=\"px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors font-medium text-sm\" id=\"close-details-panel\">Close</button>\r\n        ${\r\n  complaint.status === \"unassigned\"\r\n    ? `\r\n          <button type=\"button\" class=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors font-medium text-sm shadow-sm\" id=\"assign-from-details\">\r\n            Assign to Officer\r\n          </button>\r\n        `\r\n    : `\r\n          <button type=\"button\" class=\"px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors font-medium text-sm\" id=\"view-assignment\">\r\n            View Assignment\r\n          </button>\r\n          <button type=\"button\" class=\"px-4 py-2 border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors font-medium text-sm ml-2\" id=\"reassign-from-details\">\r\n            Reassign\r\n          </button>\r\n        `\r\n}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  async loadComplaintEvidence(complaintId) {\r\n    try {\r\n      const evidenceContainer = document.getElementById(\r\n        `evidence-container-${complaintId}`\r\n      );\r\n      if (!evidenceContainer) {\r\n        console.error(\r\n          \"[LGU_ADMIN_ASSIGNMENTS] Evidence container not found for complaint:\",\r\n          complaintId\r\n        );\r\n        return;\r\n      }\r\n      // Show loading state\r\n      evidenceContainer.innerHTML = `\r\n        <div class=\"evidence-loading\">\r\n          <div class=\"loading-spinner\"></div>\r\n          <p>Loading evidence files...</p>\r\n        </div>\r\n      `;\r\n      // Make API call to get evidence files from Supabase bucket\r\n      // SECURITY: Use Supabase session token, never localStorage\r\n      const {\r\n        data: { session },\r\n      } = await supabase.auth.getSession();\r\n      const token = session?.access_token;\r\n      const headers = { \"Content-Type\": \"application/json\" };\r\n      if (token) {\r\n        headers[\"Authorization\"] = `Bearer ${token}`;\r\n      }\r\n      const response = await fetch(`/api/complaints/${complaintId}/evidence`, {\r\n        method: \"GET\",\r\n        headers,\r\n      });\r\n      if (!response.ok) {\r\n        throw new Error(\r\n          `Failed to load evidence: ${response.status} ${response.statusText}`\r\n        );\r\n      }\r\n      const result = await response.json();\r\n      if (!result.success) {\r\n        throw new Error(result.error || \"Failed to load evidence\");\r\n      }\r\n      const evidenceFiles = result.data || [];\r\n      if (evidenceFiles.length === 0) {\r\n        evidenceContainer.innerHTML = `\r\n          <div class=\"evidence-empty\">\r\n            <p>No evidence files uploaded for this complaint</p>\r\n          </div>\r\n        `;\r\n        return;\r\n      }\r\n      // Render evidence files\r\n      const evidenceHTML = evidenceFiles\r\n        .map((file) => {\r\n          const fileIcon = this.getFileIcon(file.name);\r\n          const fileSize = this.formatFileSize(file.size);\r\n          const isImage = this.isImageFile(file.name);\r\n          return `\r\n          <div class=\"evidence-item\" data-file-name=\"${file.name}\">\r\n            <div class=\"evidence-icon\">${fileIcon}</div>\r\n            <div class=\"evidence-info\">\r\n              <div class=\"evidence-name\" title=\"${file.name}\">${file.name}</div>\r\n              <div class=\"evidence-size\">${fileSize}</div>\r\n            </div>\r\n            <div class=\"evidence-actions\">\r\n              ${\r\n  isImage\r\n    ? `\r\n                <button class=\"px-2 py-1 text-xs border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 rounded hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors\" onclick=\"this.previewEvidence('${file.name}', '${file.url}')\">\r\n                  Preview\r\n                </button>\r\n              `\r\n    : \"\"\r\n}\r\n              <button class=\"px-2 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors ml-1\" onclick=\"this.downloadEvidence('${\r\n  file.name\r\n}', '${file.url}')\">\r\n                Download\r\n              </button>\r\n            </div>\r\n          </div>\r\n        `;\r\n        })\r\n        .join(\"\");\r\n\r\n      evidenceContainer.innerHTML = `\r\n        <div class=\"evidence-list\">\r\n          ${evidenceHTML}\r\n        </div>\r\n      `;\r\n\r\n      // Add event listeners for evidence actions\r\n      this.setupEvidenceActionListeners(complaintId);\r\n    } catch (error) {\r\n      console.error(\"[LGU_ADMIN_ASSIGNMENTS] Error loading evidence:\", error);\r\n\r\n      // Try to extract detailed error message\r\n      let errorMessage = \"Failed to load evidence files\";\r\n      if (error.response?.data?.details) {\r\n        const { details } = error.response.data;\r\n        if (details.rejectedOfficers && details.rejectedOfficers.length > 0) {\r\n          const reasons = details.rejectedOfficers\r\n            .map(\r\n              (o) =>\r\n                `${o.email || o.id}: ${o.reason}${\r\n                  o.officerDept\r\n                    ? ` (has: ${o.officerDept}, needs: ${o.requiredDept})`\r\n                    : \"\"\r\n                }`\r\n            )\r\n            .join(\"; \");\r\n          errorMessage = `Cannot assign: ${reasons}`;\r\n        }\r\n      } else if (error.response?.data?.error) {\r\n        _errorMessage = error.response.data.error;\r\n      }\r\n      const evidenceContainer = document.getElementById(\r\n        `evidence-container-${complaintId}`\r\n      );\r\n      if (evidenceContainer) {\r\n        evidenceContainer.innerHTML = `\r\n          <div class=\"evidence-error\">\r\n            <p>Unable to load evidence files</p>\r\n            <p class=\"error-details\">${error.message}</p>\r\n          </div>\r\n        `;\r\n      }\r\n    }\r\n  }\r\n  setupEvidenceActionListeners(complaintId) {\r\n    // Preview buttons\r\n    document\r\n      .querySelectorAll(`#evidence-container-${complaintId} .btn-outline`)\r\n      .forEach((btn) => {\r\n        btn.addEventListener(\"click\", (e) => {\r\n          const { fileName } = e.target.closest(\".evidence-item\").dataset;\r\n          const fileUrl = e.target.onclick.toString().match(/'([^']+)'/)[1];\r\n          this.previewEvidence(fileName, fileUrl);\r\n        });\r\n      });\r\n\r\n    // Download buttons\r\n    document\r\n      .querySelectorAll(`#evidence-container-${complaintId} .btn-primary`)\r\n      .forEach((btn) => {\r\n        btn.addEventListener(\"click\", (e) => {\r\n          const { fileName } = e.target.closest(\".evidence-item\").dataset;\r\n          const fileUrl = e.target.onclick.toString().match(/'([^']+)'/)[1];\r\n          this.downloadEvidence(fileName, fileUrl);\r\n        });\r\n      });\r\n  }\r\n\r\n  getFileIcon(fileName) {\r\n    const extension = fileName.split(\".\").pop().toLowerCase();\r\n    const iconMap = {\r\n      pdf: \"📄\",\r\n      doc: \"📄\",\r\n      docx: \"📄\",\r\n      jpg: \"📷\",\r\n      jpeg: \"📷\",\r\n      png: \"📷\",\r\n      gif: \"📷\",\r\n      mp4: \"🎥\",\r\n      avi: \"🎥\",\r\n      mov: \"🎥\",\r\n      mp3: \"🎵\",\r\n      wav: \"🎵\",\r\n      txt: \"📝\",\r\n      zip: \"📦\",\r\n      rar: \"📦\",\r\n    };\r\n    return iconMap[extension] || \"📎\";\r\n  }\r\n  formatFileSize(bytes) {\r\n    if (!bytes) return \"Unknown size\";\r\n    const sizes = [\"Bytes\", \"KB\", \"MB\", \"GB\"];\r\n    const i = Math.floor(Math.log(bytes) / Math.log(1024));\r\n    return `${Math.round((bytes / Math.pow(1024, i)) * 100) / 100} ${sizes[i]}`;\r\n  }\r\n  isImageFile(fileName) {\r\n    const imageExtensions = [\"jpg\", \"jpeg\", \"png\", \"gif\", \"bmp\", \"webp\"];\r\n    const extension = fileName.split(\".\").pop().toLowerCase();\r\n    return imageExtensions.includes(extension);\r\n  }\r\n  previewEvidence(fileName, fileUrl) {\r\n    if (this.isImageFile(fileName)) {\r\n      // Open image in new tab\r\n      window.open(fileUrl, \"_blank\");\r\n    } else {\r\n      // For non-images, try to open in new tab\r\n      window.open(fileUrl, \"_blank\");\r\n    }\r\n  }\r\n  downloadEvidence(fileName, fileUrl) {\r\n    // Create a temporary link element to trigger download\r\n    const link = document.createElement(\"a\");\r\n    link.href = fileUrl;\r\n    link.download = fileName;\r\n    link.target = \"_blank\";\r\n    document.body.appendChild(link);\r\n    link.click();\r\n    document.body.removeChild(link);\r\n  }\r\n  closeComplaintDetailsPanel() {\r\n    const panel = document.getElementById(\"complaint-details-panel\");\r\n    if (panel) {\r\n      panel.classList.remove(\"active\");\r\n      document.body.classList.remove(\"details-panel-open\");\r\n    }\r\n  }\r\n  selectComplaint(complaint) {\r\n    this.selectedComplaint = complaint;\r\n    this.currentComplaintId = complaint.complaint_id;\r\n    // Update UI to show selected complaint - with null checks\r\n    const assignButton = document.getElementById(\"assign-button\");\r\n    const complaintDetailsBtn = document.getElementById(\r\n      \"complaint-details-btn\"\r\n    );\r\n    if (assignButton) assignButton.disabled = false;\r\n    if (complaintDetailsBtn) complaintDetailsBtn.disabled = false;\r\n  }\r\n  async handleAssignment() {\r\n    const officerIds = this.getSelectedOfficers();\r\n    if (officerIds.length === 0) {\r\n      showMessage(\"error\", \"Please select at least one officer\");\r\n      return;\r\n    }\r\n    try {\r\n      const requestData = {\r\n        officerIds,\r\n      };\r\n      const response = await apiClient.post(\r\n        `/api/lgu-admin/complaints/${this.currentComplaintId}/assign`,\r\n        requestData\r\n      );\r\n      if (response && response.success) {\r\n        showMessage(\"success\", \"Assignment created successfully\");\r\n        this.closeAssignmentModal();\r\n        this.refreshData();\r\n      } else {\r\n        const errorMsg = response?.error || \"Failed to create assignment\";\r\n        console.error(\"[LGU_ADMIN_ASSIGNMENTS] Assignment error:\", errorMsg);\r\n        console.error(\"[LGU_ADMIN_ASSIGNMENTS] Full response:\", response);\r\n        showMessage(\"error\", errorMsg);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[LGU_ADMIN_ASSIGNMENTS] Assignment exception:\", error);\r\n      showMessage(\"error\", \"Failed to create assignment\");\r\n    }\r\n  }\r\n  getPriorityClass(priority) {\r\n    const priorityClasses = {\r\n      low: \"priority-low\",\r\n      medium: \"priority-medium\",\r\n      high: \"priority-high\",\r\n      urgent: \"priority-urgent\",\r\n    };\r\n    return priorityClasses[priority] || \"priority-medium\";\r\n  }\r\n  getStatusClass(status) {\r\n    const statusClasses = {\r\n      unassigned: \"status-unassigned\",\r\n      assigned: \"status-assigned\",\r\n      active: \"status-active\",\r\n      in_progress: \"status-in-progress\",\r\n      completed: \"status-completed\",\r\n      cancelled: \"status-cancelled\",\r\n    };\r\n    return statusClasses[status] || \"status-unknown\";\r\n  }\r\n  getStatusText(status) {\r\n    const statusTexts = {\r\n      unassigned: \"Unassigned\",\r\n      assigned: \"Assigned\",\r\n      active: \"Active\",\r\n      in_progress: \"In Progress\",\r\n      completed: \"Completed\",\r\n      cancelled: \"Cancelled\",\r\n    };\r\n    return statusTexts[status] || status;\r\n  }\r\n}\r\n// Initialize the assignments page\r\nconst assignmentsPage = new LguAdminAssignments();\r\n// Make methods available globally for pagination\r\nwindow.assignmentsPage = assignmentsPage;\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  assignmentsPage.initialize();\r\n});\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\lgu-admin\\dashboard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\lgu-admin\\publish.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\lgu-dashboard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\lgu-officer-dashboard.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected prompt.","line":337,"column":18,"nodeType":"CallExpression","messageId":"unexpected","endLine":337,"endColumn":74}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * LGU Officer Dashboard\r\n * Field operations and task management for local government officers\r\n */\r\nimport showMessage from \"../components/toast.js\";\r\nimport { escapeHtml } from \"../utils/string.js\";\r\nimport { formatDate } from \"../utils/date.js\";\r\nimport { getStatusText } from \"../utils/complaint.js\";\r\nimport { getActivityIcon, getUpdateIcon } from \"../utils/icons.js\";\r\n\r\n// Dashboard state\r\nconst _dashboardData = null;\r\n/**\r\n * Initialize dashboard\r\n */\r\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\r\n  await loadDashboardData();\r\n  await loadMyTasks();\r\n  await loadStatistics();\r\n  await loadActivity();\r\n  await loadUpdates();\r\n  setupEventListeners();\r\n});\r\n/**\r\n * Load dashboard data\r\n */\r\nasync function loadDashboardData() {\r\n  try {\r\n    // Load all dashboard components\r\n    await Promise.all([loadStatistics(), loadActivity(), loadUpdates()]);\r\n  } catch (error) {\r\n    console.error(\"[LGU_OFFICER] Load dashboard error:\", error);\r\n    showMessage(\"error\", \"Failed to load dashboard data\");\r\n  }\r\n}\r\n/**\r\n * Load my tasks\r\n */\r\nasync function loadMyTasks() {\r\n  try {\r\n    const response = await fetch(\"/api/lgu/tasks?limit=5\");\r\n    const result = await response.json();\r\n    if (result.success) {\r\n      renderMyTasks(result.data || []);\r\n    } else {\r\n      renderMyTasks([]);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[LGU_OFFICER] Load tasks error:\", error);\r\n    renderMyTasks([]);\r\n  }\r\n}\r\n/**\r\n * Load statistics\r\n */\r\nasync function loadStatistics() {\r\n  try {\r\n    const response = await fetch(\"/api/lgu/statistics\");\r\n    const result = await response.json();\r\n    if (result.success) {\r\n      renderStatistics(result.data);\r\n    } else {\r\n      renderStatistics({});\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[LGU_OFFICER] Load statistics error:\", error);\r\n    renderStatistics({});\r\n  }\r\n}\r\n/**\r\n * Load activity\r\n */\r\nasync function loadActivity() {\r\n  try {\r\n    const response = await fetch(\"/api/lgu/activities?limit=5\");\r\n    const result = await response.json();\r\n    if (result.success) {\r\n      renderActivity(result.data || []);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[LGU_OFFICER] Load activity error:\", error);\r\n  }\r\n}\r\n/**\r\n * Load updates\r\n */\r\nasync function loadUpdates() {\r\n  try {\r\n    const response = await fetch(\"/api/lgu/updates?limit=5\");\r\n    const result = await response.json();\r\n    if (result.success) {\r\n      renderUpdates(result.data || []);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[LGU_OFFICER] Load updates error:\", error);\r\n  }\r\n}\r\n/**\r\n * Render my tasks\r\n */\r\nfunction renderMyTasks(tasks) {\r\n  const container = document.getElementById(\"tasks-container\");\r\n  if (!container) return;\r\n  // Client-side deduplication by complaint_id (keep the most recent one)\r\n  const uniqueTasks = tasks.reduce((acc, task) => {\r\n    const existing = acc.find((t) => t.complaint_id === task.complaint_id);\r\n    if (\r\n      !existing ||\r\n      new Date(task.updated_at || task.created_at) >\r\n        new Date(existing.updated_at || existing.created_at)\r\n    ) {\r\n      const filtered = acc.filter((t) => t.complaint_id !== task.complaint_id);\r\n      return [...filtered, task];\r\n    }\r\n    return acc;\r\n  }, []);\r\n  if (uniqueTasks.length === 0) {\r\n    container.innerHTML = `\r\n      <div class=\"empty-state\">\r\n        <div class=\"empty-state-icon\">📋</div>\r\n        <h3>No Tasks Assigned</h3>\r\n        <p>You don't have any tasks assigned at the moment.</p>\r\n        <button class=\"btn btn-primary\" onclick=\"refreshTasks()\">Refresh</button>\r\n      </div>\r\n    `;\r\n    return;\r\n  }\r\n  const html = uniqueTasks\r\n    .map(\r\n      (task) => `\r\n    <div class=\"task-item\" onclick=\"viewTaskDetail('${task.complaint_id}')\">\r\n      <div class=\"task-header\">\r\n        <h4 class=\"task-title\">${escapeHtml(getTaskTitle(task))}</h4>\r\n        <span class=\"task-priority priority-${(\r\n    task.urgency_level ||\r\n          task.priority ||\r\n          \"medium\"\r\n  ).toLowerCase()}\">${(\r\n  task.urgency_level ||\r\n        task.priority ||\r\n        \"MEDIUM\"\r\n).toUpperCase()}</span>\r\n      </div>\r\n      <div class=\"task-meta\">\r\n        <span class=\"task-type\">${escapeHtml(\r\n    task.complaint?.category || \"General\"\r\n  )}</span>\r\n        <span class=\"task-deadline\">Due: ${formatDate(task.deadline)}</span>\r\n        ${\r\n  task.complaint?.urgency_level\r\n    ? `<span class=\"citizen-urgency\" title=\"Citizen Reported Urgency\">Citizen: ${task.complaint.urgency_level}</span>`\r\n    : \"\"\r\n}\r\n      </div>\r\n      <div class=\"task-progress\">\r\n        <div class=\"progress-bar\">\r\n          <div class=\"progress-fill\" style=\"width: ${getTaskProgress(\r\n    task.status\r\n  )}%\"></div>\r\n        </div>\r\n        <span class=\"progress-text\">${getStatusText(task.status)}</span>\r\n      </div>\r\n      <div class=\"task-actions\">\r\n        <button class=\"btn btn-sm btn-primary\" onclick=\"event.stopPropagation(); updateTask('${\r\n  task.complaint_id\r\n}')\">Update</button>\r\n        <button class=\"btn btn-sm btn-secondary\" onclick=\"event.stopPropagation(); addNote('${\r\n  task.complaint_id\r\n}')\">Add Note</button>\r\n        <button class=\"btn btn-sm btn-outline-danger\" onclick=\"event.stopPropagation(); escalateTask('${\r\n  task.complaint_id\r\n}')\">Return</button>\r\n      </div>\r\n    </div>\r\n  `\r\n    )\r\n    .join(\"\");\r\n  container.innerHTML = html;\r\n}\r\n/**\r\n * Render statistics\r\n */\r\nfunction renderStatistics(stats) {\r\n  document.getElementById(\"stat-total-assigned\").textContent =\r\n    stats.total_tasks || 0;\r\n  document.getElementById(\"stat-in-progress\").textContent =\r\n    stats.in_progress_tasks || 0;\r\n  document.getElementById(\"stat-completed\").textContent =\r\n    stats.completed_tasks || 0;\r\n  document.getElementById(\"stat-overdue\").textContent =\r\n    stats.overdue_tasks || 0;\r\n}\r\n/**\r\n * Render activity\r\n */\r\nfunction renderActivity(activities) {\r\n  const container = document.getElementById(\"activity-container\");\r\n  if (!container) return;\r\n  // Client-side deduplication by complaint_id (keep the most recent one)\r\n  const uniqueActivities = activities.reduce((acc, activity) => {\r\n    const existing = acc.find((a) => a.complaint_id === activity.complaint_id);\r\n    if (\r\n      !existing ||\r\n      new Date(activity.created_at) > new Date(existing.created_at)\r\n    ) {\r\n      const filtered = acc.filter(\r\n        (a) => a.complaint_id !== activity.complaint_id\r\n      );\r\n      return [...filtered, activity];\r\n    }\r\n    return acc;\r\n  }, []);\r\n  console.log(\"[LGU_OFFICER_DASHBOARD] Activity deduplication:\", {\r\n    originalCount: activities.length,\r\n    uniqueCount: uniqueActivities.length,\r\n    removedDuplicates: activities.length - uniqueActivities.length,\r\n  });\r\n  if (uniqueActivities.length === 0) {\r\n    container.innerHTML = `\r\n      <div class=\"empty-state\">\r\n        <div class=\"empty-state-icon\">🕒</div>\r\n        <p>No recent activity</p>\r\n      </div>\r\n    `;\r\n    return;\r\n  }\r\n  const html = uniqueActivities\r\n    .map(\r\n      (activity) => `\r\n    <div class=\"activity-item\" data-type=\"${activity.type}\">\r\n      <div class=\"activity-icon\">${getActivityIcon(activity.type)}</div>\r\n      <div class=\"activity-content\">\r\n        <div class=\"activity-text\">${escapeHtml(activity.description)}</div>\r\n        <div class=\"activity-time\">${formatDate(activity.created_at)}</div>\r\n      </div>\r\n    </div>\r\n  `\r\n    )\r\n    .join(\"\");\r\n  container.querySelector(\".activity-list\").innerHTML = html;\r\n}\r\n/**\r\n * Render updates\r\n */\r\nfunction renderUpdates(updates) {\r\n  const container = document.getElementById(\"updates-container\");\r\n  if (!container) return;\r\n  if (updates.length === 0) {\r\n    container.innerHTML = `\r\n      <div class=\"empty-state\">\r\n        <div class=\"empty-state-icon\">🏢</div>\r\n        <p>No department updates</p>\r\n      </div>\r\n    `;\r\n    return;\r\n  }\r\n  const html = updates\r\n    .map(\r\n      (update) => `\r\n    <div class=\"update-item\">\r\n      <div class=\"update-icon\">${getUpdateIcon(update.type)}</div>\r\n      <div class=\"update-content\">\r\n        <div class=\"update-title\">${escapeHtml(update.title)}</div>\r\n        <div class=\"update-text\">${escapeHtml(\r\n    `${update.content?.substring(0, 80)}...`\r\n  )}</div>\r\n        <div class=\"update-time\">${formatDate(update.created_at)}</div>\r\n      </div>\r\n    </div>\r\n  `\r\n    )\r\n    .join(\"\");\r\n  container.querySelector(\".updates-list\").innerHTML = html;\r\n}\r\n/**\r\n * Setup event listeners\r\n */\r\nfunction setupEventListeners() {}\r\n/**\r\n * Helper functions\r\n */\r\nfunction getTaskProgress(status) {\r\n  const progressMap = {\r\n    assigned: 25,\r\n    in_progress: 50,\r\n    review: 75,\r\n    completed: 100,\r\n    cancelled: 0,\r\n  };\r\n  return progressMap[status] || 0;\r\n}\r\n// getActivityIcon and getUpdateIcon are now imported from icons.js utility\r\n// Removed duplicate formatDate and escapeHtml in favor of shared utils\r\n// Title fallback helper to avoid blank titles\r\nfunction getTaskTitle(task) {\r\n  const complaint = task?.complaint || {};\r\n  const byPriority = (task?.priority || \"\").toString().toUpperCase();\r\n\r\n  const result =\r\n    complaint.title ||\r\n    complaint.category ||\r\n    `Complaint ${\r\n      task?.complaint_id ? `#${String(task.complaint_id).substring(0, 8)}` : \"\"\r\n    } ${byPriority ? `(${byPriority})` : \"\"}`.trim();\r\n  return result;\r\n}\r\n/**\r\n * Global functions for onclick handlers\r\n */\r\nwindow.viewAssignedTasks = function () {\r\n  window.location.href = \"/taskAssigned\";\r\n};\r\nwindow.updateTaskStatus = function () {\r\n  showMessage(\"info\", \"Task status update feature coming soon\");\r\n  // TODO: Implement task status update modal\r\n};\r\nwindow.addProgressNote = function () {\r\n  showMessage(\"info\", \"Add progress note feature coming soon\");\r\n  // TODO: Implement add note modal\r\n};\r\nwindow.uploadEvidence = function () {\r\n  showMessage(\"info\", \"Upload evidence feature coming soon\");\r\n  // TODO: Implement evidence upload modal\r\n};\r\nwindow.requestSupport = function () {\r\n  showMessage(\"info\", \"Request support feature coming soon\");\r\n  // TODO: Implement support request modal\r\n};\r\nwindow.viewMap = function () {\r\n  window.location.href = \"/heatmap\";\r\n};\r\nwindow.escalateTask = function (taskId) {\r\n  if (!taskId) {\r\n    showMessage(\"warning\", \"Please select a task to escalate\");\r\n    return;\r\n  }\r\n  const reason = prompt(\"Please enter the reason for return/escalation:\");\r\n  if (reason) {\r\n    fetch(`/api/lgu/tasks/${taskId}/escalate`, {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ reason }),\r\n    })\r\n      .then((res) => res.json())\r\n      .then((result) => {\r\n        if (result.success) {\r\n          showMessage(\"success\", \"Task escalated successfully\");\r\n          loadMyTasks();\r\n        } else {\r\n          showMessage(\"error\", result.message || \"Failed to escalate task\");\r\n        }\r\n      });\r\n  }\r\n};\r\nwindow.viewTaskDetail = function (taskId) {\r\n  showMessage(\"info\", `Viewing task ${taskId}...`);\r\n  // TODO: Implement task detail view\r\n};\r\nwindow.updateTask = function (taskId) {\r\n  showMessage(\"info\", `Updating task ${taskId}...`);\r\n  // TODO: Implement task update modal\r\n};\r\nwindow.addNote = function (taskId) {\r\n  showMessage(\"info\", `Adding note to task ${taskId}...`);\r\n  // TODO: Implement add note modal\r\n};\r\nwindow.refreshStats = async function () {\r\n  showMessage(\"info\", \"Refreshing statistics...\");\r\n  await loadStatistics();\r\n  showMessage(\"success\", \"Statistics refreshed\");\r\n};\r\nwindow.refreshActivity = async function () {\r\n  showMessage(\"info\", \"Refreshing activity...\");\r\n  await loadActivity();\r\n  showMessage(\"success\", \"Activity refreshed\");\r\n};\r\nwindow.refreshUpdates = async function () {\r\n  showMessage(\"info\", \"Refreshing updates...\");\r\n  await loadUpdates();\r\n  showMessage(\"success\", \"Updates refreshed\");\r\n};\r\nwindow.refreshTasks = async function () {\r\n  showMessage(\"info\", \"Refreshing tasks...\");\r\n  await loadMyTasks();\r\n  showMessage(\"success\", \"Tasks refreshed\");\r\n};\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\lgu\\taskAssigned.js","messages":[],"suppressedMessages":[{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":95,"column":16,"nodeType":"Literal","endLine":95,"endColumn":69,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":98,"column":16,"nodeType":"Literal","endLine":98,"endColumn":69,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":101,"column":16,"nodeType":"Literal","endLine":101,"endColumn":63,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\myProfile.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\privacy-notice.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\publication.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\publish-tailwind-config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\resetPassword.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\pages\\signup-id-verify.js","messages":[{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":152,"column":38,"nodeType":"CallExpression","messageId":"returnsValue","endLine":152,"endColumn":62,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[4869,4893],"text":"{setTimeout(resolve, 500)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":182,"column":40,"nodeType":"CallExpression","messageId":"returnsValue","endLine":182,"endColumn":64,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[5922,5946],"text":"{setTimeout(resolve, 300)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'lastError' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":190,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":190,"endColumn":20},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":197,"column":42,"nodeType":"CallExpression","messageId":"returnsValue","endLine":197,"endColumn":66,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[6509,6533],"text":"{setTimeout(resolve, 300)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":286,"column":11,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":286,"endColumn":71},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":287,"column":42,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":287,"endColumn":43},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":287,"column":60,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":287,"endColumn":61},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":352,"column":27,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":352,"endColumn":28},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":352,"column":34,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":352,"endColumn":35},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":559,"column":61,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":559,"endColumn":70},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '/'. Use parentheses to clarify the intended order of operations.","line":987,"column":29,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":987,"endColumn":30},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '/'. Use parentheses to clarify the intended order of operations.","line":987,"column":40,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":987,"endColumn":41},{"ruleId":"no-lonely-if","severity":1,"message":"Unexpected if as the only statement in an else block.","line":1029,"column":11,"nodeType":"IfStatement","messageId":"unexpectedLonelyIf","endLine":1083,"endColumn":12},{"ruleId":"no-unreachable","severity":2,"message":"Unreachable code.","line":1114,"column":5,"nodeType":"ExpressionStatement","messageId":"unreachableCode","endLine":1114,"endColumn":43},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1405,"column":7,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1409,"endColumn":30}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":14,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from \"../config/config.js\";\r\n\r\n// ID Verification: upload/camera capture and OCR for identity verification\r\n// Expected OCR API response shape (example):\r\n// {\r\n//   fields: {\r\n//     firstName: \"...\",\r\n//     lastName: \"...\",\r\n//     middleName: \"...\",\r\n//     addressLine1: \"...\",\r\n//     addressLine2: \"...\",\r\n//     barangay: \"...\",\r\n//     sex: \"Male|Female|M|F\",\r\n//     idNumber: \"...\",\r\n//     birthDate: \"YYYY-MM-DD\",\r\n//     expiryDate: \"YYYY-MM-DD\"\r\n//   },\r\n//   rawText: \"...\",\r\n//   provider: \"textract|vision|tesseract|custom\"\r\n// }\r\n// Note: Extracted fields are displayed for verification purposes only, not for form autofill\r\n\r\n(function () {\r\n  const qs = (sel, root = document) => root.querySelector(sel);\r\n  const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));\r\n  const container = qs(\"#id-step-placeholder\");\r\n  if (!container) return;\r\n\r\n  const modeBtns = qsa(\".id-mode-btn\");\r\n  const uploadPanel = qs('[data-mode-panel=\"upload\"]');\r\n  const cameraPanel = qs('[data-mode-panel=\"camera\"]');\r\n\r\n  const fileInput = qs(\"#id-file-input\");\r\n  const previewWrap = qs(\"#id-preview\");\r\n  const previewImg = qs(\"#id-preview-img\");\r\n  const clearBtn = qs(\"#id-clear-btn\");\r\n\r\n  const cameraVideo = qs(\"#id-camera\");\r\n  const cameraCanvas = qs(\"#id-canvas\");\r\n  const cameraStartBtn = qs(\"#camera-start-btn\");\r\n  const cameraCaptureBtn = qs(\"#camera-capture-btn\");\r\n  const cameraStopBtn = qs(\"#camera-stop-btn\");\r\n  const cameraPreviewWrap = qs(\"#id-camera-preview\");\r\n  const cameraPreviewImg = qs(\"#id-captured-img\");\r\n  const cameraRetakeBtn = qs(\"#camera-retake-btn\");\r\n\r\n  const consent = qs(\"#id-consent-checkbox\");\r\n  const scanBtn = qs(\"#id-scan-btn\");\r\n  const statusEl = qs(\"#id-verify-status\");\r\n  const review = qs(\"#id-review\");\r\n  const reviewGrid = qs(\"#id-review-grid\");\r\n\r\n  const _form = qs(\"#regForm\") || qs(\"#oauthCompleteForm\");\r\n\r\n  let mediaStream = null;\r\n  let capturedBlob = null;\r\n  let isStartingCamera = false; // Prevent multiple simultaneous start attempts\r\n  const _lastCameraError = null;\r\n  let cameraErrorCount = 0;\r\n  let cameraCooldownUntil = 0; // Timestamp when camera can be retried\r\n  let extractedIdData = null; // Store extracted ID data for comparison\r\n\r\n  function setMode(mode) {\r\n    modeBtns.forEach((b) => {\r\n      const active = b.dataset.mode === mode;\r\n      b.classList.toggle(\"active\", active);\r\n      b.setAttribute(\"aria-selected\", String(active));\r\n    });\r\n    const isUpload = mode === \"upload\";\r\n    uploadPanel.hidden = !isUpload;\r\n    cameraPanel.hidden = isUpload;\r\n    if (!isUpload) {\r\n      previewWrap.hidden = true;\r\n      fileInput.value = \"\";\r\n      // Don't auto-start - let user explicitly click \"Enable camera\" button\r\n      // This prevents permission issues and race conditions\r\n    } else {\r\n      stopCamera();\r\n      cameraPreviewWrap.hidden = true;\r\n      capturedBlob = null;\r\n    }\r\n    updateScanEnabled();\r\n  }\r\n\r\n  function updateScanEnabled() {\r\n    const hasUpload = Boolean(fileInput.files?.[0]);\r\n    const hasCapture = Boolean(capturedBlob);\r\n    const ok = consent.checked && (hasUpload || hasCapture);\r\n    scanBtn.disabled = !ok;\r\n  }\r\n\r\n  // Upload handling\r\n  fileInput?.addEventListener(\"change\", () => {\r\n    const f = fileInput.files?.[0];\r\n    if (!f) {\r\n      previewWrap.hidden = true;\r\n      previewImg.src = \"\";\r\n      return updateScanEnabled();\r\n    }\r\n    // Preview if image\r\n    if (f.type.startsWith(\"image/\")) {\r\n      const url = URL.createObjectURL(f);\r\n      previewImg.src = url;\r\n      previewWrap.hidden = false;\r\n    } else {\r\n      previewWrap.hidden = true;\r\n      previewImg.src = \"\";\r\n    }\r\n    updateScanEnabled();\r\n  });\r\n\r\n  clearBtn?.addEventListener(\"click\", () => {\r\n    fileInput.value = \"\";\r\n    previewWrap.hidden = true;\r\n    previewImg.src = \"\";\r\n    updateScanEnabled();\r\n  });\r\n\r\n  // Camera handling\r\n  async function startCamera() {\r\n    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {\r\n      status(\r\n        \"Camera not supported on this device. Please use Upload mode.\",\r\n        \"error\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Check cooldown period\r\n    const now = Date.now();\r\n    if (now < cameraCooldownUntil) {\r\n      const secondsLeft = Math.ceil((cameraCooldownUntil - now) / 1000);\r\n      status(\r\n        `Please wait ${secondsLeft} second${\r\n          secondsLeft > 1 ? \"s\" : \"\"\r\n        } before trying again.`,\r\n        \"info\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Prevent multiple simultaneous start attempts\r\n    if (isStartingCamera) {\r\n      status(\"Camera is already starting. Please wait...\", \"info\");\r\n      return;\r\n    }\r\n\r\n    // Stop any existing camera stream first\r\n    if (mediaStream) {\r\n      stopCamera();\r\n      // Wait longer for cleanup to ensure resources are released\r\n      await new Promise((resolve) => setTimeout(resolve, 500));\r\n    }\r\n\r\n    isStartingCamera = true;\r\n\r\n    try {\r\n      cameraStartBtn.disabled = true;\r\n      status(\"Requesting camera access...\", \"info\");\r\n\r\n      // Strategy: Try simplest constraints first, then progressively more specific\r\n      // This avoids NotReadableError from overly complex constraints\r\n      let mediaStreamAttempt = null;\r\n      let lastError = null;\r\n\r\n      // Attempt 1: Absolute simplest - just request any video\r\n      try {\r\n        status(\"Checking camera availability...\", \"info\");\r\n        mediaStreamAttempt = await navigator.mediaDevices.getUserMedia({\r\n          video: true,\r\n          audio: false,\r\n        });\r\n        console.log(\"Camera access granted with simple constraints\");\r\n      } catch (simpleError) {\r\n        lastError = simpleError;\r\n        console.log(\r\n          \"Simple constraints failed, trying rear camera...\",\r\n          simpleError.name\r\n        );\r\n\r\n        // Attempt 2: Try rear camera (environment) with minimal constraints\r\n        await new Promise((resolve) => setTimeout(resolve, 300));\r\n        try {\r\n          mediaStreamAttempt = await navigator.mediaDevices.getUserMedia({\r\n            video: { facingMode: \"environment\" },\r\n            audio: false,\r\n          });\r\n          console.log(\"Camera access granted with rear camera\");\r\n        } catch (rearError) {\r\n          lastError = rearError;\r\n          console.log(\r\n            \"Rear camera failed, trying any camera with basic constraints...\",\r\n            rearError.name\r\n          );\r\n\r\n          // Attempt 3: Any camera with basic quality\r\n          await new Promise((resolve) => setTimeout(resolve, 300));\r\n          try {\r\n            mediaStreamAttempt = await navigator.mediaDevices.getUserMedia({\r\n              video: { width: 640, height: 480 },\r\n              audio: false,\r\n            });\r\n            console.log(\"Camera access granted with basic constraints\");\r\n          } catch (basicError) {\r\n            _lastError = basicError;\r\n            console.log(\"All camera attempts failed\", basicError.name);\r\n            throw basicError; // Re-throw to be caught by outer catch\r\n          }\r\n        }\r\n      }\r\n\r\n      mediaStream = mediaStreamAttempt;\r\n\r\n      // Success - reset error tracking\r\n      cameraErrorCount = 0;\r\n      lastCameraError = null;\r\n\r\n      cameraVideo.srcObject = mediaStream;\r\n      const cameraWrap = cameraVideo.closest(\".camera-wrap\");\r\n\r\n      // Wait for video to be ready\r\n      const onVideoReady = () => {\r\n        cameraVideo.classList.add(\"ready\");\r\n        if (cameraWrap) cameraWrap.classList.add(\"active\");\r\n        cameraCaptureBtn.disabled = false;\r\n        cameraStopBtn.disabled = false;\r\n        status(\r\n          \"Camera ready. Position your ID in the frame and click Capture.\",\r\n          \"success\"\r\n        );\r\n      };\r\n\r\n      cameraVideo.addEventListener(\"loadedmetadata\", onVideoReady, {\r\n        once: true,\r\n      });\r\n      cameraVideo.addEventListener(\"playing\", onVideoReady, { once: true });\r\n\r\n      cameraVideo.play().catch((err) => {\r\n        console.warn(\"Video play error:\", err);\r\n        // Still enable capture if metadata is loaded\r\n        if (cameraVideo.videoWidth > 0) {\r\n          onVideoReady();\r\n        }\r\n      });\r\n\r\n      cameraStartBtn.disabled = false;\r\n      isStartingCamera = false;\r\n    } catch (e) {\r\n      console.error(\"Camera error:\", e);\r\n      isStartingCamera = false;\r\n      cameraStartBtn.disabled = false;\r\n\r\n      // Clean up any partial stream directly (don't call stopCamera to avoid recursion)\r\n      if (mediaStream) {\r\n        mediaStream.getTracks().forEach((t) => {\r\n          t.stop();\r\n          t.enabled = false;\r\n        });\r\n        mediaStream = null;\r\n      }\r\n      if (cameraVideo) {\r\n        cameraVideo.srcObject = null;\r\n        cameraVideo.classList.remove(\"ready\");\r\n        const cameraWrap = cameraVideo.closest(\".camera-wrap\");\r\n        if (cameraWrap) cameraWrap.classList.remove(\"active\");\r\n      }\r\n\r\n      let errorMsg = \"Unable to access camera. \";\r\n      if (e.name === \"NotAllowedError\" || e.name === \"PermissionDeniedError\") {\r\n        errorMsg +=\r\n          \"Please allow camera permissions in your browser settings and try again.\";\r\n      } else if (\r\n        e.name === \"NotFoundError\" ||\r\n        e.name === \"DevicesNotFoundError\"\r\n      ) {\r\n        errorMsg += \"No camera found. Please use Upload mode instead.\";\r\n      } else if (\r\n        e.name === \"NotReadableError\" ||\r\n        e.name === \"TrackStartError\"\r\n      ) {\r\n        cameraErrorCount++;\r\n        lastCameraError = e.name;\r\n\r\n        // Implement exponential backoff: 3s, 6s, 10s, then suggest upload mode\r\n        const cooldownSeconds =\r\n          cameraErrorCount === 1 ? 3 : cameraErrorCount === 2 ? 6 : 10;\r\n        cameraCooldownUntil = Date.now() + cooldownSeconds * 1000;\r\n\r\n        errorMsg = \"Camera cannot be accessed. \";\r\n\r\n        if (cameraErrorCount === 1) {\r\n          errorMsg +=\r\n            \"This usually means the camera is being used by another application. \";\r\n          errorMsg +=\r\n            \"Please close Zoom, Teams, Skype, Discord, or other video apps, then wait 3 seconds and try again.\";\r\n        } else if (cameraErrorCount === 2) {\r\n          errorMsg += \"The camera is still unavailable. \";\r\n          errorMsg +=\r\n            \"Please check: (1) Close all video apps, (2) Close other browser tabs using camera, (3) Restart your browser. \";\r\n          errorMsg +=\r\n            \"Wait 6 seconds before trying again, or use Upload mode instead.\";\r\n        } else {\r\n          errorMsg += \"Camera access failed multiple times. \";\r\n          errorMsg +=\r\n            \"Please use Upload mode to continue, or restart your computer and try again.\";\r\n          // After 3 failures, suggest switching to upload mode\r\n          setTimeout(() => {\r\n            const uploadBtn = Array.from(modeBtns).find(\r\n              (b) => b.dataset.mode === \"upload\"\r\n            );\r\n            if (uploadBtn) {\r\n              status(\r\n                '💡 Tip: Switch to \"Upload\" mode to continue without camera.',\r\n                \"info\"\r\n              );\r\n              // Highlight the upload button\r\n              uploadBtn.style.border = \"2px solid var(--info-500)\";\r\n              uploadBtn.style.boxShadow = \"0 0 0 3px rgba(59, 130, 246, 0.2)\";\r\n              setTimeout(() => {\r\n                uploadBtn.style.border = \"\";\r\n                uploadBtn.style.boxShadow = \"\";\r\n              }, 5000);\r\n            }\r\n          }, 2000);\r\n        }\r\n\r\n        // Disable button during cooldown\r\n        cameraStartBtn.disabled = true;\r\n        const cooldownTimer = setInterval(() => {\r\n          const remaining = Math.ceil(\r\n            (cameraCooldownUntil - Date.now()) / 1000\r\n          );\r\n          if (remaining > 0) {\r\n            status(\r\n              `Please wait ${remaining} second${remaining > 1 ? \"s\" : \"\"}...`,\r\n              \"info\"\r\n            );\r\n          } else {\r\n            clearInterval(cooldownTimer);\r\n            cameraStartBtn.disabled = false;\r\n            if (cameraErrorCount <= 2) {\r\n              status('You can try clicking \"Enable camera\" again now.', \"info\");\r\n            } else {\r\n              status(\"Consider using Upload mode instead.\", \"info\");\r\n            }\r\n          }\r\n        }, 1000);\r\n\r\n        // Clear timer after cooldown\r\n        setTimeout(\r\n          () => clearInterval(cooldownTimer),\r\n          cooldownSeconds * 1000 + 100\r\n        );\r\n      } else if (\r\n        e.name === \"OverconstrainedError\" ||\r\n        e.name === \"ConstraintNotSatisfiedError\"\r\n      ) {\r\n        errorMsg +=\r\n          \"Camera does not support the requested settings. Trying with basic settings...\";\r\n        // Try again with minimal constraints\r\n        setTimeout(async () => {\r\n          try {\r\n            mediaStream = await navigator.mediaDevices.getUserMedia({\r\n              video: true,\r\n              audio: false,\r\n            });\r\n            cameraVideo.srcObject = mediaStream;\r\n            cameraVideo.play();\r\n            status(\"Camera started with basic settings.\", \"success\");\r\n          } catch (retryError) {\r\n            status(\r\n              \"Could not start camera. Please use Upload mode instead.\",\r\n              \"error\"\r\n            );\r\n          }\r\n        }, 1000);\r\n      } else {\r\n        errorMsg += \"Please use Upload mode or check your camera settings.\";\r\n      }\r\n      status(errorMsg, \"error\");\r\n    }\r\n  }\r\n\r\n  function stopCamera() {\r\n    isStartingCamera = false; // Reset flag to allow restart\r\n\r\n    if (mediaStream) {\r\n      // Stop all tracks more thoroughly\r\n      const tracks = mediaStream.getTracks();\r\n      tracks.forEach((t) => {\r\n        t.stop();\r\n        t.enabled = false;\r\n      });\r\n      // Clear the stream\r\n      mediaStream = null;\r\n    }\r\n    if (cameraVideo) {\r\n      // Pause video first\r\n      cameraVideo.pause();\r\n      cameraVideo.srcObject = null;\r\n      cameraVideo.classList.remove(\"ready\");\r\n      const cameraWrap = cameraVideo.closest(\".camera-wrap\");\r\n      if (cameraWrap) cameraWrap.classList.remove(\"active\");\r\n    }\r\n    cameraCaptureBtn.disabled = true;\r\n    cameraStopBtn.disabled = false; // Allow restart\r\n  }\r\n\r\n  cameraStartBtn?.addEventListener(\"click\", startCamera);\r\n  cameraStopBtn?.addEventListener(\"click\", () => {\r\n    stopCamera();\r\n    status(\"Camera stopped\");\r\n  });\r\n\r\n  cameraCaptureBtn?.addEventListener(\"click\", () => {\r\n    if (!cameraVideo.videoWidth || !cameraVideo.videoHeight) {\r\n      status(\r\n        \"Camera not ready. Please wait for the camera to initialize.\",\r\n        \"error\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const w = cameraVideo.videoWidth;\r\n      const h = cameraVideo.videoHeight;\r\n      cameraCanvas.width = w;\r\n      cameraCanvas.height = h;\r\n      const ctx = cameraCanvas.getContext(\"2d\");\r\n\r\n      // Draw the video frame to canvas\r\n      ctx.drawImage(cameraVideo, 0, 0, w, h);\r\n\r\n      // Convert to blob\r\n      cameraCanvas.toBlob(\r\n        (blob) => {\r\n          if (!blob) {\r\n            status(\"Failed to capture image. Please try again.\", \"error\");\r\n            return;\r\n          }\r\n\r\n          capturedBlob = blob;\r\n          const url = URL.createObjectURL(blob);\r\n          cameraPreviewImg.src = url;\r\n          cameraPreviewWrap.hidden = false;\r\n\r\n          // Stop camera after capture to save resources\r\n          stopCamera();\r\n\r\n          updateScanEnabled();\r\n          status(\r\n            \"Image captured successfully! You may proceed to verify your ID.\",\r\n            \"success\"\r\n          );\r\n        },\r\n        \"image/jpeg\",\r\n        0.92\r\n      ); // Slightly lower quality for smaller file size\r\n    } catch (err) {\r\n      console.error(\"Capture error:\", err);\r\n      status(\"Failed to capture image. Please try again.\", \"error\");\r\n    }\r\n  });\r\n\r\n  cameraRetakeBtn?.addEventListener(\"click\", () => {\r\n    if (cameraPreviewImg.src) {\r\n      URL.revokeObjectURL(cameraPreviewImg.src);\r\n    }\r\n    capturedBlob = null;\r\n    cameraPreviewImg.src = \"\";\r\n    cameraPreviewWrap.hidden = true;\r\n    updateScanEnabled();\r\n    // Restart camera for retake\r\n    if (cameraPanel && !cameraPanel.hidden) {\r\n      startCamera();\r\n    }\r\n  });\r\n\r\n  // Mode toggle\r\n  modeBtns.forEach((btn) =>\r\n    btn.addEventListener(\"click\", () => setMode(btn.dataset.mode))\r\n  );\r\n\r\n  consent?.addEventListener(\"change\", updateScanEnabled);\r\n\r\n  // Scan and verify ID\r\n  scanBtn?.addEventListener(\"click\", async () => {\r\n    const usingUpload = !uploadPanel.hidden;\r\n    const file = usingUpload ? fileInput.files?.[0] : null;\r\n    const blob = usingUpload ? file : capturedBlob;\r\n    if (!blob) return;\r\n\r\n    scanBtn.disabled = true;\r\n\r\n    // Start timer for elapsed time\r\n    const startTime = Date.now();\r\n    const timerInterval = setInterval(() => {\r\n      const elapsed = Math.floor((Date.now() - startTime) / 1000);\r\n      status(`Processing ID… This may take a few seconds. (${elapsed}s)`);\r\n    }, 1000);\r\n\r\n    status(\"Processing ID… This may take a few seconds. (0s)\");\r\n\r\n    try {\r\n      const fd = new FormData();\r\n      fd.append(\"file\", blob, (file && file.name) || \"capture.jpg\");\r\n      const res = await fetch(\"/api/identity/ocr\", {\r\n        method: \"POST\",\r\n        body: fd,\r\n      });\r\n\r\n      const data = await res.json();\r\n\r\n      // Handle error responses from OCR service\r\n      if (!res.ok || !data.success) {\r\n        const errorCode = data.error || \"UNKNOWN_ERROR\";\r\n        let errorMessage =\r\n          data.message || \"Could not process the ID automatically.\";\r\n\r\n        // Provide specific error messages based on error type\r\n        if (\r\n          errorCode === \"TEXT_DETECTION_FAILED\" ||\r\n          errorCode === \"NO_FIELDS_EXTRACTED\"\r\n        ) {\r\n          errorMessage = data.message || \"Text detection failed. \";\r\n          if (data.details && data.details.suggestions) {\r\n            errorMessage += `\\n\\nSuggestions:\\n${data.details.suggestions\r\n              .map((s, i) => `${i + 1}. ${s}`)\r\n              .join(\"\\n\")}`;\r\n          } else {\r\n            errorMessage +=\r\n              \"This may be due to poor image quality, blur, or camera issues. Please try again with a clearer image.\";\r\n          }\r\n        } else if (res.status === 400) {\r\n          errorMessage =\r\n            data.message ||\r\n            \"Invalid image. Please ensure the image is clear and readable.\";\r\n        } else if (res.status >= 500) {\r\n          errorMessage =\r\n            \"Server error occurred while processing the ID. Please try again later.\";\r\n        }\r\n\r\n        status(errorMessage, \"error\");\r\n        console.error(\"OCR error:\", {\r\n          code: errorCode,\r\n          message: data.message,\r\n          details: data.details,\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Store extracted ID data\r\n      const rawFields = data?.fields || {};\r\n      extractedIdData = {};\r\n\r\n      // Flatten fields if they are objects with value/confidence (Handle new OCR format)\r\n      Object.keys(rawFields).forEach((key) => {\r\n        const val = rawFields[key];\r\n        if (val && typeof val === \"object\" && val.value !== undefined) {\r\n          extractedIdData[key] = val.value;\r\n        } else {\r\n          extractedIdData[key] = val;\r\n        }\r\n      });\r\n      // CRITICAL FIX: Ensure idType is part of the extracted data for validation\r\n      extractedIdData.idType = data.idType;\r\n\r\n      // Store verification data in backend (only if authenticated)\r\n      try {\r\n        // Get current session token to ensure request is authenticated\r\n        const {\r\n          data: { session },\r\n        } = await supabase.auth.getSession();\r\n        const token = session?.access_token;\r\n\r\n        // If no session (e.g. email signup), skip server storage\r\n        if (!token) {\r\n          console.log(\r\n            \"[ID_VERIFY] Anonymous user - skipping server storage. Using local verification data.\"\r\n          );\r\n          // Use a temporary local ID\r\n          sessionStorage.setItem(\r\n            \"cl_verification_id\",\r\n            `local_verified_${Date.now()}`\r\n          );\r\n\r\n          // Secure Signup: Store verification token if returned by OCR\r\n          if (data.verificationToken) {\r\n            sessionStorage.setItem(\r\n              \"cl_verification_token\",\r\n              data.verificationToken\r\n            );\r\n          }\r\n\r\n          sessionStorage.setItem(\"cl_verification_complete\", \"true\");\r\n\r\n          // Immediate success for anonymous users\r\n          if (typeof window.handleVerificationSuccess === \"function\") {\r\n            window.handleVerificationSuccess({\r\n              idType: data.idType,\r\n              idNumber:\r\n                extractedIdData.idNumber || extractedIdData.public_id_number,\r\n              ...extractedIdData,\r\n            });\r\n          }\r\n\r\n          // ** MIGRANT DETECTION LOGIC **\r\n          const address = (extractedIdData.address || \"\").toUpperCase();\r\n          const isDigos = address.includes(\"DIGOS\");\r\n\r\n          if (isDigos) {\r\n            // Standard Flow: Digos ID -> Verify Address Match\r\n            status(\"ID Verified successfully.\", \"success\");\r\n            compareWithFormData(extractedIdData);\r\n          } else {\r\n            // Migrant Flow: Non-Digos ID -> Require Secondary Proof\r\n            console.log(\r\n              \"[ID_VERIFY] Non-Digos Address detected. Triggering Secondary Verification.\"\r\n            );\r\n            status(\"ID Valid. Non-Digos Address detected.\", \"warning\");\r\n\r\n            // Unhide Secondary Section\r\n            const secSection = document.getElementById(\"secondary-doc-section\");\r\n            if (secSection) secSection.hidden = false;\r\n\r\n            // Setup Secondary Upload Logic\r\n            setupSecondaryVerification(extractedIdData.lastName);\r\n          }\r\n          return;\r\n        }\r\n\r\n        const headers = { \"Content-Type\": \"application/json\" };\r\n        headers[\"Authorization\"] = `Bearer ${token}`;\r\n\r\n        // Normalize ID number for backend (server expects idNumber)\r\n        if (!extractedIdData.idNumber) {\r\n          extractedIdData.idNumber =\r\n            extractedIdData.public_id_number ||\r\n            extractedIdData.id_number ||\r\n            extractedIdData.IDNumber ||\r\n            extractedIdData.documentNumber ||\r\n            \"\";\r\n        }\r\n\r\n        const storeResponse = await fetch(\"/api/verification/store\", {\r\n          method: \"POST\",\r\n          headers,\r\n          credentials: \"include\",\r\n          body: JSON.stringify({\r\n            idType: data.idType,\r\n            fields: extractedIdData, // Use flattened data for backend storage\r\n            confidence: data.confidence,\r\n          }),\r\n        });\r\n\r\n        const storeResult = await storeResponse.json();\r\n\r\n        if (!storeResponse.ok || !storeResult.success) {\r\n          // Handle session expiry / stale user\r\n          if (storeResponse.status === 401) {\r\n            console.warn(\r\n              \"[ID_VERIFY] Session issue during storage (non-fatal):\",\r\n              storeResult.error\r\n            );\r\n            // Don't redirect, just warn and proceed\r\n            sessionStorage.setItem(\r\n              \"cl_verification_id\",\r\n              `local_verified_${Date.now()}`\r\n            );\r\n            sessionStorage.setItem(\"cl_verification_complete\", \"true\");\r\n            status(\"ID Verified locally.\", \"success\"); // Suppress warning for smooth UX\r\n          } else if (storeResult.error === \"ID_NUMBER_ALREADY_REGISTERED\") {\r\n            status(\"⚠️ This ID number is already registered.\", \"warning\");\r\n            return; // Stop if duplicate\r\n          } else {\r\n            console.error(\"Failed to store verification:\", storeResult);\r\n            status(\r\n              \"⚠️ Verification verified locally. Server storage failed.\",\r\n              \"warning\"\r\n            );\r\n          }\r\n\r\n          // Call success handler to unlock \"Next\" button (unless it was a duplicate error)\r\n          if (storeResult.error !== \"ID_NUMBER_ALREADY_REGISTERED\") {\r\n            if (typeof window.handleVerificationSuccess === \"function\") {\r\n              window.handleVerificationSuccess({\r\n                idType: data.idType,\r\n                idNumber:\r\n                  extractedIdData.idNumber || extractedIdData.public_id_number,\r\n                ...extractedIdData,\r\n              });\r\n            }\r\n          }\r\n          if (storeResult.error !== \"ID_NUMBER_ALREADY_REGISTERED\") {\r\n            compareWithFormData(extractedIdData);\r\n          }\r\n          return;\r\n        }\r\n\r\n        // Store verification token if present (for secure signup)\r\n        if (storeResult.data.verificationToken) {\r\n          sessionStorage.setItem(\r\n            \"cl_verification_token\",\r\n            storeResult.data.verificationToken\r\n          );\r\n        }\r\n\r\n        // Store verification ID for signup\r\n        try {\r\n          sessionStorage.setItem(\r\n            \"cl_verification_id\",\r\n            storeResult.data.verificationId\r\n          );\r\n          sessionStorage.setItem(\"cl_verification_complete\", \"true\");\r\n        } catch (storageError) {\r\n          console.warn(\r\n            \"Could not store verification ID in session:\",\r\n            storageError\r\n          );\r\n        }\r\n\r\n        console.log(\r\n          \"[ID_VERIFY] Verification stored:\",\r\n          storeResult.data.verificationId\r\n        );\r\n        status(\"ID Verified successfully!\", \"success\");\r\n\r\n        // Call success handler\r\n        if (typeof window.handleVerificationSuccess === \"function\") {\r\n          window.handleVerificationSuccess({\r\n            idType: data.idType,\r\n            idNumber:\r\n              extractedIdData.idNumber || extractedIdData.public_id_number,\r\n            ...extractedIdData,\r\n          });\r\n        }\r\n      } catch (storeError) {\r\n        console.error(\"Error storing verification:\", storeError);\r\n        status(\r\n          \"⚠️ Could not save verification data. Please try again.\",\r\n          \"error\"\r\n        );\r\n        return;\r\n      }\r\n\r\n      // Success - compare with form data (this will also render the results)\r\n      compareWithFormData(extractedIdData);\r\n    } catch (err) {\r\n      console.error(\"OCR error\", err);\r\n      // Determine if it's a network error, camera issue, or other error\r\n      let errorMessage = \"Could not process the ID automatically. \";\r\n      if (\r\n        err.message &&\r\n        (err.message.includes(\"fetch\") || err.message.includes(\"network\"))\r\n      ) {\r\n        errorMessage +=\r\n          \"Network error. Please check your connection and try again.\";\r\n      } else if (err.message && err.message.includes(\"camera\")) {\r\n        errorMessage +=\r\n          \"Camera error detected. Please try using Upload mode instead, or check your camera settings.\";\r\n      } else {\r\n        errorMessage +=\r\n          \"Please try again with a clearer image or continue with manual verification.\";\r\n      }\r\n      status(errorMessage, \"error\");\r\n    } finally {\r\n      clearInterval(timerInterval);\r\n      scanBtn.disabled = false;\r\n    }\r\n  });\r\n\r\n  function renderReview(fields, _provider) {\r\n    if (!fields || Object.keys(fields).length === 0) {\r\n      review.hidden = true;\r\n      reviewGrid.innerHTML = \"\";\r\n      return;\r\n    }\r\n\r\n    // Field name mapping for better display\r\n    const fieldLabels = {\r\n      firstName: \"First Name\",\r\n      lastName: \"Last Name\",\r\n      middleName: \"Middle Name\",\r\n      addressLine1: \"Address Line 1\",\r\n      addressLine2: \"Address Line 2\",\r\n      barangay: \"Barangay\",\r\n      sex: \"Sex/Gender\",\r\n      idNumber: \"ID Number\",\r\n      birthDate: \"Birth Date\",\r\n      expiryDate: \"Expiry Date\",\r\n    };\r\n\r\n    // Filter out null/empty values and format entries\r\n    const entries = Object.entries(fields)\r\n      .filter(([_k, v]) => v != null && String(v).trim() !== \"\")\r\n      .map(([k, v]) => {\r\n        const label =\r\n          fieldLabels[k] ||\r\n          k\r\n            .replace(/([A-Z])/g, \" $1\")\r\n            .replace(/^./, (str) => str.toUpperCase());\r\n        let value = String(v).trim();\r\n\r\n        // Format dates if they're in ISO format\r\n        if (\r\n          (k === \"birthDate\" || k === \"expiryDate\") &&\r\n          value.match(/^\\d{4}-\\d{2}-\\d{2}$/)\r\n        ) {\r\n          const date = new Date(value);\r\n          value = date.toLocaleDateString(\"en-US\", {\r\n            year: \"numeric\",\r\n            month: \"long\",\r\n            day: \"numeric\",\r\n          });\r\n        }\r\n\r\n        return { key: k, label, value };\r\n      });\r\n\r\n    if (entries.length === 0) {\r\n      review.hidden = true;\r\n      reviewGrid.innerHTML = \"\";\r\n      return;\r\n    }\r\n\r\n    reviewGrid.innerHTML = entries\r\n      .map(({ _key, label, value }) => {\r\n        const safeLabel = escapeHtml(label);\r\n        const safeValue = escapeHtml(value);\r\n        return `<div class=\"kv\"><div class=\"k\">${safeLabel}</div><div class=\"v\">${safeValue}</div></div>`;\r\n      })\r\n      .join(\"\");\r\n\r\n    review.hidden = false;\r\n  }\r\n\r\n  /**\r\n   * Compare extracted ID data with form data\r\n   * Only compares fields that exist in both the ID and the form\r\n   */\r\n  function compareWithFormData(idFields) {\r\n    if (!idFields || Object.keys(idFields).length === 0) {\r\n      // If no ID data, just show extracted fields if any\r\n      if (reviewGrid) {\r\n        renderReview(idFields || {});\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Get current form values (check if fields exist in the form)\r\n    const formData = {};\r\n    const formFieldMap = {\r\n      firstName: \"#firstName\",\r\n      lastName: \"#lastName\",\r\n      middleName: \"#middleName\",\r\n      addressLine1: \"#addressLine1\",\r\n      addressLine2: \"#addressLine2\",\r\n      barangay: \"#barangay\",\r\n      gender: \"#gender\",\r\n    };\r\n\r\n    // Only get form values for fields that actually exist in the DOM\r\n    Object.entries(formFieldMap).forEach(([key, selector]) => {\r\n      const element = qs(selector);\r\n      if (element) {\r\n        formData[key] = (element.value || \"\").trim();\r\n      }\r\n    });\r\n\r\n    // Normalize strings for comparison (remove extra spaces, convert to uppercase)\r\n    const normalize = (str) => {\r\n      if (!str) return \"\";\r\n      return str.replace(/\\s+/g, \" \").trim().toUpperCase();\r\n    };\r\n\r\n    // Compare gender values (handle different formats)\r\n    const normalizeGender = (gender) => {\r\n      if (!gender) return \"\";\r\n      const g = gender.toLowerCase();\r\n      if (g.startsWith(\"m\") || g === \"he\" || g === \"male\") return \"MALE\";\r\n      if (g.startsWith(\"f\") || g === \"she\" || g === \"female\") return \"FEMALE\";\r\n      return gender.toUpperCase();\r\n    };\r\n\r\n    // Compare ID gender with form gender\r\n    const normalizeIdGender = (idGender) => {\r\n      if (!idGender) return \"\";\r\n      const g = String(idGender).toLowerCase();\r\n      if (g.startsWith(\"m\") || g === \"male\") return \"MALE\";\r\n      if (g.startsWith(\"f\") || g === \"female\") return \"FEMALE\";\r\n      return String(idGender).toUpperCase();\r\n    };\r\n\r\n    // Field mapping: ID field name -> Form field name -> Display name\r\n    const fieldMappings = [\r\n      {\r\n        idField: \"firstName\",\r\n        formField: \"firstName\",\r\n        displayName: \"First Name\",\r\n        type: \"name\",\r\n        required: true,\r\n      },\r\n      {\r\n        idField: \"lastName\",\r\n        formField: \"lastName\",\r\n        displayName: \"Last Name\",\r\n        type: \"name\",\r\n        required: true,\r\n      },\r\n      {\r\n        idField: \"middleName\",\r\n        formField: \"middleName\",\r\n        displayName: \"Middle Name\",\r\n        type: \"name\",\r\n        required: false,\r\n      },\r\n      {\r\n        idField: \"address\", // Use full address from OCR\r\n        formField: \"addressLine1\",\r\n        displayName: \"Address\",\r\n        type: \"address\",\r\n        required: false,\r\n      },\r\n      {\r\n        idField: \"address\", // Use full address from OCR to check barangay\r\n        formField: \"barangay\",\r\n        displayName: \"Barangay\",\r\n        type: \"address\",\r\n        required: false,\r\n      },\r\n      {\r\n        idField: \"sex\",\r\n        formField: \"gender\",\r\n        displayName: \"Gender\",\r\n        type: \"gender\",\r\n        required: false,\r\n      },\r\n    ];\r\n\r\n    // Perform comparisons - only for fields that exist in both ID and form\r\n    const comparisons = [];\r\n    const availableIdFields = Object.keys(idFields).filter(\r\n      (key) => idFields[key] != null && String(idFields[key]).trim() !== \"\"\r\n    );\r\n    const availableFormFields = Object.keys(formData);\r\n\r\n    // Levenshtein distance for fuzzy matching\r\n    const levenshteinDistance = (a, b) => {\r\n      if (a.length === 0) return b.length;\r\n      if (b.length === 0) return a.length;\r\n      const matrix = [];\r\n      for (let i = 0; i <= b.length; i++) matrix[i] = [i];\r\n      for (let j = 0; j <= a.length; j++) matrix[0][j] = j;\r\n      for (let i = 1; i <= b.length; i++) {\r\n        for (let j = 1; j <= a.length; j++) {\r\n          if (b.charAt(i - 1) === a.charAt(j - 1)) {\r\n            matrix[i][j] = matrix[i - 1][j - 1];\r\n          } else {\r\n            matrix[i][j] = Math.min(\r\n              matrix[i - 1][j - 1] + 1,\r\n              Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1)\r\n            );\r\n          }\r\n        }\r\n      }\r\n      return matrix[b.length][a.length];\r\n    };\r\n\r\n    // Calculate similarity score (0-100)\r\n    const calculateSimilarity = (str1, str2) => {\r\n      const s1 = normalize(str1);\r\n      const s2 = normalize(str2);\r\n      if (!s1 && !s2) return 100;\r\n      if (!s1 || !s2) return 0;\r\n      if (s1 === s2) return 100;\r\n\r\n      // Partial Match Check: If one contains the other (and length > 3), it's a match\r\n      if (\r\n        (s1.includes(s2) || s2.includes(s1)) &&\r\n        Math.min(s1.length, s2.length) > 3\r\n      ) {\r\n        return 100;\r\n      }\r\n\r\n      const distance = levenshteinDistance(s1, s2);\r\n      const maxLength = Math.max(s1.length, s2.length);\r\n      const similarity = (1 - distance / maxLength) * 100;\r\n      return Math.max(0, Math.min(100, similarity));\r\n    };\r\n\r\n    fieldMappings.forEach((mapping) => {\r\n      // Only compare if:\r\n      // 1. The ID has this field\r\n      // 2. The form has this field (element exists in DOM)\r\n      const idHasField = availableIdFields.includes(mapping.idField);\r\n      const formHasField = availableFormFields.includes(mapping.formField);\r\n\r\n      if (idHasField && formHasField) {\r\n        const idValue = String(idFields[mapping.idField]).trim();\r\n        const formValue = formData[mapping.formField] || \"\";\r\n\r\n        // MIGRANT EXCEPTION: If verified by secondary doc, skip strict address checks\r\n        // We assume the Form Address is correct (self-declared) and the Secondary Doc proved it.\r\n        if (\r\n          idFields.isMigrantVerified &&\r\n          (mapping.idField === \"address\" || mapping.idField === \"barangay\")\r\n        ) {\r\n          comparisonResults.push({\r\n            field: mapping.label,\r\n            match: true,\r\n            score: 100, // Auto-pass\r\n            idValue: `${idValue  } (Migrant Verified)`,\r\n            formValue,\r\n          });\r\n          return; // Skip standard comparison\r\n        }\r\n\r\n        let match = false;\r\n        let score = 0;\r\n\r\n        if (mapping.type === \"gender\") {\r\n          // Special handling for gender\r\n          const idGender = normalizeIdGender(idValue);\r\n          const formGender = normalizeGender(formValue);\r\n          match = !formValue || idGender === formGender; // Optional field\r\n          score = match ? 100 : 0;\r\n        } else {\r\n          // Special handling for address: Use token-based matching and normalization\r\n          if (mapping.type === \"address\") {\r\n            // 1. Advanced Normalization\r\n            const normalizeAddr = (str) => {\r\n              if (!str) return \"\";\r\n              return str\r\n                .toUpperCase()\r\n                .replace(/[.,\\-#]/g, \" \") // Remove punctuation\r\n                .replace(/\\bPRK\\b/g, \"PUROK\") // Expand abbreviations\r\n                .replace(/\\bBRGY\\b/g, \"BARANGAY\")\r\n                .replace(/\\bSTR\\b|\\bST\\b/g, \"STREET\")\r\n                .replace(/\\bAVE\\b/g, \"AVENUE\")\r\n                .replace(/CITY OF (\\w+)/g, \"$1 CITY\") // CITY OF DIGOS -> DIGOS CITY\r\n                .replace(/\\s+/g, \" \")\r\n                .trim();\r\n            };\r\n\r\n            const s1 = normalizeAddr(idValue);\r\n            const s2 = normalizeAddr(formValue);\r\n\r\n            // 2. Compute similarity on normalized strings\r\n            score = calculateSimilarity(s1, s2);\r\n\r\n            // 3. Token Check: If sufficient keywords match, boost score\r\n            const tokens1 = s1.split(\" \");\r\n            const tokens2 = s2.split(\" \");\r\n            const matchingTokens = tokens1.filter(\r\n              (t) => t.length > 2 && tokens2.includes(t)\r\n            );\r\n\r\n            // If > 60% of significant words match, force success (common for address reordering)\r\n            if (\r\n              matchingTokens.length >=\r\n              Math.ceil(Math.min(tokens1.length, tokens2.length) * 0.6)\r\n            ) {\r\n              score = Math.max(score, 85);\r\n            }\r\n\r\n            // Lower strict threshold for addresses due to formatting variance\r\n            // If field is empty in form, consider it a match (optional field logic)\r\n            if (!formValue) {\r\n              match = true;\r\n              score = 100;\r\n            } else {\r\n              match = score >= 60;\r\n            }\r\n          } else {\r\n            // Standard logic for other fields\r\n            score = calculateSimilarity(idValue, formValue);\r\n            if (!formValue && !mapping.required) {\r\n              match = true;\r\n              score = 100;\r\n            } else {\r\n              match = score >= 80;\r\n            }\r\n          }\r\n        }\r\n\r\n        comparisons.push({\r\n          field: mapping.displayName,\r\n          idValue,\r\n          formValue: formValue || \"(not entered)\",\r\n          match,\r\n          score: Math.round(score),\r\n          type: mapping.type,\r\n          required: mapping.required,\r\n        });\r\n      }\r\n    });\r\n\r\n    // Track fields that exist in ID but not in form (for information display)\r\n    const idOnlyFields = availableIdFields.filter(\r\n      (idField) =>\r\n        !fieldMappings.some(\r\n          (m) =>\r\n            m.idField === idField && availableFormFields.includes(m.formField)\r\n        )\r\n    );\r\n\r\n    // Display results\r\n    displayComparisonResults(comparisons, idOnlyFields);\r\n\r\n    // Return result for status message\r\n    return { comparisons, idOnlyFields };\r\n\r\n    // Display comparison results\r\n    displayComparisonResults(comparisons);\r\n  }\r\n\r\n  /**\r\n   * Display comparison results\r\n   */\r\n  /**\r\n   * Display comparison results\r\n   */\r\n  function displayComparisonResults(comparisons, _idOnlyFields = []) {\r\n    // If no comparisons possible, show extracted ID data only\r\n    if (!comparisons || comparisons.length === 0) {\r\n      if (extractedIdData && reviewGrid) {\r\n        let message =\r\n          '<div style=\"padding: 16px; background: var(--error-50); border: 1px solid var(--error-200); border-radius: 8px; margin-bottom: 20px; text-align: center;\">';\r\n        message +=\r\n          '<div style=\"color: var(--error-700); font-weight: 700; font-size: 1.1rem; margin-bottom: 4px;\">Picture is not clear or ID not valid</div>';\r\n        message +=\r\n          '<div style=\"color: var(--error-600); font-size: 0.9rem;\">We could not automatically verify your information. Please ensure the image is clear and you are using a valid PhilSys ID.</div></div>';\r\n\r\n        const extractedHtml = renderExtractedFieldsOnly(extractedIdData);\r\n        reviewGrid.innerHTML = message + extractedHtml;\r\n        review.hidden = false;\r\n        status(\r\n          \"Picture is not clear or ID not valid. Please try again.\",\r\n          \"error\"\r\n        );\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Count matches and mismatches\r\n    const _matches = comparisons.filter((c) => c.match).length;\r\n    const _mismatches = comparisons.filter((c) => !c.match).length;\r\n\r\n    // Check for ID Type validity (must be PhilID/PhilSys)\r\n    const isPhilId =\r\n      extractedIdData?.idType === \"philid\" ||\r\n      extractedIdData?.idType === \"philpost\";\r\n    // ^ Assuming philpost is also acceptable or adjust accordingly.\r\n    // If strict PhilSys request:\r\n    // const isPhilId = extractedIdData?.idType === 'philid';\r\n\r\n    // Determine overall status\r\n    // Fail if any REQUIRED field is a mismatch\r\n    const failedRequired = comparisons.filter((c) => c.required && !c.match);\r\n    const passed = failedRequired.length === 0 && isPhilId;\r\n\r\n    // Build the status HTML message based on specific failure modes\r\n    let statusHtml = \"\";\r\n\r\n    if (passed) {\r\n      statusHtml = `\r\n        <div style=\"padding: 16px; background: var(--success-50); border: 1px solid var(--success-200); border-radius: 8px; margin-bottom: 20px; text-align: center;\">\r\n          <div style=\"color: var(--success-700); font-weight: 700; font-size: 1.1rem; margin-bottom: 4px;\">Identity Confirmed</div>\r\n          <div style=\"color: var(--success-600); font-size: 0.9rem;\">Your ID matches your profile information.</div>\r\n        </div>\r\n      `;\r\n      sessionStorage.setItem(\"cl_verification_complete\", \"true\");\r\n      status(\"✓ Identity Confirmed.\", \"success\");\r\n    } else if (!isPhilId) {\r\n      statusHtml = `\r\n        <div style=\"padding: 16px; background: var(--error-50); border: 1px solid var(--error-200); border-radius: 8px; margin-bottom: 20px; text-align: center;\">\r\n          <div style=\"color: var(--error-700); font-weight: 700; font-size: 1.1rem; margin-bottom: 4px;\">ID Not Valid</div>\r\n          <div style=\"color: var(--error-600); font-size: 0.9rem;\">\r\n            Please use only a valid <strong>PhilSys ID</strong> (National ID).<br>\r\n            <span style=\"font-size: 0.8em; color: #666; display:inline-block; margin-top:4px;\">(Debug: Detected Type '${\r\n  extractedIdData?.idType || \"Unknown\"\r\n  }')</span>\r\n          </div>\r\n        </div>\r\n      `;\r\n      sessionStorage.removeItem(\"cl_verification_complete\");\r\n      status(\"ID Not Valid. Please use PhilSys ID.\", \"error\");\r\n    } else if (failedRequired.length > 0) {\r\n      // Identity didn't match (mismatches in required fields)\r\n      statusHtml = `\r\n        <div style=\"padding: 16px; background: var(--error-50); border: 1px solid var(--error-200); border-radius: 8px; margin-bottom: 20px; text-align: center;\">\r\n          <div style=\"color: var(--error-700); font-weight: 700; font-size: 1.1rem; margin-bottom: 4px;\">Identity Didn't Match</div>\r\n          <div style=\"color: var(--error-600); font-size: 0.9rem;\">\r\n            The information on your ID does not match the details you provided (${\r\n  failedRequired.length\r\n  } field${failedRequired.length !== 1 ? \"s\" : \"\"} mismatched).\r\n            <br>Please review your inputs or ensure the ID belongs to you.\r\n          </div>\r\n        </div>\r\n      `;\r\n      sessionStorage.removeItem(\"cl_verification_complete\");\r\n      status(\"Identity Didn't Match. Please review your details.\", \"error\");\r\n    } else {\r\n      // Fallback for unclear cases (e.g. low confidence but technically matched optional fields?)\r\n      statusHtml = `\r\n        <div style=\"padding: 16px; background: var(--warning-50); border: 1px solid var(--warning-200); border-radius: 8px; margin-bottom: 20px; text-align: center;\">\r\n          <div style=\"color: var(--warning-700); font-weight: 700; font-size: 1.1rem; margin-bottom: 4px;\">Picture is not clear</div>\r\n          <div style=\"color: var(--warning-600); font-size: 0.9rem;\">\r\n            Some fields could not be confidently verified. Please try uploading a clearer image.\r\n          </div>\r\n        </div>\r\n      `;\r\n      sessionStorage.removeItem(\"cl_verification_passed\");\r\n      status(\"Picture is not clear. Please try again.\", \"warning\");\r\n    }\r\n\r\n    // Update review section with comparison results\r\n    if (reviewGrid) {\r\n      const comparisonHtml = comparisons\r\n        .map((comp) => {\r\n          const matchIcon = comp.match\r\n            ? '<span style=\"color: var(--success-600); margin-right: 8px;\">✓</span>'\r\n            : '<span style=\"color: var(--error-600); margin-right: 8px;\">✗</span>';\r\n          const matchClass = comp.match ? \"match\" : \"mismatch\";\r\n          const safeField = escapeHtml(comp.field);\r\n          const safeIdValue = escapeHtml(comp.idValue);\r\n          const safeFormValue = escapeHtml(comp.formValue);\r\n          const scoreDisplay =\r\n            comp.type !== \"gender\"\r\n              ? `<span style=\"font-size: 0.8em; color: var(--gray-500); margin-left: auto;\">${comp.score}% Match</span>`\r\n              : \"\";\r\n\r\n          return `\r\n          <div class=\"comparison-item ${matchClass}\" style=\"margin-bottom: 12px; padding: 12px; border-radius: 6px; background: ${\r\n    comp.match ? \"rgba(34, 197, 94, 0.1)\" : \"rgba(239, 68, 68, 0.1)\"\r\n  }; border-left: 3px solid ${\r\n    comp.match ? \"var(--success-600)\" : \"var(--error-600)\"\r\n  };\">\r\n            <div style=\"font-weight: 600; margin-bottom: 8px; display: flex; align-items: center;\">\r\n              ${matchIcon}\r\n              <span>${safeField}</span>\r\n              ${scoreDisplay}\r\n            </div>\r\n            <div style=\"font-size: 0.9rem; color: var(--gray-700); margin-bottom: 4px;\">\r\n              <span style=\"font-weight: 500;\">ID:</span> ${safeIdValue}\r\n            </div>\r\n            <div style=\"font-size: 0.9rem; color: var(--gray-700);\">\r\n              <span style=\"font-weight: 500;\">Form:</span> ${safeFormValue}\r\n            </div>\r\n            ${\r\n  !comp.match && comp.type !== \"gender\"\r\n    ? '<div style=\"font-size: 0.8rem; color: var(--error-600); margin-top: 4px;\">Score below 85% threshold</div>'\r\n    : \"\"\r\n  }\r\n          </div>\r\n        `;\r\n        })\r\n        .join(\"\");\r\n\r\n      // Also show other extracted fields\r\n      const otherFieldsHtml = renderOtherExtractedFields(\r\n        extractedIdData,\r\n        comparisons\r\n      );\r\n\r\n      reviewGrid.innerHTML =\r\n        statusHtml +\r\n        comparisonHtml +\r\n        (otherFieldsHtml\r\n          ? `<div style=\"margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gray-300);\"><div style=\"font-weight: 600; margin-bottom: 12px;\">Other ID Information</div>${otherFieldsHtml}</div>`\r\n          : \"\");\r\n\r\n      // Enable the review details now that process is finished\r\n      review.hidden = false;\r\n      review.removeAttribute(\"disabled\");\r\n      const summaryElement = review.querySelector(\"summary\");\r\n      if (summaryElement) {\r\n        summaryElement.classList.remove(\"review-summary-disabled\");\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Render other extracted fields that aren't being compared (ID number, dates, etc.)\r\n   */\r\n  function renderOtherExtractedFields(idFields, _comparisons) {\r\n    if (!idFields) return \"\";\r\n\r\n    const comparedFields = [\r\n      \"firstName\",\r\n      \"lastName\",\r\n      \"middleName\",\r\n      \"addressLine1\",\r\n      \"barangay\",\r\n      \"sex\",\r\n    ];\r\n    const otherFields = Object.entries(idFields)\r\n      .filter(\r\n        ([key, value]) =>\r\n          !comparedFields.includes(key) &&\r\n          value != null &&\r\n          String(value).trim() !== \"\"\r\n      )\r\n      .map(([key, value]) => {\r\n        const fieldLabels = {\r\n          idNumber: \"ID Number\",\r\n          birthDate: \"Birth Date\",\r\n          expiryDate: \"Expiry Date\",\r\n          addressLine2: \"Address Line 2\",\r\n        };\r\n        const label =\r\n          fieldLabels[key] ||\r\n          key\r\n            .replace(/([A-Z])/g, \" $1\")\r\n            .replace(/^./, (str) => str.toUpperCase());\r\n        let displayValue = String(value).trim();\r\n\r\n        // Format dates\r\n        if (\r\n          (key === \"birthDate\" || key === \"expiryDate\") &&\r\n          displayValue.match(/^\\d{4}-\\d{2}-\\d{2}$/)\r\n        ) {\r\n          const date = new Date(displayValue);\r\n          displayValue = date.toLocaleDateString(\"en-US\", {\r\n            year: \"numeric\",\r\n            month: \"long\",\r\n            day: \"numeric\",\r\n          });\r\n        }\r\n\r\n        return { label, value: displayValue };\r\n      });\r\n\r\n    if (otherFields.length === 0) return \"\";\r\n\r\n    return otherFields\r\n      .map(({ label, value }) => {\r\n        const safeLabel = escapeHtml(label);\r\n        const safeValue = escapeHtml(value);\r\n        return `<div class=\"kv\" style=\"margin-bottom: 8px;\"><div class=\"k\">${safeLabel}</div><div class=\"v\">${safeValue}</div></div>`;\r\n      })\r\n      .join(\"\");\r\n  }\r\n\r\n  /**\r\n   * Render extracted fields only (when no comparison is possible)\r\n   */\r\n  function renderExtractedFieldsOnly(idFields) {\r\n    if (!idFields) return \"\";\r\n\r\n    const fieldLabels = {\r\n      firstName: \"First Name\",\r\n      lastName: \"Last Name\",\r\n      middleName: \"Middle Name\",\r\n      addressLine1: \"Address Line 1\",\r\n      addressLine2: \"Address Line 2\",\r\n      barangay: \"Barangay\",\r\n      sex: \"Sex/Gender\",\r\n      idNumber: \"ID Number\",\r\n      birthDate: \"Birth Date\",\r\n      expiryDate: \"Expiry Date\",\r\n    };\r\n\r\n    const entries = Object.entries(idFields)\r\n      .filter(([_k, v]) => v != null && String(v).trim() !== \"\")\r\n      .map(([k, v]) => {\r\n        const label =\r\n          fieldLabels[k] ||\r\n          k\r\n            .replace(/([A-Z])/g, \" $1\")\r\n            .replace(/^./, (str) => str.toUpperCase());\r\n        let value = String(v).trim();\r\n\r\n        // Format dates\r\n        if (\r\n          (k === \"birthDate\" || k === \"expiryDate\") &&\r\n          value.match(/^\\d{4}-\\d{2}-\\d{2}$/)\r\n        ) {\r\n          const date = new Date(value);\r\n          value = date.toLocaleDateString(\"en-US\", {\r\n            year: \"numeric\",\r\n            month: \"long\",\r\n            day: \"numeric\",\r\n          });\r\n        }\r\n\r\n        return { key: k, label, value };\r\n      });\r\n\r\n    if (entries.length === 0) return \"\";\r\n\r\n    return entries\r\n      .map(({ _key, label, value }) => {\r\n        const safeLabel = escapeHtml(label);\r\n        const safeValue = escapeHtml(value);\r\n        return `<div class=\"kv\" style=\"margin-bottom: 8px;\"><div class=\"k\">${safeLabel}</div><div class=\"v\">${safeValue}</div></div>`;\r\n      })\r\n      .join(\"\");\r\n  }\r\n\r\n  function status(text, kind = \"info\") {\r\n    if (!statusEl) return;\r\n    statusEl.textContent = text;\r\n    statusEl.style.color =\r\n      kind === \"error\"\r\n        ? \"var(--error-600)\"\r\n        : kind === \"success\"\r\n          ? \"var(--success-600)\"\r\n          : \"var(--gray-600)\";\r\n  }\r\n\r\n  function escapeHtml(s) {\r\n    return s.replace(\r\n      /[&<>\"]+/g,\r\n      (c) => ({ \"&\": \"&amp;\", \"<\": \"&lt;\", \">\": \"&gt;\", '\"': \"&quot;\" }[c])\r\n    );\r\n  }\r\n\r\n  // Re-run comparison when form fields change (if ID data is available)\r\n  const formFields = [\r\n    \"firstName\",\r\n    \"lastName\",\r\n    \"middleName\",\r\n    \"addressLine1\",\r\n    \"addressLine2\",\r\n    \"barangay\",\r\n    \"gender\",\r\n  ];\r\n  formFields.forEach((fieldId) => {\r\n    const field = qs(`#${fieldId}`);\r\n    if (field) {\r\n      field.addEventListener(\"input\", () => {\r\n        if (extractedIdData) {\r\n          compareWithFormData(extractedIdData);\r\n        }\r\n      });\r\n      field.addEventListener(\"change\", () => {\r\n        if (extractedIdData) {\r\n          compareWithFormData(extractedIdData);\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  // Initialize\r\n  setMode(\"upload\");\r\n\r\n  // Helper: Setup Secondary Doc Verification\r\n  function setupSecondaryVerification(lastName) {\r\n    const fileInput = document.getElementById(\"secondary-file-input\");\r\n    const verifyBtn = document.getElementById(\"verify-residency-btn\");\r\n    const removeBtn = document.getElementById(\"secondary-remove-btn\");\r\n    const previewBox = document.getElementById(\"secondary-file-preview\");\r\n    const filenameSpan = document.getElementById(\"secondary-filename\");\r\n    const statusDiv = document.getElementById(\"residency-status\");\r\n\r\n    if (!fileInput || !verifyBtn) return;\r\n\r\n    // Reset UI\r\n    fileInput.value = \"\";\r\n    verifyBtn.disabled = true;\r\n    previewBox.classList.add(\"hidden\");\r\n    statusDiv.innerHTML = \"\";\r\n    statusDiv.className = \"mt-2 text-center text-sm\";\r\n\r\n    // File Select Handler\r\n    fileInput.onchange = (e) => {\r\n      const file = e.target.files[0];\r\n      if (file) {\r\n        filenameSpan.textContent = file.name;\r\n        previewBox.classList.remove(\"hidden\");\r\n        verifyBtn.disabled = false;\r\n        statusDiv.innerHTML = \"\";\r\n      }\r\n    };\r\n\r\n    // Remove Handler\r\n    removeBtn.onclick = () => {\r\n      fileInput.value = \"\";\r\n      previewBox.classList.add(\"hidden\");\r\n      verifyBtn.disabled = true;\r\n      statusDiv.innerHTML = \"\";\r\n    };\r\n\r\n    // Verify Handler\r\n    verifyBtn.onclick = async () => {\r\n      const file = fileInput.files[0];\r\n      if (!file) return;\r\n\r\n      verifyBtn.disabled = true;\r\n      verifyBtn.textContent = \"Verifying...\";\r\n      statusDiv.textContent = \"Scanning document for 'Digos' and Name...\";\r\n      statusDiv.className = \"mt-2 text-center text-sm text-blue-600\";\r\n\r\n      try {\r\n        const formData = new FormData();\r\n        formData.append(\"file\", file);\r\n        formData.append(\"lastName\", lastName);\r\n\r\n        const res = await fetch(\"/api/ocr/verify-residency\", {\r\n          method: \"POST\",\r\n          body: formData,\r\n        });\r\n        const result = await res.json();\r\n\r\n        if (result.success && result.verified) {\r\n          // Success!\r\n          statusDiv.textContent = `✅ ${  result.message}`;\r\n          statusDiv.className =\r\n            \"mt-2 text-center text-sm text-green-600 font-bold\";\r\n\r\n          // Store secondary token if present\r\n          if (result.residencyToken) {\r\n            sessionStorage.setItem(\r\n              \"cl_verification_token\",\r\n              result.residencyToken\r\n            );\r\n          }\r\n\r\n          setTimeout(() => {\r\n            document.getElementById(\"secondary-doc-section\").hidden = true;\r\n            status(\"Residency Verified! Proceeding...\", \"success\");\r\n            // Proceed to form comparison (skipping address mismatch check effectively)\r\n            if (typeof extractedIdData === \"object\") {\r\n              extractedIdData.isMigrantVerified = true;\r\n            }\r\n            compareWithFormData(extractedIdData);\r\n          }, 1500);\r\n        } else {\r\n          // Failure\r\n          statusDiv.textContent =\r\n            `❌ ${  result.error || \"Verification failed\"}`;\r\n          statusDiv.className =\r\n            \"mt-2 text-center text-sm text-red-600 font-bold\";\r\n          verifyBtn.disabled = false;\r\n          verifyBtn.textContent = \"Verify Residency\";\r\n        }\r\n      } catch (e) {\r\n        console.error(\"Secondary Verify Error:\", e);\r\n        statusDiv.textContent = \"❌ System Error. Please try again.\";\r\n        statusDiv.className = \"mt-2 text-center text-sm text-red-600\";\r\n        verifyBtn.disabled = false;\r\n        verifyBtn.textContent = \"Verify Residency\";\r\n      }\r\n    };\r\n  }\r\n\r\n  updateScanEnabled();\r\n})();\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\services\\toastNotificationService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\sessionActivity.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\signup-modal.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected alert.","line":49,"column":5,"nodeType":"CallExpression","messageId":"unexpected","endLine":49,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"document.addEventListener(\"click\", (e) => {\n  console.log(\"Click detected on:\", e.target.tagName, e.target.className, e.target.getAttribute(\"data-open-terms\"), e.target.getAttribute(\"data-open-privacy\"));\n  // Check for terms link first\n  if (e.target.matches(\"[data-open-terms]\") || e.target.closest(\"[data-open-terms]\")) {\n    console.log(\"Opening terms modal\");\n    e.preventDefault();\n    const termsModal = document.getElementById(\"termsModal\");\n    console.log(\"Terms modal found:\", Boolean(termsModal));\n    if (termsModal) {\n      console.log(\"Before setting styles - display:\", termsModal.style.display);\n      termsModal.style.display = \"block\";\n      termsModal.style.visibility = \"visible\";\n      termsModal.style.opacity = \"1\";\n      termsModal.style.position = \"fixed\";\n      termsModal.style.top = \"0\";\n      termsModal.style.left = \"0\";\n      termsModal.style.width = \"100%\";\n      termsModal.style.height = \"100%\";\n      termsModal.style.zIndex = \"9999999\";\n      termsModal.style.backgroundColor = \"rgba(0,0,0,0.5)\"; // Proper dark overlay\n    }\n    return; // Important: return to prevent other handlers\n  }\n  // Check for privacy link\n  if (e.target.matches(\"[data-open-privacy]\") || e.target.closest(\"[data-open-privacy]\")) {\n    e.preventDefault();\n    const privacyModal = document.getElementById(\"privacyModal\");\n    if (privacyModal) {\n      privacyModal.style.display = \"block\";\n      privacyModal.style.visibility = \"visible\";\n      privacyModal.style.opacity = \"1\";\n      privacyModal.style.position = \"fixed\";\n      privacyModal.style.top = \"0\";\n      privacyModal.style.left = \"0\";\n      privacyModal.style.width = \"100%\";\n      privacyModal.style.height = \"100%\";\n      privacyModal.style.zIndex = \"9999999\";\n      privacyModal.style.backgroundColor = \"rgba(0,0,0,0.5)\"; // Proper dark overlay\n    }\n    return; // Important: return to prevent other handlers\n  }\n  if (e.target.matches(\"[data-modal]\")) {\n    document.getElementById(e.target.getAttribute(\"data-modal\")).style.display = \"none\";\n  }\n  if (e.target.matches(\"[data-accept]\")) {\n    document.getElementById(\"terms-checkbox\").checked = true;\n    const modalId = e.target.getAttribute(\"data-accept\") === \"terms\" ? \"termsModal\" : \"privacyModal\";\n    document.getElementById(modalId).style.display = \"none\";\n    alert(\"Accepted!\");\n  }\n});\n// Close on outside click\nwindow.onclick = function(event) {\n  if (event.target.classList.contains(\"modal\")) {\n    event.target.style.display = \"none\";\n  }\n};\nconsole.log(\"Signup modal event listeners attached\");\n// Phone number validation - only allow numbers\ndocument.addEventListener(\"input\", (e) => {\n  if (e.target.id === \"mobile\") {\n    // Remove any non-numeric characters\n    e.target.value = e.target.value.replace(/[^0-9]/g, \"\");\n    // Limit to 10 digits\n    if (e.target.value.length > 10) {\n      e.target.value = e.target.value.slice(0, 10);\n    }\n  }\n});\n// Prevent non-numeric input on keypress\ndocument.addEventListener(\"keypress\", (e) => {\n  if (e.target.id === \"mobile\") {\n    // Allow: backspace, delete, tab, escape, enter\n    if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||\n            // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X\n            (e.keyCode === 65 && e.ctrlKey === true) ||\n            (e.keyCode === 67 && e.ctrlKey === true) ||\n            (e.keyCode === 86 && e.ctrlKey === true) ||\n            (e.keyCode === 88 && e.ctrlKey === true)) {\n      return;\n    }\n    // Ensure that it is a number and stop the keypress\n    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {\n      e.preventDefault();\n    }\n  }\n});\n// Prevent paste of non-numeric content\ndocument.addEventListener(\"paste\", (e) => {\n  if (e.target.id === \"mobile\") {\n    e.preventDefault();\n    const paste = (e.clipboardData || window.clipboardData).getData(\"text\");\n    const numericOnly = paste.replace(/[^0-9]/g, \"\").slice(0, 10);\n    e.target.value = numericOnly;\n  }\n});\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\super-admin\\dashboard.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":617,"column":10,"nodeType":"CallExpression","messageId":"unexpected","endLine":619,"endColumn":10},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\\".","line":786,"column":19,"nodeType":"TemplateElement","messageId":"unnecessaryEscape","endLine":786,"endColumn":20,"suggestions":[{"messageId":"removeEscape","fix":{"range":[27101,27102],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[27101,27101],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\\".","line":786,"column":75,"nodeType":"TemplateElement","messageId":"unnecessaryEscape","endLine":786,"endColumn":76,"suggestions":[{"messageId":"removeEscape","fix":{"range":[27157,27158],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[27157,27157],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\\".","line":809,"column":15,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":809,"endColumn":16,"suggestions":[{"messageId":"removeEscape","fix":{"range":[27687,27688],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[27687,27687],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Super Admin Dashboard\r\n * System-wide management interface\r\n */\r\nimport showMessage from \"../components/toast.js\";\r\n\r\n// Check for OAuth success message\r\nconst oauthSuccessMessage = sessionStorage.getItem(\"oauth_success_message\");\r\nif (oauthSuccessMessage) {\r\n  sessionStorage.removeItem(\"oauth_success_message\");\r\n  showMessage(\"success\", oauthSuccessMessage, 5000);\r\n}\r\n\r\n// Initialize dashboard\r\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\r\n  await loadDashboardData();\r\n  await loadRoleCounts();\r\n  await loadLatestUsers();\r\n  await loadRoleDistribution();\r\n  await loadApiHealth();\r\n  await loadLogs();\r\n  startTrafficMonitor();\r\n\r\n  // Setup refresh button event listeners\r\n  const refreshRoleDistributionBtn = document.getElementById(\r\n    \"refresh-role-distribution-btn\"\r\n  );\r\n  if (refreshRoleDistributionBtn) {\r\n    refreshRoleDistributionBtn.addEventListener(\"click\", loadRoleDistribution);\r\n  }\r\n\r\n  const refreshLatestUsersBtn = document.getElementById(\r\n    \"refresh-latest-users-btn\"\r\n  );\r\n  if (refreshLatestUsersBtn) {\r\n    refreshLatestUsersBtn.addEventListener(\"click\", loadLatestUsers);\r\n  }\r\n\r\n  // Setup help button (placeholder for future implementation)\r\n  const getHelpBtn = document.getElementById(\"get-help-btn\");\r\n  if (getHelpBtn) {\r\n    getHelpBtn.addEventListener(\"click\", () => {\r\n      showMessage(\"info\", \"Help feature coming soon\");\r\n    });\r\n  }\r\n});\r\n\r\n// Chart instance for role distribution\r\nlet roleDistributionChart = null;\r\n/**\r\n * Load department roles dynamically\r\n */\r\nasync function _loadDepartmentRoles() {\r\n  try {\r\n    const apiClient = (await import(\"../config/apiClient.js\")).default;\r\n    // Prefer the explicit endpoint that exists in routes\r\n    let departments = [];\r\n    try {\r\n      const res = await apiClient.get(\r\n        \"/api/department-structure/departments/all\"\r\n      );\r\n      if (res && res.success && Array.isArray(res.data)) {\r\n        departments = res.data;\r\n      }\r\n    } catch {}\r\n    // Fallback to categories tree if needed\r\n    if (!departments.length) {\r\n      const res2 = await apiClient.get(\"/api/department-structure/categories\");\r\n      if (res2 && res2.success && Array.isArray(res2.data)) {\r\n        departments = [];\r\n        res2.data.forEach((cat) =>\r\n          cat.subcategories?.forEach((sc) =>\r\n            sc.departments?.forEach((d) => departments.push(d))\r\n          )\r\n        );\r\n      }\r\n    }\r\n    // departments loaded via one of the endpoints above\r\n    // Load role swap dropdown\r\n    const roleSwapSelect = document.getElementById(\"role-swap-role\");\r\n    if (roleSwapSelect) {\r\n      const loadingEl = document.getElementById(\"department-roles-loading\");\r\n      if (loadingEl) loadingEl.remove();\r\n      departments.forEach((dept) => {\r\n        // Add officer role\r\n        const officerOption = document.createElement(\"option\");\r\n        officerOption.value = `lgu-${dept.code.toLowerCase()}`;\r\n        officerOption.textContent = `LGU Officer - ${dept.name} (${dept.code})`;\r\n        roleSwapSelect.appendChild(officerOption);\r\n        // Add admin role\r\n        const adminOption = document.createElement(\"option\");\r\n        adminOption.value = `lgu-admin-${dept.code.toLowerCase()}`;\r\n        adminOption.textContent = `LGU Admin - ${dept.name}`;\r\n        roleSwapSelect.appendChild(adminOption);\r\n      });\r\n    }\r\n    // Load assign citizen dropdown\r\n    const assignCitizenSelect = document.getElementById(\"assign-citizen-role\");\r\n    if (assignCitizenSelect) {\r\n      const loadingEl = document.getElementById(\"assign-citizen-roles-loading\");\r\n      if (loadingEl) loadingEl.remove();\r\n      departments.forEach((dept) => {\r\n        // Add officer role\r\n        const officerOption = document.createElement(\"option\");\r\n        officerOption.value = `lgu-${dept.code.toLowerCase()}`;\r\n        officerOption.textContent = `LGU Officer - ${dept.name} (${dept.code})`;\r\n        assignCitizenSelect.appendChild(officerOption);\r\n        // Add admin role\r\n        const adminOption = document.createElement(\"option\");\r\n        adminOption.value = `lgu-admin-${dept.code.toLowerCase()}`;\r\n        adminOption.textContent = `LGU Admin - ${dept.name}`;\r\n        assignCitizenSelect.appendChild(adminOption);\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Error loading department roles:\", error);\r\n    // Show error in loading placeholders\r\n    const loadingEls = document.querySelectorAll('[id$=\"-loading\"]');\r\n    loadingEls.forEach((el) => {\r\n      el.innerHTML = '<option value=\"\">Error loading departments</option>';\r\n    });\r\n  }\r\n}\r\n/**\r\n * Load dashboard data\r\n */\r\nasync function loadDashboardData() {\r\n  try {\r\n    const [statsResponse, dashboardResponse] = await Promise.all([\r\n      fetch(\"/api/superadmin/statistics\"),\r\n      fetch(\"/api/superadmin/dashboard\"),\r\n    ]);\r\n    const [statsResult, dashboardResult] = await Promise.all([\r\n      statsResponse.json(),\r\n      dashboardResponse.json(),\r\n    ]);\r\n    if (statsResult.success) {\r\n      updateStatistics(statsResult.statistics);\r\n    }\r\n    if (dashboardResult.success) {\r\n      // Additional dashboard data if needed\r\n      // console.log removed for security\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Load dashboard error:\", error);\r\n  }\r\n}\r\n/**\r\n * Update statistics display\r\n */\r\nfunction updateStatistics(stats) {\r\n  document.getElementById(\"stat-complaints\").textContent =\r\n    stats.total_complaints || 0;\r\n  document.getElementById(\"stat-role-changes\").textContent =\r\n    stats.total_role_changes || 0;\r\n  document.getElementById(\"stat-dept-transfers\").textContent =\r\n    stats.total_department_transfers || 0;\r\n}\r\n/**\r\n * Load role counts (users, admins, hr, officers)\r\n */\r\nasync function loadRoleCounts() {\r\n  try {\r\n    const _res = await fetch(\"/api/superadmin/users?limit=1\");\r\n    const metaRes = await fetch(\"/api/superadmin/users?limit=1000\");\r\n    const meta = await metaRes.json();\r\n    const users = meta.success && Array.isArray(meta.data) ? meta.data : [];\r\n    const totalUsers = users.length;\r\n    // Admins: count LGU admins only (exclude super-admin)\r\n    const admins = users.filter((u) =>\r\n      /^lgu-admin/.test(String(u.role || \"\").toLowerCase())\r\n    ).length;\r\n    // HR: include lgu-hr variants\r\n    const hr = users.filter(\r\n      (u) =>\r\n        String(u.role || \"\").toLowerCase() === \"lgu-hr\" ||\r\n        /^lgu-hr/.test(String(u.role || \"\").toLowerCase())\r\n    ).length;\r\n    // Officers: include simplified 'lgu' and legacy lgu-* (excluding admin/hr)\r\n    const roleStr = (r) => String(r || \"\").toLowerCase();\r\n    const officers = users.filter((u) => {\r\n      const r = roleStr(u.role);\r\n      return r === \"lgu\" || /^lgu-(?!admin|hr)/.test(r);\r\n    }).length;\r\n    setText(\"stat-users\", totalUsers);\r\n    setText(\"stat-admins\", admins);\r\n    setText(\"stat-hr\", hr);\r\n    setText(\"stat-officers\", officers);\r\n  } catch (e) {\r\n    // ignore\r\n  }\r\n}\r\nfunction setText(id, v) {\r\n  const el = document.getElementById(id);\r\n  if (el) el.textContent = String(v);\r\n}\r\n/**\r\n * Load role distribution and render pie chart\r\n */\r\nwindow.loadRoleDistribution = async function loadRoleDistribution() {\r\n  try {\r\n    const response = await fetch(\"/api/superadmin/role-distribution\");\r\n    const result = await response.json();\r\n\r\n    if (!result.success || !result.distribution) {\r\n      console.error(\r\n        \"[SUPER_ADMIN] Failed to load role distribution:\",\r\n        result.error\r\n      );\r\n      return;\r\n    }\r\n\r\n    const { citizens, hr, officers, admins } = result.distribution;\r\n    renderRoleDistributionChart({ citizens, hr, officers, admins });\r\n  } catch (error) {\r\n    console.error(\"[SUPER_ADMIN] Load role distribution error:\", error);\r\n  }\r\n};\r\n\r\n/**\r\n * Render role distribution pie chart (Super Admin)\r\n */\r\nfunction renderRoleDistributionChart(data) {\r\n  const canvas = document.getElementById(\"role-distribution-chart\");\r\n  if (!canvas) return;\r\n\r\n  const ctx = canvas.getContext(\"2d\");\r\n\r\n  // Destroy existing chart if it exists\r\n  if (roleDistributionChart) {\r\n    roleDistributionChart.destroy();\r\n  }\r\n\r\n  const values = [\r\n    data.citizens || 0,\r\n    data.hr || 0,\r\n    data.officers || 0,\r\n    data.admins || 0,\r\n  ];\r\n  const total = values.reduce((a, b) => a + b, 0);\r\n\r\n  const chartData = {\r\n    labels: [\r\n      `Citizens (${values[0]})`,\r\n      `HR (${values[1]})`,\r\n      `Officers (${values[2]})`,\r\n      `Admins (${values[3]})`,\r\n    ],\r\n    datasets: [\r\n      {\r\n        data: values,\r\n        backgroundColor: [\r\n          \"#3b82f6\", // Blue for Citizens\r\n          \"#10b981\", // Green for HR\r\n          \"#f59e0b\", // Orange for Officers\r\n          \"#8b5cf6\", // Purple for Admins\r\n        ],\r\n        borderColor: \"#ffffff\",\r\n        borderWidth: 2,\r\n      },\r\n    ],\r\n  };\r\n\r\n  roleDistributionChart = new Chart(ctx, {\r\n    type: \"pie\",\r\n    data: chartData,\r\n    options: {\r\n      responsive: true,\r\n      maintainAspectRatio: true,\r\n      plugins: {\r\n        legend: {\r\n          position: \"bottom\",\r\n          labels: {\r\n            padding: 15,\r\n            font: {\r\n              size: 14,\r\n            },\r\n            generateLabels(chart) {\r\n              const { data } = chart;\r\n              if (data.labels.length && data.datasets.length) {\r\n                return data.labels.map((label, i) => {\r\n                  const value = data.datasets[0].data[i];\r\n                  const percentage =\r\n                    total > 0 ? ((value / total) * 100).toFixed(1) : 0;\r\n                  return {\r\n                    text: `${label} - ${percentage}%`,\r\n                    fillStyle: data.datasets[0].backgroundColor[i],\r\n                    strokeStyle: data.datasets[0].borderColor,\r\n                    lineWidth: data.datasets[0].borderWidth,\r\n                    hidden: false,\r\n                    index: i,\r\n                  };\r\n                });\r\n              }\r\n              return [];\r\n            },\r\n          },\r\n        },\r\n        tooltip: {\r\n          callbacks: {\r\n            label(context) {\r\n              const label = context.label || \"\";\r\n              const value = context.parsed || 0;\r\n              const total = context.dataset.data.reduce((a, b) => a + b, 0);\r\n              const percentage =\r\n                total > 0 ? ((value / total) * 100).toFixed(1) : 0;\r\n              return `${label.split(\" (\")[0]}: ${value} users (${percentage}%)`;\r\n            },\r\n          },\r\n        },\r\n      },\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * Load latest registered users\r\n */\r\nwindow.loadLatestUsers = async function () {\r\n  try {\r\n    const container = document.getElementById(\"latest-users-container\");\r\n    if (!container) return;\r\n\r\n    // Show loading state\r\n    container.innerHTML = `\r\n      <div class=\"loading\">\r\n        <div class=\"spinner\"></div>\r\n        <p>Loading latest users...</p>\r\n      </div>\r\n    `;\r\n\r\n    const response = await fetch(\"/api/superadmin/latest-users?limit=5\");\r\n    const result = await response.json();\r\n\r\n    if (result.success && result.users) {\r\n      displayLatestUsers(result.users);\r\n    } else {\r\n      container.innerHTML = `<p class=\"empty-state\" style=\"color: #ef4444;\">Failed to load users: ${\r\n        result.error || \"Unknown error\"\r\n      }</p>`;\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Load latest users error:\", error);\r\n    const container = document.getElementById(\"latest-users-container\");\r\n    if (container) {\r\n      container.innerHTML =\r\n        '<p class=\"empty-state\" style=\"color: #ef4444;\">Failed to load latest users</p>';\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Display latest registered users\r\n */\r\nfunction displayLatestUsers(users) {\r\n  const container = document.getElementById(\"latest-users-container\");\r\n  if (!container) return;\r\n\r\n  if (users.length === 0) {\r\n    container.innerHTML =\r\n      '<p class=\"empty-state\">No registered users found</p>';\r\n    return;\r\n  }\r\n\r\n  const html = `\r\n    <div class=\"latest-users-list\">\r\n      ${users\r\n    .map((user) => {\r\n      const registrationDate = new Date(user.created_at).toLocaleString();\r\n      const emailConfirmedDate = user.email_confirmed_at\r\n        ? new Date(user.email_confirmed_at).toLocaleString()\r\n        : null;\r\n      const authMethod = user.is_oauth ? \"OAuth\" : \"Email\";\r\n      const roleBadge = user.role || \"citizen\";\r\n\r\n      return `\r\n          <div class=\"user-item\" style=\"display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid #e5e7eb; gap: 1rem;\">\r\n            <div style=\"flex: 1;\">\r\n              <div style=\"display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;\">\r\n                <div style=\"width: 40px; height: 40px; border-radius: 50%; background: #3b82f6; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.1rem;\">\r\n                  ${(user.name || user.email || \"U\").charAt(0).toUpperCase()}\r\n                </div>\r\n                <div>\r\n                  <div style=\"font-weight: 600; color: #111827; margin-bottom: 0.25rem;\">\r\n                    ${user.name || user.email || \"Unknown User\"}\r\n                  </div>\r\n                  <div style=\"font-size: 0.875rem; color: #6b7280;\">\r\n                    ${user.email || \"No email\"}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              <div style=\"display: flex; gap: 1rem; font-size: 0.875rem; color: #6b7280; flex-wrap: wrap;\">\r\n                <span><strong>Role:</strong> ${roleBadge}</span>\r\n                <span><strong>Method:</strong> ${authMethod}</span>\r\n                ${\r\n  emailConfirmedDate\r\n    ? `<span><strong>Confirmed:</strong> ${emailConfirmedDate}</span>`\r\n    : \"\"\r\n}\r\n              </div>\r\n            </div>\r\n            <div style=\"text-align: right; font-size: 0.875rem; color: #6b7280;\">\r\n              <div style=\"font-weight: 500; color: #111827; margin-bottom: 0.25rem;\">Registered</div>\r\n              <div>${registrationDate}</div>\r\n            </div>\r\n          </div>\r\n        `;\r\n    })\r\n    .join(\"\")}\r\n    </div>\r\n  `;\r\n\r\n  container.innerHTML = html;\r\n}\r\n/**\r\n * API Health\r\n */\r\nasync function loadApiHealth() {\r\n  const el = document.getElementById(\"api-health-status\");\r\n  const indicator = document.getElementById(\"api-health-indicator\");\r\n  if (!el) return;\r\n  try {\r\n    const res = await fetch(\"/api/health\");\r\n    const data = await res.json();\r\n    if (data && data.success) {\r\n      el.textContent = `Healthy • ${new Date(data.timestamp).toLocaleString()}`;\r\n      el.style.color = \"#10b981\";\r\n      if (indicator) {\r\n        indicator.style.background = \"#10b981\";\r\n      }\r\n    } else {\r\n      el.textContent = \"Unhealthy\";\r\n      el.style.color = \"#ef4444\";\r\n      if (indicator) {\r\n        indicator.style.background = \"#ef4444\";\r\n      }\r\n    }\r\n  } catch {\r\n    el.textContent = \"Health check failed\";\r\n    el.style.color = \"#ef4444\";\r\n    if (indicator) {\r\n      indicator.style.background = \"#ef4444\";\r\n    }\r\n  }\r\n  const btn = document.getElementById(\"btn-refresh-health\");\r\n  if (btn) btn.onclick = loadApiHealth;\r\n}\r\n/**\r\n * Traffic monitor using rate-limit status (proxy for request volume)\r\n */\r\nfunction startTrafficMonitor() {\r\n  const graph = document.getElementById(\"traffic-graph\");\r\n  const meta = document.getElementById(\"traffic-meta\");\r\n  if (!graph || !meta) return;\r\n  const bars = [];\r\n  async function tick() {\r\n    try {\r\n      const res = await fetch(\"/api/rate-limit/status\");\r\n      const data = await res.json();\r\n      const requests = (data && data.status && data.status.requests) || 0;\r\n      bars.push(requests);\r\n      if (bars.length > 60) bars.shift();\r\n      renderBars(bars, graph);\r\n      meta.textContent = `Requests in window: ${requests}, Remaining: ${\r\n        (data && data.status && data.status.remaining) || \"-\"\r\n      }`;\r\n    } catch {}\r\n  }\r\n  tick();\r\n  setInterval(tick, 1000);\r\n}\r\nfunction renderBars(values, container) {\r\n  const max = Math.max(1, ...values);\r\n  container.innerHTML = values\r\n    .map((v) => {\r\n      const h = Math.round((v / max) * 100);\r\n      return `<div style=\"width: 8px; height:${h}%; background:#3b82f6; border-radius:2px;\"></div>`;\r\n    })\r\n    .join(\"\");\r\n}\r\n/**\r\n * Load system logs\r\n */\r\nwindow.loadLogs = async function () {\r\n  try {\r\n    const logType = document.getElementById(\"log-type-filter\").value;\r\n    const response = await fetch(\r\n      `/api/superadmin/logs?log_type=${logType}&limit=50`\r\n    );\r\n    const result = await response.json();\r\n    if (result.success) {\r\n      displayLogs(result.logs);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Load logs error:\", error);\r\n    const container = document.getElementById(\"logs-container\");\r\n    if (container) {\r\n      container.innerHTML =\r\n        '<p class=\"empty-state\" style=\"color: #ef4444;\">Failed to load logs</p>';\r\n    }\r\n  }\r\n};\r\n/**\r\n * Display logs\r\n */\r\nfunction displayLogs(logs) {\r\n  const container = document.getElementById(\"logs-container\");\r\n  const allLogs = [];\r\n  // Combine all log types\r\n  if (logs.role_changes) {\r\n    logs.role_changes.forEach((log) => {\r\n      allLogs.push({ ...log, log_type: \"role_change\" });\r\n    });\r\n  }\r\n  if (logs.department_transfers) {\r\n    logs.department_transfers.forEach((log) => {\r\n      allLogs.push({ ...log, log_type: \"dept_transfer\" });\r\n    });\r\n  }\r\n  if (logs.complaint_workflow) {\r\n    logs.complaint_workflow.forEach((log) => {\r\n      allLogs.push({ ...log, log_type: \"complaint\" });\r\n    });\r\n  }\r\n  // Sort by date\r\n  allLogs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));\r\n  if (allLogs.length === 0) {\r\n    container.innerHTML = '<p class=\"empty-state\">No logs found</p>';\r\n    return;\r\n  }\r\n  const html = allLogs\r\n    .slice(0, 50)\r\n    .map((log) => formatLogEntry(log))\r\n    .join(\"\");\r\n  container.innerHTML = html;\r\n}\r\n/**\r\n * Format log entry\r\n */\r\nfunction formatLogEntry(log) {\r\n  const date = new Date(log.created_at).toLocaleString();\r\n  let content = \"\";\r\n  let typeLabel = \"\";\r\n  let typeColor = \"#667eea\";\r\n  if (log.log_type === \"role_change\") {\r\n    typeLabel = \"Role Change\";\r\n    typeColor = \"#3498db\";\r\n    const userEmail = log.user?.email || \"Unknown\";\r\n    const performerEmail = log.performer?.email || \"System\";\r\n    content = `\r\n      <strong>${userEmail}</strong>: ${log.old_role} → ${log.new_role}\r\n      <div style=\"color: #64748b; font-size: 0.875rem; margin-top: 0.5rem;\">By: ${performerEmail}</div>\r\n      ${\r\n  log.metadata?.reason\r\n    ? `<div style=\"margin-top: 0.5rem; color: #64748b; font-size: 0.875rem;\">Reason: ${log.metadata.reason}</div>`\r\n    : \"\"\r\n}\r\n    `;\r\n  } else if (log.log_type === \"dept_transfer\") {\r\n    typeLabel = \"Dept Transfer\";\r\n    typeColor = \"#f59e0b\";\r\n    const userEmail = log.user?.email || \"Unknown\";\r\n    const performerEmail = log.performer?.email || \"System\";\r\n    content = `\r\n      <strong>${userEmail}</strong>: ${log.from_department || \"N/A\"} → ${\r\n  log.to_department\r\n}\r\n      <div style=\"color: #64748b; font-size: 0.875rem; margin-top: 0.5rem;\">By: ${performerEmail}</div>\r\n      ${\r\n  log.reason\r\n    ? `<div style=\"margin-top: 0.5rem; color: #64748b; font-size: 0.875rem;\">Reason: ${log.reason}</div>`\r\n    : \"\"\r\n}\r\n    `;\r\n  } else if (log.log_type === \"complaint\") {\r\n    typeLabel = \"Complaint\";\r\n    typeColor = \"#10b981\";\r\n    content = `\r\n      <strong>${\r\n  log.action_type\r\n}</strong>: Complaint #${log.complaint_id?.substring(0, 8)}...\r\n      ${\r\n  log.details\r\n    ? `<div style=\"margin-top: 0.5rem; color: #64748b; font-size: 0.875rem;\">${JSON.stringify(\r\n      log.details\r\n    )}</div>`\r\n    : \"\"\r\n}\r\n    `;\r\n  }\r\n\r\n  return `\r\n    <div class=\"log-entry\">\r\n      <div class=\"log-entry-header\">\r\n        <span class=\"log-type\" style=\"background: ${typeColor};\">${typeLabel}</span>\r\n        <span class=\"log-entry-date\">${date}</span>\r\n      </div>\r\n      <div class=\"log-entry-content\">${content}</div>\r\n    </div>\r\n  `;\r\n}\r\n\r\n/**\r\n * Setup form handlers\r\n */\r\nfunction _setupFormHandlers() {\r\n  // Role Swap\r\n  document\r\n    .getElementById(\"role-swap-form\")\r\n    .addEventListener(\"submit\", async (e) => {\r\n      e.preventDefault();\r\n      const userId = document.getElementById(\"role-swap-user\").value;\r\n      const newRole = document.getElementById(\"role-swap-role\").value;\r\n      const reason = document.getElementById(\"role-swap-reason\").value;\r\n\r\n      if (\r\n        !confirm(\r\n          `Are you sure you want to change this user's role to ${newRole}?`\r\n        )\r\n      ) {\r\n        return;\r\n      }\r\n      await performRoleSwap(userId, newRole, reason);\r\n    });\r\n  // Department Transfer\r\n  document\r\n    .getElementById(\"dept-transfer-form\")\r\n    .addEventListener(\"submit\", async (e) => {\r\n      e.preventDefault();\r\n      const userId = document.getElementById(\"dept-transfer-user\").value;\r\n      const fromDept = document.getElementById(\"dept-transfer-from\").value;\r\n      const toDept = document.getElementById(\"dept-transfer-to\").value;\r\n      const reason = document.getElementById(\"dept-transfer-reason\").value;\r\n      await transferDepartment(userId, fromDept, toDept, reason);\r\n    });\r\n  // Assign Citizen\r\n  document\r\n    .getElementById(\"assign-citizen-form\")\r\n    .addEventListener(\"submit\", async (e) => {\r\n      e.preventDefault();\r\n      const userId = document.getElementById(\"assign-citizen-user\").value;\r\n      const role = document.getElementById(\"assign-citizen-role\").value;\r\n      const department = document.getElementById(\"assign-citizen-dept\").value;\r\n      const reason = document.getElementById(\"assign-citizen-reason\").value;\r\n      await assignCitizen(userId, role, department, reason);\r\n    });\r\n  // Log type filter change\r\n  document.getElementById(\"log-type-filter\").addEventListener(\"change\", () => {\r\n    loadLogs();\r\n  });\r\n}\r\nfunction _setupUserSearchSA() {\r\n  const btn = document.getElementById(\"sa-user-search-btn\");\r\n  const input = document.getElementById(\"sa-user-search\");\r\n  const brgy = document.getElementById(\"sa-user-barangay\");\r\n  async function run() {\r\n    const q = encodeURIComponent(input?.value || \"\");\r\n    const b = encodeURIComponent(brgy?.value || \"\");\r\n    const url = `/api/superadmin/users?search=${q}${b ? `&barangay=${b}` : \"\"}`;\r\n    try {\r\n      const res = await fetch(url);\r\n      const result = await res.json();\r\n      if (result.success) {\r\n        renderUserListSA(result.data || []);\r\n      } else {\r\n        renderUserListSA([]);\r\n      }\r\n    } catch (e) {\r\n      console.error(\"[SUPERADMIN] user search error:\", e);\r\n      renderUserListSA([]);\r\n    }\r\n  }\r\n  if (btn) btn.addEventListener(\"click\", run);\r\n  if (input)\r\n    input.addEventListener(\"keypress\", (e) => {\r\n      if (e.key === \"Enter\") run();\r\n    });\r\n}\r\nfunction renderUserListSA(users) {\r\n  const list = document.getElementById(\"sa-user-list\");\r\n  if (!list) return;\r\n  if (!users.length) {\r\n    list.innerHTML = '<p class=\"empty-state\">No users found.</p>';\r\n    return;\r\n  }\r\n  list.innerHTML = users\r\n    .map(\r\n      (u) => `\r\n    <div class=\"user-item\" data-user-id=\"${u.id}\">\r\n      <div><strong>${escapeHtml(u.fullName || u.name || u.email)}</strong></div>\r\n      <div style=\"color:#64748b; font-size:0.875rem; margin-top:0.25rem;\">${escapeHtml(\r\n    u.email || \"\"\r\n  )}</div>\r\n      <div style=\"color:#64748b; font-size:0.875rem; margin-top:0.25rem;\">Role: ${escapeHtml(\r\n    u.role || \"\"\r\n  )} | Brgy: ${escapeHtml(u.address?.barangay || \"-\")}</div>\r\n    </div>\r\n  `\r\n    )\r\n    .join(\"\");\r\n  list.querySelectorAll(\".user-item\").forEach((el) => {\r\n    el.addEventListener(\"click\", async () => {\r\n      const id = el.getAttribute(\"data-user-id\");\r\n      await loadUserDetailsSA(id);\r\n      await loadUserComplaintsSA(id);\r\n    });\r\n  });\r\n}\r\nasync function loadUserDetailsSA(userId) {\r\n  try {\r\n    const res = await fetch(`/api/superadmin/users/${userId}`);\r\n    const result = await res.json();\r\n    const container = document.getElementById(\"sa-user-details\");\r\n    if (!container) return;\r\n    if (result.success && result.data) {\r\n      const u = result.data;\r\n      container.innerHTML = `\r\n        <div style=\"display:flex; gap:1rem; align-items:center; margin-bottom:1rem;\">\r\n          <div style=\"width:48px; height:48px; border-radius:50%; background:#e2e8f0; display:flex; align-items:center; justify-content:center; font-size:1.5rem;\">👤</div>\r\n          <div>\r\n            <div style=\"font-weight:700; font-size:1.125rem; color:#1e293b;\">${escapeHtml(\r\n    u.fullName || u.name || u.email\r\n  )}</div>\r\n            <div style=\"color:#64748b; font-size:0.875rem;\">${escapeHtml(\r\n    u.email || \"\"\r\n  )}</div>\r\n          </div>\r\n        </div>\r\n        <div style=\"display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; padding-top:1rem; border-top:1px solid #e2e8f0;\">\r\n          <div><strong style=\"color:#1e293b;\">Role:</strong> <span style=\"color:#64748b;\">${escapeHtml(\r\n    u.role || \"-\"\r\n  )}</span></div>\r\n          <div><strong style=\"color:#1e293b;\">Department:</strong> <span style=\"color:#64748b;\">${escapeHtml(\r\n    u.department || \"-\"\r\n  )}</span></div>\r\n          <div><strong style=\"color:#1e293b;\">Barangay:</strong> <span style=\"color:#64748b;\">${escapeHtml(\r\n    u.address?.barangay || \"-\"\r\n  )}</span></div>\r\n          <div><strong style=\"color:#1e293b;\">City:</strong> <span style=\"color:#64748b;\">${escapeHtml(\r\n    u.address?.city || \"-\"\r\n  )}</span></div>\r\n          <div><strong style=\"color:#1e293b;\">Mobile:</strong> <span style=\"color:#64748b;\">${escapeHtml(\r\n    u.mobileNumber || \"-\"\r\n  )}</span></div>\r\n        </div>\r\n      `;\r\n    } else {\r\n      container.innerHTML =\r\n        '<p class=\"empty-state\" style=\"color:#ef4444;\">Failed to load user.</p>';\r\n    }\r\n  } catch (e) {\r\n    console.error(\"[SUPERADMIN] load user details error:\", e);\r\n  }\r\n}\r\nasync function loadUserComplaintsSA(userId) {\r\n  try {\r\n    const res = await fetch(\r\n      `/api/superadmin/users/${userId}/complaints?limit=10`\r\n    );\r\n    const result = await res.json();\r\n    const container = document.getElementById(\"sa-user-complaints\");\r\n    if (!container) return;\r\n    if (result.success) {\r\n      const complaints = result.data || [];\r\n      if (!complaints.length) {\r\n        container.innerHTML = '<p class=\"empty-state\">No complaints found.</p>';\r\n        return;\r\n      }\r\n      container.innerHTML = complaints\r\n        .map(\r\n          (c) => `\r\n        <div style=\"padding:0.75rem; border:1px solid #e2e8f0; border-radius:0.5rem; background:#f8fafc; margin-bottom:0.75rem;\">\r\n          <div style=\"display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;\">\r\n            <strong style=\"color:#1e293b;\">${escapeHtml(\r\n    c.title || \"Untitled\"\r\n  )}</strong>\r\n            <span style=\"color:#64748b; font-size:0.875rem; padding:0.25rem 0.5rem; background:white; border-radius:0.25rem; border:1px solid #e2e8f0;\">${escapeHtml(\r\n    c.status || \"\"\r\n  )}</span>\r\n          </div>\r\n          <div style=\"color:#64748b; font-size:0.875rem;\">Type: ${escapeHtml(\r\n    c.type || \"-\"\r\n  )}</div>\r\n          ${\r\n  c.location_text\r\n    ? `<div style=\\\"color:#64748b; font-size:0.875rem; margin-top:0.25rem;\\\">${escapeHtml(\r\n      c.location_text\r\n    )}</div>`\r\n    : \"\"\r\n}\r\n        </div>\r\n      `\r\n        )\r\n        .join(\"\");\r\n    } else {\r\n      container.innerHTML =\r\n        '<p class=\"empty-state\" style=\"color:#ef4444;\">Failed to load complaints.</p>';\r\n    }\r\n  } catch (e) {\r\n    console.error(\"[SUPERADMIN] load user complaints error:\", e);\r\n  }\r\n}\r\nfunction escapeHtml(s) {\r\n  if (s == null) return \"\";\r\n  return String(s)\r\n    .replace(/&/g, \"&amp;\")\r\n    .replace(/</g, \"&lt;\")\r\n    .replace(/>/g, \"&gt;\")\r\n    .replace(/\\\"/g, \"&quot;\")\r\n    .replace(/'/g, \"&#39;\");\r\n}\r\n/**\r\n * Perform role swap\r\n */\r\nasync function performRoleSwap(userId, newRole, reason) {\r\n  try {\r\n    const response = await fetch(\"/api/superadmin/role-swap\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        user_id: userId,\r\n        new_role: newRole,\r\n        reason,\r\n      }),\r\n    });\r\n    const result = await response.json();\r\n    if (result.success) {\r\n      showMessage(\"success\", result.message);\r\n      document.getElementById(\"role-swap-form\").reset();\r\n      await loadDashboardData();\r\n      await loadLogs();\r\n    } else {\r\n      showMessage(\"error\", result.error);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Role swap error:\", error);\r\n    showMessage(\"error\", \"Failed to perform role swap\");\r\n  }\r\n}\r\n/**\r\n * Transfer department\r\n */\r\nasync function transferDepartment(userId, fromDept, toDept, reason) {\r\n  try {\r\n    const response = await fetch(\"/api/superadmin/transfer-department\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        user_id: userId,\r\n        from_department: fromDept,\r\n        to_department: toDept,\r\n        reason,\r\n      }),\r\n    });\r\n    const result = await response.json();\r\n    if (result.success) {\r\n      showMessage(\"success\", result.message);\r\n      document.getElementById(\"dept-transfer-form\").reset();\r\n      await loadDashboardData();\r\n      await loadLogs();\r\n    } else {\r\n      showMessage(\"error\", result.error);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Transfer department error:\", error);\r\n    showMessage(\"error\", \"Failed to transfer department\");\r\n  }\r\n}\r\n/**\r\n * Assign citizen\r\n */\r\nasync function assignCitizen(userId, role, department, reason) {\r\n  try {\r\n    const response = await fetch(\"/api/superadmin/assign-citizen\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        user_id: userId,\r\n        role,\r\n        department_id: department,\r\n        reason,\r\n      }),\r\n    });\r\n    const result = await response.json();\r\n    if (result.success) {\r\n      showMessage(\"success\", result.message);\r\n      document.getElementById(\"assign-citizen-form\").reset();\r\n      await loadDashboardData();\r\n      await loadLogs();\r\n    } else {\r\n      showMessage(\"error\", result.error);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Assign citizen error:\", error);\r\n    showMessage(\"error\", \"Failed to assign citizen\");\r\n  }\r\n}\r\n\r\n/**\r\n * Super Admin Global Helpers\r\n */\r\nwindow.refreshAuditLogs = () =>\r\n  window.loadLogs ? window.loadLogs() : console.error(\"loadLogs not found\");\r\nwindow.triggerBackup = () => {\r\n  showMessage(\"info\", \"Starting manual backup...\");\r\n  setTimeout(\r\n    () => showMessage(\"success\", \"Database backup completed and encrypted\"),\r\n    2000\r\n  );\r\n};\r\nwindow.manageCategories = () =>\r\n  showMessage(\"info\", \"Category management modal coming soon\");\r\nwindow.managePermissions = () =>\r\n  showMessage(\"info\", \"Permission management modal coming soon\");\r\nwindow.systemSettings = () =>\r\n  showMessage(\"info\", \"System settings modal coming soon\");\r\nwindow.apiKeys = () =>\r\n  showMessage(\"info\", \"API Key management modal coming soon\");\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\super-admin\\pending-signups.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":106,"column":8,"nodeType":"CallExpression","messageId":"unexpected","endLine":106,"endColumn":72},{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":136,"column":8,"nodeType":"CallExpression","messageId":"unexpected","endLine":136,"endColumn":71}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Super Admin Pending Signups Page\r\n * Display and manage pending signup requests\r\n */\r\nimport showMessage from \"../components/toast.js\";\r\n\r\n// Initialize page\r\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\r\n  await loadPendingSignups();\r\n});\r\n\r\n/**\r\n * Load pending signups\r\n */\r\nwindow.loadPendingSignups = async function() {\r\n  try {\r\n    const container = document.getElementById(\"pending-signups-container\");\r\n    if (!container) return;\r\n\r\n    // Show loading state\r\n    container.innerHTML = `\r\n      <div class=\"loading\">\r\n        <div class=\"spinner\"></div>\r\n        <p>Loading pending signups...</p>\r\n      </div>\r\n    `;\r\n\r\n    const response = await fetch(\"/api/hr/pending-signups\");\r\n    const result = await response.json();\r\n\r\n    if (result.success && result.data) {\r\n      displayPendingSignups(result.data);\r\n    } else {\r\n      container.innerHTML = `<p class=\"empty-state\" style=\"color: #ef4444;\">Failed to load pending signups: ${  result.error || \"Unknown error\"  }</p>`;\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Load pending signups error:\", error);\r\n    const container = document.getElementById(\"pending-signups-container\");\r\n    if (container) {\r\n      container.innerHTML = '<p class=\"empty-state\" style=\"color: #ef4444;\">Failed to load pending signups</p>';\r\n    }\r\n    showMessage(\"Failed to load pending signups\", \"error\");\r\n  }\r\n};\r\n\r\n/**\r\n * Display pending signups\r\n */\r\nfunction displayPendingSignups(users) {\r\n  const container = document.getElementById(\"pending-signups-container\");\r\n  if (!container) return;\r\n\r\n  if (users.length === 0) {\r\n    container.innerHTML = '<p class=\"empty-state\">No pending signups found</p>';\r\n    return;\r\n  }\r\n\r\n  const html = `\r\n    <div class=\"pending-signups-list\">\r\n      ${users.map(user => {\r\n    const name = user.name || user.fullName || user.email || user.id;\r\n    const dept = user?.raw_user_meta_data?.pending_department || user?.user_metadata?.pending_department || \"-\";\r\n    const role = user?.raw_user_meta_data?.pending_role || user?.user_metadata?.pending_role || \"-\";\r\n    const email = user.email || \"No email\";\r\n    const createdAt = user.created_at ? new Date(user.created_at).toLocaleString() : \"Unknown\";\r\n\r\n    return `\r\n          <div class=\"user-item\" style=\"display: flex; align-items: center; justify-content: space-between; padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem; background: white;\">\r\n            <div style=\"flex: 1;\">\r\n              <div style=\"display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;\">\r\n                <div style=\"width: 48px; height: 48px; border-radius: 50%; background: #3b82f6; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.25rem;\">\r\n                  ${name.charAt(0).toUpperCase()}\r\n                </div>\r\n                <div>\r\n                  <div style=\"font-weight: 600; color: #111827; font-size: 1.1rem; margin-bottom: 0.25rem;\">\r\n                    ${escapeHtml(name)}\r\n                  </div>\r\n                  <div style=\"font-size: 0.875rem; color: #6b7280;\">\r\n                    ${escapeHtml(email)}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              <div style=\"display: flex; gap: 1.5rem; font-size: 0.875rem; color: #6b7280; flex-wrap: wrap; margin-top: 0.75rem;\">\r\n                <div><strong>Requested Role:</strong> ${escapeHtml(String(role))}</div>\r\n                <div><strong>Department:</strong> ${escapeHtml(String(dept))}</div>\r\n                <div><strong>Registered:</strong> ${createdAt}</div>\r\n              </div>\r\n            </div>\r\n            <div style=\"display: flex; gap: 0.75rem; margin-left: 1rem;\">\r\n              <button class=\"btn btn-success\" onclick=\"approvePending('${user.id}')\" style=\"white-space: nowrap;\">Approve</button>\r\n              <button class=\"btn btn-danger\" onclick=\"rejectPending('${user.id}')\" style=\"white-space: nowrap;\">Reject</button>\r\n            </div>\r\n          </div>\r\n        `;\r\n  }).join(\"\")}\r\n    </div>\r\n  `;\r\n\r\n  container.innerHTML = html;\r\n}\r\n\r\n/**\r\n * Approve pending signup\r\n */\r\nwindow.approvePending = async function(userId) {\r\n  if (!confirm(\"Are you sure you want to approve this signup request?\")) {\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(`/api/hr/pending-signups/${userId}/approve`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\"\r\n      }\r\n    });\r\n\r\n    const result = await response.json();\r\n\r\n    if (result.success) {\r\n      showMessage(\"Signup approved successfully\", \"success\");\r\n      await loadPendingSignups();\r\n    } else {\r\n      showMessage(result.error || \"Failed to approve signup\", \"error\");\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Approve pending signup error:\", error);\r\n    showMessage(\"Failed to approve signup\", \"error\");\r\n  }\r\n};\r\n\r\n/**\r\n * Reject pending signup\r\n */\r\nwindow.rejectPending = async function(userId) {\r\n  if (!confirm(\"Are you sure you want to reject this signup request?\")) {\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(`/api/hr/pending-signups/${userId}/reject`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\"\r\n      }\r\n    });\r\n\r\n    const result = await response.json();\r\n\r\n    if (result.success) {\r\n      showMessage(\"Signup rejected successfully\", \"success\");\r\n      await loadPendingSignups();\r\n    } else {\r\n      showMessage(result.error || \"Failed to reject signup\", \"error\");\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Reject pending signup error:\", error);\r\n    showMessage(\"Failed to reject signup\", \"error\");\r\n  }\r\n};\r\n\r\n/**\r\n * Escape HTML to prevent XSS\r\n */\r\nfunction escapeHtml(text) {\r\n  if (text == null) return \"\";\r\n  const div = document.createElement(\"div\");\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\super-admin\\server-logs.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\super-admin\\user-manager.js","messages":[{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":579,"column":23,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":579,"endColumn":32},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":596,"column":36,"nodeType":"CallExpression","messageId":"returnsValue","endLine":596,"endColumn":60,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[22012,22036],"text":"{setTimeout(resolve, 500)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":611,"column":8,"nodeType":"CallExpression","messageId":"unexpected","endLine":611,"endColumn":47},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":630,"column":36,"nodeType":"CallExpression","messageId":"returnsValue","endLine":630,"endColumn":60,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[23152,23176],"text":"{setTimeout(resolve, 500)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":741,"column":36,"nodeType":"CallExpression","messageId":"returnsValue","endLine":741,"endColumn":60,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[26321,26345],"text":"{setTimeout(resolve, 500)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":756,"column":8,"nodeType":"CallExpression","messageId":"unexpected","endLine":756,"endColumn":35},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":775,"column":36,"nodeType":"CallExpression","messageId":"returnsValue","endLine":775,"endColumn":60,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[27386,27410],"text":"{setTimeout(resolve, 500)}"},"desc":"Wrap the expression in `{}`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import showMessage from \"../components/toast.js\";\r\nimport { supabase } from \"../config/config.js\";\r\n\r\nlet departmentsCache = [];\r\nlet selectedUser = null;\r\nlet currentUserRole = null;\r\nlet currentUserId = null;\r\n\r\n// Helper function to get auth headers\r\nasync function getAuthHeaders() {\r\n  const { data: { session } } = await supabase.auth.getSession();\r\n  const token = session?.access_token;\r\n  const headers = { \"Content-Type\": \"application/json\" };\r\n  if (token) {\r\n    headers[\"Authorization\"] = `Bearer ${token}`;\r\n  }\r\n  return headers;\r\n}\r\n\r\n// Get current user role\r\nasync function getCurrentUserRole() {\r\n  try {\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    if (session?.user) {\r\n      currentUserId = session.user.id;\r\n      const metadata = session.user.user_metadata || session.user.raw_user_meta_data || {};\r\n      return metadata.role || \"citizen\";\r\n    }\r\n  } catch (e) {\r\n    console.error(\"[USER_MANAGER] Error getting current user role:\", e);\r\n  }\r\n  return \"citizen\";\r\n}\r\n\r\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\r\n  console.log(\"[USER_MANAGER] DOMContentLoaded - script is loading\");\r\n\r\n  try {\r\n    currentUserRole = await getCurrentUserRole();\r\n    await loadDepartments();\r\n    setupHandlers();\r\n    await refreshUserList();\r\n    console.log(\"[USER_MANAGER] Initialization complete\");\r\n  } catch (error) {\r\n    console.error(\"[USER_MANAGER] Initialization error:\", error);\r\n  }\r\n});\r\n\r\n// Also try to attach handlers immediately (in case DOMContentLoaded already fired)\r\nif (document.readyState === \"loading\") {\r\n  console.log(\"[USER_MANAGER] Document still loading, waiting for DOMContentLoaded\");\r\n} else {\r\n  console.log(\"[USER_MANAGER] Document already loaded, setting up handlers immediately\");\r\n  loadDepartments().then(async () => {\r\n    currentUserRole = await getCurrentUserRole();\r\n    setupHandlers();\r\n    refreshUserList();\r\n  });\r\n}\r\n\r\nasync function loadDepartments() {\r\n  try {\r\n    const headers = await getAuthHeaders();\r\n    const res = await fetch(\"/api/department-structure/departments\", {\r\n      headers,\r\n      credentials: \"include\"\r\n    });\r\n    const { data } = await res.json();\r\n    departmentsCache = Array.isArray(data) ? data : [];\r\n    const deptSelect = document.getElementById(\"promotion-dept\");\r\n    if (deptSelect) {\r\n      departmentsCache.forEach(d => {\r\n        const opt = document.createElement(\"option\");\r\n        opt.value = d.code?.toUpperCase() || \"\";\r\n        opt.textContent = `${d.name} (${d.code})`;\r\n        deptSelect.appendChild(opt);\r\n      });\r\n    }\r\n  } catch (e) {\r\n    // ignore\r\n  }\r\n}\r\n\r\nfunction setupHandlers() {\r\n  console.log(\"[USER_MANAGER] setupHandlers called\");\r\n\r\n  const search = document.getElementById(\"um-search\");\r\n  const filter = document.getElementById(\"um-filter\");\r\n  const refresh = document.getElementById(\"um-refresh\");\r\n\r\n  // Search input\r\n  if (search) {\r\n    let searchTimeout;\r\n    search.addEventListener(\"keypress\", (e) => {\r\n      if (e.key === \"Enter\") {\r\n        e.preventDefault();\r\n        refreshUserList();\r\n      }\r\n    });\r\n    search.addEventListener(\"input\", (_e) => {\r\n      clearTimeout(searchTimeout);\r\n      searchTimeout = setTimeout(() => {\r\n        refreshUserList();\r\n      }, 500);\r\n    });\r\n    search.addEventListener(\"keydown\", (e) => {\r\n      if (e.key === \"Escape\") {\r\n        search.value = \"\";\r\n        refreshUserList();\r\n      }\r\n    });\r\n  }\r\n\r\n  // Filter dropdown\r\n  if (filter) {\r\n    filter.addEventListener(\"change\", () => {\r\n      refreshUserList();\r\n    });\r\n  }\r\n\r\n  // Refresh button\r\n  if (refresh) {\r\n    refresh.addEventListener(\"click\", () => {\r\n      refreshUserList();\r\n    });\r\n  }\r\n\r\n  // Promotion modal handlers\r\n  const promotionCloseBtn = document.getElementById(\"promotion-close\");\r\n  if (promotionCloseBtn) {\r\n    promotionCloseBtn.addEventListener(\"click\", hidePromotionModal);\r\n  }\r\n\r\n  const promotionModal = document.getElementById(\"promotion-modal\");\r\n  if (promotionModal) {\r\n    promotionModal.addEventListener(\"click\", (e) => { if (e.target === promotionModal) hidePromotionModal(); });\r\n  }\r\n\r\n  const promotionForm = document.getElementById(\"promotion-form\");\r\n  if (promotionForm) {\r\n    promotionForm.addEventListener(\"submit\", onPromoteSubmit);\r\n  }\r\n\r\n  // Ban modal handlers\r\n  const banCloseBtn = document.getElementById(\"ban-close\");\r\n  if (banCloseBtn) {\r\n    banCloseBtn.addEventListener(\"click\", hideBanModal);\r\n  }\r\n\r\n  const banModal = document.getElementById(\"ban-modal\");\r\n  if (banModal) {\r\n    banModal.addEventListener(\"click\", (e) => { if (e.target === banModal) hideBanModal(); });\r\n  }\r\n\r\n  const banForm = document.getElementById(\"ban-form\");\r\n  if (banForm) {\r\n    banForm.addEventListener(\"submit\", onBanSubmit);\r\n  }\r\n\r\n  // Delete user modal handlers\r\n  const deleteCloseBtn = document.getElementById(\"delete-user-close\");\r\n  if (deleteCloseBtn) {\r\n    deleteCloseBtn.addEventListener(\"click\", hideDeleteModal);\r\n  }\r\n\r\n  const deleteCancelBtn = document.getElementById(\"delete-user-cancel\");\r\n  if (deleteCancelBtn) {\r\n    deleteCancelBtn.addEventListener(\"click\", (e) => {\r\n      e.preventDefault();\r\n      hideDeleteModal();\r\n    });\r\n  }\r\n\r\n  const deleteModal = document.getElementById(\"delete-user-modal\");\r\n  if (deleteModal) {\r\n    deleteModal.addEventListener(\"click\", (e) => {\r\n      if (e.target === deleteModal) hideDeleteModal();\r\n    });\r\n  }\r\n\r\n  const deleteForm = document.getElementById(\"delete-user-form\");\r\n  if (deleteForm) {\r\n    deleteForm.addEventListener(\"submit\", onDeleteUserSubmit);\r\n  }\r\n\r\n  // Ban type change handler\r\n  const banTypeSelect = document.getElementById(\"ban-type\");\r\n  if (banTypeSelect) {\r\n    banTypeSelect.addEventListener(\"change\", (e) => {\r\n      const durationGroup = document.getElementById(\"ban-duration-group\");\r\n      if (e.target.value === \"temporary\") {\r\n        durationGroup.style.display = \"block\";\r\n        document.getElementById(\"ban-duration\").setAttribute(\"required\", \"required\");\r\n      } else {\r\n        durationGroup.style.display = \"none\";\r\n        document.getElementById(\"ban-duration\").removeAttribute(\"required\");\r\n      }\r\n    });\r\n  }\r\n\r\n  console.log(\"[USER_MANAGER] setupHandlers complete\");\r\n}\r\n\r\nasync function refreshUserList() {\r\n  const list = document.getElementById(\"um-user-list\");\r\n  if (!list) return;\r\n\r\n  const searchInput = document.getElementById(\"um-search\");\r\n  const filterSelect = document.getElementById(\"um-filter\");\r\n  const searchQuery = (searchInput?.value || \"\").trim().toLowerCase();\r\n  const filter = filterSelect?.value || \"all\";\r\n\r\n  // Show loading state\r\n  list.innerHTML = '<p class=\"empty-state\">Loading users...</p>';\r\n\r\n  try {\r\n    const headers = await getAuthHeaders();\r\n    const res = await fetch(`/api/superadmin/users?limit=1000&search=${encodeURIComponent(searchQuery)}`, {\r\n      headers,\r\n      credentials: \"include\"\r\n    });\r\n    const result = await res.json();\r\n    const users = (result.success && Array.isArray(result.data)) ? result.data : [];\r\n\r\n    // Apply filters\r\n    const filtered = users.filter(u => {\r\n      // Role filter\r\n      const role = String(u.role || \"\").toLowerCase();\r\n      if (filter === \"citizen\") {\r\n        if (role !== \"citizen\") return false;\r\n      } else if (filter === \"staff\") {\r\n        if (role === \"citizen\") return false;\r\n      } else if (filter === \"banned\") {\r\n        const isBanned = u.isBanned === true || u.raw_user_meta_data?.isBanned === true || u.user_metadata?.isBanned === true;\r\n        if (!isBanned) return false;\r\n      }\r\n\r\n      // Search filter\r\n      if (searchQuery) {\r\n        const name = (u.fullName || u.name || \"\").toLowerCase();\r\n        const email = (u.email || \"\").toLowerCase();\r\n        const department = (u.department || \"\").toLowerCase();\r\n        const roleDisplay = normalizeRoleDisplay(u.role, u.department).toLowerCase();\r\n\r\n        const matchesSearch = name.includes(searchQuery) ||\r\n                             email.includes(searchQuery) ||\r\n                             department.includes(searchQuery) ||\r\n                             roleDisplay.includes(searchQuery);\r\n\r\n        if (!matchesSearch) return false;\r\n      }\r\n\r\n      return true;\r\n    });\r\n\r\n    // Render results\r\n    if (filtered.length === 0) {\r\n      list.innerHTML = '<p class=\"empty-state\">No users found matching your criteria.</p>';\r\n    } else {\r\n      list.innerHTML = filtered.map(u => renderUserRow(u)).join(\"\");\r\n    }\r\n\r\n    // Attach event listeners\r\n    list.querySelectorAll(\".um-user-item\").forEach(el => {\r\n      el.addEventListener(\"click\", async () => {\r\n        const id = el.getAttribute(\"data-user-id\");\r\n        await loadUserDetails(id);\r\n      });\r\n\r\n      const promoteBtn = el.querySelector(\".um-promote\");\r\n      const demoteBtn = el.querySelector(\".um-demote\");\r\n      const banBtn = el.querySelector(\".um-ban\");\r\n      const unbanBtn = el.querySelector(\".um-unban\");\r\n\r\n      if (promoteBtn) {\r\n        promoteBtn.addEventListener(\"click\", (e) => {\r\n          e.stopPropagation();\r\n          e.preventDefault();\r\n          openPromotionModal(el.dataset.userEmail, el.dataset.userName, el.dataset.userId);\r\n        });\r\n      }\r\n\r\n      if (demoteBtn) {\r\n        demoteBtn.addEventListener(\"click\", async (e) => {\r\n          e.stopPropagation();\r\n          await demoteToCitizen(el.dataset.userId);\r\n        });\r\n      }\r\n\r\n      if (banBtn) {\r\n        banBtn.addEventListener(\"click\", (e) => {\r\n          e.stopPropagation();\r\n          e.preventDefault();\r\n          openBanModal(el.dataset.userEmail, el.dataset.userName, el.dataset.userId);\r\n        });\r\n      }\r\n\r\n      if (unbanBtn) {\r\n        unbanBtn.addEventListener(\"click\", async (e) => {\r\n          e.stopPropagation();\r\n          await unbanUser(el.dataset.userId);\r\n        });\r\n      }\r\n    });\r\n  } catch (e) {\r\n    list.innerHTML = '<p class=\"empty-state\">Failed to load users.</p>';\r\n  }\r\n}\r\n\r\n// Normalize role for display\r\nfunction normalizeRoleDisplay(role, department = null) {\r\n  if (!role) return \"Citizen\";\r\n  const roleLower = role.toLowerCase();\r\n\r\n  let displayRole = \"\";\r\n  if (roleLower === \"lgu\" || roleLower === \"lgu-officer\") {\r\n    displayRole = \"LGU Officer\";\r\n  } else if (roleLower === \"lgu-admin\") {\r\n    displayRole = \"LGU Admin\";\r\n  } else if (roleLower === \"lgu-hr\") {\r\n    displayRole = \"LGU HR\";\r\n  } else if (roleLower === \"super-admin\") {\r\n    displayRole = \"Super Admin\";\r\n  } else if (roleLower === \"complaint-coordinator\") {\r\n    displayRole = \"Complaint Coordinator\";\r\n  } else if (roleLower === \"citizen\") {\r\n    displayRole = \"Citizen\";\r\n  } else {\r\n    displayRole = role.split(\"-\").map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(\" \");\r\n  }\r\n\r\n  const isLguRole = roleLower === \"lgu\" || roleLower === \"lgu-officer\" || roleLower === \"lgu-admin\" || roleLower === \"lgu-hr\";\r\n  if (isLguRole && department) {\r\n    displayRole += ` - ${department}`;\r\n  }\r\n\r\n  return displayRole;\r\n}\r\n\r\nfunction renderUserRow(u) {\r\n  const role = (u.role || \"\").toLowerCase();\r\n  const isCitizen = role === \"citizen\";\r\n  const displayRole = normalizeRoleDisplay(u.role, u.department);\r\n\r\n  // Check ban status\r\n  const isBanned = u.isBanned === true ||\r\n                  u.raw_user_meta_data?.isBanned === true ||\r\n                  u.user_metadata?.isBanned === true;\r\n  const banExpiresAt = u.banExpiresAt || u.raw_user_meta_data?.banExpiresAt || u.user_metadata?.banExpiresAt;\r\n  const warningStrike = u.warningStrike || u.raw_user_meta_data?.warningStrike || u.user_metadata?.warningStrike || 0;\r\n\r\n  // Check if ban has expired\r\n  let banStatus = \"\";\r\n  if (isBanned && banExpiresAt) {\r\n    const expirationDate = new Date(banExpiresAt);\r\n    const now = new Date();\r\n    if (now > expirationDate) {\r\n      banStatus = '<span style=\"color:#10b981; font-size:0.75rem;\">(Ban Expired)</span>';\r\n    } else {\r\n      const banType = u.banType || u.raw_user_meta_data?.banType || u.user_metadata?.banType || \"temporary\";\r\n      if (banType === \"permanent\") {\r\n        banStatus = '<span style=\"color:#ef4444; font-size:0.75rem;\">🔴 BANNED (Permanent)</span>';\r\n      } else {\r\n        banStatus = `<span style=\"color:#f59e0b; font-size:0.75rem;\">🟡 BANNED (Until ${new Date(banExpiresAt).toLocaleDateString()})</span>`;\r\n      }\r\n    }\r\n  }\r\n\r\n  return `\r\n    <div class=\"um-user-item user-item\" data-user-id=\"${u.id}\" data-user-email=\"${escapeHtml(u.email || \"\")}\" data-user-name=\"${escapeHtml(u.fullName || u.name || \"\")}\">\r\n      <div><strong>${escapeHtml(u.fullName || u.name || u.email)}</strong> ${banStatus}</div>\r\n      <div style=\"color:#64748b; font-size:0.875rem;\">${escapeHtml(u.email || \"\")}</div>\r\n      <div style=\"color:#64748b; font-size:0.875rem;\">Role: ${escapeHtml(displayRole)}</div>\r\n      ${warningStrike > 0 ? `<div style=\"color:#f59e0b; font-size:0.75rem;\">⚠️ Warning Strikes: ${warningStrike}</div>` : \"\"}\r\n      <div style=\"margin-top:0.5rem; display:flex; gap:0.5rem; flex-wrap:wrap;\">\r\n        ${isCitizen ? `<button class=\"btn btn-primary um-promote\">Promote</button>` : `<button class=\"btn btn-secondary um-demote\">Demote to Citizen</button>`}\r\n        ${!isBanned ? `<button class=\"btn btn-danger um-ban\">Ban Now</button>` : \"\"}\r\n        ${isBanned && currentUserRole === \"super-admin\" ? `<button class=\"btn btn-success um-unban\">Unban</button>` : \"\"}\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n\r\nasync function loadUserDetails(userId) {\r\n  selectedUser = null;\r\n  try {\r\n    const headers = await getAuthHeaders();\r\n    const res = await fetch(`/api/superadmin/users/${userId}`, {\r\n      headers,\r\n      credentials: \"include\"\r\n    });\r\n    const result = await res.json();\r\n    const container = document.getElementById(\"um-user-details\");\r\n    if (!container) return;\r\n    if (result.success && result.data) {\r\n      selectedUser = result.data;\r\n      const u = selectedUser;\r\n\r\n      // Get ban status\r\n      const isBanned = u.isBanned === true ||\r\n                      u.raw_user_meta_data?.isBanned === true ||\r\n                      u.user_metadata?.isBanned === true;\r\n      const banType = u.banType || u.raw_user_meta_data?.banType || u.user_metadata?.banType;\r\n      const banExpiresAt = u.banExpiresAt || u.raw_user_meta_data?.banExpiresAt || u.user_metadata?.banExpiresAt;\r\n      const banReason = u.banReason || u.raw_user_meta_data?.banReason || u.user_metadata?.banReason;\r\n      const warningStrike = u.warningStrike || u.raw_user_meta_data?.warningStrike || u.user_metadata?.warningStrike || 0;\r\n\r\n      let banInfo = \"\";\r\n      if (isBanned) {\r\n        if (banExpiresAt) {\r\n          const expirationDate = new Date(banExpiresAt);\r\n          const now = new Date();\r\n          if (now > expirationDate) {\r\n            banInfo = '<div style=\"color:#10b981; padding:0.5rem; background:#f0fdf4; border-radius:4px; margin-top:0.5rem;\">Ban has expired</div>';\r\n          } else {\r\n            const banTypeText = banType === \"permanent\" ? \"Permanent\" : \"Temporary\";\r\n            banInfo = `\r\n              <div style=\"color:#ef4444; padding:0.5rem; background:#fef2f2; border-radius:4px; margin-top:0.5rem;\">\r\n                <strong>Banned (${banTypeText})</strong><br>\r\n                ${banType !== \"permanent\" ? `Expires: ${new Date(banExpiresAt).toLocaleString()}<br>` : \"\"}\r\n                ${banReason ? `Reason: ${escapeHtml(banReason)}` : \"\"}\r\n              </div>\r\n            `;\r\n          }\r\n        }\r\n      }\r\n\r\n      const isTargetSuperAdmin = String(u.role || \"\").toLowerCase() === \"super-admin\";\r\n      const canDeleteUser = currentUserRole === \"super-admin\" && u.id !== currentUserId && !isTargetSuperAdmin;\r\n\r\n      container.innerHTML = `\r\n        <div style=\"display:flex; gap:1rem; align-items:center; margin-bottom:1rem;\">\r\n          <div style=\"width:48px; height:48px; border-radius:50%; background:#e2e8f0; display:flex; align-items:center; justify-content:center;\">👤</div>\r\n          <div>\r\n            <div style=\"font-weight:700; font-size:1.125rem; color:#1e293b;\">${escapeHtml(u.fullName || u.name || u.email)}</div>\r\n            <div style=\"color:#64748b; font-size:0.875rem;\">${escapeHtml(u.email || \"\")}</div>\r\n          </div>\r\n        </div>\r\n        ${banInfo}\r\n        <div style=\"display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; padding-top:1rem; border-top:1px solid #e2e8f0;\">\r\n          <div><strong style=\"color:#1e293b;\">Role:</strong> <span style=\"color:#64748b;\">${escapeHtml(normalizeRoleDisplay(u.role, u.department))}</span></div>\r\n          <div><strong style=\"color:#1e293b;\">Department:</strong> <span style=\"color:#64748b;\">${escapeHtml(u.department || \"-\")}</span></div>\r\n          <div><strong style=\"color:#1e293b;\">Warning Strikes:</strong> <span style=\"color:#64748b;\">${warningStrike}</span></div>\r\n        </div>\r\n        <div style=\"margin-top:1rem; display:flex; gap:0.5rem; flex-wrap:wrap;\">\r\n          ${!isBanned ? `<button class=\"btn btn-danger\" onclick=\"openBanModal('${escapeHtml(u.email || \"\")}', '${escapeHtml(u.fullName || u.name || \"\")}', '${u.id}')\">Ban Now</button>` : \"\"}\r\n          ${isBanned && currentUserRole === \"super-admin\" ? `<button class=\"btn btn-success\" onclick=\"unbanUser('${u.id}')\">Unban</button>` : \"\"}\r\n          ${canDeleteUser ? '<button class=\"btn btn-secondary\" id=\"delete-user-btn\">Delete Account</button>' : \"\"}\r\n        </div>\r\n      `;\r\n\r\n      if (canDeleteUser) {\r\n        const deleteBtn = container.querySelector(\"#delete-user-btn\");\r\n        if (deleteBtn) {\r\n          deleteBtn.addEventListener(\"click\", (e) => {\r\n            e.preventDefault();\r\n            openDeleteModal(u);\r\n          });\r\n        }\r\n      }\r\n    }\r\n  } catch (e) {\r\n    console.error(\"[USER_MANAGER] Error loading user details:\", e);\r\n  }\r\n}\r\n\r\nfunction openPromotionModal(email, name, userId) {\r\n  const modal = document.getElementById(\"promotion-modal\");\r\n  if (!modal) {\r\n    showMessage(\"error\", \"Promotion modal not found\");\r\n    return;\r\n  }\r\n\r\n  selectedUser = { id: userId, email, name };\r\n\r\n  const userLabel = document.getElementById(\"promotion-user-label\");\r\n  const roleSelect = document.getElementById(\"promotion-role\");\r\n  const deptSelect = document.getElementById(\"promotion-dept\");\r\n  const reasonTextarea = document.getElementById(\"promotion-reason\");\r\n\r\n  if (userLabel) userLabel.value = `${name || email}`;\r\n  if (roleSelect) {\r\n    roleSelect.value = \"\";\r\n    roleSelect.removeEventListener(\"change\", updateDepartmentRequirement);\r\n    roleSelect.addEventListener(\"change\", updateDepartmentRequirement);\r\n  }\r\n  if (deptSelect) deptSelect.value = \"\";\r\n  if (reasonTextarea) reasonTextarea.value = \"\";\r\n\r\n  updateDepartmentRequirement();\r\n  modal.style.display = \"flex\";\r\n  modal.style.visibility = \"visible\";\r\n  modal.style.opacity = \"1\";\r\n  modal.style.zIndex = \"10000\";\r\n}\r\n\r\nfunction updateDepartmentRequirement() {\r\n  const roleSelect = document.getElementById(\"promotion-role\");\r\n  const deptSelect = document.getElementById(\"promotion-dept\");\r\n  const requiredIndicator = document.getElementById(\"dept-required-indicator\");\r\n  const helpText = document.getElementById(\"dept-help-text\");\r\n\r\n  if (!roleSelect || !deptSelect) return;\r\n\r\n  const selectedRole = roleSelect.value;\r\n  const isSuperAdmin = selectedRole === \"super-admin\";\r\n  const isCoordinator = selectedRole === \"complaint-coordinator\";\r\n  const shouldDisable = isSuperAdmin || isCoordinator;\r\n\r\n  if (shouldDisable) {\r\n    deptSelect.disabled = true;\r\n    deptSelect.removeAttribute(\"required\");\r\n    deptSelect.value = \"\";\r\n    if (requiredIndicator) requiredIndicator.style.display = \"none\";\r\n    if (helpText) {\r\n      const roleName = isSuperAdmin ? \"Super Admin\" : \"Complaint Coordinator\";\r\n      helpText.textContent = `Not applicable for ${roleName}`;\r\n    }\r\n    deptSelect.style.backgroundColor = \"#f3f4f6\";\r\n    deptSelect.style.cursor = \"not-allowed\";\r\n  } else {\r\n    deptSelect.disabled = false;\r\n    deptSelect.setAttribute(\"required\", \"required\");\r\n    if (requiredIndicator) requiredIndicator.style.display = \"inline\";\r\n    if (helpText) {\r\n      helpText.textContent = \"Required for all roles except Super Admin and Complaint Coordinator\";\r\n    }\r\n    deptSelect.style.backgroundColor = \"\";\r\n    deptSelect.style.cursor = \"\";\r\n  }\r\n}\r\n\r\nfunction hidePromotionModal() {\r\n  const modal = document.getElementById(\"promotion-modal\");\r\n  if (modal) {\r\n    modal.style.display = \"none\";\r\n    modal.style.visibility = \"hidden\";\r\n    modal.style.opacity = \"0\";\r\n  }\r\n}\r\n\r\nasync function onPromoteSubmit(e) {\r\n  e.preventDefault();\r\n  e.stopPropagation();\r\n\r\n  if (!selectedUser) {\r\n    showMessage(\"error\", \"No user selected\");\r\n    return;\r\n  }\r\n\r\n  const roleSelect = document.getElementById(\"promotion-role\");\r\n  const deptSelect = document.getElementById(\"promotion-dept\");\r\n  const reasonTextarea = document.getElementById(\"promotion-reason\");\r\n\r\n  if (!roleSelect || !deptSelect) {\r\n    showMessage(\"error\", \"Form elements not found\");\r\n    return;\r\n  }\r\n\r\n  const role = roleSelect.value;\r\n  const dept = deptSelect.value;\r\n  const reason = reasonTextarea?.value || \"\";\r\n\r\n  if (!role) {\r\n    showMessage(\"error\", \"Please select a role\");\r\n    return;\r\n  }\r\n\r\n  const rolesWithoutDept = [\"super-admin\", \"complaint-coordinator\"];\r\n  if (!rolesWithoutDept.includes(role) && !dept) {\r\n    showMessage(\"error\", \"Please select an office (not required for Super Admin and Complaint Coordinator)\");\r\n    return;\r\n  }\r\n\r\n  const requestBody = {\r\n    user_id: selectedUser.id,\r\n    role,\r\n    department_id: dept,\r\n    reason: reason || undefined\r\n  };\r\n\r\n  try {\r\n    const headers = await getAuthHeaders();\r\n    const res = await fetch(\"/api/superadmin/assign-citizen\", {\r\n      method: \"POST\",\r\n      headers,\r\n      credentials: \"include\",\r\n      body: JSON.stringify(requestBody)\r\n    });\r\n\r\n    const result = await res.json();\r\n\r\n    if (result.success) {\r\n      showMessage(\"success\", `Citizen promoted successfully to ${role}`);\r\n      hidePromotionModal();\r\n      await new Promise(resolve => setTimeout(resolve, 500));\r\n      await refreshUserList();\r\n      if (selectedUser && selectedUser.id) {\r\n        await loadUserDetails(selectedUser.id);\r\n      }\r\n    } else {\r\n      showMessage(\"error\", result.error || \"Failed to promote\");\r\n    }\r\n  } catch (e) {\r\n    console.error(\"[USER_MANAGER] Promotion exception:\", e);\r\n    showMessage(\"error\", e.message || \"Failed to promote\");\r\n  }\r\n}\r\n\r\nasync function demoteToCitizen(userId) {\r\n  if (!confirm(\"Demote this user to Citizen?\")) return;\r\n  try {\r\n    const headers = await getAuthHeaders();\r\n    const res = await fetch(\"/api/superadmin/role-swap\", {\r\n      method: \"POST\",\r\n      headers,\r\n      credentials: \"include\",\r\n      body: JSON.stringify({ user_id: userId, new_role: \"citizen\", reason: \"Demotion by super-admin\" })\r\n    });\r\n\r\n    if (!res.ok) {\r\n      const errorData = await res.json().catch(() => ({ error: \"Network error\" }));\r\n      throw new Error(errorData.error || `HTTP ${res.status}`);\r\n    }\r\n\r\n    const result = await res.json();\r\n\r\n    if (result.success) {\r\n      showMessage(\"success\", `User demoted to Citizen.`);\r\n      await new Promise(resolve => setTimeout(resolve, 500));\r\n      await refreshUserList();\r\n      if (selectedUser && selectedUser.id === userId) {\r\n        await loadUserDetails(userId);\r\n      }\r\n    } else {\r\n      showMessage(\"error\", result.error || \"Failed to demote\");\r\n    }\r\n  } catch (e) {\r\n    console.error(\"[USER_MANAGER] Demotion exception:\", e);\r\n    showMessage(\"error\", `Failed to demote: ${  e.message || \"Network error\"}`);\r\n  }\r\n}\r\n\r\nfunction openBanModal(email, name, userId) {\r\n  const modal = document.getElementById(\"ban-modal\");\r\n  if (!modal) {\r\n    showMessage(\"error\", \"Ban modal not found\");\r\n    return;\r\n  }\r\n\r\n  selectedUser = { id: userId, email, name };\r\n\r\n  const userLabel = document.getElementById(\"ban-user-label\");\r\n  const banTypeSelect = document.getElementById(\"ban-type\");\r\n  const durationInput = document.getElementById(\"ban-duration\");\r\n  const reasonTextarea = document.getElementById(\"ban-reason\");\r\n\r\n  if (userLabel) userLabel.value = `${name || email}`;\r\n  if (banTypeSelect) banTypeSelect.value = \"\";\r\n  if (durationInput) {\r\n    durationInput.value = \"\";\r\n    durationInput.removeAttribute(\"required\");\r\n  }\r\n  if (reasonTextarea) reasonTextarea.value = \"\";\r\n\r\n  document.getElementById(\"ban-duration-group\").style.display = \"none\";\r\n\r\n  modal.style.display = \"flex\";\r\n  modal.style.visibility = \"visible\";\r\n  modal.style.opacity = \"1\";\r\n  modal.style.zIndex = \"10000\";\r\n}\r\n\r\nfunction hideBanModal() {\r\n  const modal = document.getElementById(\"ban-modal\");\r\n  if (modal) {\r\n    modal.style.display = \"none\";\r\n    modal.style.visibility = \"hidden\";\r\n    modal.style.opacity = \"0\";\r\n  }\r\n}\r\n\r\nasync function onBanSubmit(e) {\r\n  e.preventDefault();\r\n  e.stopPropagation();\r\n\r\n  if (!selectedUser) {\r\n    showMessage(\"error\", \"No user selected\");\r\n    return;\r\n  }\r\n\r\n  const banTypeSelect = document.getElementById(\"ban-type\");\r\n  const durationInput = document.getElementById(\"ban-duration\");\r\n  const reasonTextarea = document.getElementById(\"ban-reason\");\r\n\r\n  if (!banTypeSelect || !reasonTextarea) {\r\n    showMessage(\"error\", \"Form elements not found\");\r\n    return;\r\n  }\r\n\r\n  const banType = banTypeSelect.value;\r\n  const duration = banType === \"temporary\" ? parseInt(durationInput?.value) : null;\r\n  const reason = reasonTextarea.value.trim();\r\n\r\n  if (!banType) {\r\n    showMessage(\"error\", \"Please select a ban type\");\r\n    return;\r\n  }\r\n\r\n  if (banType === \"temporary\" && (!duration || duration < 1)) {\r\n    showMessage(\"error\", \"Please enter a valid duration (in hours)\");\r\n    return;\r\n  }\r\n\r\n  if (!reason) {\r\n    showMessage(\"error\", \"Please provide a reason for the ban\");\r\n    return;\r\n  }\r\n\r\n  const requestBody = {\r\n    user_id: selectedUser.id,\r\n    type: banType,\r\n    duration,\r\n    reason\r\n  };\r\n\r\n  try {\r\n    const headers = await getAuthHeaders();\r\n    const res = await fetch(\"/api/superadmin/ban-user\", {\r\n      method: \"POST\",\r\n      headers,\r\n      credentials: \"include\",\r\n      body: JSON.stringify(requestBody)\r\n    });\r\n\r\n    const result = await res.json();\r\n\r\n    if (result.success) {\r\n      showMessage(\"success\", `User banned successfully (${banType})`);\r\n      hideBanModal();\r\n      await new Promise(resolve => setTimeout(resolve, 500));\r\n      await refreshUserList();\r\n      if (selectedUser && selectedUser.id) {\r\n        await loadUserDetails(selectedUser.id);\r\n      }\r\n    } else {\r\n      showMessage(\"error\", result.error || \"Failed to ban user\");\r\n    }\r\n  } catch (e) {\r\n    console.error(\"[USER_MANAGER] Ban exception:\", e);\r\n    showMessage(\"error\", e.message || \"Failed to ban user\");\r\n  }\r\n}\r\n\r\nasync function unbanUser(userId) {\r\n  if (!confirm(\"Unban this user?\")) return;\r\n  try {\r\n    const headers = await getAuthHeaders();\r\n    const res = await fetch(\"/api/superadmin/unban-user\", {\r\n      method: \"POST\",\r\n      headers,\r\n      credentials: \"include\",\r\n      body: JSON.stringify({ user_id: userId })\r\n    });\r\n\r\n    if (!res.ok) {\r\n      const errorData = await res.json().catch(() => ({ error: \"Network error\" }));\r\n      throw new Error(errorData.error || `HTTP ${res.status}`);\r\n    }\r\n\r\n    const result = await res.json();\r\n\r\n    if (result.success) {\r\n      showMessage(\"success\", \"User unbanned successfully\");\r\n      await new Promise(resolve => setTimeout(resolve, 500));\r\n      await refreshUserList();\r\n      if (selectedUser && selectedUser.id === userId) {\r\n        await loadUserDetails(userId);\r\n      }\r\n    } else {\r\n      showMessage(\"error\", result.error || \"Failed to unban user\");\r\n    }\r\n  } catch (e) {\r\n    console.error(\"[USER_MANAGER] Unban exception:\", e);\r\n    showMessage(\"error\", `Failed to unban: ${  e.message || \"Network error\"}`);\r\n  }\r\n}\r\n\r\nfunction openDeleteModal(user) {\r\n  const modal = document.getElementById(\"delete-user-modal\");\r\n  if (!modal) {\r\n    showMessage(\"error\", \"Delete modal not found\");\r\n    return;\r\n  }\r\n\r\n  selectedUser = user;\r\n  const nameLabel = document.getElementById(\"delete-user-name\");\r\n  const emailLabel = document.getElementById(\"delete-user-email\");\r\n  const confirmInput = document.getElementById(\"delete-user-confirm-input\");\r\n  const reasonInput = document.getElementById(\"delete-user-reason\");\r\n\r\n  if (nameLabel) {\r\n    nameLabel.textContent = user.fullName || user.name || user.email || \"Selected user\";\r\n  }\r\n  if (emailLabel) {\r\n    emailLabel.textContent = user.email || \"N/A\";\r\n  }\r\n  if (confirmInput) {\r\n    confirmInput.value = \"\";\r\n    confirmInput.placeholder = (user.email || \"\").toLowerCase();\r\n  }\r\n  if (reasonInput) {\r\n    reasonInput.value = \"\";\r\n  }\r\n\r\n  modal.style.display = \"flex\";\r\n  modal.style.visibility = \"visible\";\r\n  modal.style.opacity = \"1\";\r\n  modal.style.zIndex = \"10000\";\r\n}\r\n\r\nfunction hideDeleteModal() {\r\n  const modal = document.getElementById(\"delete-user-modal\");\r\n  if (modal) {\r\n    modal.style.display = \"none\";\r\n    modal.style.visibility = \"hidden\";\r\n    modal.style.opacity = \"0\";\r\n  }\r\n}\r\n\r\nasync function onDeleteUserSubmit(e) {\r\n  e.preventDefault();\r\n  if (!selectedUser) {\r\n    showMessage(\"error\", \"No user selected for deletion\");\r\n    return;\r\n  }\r\n\r\n  const confirmInput = document.getElementById(\"delete-user-confirm-input\");\r\n  const reasonInput = document.getElementById(\"delete-user-reason\");\r\n  const submitBtn = document.getElementById(\"delete-user-submit\");\r\n\r\n  const expected = (selectedUser.email || \"\").toLowerCase();\r\n  const provided = (confirmInput?.value || \"\").trim().toLowerCase();\r\n  if (!expected || provided !== expected) {\r\n    showMessage(\"error\", \"Please type the user's email to confirm deletion\");\r\n    return;\r\n  }\r\n\r\n  const reason = (reasonInput?.value || \"\").trim();\r\n  if (!reason || reason.length < 10) {\r\n    showMessage(\"error\", \"Please provide a reason (at least 10 characters)\");\r\n    return;\r\n  }\r\n\r\n  if (submitBtn) {\r\n    submitBtn.disabled = true;\r\n    submitBtn.textContent = \"Deleting...\";\r\n  }\r\n\r\n  try {\r\n    const headers = await getAuthHeaders();\r\n    const res = await fetch(\"/api/compliance/delete\", {\r\n      method: \"DELETE\",\r\n      headers,\r\n      credentials: \"include\",\r\n      body: JSON.stringify({ userId: selectedUser.id, reason })\r\n    });\r\n    const result = await res.json().catch(() => ({}));\r\n    if (!res.ok || !result?.success) {\r\n      throw new Error(result?.error || \"Failed to delete user\");\r\n    }\r\n\r\n    showMessage(\"success\", \"User deleted successfully\");\r\n    hideDeleteModal();\r\n    selectedUser = null;\r\n    const details = document.getElementById(\"um-user-details\");\r\n    if (details) {\r\n      details.innerHTML = '<p class=\"empty-state\">Select a user to manage.</p>';\r\n    }\r\n    await refreshUserList();\r\n  } catch (error) {\r\n    console.error(\"[USER_MANAGER] Delete user error:\", error);\r\n    showMessage(\"error\", error.message || \"Failed to delete user\");\r\n  } finally {\r\n    if (submitBtn) {\r\n      submitBtn.disabled = false;\r\n      submitBtn.textContent = \"Delete User\";\r\n    }\r\n  }\r\n}\r\n\r\n// Make functions available globally for inline onclick handlers\r\nwindow.openBanModal = openBanModal;\r\nwindow.unbanUser = unbanUser;\r\nwindow.openDeleteModal = openDeleteModal;\r\n\r\nfunction escapeHtml(s) {\r\n  if (s == null) return \"\";\r\n  return String(s)\r\n    .replace(/&/g, \"&amp;\")\r\n    .replace(/</g, \"&lt;\")\r\n    .replace(/>/g, \"&gt;\")\r\n    .replace(/\"/g, \"&quot;\")\r\n    .replace(/'/g, \"&#39;\");\r\n}\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\auth.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\authUtils.js","messages":[{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":5,"column":22,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":9,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { storageAvailable } from \"./storage.js\";\n\nexport default function getCurrentUser() {\n  // Determine which storage to use\n  const useStorage = storageAvailable(\"localStorage\") ?\n    localStorage :\n    storageAvailable(\"sessionStorage\") ?\n      sessionStorage :\n      null;\n  if (!useStorage) {\n    console.error(\"No storage mechanism available\");\n    return null;\n  }\n  try {\n    console.log(\"Storage type:\", useStorage);\n    const userData = useStorage.getItem(\"user\");\n    console.log(\"User data from storage:\", userData);\n    if (!userData) return null;\n    const user = JSON.parse(userData);\n    console.log(\"Parsed user object:\", user);\n    if (!user || typeof user !== \"object\") return null;\n    // Check session expiration (1 hour timeout)\n    const lastActive = useStorage.getItem(\"lastActive\");\n    if (lastActive && Date.now() - parseInt(lastActive) > 3600000) {\n      console.warn(\"Session expired due to inactivity\");\n      useStorage.removeItem(\"user\");\n      return null;\n    }\n    // Update last active timestamp\n    useStorage.setItem(\"lastActive\", Date.now().toString());\n    return user;\n  } catch (error) {\n    console.error(\"Error parsing user data:\", error);\n    return null;\n  }\n}\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\boundaryValidator.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '>' and '!=='. Use parentheses to clarify the intended order of operations.","line":149,"column":27,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":149,"endColumn":28},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '>' and '!=='. Use parentheses to clarify the intended order of operations.","line":149,"column":31,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":149,"endColumn":34},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '!==' and '>'. Use parentheses to clarify the intended order of operations.","line":149,"column":31,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":149,"endColumn":34},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '!==' and '>'. Use parentheses to clarify the intended order of operations.","line":149,"column":38,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":149,"endColumn":39},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":150,"column":51,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":150,"endColumn":52},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":150,"column":63,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":150,"endColumn":64}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Digos City Boundary Validator (Frontend)\r\n * Validates if coordinates are within Digos City boundaries\r\n * Uses the actual polygon boundary from digos-city-boundary.json\r\n */\r\n\r\n// Cache for boundary data\r\nlet boundaryCache = null;\r\nlet boundaryLoadPromise = null;\r\n\r\n/**\r\n * Load Digos city boundary from JSON file\r\n */\r\nasync function loadDigosBoundary() {\r\n  if (boundaryCache) {\r\n    return boundaryCache;\r\n  }\r\n\r\n  if (boundaryLoadPromise) {\r\n    return boundaryLoadPromise;\r\n  }\r\n\r\n  boundaryLoadPromise = (async () => {\r\n    try {\r\n      // Try to fetch from API endpoint first (if it exists)\r\n      let response;\r\n      try {\r\n        response = await fetch(\"/api/digos-boundary\");\r\n        if (response.ok) {\r\n          const boundary = await response.json();\r\n          boundaryCache = boundary;\r\n          return boundary;\r\n        }\r\n        // If 404, silently fall back (don't log - this is expected if server not restarted)\r\n      } catch (err) {\r\n        // Network error - continue to fallback\r\n        console.debug(\"[BOUNDARY_VALIDATOR] Network error fetching API:\", err);\r\n      }\r\n\r\n      // Fallback: try to use barangay boundaries from /api/boundaries\r\n      // and construct city boundary from them\r\n      try {\r\n        response = await fetch(\"/api/boundaries\");\r\n        if (response.ok) {\r\n          const brgyData = await response.json();\r\n          if (Array.isArray(brgyData) && brgyData.length > 0) {\r\n            // Store barangay data for point-in-polygon checks\r\n            boundaryCache = {\r\n              type: \"barangay_boundaries\",\r\n              barangays: brgyData,\r\n              // Create a simple bounding box from all barangays\r\n              bounds: calculateBoundsFromBarangays(brgyData),\r\n            };\r\n            // Log that we're using barangay boundaries fallback (only once)\r\n            if (!boundaryCache._logged) {\r\n              console.log(\r\n                \"[BOUNDARY_VALIDATOR] Using barangay boundaries for validation\"\r\n              );\r\n              boundaryCache._logged = true;\r\n            }\r\n            return boundaryCache;\r\n          }\r\n        }\r\n      } catch (err) {\r\n        // Barangay boundaries API failed, continue to final fallback\r\n        console.debug(\r\n          \"[BOUNDARY_VALIDATOR] Error fetching barangay boundaries:\",\r\n          err\r\n        );\r\n      }\r\n\r\n      // Final fallback: try direct file path (may not work in production)\r\n      try {\r\n        response = await fetch(\"/assets/json/digos-city-boundary.json\");\r\n        if (response.ok) {\r\n          const boundary = await response.json();\r\n          boundaryCache = boundary;\r\n          return boundary;\r\n        }\r\n      } catch (err) {\r\n        // Direct file path also failed\r\n        console.debug(\r\n          \"[BOUNDARY_VALIDATOR] Error fetching static boundary file:\",\r\n          err\r\n        );\r\n      }\r\n\r\n      // If all methods failed, return null (will use bounding box fallback in validation)\r\n      return null;\r\n    } finally {\r\n      boundaryLoadPromise = null;\r\n    }\r\n  })();\r\n\r\n  return boundaryLoadPromise;\r\n}\r\n\r\n/**\r\n * Calculate bounding box from barangay boundaries\r\n * @param {Array} brgyData - Array of barangay data with geojson\r\n * @returns {Object} {minLng, maxLng, minLat, maxLat}\r\n */\r\nfunction calculateBoundsFromBarangays(brgyData) {\r\n  let minLng = Infinity,\r\n    maxLng = -Infinity;\r\n  let minLat = Infinity,\r\n    maxLat = -Infinity;\r\n\r\n  brgyData.forEach((barangay) => {\r\n    if (barangay.geojson && barangay.geojson.geometry) {\r\n      const coords = barangay.geojson.geometry.coordinates;\r\n      if (barangay.geojson.geometry.type === \"Polygon\") {\r\n        coords[0].forEach(([lng, lat]) => {\r\n          minLng = Math.min(minLng, lng);\r\n          maxLng = Math.max(maxLng, lng);\r\n          minLat = Math.min(minLat, lat);\r\n          maxLat = Math.max(maxLat, lat);\r\n        });\r\n      } else if (barangay.geojson.geometry.type === \"MultiPolygon\") {\r\n        coords.forEach((polygon) => {\r\n          polygon[0].forEach(([lng, lat]) => {\r\n            minLng = Math.min(minLng, lng);\r\n            maxLng = Math.max(maxLng, lng);\r\n            minLat = Math.min(minLat, lat);\r\n            maxLat = Math.max(maxLat, lat);\r\n          });\r\n        });\r\n      }\r\n    }\r\n  });\r\n\r\n  return { minLng, maxLng, minLat, maxLat };\r\n}\r\n\r\n/**\r\n * Check if a point is inside a polygon ring using ray casting algorithm\r\n * @param {Array} point - [longitude, latitude]\r\n * @param {Array} ring - Array of [longitude, latitude] coordinates\r\n * @returns {boolean}\r\n */\r\nfunction isPointInRing(point, ring) {\r\n  const [x, y] = point;\r\n  let inside = false;\r\n\r\n  for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {\r\n    const [xi, yi] = ring[i];\r\n    const [xj, yj] = ring[j];\r\n\r\n    const intersectY = yi > y !== yj > y;\r\n    const intersectX = x < ((xj - xi) * (y - yi)) / (yj - yi) + xi;\r\n    const intersect = intersectY && intersectX;\r\n    if (intersect) inside = !inside;\r\n  }\r\n\r\n  return inside;\r\n}\r\n\r\n/**\r\n * Check if a point is inside a polygon\r\n * @param {Array} point - [longitude, latitude]\r\n * @param {Array} coordinates - Polygon coordinates array\r\n * @returns {boolean}\r\n */\r\nfunction isPointInPolygon(point, coordinates) {\r\n  if (!coordinates || coordinates.length === 0) {\r\n    return false;\r\n  }\r\n\r\n  // Handle Polygon structure: [outerRing, hole1, hole2, ...]\r\n  const outerRing = coordinates[0];\r\n  if (!outerRing || outerRing.length === 0) {\r\n    return false;\r\n  }\r\n\r\n  let inside = isPointInRing(point, outerRing);\r\n\r\n  // Check holes (inner rings) - if point is in a hole, it's outside\r\n  if (inside && coordinates.length > 1) {\r\n    for (let i = 1; i < coordinates.length; i++) {\r\n      if (isPointInRing(point, coordinates[i])) {\r\n        inside = false;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  return inside;\r\n}\r\n\r\n/**\r\n * Validate if coordinates are within Digos City boundary\r\n * @param {number} latitude - Latitude coordinate\r\n * @param {number} longitude - Longitude coordinate\r\n * @returns {Promise<boolean>} True if coordinates are within city boundaries\r\n */\r\nasync function isWithinDigosBoundary(latitude, longitude) {\r\n  // Validate input\r\n  if (typeof latitude !== \"number\" || typeof longitude !== \"number\") {\r\n    return false;\r\n  }\r\n\r\n  if (latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {\r\n    return false;\r\n  }\r\n\r\n  // Load boundary\r\n  const boundary = await loadDigosBoundary();\r\n  if (!boundary) {\r\n    // Use bounding box fallback if boundary not available\r\n    const minLat = 6.723539;\r\n    const maxLat = 6.985025;\r\n    const minLng = 125.245633;\r\n    const maxLng = 125.39129;\r\n    return (\r\n      latitude >= minLat &&\r\n      latitude <= maxLat &&\r\n      longitude >= minLng &&\r\n      longitude <= maxLng\r\n    );\r\n  }\r\n\r\n  const point = [longitude, latitude]; // GeoJSON uses [lng, lat] order\r\n\r\n  // Handle barangay boundaries format (from /api/boundaries)\r\n  if (boundary.type === \"barangay_boundaries\" && boundary.barangays) {\r\n    return _checkBarangayBoundaries(boundary, point, latitude, longitude);\r\n  }\r\n\r\n  // Handle standard GeoJSON boundary format\r\n  if (boundary.geometry?.coordinates) {\r\n    return _checkGeoJsonBoundary(boundary, point);\r\n  }\r\n\r\n  console.warn(\"[BOUNDARY_VALIDATOR] Invalid boundary format\");\r\n  return true; // Fail open if boundary format invalid\r\n}\r\n\r\nfunction _checkBarangayBoundaries(boundary, point, latitude, longitude) {\r\n  // Check if point is within any barangay boundary\r\n  for (const barangay of boundary.barangays) {\r\n    if (barangay.geojson?.geometry) {\r\n      const coords = barangay.geojson.geometry.coordinates;\r\n      if (barangay.geojson.geometry.type === \"Polygon\") {\r\n        if (isPointInPolygon(point, coords)) {\r\n          return true;\r\n        }\r\n      } else if (barangay.geojson.geometry.type === \"MultiPolygon\") {\r\n        for (const polygon of coords) {\r\n          if (isPointInPolygon(point, polygon)) {\r\n            return true;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n  // If not in any barangay, check bounding box as fallback\r\n  if (boundary.bounds) {\r\n    return (\r\n      latitude >= boundary.bounds.minLat &&\r\n      latitude <= boundary.bounds.maxLat &&\r\n      longitude >= boundary.bounds.minLng &&\r\n      longitude <= boundary.bounds.maxLng\r\n    );\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction _checkGeoJsonBoundary(boundary, point) {\r\n  const { coordinates } = boundary.geometry;\r\n\r\n  // Handle Polygon geometry type\r\n  if (boundary.geometry.type === \"Polygon\") {\r\n    return isPointInPolygon(point, coordinates);\r\n  }\r\n\r\n  // Handle MultiPolygon geometry type\r\n  if (boundary.geometry.type === \"MultiPolygon\") {\r\n    // MultiPolygon: [[[ring1], [ring2]], [[ring3]]]\r\n    for (const polygon of coordinates) {\r\n      if (isPointInPolygon(point, polygon)) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  console.warn(\r\n    \"[BOUNDARY_VALIDATOR] Unsupported geometry type:\",\r\n    boundary.geometry.type\r\n  );\r\n  return true; // Fail open if geometry type not supported\r\n}\r\n\r\n/**\r\n * Get Digos city bounding box (for quick pre-check)\r\n * @returns {Promise<Object|null>} {minLng, maxLng, minLat, maxLat} or null\r\n */\r\nasync function getDigosBounds() {\r\n  const boundary = await loadDigosBoundary();\r\n  if (!boundary || !boundary.geometry || !boundary.geometry.coordinates) {\r\n    return null;\r\n  }\r\n\r\n  let minLng = Infinity,\r\n    maxLng = -Infinity;\r\n  let minLat = Infinity,\r\n    maxLat = -Infinity;\r\n\r\n  const { coordinates } = boundary.geometry;\r\n\r\n  function processRing(ring) {\r\n    for (const [lng, lat] of ring) {\r\n      minLng = Math.min(minLng, lng);\r\n      maxLng = Math.max(maxLng, lng);\r\n      minLat = Math.min(minLat, lat);\r\n      maxLat = Math.max(maxLat, lat);\r\n    }\r\n  }\r\n\r\n  if (boundary.geometry.type === \"Polygon\") {\r\n    for (const ring of coordinates) {\r\n      processRing(ring);\r\n    }\r\n  } else if (boundary.geometry.type === \"MultiPolygon\") {\r\n    for (const polygon of coordinates) {\r\n      for (const ring of polygon) {\r\n        processRing(ring);\r\n      }\r\n    }\r\n  }\r\n\r\n  return { minLng, maxLng, minLat, maxLat };\r\n}\r\n\r\n/**\r\n * Quick bounding box check (faster than full polygon check)\r\n * Use this for initial filtering before doing full polygon check\r\n * @param {number} latitude - Latitude coordinate\r\n * @param {number} longitude - Longitude coordinate\r\n * @returns {Promise<boolean>}\r\n */\r\nasync function isWithinDigosBounds(latitude, longitude) {\r\n  const bounds = await getDigosBounds();\r\n  if (!bounds) {\r\n    return true; // Fail open\r\n  }\r\n\r\n  return (\r\n    latitude >= bounds.minLat &&\r\n    latitude <= bounds.maxLat &&\r\n    longitude >= bounds.minLng &&\r\n    longitude <= bounds.maxLng\r\n  );\r\n}\r\n\r\nexport {\r\n  isWithinDigosBoundary,\r\n  isWithinDigosBounds,\r\n  getDigosBounds,\r\n  loadDigosBoundary,\r\n};\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\buttonState.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\complaint.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\csrf.js","messages":[{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":16,"column":7,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":16,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// CSRF token management utility\nlet csrfToken = null;\n\n/**\n * Get CSRF token from server\n * @returns {Promise<string>} CSRF token\n */\nexport const getCsrfToken = async () => {\n  if (csrfToken) {\n    return csrfToken;\n  }\n  try {\n    const response = await fetch(\"/api/auth/csrf-token\");\n    const data = await response.json();\n    if (data.success) {\n      csrfToken = data.csrfToken;\n      return csrfToken;\n    }\n    throw new Error(\"Failed to get CSRF token\");\n  } catch (error) {\n    console.error(\"CSRF token fetch failed:\", error);\n    throw error;\n  }\n};\n\n/**\n * Get fresh CSRF token from response headers\n * @param {Response} response - Fetch response object\n * @returns {string|null} CSRF token from headers\n */\nexport const getCsrfTokenFromHeaders = (response) => {\n  return response.headers.get(\"X-CSRF-Token\");\n};\n\n/**\n * Add CSRF token to form data\n * @param {FormData} formData - Form data to add token to\n */\nexport const addCsrfTokenToForm = async (formData) => {\n  try {\n    const token = await getCsrfToken();\n    formData.append(\"_csrf\", token);\n  } catch (error) {\n    console.error(\"Failed to add CSRF token to form:\", error);\n    throw error;\n  }\n};\n\n/**\n * Add CSRF token to request headers\n * @param {Object} headers - Headers object to add token to\n */\nexport const addCsrfTokenToHeaders = async (headers = {}) => {\n  try {\n    const token = await getCsrfToken();\n    headers[\"X-CSRF-Token\"] = token;\n    return headers;\n  } catch (error) {\n    console.error(\"Failed to add CSRF token to headers:\", error);\n    throw error;\n  }\n};\n\n/**\n * Clear stored CSRF token (useful after logout)\n */\nexport const clearCsrfToken = () => {\n  csrfToken = null;\n};\n\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\date.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\departmentUtils.js","messages":[{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":75,"column":10,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":75,"endColumn":109}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Department Utilities\n * Provides dynamic department name mapping and lookup functions\n */\nimport apiClient from \"../config/apiClient.js\";\n\n// Cache for department data\nlet departmentCache = null;\nlet cacheTimestamp = null;\nconst CACHE_DURATION = 5 * 60 * 1000; // 5 minutes\n/**\n * Get all departments with their codes and names\n */\n\nexport async function getDepartments() {\n  const now = Date.now();\n  // Return cached data if still valid\n  if (departmentCache && cacheTimestamp && (now - cacheTimestamp) < CACHE_DURATION) {\n    return departmentCache;\n  }\n  try {\n    const { data, error } = await apiClient.get(\"/api/department-structure/categories\");\n    if (error) throw error;\n    // Flatten the hierarchical structure into a simple array\n    const departments = [];\n    if (data) {\n      data.forEach(category => {\n        if (category.subcategories) {\n          category.subcategories.forEach(subcategory => {\n            if (subcategory.departments) {\n              subcategory.departments.forEach(dept => {\n                departments.push({\n                  id: dept.id,\n                  code: dept.code,\n                  name: dept.name,\n                  level: dept.level,\n                  subcategory: subcategory.name,\n                  category: category.name\n                });\n              });\n            }\n          });\n        }\n      });\n    }\n    // Cache the result\n    departmentCache = departments;\n    cacheTimestamp = now;\n    return departments;\n  } catch (error) {\n    console.error(\"Error fetching departments:\", error);\n    // Return empty array on error\n    return [];\n  }\n}\n/**\n * Get department name by code\n */\n\nexport async function getDepartmentNameByCode(code) {\n  const departments = await getDepartments();\n  const department = departments.find(dept => dept.code === code);\n  return department ? department.name : code;\n}\n\n/**\n * Get department name by ID or code (handles both numeric IDs and codes)\n */\nexport async function getDepartmentNameByIdOrCode(idOrCode) {\n  const departments = await getDepartments();\n  // Try to find by ID (if numeric) or by code\n  const department = departments.find(dept =>\n    String(dept.id) === String(idOrCode) || dept.code === idOrCode\n  );\n  return department ? department.name : (typeof idOrCode === \"number\" ? `Department ${idOrCode}` : idOrCode);\n}\n\n/**\n * Get all departments as a simple array (for dropdowns, etc.)\n * Uses /api/departments/active endpoint for better performance\n */\nlet activeDepartmentsCache = null;\nlet activeDepartmentsCacheTimestamp = null;\n\nexport async function getActiveDepartments() {\n  const now = Date.now();\n  // Return cached data if still valid\n  if (activeDepartmentsCache && activeDepartmentsCacheTimestamp && (now - activeDepartmentsCacheTimestamp) < CACHE_DURATION) {\n    return activeDepartmentsCache;\n  }\n  try {\n    const response = await fetch(\"/api/departments/active\");\n    const result = await response.json();\n    if (result.success && result.data) {\n      activeDepartmentsCache = result.data;\n      activeDepartmentsCacheTimestamp = now;\n      return result.data;\n    }\n    return [];\n  } catch (error) {\n    console.error(\"Error fetching active departments:\", error);\n    return [];\n  }\n}","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\dom.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\fileHandler.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\global-oauth-guard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\icons.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\message.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\navigation.js","messages":[{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":72,"column":42,"nodeType":"CallExpression","messageId":"returnsValue","endLine":72,"endColumn":66,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[2913,2937],"text":"{setTimeout(resolve, 150)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":148,"column":38,"nodeType":"CallExpression","messageId":"returnsValue","endLine":148,"endColumn":62,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[5438,5462],"text":"{setTimeout(resolve, 100)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":186,"column":36,"nodeType":"CallExpression","messageId":"returnsValue","endLine":186,"endColumn":60,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[6639,6663],"text":"{setTimeout(resolve, 500)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":229,"column":38,"nodeType":"CallExpression","messageId":"returnsValue","endLine":229,"endColumn":62,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[8253,8277],"text":"{setTimeout(resolve, 500)}"},"desc":"Wrap the expression in `{}`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Navigation utilities for clearing OAuth context on explicit navigation\r\nimport { getOAuthContext, clearOAuthContext } from \"../auth/authChecker.js\";\r\nimport { supabase } from \"../config/config.js\";\r\n\r\n/**\r\n * Clears incomplete OAuth signup context when user explicitly navigates\r\n * This should be called when user clicks login/signup buttons or brand logo\r\n */\r\nexport const clearOAuthOnNavigation = async () => {\r\n  try {\r\n    const ctx = getOAuthContext();\r\n    // Only cleanup if there's a pending OAuth attempt\r\n    // Only delete users for incomplete signups, not logins\r\n    if (ctx && ctx.status === \"pending\") {\r\n      // Get user ID before signing out (only for signups)\r\n      const shouldDeleteUser = ctx.intent === \"signup\";\r\n      const { data: { session } } = await supabase.auth.getSession();\r\n      const userId = session?.user?.id;\r\n\r\n      // Store user ID temporarily in case cleanup is interrupted\r\n      if (shouldDeleteUser && userId) {\r\n        try {\r\n          sessionStorage.setItem(\"cl_pending_deletion_user_id\", userId);\r\n        } catch {}\r\n      }\r\n\r\n      // Delete user from database if it's a signup and user exists\r\n      if (shouldDeleteUser && userId) {\r\n        let deletionSuccessful = false;\r\n\r\n        // Try deletion with access token if available\r\n        if (session?.access_token) {\r\n          try {\r\n            const token = session.access_token;\r\n            const headers = { \"Content-Type\": \"application/json\" };\r\n            headers[\"Authorization\"] = `Bearer ${token}`;\r\n\r\n            const deleteResponse = await fetch(\"/api/compliance/delete\", {\r\n              method: \"DELETE\",\r\n              headers,\r\n              credentials: \"include\",\r\n              body: JSON.stringify({\r\n                userId,\r\n                confirm: true,\r\n                reason: \"Incomplete OAuth signup cancelled - user navigated away\"\r\n              })\r\n            });\r\n\r\n            if (deleteResponse.ok) {\r\n              deletionSuccessful = true;\r\n            } else {\r\n              const errorData = await deleteResponse.json().catch(() => ({}));\r\n              const {status} = deleteResponse;\r\n              // Don't log auth errors - they're expected for incomplete signups\r\n              if (status !== 401 && status !== 403) {\r\n                console.warn(\"[NAV] Failed to delete incomplete OAuth user:\", {\r\n                  status,\r\n                  error: errorData.error || \"Unknown error\",\r\n                  userId\r\n                });\r\n              }\r\n            }\r\n          } catch (deleteError) {\r\n            console.warn(\"[NAV] Error during user deletion:\", deleteError.message);\r\n          }\r\n        }\r\n\r\n        // Retry deletion after a short delay if first attempt failed\r\n        // This handles race conditions where session might be cleared\r\n        if (!deletionSuccessful) {\r\n          try {\r\n            await new Promise(resolve => setTimeout(resolve, 150));\r\n\r\n            // Check if we still have a session for retry\r\n            const { data: { session: retrySession } } = await supabase.auth.getSession();\r\n            if (retrySession?.access_token) {\r\n              const token = retrySession.access_token;\r\n              const headers = { \"Content-Type\": \"application/json\" };\r\n              headers[\"Authorization\"] = `Bearer ${token}`;\r\n\r\n              const retryResponse = await fetch(\"/api/compliance/delete\", {\r\n                method: \"DELETE\",\r\n                headers,\r\n                credentials: \"include\",\r\n                body: JSON.stringify({\r\n                  userId,\r\n                  confirm: true,\r\n                  reason: \"Incomplete OAuth signup cancelled - retry deletion\"\r\n                })\r\n              });\r\n\r\n              if (retryResponse.ok) {\r\n                deletionSuccessful = true;\r\n              }\r\n            }\r\n          } catch (retryError) {\r\n            // Silently fail - we'll proceed with cleanup anyway\r\n          }\r\n        }\r\n\r\n        // Clear stored user ID on successful deletion\r\n        if (deletionSuccessful) {\r\n          try {\r\n            sessionStorage.removeItem(\"cl_pending_deletion_user_id\");\r\n          } catch {}\r\n        }\r\n      }\r\n\r\n      // Clear OAuth context first\r\n      clearOAuthContext();\r\n\r\n      // Aggressively clear session - multiple attempts\r\n      try {\r\n        await supabase.auth.signOut();\r\n      } catch {}\r\n\r\n      try {\r\n        await fetch(\"/auth/session\", { method: \"DELETE\", credentials: \"include\" });\r\n      } catch {}\r\n\r\n      // Force clear all Supabase storage\r\n      try {\r\n        const keys = Object.keys(localStorage);\r\n        keys.forEach(key => {\r\n          if (key.startsWith(\"sb-\") || key.includes(\"supabase\")) {\r\n            localStorage.removeItem(key);\r\n          }\r\n        });\r\n      } catch {}\r\n\r\n      // Verify and force clear again if needed\r\n      const { data: { session: verifySession } } = await supabase.auth.getSession();\r\n      if (verifySession) {\r\n        // Force another sign out\r\n        try {\r\n          await supabase.auth.signOut();\r\n        } catch {}\r\n        // Clear storage again\r\n        try {\r\n          const keys = Object.keys(localStorage);\r\n          keys.forEach(key => {\r\n            if (key.startsWith(\"sb-\") || key.includes(\"supabase\")) {\r\n              localStorage.removeItem(key);\r\n            }\r\n          });\r\n        } catch {}\r\n        // Wait a bit more\r\n        await new Promise(resolve => setTimeout(resolve, 100));\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.warn(\"[NAV] Error clearing OAuth context:\", error);\r\n  }\r\n};\r\n\r\n/**\r\n * Sets up click handlers for navigation elements (login/signup buttons, brand logo)\r\n * to clear OAuth context when clicked\r\n */\r\nexport const setupNavigationCleanup = () => {\r\n  const handleNavigationClick = async (e) => {\r\n    const target = e.currentTarget;\r\n    const href = target.getAttribute(\"href\");\r\n\r\n    // Only handle login/signup links\r\n    if (!href || (!href.includes(\"/login\") && !href.includes(\"/signup\"))) {\r\n      return;\r\n    }\r\n\r\n    // Check if we need to cleanup OAuth (both login and signup)\r\n    const ctx = getOAuthContext();\r\n    if (ctx && ctx.status === \"pending\") {\r\n      // Prevent default navigation\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n\r\n      // Set flag to prevent redirects on destination page\r\n      try {\r\n        sessionStorage.setItem(\"cl_oauth_cleanup\", \"true\");\r\n      } catch {}\r\n\r\n      // Clear OAuth context, delete user, and sign out\r\n      await clearOAuthOnNavigation();\r\n\r\n      // Wait a bit to ensure user deletion and session clearing completes\r\n      await new Promise(resolve => setTimeout(resolve, 500));\r\n\r\n      // Final check - clear session one more time before navigation\r\n      try {\r\n        await supabase.auth.signOut();\r\n        await fetch(\"/auth/session\", { method: \"DELETE\", credentials: \"include\" });\r\n      } catch {}\r\n\r\n      // Navigate manually with a cache-busting parameter to force fresh load\r\n      if (href) {\r\n        const separator = href.includes(\"?\") ? \"&\" : \"?\";\r\n        window.location.href = `${href}${separator}_t=${Date.now()}`;\r\n      }\r\n    }\r\n    // If no OAuth cleanup needed, let default navigation proceed\r\n  };\r\n\r\n  // Setup click handlers for login/signup buttons by ID\r\n  const loginBtn = document.getElementById(\"login-btn\");\r\n  const signupBtn = document.getElementById(\"signup-btn\");\r\n\r\n  if (loginBtn) {\r\n    loginBtn.addEventListener(\"click\", handleNavigationClick);\r\n  }\r\n  if (signupBtn) {\r\n    signupBtn.addEventListener(\"click\", handleNavigationClick);\r\n  }\r\n\r\n  // Setup click handlers for auth links in footer (class=\"auth-link\")\r\n  const authLinks = document.querySelectorAll('a.auth-link[href*=\"/login\"], a.auth-link[href*=\"/signup\"]');\r\n  authLinks.forEach(link => {\r\n    link.addEventListener(\"click\", handleNavigationClick);\r\n  });\r\n\r\n  // Setup click handler for brand logo\r\n  const brandLogo = document.querySelector(\".brand-logo\");\r\n  if (brandLogo) {\r\n    brandLogo.addEventListener(\"click\", async (e) => {\r\n      const ctx = getOAuthContext();\r\n      if (ctx && ctx.status === \"pending\") {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        await clearOAuthOnNavigation();\r\n        await new Promise(resolve => setTimeout(resolve, 500));\r\n        // Final check - clear session one more time before navigation\r\n        try {\r\n          await supabase.auth.signOut();\r\n          await fetch(\"/auth/session\", { method: \"DELETE\", credentials: \"include\" });\r\n        } catch {}\r\n        window.location.href = `/?_t=${Date.now()}`;\r\n      }\r\n    });\r\n  }\r\n\r\n  // Setup click handlers for any other login/signup links (like \"Get Started\" buttons)\r\n  const allLoginSignupLinks = document.querySelectorAll('a[href*=\"/login\"], a[href*=\"/signup\"]');\r\n  allLoginSignupLinks.forEach(link => {\r\n    // Skip if already handled above\r\n    if (link.id === \"login-btn\" || link.id === \"signup-btn\" || link.classList.contains(\"auth-link\")) {\r\n      return;\r\n    }\r\n    link.addEventListener(\"click\", handleNavigationClick);\r\n  });\r\n};\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\oauth-cleanup.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'supabase' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'clearOAuthContext' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Aggressive OAuth cleanup utility\r\nimport { supabase } from \"../config/config.js\";\r\nimport { getOAuthContext, clearOAuthContext } from \"../auth/authChecker.js\";\r\n\r\n/**\r\n * Clears OAuth session and context (without deleting users)\r\n * This should be called to clear stale sessions, but NOT to delete users\r\n * User deletion should only happen on explicit navigation clicks\r\n */\r\n// aggressiveOAuthCleanup removed - replaced by GlobalOAuthGuard\r\n// This file now only contains helper utilities\r\n\r\n/**\r\n * Checks if we should skip authentication checks due to pending OAuth cleanup\r\n */\r\nexport const shouldSkipAuthCheck = () => {\r\n  try {\r\n    const ctx = getOAuthContext();\r\n    return ctx && ctx.status === \"pending\";\r\n  } catch {\r\n    return false;\r\n  }\r\n};\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\passwordToggle.js","messages":[{"ruleId":"no-lonely-if","severity":1,"message":"Unexpected if as the only statement in an else block.","line":34,"column":5,"nodeType":"IfStatement","messageId":"unexpectedLonelyIf","endLine":36,"endColumn":6}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Password Visibility Toggle Utility\n * Adds show/hide password functionality to all password input fields\n */\n\n/**\n * Initialize password toggle for a single password input\n * @param {HTMLInputElement} passwordInput - The password input element\n */\nfunction initPasswordToggle(passwordInput) {\n  if (!passwordInput || passwordInput.type !== \"password\") {\n    return;\n  }\n\n  // Check if toggle already exists\n  if (passwordInput.dataset.toggleInitialized === \"true\") {\n    return;\n  }\n\n  // Mark as initialized\n  passwordInput.dataset.toggleInitialized = \"true\";\n\n  // Find the input wrapper or create one\n  let wrapper = passwordInput.parentElement;\n  if (!wrapper || !wrapper.classList.contains(\"input-wrapper\")) {\n    // If no wrapper, wrap the input\n    wrapper = document.createElement(\"div\");\n    wrapper.className = \"input-wrapper\";\n    wrapper.style.position = \"relative\"; // Ensure relative positioning\n    passwordInput.parentNode.insertBefore(wrapper, passwordInput);\n    wrapper.appendChild(passwordInput);\n  } else {\n    // Ensure wrapper has relative positioning\n    if (getComputedStyle(wrapper).position === \"static\") {\n      wrapper.style.position = \"relative\";\n    }\n  }\n\n  // Create toggle button\n  const toggleBtn = document.createElement(\"button\");\n  toggleBtn.type = \"button\";\n  toggleBtn.className = \"password-toggle\";\n  toggleBtn.setAttribute(\"aria-label\", \"Toggle password visibility\");\n  toggleBtn.innerHTML = `\n    <svg class=\"eye-icon eye-show\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n      <path d=\"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z\"/>\n      <circle cx=\"12\" cy=\"12\" r=\"3\"/>\n    </svg>\n    <svg class=\"eye-icon eye-hide\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" style=\"display: none;\">\n      <path d=\"M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24\"/>\n      <line x1=\"1\" y1=\"1\" x2=\"23\" y2=\"23\"/>\n    </svg>\n  `;\n\n  // Add toggle functionality\n  toggleBtn.addEventListener(\"click\", (e) => {\n    e.preventDefault();\n    e.stopPropagation();\n\n    const isPassword = passwordInput.type === \"password\";\n    passwordInput.type = isPassword ? \"text\" : \"password\";\n\n    // Toggle icon visibility\n    const showIcon = toggleBtn.querySelector(\".eye-show\");\n    const hideIcon = toggleBtn.querySelector(\".eye-hide\");\n\n    if (isPassword) {\n      // Show password - show hide icon\n      showIcon.style.display = \"none\";\n      hideIcon.style.display = \"block\";\n      toggleBtn.setAttribute(\"aria-label\", \"Hide password\");\n    } else {\n      // Hide password - show show icon\n      showIcon.style.display = \"block\";\n      hideIcon.style.display = \"none\";\n      toggleBtn.setAttribute(\"aria-label\", \"Show password\");\n    }\n  });\n\n  // Insert toggle button - always append to wrapper (will be positioned absolutely)\n  wrapper.appendChild(toggleBtn);\n}\n\n/**\n * Initialize password toggles for all password inputs on the page\n */\nexport function initAllPasswordToggles() {\n  // Find all password inputs\n  const passwordInputs = document.querySelectorAll('input[type=\"password\"]');\n\n  passwordInputs.forEach(input => {\n    initPasswordToggle(input);\n  });\n\n  // Also watch for dynamically added password inputs\n  const observer = new MutationObserver((mutations) => {\n    mutations.forEach((mutation) => {\n      mutation.addedNodes.forEach((node) => {\n        if (node.nodeType === 1) { // Element node\n          if (node.tagName === \"INPUT\" && node.type === \"password\") {\n            initPasswordToggle(node);\n          }\n          // Check children\n          const passwordInputs = node.querySelectorAll?.('input[type=\"password\"]');\n          if (passwordInputs) {\n            passwordInputs.forEach(input => initPasswordToggle(input));\n          }\n        }\n      });\n    });\n  });\n\n  observer.observe(document.body, {\n    childList: true,\n    subtree: true\n  });\n}\n\n// Auto-initialize on DOM ready\nif (document.readyState === \"loading\") {\n  document.addEventListener(\"DOMContentLoaded\", initAllPasswordToggles);\n} else {\n  initAllPasswordToggles();\n}\n\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\privacyContent.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\roleUtils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\storage.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\string.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\public\\js\\utils\\validation.js","messages":[{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\\".","line":10,"column":35,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":10,"endColumn":36,"suggestions":[{"messageId":"removeEscape","fix":{"range":[346,347],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[346,346],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\[.","line":72,"column":25,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":72,"endColumn":26,"suggestions":[{"messageId":"removeEscape","fix":{"range":[2222,2223],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[2222,2222],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\/.","line":72,"column":42,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":72,"endColumn":43,"suggestions":[{"messageId":"removeEscape","fix":{"range":[2239,2240],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[2239,2239],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Input validation and sanitization utilities\r\n/**\r\n * Sanitize string input by removing potentially dangerous characters\r\n * @param {string} input - Input string to sanitize\r\n * @returns {string} Sanitized string\r\n */\r\n\r\nexport const sanitizeString = (input) => {\r\n  if (typeof input !== \"string\") return \"\";\r\n  return input.trim().replace(/[<>\\\"'&]/g, (match) => {\r\n    const entityMap = {\r\n      \"<\": \"&lt;\",\r\n      \">\": \"&gt;\",\r\n      '\"': \"&quot;\",\r\n      \"'\": \"&#x27;\",\r\n      \"&\": \"&amp;\",\r\n    };\r\n    return entityMap[match];\r\n  });\r\n};\r\n/**\r\n * Validate email format\r\n * @param {string} email - Email to validate\r\n * @returns {boolean} True if valid email format\r\n */\r\n\r\nexport const isValidEmail = (email) => {\r\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n  return emailRegex.test(email);\r\n};\r\n/**\r\n * Validate mobile number (Philippine format)\r\n * @param {string} mobile - Mobile number to validate\r\n * @returns {boolean} True if valid Philippine mobile number\r\n */\r\n\r\nexport const isValidPhilippineMobile = (mobile) => {\r\n  // Remove +63 prefix if present\r\n  const cleanMobile = mobile.replace(/^\\+63/, \"\");\r\n  // Should be 10 digits starting with 9\r\n  const mobileRegex = /^9\\d{9}$/;\r\n  return mobileRegex.test(cleanMobile);\r\n};\r\n/**\r\n * Validate password strength\r\n * @param {string} password - Password to validate\r\n * @returns {Object} Validation result with isValid and errors\r\n */\r\n\r\nexport const validatePassword = (password) => {\r\n  const errors = [];\r\n  const minLength = 8;\r\n  const maxLength = 128;\r\n  if (typeof password !== \"string\") {\r\n    return { isValid: false, errors: [\"Password is required\"] };\r\n  }\r\n  if (password.length < minLength) {\r\n    errors.push(`Password must be at least ${minLength} characters long`);\r\n  }\r\n  if (password.length > maxLength) {\r\n    errors.push(`Password must not exceed ${maxLength} characters`);\r\n  }\r\n  if (!/[A-Z]/.test(password)) {\r\n    errors.push(\"Password must contain at least one uppercase letter\");\r\n  }\r\n  if (!/[a-z]/.test(password)) {\r\n    errors.push(\"Password must contain at least one lowercase letter\");\r\n  }\r\n  if (!/\\d/.test(password)) {\r\n    errors.push(\"Password must contain at least one number\");\r\n  }\r\n  if (!/[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(password)) {\r\n    errors.push(\"Password must contain at least one special character\");\r\n  }\r\n  return { isValid: errors.length === 0, errors };\r\n};\r\n/**\r\n * Validate and sanitize form data\r\n * @param {Object} formData - Form data object\r\n * @param {Object} rules - Validation rules for each field\r\n * @returns {Object} Validation result with sanitized data and errors\r\n */\r\n\r\nexport const validateAndSanitizeForm = (formData, rules) => {\r\n  const sanitizedData = {};\r\n  const errors = [];\r\n  for (const [field, value] of Object.entries(formData)) {\r\n    const rule = rules[field];\r\n    if (!rule) {\r\n      // No validation rule, just sanitize\r\n      sanitizedData[field] = sanitizeString(value);\r\n      continue;\r\n    }\r\n    // Check required fields\r\n    if (\r\n      rule.required &&\r\n      (!value ||\r\n        (typeof value === \"string\" && value.trim() === \"\") ||\r\n        value === null ||\r\n        value === void 0)\r\n    ) {\r\n      errors.push(`${field} is required`);\r\n      continue;\r\n    }\r\n    // Skip validation if field is empty and not required\r\n    if (\r\n      !value ||\r\n      (typeof value === \"string\" && value.trim() === \"\") ||\r\n      value === null ||\r\n      value === void 0\r\n    ) {\r\n      sanitizedData[field] = \"\";\r\n      continue;\r\n    }\r\n    // Apply sanitization\r\n    const sanitizedValue = sanitizeString(value);\r\n    // Apply specific validations\r\n    if (rule.type === \"email\" && !isValidEmail(sanitizedValue)) {\r\n      errors.push(`Invalid email format for ${field}`);\r\n    }\r\n    if (rule.type === \"mobile\" && !isValidPhilippineMobile(sanitizedValue)) {\r\n      errors.push(`Invalid Philippine mobile number for ${field}`);\r\n    }\r\n    if (rule.type === \"password\") {\r\n      const passwordValidation = validatePassword(sanitizedValue);\r\n      if (!passwordValidation.isValid) {\r\n        errors.push(\r\n          ...passwordValidation.errors.map((error) => `${field}: ${error}`)\r\n        );\r\n      }\r\n    }\r\n    if (rule.maxLength && sanitizedValue.length > rule.maxLength) {\r\n      errors.push(`${field} must not exceed ${rule.maxLength} characters`);\r\n    }\r\n    if (rule.minLength && sanitizedValue.length < rule.minLength) {\r\n      errors.push(\r\n        `${field} must be at least ${rule.minLength} characters long`\r\n      );\r\n    }\r\n    sanitizedData[field] = sanitizedValue;\r\n  }\r\n  return {\r\n    isValid: errors.length === 0,\r\n    sanitizedData,\r\n    errors,\r\n  };\r\n};\r\n/**\r\n * Validate file upload\r\n * @param {FileList|File[]} files - Files to validate\r\n * @param {Object} options - Validation options\r\n * @returns {Object} Validation result\r\n */\r\n\r\nexport const validateFileUpload = (files, options = {}) => {\r\n  const {\r\n    maxSize = 10 * 1024 * 1024, // 10MB default\r\n    maxFiles = 5,\r\n    allowedTypes = [\r\n      \"image/jpeg\",\r\n      \"image/png\",\r\n      \"image/webp\",\r\n      \"application/pdf\",\r\n      \"video/mp4\",\r\n    ],\r\n  } = options;\r\n  const errors = [];\r\n  if (files.length > maxFiles) {\r\n    errors.push(`Maximum ${maxFiles} files allowed`);\r\n  }\r\n  for (let i = 0; i < files.length; i++) {\r\n    const file = files[i];\r\n    if (file.size > maxSize) {\r\n      errors.push(\r\n        `File ${file.name} exceeds maximum size of ${Math.round(\r\n          maxSize / 1024 / 1024\r\n        )}MB`\r\n      );\r\n    }\r\n    if (!allowedTypes.includes(file.type)) {\r\n      errors.push(\r\n        `File ${\r\n          file.name\r\n        } has unsupported type. Allowed types: ${allowedTypes.join(\", \")}`\r\n      );\r\n    }\r\n  }\r\n  return {\r\n    isValid: errors.length === 0,\r\n    errors,\r\n  };\r\n};\r\n/**\r\n * Validate a batch of new files against constraints and existing selection\r\n * Returns filtered valid files and a list of human-readable errors\r\n * @param {FileList|File[]} newFiles\r\n * @param {File[]} existingFiles\r\n * @param {Object} options\r\n * @param {number} options.maxFiles\r\n * @param {number} options.maxSize\r\n * @param {string[]} options.allowedTypes\r\n * @returns {{ validFiles: File[], errors: string[] }}\r\n */\r\n\r\nexport const validateFiles = (newFiles, existingFiles = [], options = {}) => {\r\n  const maxSize = options.maxSize ?? 10 * 1024 * 1024;\r\n  const maxFiles = options.maxFiles ?? 5;\r\n  const allowedTypes = options.allowedTypes ?? [\r\n    \"image/jpeg\",\r\n    \"image/png\",\r\n    \"image/webp\",\r\n    \"application/pdf\",\r\n    \"video/mp4\",\r\n  ];\r\n  const errors = [];\r\n  const validFiles = [];\r\n  if (!newFiles || newFiles.length === 0) {\r\n    return { validFiles, errors };\r\n  }\r\n  // Build a set to detect duplicates (by name+size+type)\r\n  const existingKey = (f) => `${f.name}:${f.size}:${f.type}`;\r\n  const existingSet = new Set((existingFiles || []).map(existingKey));\r\n  for (let i = 0; i < newFiles.length; i++) {\r\n    const file = newFiles[i];\r\n    // Enforce overall max files\r\n    if (existingFiles.length + validFiles.length >= maxFiles) {\r\n      errors.push(`Maximum ${maxFiles} files allowed`);\r\n      break;\r\n    }\r\n    // Type check\r\n    if (!allowedTypes.includes(file.type)) {\r\n      errors.push(`File ${file.name} has unsupported type`);\r\n      continue;\r\n    }\r\n    // Size check\r\n    if (file.size > maxSize) {\r\n      const mb = Math.round(maxSize / 1024 / 1024);\r\n      errors.push(`File ${file.name} exceeds maximum size of ${mb}MB`);\r\n      continue;\r\n    }\r\n    // Duplicate check\r\n    const key = existingKey(file);\r\n    if (\r\n      existingSet.has(key) ||\r\n      validFiles.some((f) => existingKey(f) === key)\r\n    ) {\r\n      errors.push(`File ${file.name} is already selected`);\r\n      continue;\r\n    }\r\n    validFiles.push(file);\r\n  }\r\n  return { validFiles, errors };\r\n};\r\n/**\r\n * Attach realtime validation to a form (HTML5 validity + custom rules)\r\n * @param {HTMLFormElement} form\r\n */\r\n\r\nexport const setupRealtimeValidation = (form) => {\r\n  if (!form) return;\r\n  const setError = (input, message) => {\r\n    if (!input) return;\r\n    input.setCustomValidity(message || \"\");\r\n    // Do not spam reportValidity on each keystroke; only clear silently\r\n    if (!message) return;\r\n    try {\r\n      input.reportValidity();\r\n    } catch {}\r\n  };\r\n  const rules = {\r\n    \"#complaintTitle\": { required: true, minLength: 3 },\r\n    \"#description\": { required: true, minLength: 10 },\r\n    \"#location\": { required: true },\r\n    \"#complaintCategory\": { required: true },\r\n    \"#complaintSubcategory\": { required: true },\r\n    \"#urgencyLevel\": { required: true },\r\n  };\r\n  const validateTarget = (selector) => {\r\n    const input = form.querySelector(selector);\r\n    if (!input) return;\r\n    const value = (input.value || \"\").trim();\r\n    const rule = rules[selector] || {};\r\n    if (rule.required && !value) {\r\n      return setError(input, \"This field is required\");\r\n    }\r\n    if (rule.minLength && value.length < rule.minLength) {\r\n      return setError(input, `Must be at least ${rule.minLength} characters`);\r\n    }\r\n    setError(input, \"\");\r\n  };\r\n  // Wire inputs\r\n  Object.keys(rules).forEach((selector) => {\r\n    const input = form.querySelector(selector);\r\n    if (!input) return;\r\n    const formGroup = input.closest(\".form-group\");\r\n    [\"input\", \"change\", \"blur\"].forEach((evt) => {\r\n      input.addEventListener(evt, () => {\r\n        // Add touched class when user interacts with the field\r\n        if (formGroup) formGroup.classList.add(\"touched\");\r\n        validateTarget(selector);\r\n      });\r\n    });\r\n  });\r\n  // Initial pass - removed to prevent immediate validation errors\r\n  // Object.keys(rules).forEach(validateTarget);\r\n};\r\n/**\r\n * Extract complaint form data from DOM\r\n * @param {HTMLFormElement} formElement\r\n * @returns {Object}\r\n */\r\n\r\nexport const extractComplaintFormData = (formElement) => {\r\n  if (!formElement) return {};\r\n  const getVal = (selector) => {\r\n    const el = formElement.querySelector(selector);\r\n    return el ? el.value.trim() : \"\";\r\n  };\r\n  const parseNum = (selector) => {\r\n    const v = getVal(selector);\r\n    if (v === \"\") return null;\r\n    const n = Number(v);\r\n    return Number.isFinite(n) ? n : null;\r\n  };\r\n  // Collect selected departments (checkboxes inside #departmentCheckboxes)\r\n  const departments = Array.from(\r\n    formElement.querySelectorAll(\r\n      '#departmentCheckboxes input[type=\"checkbox\"]:checked'\r\n    )\r\n  ).map((cb) => cb.value);\r\n  return {\r\n    title: getVal(\"#complaintTitle\"),\r\n    // type field removed - not in current schema\r\n    // subtype field removed - not in current schema\r\n    category: getVal(\"#complaintCategory\"),\r\n    subcategory: getVal(\"#complaintSubcategory\"),\r\n    description: getVal(\"#description\"),\r\n    location_text: getVal(\"#location\"),\r\n    latitude: parseNum(\"#latitude\"),\r\n    longitude: parseNum(\"#longitude\"),\r\n    urgency_level: getVal(\"#urgencyLevel\"),\r\n    departments,\r\n  };\r\n};\r\n\r\n/**\r\n * Check if coordinates are within Digos City boundaries\r\n * Uses the actual Digos city boundary polygon from digos-city-boundary.json\r\n * @param {number} latitude - Latitude coordinate\r\n * @param {number} longitude - Longitude coordinate\r\n * @returns {Promise<boolean>} True if coordinates are within city boundaries\r\n */\r\nexport const isWithinCityBoundary = async (latitude, longitude) => {\r\n  try {\r\n    const { isWithinDigosBoundary } = await import(\"./boundaryValidator.js\");\r\n    return await isWithinDigosBoundary(latitude, longitude);\r\n  } catch (error) {\r\n    console.warn(\"[VALIDATION] Boundary check failed:\", error);\r\n    // Fallback: Simple bounding box check for Digos City\r\n    // Based on actual bounds from boundary file\r\n    const minLat = 6.723539;\r\n    const maxLat = 6.985025;\r\n    const minLng = 125.245633;\r\n    const maxLng = 125.39129;\r\n    return (\r\n      latitude >= minLat &&\r\n      latitude <= maxLat &&\r\n      longitude >= minLng &&\r\n      longitude <= maxLng\r\n    );\r\n  }\r\n};\r\n/**\r\n * Validate complaint form data\r\n * @param {Object} data\r\n * @returns {{ valid: boolean, errors: string[] }}\r\n */\r\n\r\nexport const validateComplaintForm = (data) => {\r\n  const errors = [];\r\n  if (!data) {\r\n    return { valid: false, errors: [\"Invalid form data\"] };\r\n  }\r\n  const title = sanitizeString(data.title || \"\");\r\n  const description = sanitizeString(data.description || \"\");\r\n  const locationText = sanitizeString(data.location_text || \"\");\r\n  const category = sanitizeString(data.category || \"\");\r\n  const subcategory = sanitizeString(data.subcategory || \"\");\r\n  if (!title || title.trim().length === 0) errors.push(\"Title is required\");\r\n  if (title && title.length < 3)\r\n    errors.push(\"Title must be at least 3 characters\");\r\n  if (!description || description.trim().length === 0)\r\n    errors.push(\"Description is required\");\r\n  if (description && description.length < 10)\r\n    errors.push(\"Description must be at least 10 characters\");\r\n  if (!locationText) errors.push(\"Location is required\");\r\n  // Validate hierarchical form fields\r\n  if (!category) errors.push(\"Category is required\");\r\n  if (!subcategory) errors.push(\"Subcategory is required\");\r\n  if (!data.urgency_level) errors.push(\"Urgency level is required\");\r\n  // Validate departments\r\n  if (!data.departments || data.departments.length === 0) {\r\n    errors.push(\"At least one department must be selected\");\r\n  }\r\n  // If one coordinate is provided, both should be valid numbers\r\n  const hasLat = data.latitude !== null && data.latitude !== void 0;\r\n  const hasLng = data.longitude !== null && data.longitude !== void 0;\r\n  if ((hasLat && !hasLng) || (!hasLat && hasLng)) {\r\n    errors.push(\"Both latitude and longitude must be provided\");\r\n  }\r\n  if (hasLat && hasLng) {\r\n    if (\r\n      typeof data.latitude !== \"number\" ||\r\n      typeof data.longitude !== \"number\"\r\n    ) {\r\n      errors.push(\"Coordinates must be numeric\");\r\n    }\r\n    // Note: Boundary check is async, so it should be done separately before form submission\r\n    // This validation function is synchronous, so boundary check happens in the form handler\r\n  }\r\n  return { valid: errors.length === 0, errors };\r\n};\r\n\r\n/**\r\n * Validate complaint coordinates against Digos boundary (async)\r\n * @param {number} latitude - Latitude coordinate\r\n * @param {number} longitude - Longitude coordinate\r\n * @returns {Promise<{valid: boolean, error?: string}>}\r\n */\r\nexport const validateComplaintCoordinates = async (latitude, longitude) => {\r\n  if (typeof latitude !== \"number\" || typeof longitude !== \"number\") {\r\n    return { valid: false, error: \"Coordinates must be numeric\" };\r\n  }\r\n\r\n  if (latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {\r\n    return { valid: false, error: \"Invalid coordinate values\" };\r\n  }\r\n\r\n  const withinBoundary = await isWithinCityBoundary(latitude, longitude);\r\n  if (!withinBoundary) {\r\n    return {\r\n      valid: false,\r\n      error: \"Complaint location must be within Digos City boundaries\",\r\n    };\r\n  }\r\n\r\n  return { valid: true };\r\n};\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\scripts\\fix_css.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\scripts\\security-scan.js","messages":[],"suppressedMessages":[{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found readdirSync from package \"fs\" with non literal argument at index 0","line":57,"column":17,"nodeType":"CallExpression","endLine":57,"endColumn":40,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found statSync from package \"fs\" with non literal argument at index 0","line":60,"column":9,"nodeType":"CallExpression","endLine":60,"endColumn":42,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found readFileSync from package \"fs\" with non literal argument at index 0","line":82,"column":23,"nodeType":"CallExpression","endLine":82,"endColumn":52,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\server.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\shared\\constants.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\admin\\departments.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":246,"column":10,"nodeType":"CallExpression","messageId":"unexpected","endLine":246,"endColumn":77}],"suppressedMessages":[{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":149,"column":16,"nodeType":"Literal","endLine":149,"endColumn":69,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":162,"column":16,"nodeType":"Literal","endLine":162,"endColumn":69,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":167,"column":16,"nodeType":"Literal","endLine":167,"endColumn":63,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import apiClient from \"../config/apiClient.js\";\r\nimport showMessage from \"../components/toast.js\";\r\n\r\nclass DepartmentManager {\r\n\r\n  constructor() {\r\n    this.departments = [];\r\n    this.currentDepartment = null;\r\n    this.init();\r\n  }\r\n  async init() {\r\n    await this.loadDepartments();\r\n    this.setupEventListeners();\r\n    this.startStatusRefresh();\r\n  }\r\n  setupEventListeners() {\r\n    const form = document.getElementById(\"departmentForm\");\r\n    if (form) {\r\n      form.addEventListener(\"submit\", (e) => this.handleSubmit(e));\r\n    }\r\n    // Auto-format department code\r\n    const codeInput = document.getElementById(\"departmentCode\");\r\n    if (codeInput) {\r\n      codeInput.addEventListener(\"input\", (e) => {\r\n        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9_]/g, \"\");\r\n      });\r\n    }\r\n  }\r\n  async loadDepartments() {\r\n    try {\r\n      const response = await apiClient.get(\"/api/departments/active\");\r\n      if (response.success) {\r\n        this.departments = response.data;\r\n        // Load officers for each department\r\n        await this.loadOfficersForAllDepartments();\r\n        this.renderDepartments();\r\n        this.updateStats();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to load departments:\", error);\r\n      showMessage(\"error\", \"Failed to load departments\");\r\n    }\r\n  }\r\n  async loadOfficersForAllDepartments() {\r\n    const promises = this.departments.map(async (dept) => {\r\n      try {\r\n        const response = await apiClient.getDepartmentOfficers(dept.id);\r\n        if (response.success) {\r\n          dept.officers = response.data.map(officer => ({\r\n            ...officer,\r\n            lastSeenText: this.getLastSeenText(officer.last_sign_in_at),\r\n            statusClass: this.getStatusClass(officer.is_online, officer.last_sign_in_at)\r\n          }));\r\n          dept.officersVisible = false; // Initially hidden\r\n        } else {\r\n          dept.officers = [];\r\n          dept.officersVisible = false;\r\n        }\r\n      } catch (error) {\r\n        console.error(`Failed to load officers for department ${dept.name}:`, error);\r\n        dept.officers = [];\r\n        dept.officersVisible = false;\r\n      }\r\n    });\r\n    await Promise.all(promises);\r\n  }\r\n  renderDepartments() {\r\n    const grid = document.getElementById(\"departmentGrid\");\r\n    if (!grid) return;\r\n    // Use safer DOM manipulation instead of innerHTML\r\n    grid.innerHTML = \"\";\r\n    const safeHtml = this.departments.map(dept => `\r\n      <div class=\"department-card\">\r\n        <div class=\"department-header\">\r\n          <span class=\"department-code\">${dept.code}</span>\r\n          <span class=\"status-badge ${dept.is_active ? \"status-active\" : \"status-inactive\"}\">\r\n            ${dept.is_active ? \"Active\" : \"Inactive\"}\r\n          </span>\r\n        </div>\r\n        <h3>${dept.name}</h3>\r\n        <p>${dept.description || \"No description provided\"}</p>\r\n\r\n        <div class=\"officers-section\" id=\"officers-${dept.id}\">\r\n          <div class=\"officers-header\">\r\n            <h4>Officers (${dept.officers ? dept.officers.length : 0})</h4>\r\n            <button class=\"toggle-officers\" onclick=\"departmentManager.toggleOfficers(${dept.id})\">\r\n              ${dept.officersVisible ? \"Hide\" : \"Show\"} Officers\r\n            </button>\r\n          </div>\r\n          <div class=\"officers-list\" style=\"display: ${dept.officersVisible ? \"grid\" : \"none\"}\">\r\n            ${dept.officers && dept.officers.length > 0 ?\r\n    dept.officers.map(officer => `\r\n                <div class=\"officer-item\">\r\n                  <div class=\"officer-status\">\r\n                    <div class=\"officer-avatar\">${officer.name.charAt(0).toUpperCase()}</div>\r\n                    <div class=\"status-indicator ${officer.statusClass}\"></div>\r\n                  </div>\r\n                  <div class=\"officer-info\">\r\n                    <p class=\"officer-name\">${officer.name}</p>\r\n                    <p class=\"officer-role\">${officer.role || \"Officer\"}</p>\r\n                    <p class=\"officer-status-text ${officer.statusClass}-text\">\r\n                      ${officer.is_online ? \"Online\" : \"Offline\"}\r\n                    </p>\r\n                    <p class=\"officer-last-seen\">${officer.lastSeenText}</p>\r\n                  </div>\r\n                </div>\r\n              `).join(\"\") :\r\n    '<div class=\"no-officers\">No officers assigned to this department</div>'\r\n}\r\n          </div>\r\n        </div>\r\n        <div class=\"department-actions\">\r\n          <button class=\"btn btn-sm btn-primary\" onclick=\"departmentManager.editDepartment(${dept.id})\">\r\n            Edit\r\n          </button>\r\n          <button class=\"btn btn-sm ${dept.is_active ? \"btn-warning\" : \"btn-success\"}\"\r\n                  onclick=\"departmentManager.toggleStatus(${dept.id})\">\r\n            ${dept.is_active ? \"Deactivate\" : \"Activate\"}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    `).join(\"\");\r\n\r\n    // Use safer approach - create elements directly\r\n    const parser = new DOMParser();\r\n    const doc = parser.parseFromString(this.sanitizeHtml(safeHtml), \"text/html\");\r\n    const fragment = document.createDocumentFragment();\r\n    Array.from(doc.body.children).forEach(child => fragment.appendChild(child.cloneNode(true)));\r\n    grid.appendChild(fragment);\r\n  }\r\n  // Enhanced HTML sanitization function\r\n  sanitizeHtml(html) {\r\n    if (!html || typeof html !== \"string\") return \"\";\r\n    // Use DOMPurify for comprehensive sanitization\r\n    if (typeof DOMPurify !== \"undefined\") {\r\n      return DOMPurify.sanitize(html, {\r\n        ALLOWED_TAGS: [\"div\", \"span\", \"p\", \"h1\", \"h2\", \"h3\", \"h4\", \"h5\", \"h6\", \"strong\", \"em\", \"b\", \"i\", \"u\", \"br\", \"hr\", \"ul\", \"ol\", \"li\", \"a\", \"img\"],\r\n        ALLOWED_ATTR: [\"class\", \"id\", \"style\", \"href\", \"src\", \"alt\", \"title\", \"data-*\"],\r\n        ALLOW_DATA_ATTR: true,\r\n        ALLOW_UNKNOWN_PROTOCOLS: false,\r\n        SANITIZE_DOM: true,\r\n        KEEP_CONTENT: true\r\n      });\r\n    }\r\n    // Fallback sanitization if DOMPurify is not available\r\n    return html\r\n      // Remove script tags and their content\r\n      // eslint-disable-next-line security/detect-unsafe-regex\r\n      .replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, \"\")\r\n      // Remove event handlers\r\n      .replace(/on\\w+\\s*=\\s*[\"'][^\"']*[\"']/gi, \"\")\r\n      // Remove javascript: URLs\r\n      .replace(/javascript\\s*:/gi, \"\")\r\n      // Remove vbscript: URLs\r\n      .replace(/vbscript\\s*:/gi, \"\")\r\n      // Remove data: URLs (except safe image types)\r\n      .replace(/data\\s*:(?!image\\/(png|jpg|jpeg|gif|svg|webp))/gi, \"\")\r\n      // Remove iframe tags\r\n      .replace(/<iframe\\b[^<]*>.*?<\\/iframe>/gi, \"\")\r\n      // Remove object tags\r\n      // eslint-disable-next-line security/detect-unsafe-regex\r\n      .replace(/<object\\b[^<]*(?:(?!<\\/object>)<[^<]*)*<\\/object>/gi, \"\")\r\n      // Remove embed tags\r\n      .replace(/<embed\\b[^<]*>/gi, \"\")\r\n      // Remove form tags\r\n      // eslint-disable-next-line security/detect-unsafe-regex\r\n      .replace(/<form\\b[^<]*(?:(?!<\\/form>)<[^<]*)*<\\/form>/gi, \"\")\r\n      // Remove input tags\r\n      .replace(/<input\\b[^<]*>/gi, \"\")\r\n      // Remove button tags with onclick\r\n      .replace(/<button\\b[^<]*onclick[^<]*>/gi, \"<button>\")\r\n      // Remove style attributes with javascript\r\n      .replace(/style\\s*=\\s*[\"'][^\"']*javascript[^\"']*[\"']/gi, \"\")\r\n      // Remove href with javascript\r\n      .replace(/href\\s*=\\s*[\"']javascript[^\"']*[\"']/gi, 'href=\"#\"')\r\n      // Remove src with javascript\r\n      .replace(/src\\s*=\\s*[\"']javascript[^\"']*[\"']/gi, \"\");\r\n  }\r\n  updateStats() {\r\n    const totalElement = document.getElementById(\"totalCount\");\r\n    const activeElement = document.getElementById(\"activeCount\");\r\n    if (totalElement) totalElement.textContent = this.departments.length;\r\n    if (activeElement) {\r\n      activeElement.textContent = this.departments.filter(d => d.is_active).length;\r\n    }\r\n  }\r\n  async handleSubmit(e) {\r\n    e.preventDefault();\r\n    const formData = new FormData(e.target);\r\n    const data = {\r\n      name: formData.get(\"name\"),\r\n      code: formData.get(\"code\"),\r\n      description: formData.get(\"description\"),\r\n      is_active: formData.has(\"is_active\")\r\n    };\r\n    try {\r\n      let response;\r\n      if (this.currentDepartment) {\r\n        response = await apiClient.put(`/api/departments/${this.currentDepartment.id}`, data);\r\n      } else {\r\n        response = await apiClient.post(\"/api/departments\", data);\r\n      }\r\n      if (response.success) {\r\n        showMessage(\"success\", response.message);\r\n        this.closeModal();\r\n        await this.loadDepartments();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Department operation failed:\", error);\r\n      showMessage(\"error\", error.message || \"Operation failed\");\r\n    }\r\n  }\r\n  openModal(mode = \"add\", department = null) {\r\n    this.currentDepartment = department;\r\n    const modal = document.getElementById(\"departmentModal\");\r\n    const title = document.getElementById(\"modalTitle\");\r\n    const form = document.getElementById(\"departmentForm\");\r\n    if (mode === \"edit\" && department) {\r\n      title.textContent = \"Edit Department\";\r\n      document.getElementById(\"departmentName\").value = department.name;\r\n      document.getElementById(\"departmentCode\").value = department.code;\r\n      document.getElementById(\"departmentDescription\").value = department.description || \"\";\r\n      document.getElementById(\"departmentActive\").checked = department.is_active;\r\n    } else {\r\n      title.textContent = \"Add Department\";\r\n      form.reset();\r\n    }\r\n    modal.style.display = \"block\";\r\n  }\r\n  closeModal() {\r\n    const modal = document.getElementById(\"departmentModal\");\r\n    modal.style.display = \"none\";\r\n    this.currentDepartment = null;\r\n  }\r\n  editDepartment(id) {\r\n    const department = this.departments.find(d => d.id === id);\r\n    if (department) {\r\n      this.openModal(\"edit\", department);\r\n    }\r\n  }\r\n  async toggleStatus(id) {\r\n    const department = this.departments.find(d => d.id === id);\r\n    if (!department) return;\r\n    const newStatus = !department.is_active;\r\n    const action = newStatus ? \"activate\" : \"deactivate\";\r\n    if (!confirm(`Are you sure you want to ${action} \"${department.name}\"?`)) {\r\n      return;\r\n    }\r\n    try {\r\n      const response = await apiClient.put(`/api/departments/${id}`, {\r\n        is_active: newStatus\r\n      });\r\n      if (response.success) {\r\n        showMessage(\"success\", `Department ${action}d successfully`);\r\n        await this.loadDepartments();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Status toggle failed:\", error);\r\n      showMessage(\"error\", error.message || \"Operation failed\");\r\n    }\r\n  }\r\n  toggleOfficers(departmentId) {\r\n    const department = this.departments.find(d => d.id === departmentId);\r\n    if (!department) return;\r\n    department.officersVisible = !department.officersVisible;\r\n    this.renderDepartments();\r\n  }\r\n  getLastSeenText(lastSignInAt) {\r\n    if (!lastSignInAt) return \"Never\";\r\n    const lastSignIn = new Date(lastSignInAt);\r\n    const now = new Date();\r\n    const diffInMinutes = Math.floor((now - lastSignIn) / (1000 * 60));\r\n    if (diffInMinutes < 1) return \"Just now\";\r\n    if (diffInMinutes < 60) return `${diffInMinutes}m ago`;\r\n    const diffInHours = Math.floor(diffInMinutes / 60);\r\n    if (diffInHours < 24) return `${diffInHours}h ago`;\r\n    const diffInDays = Math.floor(diffInHours / 24);\r\n    if (diffInDays < 7) return `${diffInDays}d ago`;\r\n    return lastSignIn.toLocaleDateString();\r\n  }\r\n  getStatusClass(isOnline, lastSignInAt) {\r\n    if (isOnline) return \"status-online\";\r\n    if (!lastSignInAt) return \"status-offline\";\r\n    const lastSignIn = new Date(lastSignInAt);\r\n    const now = new Date();\r\n    const diffInMinutes = (now - lastSignIn) / (1000 * 60);\r\n\r\n    // Consider \"away\" if last seen within 1 hour but not online\r\n    if (diffInMinutes < 60) return \"status-away\";\r\n    return \"status-offline\";\r\n  }\r\n  startStatusRefresh() {\r\n    // Refresh status every 2 minutes\r\n    setInterval(() => {\r\n      this.refreshOfficerStatus();\r\n    }, 2 * 60 * 1000);\r\n  }\r\n  async refreshOfficerStatus() {\r\n    // Only refresh if officers are visible\r\n    const hasVisibleOfficers = this.departments.some(dept => dept.officersVisible);\r\n    if (!hasVisibleOfficers) return;\r\n    try {\r\n      // Reload officers for all departments\r\n      await this.loadOfficersForAllDepartments();\r\n      this.renderDepartments();\r\n    } catch (error) {\r\n      console.error(\"Failed to refresh officer status:\", error);\r\n    }\r\n  }\r\n}\r\n// Global functions for onclick handlers\r\nwindow.openModal = (mode) => {\r\n  if (window.departmentManager) {\r\n    window.departmentManager.openModal(mode);\r\n  }\r\n};\r\nwindow.closeModal = () => {\r\n  if (window.departmentManager) {\r\n    window.departmentManager.closeModal();\r\n  }\r\n};\r\nwindow.toggleOfficers = (departmentId) => {\r\n  if (window.departmentManager) {\r\n    window.departmentManager.toggleOfficers(departmentId);\r\n  }\r\n};\r\n// Initialize when DOM is loaded\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  window.departmentManager = new DepartmentManager();\r\n});\r\n// Close modal when clicking outside\r\nwindow.addEventListener(\"click\", (e) => {\r\n  const modal = document.getElementById(\"departmentModal\");\r\n  if (e.target === modal) {\r\n    window.departmentManager?.closeModal();\r\n  }\r\n});\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\auth\\auth.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'addCsrfTokenToForm' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":28},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":466,"column":15,"nodeType":"CallExpression","messageId":"returnsValue","endLine":466,"endColumn":80,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[16798,16863],"text":"{setTimeout(() => reject(new Error(\"Session sync timeout\")), 3000)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":490,"column":38,"nodeType":"CallExpression","messageId":"returnsValue","endLine":490,"endColumn":56,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[17809,17827],"text":"{setTimeout(r, 100)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":502,"column":32,"nodeType":"CallExpression","messageId":"returnsValue","endLine":502,"endColumn":51,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[18264,18283],"text":"{setTimeout(r, 2000)}"},"desc":"Wrap the expression in `{}`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// login, register, change pass, and additional social media\r\nimport { supabase } from \"../config/config.js\";\r\nimport showMessage from \"../components/toast.js\";\r\nimport {\r\n  saveUserMeta,\r\n  getOAuthContext,\r\n  setOAuthContext,\r\n} from \"./authChecker.js\";\r\nimport { setButtonLoading, temporarilyMark } from \"../utils/buttonState.js\";\r\nimport { addCsrfTokenToForm } from \"../utils/csrf.js\";\r\nimport { validateAndSanitizeForm, isValidEmail } from \"../utils/validation.js\";\r\n\r\n// Show toast on login page if redirected due to missing auth\r\ntry {\r\n  const isLoginPage = /\\/login(?:$|\\?)/.test(\r\n    window.location.pathname + window.location.search\r\n  );\r\n  if (isLoginPage) {\r\n    const params = new URLSearchParams(window.location.search);\r\n    const err = params.get(\"err\");\r\n    if (err === \"not_authenticated\") {\r\n      showMessage(\"error\", \"Please log in to continue\");\r\n    }\r\n  }\r\n} catch {}\r\n\r\nexport const retrieveUserRole = async () => {};\r\n\r\n// reCAPTCHA setup\r\nlet loginCaptchaWidgetId = null;\r\nlet registerCaptchaWidgetId = null;\r\nlet siteKey = \"\";\r\n// Fetch CAPTCHA key securely from server\r\nasync function getCaptchaKey() {\r\n  try {\r\n    const response = await fetch(\"/api/captcha/key\");\r\n    const data = await response.json();\r\n    return data.key || \"\";\r\n  } catch (error) {\r\n    console.error(\"Failed to fetch CAPTCHA key:\", error);\r\n    return \"\";\r\n  }\r\n}\r\nasync function renderCaptchaWidgetsIfAny() {\r\n  // Skip reCAPTCHA in development mode\r\n  if (\r\n    window.location.hostname === \"localhost\" ||\r\n    window.location.hostname === \"127.0.0.1\"\r\n  ) {\r\n    // console.log removed for security\r\n    return;\r\n  }\r\n  if (!window.grecaptcha) return;\r\n  // Fetch CAPTCHA key if not already loaded\r\n  if (!siteKey) {\r\n    siteKey = await getCaptchaKey();\r\n  }\r\n  if (!siteKey) return;\r\n  window.grecaptcha.ready(() => {\r\n    const loginEl = document.getElementById(\"login-captcha\");\r\n    if (loginEl && loginCaptchaWidgetId === null) {\r\n      loginCaptchaWidgetId = window.grecaptcha.render(loginEl, {\r\n        sitekey: siteKey,\r\n      });\r\n    }\r\n    const regEl = document.getElementById(\"register-captcha\");\r\n    if (regEl && registerCaptchaWidgetId === null) {\r\n      registerCaptchaWidgetId = window.grecaptcha.render(regEl, {\r\n        sitekey: siteKey,\r\n      });\r\n    }\r\n  });\r\n}\r\n// Try render on load and after a short delay to cover async script load\r\nrenderCaptchaWidgetsIfAny();\r\nsetTimeout(renderCaptchaWidgetsIfAny, 500);\r\nasync function verifyCaptchaOrFail(widgetId) {\r\n  // Skip reCAPTCHA verification in development mode\r\n  if (\r\n    window.location.hostname === \"localhost\" ||\r\n    window.location.hostname === \"127.0.0.1\"\r\n  ) {\r\n    // console.log removed for security\r\n    return { ok: true };\r\n  }\r\n  if (!widgetId && widgetId !== 0) {\r\n    showMessage(\"error\", \"Captcha not ready. Please wait and try again.\");\r\n    return { ok: false };\r\n  }\r\n  const token = window.grecaptcha\r\n    ? window.grecaptcha.getResponse(widgetId)\r\n    : \"\";\r\n  if (!token) {\r\n    showMessage(\"error\", \"Please complete the captcha.\");\r\n    return { ok: false };\r\n  }\r\n  try {\r\n    const res = await fetch(\"/api/captcha/verify\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ token }),\r\n    });\r\n    const json = await res.json();\r\n    if (json && json.success) {\r\n      return { ok: true };\r\n    }\r\n    showMessage(\"error\", \"Captcha verification failed. Please try again.\");\r\n    return { ok: false };\r\n  } catch (_err) {\r\n    showMessage(\"error\", \"Captcha verification error. Please try again.\");\r\n    return { ok: false };\r\n  } finally {\r\n    if (window.grecaptcha) {\r\n      try {\r\n        window.grecaptcha.reset(widgetId);\r\n      } catch (_e) {}\r\n    }\r\n  }\r\n}\r\nconst regFormEl = document.getElementById(\"regForm\");\r\n\r\n// Form persistence logic for registration\r\nconst REG_FORM_STORAGE_KEY = \"cl_reg_form_data\";\r\n\r\nfunction saveRegFormData() {\r\n  if (!regFormEl) return;\r\n\r\n  const formData = new FormData(regFormEl);\r\n  const dataToSave = {};\r\n\r\n  for (const [key, value] of formData.entries()) {\r\n    // Don't save sensitive fields\r\n    if (key !== \"regPassword\" && key !== \"reRegPassword\") {\r\n      dataToSave[key] = value;\r\n    }\r\n  }\r\n\r\n  try {\r\n    sessionStorage.setItem(REG_FORM_STORAGE_KEY, JSON.stringify(dataToSave));\r\n  } catch (e) {\r\n    console.warn(\"Failed to save registration form data:\", e);\r\n  }\r\n}\r\n\r\nfunction loadRegFormData() {\r\n  if (!regFormEl) return;\r\n\r\n  try {\r\n    const savedData = sessionStorage.getItem(REG_FORM_STORAGE_KEY);\r\n    if (!savedData) return;\r\n\r\n    const parsedData = JSON.parse(savedData);\r\n\r\n    Object.keys(parsedData).forEach((key) => {\r\n      const input = regFormEl.querySelector(`[name=\"${key}\"]`);\r\n      if (input && input.type !== \"file\") {\r\n        // Skip file inputs\r\n        input.value = parsedData[key];\r\n        // Trigger input event to ensure UI updates (like floating labels)\r\n        input.dispatchEvent(new Event(\"input\", { bubbles: true }));\r\n      }\r\n    });\r\n  } catch (e) {\r\n    console.warn(\"Failed to load registration form data:\", e);\r\n  }\r\n}\r\n\r\nfunction clearRegFormData() {\r\n  try {\r\n    sessionStorage.removeItem(REG_FORM_STORAGE_KEY);\r\n    sessionStorage.removeItem(\"cl_signup_step_index\"); // Clear step index too\r\n  } catch (e) {\r\n    console.warn(\"Failed to clear registration form data:\", e);\r\n  }\r\n}\r\n\r\n// Initialize persistence if form exists\r\nif (regFormEl) {\r\n  // Load saved data on init\r\n  loadRegFormData();\r\n\r\n  // Save data on input changes\r\n  regFormEl.addEventListener(\"input\", (e) => {\r\n    // Debounce saving if needed, but for now direct save is fine for simple text\r\n    if (e.target.name !== \"regPassword\" && e.target.name !== \"reRegPassword\") {\r\n      saveRegFormData();\r\n    }\r\n  });\r\n\r\n  regFormEl.addEventListener(\"submit\", async (e) => {\r\n    e.preventDefault(); // prevent page refresh\r\n    regFormEl.classList.add(\"was-validated\");\r\n    const firstName = document.getElementById(\"firstName\")?.value.trim() || \"\";\r\n    const middleName =\r\n      document.getElementById(\"middleName\")?.value.trim() || \"\";\r\n    const lastName = document.getElementById(\"lastName\")?.value.trim() || \"\";\r\n    const email = document.getElementById(\"email\").value.trim();\r\n    const mobile = document.getElementById(\"mobile\").value.trim();\r\n    const addressLine1 =\r\n      document.getElementById(\"addressLine1\")?.value.trim() || \"\";\r\n    const addressLine2 =\r\n      document.getElementById(\"addressLine2\")?.value.trim() || \"\";\r\n    const barangay = document.getElementById(\"barangay\")?.value.trim() || \"\";\r\n    const gender = document.getElementById(\"gender\")?.value || \"\";\r\n    const regPass = document.getElementById(\"regPassword\").value;\r\n    const reRegPass = document.getElementById(\"reRegPassword\").value;\r\n    // Early password length checks\r\n    if (!regPass || regPass.length < 8) {\r\n      showMessage(\"error\", \"Password must be at least 8 characters long\");\r\n      return;\r\n    }\r\n    // Validate form data\r\n    const validationRules = {\r\n      firstName: { required: true, minLength: 1, maxLength: 100 },\r\n      middleName: { required: false, minLength: 0, maxLength: 100 },\r\n      lastName: { required: true, minLength: 1, maxLength: 100 },\r\n      email: { required: true, type: \"email\" },\r\n      mobile: { required: true, type: \"mobile\" },\r\n      regPassword: { required: true, type: \"password\" },\r\n      addressLine1: { required: false, minLength: 0, maxLength: 255 },\r\n      addressLine2: { required: false, minLength: 0, maxLength: 255 },\r\n      barangay: { required: false, minLength: 0, maxLength: 100 },\r\n      gender: { required: false },\r\n    };\r\n    const formData = {\r\n      firstName,\r\n      middleName,\r\n      lastName,\r\n      email,\r\n      mobile,\r\n      regPassword: regPass,\r\n      addressLine1,\r\n      addressLine2,\r\n      barangay,\r\n      gender,\r\n    };\r\n    const validation = validateAndSanitizeForm(formData, validationRules);\r\n    if (!validation.isValid) {\r\n      showMessage(\"error\", validation.errors.join(\", \"));\r\n      return;\r\n    }\r\n    // Additional password confirmation check\r\n    if (reRegPass !== regPass) {\r\n      showMessage(\"error\", \"Passwords don't match\");\r\n      return;\r\n    }\r\n\r\n    // verify captcha\r\n    const captchaResult = await verifyCaptchaOrFail(registerCaptchaWidgetId);\r\n    if (!captchaResult.ok) return;\r\n\r\n    try {\r\n      const submitBtn = regFormEl.querySelector(\r\n        'button[type=\"submit\"], .btn-primary, .btn'\r\n      );\r\n      const resetBtn = setButtonLoading(submitBtn, \"Creating account...\");\r\n      // Build JSON payload (role defaults to 'citizen' on backend)\r\n      const payload = {\r\n        email: validation.sanitizedData.email,\r\n        password: regPass,\r\n        confirmPassword: reRegPass,\r\n        firstName: validation.sanitizedData.firstName,\r\n        middleName: validation.sanitizedData.middleName || \"\",\r\n        lastName: validation.sanitizedData.lastName,\r\n        mobileNumber: `+63${validation.sanitizedData.mobile}`,\r\n        gender: validation.sanitizedData.gender || \"\",\r\n        address: {\r\n          line1: validation.sanitizedData.addressLine1 || \"\",\r\n          line2: validation.sanitizedData.addressLine2 || \"\",\r\n          barangay: validation.sanitizedData.barangay || \"\",\r\n        },\r\n        // role: 'citizen', // backend defaults to citizen\r\n        agreedToTerms: true,\r\n        isOAuth: false, // Regular signup\r\n        verificationToken: sessionStorage.getItem(\"cl_verification_token\"), // Send proof of ID verification\r\n      };\r\n      // Submit via API instead of direct Supabase call\r\n      const response = await fetch(\"/api/auth/signup\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      const result = await response.json();\r\n      // Be tolerant of API variations: treat 2xx with clear success message as success\r\n      const successMessage =\r\n        result && result.message ? String(result.message) : \"\";\r\n      const isHttpSuccess = response.ok; // includes 201\r\n      const isApiSuccess = result && result.success === true;\r\n      const looksLikeSuccess =\r\n        /account created|verify your email|verification email/i.test(\r\n          successMessage\r\n        );\r\n      if (isHttpSuccess && (isApiSuccess || looksLikeSuccess)) {\r\n        // SECURITY: Tokens are no longer in response, Supabase session is managed server-side\r\n        // Server sets HttpOnly cookie, client relies on that for authentication\r\n        // No need to manually set session here as server handles it\r\n        showMessage(\r\n          \"success\",\r\n          \"Successfully registered. Please confirm via the email we sent.\"\r\n        );\r\n        clearRegFormData(); // Clear saved form data\r\n        temporarilyMark(submitBtn, \"Success\", \"btn-success\");\r\n        resetBtn();\r\n        setTimeout(() => {\r\n          window.location.href = \"/login\";\r\n        }, 3000);\r\n      } else {\r\n        const errMsg = (\r\n          result && result.error ? String(result.error) : \"\"\r\n        ).toLowerCase();\r\n        if (\r\n          errMsg.includes(\"already registered\") ||\r\n          errMsg.includes(\"already exists\") ||\r\n          errMsg.includes(\"duplicate\") ||\r\n          errMsg.includes(\"email is used\") ||\r\n          errMsg.includes(\"email taken\") ||\r\n          errMsg.includes(\"email already exist\")\r\n        ) {\r\n          showMessage(\"error\", \"Email already exist\");\r\n        } else {\r\n          showMessage(\r\n            \"error\",\r\n            result.error || successMessage || \"Registration failed\"\r\n          );\r\n        }\r\n        temporarilyMark(submitBtn, \"Failed\", \"btn-danger\");\r\n        resetBtn();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Registration error:\", error);\r\n      showMessage(\"error\", \"Registration failed. Please try again.\");\r\n      try {\r\n        const submitBtn = regFormEl.querySelector(\r\n          'button[type=\"submit\"], .btn-primary, .btn'\r\n        );\r\n        temporarilyMark(submitBtn, \"Failed\", \"btn-danger\");\r\n      } catch {}\r\n      try {\r\n        const _submitBtn = regFormEl.querySelector(\r\n          'button[type=\"submit\"], .btn-primary, .btn'\r\n        );\r\n      } catch {}\r\n    }\r\n  });\r\n}\r\nconst loginFormEl = document.getElementById(\"login\");\r\nif (loginFormEl)\r\n  loginFormEl.addEventListener(\"submit\", async (e) => {\r\n    e.preventDefault();\r\n    loginFormEl.classList.add(\"was-validated\");\r\n    const email = document.getElementById(\"email\").value;\r\n    const pass = document.getElementById(\"password\").value;\r\n    const remember = document.getElementById(\"remember-me\")?.checked || false;\r\n\r\n    // Store device trust preference\r\n    try {\r\n      const { setDeviceTrusted } = await import(\"./authChecker.js\");\r\n      setDeviceTrusted(remember);\r\n    } catch (error) {\r\n      console.error(\"[AUTH] Failed to set device trust preference:\", error);\r\n    }\r\n    // Get login button elements\r\n    const loginBtn = document.getElementById(\"login-submit-btn\");\r\n    const loginBtnIcon = document.getElementById(\"login-btn-icon\");\r\n    const loginBtnText = document.getElementById(\"login-btn-text\");\r\n    // Function to show loading state\r\n    const showLoading = () => {\r\n      if (!loginBtn || !loginBtnIcon) return;\r\n\r\n      // Store original icon HTML only if not already stored\r\n      // This prevents overwriting with the spinner if called multiple times\r\n      if (!loginBtn.dataset.originalIcon) {\r\n        const originalIcon = loginBtnIcon.outerHTML;\r\n        loginBtn.dataset.originalIcon = originalIcon;\r\n      }\r\n\r\n      // Replace icon with loading spinner (CSS animation will handle rotation)\r\n      loginBtnIcon.innerHTML = `\r\n      <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"2\" fill=\"none\" opacity=\"0.3\"/>\r\n      <path d=\"M12 2 A10 10 0 0 1 22 12\" stroke=\"currentColor\" stroke-width=\"2\" fill=\"none\" stroke-linecap=\"round\" stroke-dasharray=\"15 10\"/>\r\n    `;\r\n      loginBtnIcon.classList.add(\"spinning\");\r\n      // Disable button\r\n      loginBtn.disabled = true;\r\n      loginBtnText.textContent = \"Signing in...\";\r\n    };\r\n\r\n    // Function to hide loading state\r\n    const hideLoading = () => {\r\n      if (!loginBtn) return;\r\n\r\n      // Get current icon element (might have been replaced)\r\n      const currentIcon = document.getElementById(\"login-btn-icon\");\r\n      if (currentIcon && loginBtn.dataset.originalIcon) {\r\n        // Restore original icon\r\n        const originalIconHtml = loginBtn.dataset.originalIcon;\r\n        const tempDiv = document.createElement(\"div\");\r\n        tempDiv.innerHTML = originalIconHtml;\r\n        const restoredIcon = tempDiv.firstElementChild;\r\n        if (restoredIcon) {\r\n          currentIcon.parentNode.replaceChild(restoredIcon, currentIcon);\r\n        }\r\n        // Clear the stored icon so we can capture it fresh next time if needed\r\n        // (though keeping it is also fine, clearing is safer for state resets)\r\n        delete loginBtn.dataset.originalIcon;\r\n      }\r\n\r\n      // Remove spinning class if it exists\r\n      if (currentIcon) {\r\n        currentIcon.classList.remove(\"spinning\");\r\n      }\r\n\r\n      // Re-enable button\r\n      loginBtn.disabled = false;\r\n      if (loginBtnText) {\r\n        loginBtnText.textContent = \"Sign in\";\r\n      }\r\n    };\r\n\r\n    // Basic validation\r\n    if (!email || !pass) {\r\n      showMessage(\"error\", \"Email and password are required\");\r\n      return;\r\n    }\r\n\r\n    if (!isValidEmail(email)) {\r\n      showMessage(\"error\", \"Please enter a valid email address\");\r\n      return;\r\n    }\r\n\r\n    // Show loading state\r\n    showLoading();\r\n\r\n    // verify captcha\r\n    const captchaResult = await verifyCaptchaOrFail(loginCaptchaWidgetId);\r\n    if (!captchaResult.ok) {\r\n      hideLoading();\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Submit via API with JSON body\r\n      const response = await fetch(\"/api/auth/login\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ email, password: pass, remember }),\r\n      });\r\n\r\n      const result = await response.json();\r\n\r\n      if (result.success) {\r\n        // SECURITY: Server handles all authentication and sets HttpOnly cookie\r\n        // Client syncs Supabase session state using refresh token from server response\r\n        try {\r\n          // Server already authenticated and set cookie, now sync client-side Supabase session\r\n          const refreshToken = result.data?.refresh_token;\r\n\r\n          if (refreshToken) {\r\n            // Use refresh token to get full Supabase session without re-authenticating\r\n            // Wrap in timeout to prevent hanging\r\n            const syncPromise = supabase.auth.refreshSession({\r\n              refresh_token: refreshToken,\r\n            });\r\n\r\n            const timeoutPromise = new Promise((_, reject) =>\r\n              setTimeout(() => reject(new Error(\"Session sync timeout\")), 3000)\r\n            );\r\n\r\n            const { data: sessionData, error: refreshError } =\r\n              await Promise.race([syncPromise, timeoutPromise]).catch(\r\n                (err) => ({ error: err })\r\n              );\r\n\r\n            if (refreshError || !sessionData?.session) {\r\n              console.warn(\r\n                \"[CLIENT AUTH] ⚠️ Failed to sync Supabase session:\",\r\n                refreshError?.message || \"Unknown error\"\r\n              );\r\n              // Server cookie is still valid, continue with server-side auth only\r\n            }\r\n          } else {\r\n            console.warn(\r\n              \"[CLIENT AUTH] ⚠️ No refresh token in response, client-side Supabase features may be limited\"\r\n            );\r\n          }\r\n\r\n          // Verify session by hitting a protected endpoint\r\n          // Also wrapped in timeout/race to prevent blocking\r\n          const verifyPromise = async () => {\r\n            await new Promise((r) => setTimeout(r, 100)); // Brief wait for cookie\r\n            const resp = await fetch(\"/api/user/role\", {\r\n              method: \"GET\",\r\n              credentials: \"include\",\r\n              headers: { \"Content-Type\": \"application/json\" },\r\n            });\r\n            if (!resp.ok) throw new Error(\"Role check failed\");\r\n            return resp;\r\n          };\r\n\r\n          await Promise.race([\r\n            verifyPromise(),\r\n            new Promise((r) => setTimeout(r, 2000)), // 2s max wait for verification\r\n          ]).catch((err) =>\r\n            console.warn(\r\n              \"[CLIENT AUTH] ⚠️ Session verification skipped:\",\r\n              err.message\r\n            )\r\n          );\r\n        } catch (error) {\r\n          console.error(\"[CLIENT AUTH] Error in session sync:\", error);\r\n          // Don't fail login if session sync fails - server cookie is still valid\r\n        }\r\n\r\n        showMessage(\"success\", \"Logged in successfully\");\r\n\r\n        // SECURITY: Use user data from server response (server is source of truth)\r\n        const serverUser = result.data?.user;\r\n        let role = serverUser?.role || serverUser?.normalizedRole || null;\r\n        let name = serverUser?.name || serverUser?.fullName || null;\r\n\r\n        // If server data is incomplete, try to get from Supabase session\r\n        if (!role || !name) {\r\n          try {\r\n            const {\r\n              data: { session: clientSession },\r\n            } = await supabase.auth.getSession();\r\n            if (clientSession?.user) {\r\n              const userMetadata = clientSession.user.user_metadata || {};\r\n              const rawUserMetaData =\r\n                clientSession.user.raw_user_meta_data || {};\r\n              const combinedMetadata = { ...userMetadata, ...rawUserMetaData };\r\n              role =\r\n                role ||\r\n                combinedMetadata.role ||\r\n                combinedMetadata.normalized_role ||\r\n                null;\r\n              name = name || combinedMetadata.name || null;\r\n            }\r\n          } catch (e) {\r\n            console.warn(\"Failed to fetch client session metadata:\", e);\r\n          }\r\n        }\r\n\r\n        // Save user metadata for client-side use\r\n        if (role || name) {\r\n          saveUserMeta({ role, name });\r\n        }\r\n\r\n        // Check if user has completed registration\r\n        if (!role || !name) {\r\n          showMessage(\"error\", \"Please complete your profile first\");\r\n          hideLoading(); // Ensure button is reset\r\n          setTimeout(() => {\r\n            window.location.href = \"/OAuthContinuation\";\r\n          }, 2000);\r\n          return;\r\n        }\r\n\r\n        // Redirect to dashboard based on role\r\n        try {\r\n          hideLoading();\r\n        } catch (e) {}\r\n\r\n        setTimeout(() => {\r\n          try {\r\n            window.location.href = \"/dashboard\";\r\n          } catch (e) {\r\n            /* ignore */\r\n          }\r\n        }, 1500);\r\n\r\n        // Safety fallback: if navigation hasn't started after 7s, clear loading state\r\n        setTimeout(() => {\r\n          try {\r\n            const stillOnLogin =\r\n              window.location.pathname &&\r\n              window.location.pathname.toLowerCase().includes(\"/login\");\r\n            if (stillOnLogin) {\r\n              try {\r\n                hideLoading();\r\n              } catch (e) {}\r\n              showMessage(\r\n                \"info\",\r\n                \"Login appears to be taking longer than usual. If you are not redirected, please refresh the page.\"\r\n              );\r\n            }\r\n          } catch (_) {}\r\n        }, 7000);\r\n      } else {\r\n        // Login failed - hide loading state\r\n        hideLoading();\r\n        showMessage(\"error\", result.error || \"Login failed\");\r\n\r\n        // If OAuth context suggests provider was intended but failed, route to signup\r\n        const ctx = getOAuthContext();\r\n        if (ctx && ctx.provider) {\r\n          window.location.href = \"/signup\";\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Login error:\", error);\r\n      // Hide loading state on error\r\n      hideLoading();\r\n      showMessage(\"error\", \"Login failed. Please try again.\");\r\n    }\r\n  });\r\n// OAuth sign-in buttons (popup-based)\r\nconst oauthButtons = [\r\n  { id: \"login-google\", provider: \"google\" },\r\n  { id: \"login-facebook\", provider: \"facebook\" },\r\n];\r\n\r\noauthButtons.forEach(({ id, provider }) => {\r\n  const btn = document.getElementById(id);\r\n  if (!btn) return;\r\n  btn.addEventListener(\"click\", () => startOAuthPopup(provider));\r\n});\r\n\r\nasync function startOAuthPopup(provider) {\r\n  const scopes =\r\n    provider === \"google\"\r\n      ? \"email profile https://www.googleapis.com/auth/user.phonenumbers.read\"\r\n      : \"email public_profile\";\r\n  try {\r\n    // Determine intent based on current page\r\n    const isSignupPage = window.location.pathname.includes(\"/signup\");\r\n    const intent = isSignupPage ? \"signup\" : \"login\";\r\n\r\n    // Set OAuth context to track the flow\r\n    setOAuthContext({\r\n      provider,\r\n      intent,\r\n      status: \"pending\",\r\n      startedAt: Date.now(),\r\n    });\r\n\r\n    console.log(\"[OAUTH] Starting OAuth flow:\", { provider, intent });\r\n\r\n    // Direct redirect (no popup) - simpler and more reliable\r\n    const { data, error } = await supabase.auth.signInWithOAuth({\r\n      provider,\r\n      options: {\r\n        redirectTo: `${window.location.origin}/oauth-callback`,\r\n        scopes,\r\n      },\r\n    });\r\n\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    // If URL is returned, redirect to it\r\n    if (data?.url) {\r\n      window.location.href = data.url;\r\n    }\r\n  } catch (error) {\r\n    console.error(`[OAUTH] ${provider} OAuth error:`, error);\r\n    showMessage(\"error\", error.message || `${provider} sign-in failed`);\r\n    // Clear OAuth context on error\r\n    try {\r\n      clearOAuthContext();\r\n    } catch {}\r\n  }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\auth\\authChecker.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\auth\\complete-position-signup-page.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\auth\\complete-position-signup.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'renderPrivacyNotice' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from \"../config/config.js\";\r\nimport showMessage from \"../components/toast.js\";\r\nimport { renderPrivacyNotice } from \"../utils/privacyContent.js\";\r\n\r\n// Get signup code from URL parameters\r\nconst urlParams = new URLSearchParams(window.location.search);\r\nconst signupCode = urlParams.get(\"code\");\r\n// reCAPTCHA setup\r\nconst positionSignupCaptchaWidgetId = 0;\r\n// Wait for captcha to be ready\r\nconst waitForCaptcha = () => {\r\n\r\n  if (window.grecaptcha && window.grecaptcha.getResponse) {\r\n    // console.log removed for security\r\n    return true;\r\n  }\r\n  return false;\r\n};\r\n// Check if captcha is ready, retry if not\r\nconst checkCaptchaReady = () => {\r\n  if (waitForCaptcha()) {\r\n    // console.log removed for security\r\n  } else {\r\n    // console.log removed for security\r\n    setTimeout(checkCaptchaReady, 500);\r\n  }\r\n};\r\n// Start checking for captcha readiness\r\ncheckCaptchaReady();\r\nasync function verifyCaptchaOrFail(widgetId) {\r\n  // console.log removed for security\r\n  if (widgetId === null || widgetId === void 0) {\r\n    // console.log removed for security\r\n    showMessage(\"error\", \"Captcha not ready. Please wait and try again.\");\r\n    return { ok: false };\r\n  }\r\n  if (!window.grecaptcha) {\r\n    // console.log removed for security\r\n    showMessage(\"error\", \"reCAPTCHA not loaded. Please refresh the page.\");\r\n    return { ok: false };\r\n  }\r\n  const token = window.grecaptcha.getResponse(widgetId);\r\n  // console.log removed for security\r\n  if (!token) {\r\n    showMessage(\"error\", \"Please complete the captcha.\");\r\n    return { ok: false };\r\n  }\r\n  try {\r\n    const res = await fetch(\"/api/captcha/verify\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ token })\r\n    });\r\n    const json = await res.json();\r\n    if (json && json.success) {\r\n      return { ok: true };\r\n    }\r\n    showMessage(\"error\", \"Captcha verification failed. Please try again.\");\r\n    return { ok: false };\r\n  } catch (_err) {\r\n    showMessage(\"error\", \"Captcha verification error. Please try again.\");\r\n    return { ok: false };\r\n  } finally {\r\n    if (window.grecaptcha) {\r\n      try { window.grecaptcha.reset(widgetId); } catch (_e) {}\r\n    }\r\n  }\r\n}\r\n// Validate signup code and get role/department info\r\nconst validateSignupCode = async (code) => {\r\n  try {\r\n    const response = await fetch(`/api/hr/validate-signup-code/${code}`);\r\n    const result = await response.json();\r\n    if (result && result.valid) {\r\n      return {\r\n        valid: true,\r\n        role: result.data?.role,\r\n        department: result.data?.department_code\r\n      };\r\n    }\r\n    showMessage(\"error\", result.error || \"Invalid signup code\");\r\n    return { valid: false };\r\n  } catch (error) {\r\n    console.error(\"Code validation error:\", error);\r\n    showMessage(\"error\", \"Failed to validate signup code\");\r\n    return { valid: false };\r\n  }\r\n};\r\n// Prefill OAuth data from provider\r\nconst prefillOAuthData = async () => {\r\n  try {\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    const user = session?.user;\r\n    if (user) {\r\n      // Extract name from various OAuth provider sources\r\n      const name = user.user_metadata?.name ||\r\n                   (user.user_metadata?.first_name && user.user_metadata?.last_name ?\r\n                     `${user.user_metadata.first_name} ${user.user_metadata.last_name}` : \"\") ||\r\n                   \"\";\r\n      // Prefill name (read-only)\r\n      const nameInput = document.getElementById(\"name\");\r\n      if (nameInput && name) {\r\n        nameInput.value = name.trim();\r\n      }\r\n      // Prefill email (read-only)\r\n      const emailInput = document.getElementById(\"email\");\r\n      if (emailInput && user.email) {\r\n        emailInput.value = user.email;\r\n      }\r\n      // Try to get phone from OAuth provider\r\n      const oauthPhone = user.user_metadata?.phone_number ||\r\n                        user.user_metadata?.phone ||\r\n                        user.user_metadata?.mobile ||\r\n                        null;\r\n      const mobileInput = document.getElementById(\"mobile\");\r\n      if (mobileInput) {\r\n\r\n        if (oauthPhone) {\r\n          // Extract digits only\r\n          let digits = oauthPhone.replace(/\\D/g, \"\");\r\n          // Handle Philippines mobile format\r\n          if (digits.startsWith(\"63\") && digits.length >= 12) {\r\n            digits = digits.substring(2, 12);\r\n          } else if (digits.length === 10) {\r\n            // Already 10 digits, use as is\r\n          } else if (digits.length > 10) {\r\n            digits = digits.substring(digits.length - 10);\r\n          }\r\n          mobileInput.value = digits;\r\n          mobileInput.readOnly = true;\r\n          mobileInput.style.background = \"#f5f5f5\";\r\n          mobileInput.style.cursor = \"not-allowed\";\r\n        } else {\r\n          // No phone from OAuth - keep field editable\r\n          mobileInput.readOnly = false;\r\n          mobileInput.style.background = \"\";\r\n          mobileInput.style.cursor = \"\";\r\n          mobileInput.required = true;\r\n        }\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error prefilling OAuth data:\", error);\r\n  }\r\n};\r\n// Prefill signup code and role/department info\r\nconst prefillSignupInfo = async () => {\r\n\r\n  if (!signupCode) {\r\n    showMessage(\"error\", \"No signup code provided\");\r\n    return;\r\n  }\r\n  // Prefill signup code\r\n  const codeInput = document.getElementById(\"signupCode\");\r\n  if (codeInput) {\r\n    codeInput.value = signupCode;\r\n  }\r\n  // Validate code and get role/department\r\n  const validation = await validateSignupCode(signupCode);\r\n  if (validation.valid) {\r\n    const roleInput = document.getElementById(\"role\");\r\n    const departmentInput = document.getElementById(\"department\");\r\n    if (roleInput) {\r\n      roleInput.value = validation.role;\r\n    }\r\n    if (departmentInput) {\r\n      departmentInput.value = validation.department;\r\n    }\r\n  }\r\n};\r\n// Handle form submission\r\nconst positionSignupForm = document.getElementById(\"positionSignupForm\");\r\n\r\n// Form persistence logic for OAuth completion\r\nconst OAUTH_FORM_STORAGE_KEY = \"cl_oauth_form_data\";\r\n\r\nfunction saveOAuthFormData() {\r\n  if (!positionSignupForm) return;\r\n\r\n  const formData = new FormData(positionSignupForm);\r\n  const dataToSave = {};\r\n\r\n  for (const [key, value] of formData.entries()) {\r\n    // Save all fields including hidden ones if needed, but exclude sensitive if any (none here really)\r\n    // We want to save name, email, mobile, signupCode\r\n    dataToSave[key] = value;\r\n  }\r\n\r\n  try {\r\n    localStorage.setItem(OAUTH_FORM_STORAGE_KEY, JSON.stringify(dataToSave));\r\n  } catch (e) {\r\n    console.warn(\"Failed to save OAuth form data:\", e);\r\n  }\r\n}\r\n\r\nfunction loadOAuthFormData() {\r\n  if (!positionSignupForm) return;\r\n\r\n  try {\r\n    const savedData = localStorage.getItem(OAUTH_FORM_STORAGE_KEY);\r\n    if (!savedData) return;\r\n\r\n    const parsedData = JSON.parse(savedData);\r\n\r\n    Object.keys(parsedData).forEach(key => {\r\n      const input = positionSignupForm.querySelector(`[name=\"${key}\"]`);\r\n      // Only restore if input is empty or editable (don't overwrite read-only prefilled data unless it matches)\r\n      // Actually, we should be careful. If OAuth prefilled it, we might want to keep that.\r\n      // But if user edited it and refreshed, we want their edit.\r\n      // Strategy: Restore everything, but maybe check if readOnly?\r\n      if (input && !input.readOnly) {\r\n        input.value = parsedData[key];\r\n        input.dispatchEvent(new Event(\"input\", { bubbles: true }));\r\n      }\r\n    });\r\n  } catch (e) {\r\n    console.warn(\"Failed to load OAuth form data:\", e);\r\n  }\r\n}\r\n\r\nfunction clearOAuthFormData() {\r\n  try {\r\n    localStorage.removeItem(OAUTH_FORM_STORAGE_KEY);\r\n  } catch (e) {\r\n    console.warn(\"Failed to clear OAuth form data:\", e);\r\n  }\r\n}\r\n\r\nif (positionSignupForm) {\r\n  // Load saved data on init - AFTER prefill logic runs?\r\n  // We should probably run this after prefill to overwrite with user edits if any\r\n  // But prefill is async. Let's hook into the prefill completion or just run it with a delay/check.\r\n  // Actually, prefill runs on load. We can run this after.\r\n\r\n  // Wait a tick for prefill to potentially happen, then load user saved data on top\r\n  setTimeout(loadOAuthFormData, 500);\r\n\r\n  // Save data on input changes\r\n  positionSignupForm.addEventListener(\"input\", () => {\r\n    saveOAuthFormData();\r\n  });\r\n\r\n  positionSignupForm.addEventListener(\"submit\", async (e) => {\r\n    e.preventDefault();\r\n    const name = document.getElementById(\"name\").value.trim();\r\n    const email = document.getElementById(\"email\").value.trim();\r\n    const mobile = document.getElementById(\"mobile\").value.trim();\r\n    const code = document.getElementById(\"signupCode\").value.trim();\r\n    if (!name) {\r\n      showMessage(\"error\", \"Name is required\");\r\n      return;\r\n    }\r\n    if (!email) {\r\n      showMessage(\"error\", \"Email is required\");\r\n      return;\r\n    }\r\n    if (!mobile || !/^[0-9]{10}$/.test(mobile)) {\r\n      showMessage(\"error\", \"Please enter a valid 10-digit mobile number\");\r\n      return;\r\n    }\r\n    if (!code) {\r\n      showMessage(\"error\", \"Signup code is required\");\r\n      return;\r\n    }\r\n    // Show loading state\r\n    const submitButton = e.target.querySelector('button[type=\"submit\"]');\r\n    const buttonText = submitButton.querySelector(\".button-text\");\r\n    const buttonLoading = submitButton.querySelector(\".button-loading\");\r\n    buttonText.style.display = \"none\";\r\n    buttonLoading.style.display = \"flex\";\r\n    submitButton.disabled = true;\r\n    // Verify captcha (skip if not available)\r\n    if (positionSignupCaptchaWidgetId !== null) {\r\n      const captchaResult = await verifyCaptchaOrFail(positionSignupCaptchaWidgetId);\r\n      if (!captchaResult.ok) {\r\n        // Reset button state\r\n        buttonText.style.display = \"block\";\r\n        buttonLoading.style.display = \"none\";\r\n        submitButton.disabled = false;\r\n        return;\r\n      }\r\n    } else {\r\n      // console.log removed for security\r\n    }\r\n    // Complete OAuth registration with HR signup code\r\n    try {\r\n      const response = await fetch(\"/api/auth/complete-oauth-hr\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        body: JSON.stringify({\r\n          name,\r\n          mobile,\r\n          signupCode: code\r\n        })\r\n      });\r\n      const result = await response.json();\r\n      if (!result.success) {\r\n        showMessage(\"error\", result.error || \"Failed to complete registration\");\r\n        return;\r\n      }\r\n      showMessage(\"success\", \"Registration completed successfully! Redirecting to dashboard...\");\r\n      clearOAuthFormData(); // Clear saved data\r\n      setTimeout(() => {\r\n        window.location.href = \"/dashboard\";\r\n      }, 2000);\r\n    } catch (err) {\r\n      console.error(\"HR OAuth completion error:\", err);\r\n      showMessage(\"error\", \"Registration failed. Please try again.\");\r\n    } finally {\r\n      // Reset button state\r\n      buttonText.style.display = \"block\";\r\n      buttonLoading.style.display = \"none\";\r\n      submitButton.disabled = false;\r\n    }\r\n  });\r\n}\r\n// Terms and Privacy handlers\r\ndocument.getElementById(\"toc\")?.addEventListener(\"click\", () => {\r\n  document.getElementById(\"terms\").innerHTML = \"<h3>Terms and Conditions</h3><p>Your terms content here...</p>\";\r\n});\r\n// Privacy Notice link now opens in new tab - no modal needed\r\n// Privacy content is available at /privacy-notice\r\n// Prefill data on page load\r\nprefillOAuthData();\r\nprefillSignupInfo();\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\auth\\index-page.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'clearOAuthContext' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":52},{"ruleId":"no-unused-vars","severity":1,"message":"'suppressAuthErrorNotifications' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":84}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Index/landing page specific functionality\nimport { supabase } from \"../config/config.js\";\nimport { logout, getOAuthContext, clearOAuthContext, suppressAuthErrorNotifications } from \"./authChecker.js\";\nimport { shouldSkipAuthCheck } from \"../utils/oauth-cleanup.js\";\n\n// Track if logout event listener has been added\nlet logoutListenerAdded = false;\n\n// Global Guard handles all cleanup now - redundant code removed\n\n// Check authentication status and update UI\nconst checkAuthenticationAndUpdateUI = async () => {\n  try {\n    // Global Guard already ran at init\n    // await clearOAuthContextOnLanding();\n\n    // Check for incomplete OAuth signup - if pending or handoff, don't show authenticated UI\n    const ctx = getOAuthContext();\n    const hasIncompleteOAuth = ctx && ctx.intent === \"signup\" && (ctx.status === \"pending\" || ctx.status === \"handoff\");\n    const hasPendingOAuth = shouldSkipAuthCheck() || hasIncompleteOAuth;\n\n    // Get current session\n    const { data: { session }, error } = await supabase.auth.getSession();\n    const unauthenticatedButtons = document.getElementById(\"unauthenticated-buttons\");\n    const authenticatedButtons = document.getElementById(\"authenticated-buttons\");\n    const logoutBtn = document.getElementById(\"logout-btn\");\n\n    // If there's an incomplete OAuth signup, always show unauthenticated buttons\n    if (hasPendingOAuth || hasIncompleteOAuth) {\n      if (unauthenticatedButtons) unauthenticatedButtons.classList.remove(\"hidden\");\n      if (authenticatedButtons) authenticatedButtons.classList.add(\"hidden\");\n      return;\n    }\n\n    if (session && !error) {\n      // Get user metadata\n      const {user} = session;\n      const role = user?.user_metadata?.role || user?.raw_user_meta_data?.role || \"\";\n      const name = user?.user_metadata?.name || user?.raw_user_meta_data?.name || \"\";\n      const hasMobile = user?.user_metadata?.mobile_number ||\n                       user?.user_metadata?.mobile ||\n                       user?.phone;\n\n      // Check if user has completed registration (must have role, name, AND mobile)\n      if (role && name && hasMobile) {\n        // Hide login/signup buttons, show dashboard button\n        if (unauthenticatedButtons) unauthenticatedButtons.classList.add(\"hidden\");\n        if (authenticatedButtons) authenticatedButtons.classList.remove(\"hidden\");\n        // Add logout functionality (only once)\n        if (logoutBtn && !logoutListenerAdded) {\n          logoutBtn.addEventListener(\"click\", async () => {\n            await logout();\n          });\n          logoutListenerAdded = true;\n        }\n      } else {\n        // Profile incomplete, keep showing login/signup for profile completion\n        if (unauthenticatedButtons) unauthenticatedButtons.classList.remove(\"hidden\");\n        if (authenticatedButtons) authenticatedButtons.classList.add(\"hidden\");\n      }\n    } else {\n      // Show login/signup buttons, hide dashboard button\n      if (unauthenticatedButtons) unauthenticatedButtons.classList.remove(\"hidden\");\n      if (authenticatedButtons) authenticatedButtons.classList.add(\"hidden\");\n    }\n  } catch (error) {\n    console.error(\"💥 Authentication check failed:\", error);\n    // On error, default to showing login/signup buttons\n    const unauthenticatedButtons = document.getElementById(\"unauthenticated-buttons\");\n    const authenticatedButtons = document.getElementById(\"authenticated-buttons\");\n    if (unauthenticatedButtons) unauthenticatedButtons.classList.remove(\"hidden\");\n    if (authenticatedButtons) authenticatedButtons.classList.add(\"hidden\");\n  }\n};\n// Initialize index page\nconst initializeIndexPage = async () => {\n  // CRITICAL: Run Global OAuth Guard FIRST to wipe stale state\n  const { initGlobalOAuthGuard } = await import(\"../utils/global-oauth-guard.js\");\n  await initGlobalOAuthGuard();\n\n  // Setup navigation cleanup for login/signup buttons and brand logo\n  const { setupNavigationCleanup } = await import(\"../utils/navigation.js\");\n  setupNavigationCleanup();\n\n  // Run authentication check when page loads\n  checkAuthenticationAndUpdateUI();\n  // Also run immediately in case DOMContentLoaded already fired\n  checkAuthenticationAndUpdateUI();\n};\n// Initialize when DOM is ready\nif (document.readyState === \"loading\") {\n  document.addEventListener(\"DOMContentLoaded\", initializeIndexPage);\n} else {\n  initializeIndexPage();\n}\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\auth\\login-page.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'shouldSkipAuthCheck' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29},{"ruleId":"no-alert","severity":1,"message":"Unexpected alert.","line":157,"column":9,"nodeType":"CallExpression","messageId":"unexpected","endLine":157,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Login page specific functionality\r\nimport { supabase } from \"../config/config.js\";\r\nimport { shouldSkipAuthCheck } from \"../utils/oauth-cleanup.js\";\r\nimport {\r\n  getOAuthContext,\r\n  suppressAuthErrorNotifications,\r\n} from \"./authChecker.js\";\r\n\r\n// Global Guard handles all cleanup now - redundant code removed\r\nconst ctx = getOAuthContext();\r\nif (ctx && ctx.status === \"pending\") {\r\n  // Check if this is coming from an OAuth redirect (don't clear if it is)\r\n  const urlParams = new URLSearchParams(window.location.search);\r\n  const isOAuthRedirect =\r\n    urlParams.get(\"code\") ||\r\n    urlParams.get(\"error\") ||\r\n    urlParams.get(\"popup\") === \"1\";\r\n\r\n  // Only clear if user explicitly navigated here (not from OAuth redirect)\r\n  if (!isOAuthRedirect) {\r\n    console.log(\r\n      \"[LOGIN] User navigated to login during OAuth signup - cleaning up\"\r\n    );\r\n    suppressAuthErrorNotifications();\r\n\r\n    // Get user ID before signing out (for deletion)\r\n    const {\r\n      data: { session },\r\n    } = await supabase.auth.getSession();\r\n    const userId = session?.user?.id;\r\n\r\n    // Delete incomplete OAuth signup from database\r\n    if (userId && session?.access_token && ctx.intent === \"signup\") {\r\n      try {\r\n        const token = session.access_token;\r\n        const headers = {\r\n          Authorization: `Bearer ${token}`,\r\n        };\r\n\r\n        await fetch(\"/api/auth/oauth-incomplete\", {\r\n          method: \"DELETE\",\r\n          headers,\r\n          credentials: \"include\",\r\n        });\r\n        console.log(\"[LOGIN] Incomplete OAuth signup deleted\");\r\n      } catch (deleteError) {\r\n        console.warn(\"[LOGIN] Error deleting incomplete signup:\", deleteError);\r\n      }\r\n    }\r\n\r\n    // Clear OAuth context and session\r\n    const { clearOAuthContext } = await import(\"./authChecker.js\");\r\n    clearOAuthContext();\r\n\r\n    // Clear session to prevent redirects to oauth-continuation\r\n    try {\r\n      await supabase.auth.signOut();\r\n    } catch {}\r\n    try {\r\n      await fetch(\"/auth/session\", { method: \"DELETE\" });\r\n    } catch {}\r\n\r\n    // Clear Supabase storage\r\n    try {\r\n      const keys = Object.keys(localStorage);\r\n      keys.forEach((key) => {\r\n        if (key.startsWith(\"sb-\") || key.includes(\"supabase\")) {\r\n          localStorage.removeItem(key);\r\n        }\r\n      });\r\n    } catch {}\r\n  }\r\n}\r\n\r\n// Check if user is already logged in and redirect to dashboard\r\nconst checkAuthentication = async () => {\r\n  try {\r\n    // Global Guard already ran at init\r\n    // await clearOAuthContextOnLanding();\r\n\r\n    // Check if we just cleaned up OAuth - skip redirects\r\n    let oauthCleanupFlag = false;\r\n    try {\r\n      oauthCleanupFlag = sessionStorage.getItem(\"cl_oauth_cleanup\") === \"true\";\r\n      if (oauthCleanupFlag) {\r\n        sessionStorage.removeItem(\"cl_oauth_cleanup\");\r\n      }\r\n    } catch {}\r\n\r\n    // If we just cleaned up, don't redirect - let user proceed with login\r\n    if (oauthCleanupFlag) {\r\n      return;\r\n    }\r\n\r\n    // Check if redirected due to session expiration - don't auto-login\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    if (urlParams.get(\"session_expired\") === \"true\") {\r\n      // Session expired - clear any stale session and don't auto-login\r\n      try {\r\n        await supabase.auth.signOut();\r\n      } catch (error) {\r\n        console.error(\"[LOGIN] Error clearing expired session:\", error);\r\n      }\r\n      // Remove the parameter from URL\r\n      window.history.replaceState({}, document.title, \"/login\");\r\n      return; // Don't proceed with auto-login check\r\n    }\r\n\r\n    // console.log removed for security\r\n    // Get current session\r\n    const {\r\n      data: { session },\r\n      error,\r\n    } = await supabase.auth.getSession();\r\n    if (session && !error) {\r\n      // console.log removed for security\r\n      // Get user metadata\r\n      const { user } = session;\r\n      const role = user?.user_metadata?.role || \"\";\r\n      const name = user?.user_metadata?.name || \"\";\r\n      // Check if user has completed registration\r\n      if (role && name) {\r\n        // console.log removed for security\r\n        window.location.href = \"/dashboard\";\r\n      } else {\r\n        // User has incomplete registration - redirect to continuation\r\n        // This is the normal flow after OAuth signup\r\n        // console.log removed for security\r\n        window.location.href = \"/oauth-continuation\";\r\n      }\r\n    } else {\r\n      // console.log removed for security\r\n    }\r\n  } catch (error) {\r\n    console.error(\"💥 Authentication check failed:\", error);\r\n    // If there's an error, let the user proceed with login\r\n  }\r\n};\r\n\r\n// Check for URL parameters and show toast messages\r\nconst handleUrlMessages = () => {\r\n  const urlParams = new URLSearchParams(window.location.search);\r\n  const message = urlParams.get(\"message\");\r\n  const type = urlParams.get(\"type\");\r\n  if (message && type) {\r\n    // Import and show toast message\r\n    import(\"../components/toast.js\")\r\n      .then(({ default: showMessage }) => {\r\n        showMessage(type, message);\r\n        // Clean up URL parameters\r\n        const cleanUrl = window.location.pathname;\r\n        window.history.replaceState({}, document.title, cleanUrl);\r\n      })\r\n      .catch((error) => {\r\n        console.error(\"Failed to load toast module:\", error);\r\n        // Fallback to alert if toast fails\r\n        alert(message);\r\n      });\r\n  }\r\n};\r\n// Initialize login page\r\nconst initializeLoginPage = async () => {\r\n  // CRITICAL: Run Global OAuth Guard FIRST to wipe stale state before checking auth\r\n  // This prevents auto-redirects if the user has abandoned the flow\r\n  const { initGlobalOAuthGuard } = await import(\r\n    \"../utils/global-oauth-guard.js\"\r\n  );\r\n  await initGlobalOAuthGuard();\r\n\r\n  // Setup navigation cleanup for login/signup buttons and brand logo\r\n  const { setupNavigationCleanup } = await import(\"../utils/navigation.js\");\r\n  setupNavigationCleanup();\r\n\r\n  // Run authentication check when page loads\r\n  checkAuthentication();\r\n  // Handle URL messages\r\n  handleUrlMessages();\r\n  // Listen for auth state changes to update UI dynamically\r\n  supabase.auth.onAuthStateChange((event, session) => {\r\n    // console.log removed for security\r\n    if (event === \"SIGNED_IN\" && session) {\r\n      checkAuthentication();\r\n    }\r\n  });\r\n};\r\n// Initialize when DOM is ready\r\nif (document.readyState === \"loading\") {\r\n  document.addEventListener(\"DOMContentLoaded\", initializeLoginPage);\r\n} else {\r\n  initializeLoginPage();\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\auth\\oauth-callback.js","messages":[{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":17,"column":34,"nodeType":"CallExpression","messageId":"returnsValue","endLine":17,"endColumn":59,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[800,825],"text":"{setTimeout(resolve, 1000)}"},"desc":"Wrap the expression in `{}`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// OAuth callback handler - processes OAuth redirect and determines next step\nimport { supabase } from \"../config/config.js\";\nimport { setOAuthContext, clearOAuthContext, getOAuthContext, suppressAuthErrorNotifications } from \"./authChecker.js\";\n\nconsole.log(\"[OAUTH_CALLBACK] OAuth callback page loaded\");\n\nconst processOAuthCallback = async () => {\n  // Suppress auth error notifications while OAuth flow settles\n  suppressAuthErrorNotifications();\n  try {\n    console.log(\"[OAUTH_CALLBACK] Processing OAuth callback...\");\n    console.log(\"[OAUTH_CALLBACK] URL:\", window.location.href);\n    console.log(\"[OAUTH_CALLBACK] Hash:\", window.location.hash);\n\n    // Wait for Supabase to process the OAuth callback\n    // Supabase automatically handles tokens in URL hash\n    await new Promise(resolve => setTimeout(resolve, 1000));\n\n    // Get the session\n    const { data: { session }, error: sessionError } = await supabase.auth.getSession();\n\n    if (sessionError || !session) {\n      console.error(\"[OAUTH_CALLBACK] No session found:\", sessionError);\n      window.location.href = \"/login?err=oauth_failed\";\n      return;\n    }\n\n    console.log(\"[OAUTH_CALLBACK] Session found, user ID:\", session.user?.id);\n\n    // Set server-side session cookie\n    try {\n      const cookieResponse = await fetch(\"/auth/session\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ access_token: session.access_token })\n      });\n\n      if (!cookieResponse.ok) {\n        console.warn(\"[OAUTH_CALLBACK] Failed to set server cookie\");\n      }\n    } catch (cookieError) {\n      console.warn(\"[OAUTH_CALLBACK] Error setting server cookie:\", cookieError);\n    }\n\n    // Get OAuth intent from context (set when user clicked OAuth button)\n    const oauthContext = getOAuthContext();\n    const intent = oauthContext?.intent || \"login\"; // Default to login for safety\n\n    console.log(\"[OAUTH_CALLBACK] OAuth intent:\", intent);\n    console.log(\"[OAUTH_CALLBACK] OAuth context:\", oauthContext);\n\n    // Check user status on server (pass intent to help determine new vs existing)\n    try {\n      const statusResponse = await fetch(`/api/auth/oauth-status?intent=${intent}`, {\n        method: \"GET\",\n        headers: {\n          \"Authorization\": `Bearer ${session.access_token}`,\n          \"X-OAuth-Intent\": intent\n        }\n      });\n\n      if (!statusResponse.ok) {\n        throw new Error(\"Failed to check user status\");\n      }\n\n      const statusData = await statusResponse.json();\n      console.log(\"[OAUTH_CALLBACK] User status:\", statusData);\n\n      if (statusData.complete) {\n        // User is fully registered - go to dashboard\n        console.log(\"[OAUTH_CALLBACK] User is complete, redirecting to dashboard\");\n        console.log(\"[OAUTH_CALLBACK] User type:\", statusData.userType);\n        console.log(\"[OAUTH_CALLBACK] Message:\", statusData.message);\n\n        // Clear OAuth context since we're done\n        clearOAuthContext();\n\n        // Store a success message if available\n        if (statusData.message) {\n          sessionStorage.setItem(\"oauth_success_message\", statusData.message);\n        }\n\n        window.location.href = \"/dashboard\";\n      } else {\n        // User needs to complete profile - go to continuation\n        const isNewSignup = statusData.isNewSignup || intent === \"signup\";\n        const isExistingIncomplete = statusData.isExistingIncomplete || (intent === \"login\" && !statusData.isNewSignup);\n\n        console.log(\"[OAUTH_CALLBACK] User is incomplete, redirecting to continuation\");\n        console.log(\"[OAUTH_CALLBACK] Is new signup:\", isNewSignup);\n        console.log(\"[OAUTH_CALLBACK] Is existing incomplete:\", isExistingIncomplete);\n        console.log(\"[OAUTH_CALLBACK] User type:\", statusData.userType);\n\n        // Set OAuth context for continuation page\n        const provider = session.user?.identities?.[0]?.provider || \"oauth\";\n        setOAuthContext({\n          provider,\n          email: session.user?.email,\n          intent,\n          status: \"handoff\",\n          startedAt: Date.now(),\n          userType: statusData.userType,\n          isNewSignup,\n          message: statusData.message\n        });\n\n        window.location.href = \"/oauth-continuation\";\n      }\n    } catch (statusError) {\n      console.error(\"[OAUTH_CALLBACK] Error checking user status:\", statusError);\n      // Fallback: redirect to continuation with default signup intent\n      const provider = session.user?.identities?.[0]?.provider || \"oauth\";\n      setOAuthContext({\n        provider,\n        email: session.user?.email,\n        intent: intent || \"signup\",\n        status: \"handoff\",\n        startedAt: Date.now()\n      });\n      window.location.href = \"/oauth-continuation\";\n    }\n  } catch (error) {\n    console.error(\"[OAUTH_CALLBACK] Error processing callback:\", error);\n    window.location.href = \"/login?err=oauth_failed\";\n  }\n};\n\n// Process callback when page loads\nif (document.readyState === \"loading\") {\n  document.addEventListener(\"DOMContentLoaded\", processOAuthCallback);\n} else {\n  processOAuthCallback();\n}\n\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\auth\\oauth-complete.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'renderPrivacyNotice' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from \"../config/config.js\";\r\nimport showMessage from \"../components/toast.js\";\r\nimport { validateAndSanitizeForm } from \"../utils/validation.js\";\r\nimport { renderPrivacyNotice } from \"../utils/privacyContent.js\";\r\nimport { getOAuthContext } from \"./authChecker.js\";\r\n\r\n// reCAPTCHA setup - using auto-rendered captcha from HTML\r\nconst oauthCompleteCaptchaWidgetId = 0; // Default ID for auto-rendered captchas\r\n// Wait for captcha to be ready\r\nconst waitForCaptcha = () => {\r\n\r\n  if (window.grecaptcha && window.grecaptcha.getResponse) {\r\n    // console.log removed for security\r\n    return true;\r\n  }\r\n  return false;\r\n};\r\n// Check if captcha is ready, retry if not\r\nconst checkCaptchaReady = () => {\r\n  if (waitForCaptcha()) {\r\n    // console.log removed for security\r\n  } else {\r\n    // console.log removed for security\r\n    setTimeout(checkCaptchaReady, 500);\r\n  }\r\n};\r\n// Start checking for captcha readiness\r\ncheckCaptchaReady();\r\nasync function verifyCaptchaOrFail(widgetId) {\r\n  // console.log removed for security\r\n  if (widgetId === null || widgetId === void 0) {\r\n    // console.log removed for security\r\n    showMessage(\"error\", \"Captcha not ready. Please wait and try again.\");\r\n    return { ok: false };\r\n  }\r\n  if (!window.grecaptcha) {\r\n    // console.log removed for security\r\n    showMessage(\"error\", \"reCAPTCHA not loaded. Please refresh the page.\");\r\n    return { ok: false };\r\n  }\r\n  const token = window.grecaptcha.getResponse(widgetId);\r\n  // console.log removed for security\r\n  if (!token) {\r\n    showMessage(\"error\", \"Please complete the captcha.\");\r\n    return { ok: false };\r\n  }\r\n  try {\r\n    const res = await fetch(\"/api/captcha/verify\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ token })\r\n    });\r\n    const json = await res.json();\r\n    if (json && json.success) {\r\n      return { ok: true };\r\n    }\r\n    showMessage(\"error\", \"Captcha verification failed. Please try again.\");\r\n    return { ok: false };\r\n  } catch (_err) {\r\n    showMessage(\"error\", \"Captcha verification error. Please try again.\");\r\n    return { ok: false };\r\n  } finally {\r\n    if (window.grecaptcha) {\r\n      try { window.grecaptcha.reset(widgetId); } catch (_e) {}\r\n    }\r\n  }\r\n}\r\n// Form persistence logic\r\nconst OAUTH_FORM_STORAGE_KEY = \"cl_oauth_complete_form_data\";\r\n\r\nfunction saveOAuthFormData() {\r\n  const form = document.getElementById(\"oauthCompleteForm\");\r\n  if (!form) return;\r\n\r\n  const formData = new FormData(form);\r\n  const dataToSave = {};\r\n\r\n  for (const [key, value] of formData.entries()) {\r\n    // Don't save sensitive fields\r\n    if (key !== \"regPassword\" && key !== \"reRegPassword\") {\r\n      dataToSave[key] = value;\r\n    }\r\n  }\r\n\r\n  try {\r\n    localStorage.setItem(OAUTH_FORM_STORAGE_KEY, JSON.stringify(dataToSave));\r\n  } catch (e) {\r\n    console.warn(\"Failed to save OAuth form data:\", e);\r\n  }\r\n}\r\n\r\nfunction loadOAuthFormData() {\r\n  try {\r\n    const savedData = localStorage.getItem(OAUTH_FORM_STORAGE_KEY);\r\n    if (!savedData) return;\r\n\r\n    const parsedData = JSON.parse(savedData);\r\n    const form = document.getElementById(\"oauthCompleteForm\");\r\n    if (!form) return;\r\n\r\n    Object.keys(parsedData).forEach(key => {\r\n      const input = form.querySelector(`[name=\"${key}\"]`);\r\n      if (input && input.type !== \"file\") {\r\n        input.value = parsedData[key];\r\n        input.dispatchEvent(new Event(\"input\", { bubbles: true }));\r\n      }\r\n    });\r\n  } catch (e) {\r\n    console.warn(\"Failed to load OAuth form data:\", e);\r\n  }\r\n}\r\n\r\nfunction clearOAuthFormData() {\r\n  try {\r\n    localStorage.removeItem(OAUTH_FORM_STORAGE_KEY);\r\n    localStorage.removeItem(\"cl_signup_step_index\"); // Also clear step index\r\n  } catch (e) {\r\n    console.warn(\"Failed to clear OAuth form data:\", e);\r\n  }\r\n}\r\n\r\n// Prefill OAuth data from provider\r\nconst prefillOAuthData = async () => {\r\n  try {\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    const user = session?.user;\r\n    if (user) {\r\n      const identityData = user.identities?.[0]?.identity_data || {};\r\n      const meta = user.user_metadata || {};\r\n      const rawMeta = user.raw_user_meta_data || {};\r\n      const combined = { ...identityData, ...meta, ...rawMeta };\r\n      const fullName = combined.full_name || combined.name || \"\";\r\n\r\n      // Prioritize explicit fields\r\n      let firstName = combined.given_name || combined.first_name || \"\";\r\n      let lastName = combined.family_name || combined.last_name || \"\";\r\n      const middleName = combined.middle_name || \"\";\r\n\r\n      // If explicit fields are missing, try to parse from full name\r\n      if (!firstName && !lastName && fullName) {\r\n        const nameParts = fullName.trim().split(\" \");\r\n        if (nameParts.length === 1) {\r\n          firstName = nameParts[0];\r\n        } else if (nameParts.length > 1) {\r\n          // Assume last word is last name, everything else is first name\r\n          // Do NOT infer middle name automatically to avoid splitting multi-word first names\r\n          lastName = nameParts.pop();\r\n          firstName = nameParts.join(\" \");\r\n        }\r\n      }\r\n\r\n      // Prefill firstName\r\n      const firstNameInput = document.getElementById(\"firstName\");\r\n      if (firstNameInput && firstName && !firstNameInput.value) {\r\n        firstNameInput.value = firstName;\r\n      }\r\n\r\n      const middleNameInput = document.getElementById(\"middleName\");\r\n      if (middleNameInput) {\r\n        if (middleName && !middleNameInput.value) {\r\n          middleNameInput.value = middleName;\r\n        } else if (!middleName && !middleNameInput.value) {\r\n          // Enable if empty so user can enter it or leave it blank\r\n          middleNameInput.removeAttribute(\"readonly\");\r\n          middleNameInput.removeAttribute(\"disabled\");\r\n          middleNameInput.removeAttribute(\"aria-disabled\");\r\n          middleNameInput.removeAttribute(\"title\");\r\n        }\r\n      }\r\n\r\n      // Prefill lastName\r\n      const lastNameInput = document.getElementById(\"lastName\");\r\n      if (lastNameInput && lastName && !lastNameInput.value) {\r\n        lastNameInput.value = lastName;\r\n      }\r\n\r\n      // Prefill email (read-only)\r\n      const emailInput = document.getElementById(\"email\");\r\n      if (emailInput && user.email) {\r\n        emailInput.value = user.email;\r\n      }\r\n\r\n      // Try to get phone from OAuth provider (Google, Facebook, etc.)\r\n      const oauthPhone = user.user_metadata?.phone_number ||\r\n                        user.user_metadata?.phone ||\r\n                        user.user_metadata?.mobile ||\r\n                        null;\r\n      const mobileInput = document.getElementById(\"mobile\");\r\n      if (mobileInput && !mobileInput.value) {\r\n        if (oauthPhone) {\r\n          // Extract digits only (handle various formats: +63XXX, +1XXX, etc.)\r\n          let digits = oauthPhone.replace(/\\D/g, \"\");\r\n          // If it starts with country code, try to extract Philippines mobile\r\n          if (digits.startsWith(\"63\") && digits.length >= 12) {\r\n            // Remove country code 63 and keep 10 digits\r\n            digits = digits.substring(2, 12);\r\n          } else if (digits.length === 10) {\r\n            // Already 10 digits, use as is\r\n          } else if (digits.length > 10) {\r\n            // Take last 10 digits\r\n            digits = digits.substring(digits.length - 10);\r\n          }\r\n          mobileInput.value = digits;\r\n        }\r\n        // Mobile is always editable for OAuth continuation\r\n        mobileInput.required = true;\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error prefilling OAuth data:\", error);\r\n  } finally {\r\n    // Load saved data AFTER prefill to ensure user edits are preserved\r\n    loadOAuthFormData();\r\n  }\r\n};\r\n\r\n// Handle form submission\r\nconst oauthCompleteForm = document.getElementById(\"oauthCompleteForm\");\r\nif (oauthCompleteForm) {\r\n  // Save on input\r\n  oauthCompleteForm.addEventListener(\"input\", (e) => {\r\n    if (e.target.name !== \"regPassword\" && e.target.name !== \"reRegPassword\") {\r\n      saveOAuthFormData();\r\n    }\r\n  });\r\n\r\n  oauthCompleteForm.addEventListener(\"submit\", async (e) => {\r\n    e.preventDefault();\r\n    const firstName = document.getElementById(\"firstName\")?.value.trim() || \"\";\r\n    const middleName = document.getElementById(\"middleName\")?.value.trim() || \"\";\r\n    const lastName = document.getElementById(\"lastName\")?.value.trim() || \"\";\r\n    const email = document.getElementById(\"email\").value.trim();\r\n    const mobile = document.getElementById(\"mobile\").value.trim();\r\n    const addressLine1 = document.getElementById(\"addressLine1\")?.value.trim() || \"\";\r\n    const gender = document.getElementById(\"gender\")?.value || \"\";\r\n    const passwordInput = document.getElementById(\"regPassword\");\r\n    const confirmPasswordInput = document.getElementById(\"reRegPassword\");\r\n    const regPass = passwordInput ? passwordInput.value : \"\";\r\n    const reRegPass = confirmPasswordInput ? confirmPasswordInput.value : \"\";\r\n    const passwordProvided = Boolean(passwordInput && regPass);\r\n\r\n    // Early password length checks (only if password field exists)\r\n    if (passwordProvided && regPass.length < 8) {\r\n      showMessage(\"error\", \"Password must be at least 8 characters long\");\r\n      return;\r\n    }\r\n\r\n    // Validate form data\r\n    const validationRules = {\r\n      firstName: { required: true, minLength: 1, maxLength: 100 },\r\n      middleName: { required: false, minLength: 0, maxLength: 100 },\r\n      lastName: { required: true, minLength: 1, maxLength: 100 },\r\n      email: { required: true, type: \"email\" },\r\n      mobile: { required: true, type: \"mobile\" },\r\n      addressLine1: { required: false, minLength: 0, maxLength: 255 },\r\n      gender: { required: false }\r\n    };\r\n    if (passwordProvided) {\r\n      validationRules.regPassword = { required: true, type: \"password\" };\r\n    }\r\n    const formData = { firstName, middleName, lastName, email, mobile, addressLine1, gender };\r\n    if (passwordProvided) {\r\n      formData.regPassword = regPass;\r\n    }\r\n    const validation = validateAndSanitizeForm(formData, validationRules);\r\n    if (!validation.isValid) {\r\n      showMessage(\"error\", validation.errors.join(\", \"));\r\n      return;\r\n    }\r\n\r\n    // Additional password confirmation check (only if password provided)\r\n    if (passwordProvided && reRegPass !== regPass) {\r\n      showMessage(\"error\", \"Passwords don't match\");\r\n      return;\r\n    }\r\n\r\n    // verify captcha (skip if not available)\r\n    if (oauthCompleteCaptchaWidgetId !== null) {\r\n      const captchaResult = await verifyCaptchaOrFail(oauthCompleteCaptchaWidgetId);\r\n      if (!captchaResult.ok) return;\r\n    } else {\r\n      // console.log removed for security\r\n    }\r\n\r\n    // Build JSON payload matching signup structure\r\n    const payload = {\r\n      email: validation.sanitizedData.email,\r\n      firstName: validation.sanitizedData.firstName,\r\n      middleName: validation.sanitizedData.middleName || \"\",\r\n      lastName: validation.sanitizedData.lastName,\r\n      mobileNumber: `+63${validation.sanitizedData.mobile}`,\r\n      gender: validation.sanitizedData.gender || \"\",\r\n      address: { line1: validation.sanitizedData.addressLine1 || \"\" },\r\n      agreedToTerms: true,\r\n      isOAuth: true // OAuth continuation\r\n    };\r\n    if (passwordProvided) {\r\n      payload.password = regPass;\r\n      payload.confirmPassword = reRegPass;\r\n    }\r\n\r\n    // Update user metadata and complete profile via backend\r\n    try {\r\n      // Get access token from current session\r\n      const { data: { session } } = await supabase.auth.getSession();\r\n      const accessToken = session?.access_token;\r\n\r\n      const headers = {\r\n        \"Content-Type\": \"application/json\"\r\n      };\r\n\r\n      // Add Authorization header if we have a token\r\n      if (accessToken) {\r\n        headers[\"Authorization\"] = `Bearer ${accessToken}`;\r\n        // Also include in body as fallback\r\n        payload.access_token = accessToken;\r\n      }\r\n\r\n      const response = await fetch(\"/api/auth/complete-oauth\", {\r\n        method: \"POST\",\r\n        headers,\r\n        body: JSON.stringify(payload)\r\n      });\r\n      const result = await response.json();\r\n      if (!result.success) {\r\n        const errMsg = (result && result.error ? String(result.error) : \"\").toLowerCase();\r\n        if (errMsg.includes(\"already registered\") || errMsg.includes(\"already exists\") || errMsg.includes(\"duplicate\") || errMsg.includes(\"email is used\") || errMsg.includes(\"email taken\") || errMsg.includes(\"email already exist\")) {\r\n          showMessage(\"error\", \"Email already exist\");\r\n        } else {\r\n          showMessage(\"error\", result.error || \"Failed to complete registration\");\r\n        }\r\n        return;\r\n      }\r\n      // Mark OAuth signup as completed to prevent cleanup\r\n      try {\r\n        const { setOAuthContext, clearOAuthContext } = await import(\"./authChecker.js\");\r\n        const ctx = getOAuthContext();\r\n        if (ctx) {\r\n          setOAuthContext({ ...ctx, status: \"completed\" });\r\n        }\r\n        // Clear context after a short delay to allow redirect\r\n        setTimeout(() => {\r\n          clearOAuthContext();\r\n        }, 1000);\r\n      } catch (error) {\r\n        console.warn(\"[OAUTH_COMPLETE] Error updating OAuth context:\", error);\r\n      }\r\n\r\n      showMessage(\"success\", \"Profile completed successfully! Redirecting to dashboard...\");\r\n      clearOAuthFormData(); // Clear saved form data\r\n\r\n      // Clear OAuth context since signup is complete\r\n      try {\r\n        const { clearOAuthContext } = await import(\"./authChecker.js\");\r\n        clearOAuthContext();\r\n      } catch {}\r\n\r\n      // Redirect immediately to dashboard\r\n      setTimeout(() => {\r\n        window.location.href = \"/dashboard\";\r\n      }, 1000);\r\n    } catch (err) {\r\n      console.error(\"OAuth completion error:\", err);\r\n      showMessage(\"error\", \"Registration failed. Please try again.\");\r\n    }\r\n  });\r\n}\r\n// Terms and Privacy handlers\r\ndocument.getElementById(\"toc\").addEventListener(\"click\", (event) => {\r\n  event.preventDefault();\r\n  document.getElementById(\"terms\").innerHTML = \"<h3>Terms and Conditions</h3><p>Your terms content here...</p>\";\r\n});\r\n// Privacy Notice link now opens in new tab - no modal needed\r\n// Privacy content is available at /privacy-notice\r\n// Prefill data on page load\r\nprefillOAuthData();\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\auth\\oauth-continuation-page.js","messages":[{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":110,"column":7,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":110,"endColumn":27},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":119,"column":38,"nodeType":"CallExpression","messageId":"returnsValue","endLine":119,"endColumn":62,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[4231,4255],"text":"{setTimeout(resolve, 500)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":352,"column":34,"nodeType":"CallExpression","messageId":"returnsValue","endLine":352,"endColumn":58,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[13331,13355],"text":"{setTimeout(resolve, 500)}"},"desc":"Wrap the expression in `{}`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// OAuth continuation page specific functionality\r\n// console.log('[OAUTH_CONT] Script file loaded at:', new Date().toISOString());\r\n// console.log('[OAUTH_CONT] Current URL:', window.location.href);\r\n\r\nimport { supabase } from \"../config/config.js\";\r\nimport { getOAuthContext, clearOAuthContext, setOAuthContext, suppressAuthErrorNotifications } from \"./authChecker.js\";\r\nimport showMessage from \"../components/toast.js\";\r\n\r\n// console.log('[OAUTH_CONT] Imports completed');\r\n\r\n// Cleanup incomplete OAuth signup on interruption\r\nconst cleanupIncompleteOAuthSignup = async (_reason = \"OAuth signup was interrupted\") => {\r\n  suppressAuthErrorNotifications();\r\n  try {\r\n    const ctx = getOAuthContext();\r\n    // Only cleanup if this is an incomplete NEW signup (not existing user login)\r\n    // Don't cleanup if:\r\n    // 1. No context\r\n    // 2. Intent is 'login' (existing user)\r\n    // 3. Status is 'completed' (already done)\r\n    // 4. User type is 'existing' (existing user with incomplete profile)\r\n    if (!ctx ||\r\n        ctx.intent !== \"signup\" ||\r\n        ctx.status === \"completed\" ||\r\n        ctx.userType === \"existing\" ||\r\n        ctx.isExistingIncomplete) {\r\n      /* console.log('[OAUTH_CONT] Skipping cleanup - not a new signup:', {\r\n        hasContext: !!ctx,\r\n        intent: ctx?.intent,\r\n        status: ctx?.status,\r\n        userType: ctx?.userType,\r\n        isExistingIncomplete: ctx?.isExistingIncomplete\r\n      }); */\r\n      return;\r\n    }\r\n\r\n    // Get user ID before signing out\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    const userId = session?.user?.id;\r\n\r\n    // Delete incomplete OAuth signup from database\r\n    if (userId && session?.access_token) {\r\n      try {\r\n        const token = session.access_token;\r\n        const headers = {\r\n          \"Authorization\": `Bearer ${token}`\r\n        };\r\n\r\n        const deleteResponse = await fetch(\"/api/auth/oauth-incomplete\", {\r\n          method: \"DELETE\",\r\n          headers,\r\n          credentials: \"include\"\r\n        });\r\n\r\n        if (!deleteResponse.ok) {\r\n          const errorData = await deleteResponse.json().catch(() => ({}));\r\n          const {status} = deleteResponse;\r\n          // Don't log auth errors - they're expected for incomplete signups\r\n          if (status !== 401 && status !== 403) {\r\n            console.warn(\"[OAUTH_CONT] Failed to delete incomplete OAuth signup:\", errorData.error || \"Unknown error\");\r\n          }\r\n        } else {\r\n          // console.log('[OAUTH_CONT] Incomplete OAuth signup deleted successfully');\r\n        }\r\n      } catch (deleteError) {\r\n        console.warn(\"[OAUTH_CONT] Error deleting incomplete signup:\", deleteError);\r\n      }\r\n    }\r\n\r\n    // Sign out and clear session\r\n    try {\r\n      await supabase.auth.signOut();\r\n    } catch {}\r\n\r\n    try {\r\n      await fetch(\"/auth/session\", { method: \"DELETE\" });\r\n    } catch {}\r\n\r\n    // Clear OAuth context\r\n    clearOAuthContext();\r\n\r\n    // Clear Supabase storage\r\n    try {\r\n      const keys = Object.keys(localStorage);\r\n      keys.forEach(key => {\r\n        if (key.startsWith(\"sb-\") || key.includes(\"supabase\")) {\r\n          localStorage.removeItem(key);\r\n        }\r\n      });\r\n    } catch {}\r\n  } catch (error) {\r\n    console.warn(\"[OAUTH_CONT] Error cleaning up incomplete OAuth signup:\", error);\r\n  }\r\n};\r\n\r\n// Validate that user should be on this page\r\nconst validateOAuthContinuation = async () => {\r\n  // console.log('[OAUTH_CONT_VALIDATE] Starting validation...');\r\n  try {\r\n    // First check if user has a session (this is the primary requirement)\r\n    // Retry a few times in case session is still being set\r\n    let session = null;\r\n    let error = null;\r\n    let retries = 3;\r\n\r\n    while (retries > 0 && !session) {\r\n      // console.log(`[OAUTH_CONT_VALIDATE] Checking session (${4 - retries}/3)...`);\r\n      const result = await supabase.auth.getSession();\r\n      session = result.data?.session;\r\n      error = result.error;\r\n\r\n      if (session) {\r\n        // console.log('[OAUTH_CONT_VALIDATE] ✅ Session found!');\r\n        break;\r\n      }\r\n\r\n      if (retries > 1) {\r\n        // console.log('[OAUTH_CONT_VALIDATE] ⏳ Session not found, retrying in 500ms...');\r\n        await new Promise(resolve => setTimeout(resolve, 500));\r\n      }\r\n      retries--;\r\n    }\r\n\r\n    /* console.log('[OAUTH_CONT_VALIDATE] Session check result:', {\r\n      hasSession: !!session,\r\n      hasError: !!error,\r\n      error: error?.message,\r\n      userId: session?.user?.id\r\n    }); */\r\n\r\n    if (!session || error) {\r\n      // No session - user shouldn't be here\r\n      console.warn(\"[OAUTH_CONT_VALIDATE] ❌ No session found after retries:\", error);\r\n      // console.log('[OAUTH_CONT_VALIDATE] Checking localStorage for session data...');\r\n\r\n      // Check if there's any session data in localStorage\r\n      const storageKeys = Object.keys(localStorage);\r\n      const _supabaseKeys = storageKeys.filter(k => k.includes(\"supabase\") || k.startsWith(\"sb-\"));\r\n      // console.log('[OAUTH_CONT_VALIDATE] Supabase storage keys:', supabaseKeys);\r\n\r\n      // console.log('[OAUTH_CONT_VALIDATE] Redirecting to signup...');\r\n      showMessage(\"error\", \"Session expired. Please start over.\");\r\n      cleanupIncompleteOAuthSignup(\"Session expired\");\r\n      setTimeout(() => {\r\n        window.location.href = \"/signup\";\r\n      }, 2000);\r\n      return false;\r\n    }\r\n\r\n    // console.log('[OAUTH_CONT_VALIDATE] ✅ Session exists');\r\n\r\n    // Check if user is already fully registered\r\n    // console.log('[OAUTH_CONT_VALIDATE] Checking registration status...');\r\n    const {user} = session;\r\n    const role = user?.user_metadata?.role || user?.raw_user_meta_data?.role;\r\n    const name = user?.user_metadata?.name || user?.raw_user_meta_data?.name;\r\n    const hasMobile = user?.user_metadata?.mobile_number ||\r\n                     user?.user_metadata?.mobile ||\r\n                     user?.phone;\r\n\r\n    /* console.log('[OAUTH_CONT_VALIDATE] Registration check:', {\r\n      role: role || 'missing',\r\n      name: name || 'missing',\r\n      hasMobile: !!hasMobile,\r\n      isFullyRegistered: !!(role && name && hasMobile)\r\n    }); */\r\n\r\n    if (role && name && hasMobile) {\r\n      // User is already fully registered - redirect to dashboard\r\n      console.log(\"[OAUTH_CONT_VALIDATE] ❌ User already fully registered, redirecting to dashboard\");\r\n      clearOAuthContext();\r\n      window.location.href = \"/dashboard\";\r\n      return false;\r\n    }\r\n\r\n    // console.log('[OAUTH_CONT_VALIDATE] ✅ User is not fully registered');\r\n\r\n    // Check if there's a valid OAuth context\r\n    // console.log('[OAUTH_CONT_VALIDATE] Checking OAuth context...');\r\n    let ctx = getOAuthContext();\r\n    // console.log('[OAUTH_CONT_VALIDATE] OAuth context:', ctx);\r\n\r\n    if (!ctx || ctx.intent !== \"signup\") {\r\n      // Context might be missing if page was refreshed or context was cleared\r\n      // Check if user has OAuth identity to determine if this is an OAuth signup\r\n      const provider = user?.identities?.[0]?.provider;\r\n      // console.log('[OAUTH_CONT_VALIDATE] Context missing or wrong intent, checking provider:', provider);\r\n\r\n      if (provider) {\r\n        // User has OAuth identity but no context - recreate context\r\n        // console.log('[OAUTH_CONT_VALIDATE] ✅ OAuth context missing, recreating from session');\r\n        ctx = {\r\n          provider,\r\n          email: user.email,\r\n          intent: \"signup\",\r\n          status: \"handoff\",\r\n          startedAt: Date.now()\r\n        };\r\n        setOAuthContext(ctx);\r\n        // console.log('[OAUTH_CONT_VALIDATE] Recreated context:', ctx);\r\n      } else {\r\n        // No OAuth identity - user shouldn't be here\r\n        console.warn(\"[OAUTH_CONT_VALIDATE] ❌ No OAuth context and no OAuth identity found\");\r\n        showMessage(\"error\", \"No active OAuth signup found. Redirecting to signup...\");\r\n        setTimeout(() => {\r\n          window.location.href = \"/signup\";\r\n        }, 2000);\r\n        return false;\r\n      }\r\n    } else {\r\n      // console.log('[OAUTH_CONT_VALIDATE] ✅ OAuth context exists');\r\n    }\r\n\r\n    // User should be here - update context status if needed\r\n    if (ctx.status !== \"handoff\" && ctx.status !== \"completed\") {\r\n      // console.log('[OAUTH_CONT_VALIDATE] Updating context status to handoff');\r\n      setOAuthContext({ ...ctx, status: \"handoff\" });\r\n    }\r\n\r\n    // console.log('[OAUTH_CONT_VALIDATE] ✅ Validation passed, showing form');\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"[OAUTH_CONT] Validation error:\", error);\r\n    return false;\r\n  }\r\n};\r\n\r\nconst CAPTCHA_RENDER_FLAG = \"__oauthCaptchaRendered\";\r\n\r\n// Fetch CAPTCHA key for OAuth continuation\r\nconst fetchCaptchaKey = async () => {\r\n  try {\r\n    const response = await fetch(\"/api/captcha/oauth-key\");\r\n    const data = await response.json();\r\n    if (data.success && data.key) {\r\n      return data.key;\r\n    }\r\n    console.error(\"Failed to fetch CAPTCHA key:\", data.error);\r\n    return null;\r\n  } catch (error) {\r\n    console.error(\"Error fetching CAPTCHA key:\", error);\r\n    return null;\r\n  }\r\n};\r\n\r\n// Initialize CAPTCHA on OAuth continuation page\r\nconst initializeCaptcha = async () => {\r\n  const captchaContainer = document.getElementById(\"oauth-complete-captcha\");\r\n  if (!captchaContainer || !window.grecaptcha) {\r\n    console.warn(\"CAPTCHA not available\");\r\n    return;\r\n  }\r\n\r\n  if (captchaContainer.dataset.rendered === \"true\" || window[CAPTCHA_RENDER_FLAG]) {\r\n    // console.log('[OAUTH_CONT] CAPTCHA already rendered, skipping re-render');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const siteKey = await fetchCaptchaKey();\r\n    if (siteKey) {\r\n      window.grecaptcha.ready(() => {\r\n        if (captchaContainer.dataset.rendered === \"true\" || window[CAPTCHA_RENDER_FLAG]) {\r\n          // console.log('[OAUTH_CONT] CAPTCHA rendered during wait, skipping');\r\n          return;\r\n        }\r\n        window.grecaptcha.render(captchaContainer, {\r\n          sitekey: siteKey\r\n        });\r\n        captchaContainer.dataset.rendered = \"true\";\r\n        window[CAPTCHA_RENDER_FLAG] = true;\r\n        // console.log('[OAUTH_CONT] CAPTCHA rendered successfully');\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Failed to initialize CAPTCHA:\", error);\r\n  }\r\n};\r\n\r\n// Setup interruption handlers\r\nconst setupInterruptionHandlers = () => {\r\n  // Handle tab close / navigation away\r\n  const handleBeforeUnload = (_e) => {\r\n    const ctx = getOAuthContext();\r\n    if (ctx && ctx.intent === \"signup\" && ctx.status !== \"completed\") {\r\n      // Cleanup on page unload (but don't block navigation)\r\n      cleanupIncompleteOAuthSignup(\"User closed tab or navigated away\");\r\n    }\r\n  };\r\n\r\n  // Handle visibility change (user switches tabs)\r\n  const handleVisibilityChange = () => {\r\n    if (document.visibilityState === \"hidden\") {\r\n      const ctx = getOAuthContext();\r\n      if (ctx && ctx.intent === \"signup\" && ctx.status !== \"completed\") {\r\n        // Mark as potentially abandoned\r\n        setOAuthContext({ ...ctx, lastActivity: Date.now() });\r\n      }\r\n    } else if (document.visibilityState === \"visible\") {\r\n      // Check if OAuth signup is stale (abandoned for more than 5 minutes)\r\n      const ctx = getOAuthContext();\r\n      if (ctx && ctx.intent === \"signup\" && ctx.status !== \"completed\") {\r\n        const lastActivity = ctx.lastActivity || ctx.startedAt || 0;\r\n        const elapsed = Date.now() - lastActivity;\r\n        const STALE_TIMEOUT = 60 * 60 * 1000; // 60 minutes\r\n\r\n        if (elapsed > STALE_TIMEOUT) {\r\n          showMessage(\"error\", \"OAuth signup session expired. Please start over.\");\r\n          cleanupIncompleteOAuthSignup(\"Session expired due to inactivity\");\r\n          setTimeout(() => {\r\n            window.location.href = \"/signup\";\r\n          }, 2000);\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  // Handle page hide (navigation away)\r\n  const handlePageHide = () => {\r\n    const ctx = getOAuthContext();\r\n    if (ctx && ctx.intent === \"signup\" && ctx.status !== \"completed\") {\r\n      cleanupIncompleteOAuthSignup(\"User navigated away\");\r\n    }\r\n  };\r\n\r\n  window.addEventListener(\"beforeunload\", handleBeforeUnload);\r\n  document.addEventListener(\"visibilitychange\", handleVisibilityChange);\r\n  window.addEventListener(\"pagehide\", handlePageHide);\r\n\r\n  // Return cleanup function\r\n  return () => {\r\n    window.removeEventListener(\"beforeunload\", handleBeforeUnload);\r\n    document.removeEventListener(\"visibilitychange\", handleVisibilityChange);\r\n    window.removeEventListener(\"pagehide\", handlePageHide);\r\n  };\r\n};\r\n\r\n// Initialize OAuth continuation page\r\nconst initializeOAuthContinuationPage = async () => {\r\n  suppressAuthErrorNotifications();\r\n  // console.log('[OAUTH_CONT] ========================================');\r\n  // console.log('[OAUTH_CONT] Initializing OAuth continuation page...');\r\n  // console.log('[OAUTH_CONT] URL:', window.location.href);\r\n  // console.log('[OAUTH_CONT] URL Hash:', window.location.hash);\r\n  // console.log('[OAUTH_CONT] Timestamp:', new Date().toISOString());\r\n\r\n  // Check if there are tokens in the URL hash (from Supabase redirect)\r\n  if (window.location.hash) {\r\n    // console.log('[OAUTH_CONT] URL hash detected, Supabase may extract session from it');\r\n    // Supabase will automatically handle tokens in URL hash\r\n    // Wait a moment for Supabase to process the hash\r\n    await new Promise(resolve => setTimeout(resolve, 500));\r\n  }\r\n\r\n  // Check OAuth context\r\n  const ctx = getOAuthContext();\r\n  // console.log('[OAUTH_CONT] OAuth Context:', ctx);\r\n\r\n  // Update page title and subtitle based on user type\r\n  const updatePageMessages = () => {\r\n    const isNewSignup = ctx?.isNewSignup || ctx?.intent === \"signup\";\r\n    const _userType = ctx?._userType || (isNewSignup ? \"new\" : \"existing\");\r\n    const customMessage = ctx?.message;\r\n\r\n    // Update page title\r\n    const titleElement = document.querySelector(\".auth-title\");\r\n    if (titleElement) {\r\n      if (isNewSignup) {\r\n        titleElement.textContent = \"Complete Your Registration\";\r\n      } else {\r\n        titleElement.textContent = \"Complete Your Profile\";\r\n      }\r\n    }\r\n\r\n    // Update subtitle\r\n    const subtitleElement = document.querySelector(\".auth-subtitle\");\r\n    if (subtitleElement) {\r\n      if (customMessage) {\r\n        subtitleElement.textContent = customMessage;\r\n      } else if (isNewSignup) {\r\n        subtitleElement.textContent = \"Please provide your information to complete your registration.\";\r\n      } else {\r\n        subtitleElement.textContent = \"Your profile is incomplete. Please provide the missing information to continue.\";\r\n      }\r\n    }\r\n\r\n    // Update submit button text\r\n    const submitButton = document.getElementById(\"signup-submit-btn\");\r\n    if (submitButton) {\r\n      if (isNewSignup) {\r\n        submitButton.textContent = \"Complete Registration\";\r\n      } else {\r\n        submitButton.textContent = \"Update Profile\";\r\n      }\r\n    }\r\n\r\n    /* console.log('[OAUTH_CONT] Updated page messages:', {\r\n      isNewSignup,\r\n      userType,\r\n      customMessage\r\n    }); */\r\n  };\r\n\r\n  // Update messages if context is available\r\n  if (ctx) {\r\n    updatePageMessages();\r\n  }\r\n\r\n  // Check session\r\n  const { data: { session }, error: _sessionError } = await supabase.auth.getSession();\r\n  // console.log('[OAUTH_CONT] Session exists:', !!session);\r\n  // console.log('[OAUTH_CONT] Session error:', sessionError);\r\n  if (session?.user) {\r\n    /* console.log('[OAUTH_CONT] User ID:', session.user.id);\r\n    console.log('[OAUTH_CONT] User email:', session.user.email);\r\n    console.log('[OAUTH_CONT] User metadata:', {\r\n      role: session.user.user_metadata?.role || session.user.raw_user_meta_data?.role,\r\n      name: session.user.user_metadata?.name || session.user.raw_user_meta_data?.name,\r\n      mobile: session.user.user_metadata?.mobile_number || session.user.user_metadata?.mobile,\r\n      provider: session.user.identities?.[0]?.provider\r\n    }); */\r\n  }\r\n\r\n  const form = document.getElementById(\"oauthCompleteForm\");\r\n  const _steps = document.getElementById(\"signup-_steps\");\r\n  const step1 = document.querySelector('.signup-step[data-step=\"1\"]');\r\n  // console.log('[OAUTH_CONT] Form element exists:', !!form);\r\n  // console.log('[OAUTH_CONT] Steps container exists:', !!steps);\r\n  // console.log('[OAUTH_CONT] Step 1 exists:', !!step1);\r\n\r\n  // First, validate that user should be here\r\n  // console.log('[OAUTH_CONT] Starting validation...');\r\n  const isValid = await validateOAuthContinuation();\r\n  // console.log('[OAUTH_CONT] Validation result:', isValid);\r\n\r\n  // Re-check context after validation (it might have been updated)\r\n  const updatedCtx = getOAuthContext();\r\n  if (updatedCtx && updatedCtx !== ctx) {\r\n    updatePageMessages();\r\n  }\r\n\r\n  if (!isValid) {\r\n    // console.log('[OAUTH_CONT] ❌ Validation failed, redirecting...');\r\n    // console.log('[OAUTH_CONT] ========================================');\r\n    return; // Validation failed, redirect will happen\r\n  }\r\n\r\n  // console.log('[OAUTH_CONT] ✅ Validation passed, setting up page...');\r\n\r\n  // Setup interruption handlers\r\n  // console.log('[OAUTH_CONT] Setting up interruption handlers...');\r\n  setupInterruptionHandlers();\r\n\r\n  // Prefill OAuth data manually (oauth-complete.js handles form submission)\r\n  // console.log('[OAUTH_CONT] Prefilling OAuth data...');\r\n  try {\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    const user = session?.user;\r\n    if (user) {\r\n      const identityData = user.identities?.[0]?.identity_data || {};\r\n      const meta = user.user_metadata || {};\r\n      const rawMeta = user.raw_user_meta_data || {};\r\n      const combined = { ...identityData, ...meta, ...rawMeta };\r\n      const fullName = combined.full_name || combined.name || \"\";\r\n\r\n      // Prioritize explicit fields\r\n      let firstName = combined.given_name || combined.first_name || \"\";\r\n      let lastName = combined.family_name || combined.last_name || \"\";\r\n      const middleName = combined.middle_name || \"\";\r\n\r\n      // If explicit fields are missing, try to parse from full name\r\n      if (!firstName && !lastName && fullName) {\r\n        const nameParts = fullName.trim().split(\" \");\r\n        if (nameParts.length === 1) {\r\n          firstName = nameParts[0];\r\n        } else if (nameParts.length > 1) {\r\n          // Assume last word is last name, everything else is first name\r\n          // Do NOT infer middle name automatically to avoid splitting multi-word first names\r\n          lastName = nameParts.pop();\r\n          firstName = nameParts.join(\" \");\r\n        }\r\n      }\r\n\r\n      const firstNameInput = document.getElementById(\"firstName\");\r\n      if (firstNameInput && firstName) {\r\n        firstNameInput.value = firstName;\r\n        // console.log('[OAUTH_CONT] Prefilled firstName:', firstName);\r\n      }\r\n      const middleNameInput = document.getElementById(\"middleName\");\r\n      if (middleNameInput) {\r\n        if (middleName) {\r\n          middleNameInput.value = middleName;\r\n          // console.log('[OAUTH_CONT] Prefilled middleName:', middleName);\r\n        } else {\r\n          // Enable if empty so user can enter it or leave it blank\r\n          middleNameInput.removeAttribute(\"readonly\");\r\n          middleNameInput.removeAttribute(\"disabled\");\r\n          middleNameInput.removeAttribute(\"aria-disabled\");\r\n          middleNameInput.removeAttribute(\"title\");\r\n        }\r\n      }\r\n      const lastNameInput = document.getElementById(\"lastName\");\r\n      if (lastNameInput && lastName) {\r\n        lastNameInput.value = lastName;\r\n        // console.log('[OAUTH_CONT] Prefilled lastName:', lastName);\r\n      }\r\n      const emailInput = document.getElementById(\"email\");\r\n      if (emailInput && user.email) {\r\n        emailInput.value = user.email;\r\n        // console.log('[OAUTH_CONT] Prefilled email:', user.email);\r\n      }\r\n\r\n      // Try to get phone from OAuth provider\r\n      const oauthPhone = user.user_metadata?.phone_number ||\r\n                        user.user_metadata?.phone ||\r\n                        user.user_metadata?.mobile ||\r\n                        null;\r\n      const mobileInput = document.getElementById(\"mobile\");\r\n      if (mobileInput && oauthPhone) {\r\n        let digits = oauthPhone.replace(/\\D/g, \"\");\r\n        if (digits.startsWith(\"63\") && digits.length >= 12) {\r\n          digits = digits.substring(2, 12);\r\n        } else if (digits.length > 10) {\r\n          digits = digits.substring(digits.length - 10);\r\n        }\r\n        if (digits.length === 10) {\r\n          mobileInput.value = digits;\r\n          // console.log('[OAUTH_CONT] Prefilled mobile:', digits);\r\n        }\r\n      }\r\n    }\r\n  } catch (prefillError) {\r\n    console.warn(\"[OAUTH_CONT] Prefill failed:\", prefillError);\r\n  }\r\n\r\n  // Initialize CAPTCHA\r\n  // console.log('[OAUTH_CONT] Initializing CAPTCHA...');\r\n  initializeCaptcha();\r\n\r\n  // Re-initialize CAPTCHA after a delay to handle async script loading\r\n  setTimeout(initializeCaptcha, 1000);\r\n\r\n  // Verify form is visible\r\n  const _formVisible = form && form.offsetParent !== null;\r\n  const _step1Visible = step1 && step1.offsetParent !== null;\r\n  /* console.log('[OAUTH_CONT] Form visibility check:', {\r\n    formExists: !!form,\r\n    formVisible: formVisible,\r\n    step1Exists: !!step1,\r\n    step1Visible: step1Visible,\r\n    step1Hidden: step1?.hasAttribute('hidden')\r\n  }); */\r\n\r\n\r\n  // console.log('[OAUTH_CONT] ✅ Page initialization complete');\r\n  // console.log('[OAUTH_CONT] ========================================');\r\n};\r\n\r\n// Global handler for ID verification success (called by signup-id-verify.js)\r\nwindow.handleVerificationSuccess = (data) => {\r\n  console.log(\"[OAUTH_CONT] Handling verification success:\", data);\r\n\r\n  if (!data) return;\r\n\r\n  // Populate form fields with OCR data\r\n  const fields = {\r\n    firstName: data.firstName,\r\n    lastName: data.lastName,\r\n    middleName: data.middleName,\r\n    addressLine1: data.address,\r\n    // Map other fields if needed\r\n  };\r\n\r\n  let updatedCount = 0;\r\n\r\n  Object.entries(fields).forEach(([id, value]) => {\r\n    if (value) {\r\n      const input = document.getElementById(id);\r\n      if (input) {\r\n        // Only update if empty or user explicitly wants to overwrite (for now just update)\r\n        // Or maybe highlight matches?\r\n        // User said: \"if it matches the field in both the id and the form\"\r\n        // This implies validation. But prefilling is a good first step.\r\n        if (input.value !== value) {\r\n          input.value = value;\r\n          input.dispatchEvent(new Event(\"input\", { bubbles: true }));\r\n          updatedCount++;\r\n        }\r\n      }\r\n    }\r\n  });\r\n\r\n  if (updatedCount > 0) {\r\n    showMessage(\"success\", \"Form updated with ID information.\");\r\n  } else {\r\n    showMessage(\"success\", \"ID verified. Information matches form.\");\r\n  }\r\n\r\n  // Unlock next step if needed (handled by signup-progressive.js usually)\r\n  const nextBtn = document.getElementById(\"signup-next-btn\");\r\n  if (nextBtn) {\r\n    nextBtn.removeAttribute(\"disabled\");\r\n  }\r\n};\r\n\r\n// Initialize when DOM is ready\r\n// Initialize when DOM is ready\r\n// console.log('[OAUTH_CONT] Setting up initialization, document.readyState:', document.readyState);\r\n\r\nif (document.readyState === \"loading\") {\r\n  // console.log('[OAUTH_CONT] Document still loading, waiting for DOMContentLoaded...');\r\n  document.addEventListener(\"DOMContentLoaded\", () => {\r\n    // console.log('[OAUTH_CONT] DOMContentLoaded fired, initializing...');\r\n    initializeOAuthContinuationPage();\r\n  });\r\n} else {\r\n  // console.log('[OAUTH_CONT] Document already ready, initializing immediately...');\r\n  initializeOAuthContinuationPage();\r\n}\r\n\r\n// Also try immediate execution as fallback\r\nsetTimeout(() => {\r\n  // console.log('[OAUTH_CONT] Fallback timeout check, readyState:', document.readyState);\r\n  if (document.readyState === \"complete\" || document.readyState === \"interactive\") {\r\n    // console.log('[OAUTH_CONT] Fallback: Attempting initialization...');\r\n    initializeOAuthContinuationPage();\r\n  }\r\n}, 100);\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\auth\\roleToggle.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected alert.","line":8,"column":1,"nodeType":"CallExpression","messageId":"unexpected","endLine":8,"endColumn":40},{"ruleId":"no-unused-vars","severity":1,"message":"'supabase' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Role Toggle System\r\n * Allows staff roles to switch to citizen mode temporarily\r\n */\r\n// console.log removed for security\r\n// Test: Add a simple alert to see if script is running\r\n// console.log removed for security\r\nalert(\"Role toggle script is running!\");\r\nimport { supabase } from \"../config/config.js\";\r\nimport { getUserRole, saveUserMeta } from \"./authChecker.js\";\r\nimport showMessage from \"../components/toast.js\";\r\n\r\n// Local storage keys\r\nconst ROLE_MODE_KEY = \"cl_role_mode\";\r\nconst ACTUAL_ROLE_KEY = \"cl_actual_role\";\r\n// Roles that can switch\r\nconst SWITCHABLE_ROLES = [\r\n  \"complaint-coordinator\",\r\n  \"lgu\",           // LGU Officers\r\n  \"lgu-admin\",      // LGU Admins\r\n  \"lgu-hr\",         // LGU HR\r\n  \"super-admin\"\r\n];\r\n// Cache for role info API calls\r\nlet roleInfoCache = null;\r\nlet roleInfoCacheTime = 0;\r\nconst ROLE_INFO_CACHE_DURATION = 5000; // 5 seconds cache\r\n// Prevent multiple initializations\r\nlet isInitialized = false;\r\n/**\r\n * Check if current user can switch to citizen mode\r\n * Logic: Check the actual_role (not current role) to determine if user is staff\r\n * If actual_role is a staff role → show toggle button\r\n * If actual_role is citizen or doesn't exist → hide button\r\n */\r\nexport async function canSwitchToCitizen() {\r\n  try {\r\n    // Check cache first\r\n    const now = Date.now();\r\n    if (roleInfoCache && (now - roleInfoCacheTime) < ROLE_INFO_CACHE_DURATION) {\r\n      // console.log removed for security\r\n      const baseRole = roleInfoCache.data.base_role;\r\n      const _currentRole = roleInfoCache.data.role;\r\n\r\n      // If no base_role exists, user is a real citizen\r\n      if (!baseRole) {\r\n        // console.log removed for security\r\n        return false;\r\n      }\r\n\r\n      // Check if base_role is a switchable staff role\r\n      const canSwitch = SWITCHABLE_ROLES.includes(baseRole);\r\n\r\n      return canSwitch;\r\n    }\r\n\r\n    // Get role info from API - we need base_role to determine if user is really staff\r\n    const response = await fetch(\"/api/user/role-info\", {\r\n      credentials: \"include\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\"\r\n      }\r\n    });\r\n    const result = await response.json();\r\n    if (!result.success) {\r\n      console.error(\"[ROLE_TOGGLE] Failed to get role info:\", result);\r\n      return false;\r\n    }\r\n    // Cache the result\r\n    roleInfoCache = result;\r\n    roleInfoCacheTime = now;\r\n    // IMPORTANT: Check base_role, not current role\r\n    // base_role tells us what the user's real role is\r\n    // If they're in citizen mode, base_role will still be their staff role\r\n    const baseRole = result.data.base_role;\r\n    const _currentRole = result.data.role;\r\n    // If no base_role exists, user is a real citizen\r\n    if (!baseRole) {\r\n      // console.log removed for security\r\n      return false;\r\n    }\r\n    // Check if base_role is a switchable staff role\r\n    const canSwitch = SWITCHABLE_ROLES.includes(baseRole);\r\n    return canSwitch;\r\n  } catch (error) {\r\n    console.error(\"[ROLE_TOGGLE] Check switch error:\", error);\r\n    return false;\r\n  }\r\n}\r\n/**\r\n * Get current active role (considering toggle state)\r\n */\r\n\r\nexport function getActiveRole() {\r\n  try {\r\n    const roleMode = localStorage.getItem(ROLE_MODE_KEY);\r\n    const actualRole = localStorage.getItem(ACTUAL_ROLE_KEY);\r\n    if (roleMode === \"citizen\" && actualRole) {\r\n      return \"citizen\"; // Currently in citizen mode\r\n    }\r\n    return actualRole; // Normal mode\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n/**\r\n * Switch to citizen mode (updates database)\r\n */\r\n\r\nexport async function switchToCitizenMode() {\r\n  try {\r\n    const actualRole = await getUserRole({ refresh: true });\r\n    // Check if role is switchable\r\n    const canSwitch = SWITCHABLE_ROLES.includes(actualRole);\r\n    if (!canSwitch) {\r\n      showMessage(\"error\", \"Your role cannot switch to citizen mode\");\r\n      return false;\r\n    }\r\n    // console.log removed for security\r\n    // Update database via API\r\n    const response = await fetch(\"/api/user/switch-role\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({\r\n        targetRole: \"citizen\",\r\n        previousRole: actualRole\r\n      })\r\n    });\r\n    const result = await response.json();\r\n    if (!result.success) {\r\n      showMessage(\"error\", result.error || \"Failed to switch role\");\r\n      return false;\r\n    }\r\n    // Store base role in localStorage for UI reference\r\n    localStorage.setItem(ACTUAL_ROLE_KEY, actualRole);\r\n    localStorage.setItem(ROLE_MODE_KEY, \"citizen\");\r\n    // Update user meta to reflect citizen mode\r\n    saveUserMeta({ role: \"citizen\", base_role: actualRole, mode: \"citizen_mode\" });\r\n    showMessage(\"success\", \"Switched to Citizen mode. Refreshing...\");\r\n    // Refresh page to reload with new role\r\n    setTimeout(() => window.location.reload(), 1000);\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"[ROLE_TOGGLE] Switch to citizen error:\", error);\r\n    showMessage(\"error\", \"Failed to switch to citizen mode\");\r\n    return false;\r\n  }\r\n}\r\n/**\r\n * Switch back to actual role (updates database)\r\n */\r\n\r\nexport async function switchToActualRole() {\r\n  try {\r\n    const actualRole = localStorage.getItem(ACTUAL_ROLE_KEY);\r\n    if (!actualRole) {\r\n      showMessage(\"error\", \"No actual role found\");\r\n      console.error(\"[ROLE_TOGGLE] No actual role in localStorage\");\r\n      return false;\r\n    }\r\n    // console.log removed for security\r\n    // Update database via API\r\n    const response = await fetch(\"/api/user/switch-role\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({\r\n        targetRole: actualRole,\r\n        previousRole: \"citizen\"\r\n      })\r\n    });\r\n    const result = await response.json();\r\n    // console.log removed for security\r\n    if (!result.success) {\r\n      showMessage(\"error\", result.error || \"Failed to switch role\");\r\n      return false;\r\n    }\r\n    // Clear mode\r\n    localStorage.removeItem(ROLE_MODE_KEY);\r\n    // Update user meta to reflect base role\r\n    saveUserMeta({ role: actualRole });\r\n    // console.log removed for security\r\n    showMessage(\"success\", `Switched back to ${actualRole} mode. Refreshing...`);\r\n    // Refresh page to reload with new role\r\n    setTimeout(() => window.location.reload(), 1000);\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"[ROLE_TOGGLE] Switch to actual role error:\", error);\r\n    showMessage(\"error\", \"Failed to switch back\");\r\n    return false;\r\n  }\r\n}\r\n/**\r\n * Check if currently in citizen mode\r\n */\r\n\r\nexport function isInCitizenMode() {\r\n  try {\r\n    const roleMode = localStorage.getItem(ROLE_MODE_KEY);\r\n    return roleMode === \"citizen\";\r\n  } catch (error) {\r\n    return false;\r\n  }\r\n}\r\n/**\r\n * Get actual role (not considering toggle)\r\n */\r\n\r\nexport function getActualRole() {\r\n  try {\r\n    const actualRole = localStorage.getItem(ACTUAL_ROLE_KEY);\r\n    return actualRole || null;\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n/**\r\n * Initialize role toggle UI\r\n * Should be called on every page that needs the toggle\r\n */\r\n\r\nexport async function initializeRoleToggle() {\r\n  // console.log removed for security\r\n  // Prevent multiple initializations\r\n  if (isInitialized) {\r\n    // console.log removed for security\r\n    return;\r\n  }\r\n  isInitialized = true;\r\n  // Show button immediately with loading state\r\n  createRoleToggleButton(\"lgu\", false, true);\r\n  try {\r\n    // Check if user has a session before making API call\r\n    const { supabase } = await import(\"../config/config.js\");\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    if (!session) {\r\n      // No session, remove button and reset\r\n      const btn = document.getElementById(\"role-toggle-btn\");\r\n      if (btn) btn.remove();\r\n      isInitialized = false;\r\n      return;\r\n    }\r\n\r\n    // Check if user has a base role (meaning they're staff who can switch)\r\n    const response = await fetch(\"/api/user/role-info\", {\r\n      credentials: \"include\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\"\r\n      }\r\n    });\r\n\r\n    if (!response.ok) {\r\n      // Handle 401 gracefully - user not authenticated\r\n      if (response.status === 401) {\r\n        const btn = document.getElementById(\"role-toggle-btn\");\r\n        if (btn) btn.remove();\r\n        isInitialized = false;\r\n        return;\r\n      }\r\n      throw new Error(`HTTP error! status: ${response.status}`);\r\n    }\r\n\r\n    const result = await response.json();\r\n    const baseRole = result?.data?.base_role;\r\n    const currentRole = result?.data?.role || \"citizen\";\r\n    // Show button if user has a base role (staff member) OR if they're currently in citizen mode with a base role\r\n    const hasBaseRole = baseRole && baseRole !== \"citizen\";\r\n    const isInCitizenMode = currentRole === \"citizen\" && baseRole;\r\n    if (!hasBaseRole && !isInCitizenMode) {\r\n      // Remove the button if user is a real citizen (no base role)\r\n      const btn = document.getElementById(\"role-toggle-btn\");\r\n      if (btn) {\r\n        // console.log removed for security\r\n        btn.remove();\r\n      }\r\n      isInitialized = false; // Reset initialization flag\r\n      return;\r\n    }\r\n    // console.log removed for security\r\n    // Cache the result for future use\r\n    roleInfoCache = result;\r\n    roleInfoCacheTime = Date.now();\r\n    // Update localStorage to keep in sync\r\n    if (isInCitizenMode) {\r\n      localStorage.setItem(ACTUAL_ROLE_KEY, baseRole);\r\n      localStorage.setItem(ROLE_MODE_KEY, \"citizen\");\r\n    } else {\r\n      localStorage.removeItem(ROLE_MODE_KEY);\r\n    }\r\n    // Update button with base role\r\n    updateRoleToggleButton(baseRole, isInCitizenMode);\r\n    // Watch for header changes and re-add button if needed\r\n    watchForHeaderChanges(baseRole, isInCitizenMode);\r\n  } catch (error) {\r\n    console.error(\"[ROLE_TOGGLE] Initialize error:\", error);\r\n    // Remove button on error\r\n    const btn = document.getElementById(\"role-toggle-btn\");\r\n    if (btn) btn.remove();\r\n  }\r\n}\r\n/**\r\n * Watch for header changes and re-add button if needed\r\n */\r\nfunction watchForHeaderChanges(baseRole, isInCitizenMode) {\r\n  const headerRight = document.querySelector(\".header-right\");\r\n  if (!headerRight) return;\r\n  const observer = new MutationObserver((mutations) => {\r\n    mutations.forEach((mutation) => {\r\n      if (mutation.type === \"childList\") {\r\n        // Check if our button was removed\r\n        const existingBtn = document.getElementById(\"role-toggle-btn\");\r\n        if (!existingBtn && (baseRole || isInCitizenMode)) {\r\n          // console.log removed for security\r\n          createRoleToggleButton(baseRole, isInCitizenMode, false);\r\n        }\r\n      }\r\n    });\r\n  });\r\n  observer.observe(headerRight, {\r\n    childList: true,\r\n    subtree: true\r\n  });\r\n  // Store observer for cleanup if needed\r\n  window.roleToggleObserver = observer;\r\n}\r\n/**\r\n * Create role toggle button in header (simple button matching existing style)\r\n */\r\nfunction createRoleToggleButton(actualRole = null, isInCitizen = false, isLoading = false) {\r\n  // Check if button already exists\r\n  const existingBtn = document.getElementById(\"role-toggle-btn\");\r\n  if (existingBtn) {\r\n    // console.log removed for security\r\n    updateRoleToggleButton(actualRole, isInCitizen);\r\n    return;\r\n  }\r\n  // Find header-right container (where notification and profile buttons are)\r\n  const headerRight = document.querySelector(\".header-right\");\r\n  if (!headerRight) {\r\n    console.warn(\"[ROLE_TOGGLE] Header-right not found, retrying...\");\r\n    // Retry with multiple attempts and longer delays\r\n    setTimeout(() => {\r\n      const retryHeaderRight = document.querySelector(\".header-right\");\r\n      if (retryHeaderRight) {\r\n        // console.log removed for security\r\n        createRoleToggleButton(actualRole, isInCitizen, isLoading);\r\n      } else {\r\n        // Try again after header initialization\r\n        setTimeout(() => {\r\n          const secondRetry = document.querySelector(\".header-right\");\r\n          if (secondRetry) {\r\n            // console.log removed for security\r\n            createRoleToggleButton(actualRole, isInCitizen, isLoading);\r\n          } else {\r\n            // Final attempt after everything should be loaded\r\n            setTimeout(() => {\r\n              const finalRetry = document.querySelector(\".header-right\");\r\n              if (finalRetry) {\r\n                // console.log removed for security\r\n                createRoleToggleButton(actualRole, isInCitizen, isLoading);\r\n              } else {\r\n                console.warn(\"[ROLE_TOGGLE] Header-right not found after multiple retries - header may not be initialized\");\r\n              }\r\n            }, 2000); // Wait 2 seconds for full initialization\r\n          }\r\n        }, 1000); // Wait 1 second for header to be created\r\n      }\r\n    }, 500); // Initial retry after 500ms\r\n    return;\r\n  }\r\n  const toggleBtn = document.createElement(\"button\");\r\n  toggleBtn.id = \"role-toggle-btn\";\r\n  toggleBtn.className = \"role-toggle-btn\";\r\n  if (isLoading) {\r\n    toggleBtn.title = \"Loading...\";\r\n    toggleBtn.innerHTML = \"⏳\";\r\n    toggleBtn.disabled = true;\r\n  } else if (actualRole) {\r\n    toggleBtn.title = isInCitizen ? `Switch back to ${formatRoleName(actualRole)}` : \"Switch to Citizen Mode\";\r\n    toggleBtn.innerHTML = isInCitizen ? \"👔\" : \"👤\";\r\n    toggleBtn.disabled = false;\r\n    toggleBtn.addEventListener(\"click\", async () => {\r\n      if (isInCitizenMode()) {\r\n        const success = await switchToActualRole();\r\n        if (success) {\r\n          setTimeout(() => window.location.reload(), 500);\r\n        }\r\n      } else {\r\n        const success = await switchToCitizenMode();\r\n        if (success) {\r\n          setTimeout(() => window.location.reload(), 500);\r\n        }\r\n      }\r\n    });\r\n  } else {\r\n    toggleBtn.title = \"Role Toggle\";\r\n    toggleBtn.innerHTML = \"👤\";\r\n    toggleBtn.disabled = true;\r\n  }\r\n  // Add simple styles that match notification button\r\n  addToggleStyles();\r\n  // Insert before notification button\r\n  const notificationContainer = headerRight.querySelector(\".notification-container\");\r\n  if (notificationContainer) {\r\n    headerRight.insertBefore(toggleBtn, notificationContainer);\r\n  } else {\r\n    headerRight.prepend(toggleBtn);\r\n  }\r\n  // console.log removed for security\r\n}\r\n/**\r\n * Update existing role toggle button\r\n */\r\nfunction updateRoleToggleButton(actualRole, isInCitizen) {\r\n  // console.log removed for security\r\n  const toggleBtn = document.getElementById(\"role-toggle-btn\");\r\n  if (!toggleBtn) {\r\n    console.warn(\"[ROLE_TOGGLE] Button not found for update, creating new one\");\r\n    createRoleToggleButton(actualRole, isInCitizen, false);\r\n    return;\r\n  }\r\n  toggleBtn.disabled = false;\r\n  toggleBtn.title = isInCitizen ? `Switch back to ${formatRoleName(actualRole)}` : \"Switch to Citizen Mode\";\r\n  toggleBtn.innerHTML = isInCitizen ? \"👔\" : \"👤\";\r\n  // console.log removed for security\r\n  // console.log removed for security\r\n  // Remove old listener and add new one\r\n  const newBtn = toggleBtn.cloneNode(true);\r\n  toggleBtn.parentNode.replaceChild(newBtn, toggleBtn);\r\n  newBtn.addEventListener(\"click\", async () => {\r\n    const inCitizenMode = isInCitizenMode();\r\n    // console.log removed for security\r\n    if (inCitizenMode) {\r\n      // console.log removed for security\r\n      const success = await switchToActualRole();\r\n      if (success) {\r\n        setTimeout(() => window.location.reload(), 500);\r\n      }\r\n    } else {\r\n      // console.log removed for security\r\n      const success = await switchToCitizenMode();\r\n      if (success) {\r\n        setTimeout(() => window.location.reload(), 500);\r\n      }\r\n    }\r\n  });\r\n  // console.log removed for security\r\n}\r\n/**\r\n * Format role name for display\r\n */\r\nfunction formatRoleName(role) {\r\n  // Handle LGU officer roles with department codes\r\n  if (/^lgu-(?!admin|hr)/.test(role)) {\r\n    const dept = role.replace(/^lgu-/, \"\").toUpperCase();\r\n    return `LGU Officer (${dept})`;\r\n  }\r\n  // Handle LGU admin roles with department codes\r\n  if (/^lgu-admin-/.test(role)) {\r\n    const dept = role.replace(/^lgu-admin-/, \"\").toUpperCase();\r\n    return `LGU Admin (${dept})`;\r\n  }\r\n  // Handle LGU HR roles with department codes\r\n  if (/^lgu-hr-/.test(role)) {\r\n    const dept = role.replace(/^lgu-hr-/, \"\").toUpperCase();\r\n    return `HR (${dept})`;\r\n  }\r\n  const names = {\r\n    \"complaint-coordinator\": \"Coordinator\",\r\n    \"lgu-admin\": \"LGU Admin\",\r\n    \"lgu-hr\": \"HR\",\r\n    \"super-admin\": \"Super Admin\"\r\n  };\r\n  return names[role] || role;\r\n}\r\n/**\r\n * Add CSS styles for toggle button (matches notification button style)\r\n */\r\nfunction addToggleStyles() {\r\n  if (document.getElementById(\"role-toggle-styles\")) {\r\n    return;\r\n  }\r\n  const styles = document.createElement(\"style\");\r\n  styles.id = \"role-toggle-styles\";\r\n  styles.textContent = `\r\n    .role-toggle-btn {\r\n      position: relative;\r\n      background: none;\r\n      border: none;\r\n      font-size: 16px;\r\n      cursor: pointer;\r\n      padding: 6px;\r\n      border-radius: 50%;\r\n      transition: background-color 0.2s ease;\r\n      width: 32px;\r\n      height: 32px;\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      flex-shrink: 0;\r\n    }\r\n\r\n    .role-toggle-btn:hover {\r\n      background-color: rgba(0, 0, 0, 0.1);\r\n    }\r\n\r\n    .role-toggle-btn:active {\r\n      background-color: rgba(0, 0, 0, 0.15);\r\n    }\r\n\r\n    @media (max-width: 768px) {\r\n      .role-toggle-btn {\r\n        width: 28px;\r\n        height: 28px;\r\n        font-size: 14px;\r\n      }\r\n    }\r\n  `;\r\n  document.head.appendChild(styles);\r\n}\r\n// Auto-initialize on page load\r\nif (typeof window !== \"undefined\") {\r\n  document.addEventListener(\"DOMContentLoaded\", () => {\r\n    initializeRoleToggle();\r\n  });\r\n}\r\n\r\nexport default {\r\n  canSwitchToCitizen,\r\n  getActiveRole,\r\n  switchToCitizenMode,\r\n  switchToActualRole,\r\n  isInCitizenMode,\r\n  getActualRole,\r\n  initializeRoleToggle\r\n};\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\auth\\signup-page.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'suppressAuthErrorNotifications' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":63,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":93},{"ruleId":"no-unused-vars","severity":1,"message":"'shouldSkipAuthCheck' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":29},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":389,"column":36,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":389,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Signup page specific functionality\r\nimport { supabase } from \"../config/config.js\";\r\nimport showMessage from \"../components/toast.js\";\r\nimport { renderPrivacyNotice } from \"../utils/privacyContent.js\";\r\nimport { getOAuthContext, setOAuthContext, clearOAuthContext, suppressAuthErrorNotifications } from \"../auth/authChecker.js\";\r\nimport { shouldSkipAuthCheck } from \"../utils/oauth-cleanup.js\";\r\n\r\n// Check if user is already logged in and redirect to dashboard\r\nconst shouldDeferAuthRedirect = () => {\r\n  try {\r\n    const ctx = getOAuthContext();\r\n    return ctx && ctx.intent === \"signup\" && ctx.status === \"pending\";\r\n  } catch {\r\n    return false;\r\n  }\r\n};\r\n\r\n// Global Guard handles all cleanup now - redundant code removed\r\n\r\nconst checkAuthentication = async () => {\r\n  try {\r\n    // Global Guard already ran at init\r\n    // await clearOAuthContextOnLanding();\r\n\r\n    // Check if we just cleaned up OAuth - skip redirects\r\n    let oauthCleanupFlag = false;\r\n    try {\r\n      oauthCleanupFlag = sessionStorage.getItem(\"cl_oauth_cleanup\") === \"true\";\r\n      if (oauthCleanupFlag) {\r\n        sessionStorage.removeItem(\"cl_oauth_cleanup\");\r\n      }\r\n    } catch {}\r\n\r\n    // If we just cleaned up, don't redirect - let user proceed with signup\r\n    if (oauthCleanupFlag) {\r\n      return;\r\n    }\r\n\r\n    // Check for pending OAuth - if exists and user explicitly navigated, don't redirect\r\n    // But allow legitimate OAuth continuation redirects\r\n    const oauthCtx = getOAuthContext();\r\n    const hasPendingOAuth = oauthCtx && oauthCtx.status === \"pending\";\r\n\r\n    // Only skip redirect if user explicitly navigated (not from OAuth redirect)\r\n    if (hasPendingOAuth) {\r\n      const urlParams = new URLSearchParams(window.location.search);\r\n      const isOAuthRedirect = urlParams.get(\"code\") || urlParams.get(\"error\") || urlParams.get(\"popup\") === \"1\";\r\n      // If user explicitly navigated (not from OAuth), don't redirect\r\n      if (!isOAuthRedirect) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    // console.log removed for security\r\n    // Get current session\r\n    const { data: { session }, error } = await supabase.auth.getSession();\r\n    if (session && !error) {\r\n      // console.log removed for security\r\n      // Get user metadata\r\n      const {user} = session;\r\n      const role = user?.user_metadata?.role || \"\";\r\n      const name = user?.user_metadata?.name || \"\";\r\n      // Check if user has completed registration\r\n      if (role && name) {\r\n        // console.log removed for security\r\n        if (shouldDeferAuthRedirect()) return;\r\n        window.location.href = \"/dashboard\";\r\n      } else {\r\n        // User has incomplete registration - redirect to continuation\r\n        // This is the normal flow after OAuth signup\r\n        // Only defer if there's a pending OAuth and user explicitly navigated\r\n        if (shouldDeferAuthRedirect()) {\r\n          const urlParams = new URLSearchParams(window.location.search);\r\n          const isOAuthRedirect = urlParams.get(\"code\") || urlParams.get(\"error\") || urlParams.get(\"popup\") === \"1\";\r\n          // If not from OAuth redirect, don't redirect to continuation\r\n          if (!isOAuthRedirect) {\r\n            return;\r\n          }\r\n        }\r\n        // console.log removed for security\r\n        window.location.href = \"/oauth-continuation\";\r\n      }\r\n    } else {\r\n      // console.log removed for security\r\n    }\r\n  } catch (error) {\r\n    console.error(\"💥 Authentication check failed:\", error);\r\n    // If there's an error, let the user proceed with signup\r\n  }\r\n};\r\n\r\nlet resetSignupStateHandler = null;\r\nlet oauthAbortWatcherInstalled = false;\r\n\r\n// Initialize signup page\r\nconst initializeSignupPage = async () => {\r\n  // CRITICAL: Run Global OAuth Guard FIRST to wipe stale state\r\n  const { initGlobalOAuthGuard } = await import(\"../utils/global-oauth-guard.js\");\r\n  await initGlobalOAuthGuard();\r\n\r\n  // Setup navigation cleanup for login/signup buttons and brand logo\r\n  const { setupNavigationCleanup } = await import(\"../utils/navigation.js\");\r\n  setupNavigationCleanup();\r\n\r\n  // Run authentication check when page loads\r\n  checkAuthentication();\r\n\r\n  // Wire password strength meter\r\n  attachPasswordStrengthMeter();\r\n\r\n  // Listen for auth state changes to update UI dynamically\r\n  supabase.auth.onAuthStateChange((event, session) => {\r\n    // console.log removed for security\r\n    if (event === \"SIGNED_IN\" && session) {\r\n      checkAuthentication();\r\n    }\r\n  });\r\n  // Terms & Privacy Modals are now handled by the SimpleModal component\r\n  // Listen for acceptance events to update the checkbox\r\n  document.addEventListener(\"termsAccepted\", () => {\r\n    const termsCheckbox = document.getElementById(\"terms-checkbox\");\r\n    if (termsCheckbox) termsCheckbox.checked = true;\r\n  });\r\n  document.addEventListener(\"privacyAccepted\", () => {\r\n    const termsCheckbox = document.getElementById(\"terms-checkbox\");\r\n    if (termsCheckbox) termsCheckbox.checked = true;\r\n  });\r\n  renderPrivacyNotice(\"#privacyModalContent\", { headingTag: \"h4\" });\r\n  setupSignupMethodSelector();\r\n  setupOAuthPopupBridge();\r\n  setupOAuthAbortWatcher();\r\n};\r\n// --- Live password strength meter wiring ---\r\nfunction attachPasswordStrengthMeter() {\r\n  try {\r\n    const passwordInput = document.getElementById(\"regPassword\");\r\n    const strengthFill = document.getElementById(\"strength-fill\");\r\n    const strengthText = document.getElementById(\"strength-text\");\r\n    if (!passwordInput || !strengthFill || !strengthText) return;\r\n    const _classList = [\"weak\", \"fair\", \"good\", \"strong\"];\r\n    const calcScore = (pwd) => {\r\n      let score = 0;\r\n      if (!pwd) return 0;\r\n      if (pwd.length >= 8) score++;\r\n      if (pwd.length >= 12) score++;\r\n      if (/[a-z]/.test(pwd)) score++;\r\n      if (/[A-Z]/.test(pwd)) score++;\r\n      if (/\\d/.test(pwd)) score++;\r\n      if (/[!@#$%^&*()_+\\-=[\\]{};':\"\\\\|,.<>/?]/.test(pwd)) score++;\r\n      // penalties\r\n      if (/(.)\\1{2,}/.test(pwd)) score -= 1;\r\n      if (/123456|abcdef|qwerty|asdfgh|zxcvbn/i.test(pwd)) score -= 2;\r\n      return Math.max(0, Math.min(4, score));\r\n    };\r\n\r\n    const labelFor = (score) => {\r\n      switch (true) {\r\n        case score <= 1: return \"Weak\";\r\n        case score === 2: return \"Fair\";\r\n        case score === 3: return \"Good\";\r\n        default: return \"Strong\";\r\n      }\r\n    };\r\n    const classFor = (score) => {\r\n      if (score <= 1) return \"weak\";\r\n      if (score === 2) return \"fair\";\r\n      if (score === 3) return \"good\";\r\n      return \"strong\";\r\n    };\r\n    const update = () => {\r\n      const pwd = passwordInput.value || \"\";\r\n      // Do not evaluate if empty or less than 8 chars\r\n      if (pwd.length < 8) {\r\n        strengthFill.classList.remove(\"weak\",\"fair\",\"good\",\"strong\");\r\n        strengthText.classList.remove(\"weak\",\"fair\",\"good\",\"strong\");\r\n        strengthFill.style.width = \"0%\";\r\n        strengthText.textContent = \"Password strength\";\r\n        return;\r\n      }\r\n      const score = calcScore(pwd);\r\n      const cls = classFor(score);\r\n      // reset\r\n      strengthFill.classList.remove(\"weak\",\"fair\",\"good\",\"strong\");\r\n      strengthText.classList.remove(\"weak\",\"fair\",\"good\",\"strong\");\r\n      // Apply base width 0 first\r\n      strengthFill.style.width = \"0%\";\r\n      // apply classes\r\n      strengthFill.classList.add(cls);\r\n      strengthText.classList.add(cls);\r\n      // Map class to width explicitly in case CSS not applied yet\r\n      const widthMap = { weak: \"25%\", fair: \"50%\", good: \"75%\", strong: \"100%\" };\r\n      strengthFill.style.width = widthMap[cls];\r\n      strengthText.textContent = `Password strength: ${labelFor(score)}`;\r\n    };\r\n    passwordInput.addEventListener(\"input\", update);\r\n    update();\r\n  } catch (_) {}\r\n}\r\n// Initialize when DOM is ready\r\nif (document.readyState === \"loading\") {\r\n  document.addEventListener(\"DOMContentLoaded\", initializeSignupPage);\r\n} else {\r\n  initializeSignupPage();\r\n}\r\n\r\n// --- Signup method selector ---\r\nconst METHOD_STORAGE_KEY = \"cl_signup_method\";\r\n\r\nfunction setupSignupMethodSelector() {\r\n  const regForm = document.getElementById(\"regForm\");\r\n  const emailFlow = document.getElementById(\"signup-email-flow\");\r\n  const placeholder = document.getElementById(\"signup-flow-placeholder\");\r\n  const methodSection = document.getElementById(\"signup-method-section\");\r\n  const methodBackBtn = document.getElementById(\"signup-method-back\");\r\n  const buttons = document.querySelectorAll(\"[data-signup-method]\");\r\n  if (!regForm || !emailFlow) return;\r\n\r\n  const selectMethod = (method, { persist = false } = {}) => {\r\n    regForm.dataset.method = method;\r\n    buttons.forEach((btn) => {\r\n      const isActive = btn.dataset.signupMethod === method;\r\n      btn.setAttribute(\"aria-pressed\", isActive ? \"true\" : \"false\");\r\n    });\r\n    if (method === \"email\") {\r\n      methodSection?.setAttribute(\"hidden\", \"\");\r\n      methodBackBtn?.removeAttribute(\"hidden\");\r\n      emailFlow.hidden = false;\r\n      placeholder?.setAttribute(\"hidden\", \"\");\r\n    } else {\r\n      methodSection?.removeAttribute(\"hidden\");\r\n      methodBackBtn?.setAttribute(\"hidden\", \"\");\r\n      emailFlow.hidden = true;\r\n      if (method === \"none\") {\r\n        placeholder?.removeAttribute(\"hidden\");\r\n      } else {\r\n        placeholder?.setAttribute(\"hidden\", \"\");\r\n      }\r\n    }\r\n    if (persist) {\r\n      try {\r\n        if (method === \"email\") {\r\n          localStorage.setItem(METHOD_STORAGE_KEY, \"email\");\r\n        } else {\r\n          localStorage.removeItem(METHOD_STORAGE_KEY);\r\n        }\r\n      } catch {}\r\n    }\r\n  };\r\n\r\n  const resetSignupState = ({ persist = true } = {}) => {\r\n    if (regForm) {\r\n      regForm.reset();\r\n      regForm.dataset.method = \"none\";\r\n    }\r\n    selectMethod(\"none\", { persist });\r\n    clearOAuthContext();\r\n    try { localStorage.removeItem(\"cl_signup_step_index\"); } catch {} // Reset step index storage\r\n    document.dispatchEvent(new Event(\"signup-reset\")); // Reset UI step to 0\r\n  };\r\n  resetSignupStateHandler = resetSignupState;\r\n\r\n  buttons.forEach((btn) => {\r\n    btn.addEventListener(\"click\", () => {\r\n      const method = btn.dataset.signupMethod || \"email\";\r\n      selectMethod(method, { persist: true });\r\n    });\r\n  });\r\n\r\n  // Restore last method if it was email to keep the form open\r\n  let cachedMethod = null;\r\n  try {\r\n    cachedMethod = localStorage.getItem(METHOD_STORAGE_KEY);\r\n  } catch {}\r\n  if (cachedMethod === \"email\") {\r\n    selectMethod(\"email\");\r\n  } else {\r\n    selectMethod(\"none\");\r\n  }\r\n\r\n  methodBackBtn?.addEventListener(\"click\", () => {\r\n    resetSignupState({ persist: true });\r\n    const methodTop = methodSection?.offsetTop || 0;\r\n    window.scrollTo({ top: methodTop - 40, behavior: \"smooth\" });\r\n  });\r\n\r\n  // Removed handlePageExit to allow persistence across refreshes\r\n  // window.addEventListener('pagehide', handlePageExit);\r\n  // window.addEventListener('beforeunload', handlePageExit);\r\n}\r\n\r\nfunction setupOAuthPopupBridge() {\r\n  window.addEventListener(\"message\", async (event) => {\r\n    if (event.origin !== window.location.origin) return;\r\n\r\n    // Log the full event data to debug\r\n    // console.log('[SIGNUP] Received message from popup:', event.data); // Redacted for security\r\n    console.log(\"[SIGNUP] Full event:\", {\r\n      type: event.data?.type,\r\n      redirectTo: event.data?.redirectTo,\r\n      incomplete: event.data?.incomplete,\r\n      // payload: event.data?.payload, // Redacted for security\r\n      // fullData: event.data // Redacted for security\r\n    });\r\n\r\n    const { type, payload, redirectTo, incomplete } = event.data || {};\r\n\r\n    if (type === \"oauth-signup-success\") {\r\n      const provider = (payload?.provider || \"OAuth\").replace(/^\\w/, (c) => c.toUpperCase());\r\n      console.log(\"[SIGNUP] ✅ OAuth signup success, provider:\", provider);\r\n      console.log(\"[SIGNUP] Message details:\", {\r\n        redirectTo,\r\n        incomplete,\r\n        hasPayload: Boolean(payload)\r\n      });\r\n\r\n      try {\r\n        const ctx = getOAuthContext() || {};\r\n        setOAuthContext({ ...ctx, status: \"handoff\" });\r\n        console.log(\"[SIGNUP] OAuth context updated to handoff\");\r\n      } catch (e) {\r\n        console.error(\"[SIGNUP] Error updating OAuth context:\", e);\r\n      }\r\n\r\n      // CRITICAL: Set the session in this window before redirecting\r\n      // Supabase sessions are window-specific, so we need to sync it from popup\r\n      const accessToken = event.data?.accessToken;\r\n      const refreshToken = event.data?.refreshToken;\r\n\r\n      if (accessToken && refreshToken) {\r\n        try {\r\n          console.log(\"[SIGNUP] Setting session in main window...\");\r\n          console.log(\"[SIGNUP] Access token length:\", accessToken.length);\r\n          console.log(\"[SIGNUP] Refresh token length:\", refreshToken.length);\r\n\r\n          // Set the session using setSession\r\n          const { _data, error } = await supabase.auth.setSession({\r\n            access_token: accessToken,\r\n            refresh_token: refreshToken\r\n          });\r\n\r\n          if (error) {\r\n            console.error(\"[SIGNUP] ❌ Error setting session:\", error);\r\n            console.error(\"[SIGNUP] Error details:\", error.message, error.status);\r\n          } else {\r\n            console.log(\"[SIGNUP] ✅ Session set successfully in main window\");\r\n\r\n            // Verify session is actually set\r\n            const { data: { session: verifySession }, error: verifyError } = await supabase.auth.getSession();\r\n            if (verifySession) {\r\n              console.log(\"[SIGNUP] ✅ Session verified - user ID:\", verifySession.user?.id);\r\n            } else {\r\n              console.error(\"[SIGNUP] ❌ Session verification failed:\", verifyError);\r\n            }\r\n\r\n            // Also set server-side cookie\r\n            try {\r\n              const cookieResponse = await fetch(\"/auth/session\", {\r\n                method: \"POST\",\r\n                headers: { \"Content-Type\": \"application/json\" },\r\n                body: JSON.stringify({ access_token: accessToken })\r\n              });\r\n              if (cookieResponse.ok) {\r\n                console.log(\"[SIGNUP] ✅ Server session cookie set\");\r\n              } else {\r\n                console.warn(\"[SIGNUP] ⚠️ Server session cookie not set:\", cookieResponse.status);\r\n              }\r\n            } catch (cookieError) {\r\n              console.warn(\"[SIGNUP] ⚠️ Error setting server cookie:\", cookieError);\r\n            }\r\n          }\r\n        } catch (sessionError) {\r\n          console.error(\"[SIGNUP] ❌ Error setting session:\", sessionError);\r\n          console.error(\"[SIGNUP] Error stack:\", sessionError.stack);\r\n        }\r\n      } else {\r\n        console.warn(\"[SIGNUP] ⚠️ No access/refresh tokens in message\");\r\n        console.warn(\"[SIGNUP] Access token:\", Boolean(accessToken), \"Refresh token:\", Boolean(refreshToken));\r\n      }\r\n\r\n      showMessage(\"success\", `${provider} connected. Finishing setup...`);\r\n\r\n      // CRITICAL: Always redirect to continuation for OAuth signups\r\n      // Extract redirectTo from event.data if not in destructured variables\r\n      const actualRedirectTo = redirectTo || event.data?.redirectTo || \"/oauth-continuation\";\r\n\r\n      console.log(\"[SIGNUP] Redirect decision:\", {\r\n        willRedirect: true,\r\n        redirectTo: actualRedirectTo,\r\n        incomplete: incomplete !== undefined ? incomplete : event.data?.incomplete,\r\n        eventDataKeys: Object.keys(event.data || {}),\r\n        hasAccessToken: Boolean(accessToken),\r\n        hasRefreshToken: Boolean(refreshToken)\r\n      });\r\n\r\n      console.log(\"[SIGNUP] ✅ REDIRECTING TO:\", actualRedirectTo);\r\n\r\n      // CRITICAL: If we have tokens, pass them in URL hash for Supabase to pick up\r\n      // This is how Supabase normally handles OAuth redirects\r\n      let redirectUrl = actualRedirectTo;\r\n      if (accessToken && refreshToken) {\r\n        // Add tokens to URL hash - Supabase will automatically extract and set them\r\n        const hashParams = new URLSearchParams();\r\n        hashParams.set(\"access_token\", accessToken);\r\n        hashParams.set(\"refresh_token\", refreshToken);\r\n        hashParams.set(\"type\", \"recovery\"); // This tells Supabase to set the session\r\n        redirectUrl = `${actualRedirectTo}#${hashParams.toString()}`;\r\n        console.log(\"[SIGNUP] Adding session tokens to URL hash for Supabase\");\r\n      }\r\n\r\n      // Increased delay to ensure session is fully set and persisted before redirect\r\n      setTimeout(async () => {\r\n        // Double-check session before redirect\r\n        const { data: { session: finalCheck }, error: _finalError } = await supabase.auth.getSession();\r\n        if (finalCheck) {\r\n          console.log(\"[SIGNUP] ✅ Final session check passed - user ID:\", finalCheck.user?.id);\r\n          console.log(\"[SIGNUP] Executing redirect now...\");\r\n          window.location.href = redirectUrl;\r\n        } else {\r\n          console.warn(\"[SIGNUP] ⚠️ Session check failed, but redirecting anyway with tokens in URL\");\r\n          console.warn(\"[SIGNUP] Supabase will extract tokens from URL hash\");\r\n          // Redirect anyway - Supabase will extract tokens from URL hash\r\n          window.location.href = redirectUrl;\r\n        }\r\n      }, 800); // Increased delay to ensure session is fully persisted\r\n    }\r\n    if (type === \"oauth-user-exists\") {\r\n      cleanupPendingOAuth(\"User already exist\");\r\n    }\r\n    if (type === \"oauth-signup-error\" && payload?.message) {\r\n      cleanupPendingOAuth(payload.message);\r\n    }\r\n  });\r\n}\r\n\r\nconst OAUTH_STALE_TIMEOUT_MS = 3000;\r\n\r\nasync function cleanupPendingOAuth(message = \"OAuth signup was cancelled. Please try again.\") {\r\n  try {\r\n    // Get user ID before signing out\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    const userId = session?.user?.id;\r\n\r\n    // Delete user from database if user exists and has valid session\r\n    if (userId && session?.access_token) {\r\n      try {\r\n        // Get auth token for the delete request\r\n        const token = session.access_token;\r\n        const headers = { \"Content-Type\": \"application/json\" };\r\n        headers[\"Authorization\"] = `Bearer ${token}`;\r\n\r\n        // Delete user data (this will also delete from auth.users)\r\n        // If this fails, we'll still proceed with sign out and context clearing\r\n        const deleteResponse = await fetch(\"/api/compliance/delete\", {\r\n          method: \"DELETE\",\r\n          headers,\r\n          credentials: \"include\",\r\n          body: JSON.stringify({\r\n            userId,\r\n            confirm: true,\r\n            reason: \"Incomplete OAuth signup cancelled by user\"\r\n          })\r\n        });\r\n\r\n        // Only log if it's not a 401/403 (expected for invalid sessions)\r\n        if (!deleteResponse.ok) {\r\n          const errorData = await deleteResponse.json().catch(() => ({}));\r\n          const {status} = deleteResponse;\r\n          // Don't log auth errors - they're expected for incomplete signups\r\n          if (status !== 401 && status !== 403) {\r\n            console.warn(\"[SIGNUP] Failed to delete incomplete OAuth user:\", errorData.error || \"Unknown error\");\r\n          }\r\n        }\r\n      } catch (deleteError) {\r\n        // Silently fail - incomplete signups may not have valid sessions\r\n        // The sign out below will still clear the session\r\n      }\r\n    }\r\n\r\n    // Sign out after deletion attempt\r\n    await supabase.auth.signOut();\r\n  } catch {}\r\n\r\n  try { await fetch(\"/auth/session\", { method: \"DELETE\" }); } catch {}\r\n  clearOAuthContext();\r\n  resetSignupStateHandler?.({ persist: true });\r\n  if (message) {\r\n    showMessage(\"error\", message);\r\n  }\r\n}\r\n\r\nfunction setupOAuthAbortWatcher() {\r\n  if (oauthAbortWatcherInstalled) return;\r\n  oauthAbortWatcherInstalled = true;\r\n\r\n  const checkPendingOAuth = async () => {\r\n    try {\r\n      const ctx = getOAuthContext();\r\n      if (ctx && ctx.intent === \"signup\" && ctx.status === \"pending\") {\r\n        const startedAt = Number(ctx.startedAt) || 0;\r\n        const elapsed = Date.now() - startedAt;\r\n        if (elapsed > OAUTH_STALE_TIMEOUT_MS) {\r\n          await cleanupPendingOAuth(\"OAuth signup did not finish. Please try again.\");\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn(\"[SIGNUP] OAuth abort watcher error:\", error);\r\n    }\r\n  };\r\n\r\n  // Handle tab close / navigation away\r\n  const handleBeforeUnload = async () => {\r\n    const ctx = getOAuthContext();\r\n    if (ctx && ctx.intent === \"signup\" && ctx.status === \"pending\") {\r\n      // Cleanup on page unload (silently)\r\n      await cleanupPendingOAuth(null);\r\n    }\r\n  };\r\n\r\n  // Handle visibility change (user switches tabs)\r\n  const handleVisibilityChange = () => {\r\n    if (document.visibilityState === \"visible\") {\r\n      checkPendingOAuth();\r\n    } else if (document.visibilityState === \"hidden\") {\r\n      // Mark as potentially abandoned\r\n      const ctx = getOAuthContext();\r\n      if (ctx && ctx.intent === \"signup\" && ctx.status === \"pending\") {\r\n        setOAuthContext({ ...ctx, lastActivity: Date.now() });\r\n      }\r\n    }\r\n  };\r\n\r\n  // Handle page hide (navigation away)\r\n  const handlePageHide = async () => {\r\n    const ctx = getOAuthContext();\r\n    if (ctx && ctx.intent === \"signup\" && ctx.status === \"pending\") {\r\n      await cleanupPendingOAuth(null);\r\n    }\r\n  };\r\n\r\n  window.addEventListener(\"focus\", checkPendingOAuth, true);\r\n  window.addEventListener(\"beforeunload\", handleBeforeUnload);\r\n  document.addEventListener(\"visibilitychange\", handleVisibilityChange);\r\n  window.addEventListener(\"pagehide\", handlePageHide);\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\auth\\signupWithCode.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'supabase' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":18},{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":28,"column":9,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":28,"endColumn":39},{"ruleId":"no-lonely-if","severity":1,"message":"Unexpected if as the only statement in an else block.","line":284,"column":9,"nodeType":"IfStatement","messageId":"unexpectedLonelyIf","endLine":296,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from \"../config/config.js\";\r\nimport showMessage from \"../components/toast.js\";\r\nimport { validateAndSanitizeForm } from \"../utils/validation.js\";\r\nimport { renderPrivacyNotice } from \"../utils/privacyContent.js\";\r\n\r\n// Add spinner animation if not present\r\nif (!document.getElementById(\"spinner-animation\")) {\r\n  const style = document.createElement(\"style\");\r\n  style.id = \"spinner-animation\";\r\n  style.textContent = \"@keyframes spin{to{transform:rotate(360deg)}}\";\r\n  document.head.appendChild(style);\r\n}\r\n\r\n// Get signup code from URL parameters\r\nconst urlParams = new URLSearchParams(window.location.search);\r\nlet signupCode = urlParams.get(\"code\");\r\n\r\n// Form persistence logic\r\nconst FORM_STORAGE_KEY = \"cl_signup_form_data\";\r\n\r\n// Try to recover signup code from storage if missing\r\nif (!signupCode) {\r\n  try {\r\n    const savedData = localStorage.getItem(FORM_STORAGE_KEY);\r\n    if (savedData) {\r\n      const parsed = JSON.parse(savedData);\r\n      if (parsed.signupCode) {\r\n        signupCode = parsed.signupCode;\r\n        console.log(\"Restored signup code from storage:\", signupCode);\r\n\r\n        // Update URL to reflect code\r\n        const newUrl = new URL(window.location.href);\r\n        newUrl.searchParams.set(\"code\", signupCode);\r\n        window.history.replaceState({}, \"\", newUrl);\r\n      }\r\n    }\r\n  } catch (e) {\r\n    console.warn(\"Failed to recover signup code:\", e);\r\n  }\r\n}\r\n\r\n// Pre-fill the signup code if provided in URL or recovered\r\nif (signupCode) {\r\n  const codeInput = document.getElementById(\"signupCode\");\r\n  if (codeInput) {\r\n    codeInput.value = signupCode;\r\n  }\r\n}\r\n\r\n// OAuth signup function\r\nasync function signupWithOAuth(provider) {\r\n  try {\r\n    const { supabase } = await import(\"../config/config.js\");\r\n    // Get OAuth URL with signup code in state parameter\r\n    const options = {\r\n      redirectTo: `${window.location.origin}/complete-position-signup?code=${signupCode}`,\r\n      queryParams: {\r\n        access_type: \"offline\",\r\n        prompt: \"consent\",\r\n      }\r\n    };\r\n\r\n    // Set valid scopes for Facebook (avoid invalid user_mobile_phone scope)\r\n    if (provider === \"facebook\") {\r\n      options.scopes = \"email public_profile\";\r\n    }\r\n\r\n    const { data, error } = await supabase.auth.signInWithOAuth({\r\n      provider,\r\n      options\r\n    });\r\n    if (error) {\r\n      console.error(\"OAuth error:\", error);\r\n      showMessage(\"error\", `Failed to sign in with ${provider}`);\r\n      return;\r\n    }\r\n    // Redirect to OAuth provider\r\n    window.location.href = data.url;\r\n  } catch (error) {\r\n    console.error(\"OAuth signup error:\", error);\r\n    showMessage(\"error\", `Failed to sign in with ${provider}`);\r\n  }\r\n}\r\n\r\n// Function to initialize signup code validation\r\nfunction initializeSignupCodeValidation() {\r\n  // Check if signup code is provided in URL\r\n  if (!signupCode) {\r\n    showMessage(\"error\", \"No signup code provided in URL\");\r\n    // Disable form if no code\r\n    const form = document.getElementById(\"signup-form\");\r\n    if (form) {\r\n      form.style.opacity = \"0.5\";\r\n      form.style.pointerEvents = \"none\";\r\n    }\r\n  } else {\r\n    // Validate signup code automatically on page load\r\n    validateSignupCode(signupCode);\r\n  }\r\n}\r\n\r\n// Attach OAuth button listeners (no inline handlers for CSP)\r\ndocument.getElementById(\"oauth-google\")?.addEventListener(\"click\", () => signupWithOAuth(\"google\"));\r\ndocument.getElementById(\"oauth-facebook\")?.addEventListener(\"click\", () => signupWithOAuth(\"facebook\"));\r\n\r\nasync function validateSignupCode(code) {\r\n  try {\r\n    const response = await fetch(`/api/hr/validate-signup-code/${code}?t=${Date.now()}`);\r\n    const result = await response.json();\r\n    if (result.valid) {\r\n      showMessage(\"success\", `Valid signup code for ${result.data.role} role`);\r\n    } else {\r\n      // Check if it's an expired code\r\n      if (result.error && result.error.toLowerCase().includes(\"expired\")) {\r\n        showMessage(\"error\", \"This signup code has expired. Please contact HR for a new link.\");\r\n        // Redirect to landing page after 3 seconds\r\n        setTimeout(() => {\r\n          window.location.href = \"/\";\r\n        }, 3000);\r\n      } else {\r\n        showMessage(\"error\", result.error || \"Invalid signup code\");\r\n      }\r\n      // Disable form if code is invalid\r\n      const form = document.getElementById(\"signup-form\");\r\n      if (form) {\r\n        form.style.opacity = \"0.5\";\r\n        form.style.pointerEvents = \"none\";\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Code validation error:\", error);\r\n    showMessage(\"error\", \"Failed to validate signup code\");\r\n  }\r\n}\r\n\r\n// Handle form submission and persistence\r\nfunction setupFormPersistence() {\r\n  const signupForm = document.getElementById(\"signup-form\");\r\n  if (!signupForm) return;\r\n\r\n  // Form persistence logic\r\n  const FORM_STORAGE_KEY = \"cl_signup_form_data\";\r\n\r\n  function saveFormData() {\r\n    const formData = new FormData(signupForm);\r\n    const dataToSave = {};\r\n\r\n    for (const [key, value] of formData.entries()) {\r\n      // Don't save sensitive fields\r\n      // Save signupCode to allow session recovery\r\n      if (key !== \"password\" && key !== \"confirmPassword\" && key !== \"agreedToTerms\") {\r\n        dataToSave[key] = value;\r\n      }\r\n    }\r\n\r\n    try {\r\n      localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(dataToSave));\r\n    } catch (e) {\r\n      console.warn(\"Failed to save form data:\", e);\r\n    }\r\n  }\r\n\r\n  function loadFormData() {\r\n    try {\r\n      const savedData = localStorage.getItem(FORM_STORAGE_KEY);\r\n      console.log(\"Loading form data from storage:\", savedData ? \"Found data\" : \"No data\");\r\n\r\n      if (!savedData) return;\r\n\r\n      const parsedData = JSON.parse(savedData);\r\n\r\n      Object.keys(parsedData).forEach(key => {\r\n        const input = signupForm.querySelector(`[name=\"${key}\"]`);\r\n        if (input) {\r\n          input.value = parsedData[key];\r\n          // Trigger input event to ensure UI updates (like floating labels)\r\n          input.dispatchEvent(new Event(\"input\", { bubbles: true }));\r\n        }\r\n      });\r\n    } catch (e) {\r\n      console.warn(\"Failed to load form data:\", e);\r\n    }\r\n  }\r\n\r\n  function clearFormData() {\r\n    try {\r\n      localStorage.removeItem(FORM_STORAGE_KEY);\r\n    } catch (e) {\r\n      console.warn(\"Failed to clear form data:\", e);\r\n    }\r\n  }\r\n\r\n  // Load saved data on init\r\n  console.log(\"Initializing form persistence...\");\r\n  loadFormData();\r\n\r\n  // Save data on input changes\r\n  signupForm.addEventListener(\"input\", (e) => {\r\n    // Debounce saving if needed, but for now direct save is fine for simple text\r\n    if (e.target.name !== \"password\" && e.target.name !== \"confirmPassword\") {\r\n      saveFormData();\r\n    }\r\n  });\r\n\r\n  signupForm.addEventListener(\"submit\", async (e) => {\r\n    e.preventDefault();\r\n    const formData = new FormData(e.target);\r\n    const data = {\r\n      name: formData.get(\"name\"),\r\n      addressLine1: formData.get(\"addressLine1\") || \"\",\r\n      addressLine2: formData.get(\"addressLine2\") || \"\",\r\n      barangay: formData.get(\"barangay\") || \"\",\r\n      gender: formData.get(\"gender\"),\r\n      email: formData.get(\"email\"),\r\n      mobile: formData.get(\"mobile\"),\r\n      password: formData.get(\"password\"),\r\n      confirmPassword: formData.get(\"confirmPassword\"),\r\n      signupCode: formData.get(\"signupCode\"),\r\n      agreedToTerms: formData.get(\"agreedToTerms\") === \"on\"\r\n    };\r\n\r\n    // Validation rules\r\n    const validationRules = {\r\n      name: { required: true, minLength: 2, maxLength: 100 },\r\n      email: { required: true, type: \"email\" },\r\n      mobile: { required: true, type: \"mobile\" },\r\n      password: { required: true, type: \"password\" }\r\n    };\r\n    const validation = validateAndSanitizeForm(data, validationRules);\r\n    if (!validation.isValid) {\r\n      showMessage(\"error\", validation.errors.join(\", \"));\r\n      return;\r\n    }\r\n\r\n    // Check if ID verification is complete\r\n    let verificationComplete = false;\r\n    try {\r\n      verificationComplete = sessionStorage.getItem(\"cl_verification_complete\") === \"true\";\r\n    } catch (e) {\r\n      console.warn(\"Could not check verification status:\", e);\r\n    }\r\n\r\n    if (!verificationComplete) {\r\n      showMessage(\"error\", \"Please complete ID verification before signing up.\");\r\n      return;\r\n    }\r\n\r\n    // Show loading state\r\n    const submitButton = e.target.querySelector('button[type=\"submit\"]');\r\n    const originalHTML = submitButton.innerHTML;\r\n    submitButton.disabled = true;\r\n    submitButton.innerHTML = '<span class=\"spinner\" style=\"display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:white;border-radius:50%;vertical-align:middle;margin-right:8px;animation:spin 0.8s linear infinite\"></span>Creating Account...';\r\n    try {\r\n      // Submit via API\r\n      const response = await fetch(\"/api/auth/signup-with-code\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          name: validation.sanitizedData.name,\r\n          address: {\r\n            line1: data.addressLine1 || \"\",\r\n            line2: data.addressLine2 || \"\",\r\n            barangay: data.barangay || \"\"\r\n          },\r\n          gender: data.gender || \"\",\r\n          email: validation.sanitizedData.email,\r\n          mobileNumber: `+63${validation.sanitizedData.mobile}`,\r\n          password: data.password,\r\n          confirmPassword: data.confirmPassword,\r\n          signupCode: data.signupCode,\r\n          agreedToTerms: true,\r\n          isOAuth: false\r\n        })\r\n      });\r\n      const result = await response.json();\r\n      if (result.success) {\r\n        showMessage(\"success\", \"Account created successfully! Redirecting to dashboard...\");\r\n        clearFormData(); // Clear saved form data\r\n        setTimeout(() => {\r\n          window.location.href = \"/dashboard\";\r\n        }, 3000);\r\n      } else {\r\n        // Check if it's an expired code\r\n        if (result.error && result.error.toLowerCase().includes(\"expired\")) {\r\n          showMessage(\"error\", \"This signup code has expired. Please contact HR for a new link.\");\r\n          setTimeout(() => {\r\n            window.location.href = \"/\";\r\n          }, 3000);\r\n        } else {\r\n          const errMsg = (result && result.error ? String(result.error) : \"\").toLowerCase();\r\n          if (errMsg.includes(\"already registered\") || errMsg.includes(\"already exists\") || errMsg.includes(\"duplicate\") || errMsg.includes(\"email is used\") || errMsg.includes(\"email taken\") || errMsg.includes(\"email already exist\")) {\r\n            showMessage(\"error\", \"Email already exist\");\r\n          } else {\r\n            showMessage(\"error\", result.error || \"Registration failed\");\r\n          }\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Registration error:\", error);\r\n      showMessage(\"error\", \"Registration failed. Please try again.\");\r\n    } finally {\r\n      // Reset button state\r\n      submitButton.innerHTML = originalHTML;\r\n      submitButton.disabled = false;\r\n    }\r\n  });\r\n}\r\n\r\n// Initialize when DOM is ready\r\nif (document.readyState === \"loading\") {\r\n  document.addEventListener(\"DOMContentLoaded\", () => {\r\n    initializeSignupCodeValidation();\r\n    renderPrivacyNotice(\"#privacyModalContent\", { headingTag: \"h4\" });\r\n    setupFormPersistence();\r\n  });\r\n} else {\r\n  // DOM is already loaded, run immediately\r\n  initializeSignupCodeValidation();\r\n  renderPrivacyNotice(\"#privacyModalContent\", { headingTag: \"h4\" });\r\n  setupFormPersistence();\r\n}\r\n// Code validation removed - no automatic validation on blur\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\complaint\\falseComplaintMarker.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":129,"column":23,"nodeType":"CallExpression","messageId":"unexpected","endLine":131,"endColumn":6}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * False Complaint Marker Component\n * Modal for coordinators to mark complaints as false\n */\nclass FalseComplaintMarker {\n\n  constructor() {\n    this.modal = null;\n    this.complaintId = null;\n    this.onSuccess = null;\n    this.init();\n  }\n  init() {\n    this.createModal();\n    this.attachEventListeners();\n  }\n  createModal() {\n    const modalHTML = `\n      <div id=\"falseComplaintModal\" class=\"modal\" style=\"display: none;\">\n        <div class=\"modal-overlay\"></div>\n        <div class=\"modal-content false-complaint-modal\">\n          <div class=\"modal-header\">\n            <h2>Mark as False Complaint</h2>\n            <button class=\"modal-close\" id=\"closeFalseComplaintModal\">&times;</button>\n          </div>\n          \n          <div class=\"modal-body\">\n            <div class=\"warning-message\">\n              <svg class=\"warning-icon\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                <path fill-rule=\"evenodd\" d=\"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z\" clip-rule=\"evenodd\"/>\n              </svg>\n              <p>This action will mark the complaint as false and cannot be easily undone. Please provide a clear reason.</p>\n            </div>\n\n            <form id=\"falseComplaintForm\">\n              <div class=\"form-group\">\n                <label for=\"falseComplaintReason\">Reason <span class=\"required\">*</span></label>\n                <select id=\"falseComplaintReason\" name=\"reason_type\" required>\n                  <option value=\"\">Select a reason...</option>\n                  <option value=\"duplicate\">Duplicate submission</option>\n                  <option value=\"fake\">Invalid/fake information</option>\n                  <option value=\"spam\">Spam or test complaint</option>\n                  <option value=\"jurisdiction\">Outside jurisdiction</option>\n                  <option value=\"other\">Other (specify below)</option>\n                </select>\n              </div>\n\n              <div class=\"form-group\">\n                <label for=\"falseComplaintDetails\">Additional Details <span class=\"required\">*</span></label>\n                <textarea \n                  id=\"falseComplaintDetails\" \n                  name=\"details\" \n                  rows=\"4\" \n                  placeholder=\"Provide detailed explanation for marking this complaint as false...\"\n                  required\n                  minlength=\"20\"\n                ></textarea>\n                <span class=\"char-count\">0 / 20 minimum characters</span>\n              </div>\n\n              <div class=\"form-actions\">\n                <button type=\"button\" class=\"btn btn-secondary\" id=\"cancelFalseComplaint\">\n                  Cancel\n                </button>\n                <button type=\"submit\" class=\"btn btn-danger\" id=\"submitFalseComplaint\">\n                  Mark as False Complaint\n                </button>\n              </div>\n            </form>\n          </div>\n        </div>\n      </div>\n    `;\n    // Append modal to body\n    const modalContainer = document.createElement(\"div\");\n    modalContainer.innerHTML = modalHTML;\n    document.body.appendChild(modalContainer.firstElementChild);\n    this.modal = document.getElementById(\"falseComplaintModal\");\n  }\n  attachEventListeners() {\n    // Close modal\n    const closeBtn = document.getElementById(\"closeFalseComplaintModal\");\n    const cancelBtn = document.getElementById(\"cancelFalseComplaint\");\n    const overlay = this.modal.querySelector(\".modal-overlay\");\n    closeBtn?.addEventListener(\"click\", () => this.close());\n    cancelBtn?.addEventListener(\"click\", () => this.close());\n    overlay?.addEventListener(\"click\", () => this.close());\n    // Character count\n    const textarea = document.getElementById(\"falseComplaintDetails\");\n    const charCount = this.modal.querySelector(\".char-count\");\n    textarea?.addEventListener(\"input\", (e) => {\n      const {length} = e.target.value;\n      charCount.textContent = `${length} / 20 minimum characters`;\n      charCount.classList.toggle(\"valid\", length >= 20);\n    });\n    // Form submission\n    const form = document.getElementById(\"falseComplaintForm\");\n    form?.addEventListener(\"submit\", (e) => {\n      e.preventDefault();\n      this.handleSubmit();\n    });\n  }\n  open(complaintId, onSuccess) {\n    this.complaintId = complaintId;\n    this.onSuccess = onSuccess;\n    // Reset form\n    document.getElementById(\"falseComplaintForm\")?.reset();\n    const charCount = this.modal.querySelector(\".char-count\");\n    charCount.textContent = \"0 / 20 minimum characters\";\n    charCount.classList.remove(\"valid\");\n    // Show modal\n    this.modal.style.display = \"flex\";\n    document.body.style.overflow = \"hidden\";\n  }\n  close() {\n    this.modal.style.display = \"none\";\n    document.body.style.overflow = \"\";\n    this.complaintId = null;\n    this.onSuccess = null;\n  }\n  async handleSubmit() {\n    const reasonType = document.getElementById(\"falseComplaintReason\").value;\n    const details = document.getElementById(\"falseComplaintDetails\").value;\n    if (!reasonType || !details || details.length < 20) {\n      this.showError(\"Please provide a reason and detailed explanation (minimum 20 characters)\");\n      return;\n    }\n    // Confirmation dialog\n    const confirmed = confirm(\n      'Are you sure you want to mark this complaint as false? This action will change the complaint status to \"rejected_false\".'\n    );\n    if (!confirmed) return;\n    const submitBtn = document.getElementById(\"submitFalseComplaint\");\n    submitBtn.disabled = true;\n    submitBtn.textContent = \"Processing...\";\n    try {\n      const response = await fetch(`/api/complaints/${this.complaintId}/mark-false`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify({\n          reason: `${this.getReasonLabel(reasonType)}: ${details}`\n        })\n      });\n      const result = await response.json();\n      if (!response.ok || !result.success) {\n        throw new Error(result.error || \"Failed to mark complaint as false\");\n      }\n      // Success\n      this.showSuccess(\"Complaint marked as false successfully\");\n      if (this.onSuccess) {\n        this.onSuccess(result.data);\n      }\n      setTimeout(() => {\n        this.close();\n      }, 1500);\n    } catch (error) {\n      console.error(\"Error marking complaint as false:\", error);\n      this.showError(error.message || \"Failed to mark complaint as false\");\n      submitBtn.disabled = false;\n      submitBtn.textContent = \"Mark as False Complaint\";\n    }\n  }\n  getReasonLabel(reasonType) {\n    const labels = {\n      duplicate: \"Duplicate submission\",\n      fake: \"Invalid/fake information\",\n      spam: \"Spam or test complaint\",\n      jurisdiction: \"Outside jurisdiction\",\n      other: \"Other\"\n    };\n    return labels[reasonType] || reasonType;\n  }\n  showSuccess(message) {\n    const notification = this.createNotification(message, \"success\");\n    document.body.appendChild(notification);\n    setTimeout(() => notification.remove(), 3000);\n  }\n  showError(message) {\n    const notification = this.createNotification(message, \"error\");\n    document.body.appendChild(notification);\n    setTimeout(() => notification.remove(), 5000);\n  }\n  createNotification(message, type) {\n    const notification = document.createElement(\"div\");\n    notification.className = `notification notification-${type}`;\n    notification.style.cssText = `\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      padding: 15px 20px;\n      background: ${type === \"success\" ? \"#10b981\" : \"#ef4444\"};\n      color: white;\n      border-radius: 8px;\n      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n      z-index: 10000;\n      animation: slideIn 0.3s ease-out;\n    `;\n    notification.textContent = message;\n    return notification;\n  }\n}\n// Export for use in other modules\nif (typeof module !== \"undefined\" && module.exports) {\n\n  module.exports = FalseComplaintMarker;\n}\n// Initialize on page load\ndocument.addEventListener(\"DOMContentLoaded\", () => {\n  window.falseComplaintMarker = new FalseComplaintMarker();\n});\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\form\\complaintForm.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\form\\complaintFormHierarchical.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\form\\formSubmission.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\header.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'closeNotificationPanel' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":62}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { brandConfig } from \"../config/index.js\";\r\nimport { initializeNotificationButton, closeNotificationPanel } from \"./notification.js\";\r\n\r\n// Header component for easy modification\r\n\r\nexport function createHeader() {\r\n  return `\r\n    <div class=\"header-content\">\r\n      <div class=\"header-left\">\r\n        <button id=\"menu-toggle\" class=\"menu-toggle\" aria-label=\"Toggle sidebar\" title=\"Toggle menu\">\r\n          <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\"></line>\r\n            <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\"></line>\r\n            <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\"></line>\r\n          </svg>\r\n        </button>\r\n        <a href=\"${brandConfig.dashboardUrl}\" class=\"brand-logo\">\r\n          <div class=\"brand-icon\"></div>\r\n          <span class=\"brand-text\">${brandConfig.name}</span>\r\n        </a>\r\n      </div>\r\n\r\n      <div class=\"header-right\">\r\n        <button id=\"theme-toggle\" class=\"header-action theme-toggle\" aria-label=\"Toggle dark mode\" title=\"Toggle theme\">\r\n          <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <circle cx=\"12\" cy=\"12\" r=\"5\"></circle>\r\n            <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\"></line>\r\n            <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\"></line>\r\n            <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\"></line>\r\n            <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\"></line>\r\n            <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\"></line>\r\n            <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\"></line>\r\n            <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\"></line>\r\n            <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\"></line>\r\n          </svg>\r\n        </button>\r\n\r\n        <div class=\"notification-container\">\r\n          <button id=\"notification-btn\" class=\"header-action notification-btn\" title=\"Notifications\">\r\n            <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n              <path d=\"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9\"></path>\r\n              <path d=\"M13.73 21a2 2 0 0 1-3.46 0\"></path>\r\n            </svg>\r\n            <span id=\"notification-badge\" class=\"notification-badge hidden\">0</span>\r\n          </button>\r\n          <div id=\"notification-panel\" class=\"header-dropdown notification-panel\">\r\n            <div class=\"dropdown-header\">\r\n              <h3 class=\"dropdown-title\">Notifications</h3>\r\n              <button id=\"close-notifications\" class=\"dropdown-close\" aria-label=\"Close notifications\">\r\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"></line>\r\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"></line>\r\n                </svg>\r\n              </button>\r\n            </div>\r\n            <div id=\"notification-content\" class=\"dropdown-content\">\r\n              <div class=\"no-notifications\">No notifications yet</div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"profile-container\">\r\n          <button id=\"profile-btn\" class=\"header-action profile-btn\" title=\"Profile\">\r\n            <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n              <path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"></path>\r\n              <circle cx=\"12\" cy=\"7\" r=\"4\"></circle>\r\n            </svg>\r\n          </button>\r\n          <div id=\"profile-panel\" class=\"header-dropdown profile-panel\">\r\n            <div class=\"dropdown-header\">\r\n              <h3 class=\"dropdown-title\">Profile</h3>\r\n            </div>\r\n            <div class=\"dropdown-content\">\r\n              <a href=\"/myProfile\" class=\"dropdown-item\">\r\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n                    <path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"></path>\r\n                    <circle cx=\"12\" cy=\"7\" r=\"4\"></circle>\r\n                  </svg>\r\n                My Profile\r\n              </a>\r\n              <a href=\"/fileComplaint\" class=\"dropdown-item\">\r\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n                  <path d=\"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\"></path>\r\n                  <polyline points=\"14,2 14,8 20,8\"></polyline>\r\n                  <line x1=\"16\" y1=\"13\" x2=\"8\" y2=\"13\"></line>\r\n                  <line x1=\"16\" y1=\"17\" x2=\"8\" y2=\"17\"></line>\r\n                  <polyline points=\"10,9 9,9 8,9\"></polyline>\r\n                </svg>\r\n                File Complaint\r\n              </a>\r\n              <button id=\"logout-btn\" class=\"dropdown-item logout-btn\">\r\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n                    <path d=\"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4\"></path>\r\n                    <polyline points=\"16,17 21,12 16,7\"></polyline>\r\n                    <line x1=\"21\" y1=\"12\" x2=\"9\" y2=\"12\"></line>\r\n                  </svg>\r\n                Logout\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n// Initialize global click handler to close dropdowns\r\nfunction initializeGlobalClickHandler() {\r\n  // console.log removed for security\r\n  document.addEventListener(\"click\", (e) => {\r\n    const notificationPanel = document.getElementById(\"notification-panel\");\r\n    const profilePanel = document.getElementById(\"profile-panel\");\r\n    const notificationBtn = document.getElementById(\"notification-btn\");\r\n    const profileBtn = document.getElementById(\"profile-btn\");\r\n    // Close notification panel if clicking outside\r\n    if (notificationPanel && notificationPanel.classList.contains(\"show\")) {\r\n      if (!notificationPanel.contains(e.target) && !notificationBtn.contains(e.target)) {\r\n        notificationPanel.classList.remove(\"show\");\r\n        notificationPanel.style.opacity = \"0\";\r\n        notificationPanel.style.transform = \"translateY(-10px)\";\r\n        setTimeout(() => {\r\n          notificationPanel.style.display = \"none\";\r\n        }, 300);\r\n      }\r\n    }\r\n    // Close profile panel if clicking outside\r\n    if (profilePanel && profilePanel.classList.contains(\"show\")) {\r\n      if (!profilePanel.contains(e.target) && !profileBtn.contains(e.target)) {\r\n        profilePanel.classList.remove(\"show\");\r\n        profilePanel.style.opacity = \"0\";\r\n        profilePanel.style.transform = \"translateY(-10px)\";\r\n        setTimeout(() => {\r\n          profilePanel.style.display = \"none\";\r\n        }, 300);\r\n      }\r\n    }\r\n  });\r\n}\r\n// Initialize notification button - using imported function from notification.js\r\n// Initialize profile button\r\nfunction initializeProfileButton() {\r\n  // console.log removed for security\r\n  const profileBtn = document.getElementById(\"profile-btn\");\r\n  if (!profileBtn) {\r\n    console.warn(\"[HEADER] Profile button not found\");\r\n    return;\r\n  }\r\n  profileBtn.addEventListener(\"click\", (e) => {\r\n    e.stopPropagation();\r\n    const notificationPanel = document.getElementById(\"notification-panel\");\r\n    if (notificationPanel && notificationPanel.classList.contains(\"show\")) {\r\n      notificationPanel.classList.remove(\"show\");\r\n      notificationPanel.style.opacity = \"0\";\r\n      notificationPanel.style.transform = \"translateY(-10px)\";\r\n      setTimeout(() => { notificationPanel.style.display = \"none\"; }, 300);\r\n    }\r\n    const profilePanel = document.getElementById(\"profile-panel\");\r\n    if (profilePanel.classList.contains(\"show\")) {\r\n      profilePanel.classList.remove(\"show\");\r\n      profilePanel.style.opacity = \"0\";\r\n      profilePanel.style.transform = \"translateY(-10px)\";\r\n      setTimeout(() => { profilePanel.style.display = \"none\"; }, 300);\r\n    } else {\r\n      profilePanel.classList.add(\"show\");\r\n      profilePanel.style.display = \"block\";\r\n      setTimeout(() => {\r\n        profilePanel.style.opacity = \"1\";\r\n        profilePanel.style.transform = \"translateY(0)\";\r\n      }, 10);\r\n    }\r\n  });\r\n}\r\n// Initialize menu toggle\r\nfunction initializeMenuToggle() {\r\n  // console.log removed for security\r\n  const menuToggle = document.getElementById(\"menu-toggle\");\r\n  const sidebar = document.getElementById(\"sidebar\");\r\n  if (menuToggle && sidebar) {\r\n    menuToggle.addEventListener(\"click\", async () => {\r\n      // Import sidebar functions dynamically\r\n      try {\r\n        const { openSidebar, closeSidebar } = await import(\"./sidebar.js\");\r\n        const isOpen = sidebar.classList.contains(\"open\");\r\n        if (isOpen) {\r\n          closeSidebar();\r\n        } else {\r\n          openSidebar();\r\n        }\r\n        menuToggle.classList.toggle(\"active\");\r\n        // Update aria-expanded on menu toggle after a brief delay to ensure state is updated\r\n        setTimeout(() => {\r\n          menuToggle.setAttribute(\"aria-expanded\", sidebar.classList.contains(\"open\") ? \"true\" : \"false\");\r\n        }, 50);\r\n      } catch (error) {\r\n        // Fallback to direct class toggle if import fails\r\n        console.warn(\"Failed to import sidebar functions, using fallback:\", error);\r\n        sidebar.classList.toggle(\"open\");\r\n        menuToggle.classList.toggle(\"active\");\r\n        menuToggle.setAttribute(\"aria-expanded\", sidebar.classList.contains(\"open\") ? \"true\" : \"false\");\r\n      }\r\n    });\r\n    // Set initial aria-expanded state\r\n    menuToggle.setAttribute(\"aria-expanded\", \"false\");\r\n  } else {\r\n    console.warn(\"⚠️ Menu toggle or sidebar not found:\", { menuToggle: Boolean(menuToggle), sidebar: Boolean(sidebar) });\r\n  }\r\n}\r\n// Initialize theme toggle\r\nfunction initializeThemeToggle() {\r\n  // console.log removed for security\r\n  const themeToggleBtn = document.getElementById(\"theme-toggle\");\r\n  if (!themeToggleBtn) {\r\n    console.warn(\"[HEADER] Theme toggle button not found\");\r\n    return;\r\n  }\r\n  // Load saved theme\r\n  const savedTheme = localStorage.getItem(\"theme\") || \"light\";\r\n  applyTheme(savedTheme);\r\n  themeToggleBtn.addEventListener(\"click\", () => {\r\n    const rootElement = document.documentElement;\r\n    const isDark = rootElement.classList.contains(\"dark\");\r\n    const newTheme = isDark ? \"light\" : \"dark\";\r\n    applyTheme(newTheme);\r\n    localStorage.setItem(\"theme\", newTheme);\r\n    // Update button appearance\r\n    themeToggleBtn.title = isDark ? \"Switch to light mode\" : \"Switch to dark mode\";\r\n    themeToggleBtn.textContent = isDark ? \"🌙\" : \"☀️\";\r\n  });\r\n  function applyTheme(theme) {\r\n    const rootElement = document.documentElement;\r\n    if (theme === \"dark\") {\r\n      rootElement.classList.add(\"dark\");\r\n    } else {\r\n      rootElement.classList.remove(\"dark\");\r\n    }\r\n  }\r\n}\r\n// Initialize header scroll behavior\r\nfunction initializeHeaderScroll() {\r\n  // console.log removed for security\r\n  let lastScrollY = window.scrollY;\r\n  window.addEventListener(\"scroll\", () => {\r\n    const currentScrollY = window.scrollY;\r\n    const header = document.querySelector(\".header-content\");\r\n    if (header) {\r\n\r\n      if (currentScrollY > lastScrollY && currentScrollY > 100) {\r\n        // Scrolling down\r\n        header.style.transform = \"translateY(-100%)\";\r\n      } else {\r\n        // Scrolling up\r\n        header.style.transform = \"translateY(0)\";\r\n      }\r\n    }\r\n    lastScrollY = currentScrollY;\r\n  });\r\n}\r\n// Initialize dropdowns\r\nfunction initializeDropdowns() {\r\n  // console.log removed for security\r\n  // Move dropdowns to body to avoid container issues\r\n  const notificationPanel = document.getElementById(\"notification-panel\");\r\n  const profilePanel = document.getElementById(\"profile-panel\");\r\n  if (notificationPanel) {\r\n    notificationPanel.remove();\r\n    document.body.appendChild(notificationPanel);\r\n    // CSS classes will handle the styling now\r\n  }\r\n  if (profilePanel) {\r\n    profilePanel.remove();\r\n    document.body.appendChild(profilePanel);\r\n    // CSS classes will handle the styling now\r\n  }\r\n}\r\n// Initialize header when DOM is loaded\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  // Add a small delay to ensure all elements are ready\r\n  setTimeout(() => {\r\n    // console.log removed for security\r\n    const headerContainer = document.querySelector(\".header-container\");\r\n    const headerElement = document.querySelector(\"#header\");\r\n    // console.log removed for security\r\n    // console.log removed for security\r\n    // Try .header-container first, then fall back to #header\r\n    if (headerContainer) {\r\n      // console.log removed for security\r\n      const headerHTML = createHeader();\r\n      // console.log removed for security\r\n      headerContainer.innerHTML = headerHTML;\r\n    } else if (headerElement) {\r\n      // console.log removed for security\r\n      const headerHTML = createHeader();\r\n      // console.log removed for security\r\n      headerElement.innerHTML = headerHTML;\r\n    } else {\r\n      console.warn(\"[HEADER] No header container or header element found!\");\r\n      // Try to create a header container as a fallback\r\n      const {body} = document;\r\n      if (body) {\r\n        // console.log removed for security\r\n        const fallbackHeader = document.createElement(\"div\");\r\n        fallbackHeader.className = \"header-container\";\r\n        fallbackHeader.style.cssText = \"position: fixed; top: 0; left: 0; right: 0; z-index: 1000;\";\r\n        body.insertBefore(fallbackHeader, body.firstChild);\r\n        const headerHTML = createHeader();\r\n        fallbackHeader.innerHTML = headerHTML;\r\n        // console.log removed for security\r\n      } else {\r\n        console.error(\"[HEADER] Cannot create fallback header - body not found\");\r\n        return;\r\n      }\r\n    }\r\n    // Test if buttons were created\r\n    const _testNotificationBtn = document.getElementById(\"notification-btn\");\r\n    const _testProfileBtn = document.getElementById(\"profile-btn\");\r\n    // console.log removed for security\r\n    // Fix dropdown positioning by ensuring parent containers have relative positioning\r\n    const notificationContainer = document.querySelector(\".notification-container\");\r\n    const profileContainer = document.querySelector(\".profile-container\");\r\n    if (notificationContainer) {\r\n      notificationContainer.style.position = \"relative\";\r\n    }\r\n    if (profileContainer) {\r\n      profileContainer.style.position = \"relative\";\r\n    }\r\n    // Move dashboard clock into header-right to align with buttons (put it first)\r\n    try {\r\n      const headerRight = document.querySelector(\".header-right\");\r\n      const clockEl = document.getElementById(\"dashboard-clock\");\r\n      if (headerRight && clockEl) {\r\n        headerRight.insertBefore(clockEl, headerRight.firstChild);\r\n      }\r\n    } catch (e) {\r\n      console.warn(\"[HEADER] Clock positioning failed:\", e);\r\n    }\r\n    // Add a small delay to ensure DOM is fully updated\r\n    setTimeout(() => {\r\n      initializeNotificationButton();\r\n      initializeProfileButton();\r\n      initializeMenuToggle(); // Initialize menu toggle after header HTML is created\r\n      initializeThemeToggle();\r\n      initializeHeaderScroll();\r\n      initializeDropdowns();\r\n      initializeGlobalClickHandler();\r\n    }, 50);\r\n  }, 100); // Close setTimeout\r\n}); // Close DOMContentLoaded\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\map\\boundaryGenerator.js","messages":[{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":7,"column":36,"nodeType":"CallExpression","messageId":"returnsValue","endLine":7,"endColumn":60,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[281,305],"text":"{setTimeout(resolve, 200)}"},"desc":"Wrap the expression in `{}`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"async function loadBoundaries() {\r\n  try {\r\n    // Wait for map instance to be available with shorter intervals\r\n    const maxAttempts = 50; // Increased attempts\r\n    let attempts = 0;\r\n    while (!window.simpleMap && attempts < maxAttempts) {\r\n      await new Promise(resolve => setTimeout(resolve, 200)); // Increased delay to 200ms\r\n      attempts++;\r\n    }\r\n    const M = window.simpleMap;\r\n    if (!M) {\r\n      console.warn(\"[BOUNDARY] Map not available yet, skipping boundary loading\");\r\n      return; // Don't throw error, just skip if map isn't ready\r\n    }\r\n    // Fetch boundaries data\r\n    const response = await fetch(\"/api/boundaries\");\r\n    if (!response.ok) {\r\n      throw new Error(`HTTP error! status: ${response.status}`);\r\n    }\r\n    const brgyData = await response.json();\r\n    // Check if brgyData is an array\r\n    if (!Array.isArray(brgyData)) {\r\n      throw new Error(\"Boundary data is not in correct format\");\r\n    }\r\n    // Store boundaries globally for boundary checking\r\n    window.cityBoundaries = brgyData;\r\n\r\n    // Add each barangay boundary to the map\r\n    brgyData.forEach((barangay) => {\r\n      const geojsonLayer = L.geoJSON(barangay.geojson, {\r\n        style: {\r\n          color: \"#3388ff\",\r\n          weight: 2,\r\n          opacity: 1,\r\n          fillOpacity: 0, // Slight fill for better visibility\r\n        },\r\n      });\r\n      geojsonLayer.addTo(M);\r\n    });\r\n    // Don't auto-fit bounds - let the heatmap control the view\r\n    // const bounds = L.geoJSON(brgyData.map(b => b.geojson)).getBounds();\r\n    // M.fitBounds(bounds, { padding: [20, 20] }); // Add padding for better view\r\n    // console.log removed for security\r\n  } catch (err) {\r\n    console.error(\"Error loading boundaries:\", err.message);\r\n    console.error(\"Stack:\", err.stack);\r\n  }\r\n}\r\n// Initialize boundaries when DOM is ready\r\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\r\n  try {\r\n    // Load boundaries immediately - no delay\r\n    await loadBoundaries();\r\n\r\n    // If heatmap visualization exists, reload data to apply boundary filtering\r\n    if (window.heatmapViz && typeof window.heatmapViz.loadComplaintData === \"function\") {\r\n      console.log(\"[BOUNDARY] Boundaries loaded, reloading heatmap data with boundary filter\");\r\n      const currentFilters = window.heatmapViz.currentFilters || {};\r\n      await window.heatmapViz.loadComplaintData(currentFilters);\r\n\r\n      // Recreate heatmap and markers with filtered data\r\n      if (window.heatmapViz.heatmapLayer) {\r\n        window.heatmapViz.hideHeatmap();\r\n      }\r\n      window.heatmapViz.createHeatmapLayer();\r\n      window.heatmapViz.showHeatmap();\r\n\r\n      if (window.heatmapViz.markerLayer) {\r\n        window.heatmapViz.hideMarkers();\r\n      }\r\n      window.heatmapViz.createMarkerLayer();\r\n      window.heatmapViz.showMarkers();\r\n\r\n      // Update statistics if function exists\r\n      if (typeof window.updateStatistics === \"function\") {\r\n        window.updateStatistics();\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Failed to load boundaries:\", error);\r\n  }\r\n});\r\n/**\r\n * Create an inverted city boundary mask that fills everything OUTSIDE the city\r\n * @param {L.Map} map - Leaflet map instance\r\n * @param {Array} brgyData - Array of barangay data\r\n */\r\nasync function _addCityBoundary(map, brgyData) {\r\n  try {\r\n    // console.log removed for security\r\n    // Create a feature collection from all barangay geojson\r\n    const allFeatures = brgyData.map(barangay => barangay.geojson);\r\n    // Calculate the convex hull (outer boundary) of all barangays\r\n    const cityBoundary = calculateConvexHull(allFeatures);\r\n    if (cityBoundary) {\r\n      // Create a world rectangle that covers the entire map\r\n      const _worldBounds = L.latLngBounds([-90, -180], [90, 180]);\r\n      const worldRectangle = {\r\n        type: \"Feature\",\r\n        properties: { name: \"World\" },\r\n        geometry: {\r\n          type: \"Polygon\",\r\n          coordinates: [[\r\n            [-180, -90], [-180, 90], [180, 90], [180, -90], [-180, -90]\r\n          ]]\r\n        }\r\n      };\r\n      // Create the inverted mask using a \"donut\" polygon\r\n      const invertedMask = {\r\n        type: \"Feature\",\r\n        properties: { name: \"Digos City Inverted Mask\" },\r\n        geometry: {\r\n          type: \"Polygon\",\r\n          coordinates: [\r\n            worldRectangle.geometry.coordinates[0], // Outer ring (world)\r\n            cityBoundary.geometry.coordinates[0]    // Inner ring (city boundary - creates the \"hole\")\r\n          ]\r\n        }\r\n      };\r\n      // Create the inverted mask layer\r\n      const maskLayer = L.geoJSON(invertedMask, {\r\n        style: {\r\n          color: \"transparent\",     // No border\r\n          weight: 0,\r\n          opacity: 0,\r\n          fillOpacity: 0.3,         // Semi-transparent fill\r\n          fillColor: \"#000000\"      // Black mask\r\n        },\r\n        onEachFeature(feature, layer) {\r\n          layer.bindPopup(`\r\n            <div>\r\n              <h4>🏙️ Digos City Area</h4>\r\n              <p>Highlighted area shows the city limits</p>\r\n            </div>\r\n          `);\r\n        }\r\n      });\r\n      // Add inverted mask to map\r\n      maskLayer.addTo(map);\r\n      // console.log removed for security\r\n    }\r\n  } catch (error) {\r\n    console.error(\"❌ Error creating inverted city boundary:\", error);\r\n  }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\map\\complaintLocationPicker.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\map\\complaintMap.js","messages":[],"suppressedMessages":[{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":120,"column":18,"nodeType":"Literal","endLine":120,"endColumn":47,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\map\\dbscan.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\map\\heatmapController.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":163,"column":44,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":163,"endColumn":45},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":163,"column":58,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":163,"endColumn":59},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":164,"column":39,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":164,"endColumn":40},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":164,"column":53,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":164,"endColumn":54}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Heatmap Controller - Main controller for complaint heatmap functionality\n * Integrates map, visualization, and controls\n */\nclass HeatmapController {\n  constructor() {\n    this.map = null;\n    this.heatmapViz = null;\n    this.controls = null;\n    this.isInitialized = false;\n    this.zoomThreshold = 14; // Show markers only when zoomed in\n  }\n  /**\n   * Initialize the heatmap controller\n   * @param {string} mapContainerId - ID of the map container element\n   */\n  async initialize(mapContainerId = \"map\") {\n    try {\n      // console.log removed for security\n      // Initialize map\n      this.map = await initializeSimpleMap(mapContainerId, {\n        center: [6.7492, 125.3571], // Digos City, Philippines\n        zoom: 12,\n      });\n      if (!this.map) {\n        throw new Error(\"Failed to initialize map\");\n      }\n      // Initialize heatmap visualization\n      this.heatmapViz = new HeatmapVisualization(this.map);\n      // Initialize controls (skip if enhanced controls exist on the page)\n      const existingControls = document.getElementById(\"heatmap-controls\");\n      const hasEnhancedControls =\n        existingControls &&\n        existingControls.classList.contains(\"enhanced-controls\");\n      if (!hasEnhancedControls && !window.enhancedHeatmapController) {\n        this.controls = new HeatmapControls(this);\n      } else {\n        // Use existing enhanced controls panel; do not create legacy controls\n        this.controls = null;\n      }\n      // Load initial data\n      await this.loadData();\n      // Set up event listeners\n      this.setupEventListeners();\n      this.isInitialized = true;\n      // console.log removed for security\n    } catch (error) {\n      console.error(\"[HEATMAP-CONTROLLER] Initialization failed:\", error);\n      throw error;\n    }\n  }\n  /**\n   * Load complaint data with current filters\n   */\n  async loadData() {\n    try {\n      const filters = this.controls ? this.controls.getCurrentFilters() : {};\n      await this.heatmapViz.loadComplaintData(filters);\n      this.refreshVisualization();\n    } catch (error) {\n      console.error(\"[HEATMAP-CONTROLLER] Failed to load data:\", error);\n      this.showError(\"Failed to load complaint data\");\n    }\n  }\n  /**\n   * Refresh the visualization based on current view\n   */\n  refreshVisualization() {\n    if (!this.heatmapViz) return;\n    // Clear all layers first\n    this.heatmapViz.clearAllLayers();\n    // Show heatmap always, markers only when zoomed in\n    this.heatmapViz.createHeatmapLayer();\n    this.heatmapViz.showHeatmap();\n    const zoom = this.map ? this.map.getZoom() : 0;\n    if (zoom >= this.zoomThreshold) {\n      this.heatmapViz.createMarkerLayer();\n      this.heatmapViz.showMarkers();\n    }\n    // Update statistics\n    this.updateStatistics();\n  }\n  /**\n   * Toggle clustering on/off\n   * @param {boolean} enabled - Whether clustering should be enabled\n   */\n  toggleClustering(enabled) {\n    if (this.heatmapViz) {\n      this.heatmapViz.toggleClustering(enabled);\n      this.updateStatistics();\n    }\n  }\n  /**\n   * Update clustering parameters\n   * @param {number} eps - Epsilon parameter\n   * @param {number} minPts - Minimum points parameter\n   */\n  updateClusteringParameters(eps, minPts) {\n    if (this.heatmapViz) {\n      this.heatmapViz.updateClusteringParameters(eps, minPts);\n      this.updateStatistics();\n    }\n  }\n  /**\n   * Apply filters and reload data\n   * @param {Object} filters - Filter options\n   */\n  async applyFilters(filters) {\n    try {\n      await this.heatmapViz.loadComplaintData(filters);\n      this.refreshVisualization();\n    } catch (error) {\n      console.error(\"[HEATMAP-CONTROLLER] Failed to apply filters:\", error);\n      this.showError(\"Failed to apply filters\");\n    }\n  }\n  /**\n   * Update statistics display\n   */\n  updateStatistics() {\n    if (!this.heatmapViz || !this.controls) return;\n    const stats = {\n      totalComplaints: this.heatmapViz.complaintData.length,\n      clusteringStats: this.heatmapViz.getClusteringStatistics(),\n    };\n    this.controls.updateStatistics(stats);\n  }\n  /**\n   * Show error message\n   * @param {string} message - Error message\n   */\n  showError(message) {\n    if (this.controls) {\n      this.controls.showError(message);\n    } else {\n      console.error(\"[HEATMAP-CONTROLLER] Error:\", message);\n    }\n  }\n  /**\n   * Set up event listeners\n   */\n  setupEventListeners() {\n    // Map events\n    if (this.map) {\n      this.map.on(\"zoomend\", () => {\n        this.updateHeatmapIntensity();\n        this.updateViewBasedOnZoom();\n      });\n      this.map.on(\"zoomstart\", () => {\n        this.handleZoomStart();\n      });\n    }\n  }\n  /**\n   * Update heatmap intensity based on zoom level\n   */\n  updateHeatmapIntensity() {\n    if (!this.heatmapViz || !this.map) return;\n    const zoom = this.map.getZoom();\n    const baseRadius = 25;\n    const baseBlur = 15;\n    // Scale down when zoomed out, scale up when zoomed in\n    const radius = Math.max(10, baseRadius - (zoom - 10) * 2);\n    const blur = Math.max(5, baseBlur - (zoom - 10) * 1.5);\n    this.heatmapViz.heatmapConfig.radius = radius;\n    this.heatmapViz.heatmapConfig.blur = blur;\n    // Refresh heatmap\n    this.heatmapViz.hideHeatmap();\n    this.heatmapViz.createHeatmapLayer();\n    this.heatmapViz.showHeatmap();\n  }\n  /**\n   * Handle zoom start event\n   */\n  handleZoomStart() {\n    // Store current state before zoom changes\n    this.preZoomView =\n      this.map.getZoom() >= this.zoomThreshold ? \"markers\" : \"heatmap\";\n  }\n  /**\n   * Update view based on zoom level\n   */\n  updateViewBasedOnZoom() {\n    if (!this.map || !this.heatmapViz) return;\n    const zoom = this.map.getZoom();\n    // console.log removed for security\n    if (zoom >= this.zoomThreshold) {\n      // Zoomed in - show markers\n      // console.log removed for security\n      this.heatmapViz.createMarkerLayer();\n      this.heatmapViz.showMarkers();\n      this.showZoomNotification(\"📍 Markers visible (zoomed in)\");\n    } else {\n      // Zoomed out - hide markers, show only heatmap\n      // console.log removed for security\n      this.heatmapViz.hideMarkers();\n      this.showZoomNotification(\"🗺️ Heatmap only (zoomed out)\");\n    }\n  }\n  /**\n   * Show zoom notification\n   */\n  showZoomNotification(message) {\n    // Create or update notification element\n    let notification = document.getElementById(\"zoom-notification\");\n    if (!notification) {\n      notification = document.createElement(\"div\");\n      notification.id = \"zoom-notification\";\n      notification.className = \"zoom-notification\";\n      // Insert after the map container\n      const mapContainer = document.getElementById(\"map\");\n      if (mapContainer && mapContainer.parentNode) {\n        mapContainer.parentNode.appendChild(notification);\n      }\n    }\n    notification.textContent = message;\n    notification.style.display = \"block\";\n    // Auto-hide after 2 seconds\n    setTimeout(() => {\n      if (notification) {\n        notification.style.display = \"none\";\n      }\n    }, 2000);\n  }\n  /**\n   * Get current map bounds\n   * @returns {L.LatLngBounds} Current map bounds\n   */\n  getMapBounds() {\n    return this.map ? this.map.getBounds() : null;\n  }\n  /**\n   * Fit map to show all complaints\n   */\n  fitToComplaints() {\n    if (\n      !this.heatmapViz ||\n      !this.map ||\n      this.heatmapViz.complaintData.length === 0\n    ) {\n      return;\n    }\n    const group = new L.featureGroup();\n    this.heatmapViz.complaintData.forEach((complaint) => {\n      group.addLayer(L.marker([complaint.lat, complaint.lng]));\n    });\n    this.map.fitBounds(group.getBounds().pad(0.1));\n  }\n  /**\n   * Export current view as image\n   * @returns {Promise<string>} Data URL of the exported image\n   */\n  async exportMap() {\n    if (!this.map) return null;\n    return new Promise((resolve) => {\n      // Use leaflet-image plugin if available, otherwise fallback\n      if (typeof L.Util.extend === \"function\" && this.map.getContainer) {\n        // Simple canvas export (basic implementation)\n        const canvas = document.createElement(\"canvas\");\n        const ctx = canvas.getContext(\"2d\");\n        const container = this.map.getContainer();\n        canvas.width = container.offsetWidth;\n        canvas.height = container.offsetHeight;\n        // This is a basic implementation - in production, use a proper map export library\n        ctx.fillStyle = \"#f0f0f0\";\n        ctx.fillRect(0, 0, canvas.width, canvas.height);\n        ctx.fillStyle = \"#333\";\n        ctx.font = \"16px Arial\";\n        ctx.textAlign = \"center\";\n        ctx.fillText(\"Map Export\", canvas.width / 2, canvas.height / 2);\n        resolve(canvas.toDataURL());\n      } else {\n        resolve(null);\n      }\n    });\n  }\n  /**\n   * Set zoom threshold for marker visibility\n   * @param {number} threshold - Zoom level threshold\n   */\n  setZoomThreshold(threshold) {\n    this.zoomThreshold = threshold;\n    // console.log removed for security\n    // Refresh view to apply new threshold\n    this.refreshVisualization();\n  }\n  /**\n   * Set heatmap intensity\n   * @param {number} intensity - Heatmap intensity multiplier\n   */\n  setHeatmapIntensity(intensity) {\n    if (this.heatmapViz) {\n      this.heatmapViz.heatmapConfig.intensity = intensity;\n      // Refresh heatmap with new intensity\n      this.heatmapViz.hideHeatmap();\n      this.heatmapViz.createHeatmapLayer();\n      this.heatmapViz.showHeatmap();\n    }\n  }\n  /**\n   * Get current state for debugging\n   * @returns {Object} Current state\n   */\n  getState() {\n    return {\n      isInitialized: this.isInitialized,\n      complaintCount: this.heatmapViz\n        ? this.heatmapViz.complaintData.length\n        : 0,\n      clusteringEnabled: this.heatmapViz\n        ? this.heatmapViz.isClusteringEnabled\n        : false,\n      mapCenter: this.map ? this.map.getCenter() : null,\n      mapZoom: this.map ? this.map.getZoom() : null,\n      zoomThreshold: this.zoomThreshold,\n    };\n  }\n}\n// Export for use in other modules\nif (typeof module !== \"undefined\" && module.exports) {\n  module.exports = HeatmapController;\n} else {\n  window.HeatmapController = HeatmapController;\n}\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\map\\heatmapControls.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":452,"column":54,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":452,"endColumn":55},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":452,"column":69,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":452,"endColumn":70},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":455,"column":44,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":455,"endColumn":45},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":455,"column":63,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":455,"endColumn":64},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":459,"column":44,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":459,"endColumn":45},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":459,"column":64,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":459,"endColumn":65},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":463,"column":44,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":463,"endColumn":45},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":463,"column":64,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":463,"endColumn":65}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Heatmap Controls - UI controls for heatmap functionality\r\n * Handles filters, clustering parameters, and view switching\r\n */\r\nclass HeatmapControls {\r\n  constructor(controller) {\r\n    this.controller = controller;\r\n    this.currentFilters = {\r\n      status: \"\",\r\n      category: \"\",\r\n      subcategory: \"\",\r\n      department: \"\",\r\n      timeRange: \"\",\r\n      startDate: \"\",\r\n      endDate: \"\",\r\n      includeResolved: true,\r\n    };\r\n    this.clusteringParams = {\r\n      eps: 0.01,\r\n      minPts: 3,\r\n    };\r\n    this.isVisible = true;\r\n    this.userRole = null;\r\n    this.userDepartmentCode = null;\r\n    this.isDepartmentLocked = false;\r\n    this.loadDepartmentsPromise = null;\r\n    this.loadCategoriesPromise = null;\r\n    this.createControls();\r\n    this.initializeUserContext();\r\n  }\r\n  /**\r\n   * Create the controls UI\r\n   */\r\n  createControls() {\r\n    const controlsContainer = document.createElement(\"div\");\r\n    controlsContainer.id = \"heatmap-controls\";\r\n    controlsContainer.className = \"map-controls\";\r\n    controlsContainer.innerHTML = this.getControlsHTML();\r\n    // Insert after the map container\r\n    const mapContainer = document.getElementById(\"map\");\r\n    if (mapContainer && mapContainer.parentNode) {\r\n      mapContainer.parentNode.insertBefore(\r\n        controlsContainer,\r\n        mapContainer.nextSibling\r\n      );\r\n    }\r\n    this.setupEventListeners();\r\n    this.loadCategoriesPromise = this.loadCategories();\r\n    this.loadDepartmentsPromise = this.loadDepartments();\r\n  }\r\n  /**\r\n   * Get HTML for controls\r\n   * @returns {string} HTML content\r\n   */\r\n  getControlsHTML() {\r\n    return `\r\n      <div class=\"control-section\">\r\n        <h3>🗺️ Heatmap Controls</h3>\r\n\r\n        <!-- Filters -->\r\n        <div class=\"control-group\">\r\n          <label>Status Filter:</label>\r\n          <select id=\"status-filter\">\r\n            <option value=\"\">All Statuses</option>\r\n            <optgroup label=\"Standard Status\">\r\n              <option value=\"new\">New</option>\r\n              <option value=\"pending\">Pending</option>\r\n              <option value=\"in progress\">In Progress</option>\r\n              <option value=\"resolved\">Resolved</option>\r\n              <option value=\"completed\">Completed</option>\r\n              <option value=\"closed\">Closed</option>\r\n              <option value=\"rejected\">Rejected</option>\r\n              <option value=\"cancelled\">Cancelled</option>\r\n            </optgroup>\r\n            <optgroup label=\"Workflow Status\">\r\n              <option value=\"new\">New</option>\r\n              <option value=\"assigned\">Assigned</option>\r\n              <option value=\"in_progress\">In Progress (Workflow)</option>\r\n              <option value=\"pending_approval\">Pending Approval</option>\r\n            </optgroup>\r\n            <optgroup label=\"Confirmation Status\">\r\n              <option value=\"waiting_for_responders\">Waiting for Responders</option>\r\n              <option value=\"waiting_for_complainant\">Waiting for Complainant</option>\r\n              <option value=\"confirmed\">Confirmed</option>\r\n              <option value=\"disputed\">Disputed</option>\r\n            </optgroup>\r\n          </select>\r\n        </div>\r\n\r\n        <div class=\"control-group\">\r\n          <label>Category Filter:</label>\r\n          <select id=\"category-filter\">\r\n            <option value=\"\">All Categories</option>\r\n            <div id=\"category-options-loading\">Loading categories...</div>\r\n          </select>\r\n        </div>\r\n\r\n        <div class=\"control-group\">\r\n          <label>Subcategory Filter:</label>\r\n          <select id=\"subcategory-filter\" disabled>\r\n            <option value=\"\">Select a category first</option>\r\n          </select>\r\n        </div>\r\n\r\n        <div class=\"control-group\" id=\"department-filter-control\">\r\n          <label>Department Filter:</label>\r\n          <select id=\"department-filter\">\r\n            <option value=\"\">All Departments</option>\r\n            <div id=\"department-options-loading\">Loading departments...</div>\r\n          </select>\r\n        </div>\r\n\r\n        <div class=\"control-group\">\r\n          <label>Time Range:</label>\r\n          <select id=\"time-range-filter\">\r\n            <option value=\"\">All Time</option>\r\n            <option value=\"today\">Today</option>\r\n            <option value=\"yesterday\">Yesterday</option>\r\n            <option value=\"last7days\">Last 7 Days</option>\r\n            <option value=\"last30days\">Last 30 Days</option>\r\n            <option value=\"last90days\">Last 90 Days</option>\r\n            <option value=\"custom\">Custom Range</option>\r\n          </select>\r\n        </div>\r\n\r\n        <div class=\"control-group\" id=\"custom-date-range\" style=\"display: none;\">\r\n          <label>Custom Date Range:</label>\r\n          <input type=\"date\" id=\"start-date\" placeholder=\"Start Date\">\r\n          <input type=\"date\" id=\"end-date\" placeholder=\"End Date\">\r\n        </div>\r\n\r\n        <div class=\"control-group\">\r\n          <label>\r\n            <input type=\"checkbox\" id=\"include-resolved\" checked>\r\n            Include Resolved Complaints\r\n          </label>\r\n        </div>\r\n\r\n        <!-- Clustering Controls -->\r\n        <div class=\"control-group clustering-controls\">\r\n          <label>Clustering:</label>\r\n          <div class=\"clustering-toggle\">\r\n            <label>\r\n              <input type=\"checkbox\" id=\"enable-clustering\">\r\n              Enable DBSCAN Clustering\r\n            </label>\r\n          </div>\r\n\r\n          <div class=\"clustering-params\" id=\"clustering-params\" style=\"display: none;\">\r\n            <label>Epsilon (km):</label>\r\n            <input type=\"range\" id=\"eps-slider\" min=\"0.005\" max=\"0.05\" step=\"0.005\" value=\"0.01\">\r\n            <span id=\"eps-value\">0.01</span>\r\n\r\n            <label>Min Points:</label>\r\n            <input type=\"range\" id=\"minpts-slider\" min=\"2\" max=\"10\" step=\"1\" value=\"3\">\r\n            <span id=\"minpts-value\">3</span>\r\n\r\n            <button id=\"suggest-params\" class=\"btn-small\">Suggest Parameters</button>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Zoom Controls -->\r\n        <div class=\"control-group\">\r\n          <label>Zoom Threshold:</label>\r\n          <input type=\"range\" id=\"zoom-threshold\" min=\"10\" max=\"18\" step=\"1\" value=\"14\">\r\n          <span id=\"zoom-threshold-value\">14</span>\r\n          <small>Show markers at this zoom level</small>\r\n        </div>\r\n\r\n        <!-- Heatmap Intensity -->\r\n        <div class=\"control-group\">\r\n          <label>Heatmap Intensity:</label>\r\n          <input type=\"range\" id=\"heatmap-intensity\" min=\"0.1\" max=\"2.0\" step=\"0.1\" value=\"1.0\">\r\n          <span id=\"heatmap-intensity-value\">1.0</span>\r\n          <small>Adjust heatmap visibility</small>\r\n        </div>\r\n\r\n        <!-- Action Buttons -->\r\n        <div class=\"control-group\">\r\n          <button id=\"apply-filters\" class=\"btn-primary\">Apply Filters</button>\r\n          <button id=\"reset-filters\" class=\"btn-secondary\">Reset</button>\r\n          <button id=\"fit-to-complaints\" class=\"btn-secondary\">Fit to Complaints</button>\r\n        </div>\r\n\r\n        <!-- Statistics -->\r\n        <div class=\"control-group stats-section\">\r\n          <h4>Statistics</h4>\r\n          <div id=\"stats-display\">\r\n            <p>Total Complaints: <span id=\"total-complaints\">0</span></p>\r\n            <p>Clusters: <span id=\"cluster-count\">0</span></p>\r\n            <p>Noise Points: <span id=\"noise-count\">0</span></p>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Error Display -->\r\n        <div id=\"error-display\" class=\"error\" style=\"display: none;\"></div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Initialize user role context for role-based UI adjustments\r\n   */\r\n  async initializeUserContext() {\r\n    try {\r\n      const { getUserRole } = await import(\"../../auth/authChecker.js\");\r\n      this.userRole = await getUserRole();\r\n    } catch (error) {\r\n      console.warn(\"[HEATMAP_CONTROLS] Failed to determine user role:\", error);\r\n    }\r\n\r\n    if (this.userRole === \"lgu-admin\") {\r\n      try {\r\n        this.userDepartmentCode = (await this.getUserDepartment()) || null;\r\n      } catch (error) {\r\n        console.warn(\r\n          \"[HEATMAP_CONTROLS] Unable to load user department:\",\r\n          error\r\n        );\r\n      }\r\n\r\n      if (this.userDepartmentCode) {\r\n        try {\r\n          await this.loadDepartmentsPromise;\r\n        } catch (_) {\r\n          // Ignore loading errors here; we still lock the UI\r\n        }\r\n        this.lockDepartmentFilterToUserOffice();\r\n        this.currentFilters.department = this.userDepartmentCode;\r\n        this.applyFilters();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Hide department filter and show notice for LGU admins\r\n   */\r\n  lockDepartmentFilterToUserOffice() {\r\n    this.isDepartmentLocked = true;\r\n    const deptSelect = document.getElementById(\"department-filter\");\r\n    if (deptSelect) {\r\n      deptSelect.value = this.userDepartmentCode || \"\";\r\n      deptSelect.disabled = true;\r\n    }\r\n\r\n    const deptGroup = document.getElementById(\"department-filter-control\");\r\n    if (deptGroup) {\r\n      deptGroup.style.display = \"none\";\r\n    }\r\n\r\n    let notice = document.getElementById(\"department-locked-notice\");\r\n    if (!notice) {\r\n      notice = document.createElement(\"div\");\r\n      notice.id = \"department-locked-notice\";\r\n      notice.className = \"control-group department-locked-notice\";\r\n      notice.innerHTML = `\r\n        <label>Office Scope:</label>\r\n        <p style=\"margin: 0; font-size: 12px; color: #374151;\">\r\n          Complaints are limited to your assigned office\r\n          <strong class=\"locked-office-code\">${this.userDepartmentCode}</strong>.\r\n        </p>\r\n      `;\r\n      const controls = document.querySelector(\r\n        \"#heatmap-controls .control-section\"\r\n      );\r\n      if (controls && deptGroup && deptGroup.parentNode) {\r\n        deptGroup.parentNode.insertBefore(notice, deptGroup.nextSibling);\r\n      } else if (controls) {\r\n        controls.appendChild(notice);\r\n      }\r\n    } else {\r\n      const codeSpan = notice.querySelector(\".locked-office-code\");\r\n      if (codeSpan) {\r\n        codeSpan.textContent = this.userDepartmentCode;\r\n      }\r\n    }\r\n  }\r\n  /**\r\n   * Set up event listeners\r\n   */\r\n  setupEventListeners() {\r\n    // Filter controls\r\n    document.getElementById(\"apply-filters\")?.addEventListener(\"click\", () => {\r\n      this.applyFilters();\r\n    });\r\n    document.getElementById(\"reset-filters\")?.addEventListener(\"click\", () => {\r\n      this.resetFilters();\r\n    });\r\n    document\r\n      .getElementById(\"fit-to-complaints\")\r\n      ?.addEventListener(\"click\", () => {\r\n        this.controller.fitToComplaints();\r\n      });\r\n    // Clustering controls\r\n    document\r\n      .getElementById(\"enable-clustering\")\r\n      ?.addEventListener(\"change\", (e) => {\r\n        this.toggleClustering(e.target.checked);\r\n      });\r\n    // Auto-switch toggle\r\n    document.getElementById(\"eps-slider\")?.addEventListener(\"input\", (e) => {\r\n      this.updateEpsValue(e.target.value);\r\n    });\r\n    document.getElementById(\"minpts-slider\")?.addEventListener(\"input\", (e) => {\r\n      this.updateMinPtsValue(e.target.value);\r\n    });\r\n    document.getElementById(\"suggest-params\")?.addEventListener(\"click\", () => {\r\n      this.suggestParameters();\r\n    });\r\n    // Real-time updates for sliders\r\n    document.getElementById(\"eps-slider\")?.addEventListener(\"input\", (_e) => {\r\n      this.updateClusteringParams();\r\n    });\r\n    document\r\n      .getElementById(\"minpts-slider\")\r\n      ?.addEventListener(\"input\", (_e) => {\r\n        this.updateClusteringParams();\r\n      });\r\n    // Zoom threshold slider\r\n    document\r\n      .getElementById(\"zoom-threshold\")\r\n      ?.addEventListener(\"input\", (e) => {\r\n        const threshold = parseInt(e.target.value);\r\n        this.updateZoomThresholdValue(threshold);\r\n        this.controller.setZoomThreshold(threshold);\r\n      });\r\n    // Heatmap intensity slider\r\n    document\r\n      .getElementById(\"heatmap-intensity\")\r\n      ?.addEventListener(\"input\", (e) => {\r\n        const intensity = parseFloat(e.target.value);\r\n        this.updateHeatmapIntensityValue(intensity);\r\n        this.controller.setHeatmapIntensity(intensity);\r\n      });\r\n    // Filter change listeners\r\n    document.getElementById(\"status-filter\")?.addEventListener(\"change\", () => {\r\n      this.applyFilters();\r\n    });\r\n    document\r\n      .getElementById(\"category-filter\")\r\n      ?.addEventListener(\"change\", async (e) => {\r\n        const categoryId = e.target.value;\r\n        await this.loadSubcategories(categoryId);\r\n        this.currentFilters.category = categoryId;\r\n        this.currentFilters.subcategory = \"\"; // Reset subcategory when category changes\r\n        this.applyFilters();\r\n      });\r\n    document\r\n      .getElementById(\"subcategory-filter\")\r\n      ?.addEventListener(\"change\", (e) => {\r\n        this.currentFilters.subcategory = e.target.value;\r\n        this.applyFilters();\r\n      });\r\n    document\r\n      .getElementById(\"department-filter\")\r\n      ?.addEventListener(\"change\", () => {\r\n        this.applyFilters();\r\n      });\r\n    document\r\n      .getElementById(\"time-range-filter\")\r\n      ?.addEventListener(\"change\", (e) => {\r\n        const timeRange = e.target.value;\r\n        this.currentFilters.timeRange = timeRange;\r\n        // Show/hide custom date range\r\n        const customDateRange = document.getElementById(\"custom-date-range\");\r\n        if (timeRange === \"custom\") {\r\n          customDateRange.style.display = \"block\";\r\n        } else {\r\n          customDateRange.style.display = \"none\";\r\n          // Set date range based on selection\r\n          this.setDateRangeFromTimeRange(timeRange);\r\n        }\r\n        this.applyFilters();\r\n      });\r\n    document.getElementById(\"start-date\")?.addEventListener(\"change\", () => {\r\n      this.applyFilters();\r\n    });\r\n    document.getElementById(\"end-date\")?.addEventListener(\"change\", () => {\r\n      this.applyFilters();\r\n    });\r\n    document\r\n      .getElementById(\"include-resolved\")\r\n      ?.addEventListener(\"change\", () => {\r\n        this.applyFilters();\r\n      });\r\n  }\r\n  /**\r\n   * Apply current filters\r\n   */\r\n  async applyFilters() {\r\n    const filters = this.getCurrentFilters();\r\n    await this.controller.applyFilters(filters);\r\n  }\r\n  /**\r\n   * Reset all filters\r\n   */\r\n  resetFilters() {\r\n    // Reset form values\r\n    const statusFilter = document.getElementById(\"status-filter\");\r\n    if (statusFilter) statusFilter.value = \"\";\r\n    const typeFilter = document.getElementById(\"type-filter\");\r\n    if (typeFilter) typeFilter.value = \"\";\r\n    const departmentFilter = document.getElementById(\"department-filter\");\r\n    if (departmentFilter) {\r\n      departmentFilter.value = this.isDepartmentLocked\r\n        ? this.userDepartmentCode || \"\"\r\n        : \"\";\r\n    }\r\n    const startDate = document.getElementById(\"start-date\");\r\n    if (startDate) startDate.value = \"\";\r\n    const endDate = document.getElementById(\"end-date\");\r\n    if (endDate) endDate.value = \"\";\r\n    const includeResolved = document.getElementById(\"include-resolved\");\r\n    if (includeResolved) includeResolved.checked = true;\r\n    // Reset clustering\r\n    document.getElementById(\"enable-clustering\").checked = false;\r\n    this.toggleClustering(false);\r\n    // Apply reset filters\r\n    this.currentFilters = {\r\n      status: \"\",\r\n      type: \"\",\r\n      department: this.isDepartmentLocked ? this.userDepartmentCode || \"\" : \"\",\r\n      startDate: \"\",\r\n      endDate: \"\",\r\n      includeResolved: true,\r\n    };\r\n    this.applyFilters();\r\n  }\r\n  /**\r\n   * Set date range based on time range selection\r\n   * @param {string} timeRange - Selected time range\r\n   */\r\n  setDateRangeFromTimeRange(timeRange) {\r\n    const now = new Date();\r\n    const startDateInput = document.getElementById(\"start-date\");\r\n    const endDateInput = document.getElementById(\"end-date\");\r\n    if (!startDateInput || !endDateInput) return;\r\n    const clearDates = () => {\r\n      startDateInput.value = \"\";\r\n      endDateInput.value = \"\";\r\n    };\r\n    if (!timeRange) {\r\n      clearDates();\r\n      return;\r\n    }\r\n    let startDate, endDate;\r\n    switch (timeRange) {\r\n      case \"today\":\r\n        startDate = endDate = now;\r\n        break;\r\n      case \"yesterday\":\r\n        startDate = endDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);\r\n        break;\r\n      case \"last7days\":\r\n        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\r\n        endDate = now;\r\n        break;\r\n      case \"last30days\":\r\n        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\r\n        endDate = now;\r\n        break;\r\n      case \"last90days\":\r\n        startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);\r\n        endDate = now;\r\n        break;\r\n      default:\r\n        clearDates();\r\n        return;\r\n    }\r\n    startDateInput.value = startDate.toISOString().split(\"T\")[0];\r\n    endDateInput.value = endDate.toISOString().split(\"T\")[0];\r\n  }\r\n  /**\r\n   * Get current filter values\r\n   * @returns {Object} Current filters\r\n   */\r\n  getCurrentFilters() {\r\n    const selectedDepartment =\r\n      document.getElementById(\"department-filter\")?.value || \"\";\r\n    const enforcedDepartment = this.isDepartmentLocked\r\n      ? this.userDepartmentCode || \"\"\r\n      : selectedDepartment;\r\n    return {\r\n      status: document.getElementById(\"status-filter\")?.value || \"\",\r\n      category: this.currentFilters.category || \"\",\r\n      subcategory: this.currentFilters.subcategory || \"\",\r\n      department: enforcedDepartment,\r\n      timeRange: this.currentFilters.timeRange || \"\",\r\n      startDate: document.getElementById(\"start-date\")?.value || \"\",\r\n      endDate: document.getElementById(\"end-date\")?.value || \"\",\r\n      includeResolved:\r\n        document.getElementById(\"include-resolved\")?.checked || true,\r\n    };\r\n  }\r\n  /**\r\n   * Toggle clustering on/off\r\n   * @param {boolean} enabled - Whether clustering is enabled\r\n   */\r\n  toggleClustering(enabled) {\r\n    const paramsDiv = document.getElementById(\"clustering-params\");\r\n    if (paramsDiv) {\r\n      paramsDiv.style.display = enabled ? \"block\" : \"none\";\r\n    }\r\n    this.controller.toggleClustering(enabled);\r\n  }\r\n  /**\r\n   * Update epsilon value display\r\n   * @param {string} value - Epsilon value\r\n   */\r\n  updateEpsValue(value) {\r\n    const display = document.getElementById(\"eps-value\");\r\n    if (display) {\r\n      display.textContent = value;\r\n    }\r\n    this.clusteringParams.eps = parseFloat(value);\r\n  }\r\n  /**\r\n   * Update min points value display\r\n   * @param {string} value - Min points value\r\n   */\r\n  updateMinPtsValue(value) {\r\n    const display = document.getElementById(\"minpts-value\");\r\n    if (display) {\r\n      display.textContent = value;\r\n    }\r\n    this.clusteringParams.minPts = parseInt(value);\r\n  }\r\n  /**\r\n   * Update clustering parameters\r\n   */\r\n  updateClusteringParams() {\r\n    const eps = parseFloat(\r\n      document.getElementById(\"eps-slider\")?.value || 0.01\r\n    );\r\n    const minPts = parseInt(\r\n      document.getElementById(\"minpts-slider\")?.value || 3\r\n    );\r\n    this.clusteringParams.eps = eps;\r\n    this.clusteringParams.minPts = minPts;\r\n    this.controller.updateClusteringParameters(eps, minPts);\r\n  }\r\n  /**\r\n   * Suggest optimal clustering parameters\r\n   */\r\n  suggestParameters() {\r\n    if (\r\n      !this.controller.heatmapViz ||\r\n      this.controller.heatmapViz.complaintData.length === 0\r\n    ) {\r\n      this.showError(\"No complaint data available for parameter suggestion\");\r\n      return;\r\n    }\r\n    const points = this.controller.heatmapViz.complaintData.map((c) => ({\r\n      lat: c.lat,\r\n      lng: c.lng,\r\n    }));\r\n    const suggested =\r\n      this.controller.heatmapViz.dbscan.suggestParameters(points);\r\n    // Update sliders\r\n    const epsSlider = document.getElementById(\"eps-slider\");\r\n    const minPtsSlider = document.getElementById(\"minpts-slider\");\r\n    if (epsSlider) {\r\n      epsSlider.value = suggested.eps;\r\n      this.updateEpsValue(suggested.eps);\r\n    }\r\n    if (minPtsSlider) {\r\n      minPtsSlider.value = suggested.minPts;\r\n      this.updateMinPtsValue(suggested.minPts);\r\n    }\r\n    // Update clustering\r\n    this.updateClusteringParams();\r\n  }\r\n  /**\r\n   * Update zoom threshold value display\r\n   * @param {number} value - Zoom threshold value\r\n   */\r\n  updateZoomThresholdValue(value) {\r\n    const thresholdValue = document.getElementById(\"zoom-threshold-value\");\r\n    if (thresholdValue) {\r\n      thresholdValue.textContent = value;\r\n    }\r\n  }\r\n  /**\r\n   * Update heatmap intensity value display\r\n   * @param {number} value - Heatmap intensity value\r\n   */\r\n  updateHeatmapIntensityValue(value) {\r\n    const intensityValue = document.getElementById(\"heatmap-intensity-value\");\r\n    if (intensityValue) {\r\n      intensityValue.textContent = value.toFixed(1);\r\n    }\r\n  }\r\n  /**\r\n   * Update statistics display\r\n   * @param {Object} stats - Statistics object\r\n   */\r\n  updateStatistics(stats) {\r\n    const totalComplaints = document.getElementById(\"total-complaints\");\r\n    const clusterCount = document.getElementById(\"cluster-count\");\r\n    const noiseCount = document.getElementById(\"noise-count\");\r\n    if (totalComplaints) {\r\n      totalComplaints.textContent = stats.totalComplaints || 0;\r\n    }\r\n    if (stats.clusteringStats) {\r\n      if (clusterCount) {\r\n        clusterCount.textContent = stats.clusteringStats.numClusters || 0;\r\n      }\r\n      if (noiseCount) {\r\n        noiseCount.textContent = stats.clusteringStats.numNoise || 0;\r\n      }\r\n    } else {\r\n      if (clusterCount) clusterCount.textContent = \"0\";\r\n      if (noiseCount) noiseCount.textContent = \"0\";\r\n    }\r\n  }\r\n  /**\r\n   * Show error message\r\n   * @param {string} message - Error message\r\n   */\r\n  showError(message) {\r\n    const errorDiv = document.getElementById(\"error-display\");\r\n    if (errorDiv) {\r\n      errorDiv.textContent = message;\r\n      errorDiv.style.display = \"block\";\r\n      // Hide after 5 seconds\r\n      setTimeout(() => {\r\n        errorDiv.style.display = \"none\";\r\n      }, 5000);\r\n    }\r\n  }\r\n  /**\r\n   * Toggle controls visibility\r\n   */\r\n  toggleVisibility() {\r\n    const controls = document.getElementById(\"heatmap-controls\");\r\n    if (controls) {\r\n      this.isVisible = !this.isVisible;\r\n      controls.style.display = this.isVisible ? \"block\" : \"none\";\r\n    }\r\n  }\r\n  /**\r\n   * Load categories dynamically\r\n   */\r\n  async loadCategories() {\r\n    try {\r\n      const apiClientModule = await import(\"../../config/apiClient.js\");\r\n      const apiClient = apiClientModule.default;\r\n      const { data, error } = await apiClient.get(\r\n        \"/api/department-structure/categories\"\r\n      );\r\n      if (error) throw error;\r\n      const categorySelect = document.getElementById(\"category-filter\");\r\n      if (categorySelect) {\r\n        // Remove loading placeholder\r\n        const loadingEl = document.getElementById(\"category-options-loading\");\r\n        if (loadingEl) {\r\n          loadingEl.remove();\r\n        }\r\n        // Add category options\r\n        if (data && data.length > 0) {\r\n          data.forEach((category) => {\r\n            const option = document.createElement(\"option\");\r\n            option.value = category.id;\r\n            option.textContent = `${category.icon} ${category.name}`;\r\n            categorySelect.appendChild(option);\r\n          });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error loading categories for heatmap:\", error);\r\n      const categorySelect = document.getElementById(\"category-filter\");\r\n      if (categorySelect) {\r\n        const loadingEl = document.getElementById(\"category-options-loading\");\r\n        if (loadingEl) {\r\n          loadingEl.innerHTML =\r\n            '<option value=\"\">Error loading categories</option>';\r\n        }\r\n      }\r\n    }\r\n  }\r\n  /**\r\n   * Load subcategories for selected category\r\n   */\r\n  async loadSubcategories(categoryId) {\r\n    const subcategorySelect = document.getElementById(\"subcategory-filter\");\r\n    if (!subcategorySelect) return;\r\n    try {\r\n      if (!categoryId) {\r\n        subcategorySelect.innerHTML =\r\n          '<option value=\"\">Select a category first</option>';\r\n        subcategorySelect.disabled = true;\r\n        return;\r\n      }\r\n      subcategorySelect.innerHTML =\r\n        '<option value=\"\">Loading subcategories...</option>';\r\n      subcategorySelect.disabled = true;\r\n      const apiClientModule = await import(\"../../config/apiClient.js\");\r\n      const apiClient = apiClientModule.default;\r\n      const { data, error } = await apiClient.get(\r\n        `/api/department-structure/categories/${categoryId}/subcategories`\r\n      );\r\n      if (error) throw error;\r\n      subcategorySelect.innerHTML =\r\n        '<option value=\"\">All Subcategories</option>';\r\n      if (data && data.length > 0) {\r\n        data.forEach((subcategory) => {\r\n          const option = document.createElement(\"option\");\r\n          option.value = subcategory.id;\r\n          option.textContent = subcategory.name;\r\n          subcategorySelect.appendChild(option);\r\n        });\r\n        subcategorySelect.disabled = false;\r\n      } else {\r\n        subcategorySelect.innerHTML =\r\n          '<option value=\"\">No subcategories available</option>';\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error loading subcategories:\", error);\r\n      subcategorySelect.innerHTML =\r\n        '<option value=\"\">Error loading subcategories</option>';\r\n    }\r\n  }\r\n  /**\r\n   * Get user's department code\r\n   */\r\n  async getUserDepartment() {\r\n    try {\r\n      const apiClientModule = await import(\"../../config/apiClient.js\");\r\n      const apiClient = apiClientModule.default;\r\n      const response = await apiClient.get(\"/api/user/role-info\");\r\n      if (response.success && response.data) {\r\n        // Try multiple possible field names for department\r\n        const department =\r\n          response.data.department ||\r\n          response.data.dpt ||\r\n          response.data.metadata?.department ||\r\n          response.data.metadata?.dpt ||\r\n          response.data.raw_user_meta_data?.department ||\r\n          response.data.raw_user_meta_data?.dpt;\r\n        if (department) {\r\n          return department.toUpperCase();\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn(\"[HEATMAP_CONTROLS] Failed to get user department:\", error);\r\n    }\r\n    // Fallback: try Supabase session\r\n    try {\r\n      const { supabase } = await import(\"../../config/config.js\");\r\n      const {\r\n        data: { session },\r\n      } = await supabase.auth.getSession();\r\n      const metadata =\r\n        session?.user?.raw_user_meta_data || session?.user?.user_metadata || {};\r\n      const department = metadata.department || metadata.dpt;\r\n      if (department) {\r\n        return department.toUpperCase();\r\n      }\r\n    } catch (error) {\r\n      console.warn(\r\n        \"[HEATMAP_CONTROLS] Failed to get department from session:\",\r\n        error\r\n      );\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Load departments dynamically\r\n   */\r\n  async loadDepartments() {\r\n    try {\r\n      const { getDepartments } = await import(\"../../utils/departmentUtils.js\");\r\n      const departments = await getDepartments();\r\n\r\n      // Get user's department and sort departments to put user's office first\r\n      const userDepartmentCode =\r\n        this.userDepartmentCode || (await this.getUserDepartment());\r\n      if (userDepartmentCode && !this.userDepartmentCode) {\r\n        this.userDepartmentCode = userDepartmentCode;\r\n      }\r\n\r\n      if (userDepartmentCode && departments && departments.length > 0) {\r\n        // Sort: user's department first, then others\r\n        departments.sort((a, b) => {\r\n          const aCode = (a.code || \"\").toUpperCase();\r\n          const bCode = (b.code || \"\").toUpperCase();\r\n          const aIsUserDept = aCode === userDepartmentCode;\r\n          const bIsUserDept = bCode === userDepartmentCode;\r\n\r\n          if (aIsUserDept && !bIsUserDept) return -1;\r\n          if (!aIsUserDept && bIsUserDept) return 1;\r\n          return 0; // Keep original order for non-matching items\r\n        });\r\n      }\r\n\r\n      const departmentSelect = document.getElementById(\"department-filter\");\r\n      if (departmentSelect) {\r\n        // Remove loading placeholder\r\n        const loadingEl = document.getElementById(\"department-options-loading\");\r\n        if (loadingEl) {\r\n          loadingEl.remove();\r\n        }\r\n        // Add department options\r\n        departments.forEach((dept) => {\r\n          const option = document.createElement(\"option\");\r\n          option.value = dept.code;\r\n          const isUserDept =\r\n            userDepartmentCode &&\r\n            (dept.code || \"\").toUpperCase() === userDepartmentCode;\r\n          option.textContent = `${dept.name} (${dept.code})${\r\n            isUserDept ? \" ★\" : \"\"\r\n          }`;\r\n          if (isUserDept) {\r\n            option.style.fontWeight = \"bold\";\r\n          }\r\n          departmentSelect.appendChild(option);\r\n        });\r\n\r\n        if (this.isDepartmentLocked) {\r\n          this.lockDepartmentFilterToUserOffice();\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error loading departments for heatmap:\", error);\r\n      // Fallback to basic options\r\n      const departmentSelect = document.getElementById(\"department-filter\");\r\n      if (departmentSelect) {\r\n        const loadingEl = document.getElementById(\"department-options-loading\");\r\n        if (loadingEl) {\r\n          loadingEl.innerHTML =\r\n            '<option value=\"\">Error loading departments</option>';\r\n        }\r\n      }\r\n    }\r\n  }\r\n  /**\r\n   * Get current state\r\n   * @returns {Object} Current state\r\n   */\r\n  getState() {\r\n    return {\r\n      filters: this.getCurrentFilters(),\r\n      clusteringParams: this.clusteringParams,\r\n      isVisible: this.isVisible,\r\n    };\r\n  }\r\n}\r\n// Export for use in other modules\r\nif (typeof module !== \"undefined\" && module.exports) {\r\n  module.exports = HeatmapControls;\r\n} else {\r\n  window.HeatmapControls = HeatmapControls;\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\map\\heatmapVisualization.js","messages":[{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":13,"column":5,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":13,"endColumn":32},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '>' and '!=='. Use parentheses to clarify the intended order of operations.","line":75,"column":29,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":75,"endColumn":30},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '>' and '!=='. Use parentheses to clarify the intended order of operations.","line":75,"column":35,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":75,"endColumn":38},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '!==' and '>'. Use parentheses to clarify the intended order of operations.","line":75,"column":35,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":75,"endColumn":38},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '!==' and '>'. Use parentheses to clarify the intended order of operations.","line":75,"column":44,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":75,"endColumn":45},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":79,"column":40,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":79,"endColumn":41},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":79,"column":56,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":79,"endColumn":57},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '>' and '!=='. Use parentheses to clarify the intended order of operations.","line":101,"column":31,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":101,"endColumn":32},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '>' and '!=='. Use parentheses to clarify the intended order of operations.","line":101,"column":37,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":101,"endColumn":40},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '!==' and '>'. Use parentheses to clarify the intended order of operations.","line":101,"column":37,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":101,"endColumn":40},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '!==' and '>'. Use parentheses to clarify the intended order of operations.","line":101,"column":46,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":101,"endColumn":47},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":105,"column":42,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":105,"endColumn":43},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":105,"column":58,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":105,"endColumn":59},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":660,"column":25,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":660,"endColumn":26},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":660,"column":41,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":660,"endColumn":42},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":660,"column":41,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":660,"endColumn":42},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":661,"column":31,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":661,"endColumn":32},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '/'. Use parentheses to clarify the intended order of operations.","line":914,"column":43,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":914,"endColumn":44},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '/'. Use parentheses to clarify the intended order of operations.","line":914,"column":65,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":914,"endColumn":66},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":1314,"column":26,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":1314,"endColumn":27},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":1314,"column":34,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":1314,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":21,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Heatmap Visualization Component for Complaint Locations\r\n * Integrates with Leaflet maps and DBSCAN clustering\r\n */\r\n\r\n// Helper function to check if a point is inside a GeoJSON polygon\r\nfunction isPointInPolygon(lat, lng, geojson) {\r\n  if (!geojson) return false;\r\n\r\n  // Handle case where geojson is already a geometry object\r\n  let geometry = geojson;\r\n  if (geojson.geometry) {\r\n    geometry = geojson.geometry;\r\n  }\r\n\r\n  if (!geometry || !geometry.coordinates) return false;\r\n\r\n  if (geometry.type === \"Polygon\") {\r\n    return isPointInPolygonCoords(lat, lng, geometry.coordinates);\r\n  } else if (geometry.type === \"MultiPolygon\") {\r\n    // MultiPolygon coordinates: [[[ring1], [ring2]], ...] where each outer element is a polygon\r\n    // Check if point is in any of the polygons\r\n    return geometry.coordinates.some((polygon) =>\r\n      isPointInPolygonCoords(lat, lng, polygon)\r\n    );\r\n  }\r\n  return false;\r\n}\r\n\r\n// Ray casting algorithm for point-in-polygon check\r\n// coordinates can be:\r\n// - Polygon: [outerRing, innerRing1, ...] where each ring is [[lng, lat], [lng, lat], ...]\r\n// - MultiPolygon polygon: [[ring1], [ring2], ...] where each ring is [[lng, lat], [lng, lat], ...]\r\nfunction isPointInPolygonCoords(lat, lng, coordinates) {\r\n  if (!coordinates || coordinates.length === 0) return false;\r\n\r\n  // Check if this is a MultiPolygon structure (nested deeper)\r\n  // MultiPolygon coordinates structure: [[[ring1], [ring2]], ...]\r\n  // If coordinates[0][0] is an array of arrays (not just numbers), it's a MultiPolygon polygon\r\n  if (\r\n    Array.isArray(coordinates[0]) &&\r\n    Array.isArray(coordinates[0][0]) &&\r\n    Array.isArray(coordinates[0][0][0])\r\n  ) {\r\n    // This is a MultiPolygon polygon: [[[ring1]], [[ring2]], ...]\r\n    // Each element is a polygon with rings\r\n    return coordinates.some((polygon) =>\r\n      isPointInPolygonCoords(lat, lng, polygon)\r\n    );\r\n  }\r\n\r\n  // Single polygon: coordinates is [outerRing, innerRing1, innerRing2, ...]\r\n  // Each ring is [[lng, lat], [lng, lat], ...]\r\n  const outerRing = coordinates[0];\r\n  if (!outerRing || !Array.isArray(outerRing) || outerRing.length === 0)\r\n    return false;\r\n\r\n  let inside = false;\r\n\r\n  // Ray casting algorithm: cast a horizontal ray from (lat, lng) going right (increasing longitude)\r\n  // GeoJSON coordinates are [longitude, latitude]\r\n  for (let i = 0, j = outerRing.length - 1; i < outerRing.length; j = i++) {\r\n    const lng1 = outerRing[i][0]; // longitude of point i\r\n    const lat1 = outerRing[i][1]; // latitude of point i\r\n    const lng2 = outerRing[j][0]; // longitude of point j\r\n    const lat2 = outerRing[j][1]; // latitude of point j\r\n\r\n    // Skip horizontal edges (they don't contribute to the intersection count)\r\n    if (Math.abs(lat2 - lat1) < 1e-10) continue;\r\n\r\n    // Check if the horizontal ray from (lat, lng) intersects the edge from (lat1, lng1) to (lat2, lng2)\r\n    // The ray intersects if:\r\n    // 1. The point's latitude is between the edge's latitudes (or the edge crosses the point's latitude)\r\n    // 2. The intersection longitude is to the right of the point's longitude\r\n    const latBetween = lat1 > lat !== lat2 > lat;\r\n    if (latBetween) {\r\n      // Calculate the longitude where the edge crosses the point's latitude\r\n      const intersectLng =\r\n        ((lat - lat1) * (lng2 - lng1)) / (lat2 - lat1) + lng1;\r\n      // If the intersection is to the right of the point, count it\r\n      if (lng < intersectLng) {\r\n        inside = !inside;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Check if point is in any inner rings (holes)\r\n  for (let ringIndex = 1; ringIndex < coordinates.length; ringIndex++) {\r\n    const innerRing = coordinates[ringIndex];\r\n    let inHole = false;\r\n\r\n    for (let i = 0, j = innerRing.length - 1; i < innerRing.length; j = i++) {\r\n      const lng1 = innerRing[i][0]; // longitude of point i\r\n      const lat1 = innerRing[i][1]; // latitude of point i\r\n      const lng2 = innerRing[j][0]; // longitude of point j\r\n      const lat2 = innerRing[j][1]; // latitude of point j\r\n\r\n      // Skip horizontal edges\r\n      if (Math.abs(lat2 - lat1) < 1e-10) continue;\r\n\r\n      const latBetween = lat1 > lat !== lat2 > lat;\r\n      if (latBetween) {\r\n        // Calculate the longitude where the edge crosses the point's latitude\r\n        const intersectLng =\r\n          ((lat - lat1) * (lng2 - lng1)) / (lat2 - lat1) + lng1;\r\n        if (lng < intersectLng) {\r\n          inHole = !inHole;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (inHole) {\r\n      inside = false; // Point is in a hole, so it's outside\r\n      break;\r\n    }\r\n  }\r\n\r\n  return inside;\r\n}\r\n\r\n// Check if coordinates are within any barangay boundary\r\nfunction isWithinCityBoundary(lat, lng) {\r\n  if (typeof lat !== \"number\" || typeof lng !== \"number\") return false;\r\n\r\n  // Check if boundaries are loaded\r\n  if (!window.cityBoundaries || !Array.isArray(window.cityBoundaries)) {\r\n    // Fallback to bounding box if boundaries not loaded\r\n    const minLat = 6.6;\r\n    const maxLat = 7.0;\r\n    const minLng = 125.0;\r\n    const maxLng = 125.7;\r\n    return lat >= minLat && lat <= maxLat && lng >= minLng && lng <= maxLng;\r\n  }\r\n\r\n  // Debug: Log boundary structure once\r\n  if (!window._boundaryDebugged && window.cityBoundaries.length > 0) {\r\n    window._boundaryDebugged = true;\r\n    const _firstBoundary = window.cityBoundaries[0];\r\n\r\n    // Test with a known point inside Digos City (approximate center)\r\n    const testLat = 6.85;\r\n    const testLng = 125.35;\r\n    let _testResult = false;\r\n    for (const boundary of window.cityBoundaries) {\r\n      if (\r\n        boundary &&\r\n        boundary.geojson &&\r\n        isPointInPolygon(testLat, testLng, boundary.geojson)\r\n      ) {\r\n        _testResult = true;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Check if point is within any barangay boundary\r\n  for (const boundary of window.cityBoundaries) {\r\n    if (boundary && boundary.geojson) {\r\n      if (isPointInPolygon(lat, lng, boundary.geojson)) {\r\n        return true;\r\n      }\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nclass HeatmapVisualization {\r\n  constructor(map) {\r\n    this.map = map;\r\n    this.complaintData = [];\r\n    this.allComplaintData = []; // Store all complaints for client-side filtering\r\n    this.roleScopedCache = null; // Cache filtered complaints per role for this tick\r\n    this.markerMap = new Map(); // Map complaint ID to marker for quick lookup\r\n    this.clusters = [];\r\n    this.heatmapLayer = null;\r\n    this.markerLayer = null;\r\n    this.clusterLayer = null;\r\n    this.dbscan = new DBSCAN();\r\n    this.isClusteringEnabled = false;\r\n    this.currentFilters = {};\r\n    this.filterByBoundary = true; // Enable boundary filtering by default\r\n    this.userRole = null; // Will be set when role is determined\r\n    this.userDepartment = null; // Will be set for LGU admins\r\n    // Dynamic heatmap scaling configuration\r\n    this.dynamicScaling = {\r\n      enabled: true, // Enable dynamic scaling by default\r\n      maxDensity: 1.0, // Current maximum density value\r\n      smoothedMaxDensity: 1.0, // Smoothed maximum for preventing flickering\r\n      smoothingFactor: 0.3, // Smoothing factor (0-1): lower = more smoothing, higher = more responsive\r\n      minMaxDensity: 0.1, // Minimum max density to prevent division by zero\r\n      densityHistory: [], // History for rolling average (optional)\r\n      historySize: 5, // Number of previous max densities to keep for smoothing\r\n    };\r\n    // Heatmap configuration\r\n    this.heatmapConfig = {\r\n      radius: 30,\r\n      blur: 15,\r\n      maxZoom: 18,\r\n      max: 1.0,\r\n      intensity: 1.0,\r\n      gradient: {\r\n        0.0: \"transparent\",\r\n        0.2: \"blue\",\r\n        0.4: \"cyan\",\r\n        0.6: \"lime\",\r\n        0.7: \"yellow\",\r\n        0.8: \"orange\",\r\n        1.0: \"red\",\r\n      },\r\n    };\r\n    // Cluster configuration\r\n    this.clusterConfig = {\r\n      eps: 0.1, // ~10km (increased from 0.01)\r\n      minPts: 5,\r\n      clusterColors: [\r\n        \"#FF6B6B\",\r\n        \"#4ECDC4\",\r\n        \"#45B7D1\",\r\n        \"#96CEB4\",\r\n        \"#FFEAA7\",\r\n        \"#DDA0DD\",\r\n        \"#98D8C8\",\r\n        \"#F7DC6F\",\r\n        \"#BB8FCE\",\r\n        \"#85C1E9\",\r\n      ],\r\n    };\r\n    // Setup zoom listener for dynamic marker sizing\r\n    if (this.map) {\r\n      this.map.on(\"zoomend\", () => {\r\n        this.updateMarkerSizes();\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Normalize all department sources for a complaint into uppercase codes\r\n   * @param {Object} complaint\r\n   * @returns {string[]} department codes\r\n   */\r\n  getComplaintDepartments(complaint) {\r\n    if (!complaint) return [];\r\n\r\n    const rawEntries = [];\r\n    const pushValue = (value) => {\r\n      if (value === null || typeof value === \"undefined\") return;\r\n      if (Array.isArray(value)) {\r\n        value.forEach(pushValue);\r\n        return;\r\n      }\r\n      rawEntries.push(value);\r\n    };\r\n\r\n    pushValue(complaint.departments);\r\n    pushValue(complaint.department_r);\r\n    pushValue(complaint.secondaryDepartments);\r\n    pushValue(complaint.department);\r\n    pushValue(complaint.departmentCode || complaint.department_code);\r\n\r\n    const normalized = rawEntries\r\n      .map((entry) => {\r\n        if (!entry) return \"\";\r\n        if (typeof entry === \"string\") return entry;\r\n        if (typeof entry === \"object\") {\r\n          return (\r\n            entry.code ||\r\n            entry.department_code ||\r\n            entry.departmentCode ||\r\n            entry.value ||\r\n            entry.name ||\r\n            \"\"\r\n          );\r\n        }\r\n        return String(entry || \"\");\r\n      })\r\n      .flatMap((value) => value.split(\",\"))\r\n      .map((value) => value.toUpperCase().trim())\r\n      .filter(Boolean);\r\n\r\n    return [...new Set(normalized)];\r\n  }\r\n\r\n  /**\r\n   * Scope visible complaints based on role\r\n   * @returns {Array} complaints limited to current user's access\r\n   */\r\n  getRoleScopedComplaints() {\r\n    if (!Array.isArray(this.allComplaintData)) return [];\r\n\r\n    const cacheHit =\r\n      this.roleScopedCache &&\r\n      this.roleScopedCache.role === this.userRole &&\r\n      this.roleScopedCache.department === this.userDepartment &&\r\n      this.roleScopedCache.sourceSize === this.allComplaintData.length;\r\n\r\n    if (cacheHit) {\r\n      return this.roleScopedCache.data;\r\n    }\r\n\r\n    const scoped = this.filterComplaintsByRole(this.allComplaintData);\r\n    this.roleScopedCache = {\r\n      role: this.userRole,\r\n      department: this.userDepartment,\r\n      sourceSize: this.allComplaintData.length,\r\n      data: scoped,\r\n    };\r\n\r\n    return scoped;\r\n  }\r\n  /**\r\n   * Initialize user role and department for role-based filtering\r\n   */\r\n  async initializeUserRole() {\r\n    try {\r\n      const { getUserRole } = await import(\"../../auth/authChecker.js\");\r\n      this.userRole = await getUserRole();\r\n\r\n      // Get department for LGU admins\r\n      if (\r\n        this.userRole &&\r\n        [\"lgu\", \"lgu-admin\", \"lgu-hr\"].includes(this.userRole)\r\n      ) {\r\n        try {\r\n          const { supabase } = await import(\"../../config/config.js\");\r\n          const {\r\n            data: { session },\r\n          } = await supabase.auth.getSession();\r\n          const metadata =\r\n            session?.user?.raw_user_meta_data ||\r\n            session?.user?.user_metadata ||\r\n            {};\r\n          this.userDepartment = metadata.dpt || metadata.department;\r\n        } catch (error) {\r\n          console.warn(\r\n            \"[HEATMAP] Failed to get department from metadata:\",\r\n            error\r\n          );\r\n        }\r\n      }\r\n\r\n      console.log(\"[HEATMAP] User role initialized:\", {\r\n        role: this.userRole,\r\n        department: this.userDepartment,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"[HEATMAP] Failed to initialize user role:\", error);\r\n      this.userRole = \"citizen\"; // Default fallback\r\n    }\r\n    // Clear scoped cache so new role context takes effect immediately\r\n    this.roleScopedCache = null;\r\n  }\r\n\r\n  /**\r\n   * Filter complaints based on user role\r\n   * @param {Array} complaints - Array of complaints to filter\r\n   * @returns {Array} Filtered complaints based on role\r\n   */\r\n  filterComplaintsByRole(complaints) {\r\n    if (!this.userRole) {\r\n      // If role not initialized, return all (will be filtered later)\r\n      return complaints;\r\n    }\r\n\r\n    // Citizens: Only see complaints within Digos City boundaries (already filtered)\r\n    // Heatmap shows all, but markers are hidden for citizens\r\n    if (this.userRole === \"citizen\") {\r\n      return complaints; // All complaints for heatmap, but markers won't be shown\r\n    }\r\n\r\n    // Complaint coordinators: See all complaints\r\n    if (\r\n      this.userRole === \"complaint-coordinator\" ||\r\n      this.userRole === \"super-admin\"\r\n    ) {\r\n      return complaints; // All complaints\r\n    }\r\n\r\n    // LGU Admins: See only complaints assigned to their department\r\n    if (this.userRole === \"lgu-admin\" && this.userDepartment) {\r\n      const targetDept = String(this.userDepartment || \"\")\r\n        .toUpperCase()\r\n        .trim();\r\n      return complaints.filter((complaint) => {\r\n        const complaintDepartments = this.getComplaintDepartments(complaint);\r\n        return complaintDepartments.includes(targetDept);\r\n      });\r\n    }\r\n\r\n    // Default: return all (fallback)\r\n    return complaints;\r\n  }\r\n\r\n  /**\r\n   * Load complaint data from API\r\n   * @param {Object} filters - Filter options\r\n   */\r\n  async loadComplaintData(filters = {}) {\r\n    try {\r\n      // console.log removed for security\r\n      this.currentFilters = filters;\r\n      // Reset filtered count for this load\r\n      this._filteredCount = 0;\r\n\r\n      // CRITICAL: Role-based filter handling\r\n      // - Coordinators and super-admins: Remove department filter (see all complaints)\r\n      // - LGU Admins: Add department filter if not present (see only their office)\r\n      const sanitizedFilters = { ...filters };\r\n      if (\r\n        this.userRole === \"complaint-coordinator\" ||\r\n        this.userRole === \"super-admin\"\r\n      ) {\r\n        delete sanitizedFilters.department;\r\n        console.log(\r\n          \"[HEATMAP] Coordinator/Super-admin detected - removing department filter from API request\"\r\n        );\r\n      } else if (\r\n        this.userRole === \"lgu-admin\" &&\r\n        this.userDepartment &&\r\n        !sanitizedFilters.department\r\n      ) {\r\n        // Automatically add department filter for LGU admins if not already present\r\n        sanitizedFilters.department = this.userDepartment;\r\n        console.log(\r\n          \"[HEATMAP] LGU Admin detected - adding department filter to API request:\",\r\n          this.userDepartment\r\n        );\r\n      }\r\n\r\n      const queryParams = new URLSearchParams();\r\n      // Explicitly include resolved complaints by default for heatmap\r\n      queryParams.append(\r\n        \"includeResolved\",\r\n        sanitizedFilters.includeResolved !== false ? \"true\" : \"false\"\r\n      );\r\n      Object.entries(sanitizedFilters).forEach(([key, value]) => {\r\n        // Skip includeResolved as we already set it above\r\n        if (key === \"includeResolved\") return;\r\n        if (value !== null && value !== void 0 && value !== \"\") {\r\n          // Handle array values (multiple selections)\r\n          if (Array.isArray(value) && value.length > 0) {\r\n            value.forEach((v) => queryParams.append(key, v));\r\n          } else if (!Array.isArray(value)) {\r\n            queryParams.append(key, value);\r\n          }\r\n        }\r\n      });\r\n\r\n      console.log(\"[HEATMAP] Loading complaint data with filters:\", {\r\n        role: this.userRole,\r\n        originalFilters: filters,\r\n        sanitizedFilters,\r\n        queryString: queryParams.toString(),\r\n      });\r\n      // console.log removed for security\r\n      // Use apiClient for authenticated requests\r\n      const apiClientModule = await import(\"../../config/apiClient.js\");\r\n      const apiClient = apiClientModule.default;\r\n      // console.log removed for security\r\n      const result = await apiClient.get(\r\n        `/api/complaints/locations?${queryParams}`\r\n      );\r\n      // Backend service already returns data with lat/lng fields correctly formatted\r\n      const raw = Array.isArray(result.data) ? result.data : [];\r\n      // console.log removed for security\r\n      // Log first item structure for debugging\r\n      if (raw.length > 0) {\r\n        // console.log removed for security\r\n        // console.log removed for security\r\n      }\r\n      // Debug: Check if we're only getting one complaint\r\n      if (raw.length === 1) {\r\n        console.warn(\r\n          \"[HEATMAP] ⚠️ WARNING: Only 1 complaint received from API!\"\r\n        );\r\n        console.warn(\"[HEATMAP] Filters applied:\", filters);\r\n        console.warn(\r\n          \"[HEATMAP] Check backend logs to see how many complaints exist in database.\"\r\n        );\r\n      }\r\n      // Backend already provides lat/lng, so we just need to validate\r\n      // Store all valid complaints (only filter by boundary, not by status/category/department)\r\n      // Debug: Log sample complaint to check department fields\r\n      if (raw.length > 0) {\r\n        console.log(\"[HEATMAP] Sample complaint data structure:\", {\r\n          id: raw[0].id,\r\n          title: raw[0].title,\r\n          departments: raw[0].departments,\r\n          department_r: raw[0].department_r,\r\n          departments_type: typeof raw[0].departments,\r\n          departments_isArray: Array.isArray(raw[0].departments),\r\n          allKeys: Object.keys(raw[0]),\r\n        });\r\n      }\r\n\r\n      const sanitizedData = raw\r\n        .map((item) => {\r\n          const lat =\r\n            typeof item.lat === \"number\" ? item.lat : parseFloat(item.lat);\r\n          const lng =\r\n            typeof item.lng === \"number\" ? item.lng : parseFloat(item.lng);\r\n          const isValid =\r\n            Number.isFinite(lat) &&\r\n            Number.isFinite(lng) &&\r\n            lat >= -90 &&\r\n            lat <= 90 &&\r\n            lng >= -180 &&\r\n            lng <= 180;\r\n\r\n          if (!isValid) {\r\n            console.warn(\r\n              \"[HEATMAP] Skipping complaint with invalid coordinates:\",\r\n              item.id,\r\n              { lat: item.lat, lng: item.lng }\r\n            );\r\n            return null;\r\n          }\r\n\r\n          return {\r\n            ...item,\r\n            lat,\r\n            lng,\r\n            priority: item.priority || \"medium\",\r\n            status: item.status || item.workflow_status || \"new\",\r\n            workflow_status: item.workflow_status || item.status || \"new\",\r\n            confirmation_status: item.confirmation_status || \"pending\",\r\n            title: item.title || \"Complaint\",\r\n            type: item.type || item.category || \"General\",\r\n            category: item.category || item.type || \"General\",\r\n            location: item.location || item.location_text || \"\",\r\n            submittedAt:\r\n              item.submittedAt || item.submitted_at || new Date().toISOString(),\r\n          };\r\n        })\r\n        .filter(Boolean);\r\n\r\n      this._filteredCount = 0;\r\n      const filteredByBoundary = [];\r\n      let withinBoundaryData = sanitizedData;\r\n\r\n      if (this.filterByBoundary) {\r\n        withinBoundaryData = sanitizedData.filter((item) => {\r\n          const withinBoundary = isWithinCityBoundary(item.lat, item.lng);\r\n          if (!withinBoundary) {\r\n            if (filteredByBoundary.length < 3) {\r\n              console.log(\r\n                \"[HEATMAP] Filtering out complaint outside city boundaries:\",\r\n                item.id,\r\n                {\r\n                  lat: item.lat,\r\n                  lng: item.lng,\r\n                }\r\n              );\r\n            }\r\n            filteredByBoundary.push(item);\r\n            this._filteredCount++;\r\n            return false;\r\n          }\r\n          return true;\r\n        });\r\n\r\n        if (this._filteredCount > 0) {\r\n          console.log(\r\n            `[HEATMAP] Filtered out ${this._filteredCount} complaints outside city boundaries based on strict filtering.`\r\n          );\r\n        }\r\n      }\r\n\r\n      this.allComplaintData = withinBoundaryData;\r\n\r\n      // Invalidate role cache when new data arrives\r\n      this.roleScopedCache = null;\r\n\r\n      // Initialize user role if not already done\r\n      if (!this.userRole) {\r\n        await this.initializeUserRole();\r\n      }\r\n\r\n      // Apply client-side filters to determine visible complaints\r\n      this.applyClientSideFilters(filters);\r\n\r\n      // Log summary of filtering\r\n      console.log(`[HEATMAP] Data loading summary:`);\r\n      console.log(`  - Raw data from API: ${raw.length} complaints`);\r\n      console.log(\r\n        `  - After coordinate validation: ${this.allComplaintData.length} complaints`\r\n      );\r\n      if (this.filterByBoundary && this._filteredCount > 0) {\r\n        console.log(\r\n          `  - Filtered out by boundary: ${this._filteredCount} complaint(s)`\r\n        );\r\n        console.log(\r\n          `  - Remaining within boundaries: ${this.allComplaintData.length} complaint(s)`\r\n        );\r\n      }\r\n      console.log(\r\n        `  - After client-side filters: ${this.complaintData.length} complaint(s) visible`\r\n      );\r\n      console.log(\r\n        `  - User role: ${this.userRole}, Department: ${\r\n          this.userDepartment || \"N/A\"\r\n        }`\r\n      );\r\n\r\n      // Debug: Check if we're missing complaints\r\n      if (raw.length > this.allComplaintData.length) {\r\n        const missing = raw.length - this.allComplaintData.length;\r\n        console.warn(\r\n          `[HEATMAP] ⚠️ WARNING: ${missing} complaint(s) were filtered out (invalid coordinates or outside boundaries)`\r\n        );\r\n      }\r\n\r\n      // console.log removed for security\r\n      // console.log removed for security\r\n      // console.log removed for security\r\n      return this.complaintData;\r\n    } catch (error) {\r\n      console.error(\"[HEATMAP] Error loading complaint data:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Calculate maximum density value from current complaint data\r\n   * @returns {number} Maximum intensity value\r\n   */\r\n  calculateMaxDensity() {\r\n    if (!this.complaintData || this.complaintData.length === 0) {\r\n      return this.dynamicScaling.minMaxDensity;\r\n    }\r\n\r\n    // Calculate raw intensity values for all complaints\r\n    const intensities = this.complaintData.map((complaint) =>\r\n      this.getIntensityValue(complaint)\r\n    );\r\n\r\n    // Find the maximum intensity\r\n    const maxIntensity = Math.max(...intensities);\r\n\r\n    // Ensure minimum value to prevent division by zero\r\n    return Math.max(maxIntensity, this.dynamicScaling.minMaxDensity);\r\n  }\r\n\r\n  /**\r\n   * Apply smoothing to maximum density to prevent flickering\r\n   * Uses exponential moving average (EMA) for smooth transitions\r\n   * Only applies smoothing when max increases (to prevent sudden jumps to red)\r\n   * When max decreases, use the new value immediately to ensure red appears\r\n   * @param {number} newMaxDensity - New maximum density value\r\n   * @returns {number} Smoothed maximum density\r\n   */\r\n  smoothMaxDensity(newMaxDensity) {\r\n    const { smoothedMaxDensity, smoothingFactor } = this.dynamicScaling;\r\n\r\n    // If new max is higher, apply smoothing to prevent sudden jumps to red\r\n    if (newMaxDensity > smoothedMaxDensity) {\r\n      // Exponential moving average: smoothed = α * new + (1 - α) * old\r\n      // Lower smoothingFactor = more smoothing (slower to change)\r\n      // Higher smoothingFactor = more responsive (faster to change)\r\n      const smoothed =\r\n        smoothingFactor * newMaxDensity +\r\n        (1 - smoothingFactor) * smoothedMaxDensity;\r\n      return Math.max(smoothed, this.dynamicScaling.minMaxDensity);\r\n    }\r\n    // If new max is lower or equal, use it immediately\r\n    // This ensures that when data changes, the highest point can still reach red\r\n    return Math.max(newMaxDensity, this.dynamicScaling.minMaxDensity);\r\n  }\r\n\r\n  /**\r\n   * Update dynamic scaling based on current data\r\n   * This should be called whenever complaint data changes\r\n   */\r\n  updateDynamicScaling() {\r\n    if (!this.dynamicScaling.enabled) {\r\n      return;\r\n    }\r\n\r\n    // Calculate new maximum density\r\n    const newMaxDensity = this.calculateMaxDensity();\r\n\r\n    // If this is the first calculation (maxDensity is still at initial value of 1.0)\r\n    // or if we have no history, reset to use the actual max immediately\r\n    const isFirstRun =\r\n      this.dynamicScaling.maxDensity === 1.0 &&\r\n      this.dynamicScaling.densityHistory.length === 0;\r\n\r\n    if (isFirstRun) {\r\n      // First run: use actual max immediately (no smoothing)\r\n      this.dynamicScaling.maxDensity = newMaxDensity;\r\n      this.dynamicScaling.smoothedMaxDensity = newMaxDensity;\r\n      console.log(\r\n        `[HEATMAP] Dynamic scaling initialized: max=${newMaxDensity.toFixed(3)}`\r\n      );\r\n    } else {\r\n      // Subsequent runs: store current max FIRST (this is what we use for normalization)\r\n      this.dynamicScaling.maxDensity = newMaxDensity;\r\n\r\n      // Update smoothed maximum density (only used for preventing flickering on increases)\r\n      this.dynamicScaling.smoothedMaxDensity =\r\n        this.smoothMaxDensity(newMaxDensity);\r\n    }\r\n\r\n    // Optional: Store in history for rolling average (alternative smoothing method)\r\n    this.dynamicScaling.densityHistory.push(newMaxDensity);\r\n    if (\r\n      this.dynamicScaling.densityHistory.length >\r\n      this.dynamicScaling.historySize\r\n    ) {\r\n      this.dynamicScaling.densityHistory.shift();\r\n    }\r\n\r\n    console.log(\r\n      `[HEATMAP] Dynamic scaling updated: max=${newMaxDensity.toFixed(\r\n        3\r\n      )}, smoothed=${this.dynamicScaling.smoothedMaxDensity.toFixed(\r\n        3\r\n      )}, usingMaxForNormalization=${this.dynamicScaling.maxDensity.toFixed(3)}`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Normalize intensity value relative to current maximum density\r\n   * Uses the actual maxDensity (not smoothed) to ensure highest point = red (1.0)\r\n   * @param {number} intensity - Raw intensity value\r\n   * @returns {number} Normalized intensity (0-1)\r\n   */\r\n  normalizeIntensity(intensity) {\r\n    if (!this.dynamicScaling.enabled) {\r\n      return Math.min(1.0, Math.max(0.0, intensity));\r\n    }\r\n\r\n    // Use actual maxDensity (not smoothed) for normalization\r\n    // This ensures the highest point always maps to red (1.0)\r\n    // Smoothing is only used to prevent flickering when max increases\r\n    const { maxDensity } = this.dynamicScaling;\r\n\r\n    // Prevent division by zero\r\n    if (maxDensity <= 0) {\r\n      return 0.0;\r\n    }\r\n\r\n    // Normalize: value / maxValue\r\n    // The highest intensity will always be maxDensity / maxDensity = 1.0 (red)\r\n    const normalized = intensity / maxDensity;\r\n\r\n    // Clamp to [0, 1] range\r\n    return Math.min(1.0, Math.max(0.0, normalized));\r\n  }\r\n\r\n  /**\r\n   * Reset dynamic scaling smoothing (useful when data changes dramatically)\r\n   * This will immediately use the new maximum density without smoothing\r\n   */\r\n  resetDynamicScaling() {\r\n    const newMaxDensity = this.calculateMaxDensity();\r\n    this.dynamicScaling.maxDensity = newMaxDensity;\r\n    // Reset smoothed to match actual max so normalization works correctly\r\n    this.dynamicScaling.smoothedMaxDensity = Math.max(\r\n      newMaxDensity,\r\n      this.dynamicScaling.minMaxDensity\r\n    );\r\n    this.dynamicScaling.densityHistory = [];\r\n    console.log(\r\n      `[HEATMAP] Dynamic scaling reset: max=${newMaxDensity.toFixed(\r\n        3\r\n      )}, smoothed=${this.dynamicScaling.smoothedMaxDensity.toFixed(3)}`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Enable or disable dynamic scaling\r\n   * @param {boolean} enabled - Whether to enable dynamic scaling\r\n   */\r\n  setDynamicScalingEnabled(enabled) {\r\n    this.dynamicScaling.enabled = enabled;\r\n    console.log(\r\n      `[HEATMAP] Dynamic scaling ${enabled ? \"enabled\" : \"disabled\"}`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Set smoothing factor for dynamic scaling\r\n   * @param {number} factor - Smoothing factor (0-1): lower = more smoothing, higher = more responsive\r\n   */\r\n  setSmoothingFactor(factor) {\r\n    this.dynamicScaling.smoothingFactor = Math.max(0, Math.min(1, factor));\r\n    console.log(\r\n      `[HEATMAP] Smoothing factor set to ${this.dynamicScaling.smoothingFactor}`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Create heatmap layer from complaint data\r\n   * For heatmap: Citizens see all Digos City complaints, Coordinators see all, Admins see all (for visualization)\r\n   * For markers: Role-based filtering applies\r\n   */\r\n  createHeatmapLayer() {\r\n    // Clear old heatmap layer before creating new one\r\n    if (this.heatmapLayer) {\r\n      // Remove from map if it's still attached\r\n      if (this.map && this.map.hasLayer(this.heatmapLayer)) {\r\n        this.map.removeLayer(this.heatmapLayer);\r\n      }\r\n      // Remove reference\r\n      this.heatmapLayer = null;\r\n    }\r\n\r\n    // Apply filters to determine which complaints should be visible\r\n    this.applyClientSideFilters(this.currentFilters || {});\r\n\r\n    // For heatmap visualization, use filtered complaintData\r\n    // markers use the same filtered data\r\n    const heatmapData = this.complaintData || [];\r\n\r\n    if (heatmapData.length === 0) {\r\n      console.warn(\"[HEATMAP] No complaint data available for heatmap\");\r\n      this.heatmapLayer = null;\r\n      return null;\r\n    }\r\n\r\n    // Update dynamic scaling based on current data\r\n    this.updateDynamicScaling();\r\n\r\n    // Convert complaint data to heatmap format with normalized intensities\r\n    const heatmapPoints = heatmapData.map((complaint) => {\r\n      const rawIntensity = this.getIntensityValue(complaint);\r\n      const normalizedIntensity = this.normalizeIntensity(rawIntensity);\r\n\r\n      return [complaint.lat, complaint.lng, normalizedIntensity];\r\n    });\r\n\r\n    // Debug: Log intensity statistics\r\n    const intensities = heatmapPoints.map((d) => d[2]);\r\n    const maxIntensity = Math.max(...intensities);\r\n    const minIntensity = Math.min(...intensities);\r\n    const _intensitiesAt1 = intensities.filter((i) => i >= 0.99).length;\r\n\r\n    // Ensure at least one point reaches 1.0 (red) by finding all max points and setting them to 1.0\r\n    if (maxIntensity < 0.99 && intensities.length > 0) {\r\n      console.warn(\r\n        `[HEATMAP] ⚠️ Max intensity (${maxIntensity.toFixed(\r\n          3\r\n        )}) is less than 1.0. Forcing highest point(s) to 1.0.`\r\n      );\r\n      // Find all indices with maximum intensity and set them to 1.0\r\n      let fixedCount = 0;\r\n      heatmapPoints.forEach((point, _index) => {\r\n        if (Math.abs(point[2] - maxIntensity) < 0.001) {\r\n          point[2] = 1.0;\r\n          fixedCount++;\r\n        }\r\n      });\r\n      console.log(\r\n        `[HEATMAP] ✓ Set ${fixedCount} point(s) with max intensity to 1.0 (red)`\r\n      );\r\n    }\r\n\r\n    console.log(\r\n      `[HEATMAP] Intensity stats: min=${minIntensity.toFixed(\r\n        3\r\n      )}, max=${Math.max(...heatmapPoints.map((d) => d[2])).toFixed(\r\n        3\r\n      )}, count at 1.0=${\r\n        intensities.filter((i) => i >= 0.99).length\r\n      }, maxDensity=${this.dynamicScaling.maxDensity.toFixed(3)}`\r\n    );\r\n\r\n    // Update heatmap config max value to ensure proper scaling\r\n    // Leaflet.heat uses the 'max' config to scale the gradient\r\n    const config = {\r\n      ...this.heatmapConfig,\r\n      max: 1.0, // Always use 1.0 since we're normalizing to [0, 1]\r\n    };\r\n\r\n    // console.log removed for security\r\n    // Create heatmap layer using Leaflet.heat\r\n    try {\r\n      this.heatmapLayer = L.heatLayer(heatmapPoints, config);\r\n      // console.log removed for security\r\n      return this.heatmapLayer;\r\n    } catch (error) {\r\n      console.error(\"[HEATMAP] Error creating heatmap layer:\", error);\r\n      return null;\r\n    }\r\n  }\r\n  /**\r\n   * Calculate intensity value for heatmap based on complaint properties\r\n   * @param {Object} complaint - Complaint data\r\n   * @returns {number} Intensity value (0-1)\r\n   */\r\n  getIntensityValue(complaint) {\r\n    let intensity = 0.5; // Base intensity\r\n    // Adjust based on priority\r\n    const priorityWeights = {\r\n      low: 0.3,\r\n      medium: 0.6,\r\n      high: 0.9,\r\n      urgent: 1.0,\r\n    };\r\n    intensity = priorityWeights[complaint.priority] || 0.5;\r\n    // Adjust based on status\r\n    const statusWeights = {\r\n      \"pending review\": 1.0,\r\n      \"in progress\": 0.8,\r\n      resolved: 0.3,\r\n      closed: 0.1,\r\n      rejected: 0.2,\r\n    };\r\n    intensity *= statusWeights[complaint.status] || 0.5;\r\n    // Adjust based on recency (more recent = higher intensity)\r\n    const daysSinceSubmission =\r\n      (Date.now() - new Date(complaint.submittedAt).getTime()) /\r\n      (1000 * 60 * 60 * 24);\r\n    const recencyFactor = Math.max(0.1, 1 - daysSinceSubmission / 30); // Decay over 30 days\r\n    intensity *= recencyFactor;\r\n    return Math.min(1.0, Math.max(0.1, intensity));\r\n  }\r\n  /**\r\n   * Apply client-side filters to determine which complaints should be visible\r\n   * @param {Object} filters - Filter criteria\r\n   */\r\n  applyClientSideFilters(filters = {}) {\r\n    const baseData = this.getRoleScopedComplaints();\r\n\r\n    if (!baseData || baseData.length === 0) {\r\n      this.complaintData = [];\r\n      return;\r\n    }\r\n\r\n    const effectiveFilters = { ...filters };\r\n    if (this.userRole === \"lgu-admin\" && this.userDepartment) {\r\n      effectiveFilters.department = this.userDepartment;\r\n    }\r\n\r\n    // Debug: Check sample complaints for department data\r\n\r\n    this.complaintData = baseData.filter((complaint) => {\r\n      // Filter by status\r\n      if (effectiveFilters.status && effectiveFilters.status !== \"\") {\r\n        const statusArray = Array.isArray(effectiveFilters.status)\r\n          ? effectiveFilters.status\r\n          : [effectiveFilters.status];\r\n        const complaintStatus = (\r\n          complaint.status ||\r\n          complaint.workflow_status ||\r\n          \"new\"\r\n        ).toLowerCase();\r\n        const complaintWorkflowStatus = (\r\n          complaint.workflow_status || \"new\"\r\n        ).toLowerCase();\r\n        const complaintConfirmationStatus = (\r\n          complaint.confirmation_status || \"pending\"\r\n        ).toLowerCase();\r\n\r\n        // Check if complaint matches any selected status\r\n        const matchesStatus = statusArray.some((filterStatus) => {\r\n          const filterLower = filterStatus.toLowerCase();\r\n          // Map legacy status to workflow status\r\n          const statusMap = {\r\n            \"pending review\": \"new\",\r\n            pending: \"new\",\r\n            \"in progress\": \"in_progress\",\r\n            resolved: \"completed\",\r\n            completed: \"completed\",\r\n            closed: \"cancelled\",\r\n            rejected: \"cancelled\",\r\n            cancelled: \"cancelled\",\r\n          };\r\n\r\n          const mappedStatus = statusMap[filterLower] || filterLower;\r\n\r\n          // Check workflow_status\r\n          if (mappedStatus === complaintWorkflowStatus) return true;\r\n          // Check confirmation_status\r\n          if (filterLower === complaintConfirmationStatus) return true;\r\n          // Check legacy status field\r\n          if (filterLower === complaintStatus) return true;\r\n\r\n          return false;\r\n        });\r\n\r\n        if (!matchesStatus) return false;\r\n      }\r\n\r\n      // Filter by category (UUIDs from categories table)\r\n      if (effectiveFilters.category && effectiveFilters.category !== \"\") {\r\n        const categoryArray = Array.isArray(effectiveFilters.category)\r\n          ? effectiveFilters.category\r\n          : [effectiveFilters.category];\r\n        // complaint.category should be a UUID that matches the filter UUIDs\r\n        const complaintCategory = complaint.category || \"\";\r\n        if (!complaintCategory || !categoryArray.includes(complaintCategory))\r\n          return false;\r\n      }\r\n\r\n      // Filter by subcategory (UUIDs from subcategories table)\r\n      if (effectiveFilters.subcategory && effectiveFilters.subcategory !== \"\") {\r\n        const subcategoryArray = Array.isArray(effectiveFilters.subcategory)\r\n          ? effectiveFilters.subcategory\r\n          : [effectiveFilters.subcategory];\r\n        // complaint.subcategory should be a UUID that matches the filter UUIDs\r\n        const complaintSubcategory = complaint.subcategory || \"\";\r\n        if (\r\n          !complaintSubcategory ||\r\n          !subcategoryArray.includes(complaintSubcategory)\r\n        )\r\n          return false;\r\n      }\r\n\r\n      // Filter by department - checks departments array (backend transforms department_r to departments)\r\n      if (effectiveFilters.department && effectiveFilters.department !== \"\") {\r\n        const departmentArray = Array.isArray(effectiveFilters.department)\r\n          ? effectiveFilters.department\r\n          : [effectiveFilters.department];\r\n        // Get complaint's assigned departments - backend returns as 'departments' field (from department_r)\r\n        // Fallback to department_r in case backend format changes\r\n        const complaintDepartments = this.getComplaintDepartments(complaint);\r\n\r\n        // Debug logging\r\n\r\n        // If complaint has no departments assigned, exclude it from results\r\n        if (complaintDepartments.length === 0) {\r\n          return false;\r\n        }\r\n\r\n        // Check if any selected department code matches any department in departments array\r\n        // Use case-insensitive comparison to handle any case variations\r\n        const matchesDepartment = departmentArray.some((filterDept) => {\r\n          const filterDeptUpper = String(filterDept || \"\")\r\n            .toUpperCase()\r\n            .trim();\r\n          return complaintDepartments.some((complaintDept) => {\r\n            const complaintDeptUpper = String(complaintDept || \"\")\r\n              .toUpperCase()\r\n              .trim();\r\n            return complaintDeptUpper === filterDeptUpper;\r\n          });\r\n        });\r\n\r\n        if (!matchesDepartment) {\r\n          return false;\r\n        }\r\n      }\r\n\r\n      // Filter by includeResolved\r\n      if (effectiveFilters.includeResolved === false) {\r\n        const workflowStatus = (\r\n          complaint.workflow_status || \"new\"\r\n        ).toLowerCase();\r\n        if (workflowStatus === \"completed\" || workflowStatus === \"cancelled\") {\r\n          return false;\r\n        }\r\n      }\r\n\r\n      // Filter by date range\r\n      if (effectiveFilters.startDate || effectiveFilters.endDate) {\r\n        const complaintDate = new Date(\r\n          complaint.submittedAt || complaint.submitted_at\r\n        );\r\n        if (isNaN(complaintDate.getTime())) {\r\n          return false; // Invalid date, exclude\r\n        }\r\n\r\n        if (effectiveFilters.startDate) {\r\n          const startDate = new Date(effectiveFilters.startDate);\r\n          startDate.setHours(0, 0, 0, 0);\r\n          if (complaintDate < startDate) {\r\n            return false;\r\n          }\r\n        }\r\n\r\n        if (effectiveFilters.endDate) {\r\n          const endDate = new Date(effectiveFilters.endDate);\r\n          endDate.setHours(23, 59, 59, 999);\r\n          if (complaintDate > endDate) {\r\n            return false;\r\n          }\r\n        }\r\n      }\r\n\r\n      return true;\r\n    });\r\n\r\n    // Debug logging after filtering\r\n  }\r\n\r\n  /**\r\n   * Create individual complaint markers (only called once on initial load)\r\n   * Role-based filtering: Citizens don't see markers, Coordinators see all, Admins see assigned only\r\n   */\r\n  createMarkerLayer() {\r\n    // Only create markers if they don't exist yet\r\n    if (this.markerLayer && this.markerLayer.getLayers().length > 0) {\r\n      console.log(\"[HEATMAP] Markers already exist, skipping recreation\");\r\n      // Don't update visibility here - let the caller handle it based on zoom level\r\n      return this.markerLayer;\r\n    }\r\n\r\n    if (!this.allComplaintData || this.allComplaintData.length === 0) {\r\n      console.warn(\"[HEATMAP] No complaint data to create markers from\");\r\n      this.markerLayer = null;\r\n      return null;\r\n    }\r\n\r\n    // Initialize user role if not already done\r\n    if (!this.userRole) {\r\n      // Synchronous fallback - role should be initialized in loadComplaintData\r\n      console.warn(\r\n        \"[HEATMAP] User role not initialized, defaulting to citizen\"\r\n      );\r\n      this.userRole = \"citizen\";\r\n    }\r\n\r\n    // Filter complaints for markers based on role\r\n    let complaintsForMarkers = this.getRoleScopedComplaints();\r\n\r\n    // Citizens: No markers (only heatmap)\r\n    if (this.userRole === \"citizen\") {\r\n      console.log(\r\n        \"[HEATMAP] Citizen role: Markers disabled, only heatmap shown\"\r\n      );\r\n      this.markerLayer = L.layerGroup(); // Empty layer group\r\n      this.markerMap.clear();\r\n      return this.markerLayer;\r\n    }\r\n\r\n    // Complaint coordinators and super-admin: All markers\r\n    if (\r\n      this.userRole === \"complaint-coordinator\" ||\r\n      this.userRole === \"super-admin\"\r\n    ) {\r\n      complaintsForMarkers = this.allComplaintData;\r\n      console.log(\"[HEATMAP] Coordinator/Super-admin: Showing all markers\");\r\n    }\r\n    // LGU Admins: Only complaints assigned to their office/department\r\n    else if (this.userRole === \"lgu-admin\" && this.userDepartment) {\r\n      complaintsForMarkers = this.getRoleScopedComplaints();\r\n      console.log(\r\n        `[HEATMAP] LGU Admin (${this.userDepartment}): Showing ${complaintsForMarkers.length} assigned complaints out of ${this.allComplaintData.length} total`\r\n      );\r\n    }\r\n    // Default: No markers\r\n    else {\r\n      console.log(`[HEATMAP] Role ${this.userRole}: Markers disabled`);\r\n      this.markerLayer = L.layerGroup(); // Empty layer group\r\n      this.markerMap.clear();\r\n      return this.markerLayer;\r\n    }\r\n\r\n    // Create marker layer and store all markers\r\n    // IMPORTANT: Do NOT add layer to map during creation - caller will handle visibility\r\n    this.markerLayer = L.layerGroup();\r\n    this.markerMap.clear();\r\n\r\n    complaintsForMarkers.forEach((complaint, index) => {\r\n      try {\r\n        const marker = this.createComplaintMarker(complaint, index);\r\n        // Add marker to layer group (but NOT to map)\r\n        this.markerLayer.addLayer(marker);\r\n        // Store marker reference by complaint ID for quick lookup\r\n        if (complaint.id) {\r\n          this.markerMap.set(complaint.id, marker);\r\n        }\r\n        // Ensure marker is NOT on the map (safety check)\r\n        if (this.map && this.map.hasLayer(marker)) {\r\n          this.map.removeLayer(marker);\r\n        }\r\n      } catch (error) {\r\n        console.error(\r\n          `[HEATMAP] Failed to create marker ${index + 1}:`,\r\n          error,\r\n          complaint\r\n        );\r\n      }\r\n    });\r\n\r\n    console.log(\r\n      `[HEATMAP] Created ${\r\n        this.markerLayer.getLayers().length\r\n      } marker(s) for all complaints`\r\n    );\r\n\r\n    // CRITICAL: Ensure marker layer is NOT on the map during creation\r\n    // The caller will handle adding/removing based on zoom level and initial load state\r\n    if (this.map && this.map.hasLayer(this.markerLayer)) {\r\n      this.map.removeLayer(this.markerLayer);\r\n    }\r\n\r\n    // Don't apply visibility here - let the caller handle it based on zoom level\r\n    // Markers will be shown/hidden by updateZoomBasedVisibility() in heatmap-init.js\r\n\r\n    return this.markerLayer;\r\n  }\r\n\r\n  /**\r\n   * Update marker visibility based on current filters (show/hide without removing)\r\n   */\r\n  updateMarkerVisibility() {\r\n    if (!this.markerLayer || !this.map) return;\r\n\r\n    // Check if we're in initial load mode (markers should stay hidden)\r\n    // This is a safety check - the caller should prevent this during initial load\r\n    if (window.isInitialLoad === true) {\r\n      // During initial load, don't show markers - just ensure they're hidden\r\n      this.markerLayer.eachLayer((marker) => {\r\n        if (this.map.hasLayer(marker)) {\r\n          this.map.removeLayer(marker);\r\n        }\r\n      });\r\n      if (this.map.hasLayer(this.markerLayer)) {\r\n        this.map.removeLayer(this.markerLayer);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Apply filters to determine which complaints should be visible\r\n    this.applyClientSideFilters(this.currentFilters || {});\r\n\r\n    const visibleComplaintIds = new Set(this.complaintData.map((c) => c.id));\r\n    let visibleCount = 0;\r\n    let hiddenCount = 0;\r\n\r\n    // Ensure marker layer is on the map first (only if not initial load)\r\n    if (!this.map.hasLayer(this.markerLayer)) {\r\n      this.markerLayer.addTo(this.map);\r\n    }\r\n\r\n    // Update visibility of each marker\r\n    this.markerLayer.eachLayer((marker) => {\r\n      // Get complaint ID from marker (try multiple ways)\r\n      const complaintId =\r\n        marker._complaintId ||\r\n        marker.options?.complaintId ||\r\n        (this.markerMap &&\r\n          Array.from(this.markerMap.entries()).find(\r\n            ([_id, m]) => m === marker\r\n          )?.[0]);\r\n\r\n      // Determine if marker should be visible\r\n      let shouldBeVisible = false;\r\n      if (complaintId) {\r\n        shouldBeVisible = visibleComplaintIds.has(complaintId);\r\n      } else {\r\n        // Fallback: check by coordinates (less reliable but works if ID is missing)\r\n        const latLng = marker.getLatLng();\r\n        shouldBeVisible = this.complaintData.some(\r\n          (c) =>\r\n            Math.abs(c.lat - latLng.lat) < 0.0001 &&\r\n            Math.abs(c.lng - latLng.lng) < 0.0001\r\n        );\r\n      }\r\n\r\n      // Show or hide marker based on filter match\r\n      // Note: Markers are part of markerLayer, so we manage visibility by adding/removing from layer\r\n      if (shouldBeVisible) {\r\n        // Show marker - ensure it's in the layer (it should be, but check anyway)\r\n        if (!this.markerLayer.hasLayer(marker)) {\r\n          this.markerLayer.addLayer(marker);\r\n        }\r\n        // Also ensure it's visible on the map\r\n        if (!this.map.hasLayer(marker)) {\r\n          marker.addTo(this.map);\r\n        }\r\n        visibleCount++;\r\n      } else {\r\n        // Hide marker by removing from map (but keep in layer for later)\r\n        if (this.map.hasLayer(marker)) {\r\n          this.map.removeLayer(marker);\r\n        }\r\n        hiddenCount++;\r\n      }\r\n    });\r\n\r\n    // Dispatch custom event for marker visibility update\r\n    if (typeof window !== \"undefined\" && window.dispatchEvent) {\r\n      const event = new CustomEvent(\"markerVisibilityUpdated\", {\r\n        detail: {\r\n          visibleCount,\r\n          hiddenCount,\r\n          totalCount: this.markerLayer.getLayers().length,\r\n        },\r\n      });\r\n      window.dispatchEvent(event);\r\n    }\r\n  }\r\n  /**\r\n   * Create clickable circles for complaints\r\n   */\r\n  createCircleLayer() {\r\n    if (!this.complaintData || this.complaintData.length === 0) {\r\n      return null;\r\n    }\r\n    this.circleLayer = L.layerGroup();\r\n    // console.log removed for security\r\n    this.complaintData.forEach((complaint, _index) => {\r\n      // console.log removed for security\r\n      const circle = this.createComplaintCircle(complaint);\r\n      this.circleLayer.addLayer(circle);\r\n    });\r\n    // console.log removed for security\r\n    return this.circleLayer;\r\n  }\r\n  /**\r\n   * Create individual complaint marker\r\n   * @param {Object} complaint - Complaint data\r\n   * @param {number} index - Index of the complaint (for unique styling)\r\n   * @returns {L.Marker} Leaflet marker\r\n   */\r\n  createComplaintMarker(complaint, index = 0) {\r\n    const icon = this.getComplaintIcon(complaint, index);\r\n    const marker = L.marker([complaint.lat, complaint.lng], {\r\n      icon,\r\n      // Add z-index offset to prevent stacking\r\n      zIndexOffset: 1000 + index * 10,\r\n      // Store complaint ID for filtering\r\n      complaintId: complaint.id,\r\n    });\r\n    // Also store directly on marker for quick access\r\n    marker._complaintId = complaint.id;\r\n    // Create popup content\r\n    const popupContent = this.createComplaintPopup(complaint);\r\n    marker.bindPopup(popupContent, {\r\n      maxWidth: 250,\r\n      className: \"complaint-popup\",\r\n    });\r\n    return marker;\r\n  }\r\n  /**\r\n   * Create clickable circle for complaint\r\n   * @param {Object} complaint - Complaint data\r\n   * @returns {L.Circle} Leaflet circle\r\n   */\r\n  createComplaintCircle(complaint) {\r\n    const priorityColors = {\r\n      low: \"#28a745\",\r\n      medium: \"#ffc107\",\r\n      high: \"#fd7e14\",\r\n      urgent: \"#dc3545\",\r\n    };\r\n    const statusColors = {\r\n      \"pending review\": \"#6c757d\",\r\n      \"in progress\": \"#17a2b8\",\r\n      resolved: \"#28a745\",\r\n      closed: \"#6c757d\",\r\n      rejected: \"#dc3545\",\r\n    };\r\n    // Use priority color for fill, status color for border\r\n    const fillColor = priorityColors[complaint.priority] || \"#6c757d\";\r\n    const borderColor = statusColors[complaint.status] || \"#6c757d\";\r\n    // Circle size based on priority\r\n    const radiusSizes = {\r\n      low: 50,\r\n      medium: 75,\r\n      high: 100,\r\n      urgent: 125,\r\n    };\r\n    const radius = radiusSizes[complaint.priority] || 75;\r\n    const circle = L.circle([complaint.lat, complaint.lng], {\r\n      radius,\r\n      color: borderColor,\r\n      weight: 3,\r\n      opacity: 0.8,\r\n      fillColor,\r\n      fillOpacity: 0.4,\r\n      className: \"complaint-circle\",\r\n    });\r\n    // Add hover effects\r\n    circle.on(\"mouseover\", function (_e) {\r\n      this.setStyle({\r\n        weight: 5,\r\n        fillOpacity: 0.6,\r\n      });\r\n    });\r\n    circle.on(\"mouseout\", function (_e) {\r\n      this.setStyle({\r\n        weight: 3,\r\n        fillOpacity: 0.4,\r\n      });\r\n    });\r\n    // Create detailed popup content (async)\r\n    circle.bindPopup(\r\n      async () => {\r\n        return await this.createDetailedComplaintPopup(complaint);\r\n      },\r\n      {\r\n        maxWidth: 280,\r\n        className: \"complaint-circle-popup\",\r\n        closeButton: true,\r\n        autoClose: false,\r\n        keepInView: true,\r\n      }\r\n    );\r\n    // Add click event for additional actions\r\n    circle.on(\"click\", (_e) => {\r\n      // console.log removed for security\r\n      // You can add additional click actions here\r\n    });\r\n    return circle;\r\n  }\r\n  /**\r\n   * Get appropriate icon for complaint\r\n   * @param {Object} complaint - Complaint data\r\n   * @param {number} index - Index of the complaint (for unique styling)\r\n   * @returns {L.Icon} Leaflet icon\r\n   */\r\n  getComplaintIcon(complaint, index = 0) {\r\n    // Color based on complaint status\r\n    // Handles both 'status' and 'workflow_status' fields\r\n    const statusColors = {\r\n      // Standard status values\r\n      \"pending review\": \"#6c757d\", // Gray\r\n      pending: \"#6c757d\", // Gray\r\n      \"in progress\": \"#17a2b8\", // Cyan/Teal\r\n      in_progress: \"#17a2b8\", // Cyan/Teal (workflow_status format)\r\n      resolved: \"#28a745\", // Green\r\n      closed: \"#6c757d\", // Gray\r\n      rejected: \"#dc3545\", // Red\r\n      cancelled: \"#6c757d\", // Gray\r\n      completed: \"#28a745\", // Green\r\n      // Workflow status values\r\n      new: \"#6c757d\", // Gray\r\n      assigned: \"#ffc107\", // Yellow\r\n      pending_approval: \"#fd7e14\", // Orange\r\n      // Confirmation status values\r\n      waiting_for_responders: \"#17a2b8\", // Cyan\r\n      waiting_for_complainant: \"#ffc107\", // Yellow\r\n      confirmed: \"#28a745\", // Green\r\n      disputed: \"#dc3545\", // Red\r\n    };\r\n\r\n    // Check both status and workflow_status fields\r\n    let status = (\r\n      complaint.status ||\r\n      complaint.workflow_status ||\r\n      \"pending review\"\r\n    ).toLowerCase();\r\n\r\n    // If status is not found, try confirmation_status\r\n    if (!statusColors[status] && complaint.confirmation_status) {\r\n      status = complaint.confirmation_status.toLowerCase();\r\n    }\r\n\r\n    const color = statusColors[status] || \"#6c757d\"; // Default to gray if status unknown\r\n\r\n    // Dynamic sizing based on zoom level\r\n    const currentZoom = this.map ? this.map.getZoom() : 12;\r\n    const baseSize = 12; // Base size in pixels\r\n    const zoomFactor = Math.max(0.7, Math.min(1.5, currentZoom / 12)); // Scale between 0.7x and 1.5x\r\n    const size = Math.round(baseSize * zoomFactor);\r\n    const borderWidth = Math.max(2, Math.round(2 * zoomFactor));\r\n\r\n    // Add a small border color based on priority for additional visual distinction\r\n    const priorityBorderColors = {\r\n      low: \"#28a745\", // Green border\r\n      medium: \"#ffc107\", // Yellow border\r\n      high: \"#fd7e14\", // Orange border\r\n      urgent: \"#dc3545\", // Red border\r\n    };\r\n    const priority = (complaint.priority || \"medium\").toLowerCase();\r\n    const borderColor = priorityBorderColors[priority] || \"#ffffff\";\r\n\r\n    return L.divIcon({\r\n      html: `<div style=\"\r\n        background-color: ${color};\r\n        color: white;\r\n        border-radius: 50%;\r\n        width: ${size}px;\r\n        height: ${size}px;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        border: ${borderWidth}px solid ${borderColor};\r\n        box-shadow: 0 2px 6px rgba(0,0,0,0.4);\r\n        z-index: ${1000 + index};\r\n        position: relative;\r\n        cursor: pointer;\r\n        transition: all 0.2s ease;\r\n      \"></div>`,\r\n      className: \"complaint-marker\",\r\n      iconSize: [size, size],\r\n      iconAnchor: [size / 2, size / 2],\r\n    });\r\n  }\r\n  /**\r\n   * Create popup content for complaint\r\n   * @param {Object} complaint - Complaint data\r\n   * @returns {string} HTML content\r\n   */\r\n  createComplaintPopup(complaint) {\r\n    const submittedDate = new Date(complaint.submittedAt).toLocaleDateString();\r\n    const priorityClass = complaint.priority.replace(\" \", \"-\").toLowerCase();\r\n    const assignedOffices =\r\n      complaint.departments && complaint.departments.length > 0\r\n        ? complaint.departments.join(\", \")\r\n        : complaint.department || \"Not assigned\";\r\n\r\n    return `\r\n      <div class=\"complaint-popup-content\" style=\"padding: 8px; font-size: 12px; line-height: 1.3;\">\r\n        <h4 style=\"margin: 0 0 6px 0; font-size: 13px; font-weight: bold;\">${\r\n  complaint.title\r\n}</h4>\r\n        <div class=\"complaint-details\" style=\"margin: 0; padding: 0;\">\r\n          <p style=\"margin: 2px 0; font-size: 11px;\"><strong>Type:</strong> ${\r\n  complaint.type\r\n}</p>\r\n          <p style=\"margin: 2px 0; font-size: 11px;\"><strong>Status:</strong> <span class=\"status-${complaint.status.replace(\r\n    \" \",\r\n    \"-\"\r\n  )}\">${complaint.status}</span></p>\r\n          <p style=\"margin: 2px 0; font-size: 11px;\"><strong>Priority:</strong> <span class=\"priority-${priorityClass}\">${\r\n  complaint.priority\r\n}</span></p>\r\n          <p style=\"margin: 2px 0; font-size: 11px;\"><strong>Location:</strong> ${\r\n  complaint.location\r\n}</p>\r\n          <p style=\"margin: 2px 0; font-size: 11px;\"><strong>Submitted:</strong> ${submittedDate}</p>\r\n          <p style=\"margin: 2px 0; font-size: 11px;\"><strong>Assigned Offices:</strong> ${assignedOffices}</p>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Create detailed popup content for complaint circles\r\n   * @param {Object} complaint - Complaint data\r\n   * @returns {string} HTML content\r\n   */\r\n  async createDetailedComplaintPopup(complaint) {\r\n    const submittedDate = new Date(complaint.submittedAt).toLocaleDateString();\r\n    const _submittedTime = new Date(complaint.submittedAt).toLocaleTimeString();\r\n    const priorityClass = complaint.priority.replace(\" \", \"-\").toLowerCase();\r\n    const statusClass = complaint.status.replace(\" \", \"-\").toLowerCase();\r\n    const assignedOffices =\r\n      complaint.departments && complaint.departments.length > 0\r\n        ? complaint.departments.join(\", \")\r\n        : complaint.department || \"Not assigned\";\r\n\r\n    // Calculate days since submission\r\n    const daysSinceSubmission = Math.floor(\r\n      (Date.now() - new Date(complaint.submittedAt).getTime()) /\r\n        (1000 * 60 * 60 * 24)\r\n    );\r\n\r\n    // Check if user has access to this complaint\r\n    const hasAccess = await this.checkComplaintAccess(complaint);\r\n\r\n    if (!hasAccess) {\r\n      return `\r\n        <div class=\"complaint-detail-popup\" style=\"padding: 8px; font-size: 12px; line-height: 1.3; max-width: 280px;\">\r\n          <div class=\"popup-header\" style=\"margin: 0 0 6px 0; padding: 0;\">\r\n            <h3 style=\"margin: 0 0 4px 0; font-size: 13px; font-weight: bold;\">${\r\n  complaint.title\r\n}</h3>\r\n            <div class=\"complaint-badges\" style=\"display: flex; gap: 4px; margin: 0;\">\r\n              <span class=\"badge priority-${priorityClass}\" style=\"font-size: 9px; padding: 2px 4px;\">${complaint.priority.toUpperCase()}</span>\r\n              <span class=\"badge status-${statusClass}\" style=\"font-size: 9px; padding: 2px 4px;\">${complaint.status.toUpperCase()}</span>\r\n            </div>\r\n          </div>\r\n          <div class=\"popup-content\" style=\"margin: 0; padding: 0;\">\r\n            <div class=\"complaint-info\" style=\"margin: 0; padding: 0;\">\r\n              <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n                <span class=\"label\" style=\"font-weight: bold;\">Type:</span>\r\n                <span class=\"value\">${complaint.type}</span>\r\n              </div>\r\n              <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n                <span class=\"label\" style=\"font-weight: bold;\">Location:</span>\r\n                <span class=\"value\" style=\"text-align: right; max-width: 60%;\">${\r\n  complaint.location\r\n}</span>\r\n              </div>\r\n              <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n                <span class=\"label\" style=\"font-weight: bold;\">Assigned Offices:</span>\r\n                <span class=\"value\" style=\"text-align: right; max-width: 60%;\">${assignedOffices}</span>\r\n              </div>\r\n              <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n                <span class=\"label\" style=\"font-weight: bold;\">Submitted:</span>\r\n                <span class=\"value\">${submittedDate}</span>\r\n              </div>\r\n              <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n                <span class=\"label\" style=\"font-weight: bold;\">Days Open:</span>\r\n                <span class=\"value\">${daysSinceSubmission} day${\r\n  daysSinceSubmission !== 1 ? \"s\" : \"\"\r\n}</span>\r\n              </div>\r\n            </div>\r\n            <div class=\"popup-actions\" style=\"margin-top: 6px; padding-top: 6px; border-top: 1px solid #ddd;\">\r\n              <div class=\"access-denied\" style=\"font-size: 10px; color: #dc3545; text-align: center; padding: 4px;\">\r\n                <p style=\"margin: 0;\">🔒 Access restricted to assigned office</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      `;\r\n    }\r\n\r\n    return `\r\n      <div class=\"complaint-detail-popup\" style=\"padding: 8px; font-size: 12px; line-height: 1.3; max-width: 280px;\">\r\n        <div class=\"popup-header\" style=\"margin: 0 0 6px 0; padding: 0;\">\r\n          <h3 style=\"margin: 0 0 4px 0; font-size: 13px; font-weight: bold;\">${\r\n  complaint.title\r\n}</h3>\r\n          <div class=\"complaint-badges\" style=\"display: flex; gap: 4px; margin: 0;\">\r\n            <span class=\"badge priority-${priorityClass}\" style=\"font-size: 9px; padding: 2px 4px;\">${complaint.priority.toUpperCase()}</span>\r\n            <span class=\"badge status-${statusClass}\" style=\"font-size: 9px; padding: 2px 4px;\">${complaint.status.toUpperCase()}</span>\r\n          </div>\r\n        </div>\r\n        <div class=\"popup-content\" style=\"margin: 0; padding: 0;\">\r\n          <div class=\"complaint-info\" style=\"margin: 0; padding: 0;\">\r\n            <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n              <span class=\"label\" style=\"font-weight: bold;\">Type:</span>\r\n              <span class=\"value\">${complaint.type}</span>\r\n            </div>\r\n            <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n              <span class=\"label\" style=\"font-weight: bold;\">Location:</span>\r\n              <span class=\"value\" style=\"text-align: right; max-width: 60%;\">${\r\n  complaint.location\r\n}</span>\r\n            </div>\r\n            <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n              <span class=\"label\" style=\"font-weight: bold;\">Assigned Offices:</span>\r\n              <span class=\"value\" style=\"text-align: right; max-width: 60%;\">${assignedOffices}</span>\r\n            </div>\r\n            <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n              <span class=\"label\" style=\"font-weight: bold;\">Submitted:</span>\r\n              <span class=\"value\">${submittedDate}</span>\r\n            </div>\r\n            <div class=\"info-row\" style=\"margin: 2px 0; font-size: 11px; display: flex; justify-content: space-between;\">\r\n              <span class=\"label\" style=\"font-weight: bold;\">Days Open:</span>\r\n              <span class=\"value\">${daysSinceSubmission} day${\r\n  daysSinceSubmission !== 1 ? \"s\" : \"\"\r\n}</span>\r\n            </div>\r\n          </div>\r\n          <div class=\"popup-actions\" style=\"margin-top: 6px; padding-top: 6px; border-top: 1px solid #ddd; display: flex; gap: 4px;\">\r\n            <button class=\"btn-details\" onclick=\"viewComplaintDetails('${\r\n  complaint.id\r\n}')\" style=\"font-size: 10px; padding: 4px 8px; flex: 1;\">\r\n              📋 Details\r\n            </button>\r\n            <button class=\"btn-location\" onclick=\"centerOnComplaint(${\r\n  complaint.lat\r\n}, ${\r\n  complaint.lng\r\n})\" style=\"font-size: 10px; padding: 4px 8px; flex: 1;\">\r\n              📍 Center\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Check if user has access to view full details of a complaint\r\n   * @param {Object} complaint - Complaint data\r\n   * @returns {boolean} True if user has access\r\n   */\r\n  async checkComplaintAccess(complaint) {\r\n    try {\r\n      // Import getUserRole function\r\n      const { getUserRole } = await import(\"../../auth/authChecker.js\");\r\n      const userRole = await getUserRole();\r\n\r\n      // console.log removed for security\r\n      // console.log removed for security\r\n      // console.log removed for security\r\n\r\n      // Super admin has access to everything\r\n      if (userRole === \"super-admin\") {\r\n        // console.log removed for security\r\n        return true;\r\n      }\r\n\r\n      // Complaint coordinator has access to everything\r\n      if (userRole === \"complaint-coordinator\") {\r\n        // console.log removed for security\r\n        return true;\r\n      }\r\n\r\n      // With simplified roles, department is stored separately in metadata\r\n      let userDepartment = null;\r\n      if (userRole && [\"lgu\", \"lgu-admin\", \"lgu-hr\"].includes(userRole)) {\r\n        // Get department from user metadata\r\n        try {\r\n          const { supabase } = await import(\"../../config/config.js\");\r\n          const {\r\n            data: { session },\r\n          } = await supabase.auth.getSession();\r\n          const metadata =\r\n            session?.user?.raw_user_meta_data ||\r\n            session?.user?.user_metadata ||\r\n            {};\r\n          userDepartment = metadata.dpt || metadata.department;\r\n        } catch (error) {\r\n          console.warn(\"Failed to get department from metadata:\", error);\r\n        }\r\n      }\r\n\r\n      // console.log removed for security\r\n\r\n      if (!userDepartment) {\r\n        // console.log removed for security\r\n        return false;\r\n      }\r\n\r\n      // Check if complaint is assigned to user's department\r\n      const complaintDepartment = complaint.department?.toUpperCase();\r\n      const complaintDepartments = complaint.departments || [];\r\n      const secondaryDepartments = complaint.secondaryDepartments || [];\r\n\r\n      // Check primary department\r\n      if (complaintDepartment === userDepartment) {\r\n        // console.log removed for security\r\n        return true;\r\n      }\r\n\r\n      // Check if user's department is in the departments array\r\n      if (complaintDepartments.includes(userDepartment)) {\r\n        // console.log removed for security\r\n        return true;\r\n      }\r\n\r\n      // Check if user's department is in secondary departments\r\n      if (secondaryDepartments.includes(userDepartment)) {\r\n        // console.log removed for security\r\n        return true;\r\n      }\r\n\r\n      // Check if it's a joint/forced complaint (multiple departments)\r\n      if (complaintDepartment && complaintDepartment.includes(\",\")) {\r\n        const assignedDepartments = complaintDepartment\r\n          .split(\",\")\r\n          .map((dept) => dept.trim().toUpperCase());\r\n        if (assignedDepartments.includes(userDepartment)) {\r\n          // console.log removed for security\r\n          return true;\r\n        }\r\n      }\r\n\r\n      // console.log removed for security\r\n      return false;\r\n    } catch (error) {\r\n      console.error(\"[HEATMAP] Error checking complaint access:\", error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Perform DBSCAN clustering on complaint data\r\n   */\r\n  performClustering() {\r\n    try {\r\n      if (!this.complaintData || this.complaintData.length === 0) {\r\n        console.warn(\"[HEATMAP] No complaint data available for clustering\");\r\n        return { clusters: [], noise: [] };\r\n      }\r\n\r\n      // Ensure DBSCAN is initialized\r\n      if (!this.dbscan) {\r\n        console.error(\"[HEATMAP] DBSCAN not initialized\");\r\n        return { clusters: [], noise: [] };\r\n      }\r\n\r\n      // Update DBSCAN parameters\r\n      this.dbscan.eps = this.clusterConfig.eps;\r\n      this.dbscan.minPts = this.clusterConfig.minPts;\r\n\r\n      // Prepare points for clustering - filter out invalid coordinates\r\n      const points = this.complaintData\r\n        .filter((complaint) => {\r\n          const lat = parseFloat(complaint.lat);\r\n          const lng = parseFloat(complaint.lng);\r\n          return (\r\n            !isNaN(lat) &&\r\n            !isNaN(lng) &&\r\n            lat >= -90 &&\r\n            lat <= 90 &&\r\n            lng >= -180 &&\r\n            lng <= 180\r\n          );\r\n        })\r\n        .map((complaint) => ({\r\n          lat: parseFloat(complaint.lat),\r\n          lng: parseFloat(complaint.lng),\r\n          data: complaint,\r\n        }));\r\n\r\n      if (points.length === 0) {\r\n        console.warn(\"[HEATMAP] No valid coordinates for clustering\");\r\n        return { clusters: [], noise: [] };\r\n      }\r\n\r\n      // Perform clustering\r\n      const clusteringResult = this.dbscan.cluster(points);\r\n      this.clusters = clusteringResult.clusters || [];\r\n\r\n      return clusteringResult;\r\n    } catch (error) {\r\n      console.error(\"[HEATMAP] Clustering failed:\", error);\r\n      return { clusters: [], noise: [] };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create cluster visualization layer\r\n   */\r\n  createClusterLayer() {\r\n    if (!this.clusters || this.clusters.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    this.clusterLayer = L.layerGroup();\r\n\r\n    this.clusters.forEach((cluster, index) => {\r\n      const clusterPoints = cluster.map((i) => this.complaintData[i]);\r\n      const clusterCenter = this.calculateClusterCenter(clusterPoints);\r\n      const clusterRadius = this.calculateClusterRadius(\r\n        clusterPoints,\r\n        clusterCenter\r\n      );\r\n\r\n      // Create cluster circle\r\n      const clusterCircle = L.circle(clusterCenter, {\r\n        radius: clusterRadius * 1000, // Convert km to meters\r\n        color:\r\n          this.clusterConfig.clusterColors[\r\n            index % this.clusterConfig.clusterColors.length\r\n          ],\r\n        weight: 2,\r\n        opacity: 0.8,\r\n        fillOpacity: 0.2,\r\n      });\r\n\r\n      // Create cluster marker\r\n      const clusterMarker = L.marker(clusterCenter, {\r\n        icon: L.divIcon({\r\n          html: `<div style=\"\r\n            background-color: ${\r\n  this.clusterConfig.clusterColors[\r\n    index % this.clusterConfig.clusterColors.length\r\n  ]\r\n};\r\n            color: white;\r\n            border-radius: 50%;\r\n            width: 40px;\r\n            height: 40px;\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            font-weight: bold;\r\n            font-size: 16px;\r\n            border: 3px solid white;\r\n            box-shadow: 0 2px 6px rgba(0,0,0,0.3);\r\n          \">${cluster.length}</div>`,\r\n          className: \"cluster-marker\",\r\n          iconSize: [40, 40],\r\n          iconAnchor: [20, 20],\r\n        }),\r\n      });\r\n\r\n      // Create cluster popup\r\n      const popupContent = this.createClusterPopup(clusterPoints, index);\r\n      clusterMarker.bindPopup(popupContent, {\r\n        maxWidth: 400,\r\n        className: \"cluster-popup\",\r\n      });\r\n\r\n      this.clusterLayer.addLayer(clusterCircle);\r\n      this.clusterLayer.addLayer(clusterMarker);\r\n    });\r\n\r\n    // console.log removed for security\r\n    return this.clusterLayer;\r\n  }\r\n\r\n  /**\r\n   * Calculate cluster center (centroid)\r\n   * @param {Array} points - Array of complaint points\r\n   * @returns {Object} Center coordinates\r\n   */\r\n  calculateClusterCenter(points) {\r\n    const lat = points.reduce((sum, p) => sum + p.lat, 0) / points.length;\r\n    const lng = points.reduce((sum, p) => sum + p.lng, 0) / points.length;\r\n    return { lat, lng };\r\n  }\r\n\r\n  /**\r\n   * Calculate cluster radius\r\n   * @param {Array} points - Array of complaint points\r\n   * @param {Object} center - Cluster center\r\n   * @returns {number} Radius in kilometers\r\n   */\r\n  calculateClusterRadius(points, center) {\r\n    let maxDistance = 0;\r\n    points.forEach((point) => {\r\n      const distance = this.dbscan.calculateDistance(center, point);\r\n      maxDistance = Math.max(maxDistance, distance);\r\n    });\r\n    return maxDistance;\r\n  }\r\n\r\n  /**\r\n   * Create cluster popup content\r\n   * @param {Array} clusterPoints - Points in the cluster\r\n   * @param {number} clusterIndex - Cluster index\r\n   * @returns {string} HTML content\r\n   */\r\n  createClusterPopup(clusterPoints, clusterIndex) {\r\n    const statusCounts = {};\r\n    const typeCounts = {};\r\n    const priorityCounts = {};\r\n\r\n    clusterPoints.forEach((complaint) => {\r\n      statusCounts[complaint.status] =\r\n        (statusCounts[complaint.status] || 0) + 1;\r\n      typeCounts[complaint.type] = (typeCounts[complaint.type] || 0) + 1;\r\n      priorityCounts[complaint.priority] =\r\n        (priorityCounts[complaint.priority] || 0) + 1;\r\n    });\r\n\r\n    return `\r\n      <div class=\"cluster-popup-content\">\r\n        <h4>Cluster ${clusterIndex + 1} (${\r\n  clusterPoints.length\r\n} complaints)</h4>\r\n        <div class=\"cluster-stats\">\r\n          <h5>Status Distribution:</h5>\r\n          <ul>\r\n            ${Object.entries(statusCounts)\r\n    .map(([status, count]) => `<li>${status}: ${count}</li>`)\r\n    .join(\"\")}\r\n          </ul>\r\n          <h5>Type Distribution:</h5>\r\n          <ul>\r\n            ${Object.entries(typeCounts)\r\n    .map(([type, count]) => `<li>${type}: ${count}</li>`)\r\n    .join(\"\")}\r\n          </ul>\r\n          <h5>Priority Distribution:</h5>\r\n          <ul>\r\n            ${Object.entries(priorityCounts)\r\n    .map(([priority, count]) => `<li>${priority}: ${count}</li>`)\r\n    .join(\"\")}\r\n          </ul>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Show heatmap on map\r\n   */\r\n  showHeatmap() {\r\n    if (!this.heatmapLayer || !this.map) {\r\n      console.warn(\"[HEATMAP] Cannot show heatmap: layer or map is null\");\r\n      return;\r\n    }\r\n\r\n    const container =\r\n      typeof this.map.getContainer === \"function\"\r\n        ? this.map.getContainer()\r\n        : null;\r\n    const width = container?.offsetWidth || 0;\r\n    const height = container?.offsetHeight || 0;\r\n\r\n    // If the map container hasn't been laid out yet, retry shortly\r\n    if (width === 0 || height === 0) {\r\n      setTimeout(() => this.showHeatmap(), 150);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Ensure Leaflet recalculates sizes before drawing the heat canvas\r\n      this.map.invalidateSize();\r\n      this.heatmapLayer.addTo(this.map);\r\n      // console.log removed for security\r\n\r\n      // Verify it's actually on the map\r\n      setTimeout(() => {\r\n        const _hasLayer = this.map._hasLayer(this.heatmapLayer);\r\n        // console.log removed for security\r\n      }, 100);\r\n    } catch (e) {\r\n      console.error(\"[HEATMAP] Error showing heatmap:\", e);\r\n      // Fallback: retry once after a brief delay if canvas was still 0-sized\r\n      setTimeout(() => {\r\n        try {\r\n          this.map.invalidateSize();\r\n          this.heatmapLayer.addTo(this.map);\r\n          // console.log removed for security\r\n        } catch (error) {\r\n          console.error(\"[HEATMAP] Failed to show heatmap on retry:\", error);\r\n        }\r\n      }, 200);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Hide heatmap from map\r\n   */\r\n  hideHeatmap() {\r\n    if (this.heatmapLayer && this.map.hasLayer(this.heatmapLayer)) {\r\n      this.map.removeLayer(this.heatmapLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show markers on map\r\n   */\r\n  showMarkers() {\r\n    if (!this.markerLayer) {\r\n      console.warn(\"[HEATMAP] Cannot show markers: markerLayer is null\");\r\n      return;\r\n    }\r\n\r\n    if (!this.map) {\r\n      console.warn(\"[HEATMAP] Cannot show markers: map is null\");\r\n      return;\r\n    }\r\n\r\n    // console.log removed for security\r\n    this.markerLayer.addTo(this.map);\r\n\r\n    // Verify markers are actually on the map\r\n    setTimeout(() => {\r\n      const hasLayer = this.map.hasLayer(this.markerLayer);\r\n      const layerCount = this.markerLayer.getLayers().length;\r\n      // console.log removed for security\r\n\r\n      if (hasLayer && layerCount > 0) {\r\n        // Get bounds of all markers to verify they're valid\r\n        try {\r\n          const layers = this.markerLayer.getLayers();\r\n          if (layers.length > 0) {\r\n            const firstMarker = layers[0];\r\n            if (firstMarker && firstMarker.getLatLng) {\r\n              const _latLng = firstMarker.getLatLng();\r\n              // console.log removed for security\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.warn(\"[HEATMAP] Could not get marker bounds:\", error);\r\n        }\r\n      }\r\n    }, 100);\r\n  }\r\n\r\n  /**\r\n   * Hide markers from map (but keep them in the layer for later use)\r\n   */\r\n  hideMarkers() {\r\n    if (this.markerLayer && this.markerLayer.getLayers) {\r\n      try {\r\n        // Remove each marker individually from map (but keep in layer)\r\n        const layers = this.markerLayer.getLayers();\r\n        layers.forEach((layer) => {\r\n          if (\r\n            layer &&\r\n            this.map &&\r\n            this.map.hasLayer &&\r\n            this.map.hasLayer(layer)\r\n          ) {\r\n            this.map.removeLayer(layer);\r\n          }\r\n        });\r\n        // Remove the layer group from map if attached\r\n        if (\r\n          this.map &&\r\n          this.map.hasLayer &&\r\n          this.map.hasLayer(this.markerLayer)\r\n        ) {\r\n          this.map.removeLayer(this.markerLayer);\r\n        }\r\n        // DO NOT clear markers from the layer - we want to keep them for when zoom > 11\r\n        // this.markerLayer.clearLayers(); // REMOVED - this was causing markers to disappear\r\n      } catch (error) {\r\n        console.warn(\"[HEATMAP] Error hiding markers:\", error);\r\n        // Fallback: just remove the layer from map\r\n        if (this.map && this.map.removeLayer) {\r\n          try {\r\n            this.map.removeLayer(this.markerLayer);\r\n          } catch (e) {\r\n            // Ignore if already removed\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update marker sizes and colors based on current zoom level and complaint data\r\n   * This ensures markers reflect current status and priority\r\n   */\r\n  updateMarkerSizes() {\r\n    if (!this.markerLayer || !this.map) return;\r\n\r\n    const markers = this.markerLayer.getLayers();\r\n    markers.forEach((marker, index) => {\r\n      // Get the original complaint data from marker's lat/lng\r\n      const latLng = marker.getLatLng();\r\n      const complaint = this.complaintData.find(\r\n        (c) =>\r\n          Math.abs(c.lat - latLng.lat) < 0.0001 &&\r\n          Math.abs(c.lng - latLng.lng) < 0.0001\r\n      );\r\n\r\n      if (complaint) {\r\n        // Create new icon with updated size and color based on current zoom and complaint status\r\n        const newIcon = this.getComplaintIcon(complaint, index);\r\n        marker.setIcon(newIcon);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update a specific marker's appearance when complaint data changes\r\n   * @param {string} complaintId - ID of the complaint to update\r\n   */\r\n  updateMarker(complaintId) {\r\n    if (!this.markerLayer || !this.map) return;\r\n\r\n    const complaint = this.complaintData.find((c) => c.id === complaintId);\r\n    if (!complaint) return;\r\n\r\n    const markers = this.markerLayer.getLayers();\r\n    const marker = markers.find((m) => {\r\n      const latLng = m.getLatLng();\r\n      return (\r\n        Math.abs(complaint.lat - latLng.lat) < 0.0001 &&\r\n        Math.abs(complaint.lng - latLng.lng) < 0.0001\r\n      );\r\n    });\r\n\r\n    if (marker) {\r\n      const index = markers.indexOf(marker);\r\n      const newIcon = this.getComplaintIcon(complaint, index);\r\n      marker.setIcon(newIcon);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Refresh all markers to reflect current complaint data (status, priority, etc.)\r\n   * Useful when complaint data is updated externally\r\n   */\r\n  refreshMarkers() {\r\n    if (!this.markerLayer || !this.map) return;\r\n\r\n    // Hide and recreate marker layer to ensure all markers reflect current data\r\n    this.hideMarkers();\r\n    this.createMarkerLayer();\r\n    this.showMarkers();\r\n  }\r\n\r\n  /**\r\n   * Show circles on map\r\n   */\r\n  showCircles() {\r\n    if (this.circleLayer) {\r\n      this.circleLayer.addTo(this.map);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Hide circles from map\r\n   */\r\n  hideCircles() {\r\n    if (this.circleLayer && this.map.hasLayer(this.circleLayer)) {\r\n      this.map.removeLayer(this.circleLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show clusters on map\r\n   */\r\n  showClusters() {\r\n    if (this.clusterLayer) {\r\n      this.clusterLayer.addTo(this.map);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Hide clusters from map\r\n   */\r\n  hideClusters() {\r\n    if (this.clusterLayer && this.map.hasLayer(this.clusterLayer)) {\r\n      this.map.removeLayer(this.clusterLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update clustering parameters\r\n   * @param {number} eps - Epsilon parameter\r\n   * @param {number} minPts - Minimum points parameter\r\n   */\r\n  updateClusteringParameters(eps, minPts) {\r\n    this.clusterConfig.eps = eps;\r\n    this.clusterConfig.minPts = minPts;\r\n\r\n    // Re-cluster if clustering is enabled\r\n    if (this.isClusteringEnabled) {\r\n      this.performClustering();\r\n      this.hideClusters();\r\n      this.createClusterLayer();\r\n      this.showClusters();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Toggle clustering on/off\r\n   * @param {boolean} enabled - Whether clustering should be enabled\r\n   */\r\n  toggleClustering(enabled) {\r\n    this.isClusteringEnabled = enabled;\r\n\r\n    if (enabled) {\r\n      this.performClustering();\r\n      this.createClusterLayer();\r\n      this.showClusters();\r\n    } else {\r\n      this.hideClusters();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get clustering statistics\r\n   * @returns {Object} Statistics about current clustering\r\n   */\r\n  getClusteringStatistics() {\r\n    if (!this.clusters || this.clusters.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    return this.dbscan.calculateStatistics(\r\n      this.complaintData.map((c) => ({ lat: c.lat, lng: c.lng })),\r\n      { clusters: this.clusters, noise: [] }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Clear all layers from map\r\n   */\r\n  clearAllLayers() {\r\n    this.hideHeatmap();\r\n    this.hideMarkers();\r\n    this.hideCircles();\r\n    this.hideClusters();\r\n  }\r\n\r\n  /**\r\n   * Refresh visualization with current data\r\n   */\r\n  refresh() {\r\n    this.clearAllLayers();\r\n\r\n    if (this.complaintData.length > 0) {\r\n      this.createHeatmapLayer();\r\n      this.createMarkerLayer();\r\n\r\n      if (this.isClusteringEnabled) {\r\n        this.performClustering();\r\n        this.createClusterLayer();\r\n        this.showClusters();\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Export for use in other modules\r\nif (typeof module !== \"undefined\" && module.exports) {\r\n  module.exports = HeatmapVisualization;\r\n} else {\r\n  window.HeatmapVisualization = HeatmapVisualization;\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\map\\map-generator.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\notification.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'brandConfig' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":21},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":321,"column":27,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":322,"endColumn":72}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Notification component with lazy loading functionality\r\nimport { brandConfig } from \"../config/index.js\";\r\nimport apiClient from \"../config/apiClient.js\";\r\nimport { getNotificationIcon } from \"../utils/icons.js\";\r\n\r\n// Notification state management\r\nconst notificationState = {\r\n  page: 0,\r\n  limit: 10,\r\n  hasMore: true,\r\n  loading: false,\r\n  notifications: [],\r\n  isFirstLoad: true,\r\n  lastNotificationId: null\r\n};\r\n// Real-time polling interval (30 seconds)\r\nlet pollingInterval = null;\r\nconst POLLING_INTERVAL_MS = 30000;\r\n// Initialize notification button functionality\r\n\r\nexport function initializeNotificationButton() {\r\n  // console.log removed for security\r\n  const notificationBtn = document.getElementById(\"notification-btn\");\r\n  const notificationPanel = document.getElementById(\"notification-panel\");\r\n  const closeBtn = document.getElementById(\"close-notifications\");\r\n  const markAllReadBtn = document.getElementById(\"mark-all-read\");\r\n  const showMoreBtn = document.getElementById(\"show-more-notifications\");\r\n  const retryBtn = document.getElementById(\"retry-notifications\");\r\n  if (notificationBtn && notificationPanel) {\r\n    // console.log removed for security\r\n    // console.log removed for security\r\n    // console.log removed for security\r\n    // Toggle notification panel with smooth animations\r\n    notificationBtn.addEventListener(\"click\", (e) => {\r\n      // console.log removed for security\r\n      e.stopPropagation();\r\n      // Close profile panel if open\r\n      const profilePanel = document.getElementById(\"profile-panel\");\r\n      if (profilePanel && profilePanel.classList.contains(\"show\")) {\r\n        profilePanel.classList.remove(\"show\");\r\n        profilePanel.style.opacity = \"0\";\r\n        profilePanel.style.transform = \"translateY(-10px)\";\r\n        setTimeout(() => {\r\n          profilePanel.style.display = \"none\";\r\n        }, 300);\r\n      }\r\n      // Toggle notification panel with smooth animation\r\n      if (notificationPanel.classList.contains(\"show\")) {\r\n        // Close\r\n        notificationPanel.classList.remove(\"show\");\r\n        notificationPanel.style.opacity = \"0\";\r\n        notificationPanel.style.transform = \"translateY(-10px)\";\r\n        setTimeout(() => {\r\n          notificationPanel.style.display = \"none\";\r\n        }, 300);\r\n      } else {\r\n        // Open\r\n        notificationPanel.classList.add(\"show\");\r\n        notificationPanel.style.display = \"block\";\r\n        setTimeout(() => {\r\n          notificationPanel.style.opacity = \"1\";\r\n          notificationPanel.style.transform = \"translateY(0)\";\r\n        }, 10);\r\n      }\r\n      // console.log removed for security\r\n      // console.log removed for security\r\n      // Debug positioning\r\n      if (notificationPanel.classList.contains(\"show\")) {\r\n        const _rect = notificationPanel.getBoundingClientRect();\r\n        // console.log removed for security\r\n      }\r\n      // Load notifications when panel is opened (only show loading on first load)\r\n      if (notificationPanel.classList.contains(\"show\")) {\r\n        loadNotifications(true, notificationState.isFirstLoad);\r\n      }\r\n    });\r\n    // Close panel when close button is clicked\r\n    if (closeBtn) {\r\n      closeBtn.addEventListener(\"click\", (e) => {\r\n        e.stopPropagation();\r\n        notificationPanel.classList.remove(\"show\");\r\n      });\r\n    }\r\n    // Mark all as read functionality\r\n    if (markAllReadBtn) {\r\n      markAllReadBtn.addEventListener(\"click\", () => {\r\n        markAllNotificationsAsRead();\r\n      });\r\n    }\r\n    // Show more notifications\r\n    if (showMoreBtn) {\r\n      showMoreBtn.addEventListener(\"click\", () => {\r\n        loadNotifications(false, false); // Don't show loading for \"Show More\"\r\n      });\r\n    }\r\n\r\n    // Retry loading notifications\r\n    if (retryBtn) {\r\n      retryBtn.addEventListener(\"click\", () => {\r\n        loadNotifications(true, true); // Show loading for retry\r\n      });\r\n    }\r\n    // Close panel when clicking outside\r\n    document.addEventListener(\"click\", (e) => {\r\n      if (!notificationPanel.contains(e.target) && !notificationBtn.contains(e.target)) {\r\n        notificationPanel.classList.remove(\"show\");\r\n      }\r\n    });\r\n    // Initial notification count load\r\n    loadUnreadCount();\r\n    // Start real-time polling for unread count\r\n    startPolling();\r\n  }\r\n}\r\n// Close notification panel (exported for use by other components)\r\n\r\nexport function closeNotificationPanel() {\r\n  const notificationPanel = document.getElementById(\"notification-panel\");\r\n  if (notificationPanel && notificationPanel.classList.contains(\"show\")) {\r\n    notificationPanel.classList.remove(\"show\");\r\n  }\r\n}\r\n// Start real-time polling\r\nfunction startPolling() {\r\n  // Clear any existing interval\r\n  if (pollingInterval) {\r\n    clearInterval(pollingInterval);\r\n  }\r\n  // Poll every 30 seconds\r\n  pollingInterval = setInterval(() => {\r\n    loadUnreadCount();\r\n    checkForNewNotifications();\r\n  }, POLLING_INTERVAL_MS);\r\n}\r\n// Stop polling (cleanup)\r\n\r\nexport function stopPolling() {\r\n\r\n  if (pollingInterval) {\r\n    clearInterval(pollingInterval);\r\n    pollingInterval = null;\r\n  }\r\n}\r\n// Track consecutive connection errors\r\nlet connectionErrorCount = 0;\r\n\r\n// Load unread count\r\nasync function loadUnreadCount() {\r\n  try {\r\n    const response = await apiClient.get(\"/api/notifications/count\");\r\n    if (response?.success) {\r\n      updateNotificationCount(response.count);\r\n      // Reset connection error state on success\r\n      connectionErrorCount = 0;\r\n    } else if (response?.connectionError) {\r\n      // Handle connection errors gracefully\r\n      connectionErrorCount++;\r\n      // If we've had multiple connection errors, stop polling temporarily\r\n      if (connectionErrorCount >= 3) {\r\n        console.warn(\"[NOTIFICATION] Multiple connection errors detected. Stopping polling.\");\r\n        stopPolling();\r\n        // Try to restart polling after a longer delay (5 minutes)\r\n        setTimeout(() => {\r\n          console.log(\"[NOTIFICATION] Attempting to restart polling...\");\r\n          connectionErrorCount = 0;\r\n          startPolling();\r\n        }, 5 * 60 * 1000);\r\n      }\r\n    }\r\n  } catch (error) {\r\n    // Only log non-connection errors\r\n    if (!error.message?.includes(\"Failed to fetch\") &&\r\n        !error.message?.includes(\"ERR_CONNECTION_REFUSED\")) {\r\n      console.error(\"[NOTIFICATION] Failed to load unread count:\", error);\r\n    }\r\n  }\r\n}\r\n// Check for new notifications and add them to the top\r\nasync function checkForNewNotifications() {\r\n  try {\r\n    // Only check if we have notifications loaded and a last notification ID\r\n    if (notificationState.notifications.length === 0 || !notificationState.lastNotificationId) {\r\n      return;\r\n    }\r\n    // Fetch only the latest notification to check if there are new ones\r\n    const response = await apiClient.get(\"/api/notifications/latest?limit=1\");\r\n    if (response.success && response.notifications && response.notifications.length > 0) {\r\n      const latestNotification = response.notifications[0];\r\n      // If this is a new notification (different ID than our last one)\r\n      if (latestNotification.id !== notificationState.lastNotificationId) {\r\n        // console.log removed for security\r\n        // Add the new notification to the top of the list\r\n        notificationState.notifications.unshift(latestNotification);\r\n        // Update the last notification ID\r\n        notificationState.lastNotificationId = latestNotification.id;\r\n        // Re-render notifications\r\n        renderNotifications();\r\n        updateNotificationCount(notificationState.notifications.filter(n => !n.read).length);\r\n        // Show a subtle indicator that new notifications were added\r\n        showNewNotificationIndicator();\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[NOTIFICATION] Failed to check for new notifications:\", error);\r\n  }\r\n}\r\n// Show a subtle indicator that new notifications were added\r\nfunction showNewNotificationIndicator() {\r\n  const notificationPanel = document.getElementById(\"notification-panel\");\r\n  if (!notificationPanel) return;\r\n  // Add a subtle animation to indicate new content\r\n  notificationPanel.style.transform = \"scale(1.02)\";\r\n  setTimeout(() => {\r\n    notificationPanel.style.transform = \"scale(1)\";\r\n  }, 200);\r\n}\r\n// Load notifications with lazy loading\r\nasync function loadNotifications(reset = false, showLoading = true) {\r\n  if (notificationState.loading) return;\r\n  if (reset) {\r\n    notificationState.page = 0;\r\n    notificationState.notifications = [];\r\n    notificationState.hasMore = true;\r\n  }\r\n  if (!notificationState.hasMore) return;\r\n  notificationState.loading = true;\r\n  // Only show loading indicator on first load or when explicitly requested\r\n  if (showLoading) {\r\n    showLoadingState(true);\r\n  }\r\n  hideErrorState();\r\n  try {\r\n    // Simulate API call - replace with actual API endpoint\r\n    const response = await fetchNotifications(notificationState.page, notificationState.limit);\r\n    if (response.success) {\r\n      const newNotifications = response.data.notifications;\r\n      const {hasMore} = response.data;\r\n      // Add new notifications to the top of the list\r\n      if (reset) {\r\n        notificationState.notifications = newNotifications;\r\n      } else {\r\n        // Merge new notifications, keeping existing ones and adding new ones to the top\r\n        const existingIds = new Set(notificationState.notifications.map(n => n.id));\r\n        const trulyNewNotifications = newNotifications.filter(n => !existingIds.has(n.id));\r\n        notificationState.notifications = [...trulyNewNotifications, ...notificationState.notifications];\r\n      }\r\n      notificationState.hasMore = hasMore;\r\n      notificationState.page++;\r\n      // Update last notification ID for future checks\r\n      if (newNotifications.length > 0) {\r\n        notificationState.lastNotificationId = newNotifications[0].id;\r\n      }\r\n      renderNotifications();\r\n      updateShowMoreButton();\r\n      updateNotificationCount(notificationState.notifications.filter(n => !n.read).length);\r\n      // Mark first load as complete\r\n      notificationState.isFirstLoad = false;\r\n    } else {\r\n      showErrorState();\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error loading notifications:\", error);\r\n    showErrorState();\r\n  } finally {\r\n    notificationState.loading = false;\r\n    if (showLoading) {\r\n      showLoadingState(false);\r\n    }\r\n  }\r\n}\r\n// Fetch notifications from API\r\nasync function fetchNotifications(page, limit) {\r\n  try {\r\n    const response = await apiClient.get(`/api/notifications/unread?limit=${limit}&offset=${page * limit}`);\r\n    if (!response.success) {\r\n      throw new Error(\"Failed to fetch notifications\");\r\n    }\r\n    // Format created_at to relative time\r\n    const formattedNotifications = response.notifications.map(notif => ({\r\n      ...notif,\r\n      time: formatRelativeTime(notif.created_at),\r\n      read: notif.read\r\n    }));\r\n    return {\r\n      success: true,\r\n      data: {\r\n        notifications: formattedNotifications,\r\n        hasMore: formattedNotifications.length === limit\r\n      }\r\n    };\r\n  } catch (error) {\r\n    console.error(\"[NOTIFICATION] Fetch error:\", error);\r\n    throw error;\r\n  }\r\n}\r\n// Format timestamp to relative time (e.g., \"2 minutes ago\")\r\nfunction formatRelativeTime(timestamp) {\r\n  const now = new Date();\r\n  const time = new Date(timestamp);\r\n  const diffMs = now - time;\r\n  const diffSecs = Math.floor(diffMs / 1000);\r\n  const diffMins = Math.floor(diffSecs / 60);\r\n  const diffHours = Math.floor(diffMins / 60);\r\n  const diffDays = Math.floor(diffHours / 24);\r\n  if (diffSecs < 60) return \"Just now\";\r\n  if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? \"s\" : \"\"} ago`;\r\n  if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? \"s\" : \"\"} ago`;\r\n  if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? \"s\" : \"\"} ago`;\r\n  if (diffDays < 30) return `${Math.floor(diffDays / 7)} week${Math.floor(diffDays / 7) !== 1 ? \"s\" : \"\"} ago`;\r\n  return time.toLocaleDateString();\r\n}\r\n// Render notifications in the UI\r\nfunction renderNotifications() {\r\n  const content = document.getElementById(\"notification-content\");\r\n  if (!content) return;\r\n  if (notificationState.notifications.length === 0) {\r\n    content.innerHTML = '<div class=\"no-notifications\">No notifications yet</div>';\r\n    return;\r\n  }\r\n  const html = notificationState.notifications.map((notification, index) => {\r\n    const priorityClass = notification.priority === \"urgent\" ? \"notification-urgent\" :\r\n      notification.priority === \"warning\" ? \"notification-warning\" : \"\";\r\n    const linkAttr = notification.link ? `data-link=\"${notification.link}\"` : \"\";\r\n    // Add \"new\" indicator for recent notifications (first 3 items)\r\n    const isNew = index < 3 && !notification.read;\r\n    const newIndicator = isNew ? '<div class=\"new-indicator\">NEW</div>' : \"\";\r\n    return `\r\n      <div class=\"notification-item ${notification.read ? \"read\" : \"\"} ${priorityClass} ${isNew ? \"new-notification\" : \"\"}\" \r\n           data-id=\"${notification.id}\" \r\n           ${linkAttr}\r\n           style=\"cursor: ${notification.link ? \"pointer\" : \"default\"}\">\r\n        <div class=\"notification-icon\">${getNotificationIcon(notification.type, { size: 20 })}</div>\r\n        <div class=\"notification-text\">\r\n          <div class=\"notification-title\">${escapeHtml(notification.title)} ${newIndicator}</div>\r\n          <div class=\"notification-message\">${escapeHtml(notification.message)}</div>\r\n          <div class=\"notification-time\">${notification.time}</div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }).join(\"\");\r\n  content.innerHTML = html;\r\n  // Add click handlers for notifications with links\r\n  content.querySelectorAll(\".notification-item[data-link]\").forEach(item => {\r\n    item.addEventListener(\"click\", async function() {\r\n      const notifId = this.dataset.id;\r\n      const {link} = this.dataset;\r\n      // Mark as read\r\n      try {\r\n        await apiClient.post(`/api/notifications/${notifId}/mark-read`);\r\n        this.classList.add(\"read\");\r\n        loadUnreadCount();\r\n      } catch (error) {\r\n        console.warn(\"[NOTIFICATION] Failed to mark as read:\", error);\r\n      }\r\n      // Navigate to link\r\n      if (link) {\r\n        closeNotificationPanel();\r\n        window.location.href = link;\r\n      }\r\n    });\r\n  });\r\n}\r\n// Escape HTML to prevent XSS\r\nfunction escapeHtml(text) {\r\n  const div = document.createElement(\"div\");\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n// Update show more button state\r\nfunction updateShowMoreButton() {\r\n  const showMoreBtn = document.getElementById(\"show-more-notifications\");\r\n  if (!showMoreBtn) return;\r\n  if (!notificationState.hasMore) {\r\n    showMoreBtn.style.display = \"none\";\r\n  } else {\r\n    showMoreBtn.style.display = \"block\";\r\n    showMoreBtn.textContent = notificationState.loading ? \"Loading...\" : \"Show More\";\r\n    showMoreBtn.disabled = notificationState.loading;\r\n  }\r\n}\r\n// Show/hide loading state\r\nfunction showLoadingState(show) {\r\n  const loading = document.getElementById(\"notification-loading\");\r\n  if (loading) {\r\n    loading.classList.toggle(\"hidden\", !show);\r\n  }\r\n}\r\n// Show/hide error state\r\nfunction showErrorState() {\r\n  const error = document.getElementById(\"notification-error\");\r\n  if (error) {\r\n    error.classList.remove(\"hidden\");\r\n  }\r\n}\r\nfunction hideErrorState() {\r\n  const error = document.getElementById(\"notification-error\");\r\n  if (error) {\r\n    error.classList.add(\"hidden\");\r\n  }\r\n}\r\n// Mark all notifications as read\r\nasync function markAllNotificationsAsRead() {\r\n  try {\r\n    const response = await apiClient.post(\"/api/notifications/mark-all-read\");\r\n    if (response.success) {\r\n      // Update local state\r\n      notificationState.notifications.forEach(notification => {\r\n        notification.read = true;\r\n      });\r\n      renderNotifications();\r\n      updateNotificationCount(0);\r\n      // Close panel\r\n      const notificationPanel = document.getElementById(\"notification-panel\");\r\n      if (notificationPanel) {\r\n        notificationPanel.classList.remove(\"show\");\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[NOTIFICATION] Failed to mark all as read:\", error);\r\n  }\r\n}\r\n// Function to update notification count\r\n\r\nexport function updateNotificationCount(count) {\r\n  const notificationBadge = document.getElementById(\"notification-badge\");\r\n  if (notificationBadge) {\r\n\r\n    if (count > 0) {\r\n      notificationBadge.textContent = count > 99 ? \"99+\" : count;\r\n      notificationBadge.classList.remove(\"hidden\");\r\n    } else {\r\n      notificationBadge.classList.add(\"hidden\");\r\n    }\r\n  }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\sidebar.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\success.js","messages":[{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":108,"column":27,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":110,"endColumn":49},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":109,"column":11,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":110,"endColumn":49},{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":277,"column":13,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":277,"endColumn":27},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":282,"column":36,"nodeType":"CallExpression","messageId":"returnsValue","endLine":282,"endColumn":54,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[11417,11435],"text":"{setTimeout(r, 300)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":285,"column":15,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":285,"endColumn":29},{"ruleId":"no-unreachable","severity":2,"message":"Unreachable code.","line":438,"column":7,"nodeType":"IfStatement","messageId":"unreachableCode","endLine":452,"endColumn":15},{"ruleId":"no-unreachable","severity":2,"message":"Unreachable code.","line":453,"column":7,"nodeType":"ReturnStatement","messageId":"unreachableCode","endLine":453,"endColumn":14},{"ruleId":"no-alert","severity":1,"message":"Unexpected alert.","line":533,"column":9,"nodeType":"CallExpression","messageId":"unexpected","endLine":533,"endColumn":63},{"ruleId":"no-alert","severity":1,"message":"Unexpected alert.","line":541,"column":5,"nodeType":"CallExpression","messageId":"unexpected","endLine":541,"endColumn":53}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// IMMEDIATE LOGGING - Should run before any imports\nconsole.log(\"========================================\");\nconsole.log(\"[SUCCESS] ✅ MODULE FILE LOADED\");\nconsole.log(\"[SUCCESS] Script file loaded at:\", new Date().toISOString());\nconsole.log(\"[SUCCESS] Current URL:\", window.location.href);\nconsole.log(\"[SUCCESS] Pathname:\", window.location.pathname);\nconsole.log(\"[SUCCESS] Search:\", window.location.search);\nconsole.log(\"[SUCCESS] Hash:\", window.location.hash);\nconsole.log(\"========================================\");\n\nimport { supabase } from \"../config/config.js\";\nimport { saveUserMeta, setOAuthContext, clearOAuthContext, getOAuthContext } from \"../auth/authChecker.js\";\n\nconsole.log(\"[SUCCESS] ✅ Imports completed successfully\");\n\nconst run = async () => {\n  console.log(\"[SUCCESS] ========================================\");\n  console.log(\"[SUCCESS] Success page loaded\");\n  console.log(\"[SUCCESS] URL:\", window.location.href);\n  console.log(\"[SUCCESS] Timestamp:\", new Date().toISOString());\n\n  const urlParams = new URLSearchParams(window.location.search);\n  const isPopupFlow = urlParams.get(\"popup\") === \"1\" || Boolean(window.opener);\n  const oauthContext = getOAuthContext() || {};\n\n  console.log(\"[SUCCESS] Flow check:\", {\n    isPopupFlow,\n    hasOpener: Boolean(window.opener),\n    oauthContext,\n    localStorageOAuth: localStorage.getItem(\"cl_oauth_context\")\n  });\n\n  const notifyExistingUser = async () => {\n    try {\n      await supabase.auth.signOut();\n    } catch {}\n    try {\n      await fetch(\"/auth/session\", { method: \"DELETE\" });\n    } catch {}\n    clearOAuthContext();\n    if (window.opener) {\n      window.opener.postMessage({ type: \"oauth-user-exists\" }, window.location.origin);\n      setTimeout(() => {\n        try { window.close(); } catch {}\n      }, 200);\n    } else {\n      window.location.href = \"/login?err=user_exists\";\n    }\n  };\n  try {\n    // Check for error or success messages in URL hash\n    if (window.location.hash) {\n      const hashParams = new URLSearchParams(window.location.hash.substring(1));\n      const error = hashParams.get(\"error\");\n      const errorCode = hashParams.get(\"error_code\");\n      const errorDescription = hashParams.get(\"error_description\");\n      const message = hashParams.get(\"message\");\n      const type = hashParams.get(\"type\") || (error || errorCode ? \"error\" : \"success\");\n\n      // Import toast module\n      const { default: showMessage } = await import(\"./toast.js\");\n\n      // Handle error messages\n      if (error || errorCode) {\n        // Determine error message based on error code\n        let errorMessage = \"An error occurred\";\n        if (errorCode === \"otp_expired\") {\n          errorMessage = \"The email link has expired. Please request a new one.\";\n        } else if (errorCode === \"access_denied\") {\n          errorMessage = \"Access denied. The link may be invalid or expired.\";\n        } else if (errorDescription) {\n          // Decode URL-encoded description\n          errorMessage = decodeURIComponent(errorDescription.replace(/\\+/g, \" \"));\n        } else if (error) {\n          errorMessage = `Authentication error: ${error}`;\n        }\n\n        // Show error toast\n        showMessage(\"error\", errorMessage, 8000);\n\n        // Clean up URL hash\n        window.history.replaceState({}, document.title, window.location.pathname + window.location.search);\n\n        // Redirect to appropriate page based on error\n        if (errorCode === \"otp_expired\") {\n          // For expired OTP, redirect to login or appropriate page\n          setTimeout(() => {\n            window.location.href = \"/login\";\n          }, 3000);\n        } else {\n          // For other errors, redirect to login\n          setTimeout(() => {\n            window.location.href = \"/login\";\n          }, 3000);\n        }\n        return; // Exit early, don't process success flow\n      }\n\n      // Handle success messages\n      if (message) {\n        // Decode URL-encoded message (handle both + and %20 for spaces)\n        let decodedMessage = decodeURIComponent(message.replace(/\\+/g, \" \"));\n\n        // Clean up any trailing delimiters (pipe, semicolon, etc.)\n        decodedMessage = decodedMessage.replace(/[|;]$/, \"\").trim();\n\n        // Determine toast type (success, info, warning, error)\n        const toastType = type === \"error\" ? \"error\" :\n          type === \"warning\" ? \"warning\" :\n            type === \"info\" ? \"info\" : \"success\";\n\n        // Show success/info toast\n        showMessage(toastType, decodedMessage, 8000);\n\n        // Clean up URL hash\n        window.history.replaceState({}, document.title, window.location.pathname + window.location.search);\n\n        // Don't return here - continue with normal flow to process session\n      }\n    }\n\n    // After OAuth or email confirmation, Supabase sets a session\n    console.log(\"[SUCCESS] Checking session...\");\n\n    // CRITICAL: Check OAuth context BEFORE processing - it might be lost during redirect\n    let oauthContext = getOAuthContext() || {};\n    console.log(\"[SUCCESS] Initial OAuth context check (before session):\", oauthContext);\n    console.log(\"[SUCCESS] localStorage OAuth context:\", localStorage.getItem(\"cl_oauth_context\"));\n\n    const { data: { session }, error: sessionError } = await supabase.auth.getSession();\n    console.log(\"[SUCCESS] Session check:\", {\n      hasSession: Boolean(session),\n      hasError: Boolean(sessionError),\n      error: sessionError?.message\n    });\n\n    const user = session?.user;\n    const accessToken = session?.access_token || null;\n    const role = user?.user_metadata?.role || user?.raw_user_meta_data?.role || null;\n    const name = user?.user_metadata?.name || user?.raw_user_meta_data?.name || null;\n    const email = user?.email || null;\n\n    console.log(\"[SUCCESS] User data:\", {\n      userId: user?.id,\n      email,\n      role: role || \"missing\",\n      name: name || \"missing\",\n      hasAccessToken: Boolean(accessToken)\n    });\n\n    if (role || name) saveUserMeta({ role, name });\n    // Track provider\n    const provider = user?.identities?.[0]?.provider || null;\n    console.log(\"[SUCCESS] OAuth provider:\", provider);\n\n    if (provider) {\n      console.log(\"[SUCCESS] Updating OAuth context with provider:\", provider);\n      // Preserve existing OAuth context (especially intent) if it exists\n      const existingContext = getOAuthContext() || {};\n      const updatedContext = {\n        ...existingContext,\n        provider,\n        email: email || existingContext.email,\n        // Preserve intent if it exists, otherwise we'll infer it later\n        intent: existingContext.intent,\n        status: existingContext.status || \"pending\"\n      };\n      console.log(\"[SUCCESS] Updated OAuth context:\", updatedContext);\n      setOAuthContext(updatedContext);\n\n      // merge into oauth_providers array\n      try {\n        const currentProviders = Array.isArray(user?.user_metadata?.oauth_providers)\n          ? user.user_metadata.oauth_providers\n          : [];\n        const nextProviders = Array.from(new Set([...currentProviders, provider]));\n        await supabase.auth.updateUser({ data: { oauth_providers: nextProviders } });\n        console.log(\"[SUCCESS] Updated OAuth providers:\", nextProviders);\n      } catch (error) {\n        console.error(\"[SUCCESS] Error updating OAuth providers:\", error);\n      }\n    }\n    const userMetadata = user?.user_metadata || {};\n    const rawMetadata = user?.raw_user_meta_data || {};\n    const combinedMetadata = { ...userMetadata, ...rawMetadata };\n\n    const hasFullProfile = Boolean(\n      (combinedMetadata.mobile_number || combinedMetadata.mobile || user?.phone) &&\n      (role || combinedMetadata.role)\n    );\n\n    // Check if user has completed registration\n    const hasMobile = combinedMetadata.mobile_number ||\n                     combinedMetadata.mobile ||\n                     userMetadata.mobile ||\n                     userMetadata.phone ||\n                     userMetadata.phone_number ||\n                     user?.phone;\n    const isFullyRegistered = role && name && hasMobile;\n\n    // Re-read OAuth context after potential updates\n    oauthContext = getOAuthContext() || {};\n\n    // CRITICAL: If OAuth context is missing intent but we have a provider,\n    // we need to determine if this is a signup or login\n    // Heuristic: If user is NOT fully registered AND has OAuth provider, it's likely a signup\n    if (!oauthContext.intent && provider) {\n      if (!isFullyRegistered) {\n        // Incomplete registration + OAuth = new signup\n        console.log(\"[SUCCESS] OAuth context missing intent, inferring SIGNUP from incomplete registration\");\n        oauthContext = {\n          ...oauthContext,\n          provider: provider || oauthContext.provider,\n          email: email || oauthContext.email,\n          intent: \"signup\",\n          status: \"pending\"\n        };\n        setOAuthContext(oauthContext);\n      } else {\n        // Fully registered + OAuth = login\n        console.log(\"[SUCCESS] OAuth context missing intent, inferring LOGIN from complete registration\");\n        oauthContext = {\n          ...oauthContext,\n          provider: provider || oauthContext.provider,\n          email: email || oauthContext.email,\n          intent: \"login\",\n          status: \"completed\"\n        };\n        setOAuthContext(oauthContext);\n      }\n    }\n\n    const cameFromSignup = oauthContext.intent === \"signup\";\n\n    console.log(\"[SUCCESS] ========================================\");\n    console.log(\"[SUCCESS] FINAL DECISION POINT:\");\n    console.log(\"[SUCCESS] OAuth context:\", oauthContext);\n    console.log(\"[SUCCESS] Provider:\", provider);\n    console.log(\"[SUCCESS] isFullyRegistered:\", isFullyRegistered);\n    console.log(\"[SUCCESS] cameFromSignup:\", cameFromSignup);\n    console.log(\"[SUCCESS] Registration details:\", {\n      role: role || \"MISSING\",\n      name: name || \"MISSING\",\n      hasMobile: Boolean(hasMobile),\n      mobile: hasMobile || \"MISSING\"\n    });\n    console.log(\"[SUCCESS] ========================================\");\n\n    console.log(\"[SUCCESS] Registration status check:\", {\n      hasFullProfile,\n      cameFromSignup,\n      hasMobile: Boolean(hasMobile),\n      isFullyRegistered,\n      role: role || \"missing\",\n      name: name || \"missing\",\n      mobile: hasMobile || \"missing\"\n    });\n\n    // CRITICAL: Only set session cookie if user has completed registration\n    // For incomplete OAuth signups, NEVER set the cookie - this prevents marking as logged in\n    // IMPORTANT: OAuth login users (intent === 'login') are always fully registered and should always get session cookie\n    const isOAuthLogin = !cameFromSignup; // OAuth login has intent === 'login'\n\n    if (isFullyRegistered && accessToken) {\n      // User is fully registered - set session cookie (applies to both login and completed signup)\n      try {\n        const resp = await fetch(\"/auth/session\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ access_token: accessToken })\n        });\n        // Verify cookie by hitting a protected endpoint before redirecting\n        if (resp.ok) {\n          let ok = false;\n          try {\n            const check1 = await fetch(\"/api/user/role\", { method: \"GET\" });\n            ok = check1.ok;\n          } catch (error) {\n            console.error(\"[SUCCESS] First role check error:\", error);\n          }\n          if (!ok) {\n            await new Promise(r => setTimeout(r, 300));\n            try {\n              const check2 = await fetch(\"/api/user/role\", { method: \"GET\" });\n              ok = check2.ok;\n            } catch (error) {\n              console.error(\"[SUCCESS] Second role check error:\", error);\n            }\n          }\n          if (!ok) {\n            // If cannot verify, stay on page and let user refresh\n            return;\n          }\n        }\n      } catch (error) {\n        console.error(\"[SUCCESS] Session persistence error:\", error);\n      }\n    } else if (!isOAuthLogin && cameFromSignup) {\n      // ONLY for incomplete OAuth signups (not login), explicitly clear any existing session cookie\n      // to prevent being marked as logged in\n      // OAuth login users are always fully registered, so this branch never executes for them\n      // CRITICAL: DO NOT clear Supabase session - we need it for the continuation page!\n      // Only clear the server-side cookie to prevent being marked as logged in\n      console.log(\"[SUCCESS] Clearing server-side session cookie (but keeping Supabase session for continuation)\");\n      try {\n        await fetch(\"/auth/session\", { method: \"DELETE\" });\n        console.log(\"[SUCCESS] Server session cookie cleared\");\n      } catch (error) {\n        console.warn(\"[SUCCESS] Error clearing server session cookie:\", error);\n        // Silently fail - cookie might not exist\n      }\n\n      // DO NOT sign out from Supabase - we need the session for the continuation page!\n      // The continuation page will validate the session and complete the registration\n      console.log(\"[SUCCESS] Keeping Supabase session for OAuth continuation page\");\n    }\n    // If isOAuthLogin but !isFullyRegistered, this is an edge case (shouldn't happen)\n    // But we don't clear session to be safe - let the user proceed\n\n    // Check if user already exists (has full profile but came from signup)\n    if (cameFromSignup && hasFullProfile) {\n      await notifyExistingUser();\n      return;\n    }\n\n    // For incomplete OAuth signups, set context to 'handoff' (not 'pending')\n    // This allows continuation page to load but prevents auth checks\n    console.log(\"[SUCCESS] Final OAuth context decision...\");\n    console.log(\"[SUCCESS] Context decision:\", {\n      cameFromSignup,\n      isFullyRegistered,\n      hasProvider: Boolean(provider),\n      willSetContext: cameFromSignup && !isFullyRegistered && provider\n    });\n\n    if (cameFromSignup && !isFullyRegistered && provider) {\n      const newContext = {\n        provider,\n        email: email || oauthContext.email,\n        intent: \"signup\",\n        status: \"handoff\", // Changed from 'pending' to allow continuation page\n        startedAt: oauthContext.startedAt || Date.now()\n      };\n      console.log(\"[SUCCESS] ✅ Setting OAuth context to handoff:\", newContext);\n      setOAuthContext(newContext);\n      console.log(\"[SUCCESS] OAuth context after setting:\", getOAuthContext());\n    } else if (isFullyRegistered) {\n      console.log(\"[SUCCESS] User fully registered, clearing OAuth context\");\n      clearOAuthContext();\n    } else {\n      console.log(\"[SUCCESS] Keeping existing OAuth context:\", oauthContext);\n    }\n\n    if (isPopupFlow) {\n      console.log(\"[SUCCESS] 🔵 POPUP FLOW DETECTED\");\n      console.log(\"[SUCCESS] Popup flow - checking registration status...\");\n      console.log(\"[SUCCESS] isFullyRegistered:\", isFullyRegistered);\n      console.log(\"[SUCCESS] cameFromSignup:\", cameFromSignup);\n\n      const identityData = user?.identities?.[0]?.identity_data || {};\n      const userMeta = user?.user_metadata || {};\n      const rawMeta = user?.raw_user_meta_data || {};\n      const combined = {\n        ...rawMeta,\n        ...userMeta,\n        ...identityData\n      };\n      const fullName = combined.full_name || combined.name || \"\";\n      const splitName = fullName ? fullName.trim().split(\" \") : [];\n      const firstName = combined.given_name || combined.first_name || splitName[0] || \"\";\n      const lastName = combined.family_name || combined.last_name || splitName.slice(1).join(\" \") || \"\";\n      const middleName = combined.middle_name || splitName.slice(1, -1).join(\" \") || \"\";\n      const payload = { provider, email, firstName, middleName, lastName };\n\n      // CRITICAL: Always send message for OAuth signups (both complete and incomplete)\n      // The signup page will handle the redirect\n      console.log(\"[SUCCESS] 🔵 Sending message to opener window\");\n      console.log(\"[SUCCESS] Registration status:\", {\n        isFullyRegistered,\n        role: role || \"missing\",\n        name: name || \"missing\",\n        hasMobile: Boolean(hasMobile)\n      });\n\n      if (window.opener) {\n        try {\n          // CRITICAL: Get the session token to pass to main window\n          // Supabase stores sessions in localStorage which is window-specific\n          // We need to pass the token so main window can set it\n          const { data: { session: currentSession } } = await supabase.auth.getSession();\n          const accessToken = currentSession?.access_token;\n          const refreshToken = currentSession?.refresh_token;\n\n          console.log(\"[SUCCESS] Session token available:\", Boolean(accessToken));\n\n          // Always send message with redirectTo for OAuth signups\n          // If incomplete, mark it explicitly\n          const message = {\n            type: \"oauth-signup-success\",\n            payload,\n            redirectTo: \"/oauth-continuation\",\n            incomplete: !isFullyRegistered,\n            // CRITICAL: Pass session tokens so main window can set them\n            accessToken,\n            refreshToken\n          };\n          console.log(\"[SUCCESS] Sending message to opener:\", JSON.stringify({\n            ...message,\n            accessToken: accessToken ? \"***\" : null,\n            refreshToken: refreshToken ? \"***\" : null\n          }, null, 2));\n          window.opener.postMessage(message, window.location.origin);\n          console.log(\"[SUCCESS] ✅ Message sent to opener\");\n\n          // Wait a bit to ensure message is received, then close\n          setTimeout(() => {\n            try {\n              console.log(\"[SUCCESS] Closing popup...\");\n              window.close();\n            } catch (closeError) {\n              console.warn(\"[SUCCESS] Could not close popup:\", closeError);\n              // If popup can't close, redirect in popup itself\n              window.location.href = \"/oauth-continuation\";\n            }\n          }, 800); // Increased delay to ensure message is received and processed\n        } catch (postError) {\n          console.error(\"[SUCCESS] ❌ Failed to notify opener:\", postError);\n          // Fallback: redirect in popup\n          window.location.href = \"/oauth-continuation\";\n        }\n      } else {\n        console.warn(\"[SUCCESS] No opener window found, redirecting in popup...\");\n        window.location.href = \"/oauth-continuation\";\n      }\n      return;\n\n      // Fully registered - normal popup flow\n      if (window.opener) {\n        try {\n          window.opener.postMessage({ type: \"oauth-signup-success\", payload }, window.location.origin);\n        } catch (postError) {\n          console.error(\"[SUCCESS] Failed to notify opener:\", postError);\n        }\n      }\n      setTimeout(() => {\n        try {\n          window.close();\n        } catch {\n          // If popup can't close, redirect to continuation\n          window.location.href = \"/oauth-continuation\";\n        }\n      }, 200);\n      return;\n    }\n\n    // Redirect based on registration status\n    console.log(\"[SUCCESS] Determining redirect destination...\");\n    console.log(\"[SUCCESS] Redirect check:\", {\n      hasProvider: Boolean(provider),\n      isFullyRegistered,\n      cameFromSignup,\n      provider\n    });\n\n    // CRITICAL: Redirect logic - must check all conditions\n    // If user has OAuth provider but is NOT fully registered, they need to complete signup\n    // Even if cameFromSignup is false (context lost), we should still redirect if incomplete\n    // SIMPLIFIED: If provider exists and user is incomplete, redirect (regardless of context)\n    const shouldRedirectToContinuation = provider && !isFullyRegistered;\n\n    console.log(\"[SUCCESS] ========================================\");\n    console.log(\"[SUCCESS] REDIRECT DECISION:\");\n    console.log(\"[SUCCESS] shouldRedirectToContinuation:\", shouldRedirectToContinuation);\n    console.log(\"[SUCCESS] Conditions:\", {\n      hasProvider: Boolean(provider),\n      notFullyRegistered: !isFullyRegistered,\n      cameFromSignup,\n      // Fallback: if incomplete and has provider, assume signup\n      fallbackCheck: !isFullyRegistered && Boolean(provider)\n    });\n    console.log(\"[SUCCESS] ========================================\");\n\n    if (shouldRedirectToContinuation) {\n      // Incomplete OAuth signup - redirect to continuation\n      console.log(\"[SUCCESS] ✅ REDIRECTING TO OAUTH CONTINUATION\");\n      const finalContext = getOAuthContext();\n      console.log(\"[SUCCESS] OAuth context before redirect:\", finalContext);\n      console.log(\"[SUCCESS] Session exists:\", Boolean(session));\n      console.log(\"[SUCCESS] About to set window.location.href...\");\n\n      // Force redirect immediately (no setTimeout)\n      console.log(\"[SUCCESS] EXECUTING REDIRECT NOW...\");\n      window.location.href = \"/oauth-continuation\";\n      // Add a fallback in case redirect fails\n      setTimeout(() => {\n        if (window.location.pathname !== \"/oauth-continuation\") {\n          console.error(\"[SUCCESS] Redirect failed! Trying again...\");\n          window.location.replace(\"/oauth-continuation\");\n        }\n      }, 500);\n      // Exit early to prevent any other redirects\n    } else if (isFullyRegistered) {\n      // Complete registration - redirect to dashboard\n      console.log(\"[SUCCESS] ✅ Redirecting to dashboard (fully registered)\");\n      clearOAuthContext();\n      window.location.href = \"/dashboard\";\n    } else {\n      // Fallback - should not happen\n      console.log(\"[SUCCESS] ⚠️ Fallback redirect to login\");\n      clearOAuthContext();\n      window.location.href = \"/login\";\n    }\n  } catch (error) {\n    console.error(\"[SUCCESS] Main error:\", error);\n    console.error(\"[SUCCESS] Error stack:\", error.stack);\n    // Fallback: redirect to dashboard anyway\n    window.location.href = \"/dashboard\";\n  }\n};\n\nconsole.log(\"[SUCCESS] About to call run() function\");\nconsole.log(\"[SUCCESS] run function type:\", typeof run);\n\n// Wrap in try-catch with detailed error logging\ntry {\n  const result = run();\n  if (result && typeof result.then === \"function\") {\n    // It's a promise\n    result.catch((error) => {\n      console.error(\"[SUCCESS] ❌ Promise rejection in run():\", error);\n      console.error(\"[SUCCESS] Error stack:\", error.stack);\n      if (window.location.search.includes(\"debug\")) {\n        alert(`ERROR in success.js run(): ${  error.message}`);\n      }\n    });\n  }\n} catch (error) {\n  console.error(\"[SUCCESS] ❌ Error calling run():\", error);\n  console.error(\"[SUCCESS] Error stack:\", error.stack);\n  if (window.location.search.includes(\"debug\")) {\n    alert(`ERROR calling run(): ${  error.message}`);\n  }\n}\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\components\\toast.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\config\\apiClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\config\\brand.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\config\\config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\config\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\coordinator\\dashboard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\coordinator\\review-queue.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\coordinator\\review.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\hr\\dashboard.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":338,"column":10,"nodeType":"CallExpression","messageId":"unexpected","endLine":340,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * HR Dashboard\n * Role management interface for HR personnel\n */\nimport showMessage from \"../components/toast.js\";\n\n// Check for OAuth success message\nconst oauthSuccessMessage = sessionStorage.getItem(\"oauth_success_message\");\nif (oauthSuccessMessage) {\n  sessionStorage.removeItem(\"oauth_success_message\");\n  showMessage(\"success\", oauthSuccessMessage, 5000);\n}\n\n// Initialize dashboard\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\n  await loadDashboardData();\n  await loadDepartmentStats();\n  await loadRoleDistribution();\n  await loadPerformanceData();\n  await loadWorkloadDistribution();\n  await loadBottleneckAlerts();\n  setupFormHandlers();\n  setupUserSearch();\n\n  // Setup refresh button event listener\n  const refreshRoleDistributionBtn = document.getElementById(\n    \"refresh-role-distribution-btn\"\n  );\n  if (refreshRoleDistributionBtn) {\n    refreshRoleDistributionBtn.addEventListener(\"click\", loadRoleDistribution);\n  }\n\n  // Setup quick action buttons (placeholders for future implementation)\n  const promoteUserBtn = document.getElementById(\"promote-user-btn\");\n  if (promoteUserBtn) {\n    promoteUserBtn.addEventListener(\"click\", () => {\n      showMessage(\n        \"info\",\n        \"Please use the User Management section to promote users\"\n      );\n    });\n  }\n\n  const demoteUserBtn = document.getElementById(\"demote-user-btn\");\n  if (demoteUserBtn) {\n    demoteUserBtn.addEventListener(\"click\", () => {\n      showMessage(\n        \"info\",\n        \"Please use the User Management section to demote users\"\n      );\n    });\n  }\n\n  const getHelpBtn = document.getElementById(\"get-help-btn\");\n  if (getHelpBtn) {\n    getHelpBtn.addEventListener(\"click\", () => {\n      showMessage(\"info\", \"Help feature coming soon\");\n    });\n  }\n});\n\n// Chart instance for role distribution\nlet roleDistributionChart = null;\n/**\n * Load dashboard data\n */\nasync function loadDashboardData() {\n  try {\n    const response = await fetch(\"/api/hr/dashboard\");\n    const result = await response.json();\n    if (result.success) {\n      updateStatistics(result.data.statistics);\n    }\n  } catch (error) {\n    console.error(\"[HR] Load dashboard error:\", error);\n  }\n}\n/**\n * Update statistics display\n */\nfunction updateStatistics(stats) {\n  document.getElementById(\"stat-officers\").textContent =\n    stats.total_officers || 0;\n  document.getElementById(\"stat-admins\").textContent = stats.total_admins || 0;\n  document.getElementById(\"stat-promotions\").textContent =\n    stats.promotions_this_month || 0;\n  document.getElementById(\"stat-demotions\").textContent =\n    stats.demotions_this_month || 0;\n}\n/**\n * Load department statistics\n */\nasync function loadDepartmentStats() {\n  try {\n    const response = await fetch(\"/api/hr/users?limit=1000\");\n    const result = await response.json();\n    if (result.success && result.data) {\n      const users = result.data;\n      const departmentStats = calculateDepartmentStats(users);\n      renderDepartmentStats(departmentStats);\n    } else {\n      renderDepartmentStats([]);\n    }\n  } catch (error) {\n    console.error(\"[HR] Load department stats error:\", error);\n    renderDepartmentStats([]);\n  }\n}\n/**\n * Calculate department statistics from user data\n */\nfunction calculateDepartmentStats(users) {\n  const deptMap = new Map();\n  const seenUserIds = new Set();\n  users.forEach((user) => {\n    if (user && user.id) {\n      if (seenUserIds.has(user.id)) return; // avoid double counting same user\n      seenUserIds.add(user.id);\n    }\n    const role = String(user.role || \"\").toLowerCase();\n    // Derive department from multiple sources; skip if missing\n    const department =\n      user.department ||\n      user.dpt ||\n      user?.raw_user_meta_data?.department ||\n      user?.raw_user_meta_data?.dpt ||\n      user?.user_metadata?.department ||\n      user?.user_metadata?.dpt ||\n      null;\n    if (!department) return; // Ignore records without an office to avoid 'Unknown'\n\n    if (!deptMap.has(department)) {\n      deptMap.set(department, { admins: 0, officers: 0 });\n    }\n    const deptStats = deptMap.get(department);\n    // Count admins (lgu-admin-* roles)\n    if (role === \"lgu-admin\" || /^lgu-admin-/.test(role)) {\n      deptStats.admins++;\n      return;\n    }\n    // Count officers: include simplified 'lgu' and legacy lgu-* except admin/hr\n    if (role === \"lgu\" || /^lgu-(?!admin|hr)/.test(role)) {\n      deptStats.officers++;\n    }\n  });\n  return Array.from(deptMap.entries())\n    .map(([dept, stats]) => ({\n      department: dept,\n      admins: stats.admins,\n      officers: stats.officers,\n      total: stats.admins + stats.officers,\n    }))\n    .sort((a, b) => b.total - a.total);\n}\n/**\n * Load role distribution and render pie chart\n */\nwindow.loadRoleDistribution = async function loadRoleDistribution() {\n  try {\n    const response = await fetch(\"/api/hr/role-distribution\");\n    const result = await response.json();\n\n    if (!result.success || !result.distribution) {\n      console.error(\"[HR] Failed to load role distribution:\", result.error);\n      return;\n    }\n\n    const { hr, officers, admins } = result.distribution;\n    renderRoleDistributionChart({ hr, officers, admins });\n  } catch (error) {\n    console.error(\"[HR] Load role distribution error:\", error);\n  }\n};\n\n/**\n * Render role distribution pie chart (HR)\n */\nfunction renderRoleDistributionChart(data) {\n  const canvas = document.getElementById(\"role-distribution-chart\");\n  if (!canvas) return;\n\n  const ctx = canvas.getContext(\"2d\");\n\n  // Destroy existing chart if it exists\n  if (roleDistributionChart) {\n    roleDistributionChart.destroy();\n  }\n\n  const values = [data.hr || 0, data.officers || 0, data.admins || 0];\n  const total = values.reduce((a, b) => a + b, 0);\n\n  const chartData = {\n    labels: [\n      `HR (${values[0]})`,\n      `Officers (${values[1]})`,\n      `Admins (${values[2]})`,\n    ],\n    datasets: [\n      {\n        data: values,\n        backgroundColor: [\n          \"#10b981\", // Green for HR\n          \"#f59e0b\", // Orange for Officers\n          \"#8b5cf6\", // Purple for Admins\n        ],\n        borderColor: \"#ffffff\",\n        borderWidth: 2,\n      },\n    ],\n  };\n\n  roleDistributionChart = new Chart(ctx, {\n    type: \"pie\",\n    data: chartData,\n    options: {\n      responsive: true,\n      maintainAspectRatio: true,\n      plugins: {\n        legend: {\n          position: \"bottom\",\n          labels: {\n            padding: 15,\n            font: {\n              size: 14,\n            },\n            generateLabels(chart) {\n              const { data } = chart;\n              if (data.labels.length && data.datasets.length) {\n                return data.labels.map((label, i) => {\n                  const value = data.datasets[0].data[i];\n                  const percentage =\n                    total > 0 ? ((value / total) * 100).toFixed(1) : 0;\n                  return {\n                    text: `${label} - ${percentage}%`,\n                    fillStyle: data.datasets[0].backgroundColor[i],\n                    strokeStyle: data.datasets[0].borderColor,\n                    lineWidth: data.datasets[0].borderWidth,\n                    hidden: false,\n                    index: i,\n                  };\n                });\n              }\n              return [];\n            },\n          },\n        },\n        tooltip: {\n          callbacks: {\n            label(context) {\n              const label = context.label || \"\";\n              const value = context.parsed || 0;\n              const total = context.dataset.data.reduce((a, b) => a + b, 0);\n              const percentage =\n                total > 0 ? ((value / total) * 100).toFixed(1) : 0;\n              return `${label.split(\" (\")[0]}: ${value} users (${percentage}%)`;\n            },\n          },\n        },\n      },\n    },\n  });\n}\n\n/**\n * Render department statistics\n */\nfunction renderDepartmentStats(stats) {\n  const container = document.getElementById(\"department-stats\");\n  if (!container) return;\n  if (!stats.length) {\n    container.innerHTML =\n      '<p style=\"color: #7f8c8d; text-align: center; padding: 20px;\">No department data available.</p>';\n    return;\n  }\n  const html = stats\n    .map(\n      (dept) => `\n    <div class=\"dept-stat-card\">\n      <h3>${escapeHtml(dept.department)}</h3>\n      <div class=\"dept-counts\">\n        <div class=\"dept-count\">\n          <div class=\"dept-count-value\">${dept.admins}</div>\n          <div class=\"dept-count-label\">Admins</div>\n        </div>\n        <div class=\"dept-count\">\n          <div class=\"dept-count-value\">${dept.officers}</div>\n          <div class=\"dept-count-label\">Officers</div>\n        </div>\n        <div class=\"dept-count\">\n          <div class=\"dept-count-value\">${dept.total}</div>\n          <div class=\"dept-count-label\">Total</div>\n        </div>\n      </div>\n    </div>\n  `\n    )\n    .join(\"\");\n  container.innerHTML = html;\n}\n/**\n * Setup form handlers\n */\nfunction setupFormHandlers() {\n  // Forms are optional (they may be removed from the page)\n  const promoteOfficerForm = document.getElementById(\"promote-officer-form\");\n  if (promoteOfficerForm)\n    promoteOfficerForm.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const userId = document.getElementById(\"promote-officer-user\").value;\n      const department = document.getElementById(\"promote-officer-dept\").value;\n      const reason = document.getElementById(\"promote-officer-reason\").value;\n      await promoteToOfficer(userId, department, reason);\n    });\n  const promoteAdminForm = document.getElementById(\"promote-admin-form\");\n  if (promoteAdminForm)\n    promoteAdminForm.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const userId = document.getElementById(\"promote-admin-user\").value;\n      const department = document.getElementById(\"promote-admin-dept\").value;\n      const reason = document.getElementById(\"promote-admin-reason\").value;\n      await promoteToAdmin(userId, department, reason);\n    });\n  const demoteOfficerForm = document.getElementById(\"demote-officer-form\");\n  if (demoteOfficerForm)\n    demoteOfficerForm.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const userId = document.getElementById(\"demote-officer-user\").value;\n      const reason = document.getElementById(\"demote-officer-reason\").value;\n      await demoteToOfficer(userId, reason);\n    });\n  const stripTitlesForm = document.getElementById(\"strip-titles-form\");\n  if (stripTitlesForm)\n    stripTitlesForm.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const userId = document.getElementById(\"strip-titles-user\").value;\n      const reason = document.getElementById(\"strip-titles-reason\").value;\n      if (\n        !confirm(\n          \"Are you sure you want to strip all titles from this user? This will revert them to citizen status.\"\n        )\n      ) {\n        return;\n      }\n      await stripTitles(userId, reason);\n    });\n  const assignDeptForm = document.getElementById(\"assign-dept-form\");\n  if (assignDeptForm)\n    assignDeptForm.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const userId = document.getElementById(\"assign-dept-user\").value;\n      const departmentId = document.getElementById(\"assign-dept-id\").value;\n      await assignDepartment(userId, departmentId);\n    });\n  const roleHistoryForm = document.getElementById(\"role-history-form\");\n  if (roleHistoryForm)\n    roleHistoryForm.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const userId = document.getElementById(\"role-history-user\").value;\n      await viewRoleHistory(userId);\n    });\n}\n\n// Pending Signup Approvals Panel\nasync function loadPendingSignups() {\n  try {\n    const res = await fetch(\"/api/hr/pending-signups\");\n    const json = await res.json();\n    const container = document.getElementById(\"pending-signups\");\n    if (!container) return;\n    if (!json.success) {\n      container.innerHTML =\n        '<p style=\"color:#7f8c8d;\">Failed to load pending signups</p>';\n      return;\n    }\n    const users = json.data || [];\n    if (users.length === 0) {\n      container.innerHTML = '<p style=\"color:#7f8c8d;\">No pending signups.</p>';\n      return;\n    }\n    container.innerHTML = users\n      .map((u) => {\n        const name = u.name || u.fullName || u.email || u.id;\n        const dept =\n          u?.raw_user_meta_data?.pending_department ||\n          u?.user_metadata?.pending_department ||\n          \"-\";\n        const role =\n          u?.raw_user_meta_data?.pending_role ||\n          u?.user_metadata?.pending_role ||\n          \"-\";\n        return `\n        <div class=\"user-item\">\n          <div class=\"user-item-name\">${escapeHtml(name)}</div>\n          <div class=\"user-item-email\">${escapeHtml(u.email || \"\")}</div>\n          <div class=\"user-item-role\">Requested: ${escapeHtml(\n    role\n  )} @ ${escapeHtml(String(dept))}</div>\n          <div style=\"margin-top:8px; display:flex; gap:8px;\">\n            <button class=\"btn btn-success btn-sm\" data-approve=\"${\n  u.id\n}\">Approve</button>\n            <button class=\"btn btn-danger btn-sm\" data-reject=\"${\n  u.id\n}\">Reject</button>\n          </div>\n        </div>`;\n      })\n      .join(\"\");\n    // Bind actions\n    container.querySelectorAll(\"[data-approve]\").forEach((btn) => {\n      btn.addEventListener(\"click\", async () => {\n        const id = btn.getAttribute(\"data-approve\");\n        await approvePending(id);\n      });\n    });\n    container.querySelectorAll(\"[data-reject]\").forEach((btn) => {\n      btn.addEventListener(\"click\", async () => {\n        const id = btn.getAttribute(\"data-reject\");\n        await rejectPending(id);\n      });\n    });\n  } catch (e) {\n    const container = document.getElementById(\"pending-signups\");\n    if (container)\n      container.innerHTML =\n        '<p style=\"color:#7f8c8d;\">Failed to load pending signups</p>';\n  }\n}\n\nasync function approvePending(userId) {\n  try {\n    const res = await fetch(\n      `/api/hr/pending-signups/${encodeURIComponent(userId)}/approve`,\n      { method: \"POST\" }\n    );\n    const json = await res.json();\n    if (json.success) {\n      showMessage(\"success\", \"Approved\");\n      await loadPendingSignups();\n      await loadDashboardData();\n    } else {\n      showMessage(\"error\", json.error || \"Failed to approve\");\n    }\n  } catch (e) {\n    showMessage(\"error\", \"Failed to approve\");\n  }\n}\n\nasync function rejectPending(userId) {\n  try {\n    const res = await fetch(\n      `/api/hr/pending-signups/${encodeURIComponent(userId)}/reject`,\n      { method: \"POST\" }\n    );\n    const json = await res.json();\n    if (json.success) {\n      showMessage(\"success\", \"Rejected\");\n      await loadPendingSignups();\n      await loadDashboardData();\n    } else {\n      showMessage(\"error\", json.error || \"Failed to reject\");\n    }\n  } catch (e) {\n    showMessage(\"error\", \"Failed to reject\");\n  }\n}\n\n// Kick-off pending list load when dashboard is ready\ntry {\n  loadPendingSignups();\n} catch {}\n/**\n * User search & detail wiring\n */\nfunction setupUserSearch() {\n  const searchBtn = document.getElementById(\"user-search-btn\");\n  const searchInput = document.getElementById(\"user-search-input\");\n  const barangayInput = document.getElementById(\"user-filter-barangay\");\n  async function runSearch() {\n    const q = encodeURIComponent(searchInput.value || \"\");\n    const brgy = encodeURIComponent(barangayInput.value || \"\");\n    const url = `/api/hr/users?search=${q}${brgy ? `&barangay=${brgy}` : \"\"}`;\n    try {\n      const res = await fetch(url);\n      const result = await res.json();\n      if (result.success) {\n        renderUserList(result.data || []);\n      } else {\n        renderUserList([]);\n      }\n    } catch (err) {\n      console.error(\"[HR] user search error:\", err);\n      renderUserList([]);\n    }\n  }\n  if (searchBtn) searchBtn.addEventListener(\"click\", runSearch);\n  if (searchInput)\n    searchInput.addEventListener(\"keypress\", (e) => {\n      if (e.key === \"Enter\") runSearch();\n    });\n}\nfunction renderUserList(users) {\n  const list = document.getElementById(\"user-list\");\n  if (!list) return;\n  if (!users.length) {\n    list.innerHTML =\n      '<p style=\"color:#7f8c8d; padding:8px;\">No users found.</p>';\n    return;\n  }\n  list.innerHTML = users\n    .map(\n      (u) =>\n        `<div class=\"user-item\" data-user-id=\"${u.id}\">\n      <div><strong>${escapeHtml(u.fullName || u.name || u.email)}</strong></div>\n      <div class=\"user-meta\">${escapeHtml(u.email || \"\")}</div>\n      <div class=\"user-meta\">Role: ${escapeHtml(\n    u.role || \"\"\n  )} | Brgy: ${escapeHtml(u.address?.barangay || \"-\")}</div>\n    </div>`\n    )\n    .join(\"\");\n\n  // Click to load details\n  list.querySelectorAll(\".user-item\").forEach((el) => {\n    el.addEventListener(\"click\", async () => {\n      const id = el.getAttribute(\"data-user-id\");\n      await loadUserDetails(id);\n      await loadUserComplaints(id);\n    });\n  });\n}\n\nasync function loadUserDetails(userId) {\n  try {\n    const res = await fetch(`/api/hr/users/${userId}`);\n    const result = await res.json();\n    const container = document.getElementById(\"user-details\");\n    if (!container) return;\n    if (result.success && result.data) {\n      const u = result.data;\n      container.innerHTML = `\n        <div style=\"display:flex; gap:16px; align-items:center;\">\n          <div style=\"width:48px; height:48px; border-radius:50%; background:#eee;\"></div>\n          <div>\n            <div style=\"font-weight:700; font-size:1.1rem;\">${escapeHtml(\n    u.fullName || u.name || u.email\n  )}</div>\n            <div class=\"user-meta\">${escapeHtml(u.email || \"\")}</div>\n          </div>\n        </div>\n        <div style=\"margin-top:12px; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px;\">\n          <div><strong>Role:</strong> ${escapeHtml(u.role || \"\")}</div>\n          <div><strong>Department:</strong> ${escapeHtml(\n    u.department || \"-\"\n  )}</div>\n          <div><strong>Barangay:</strong> ${escapeHtml(\n    u.address?.barangay || \"-\"\n  )}</div>\n          <div><strong>City:</strong> ${escapeHtml(\n    u.address?.city || \"-\"\n  )}</div>\n          <div><strong>Mobile:</strong> ${escapeHtml(\n    u.mobileNumber || \"-\"\n  )}</div>\n        </div>\n      `;\n    } else {\n      container.innerHTML =\n        '<p style=\"color:#e74c3c;\">Failed to load user.</p>';\n    }\n  } catch (err) {\n    console.error(\"[HR] load user details error:\", err);\n  }\n}\nasync function loadUserComplaints(userId) {\n  try {\n    const res = await fetch(`/api/hr/users/${userId}/complaints?limit=10`);\n    const result = await res.json();\n    const container = document.getElementById(\"user-complaints\");\n    if (!container) return;\n    if (result.success) {\n      const complaints = result.data || [];\n      if (!complaints.length) {\n        container.innerHTML =\n          '<p style=\"color:#7f8c8d;\">No complaints found.</p>';\n        return;\n      }\n      container.innerHTML = complaints\n        .map(\n          (c) => `\n        <div style=\"padding:12px; border:1px solid #eee; border-radius:6px; margin-bottom:8px; background:#fafafa;\">\n          <div style=\"display:flex; justify-content:space-between;\">\n            <strong>${escapeHtml(c.title || \"Untitled\")}</strong>\n            <span class=\"user-meta\">${escapeHtml(c.status || \"\")}</span>\n          </div>\n          <div class=\"user-meta\">Type: ${escapeHtml(c.type || \"-\")}</div>\n          ${\n  c.location_text\n    ? `<div class=\"user-meta\">${escapeHtml(c.location_text)}</div>`\n    : \"\"\n}\n        </div>\n      `\n        )\n        .join(\"\");\n    } else {\n      container.innerHTML =\n        '<p style=\"color:#e74c3c;\">Failed to load complaints.</p>';\n    }\n  } catch (err) {\n    console.error(\"[HR] load user complaints error:\", err);\n  }\n}\nfunction escapeHtml(s) {\n  if (s == null) return \"\";\n  return String(s)\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/'/g, \"&#39;\");\n}\n/**\n * Promote to Officer\n */\nasync function promoteToOfficer(userId, department, reason) {\n  try {\n    const response = await fetch(\"/api/hr/promote-to-officer\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        user_id: userId,\n        department,\n        reason,\n      }),\n    });\n    const result = await response.json();\n    if (result.success) {\n      showMessage(\"success\", result.message);\n      document.getElementById(\"promote-officer-form\").reset();\n      await loadDashboardData();\n    } else {\n      showMessage(\"error\", result.error);\n    }\n  } catch (error) {\n    console.error(\"[HR] Promote to officer error:\", error);\n    showMessage(\"error\", \"Failed to promote user\");\n  }\n}\n/**\n * Promote to Admin\n */\nasync function promoteToAdmin(userId, department, reason) {\n  try {\n    const response = await fetch(\"/api/hr/promote-to-admin\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        user_id: userId,\n        department,\n        reason,\n      }),\n    });\n    const result = await response.json();\n    if (result.success) {\n      showMessage(\"success\", result.message);\n      document.getElementById(\"promote-admin-form\").reset();\n      await loadDashboardData();\n    } else {\n      showMessage(\"error\", result.error);\n    }\n  } catch (error) {\n    console.error(\"[HR] Promote to admin error:\", error);\n    showMessage(\"error\", \"Failed to promote user\");\n  }\n}\n/**\n * Demote to Officer\n */\nasync function demoteToOfficer(userId, reason) {\n  try {\n    const response = await fetch(\"/api/hr/demote-to-officer\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        user_id: userId,\n        reason,\n      }),\n    });\n    const result = await response.json();\n    if (result.success) {\n      showMessage(\"success\", result.message);\n      document.getElementById(\"demote-officer-form\").reset();\n      await loadDashboardData();\n    } else {\n      showMessage(\"error\", result.error);\n    }\n  } catch (error) {\n    console.error(\"[HR] Demote to officer error:\", error);\n    showMessage(\"error\", \"Failed to demote user\");\n  }\n}\n/**\n * Strip Titles\n */\nasync function stripTitles(userId, reason) {\n  try {\n    const response = await fetch(\"/api/hr/strip-titles\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        user_id: userId,\n        reason,\n      }),\n    });\n    const result = await response.json();\n    if (result.success) {\n      showMessage(\"success\", result.message);\n      document.getElementById(\"strip-titles-form\").reset();\n      await loadDashboardData();\n    } else {\n      showMessage(\"error\", result.error);\n    }\n  } catch (error) {\n    console.error(\"[HR] Strip titles error:\", error);\n    showMessage(\"error\", \"Failed to strip titles\");\n  }\n}\n/**\n * Assign Department\n */\nasync function assignDepartment(userId, departmentId) {\n  try {\n    const response = await fetch(\"/api/hr/assign-department\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        user_id: userId,\n        department_id: departmentId,\n      }),\n    });\n    const result = await response.json();\n    if (result.success) {\n      showMessage(\"success\", result.message);\n      document.getElementById(\"assign-dept-form\").reset();\n    } else {\n      showMessage(\"error\", result.error);\n    }\n  } catch (error) {\n    console.error(\"[HR] Assign department error:\", error);\n    showMessage(\"error\", \"Failed to assign department\");\n  }\n}\n/**\n * View Role History\n */\nasync function viewRoleHistory(userId) {\n  try {\n    const response = await fetch(`/api/hr/role-history/${userId}`);\n    const result = await response.json();\n    const container = document.getElementById(\"role-history-results\");\n    if (result.success && result.history) {\n      if (result.history.length === 0) {\n        container.innerHTML =\n          '<p style=\"color: #7f8c8d;\">No role history found for this user.</p>';\n        return;\n      }\n      const html = `\n        <div style=\"margin-top: 20px;\">\n          <h4>Role Change History</h4>\n          <div style=\"max-height: 400px; overflow-y: auto;\">\n            ${result.history\n    .map(\n      (entry) => `\n              <div style=\"padding: 15px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; background: #f9f9f9;\">\n                <div style=\"display: flex; justify-content: space-between; margin-bottom: 8px;\">\n                  <strong>${entry.old_role} → ${entry.new_role}</strong>\n                  <span style=\"color: #7f8c8d; font-size: 0.9rem;\">${new Date(\n    entry.created_at\n  ).toLocaleString()}</span>\n                </div>\n                ${\n  entry.metadata && entry.metadata.reason\n    ? `<div style=\"color: #555;\">Reason: ${entry.metadata.reason}</div>`\n    : \"\"\n}\n              </div>\n            `\n    )\n    .join(\"\")}\n          </div>\n        </div>\n      `;\n      container.innerHTML = html;\n    } else {\n      container.innerHTML =\n        '<p style=\"color: #e74c3c;\">Failed to load role history.</p>';\n    }\n  } catch (error) {\n    console.error(\"[HR] View role history error:\", error);\n    showMessage(\"error\", \"Failed to load role history\");\n  }\n}\n\n/**\n * Load and render performance data\n */\nwindow.refreshPerformance = async function refreshPerformance() {\n  await loadPerformanceData();\n  await loadWorkloadDistribution();\n  await loadBottleneckAlerts();\n};\n\nasync function loadPerformanceData() {\n  try {\n    const response = await fetch(\"/api/hr/performance-summary\");\n    const result = await response.json();\n    if (result.success) {\n      const stats = result.data;\n      document.getElementById(\"hr-total-handled\").textContent =\n        stats.total_handled || 0;\n      document.getElementById(\"hr-resolution-rate\").textContent = `${\n        stats.resolution_rate || 0\n      }%`;\n      document.getElementById(\"hr-avg-time\").textContent =\n        stats.avg_resolution_time || \"N/A\";\n    }\n  } catch (error) {\n    console.error(\"[HR] Load performance data error:\", error);\n  }\n}\n\n/**\n * Load and render workload distribution chart\n */\nlet workloadChart = null;\nasync function loadWorkloadDistribution() {\n  try {\n    const response = await fetch(\"/api/hr/workload-distribution\");\n    const result = await response.json();\n    if (result.success) {\n      renderWorkloadChart(result.data);\n    }\n  } catch (error) {\n    console.error(\"[HR] Load workload distribution error:\", error);\n  }\n}\n\nfunction renderWorkloadChart(data) {\n  const canvas = document.getElementById(\"workload-chart\");\n  if (!canvas) return;\n  const ctx = canvas.getContext(\"2d\");\n  if (workloadChart) workloadChart.destroy();\n\n  workloadChart = new Chart(ctx, {\n    type: \"bar\",\n    data: {\n      labels: data.map((d) => d.name),\n      datasets: [\n        {\n          label: \"Current Tasks\",\n          data: data.map((d) => d.task_count),\n          backgroundColor: \"#3b82f6\",\n          borderRadius: 4,\n        },\n      ],\n    },\n    options: {\n      responsive: true,\n      plugins: { legend: { display: false } },\n      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },\n    },\n  });\n}\n\n/**\n * Load and render bottleneck alerts\n */\nasync function loadBottleneckAlerts() {\n  const container = document.getElementById(\"bottleneck-alerts\");\n  if (!container) return;\n  try {\n    const response = await fetch(\"/api/hr/bottlenecks\");\n    const result = await response.json();\n    if (result.success && result.data.length > 0) {\n      container.innerHTML = result.data\n        .map(\n          (alert) => `\n        <div class=\"alert-item p-3 border-l-4 border-yellow-400 bg-yellow-50 rounded flex justify-between items-center animate-fade-in\">\n          <div>\n            <div class=\"font-bold text-yellow-800\">${escapeHtml(\n    alert.message\n  )}</div>\n            <div class=\"text-xs text-yellow-600\">${escapeHtml(\n    alert.department\n  )} - ${alert.count} overdue tasks</div>\n          </div>\n          <button class=\"btn btn-sm btn-outline-warning\" onclick=\"escalateBottleneck('${\n  alert.department\n}')\">Escalate</button>\n        </div>\n      `\n        )\n        .join(\"\");\n    } else {\n      container.innerHTML =\n        '<p class=\"text-sm text-gray-500 text-center p-4\">No significant bottlenecks detected at this time.</p>';\n    }\n  } catch (error) {\n    console.error(\"[HR] Load bottlenecks error:\", error);\n    container.innerHTML =\n      '<p class=\"text-sm text-red-500 text-center p-4\">Failed to check for bottlenecks.</p>';\n  }\n}\n\nwindow.escalateBottleneck = function (dept) {\n  showMessage(\"info\", `Escalating bottleneck in ${dept}...`);\n  // Mock escalate API call\n  setTimeout(\n    () => showMessage(\"success\", `Escalation notice sent to ${dept} Admin`),\n    1000\n  );\n};\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\hr\\linkGenerator.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":405,"column":10,"nodeType":"CallExpression","messageId":"unexpected","endLine":405,"endColumn":67}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * HR Link Generator\r\n * Handles signup link generation and management\r\n */\r\nimport apiClient from \"../config/apiClient.js\";\r\nimport showMessage from \"../components/toast.js\";\r\n\r\nclass LinkGenerator {\r\n\r\n  constructor() {\r\n    this.links = [];\r\n    this.departments = [];\r\n    this.init();\r\n  }\r\n  async init() {\r\n    await this.loadDepartments();\r\n    await this.loadLinks();\r\n    this.setupEventListeners();\r\n  }\r\n  setupEventListeners() {\r\n    const form = document.getElementById(\"linkForm\");\r\n    if (form) {\r\n      form.addEventListener(\"submit\", (e) => this.handleSubmit(e));\r\n    }\r\n\r\n    // Generate New Link button\r\n    const generateBtn = document.getElementById(\"generateNewLinkBtn\");\r\n    if (generateBtn) {\r\n      generateBtn.addEventListener(\"click\", () => this.generateLink());\r\n    }\r\n\r\n    // Cancel button\r\n    const cancelBtn = document.getElementById(\"cancelGenerateBtn\");\r\n    if (cancelBtn) {\r\n      cancelBtn.addEventListener(\"click\", () => this.cancelGenerate());\r\n    }\r\n\r\n    // Copy link button\r\n    const copyBtn = document.getElementById(\"copyLinkBtn\");\r\n    if (copyBtn) {\r\n      copyBtn.addEventListener(\"click\", () => this.copyLink());\r\n    }\r\n\r\n    // Filter selects\r\n    const roleFilter = document.getElementById(\"roleFilter\");\r\n    if (roleFilter) {\r\n      roleFilter.addEventListener(\"change\", () => this.filterLinks());\r\n    }\r\n\r\n    const statusFilter = document.getElementById(\"statusFilter\");\r\n    if (statusFilter) {\r\n      statusFilter.addEventListener(\"change\", () => this.filterLinks());\r\n    }\r\n  }\r\n  async loadDepartments() {\r\n    try {\r\n      const response = await apiClient.getActiveDepartments();\r\n      if (response.success) {\r\n        this.departments = response.data;\r\n        // Get user role to determine department restrictions\r\n        const userRole = await this.getUserRole();\r\n        await this.filterDepartmentsByRole(userRole);\r\n        this.populateDepartmentSelect();\r\n        await this.setupRoleRestrictions(userRole);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to load departments:\", error);\r\n    }\r\n  }\r\n  async getUserRole() {\r\n    try {\r\n      const response = await apiClient.get(\"/api/user/role-info\");\r\n      return response.data?.role || \"citizen\";\r\n    } catch (error) {\r\n      console.error(\"Failed to get user role:\", error);\r\n      return \"citizen\";\r\n    }\r\n  }\r\n  async getHRDepartment(userRole) {\r\n    if (userRole && userRole === \"lgu-hr\") {\r\n      // Get department from API endpoint which has complete metadata\r\n      try {\r\n        const response = await apiClient.get(\"/api/user/role-info\");\r\n        if (response.success && response.data) {\r\n          // First try direct department field from API response\r\n          if (response.data.department) {\r\n            return response.data.department.toUpperCase();\r\n          }\r\n          // Then try metadata fields\r\n          const metadata = response.data.metadata || response.data;\r\n          const department = metadata.department ||\r\n                             metadata.dpt ||\r\n                             metadata.raw_user_meta_data?.department ||\r\n                             metadata.raw_user_meta_data?.dpt ||\r\n                             metadata.user_metadata?.department ||\r\n                             metadata.user_metadata?.dpt;\r\n          if (department) {\r\n            return department.toUpperCase();\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.warn(\"Failed to get department from API:\", error);\r\n      }\r\n      // Fallback: try Supabase session metadata\r\n      try {\r\n        const { supabase } = await import(\"../../config/config.js\");\r\n        const { data: { session } } = await supabase.auth.getSession();\r\n        const metadata = session?.user?.raw_user_meta_data || session?.user?.user_metadata || {};\r\n        const department = metadata.department || metadata.dpt;\r\n        if (department) {\r\n          return department.toUpperCase();\r\n        }\r\n      } catch (error) {\r\n        console.warn(\"Failed to get department from session:\", error);\r\n      }\r\n      // Last resort: return null instead of hardcoded 'WST'\r\n      console.warn(\"No department found in user metadata\");\r\n      return null;\r\n    }\r\n    return null;\r\n  }\r\n  async filterDepartmentsByRole(userRole) {\r\n    // If user is LGU-HR, filter to only their department\r\n    if (userRole === \"lgu-hr\") {\r\n      const userDepartment = await this.getHRDepartment(userRole);\r\n      this.departments = this.departments.filter(dept =>\r\n        dept.code === userDepartment.toUpperCase()\r\n      );\r\n    }\r\n    // Coordinators and super-admin can see all departments\r\n  }\r\n  async setupRoleRestrictions(userRole) {\r\n    // console.log removed for security\r\n    const roleSelect = document.getElementById(\"role\");\r\n    const roleInfo = document.getElementById(\"role-info\");\r\n    const roleDescription = document.getElementById(\"role-description\");\r\n    if (userRole === \"lgu-hr\") {\r\n      // LGU-HR can only create officer or admin roles\r\n      const options = roleSelect.querySelectorAll(\"option\");\r\n      options.forEach(option => {\r\n        if (![\"lgu-officer\", \"lgu-admin\"].includes(option.value)) {\r\n          option.style.display = \"none\";\r\n        }\r\n      });\r\n      // Get HR user's department dynamically from metadata\r\n      const hrDepartment = await this.getHRDepartment(userRole);\r\n      if (!hrDepartment) {\r\n        // If no department found, show a generic message\r\n        if (roleInfo && roleDescription) {\r\n          roleDescription.textContent = \"As an LGU-HR, you can only create signup links for your assigned department with officer or admin roles. Please contact your administrator if your department is not set.\";\r\n          roleInfo.style.display = \"block\";\r\n        }\r\n        return;\r\n      }\r\n      const departmentName = this.getDepartmentName(hrDepartment);\r\n      // console.log removed for security\r\n      // Hide the department field completely for LGU-HR\r\n      const departmentField = document.querySelector(\".form-group:has(#department)\");\r\n      if (departmentField) {\r\n        departmentField.style.display = \"none\";\r\n      }\r\n      // Show role info with dynamic department\r\n      if (roleInfo && roleDescription) {\r\n        // Only show department code if name lookup failed\r\n        const displayText = departmentName && departmentName !== hrDepartment\r\n          ? `${departmentName} (${hrDepartment})`\r\n          : hrDepartment;\r\n        roleDescription.textContent = `As an LGU-HR, you can only create signup links for ${displayText} department with officer or admin roles.`;\r\n        roleInfo.style.display = \"block\";\r\n      }\r\n    } else if (userRole === \"complaint-coordinator\") {\r\n      // Show coordinator info\r\n      if (roleInfo && roleDescription) {\r\n        roleDescription.textContent = \"As a Complaint Coordinator, you can create signup links for any department and any position.\";\r\n        roleInfo.style.display = \"block\";\r\n      }\r\n    } else if (userRole === \"super-admin\") {\r\n      // Show super admin info\r\n      if (roleInfo && roleDescription) {\r\n        roleDescription.textContent = \"As a Super Admin, you have full access to create signup links for any department and any position.\";\r\n        roleInfo.style.display = \"block\";\r\n      }\r\n    }\r\n  }\r\n  getDepartmentName(departmentCode) {\r\n    if (!departmentCode) return null;\r\n    // Try to find department name from loaded departments\r\n    const dept = this.departments.find(d =>\r\n      d.code === departmentCode ||\r\n      d.code === departmentCode.toUpperCase() ||\r\n      d.code?.toUpperCase() === departmentCode.toUpperCase()\r\n    );\r\n    if (dept && dept.name) {\r\n      return dept.name;\r\n    }\r\n    // Return null if not found (not the code itself)\r\n    return null;\r\n  }\r\n  populateDepartmentSelect() {\r\n    const select = document.getElementById(\"department\");\r\n    if (!select) return;\r\n    select.innerHTML = '<option value=\"\">Select Department (Optional)</option>';\r\n    this.departments.forEach(dept => {\r\n      const option = document.createElement(\"option\");\r\n      option.value = dept.code;\r\n      option.textContent = `${dept.name} (${dept.code})`;\r\n      select.appendChild(option);\r\n    });\r\n  }\r\n  async loadLinks() {\r\n    try {\r\n      const response = await apiClient.getSignupLinks();\r\n      if (response.success) {\r\n        // console.log removed for security\r\n        this.links = response.data;\r\n        this.renderLinks();\r\n        this.updateStats();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to load links:\", error);\r\n      showMessage(\"error\", \"Failed to load signup links\");\r\n    }\r\n  }\r\n  renderLinks() {\r\n    const container = document.getElementById(\"linksList\");\r\n    if (!container) return;\r\n    if (this.links.length === 0) {\r\n      container.innerHTML = '<div class=\"no-links\">No signup links generated yet</div>';\r\n      return;\r\n    }\r\n    container.innerHTML = this.links.map((link, _index) => {\r\n      // console.log removed for security\r\n      return `\r\n      <div class=\"link-item ${link.is_expired ? \"expired\" : \"\"} ${link.is_used ? \"used\" : \"\"}\" data-link-id=\"${link.id}\">\r\n        <div class=\"link-item-header\">\r\n          <span class=\"link-role\">${this.getRoleDisplayName(link.role)}</span>\r\n          <span class=\"link-status ${this.getStatusClass(link)}\">${this.getStatusText(link)}</span>\r\n        </div>\r\n        <div class=\"link-details\">\r\n          <div><strong>Department:</strong> ${link.department_code || \"Any\"}</div>\r\n          <div><strong>Created:</strong> ${this.formatDate(link.created_at)}</div>\r\n          <div><strong>Expires:</strong> ${link.expires_at ? this.formatDate(link.expires_at) : \"Never\"}</div>\r\n        </div>\r\n        <div class=\"link-details\">\r\n          <div><strong>Code:</strong> ${link.code}</div>\r\n          <div><strong>Used:</strong> ${link.used_at ? this.formatDate(link.used_at) : \"Not used\"}</div>\r\n          <div><strong>URL:</strong> ${!link.is_used ? `<a href=\"${link.url}\" target=\"_blank\">Open Link</a>` : '<span style=\"color: #9ca3af; font-style: italic;\">Link used</span>'}</div>\r\n        </div>\r\n        <div class=\"link-actions\">\r\n          ${!link.is_used ? `\r\n          <button class=\"btn btn-sm btn-primary copy-link-url-btn\" data-link-url=\"${encodeURIComponent(link.url)}\">\r\n            Copy URL\r\n          </button>\r\n          ` : \"\"}\r\n          ${!link.is_used && !link.is_expired ? `\r\n            <button class=\"btn btn-sm btn-warning deactivate-link-btn\" data-link-id=\"${link.id}\">\r\n              Deactivate\r\n            </button>\r\n          ` : \"\"}\r\n        </div>\r\n      </div>\r\n    `;\r\n    }).join(\"\");\r\n\r\n    // Attach event listeners to dynamically generated buttons\r\n    this.attachLinkEventListeners(container);\r\n  }\r\n  attachLinkEventListeners(container) {\r\n    // Copy URL buttons\r\n    container.querySelectorAll(\".copy-link-url-btn\").forEach(btn => {\r\n      btn.addEventListener(\"click\", (_e) => {\r\n        const url = btn.getAttribute(\"data-link-url\");\r\n        if (url) {\r\n          this.copyLinkUrl(decodeURIComponent(url));\r\n        }\r\n      });\r\n    });\r\n\r\n    // Deactivate buttons\r\n    container.querySelectorAll(\".deactivate-link-btn\").forEach(btn => {\r\n      btn.addEventListener(\"click\", (_e) => {\r\n        const linkId = btn.getAttribute(\"data-link-id\");\r\n        if (linkId) {\r\n          this.deactivateLink(linkId);\r\n        }\r\n      });\r\n    });\r\n  }\r\n  escapeHtml(text) {\r\n    const div = document.createElement(\"div\");\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n  updateStats() {\r\n    const totalElement = document.getElementById(\"totalLinks\");\r\n    const activeElement = document.getElementById(\"activeLinks\");\r\n    const usedElement = document.getElementById(\"usedLinks\");\r\n    if (totalElement) totalElement.textContent = this.links.length;\r\n    if (activeElement) activeElement.textContent = this.links.filter(l => !l.is_used && !l.is_expired).length;\r\n    if (usedElement) usedElement.textContent = this.links.filter(l => l.is_used).length;\r\n  }\r\n  getRoleDisplayName(role) {\r\n    const roleMap = {\r\n      \"lgu-officer\": \"LGU Officer\",\r\n      \"lgu-admin\": \"LGU Admin\",\r\n      \"lgu-hr\": \"LGU HR\"\r\n    };\r\n    return roleMap[role] || role;\r\n  }\r\n  getStatusClass(link) {\r\n    if (link.is_used) return \"status-used\";\r\n    if (link.is_expired) return \"status-expired\";\r\n    return \"status-active\";\r\n  }\r\n  getStatusText(link) {\r\n    if (link.is_used) return \"Used\";\r\n    if (link.is_expired) return \"Expired\";\r\n    return \"Active\";\r\n  }\r\n  formatDate(dateString) {\r\n    const date = new Date(dateString);\r\n    return `${date.toLocaleDateString()  } ${  date.toLocaleTimeString()}`;\r\n  }\r\n  generateLink() {\r\n    const form = document.getElementById(\"generatorForm\");\r\n    if (form) {\r\n      form.style.display = \"block\";\r\n      form.scrollIntoView({ behavior: \"smooth\" });\r\n    }\r\n  }\r\n  cancelGenerate() {\r\n    const form = document.getElementById(\"generatorForm\");\r\n    const generatedLink = document.getElementById(\"generatedLink\");\r\n    if (form) form.style.display = \"none\";\r\n    if (generatedLink) generatedLink.style.display = \"none\";\r\n    document.getElementById(\"linkForm\").reset();\r\n  }\r\n  async handleSubmit(e) {\r\n    e.preventDefault();\r\n    const formData = new FormData(e.target);\r\n    const userRole = await this.getUserRole();\r\n    // Automatically get department based on user role\r\n    let departmentCode = null;\r\n    if (userRole === \"lgu-hr\") {\r\n      departmentCode = await this.getHRDepartment(userRole);\r\n      // console.log removed for security\r\n    } else {\r\n      // For coordinators and super-admin, use form data\r\n      departmentCode = formData.get(\"department_code\") || null;\r\n    }\r\n    const data = {\r\n      role: formData.get(\"role\"),\r\n      department_code: departmentCode,\r\n      expires_in_hours: parseInt(formData.get(\"expires_in_hours\")) || 1\r\n    };\r\n    // console.log removed for security\r\n    try {\r\n      const response = await apiClient.generateSignupLink(data);\r\n      if (response.success) {\r\n        this.showGeneratedLink(response.data);\r\n        await this.loadLinks(); // Refresh the list\r\n        this.cancelGenerate();\r\n        showMessage(\"success\", \"Signup link generated successfully\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to generate link:\", error);\r\n      showMessage(\"error\", error.message || \"Failed to generate signup link\");\r\n    }\r\n  }\r\n  showGeneratedLink(linkData) {\r\n    const generatedLink = document.getElementById(\"generatedLink\");\r\n    const linkInput = document.getElementById(\"linkInput\");\r\n    const expiryTime = document.getElementById(\"expiryTime\");\r\n    if (linkInput) linkInput.value = linkData.url;\r\n    if (expiryTime) {\r\n      const expiryDate = new Date(linkData.expires_at);\r\n      expiryTime.textContent = expiryDate.toLocaleString();\r\n    }\r\n    if (generatedLink) generatedLink.style.display = \"block\";\r\n  }\r\n  copyLink() {\r\n    const linkInput = document.getElementById(\"linkInput\");\r\n    if (linkInput) {\r\n      linkInput.select();\r\n      document.execCommand(\"copy\");\r\n      showMessage(\"success\", \"Link copied to clipboard\");\r\n    }\r\n  }\r\n  copyLinkUrl(url) {\r\n    navigator.clipboard.writeText(url).then(() => {\r\n      showMessage(\"success\", \"URL copied to clipboard\");\r\n    }).catch(() => {\r\n      // Fallback for older browsers\r\n      const textArea = document.createElement(\"textarea\");\r\n      textArea.value = url;\r\n      document.body.appendChild(textArea);\r\n      textArea.select();\r\n      document.execCommand(\"copy\");\r\n      document.body.removeChild(textArea);\r\n      showMessage(\"success\", \"URL copied to clipboard\");\r\n    });\r\n  }\r\n  async deactivateLink(linkId) {\r\n    // console.log removed for security\r\n    if (!confirm(\"Are you sure you want to deactivate this link?\")) {\r\n      return;\r\n    }\r\n    try {\r\n      // console.log removed for security\r\n      const response = await apiClient.deactivateSignupLink(linkId);\r\n      // console.log removed for security\r\n      if (response.success) {\r\n        showMessage(\"success\", \"Link deactivated successfully\");\r\n        await this.loadLinks();\r\n      } else {\r\n        showMessage(\"error\", response.error || \"Failed to deactivate link\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[LINK-GENERATOR] Failed to deactivate link:\", error);\r\n      showMessage(\"error\", error.message || \"Failed to deactivate link\");\r\n    }\r\n  }\r\n  filterLinks() {\r\n    const roleFilter = document.getElementById(\"roleFilter\")?.value;\r\n    const statusFilter = document.getElementById(\"statusFilter\")?.value;\r\n    let filteredLinks = this.links;\r\n    if (roleFilter) {\r\n      filteredLinks = filteredLinks.filter(link => link.role === roleFilter);\r\n    }\r\n    if (statusFilter) {\r\n\r\n      if (statusFilter === \"active\") {\r\n        filteredLinks = filteredLinks.filter(link => !link.is_used && !link.is_expired);\r\n      } else if (statusFilter === \"expired\") {\r\n        filteredLinks = filteredLinks.filter(link => link.is_expired);\r\n      } else if (statusFilter === \"used\") {\r\n        filteredLinks = filteredLinks.filter(link => link.is_used);\r\n      }\r\n    }\r\n    // Temporarily replace links array for rendering\r\n    const originalLinks = this.links;\r\n    this.links = filteredLinks;\r\n    this.renderLinks();\r\n    this.links = originalLinks;\r\n  }\r\n}\r\n// Global functions for onclick handlers\r\nwindow.generateLink = () => {\r\n  if (window.linkGenerator) {\r\n    window.linkGenerator.generateLink();\r\n  }\r\n};\r\nwindow.copyLink = () => {\r\n  if (window.linkGenerator) {\r\n    window.linkGenerator.copyLink();\r\n  }\r\n};\r\nwindow.copyLinkUrl = (url) => {\r\n  if (window.linkGenerator) {\r\n    window.linkGenerator.copyLinkUrl(url);\r\n  }\r\n};\r\nwindow.deactivateLink = (linkId) => {\r\n  if (window.linkGenerator) {\r\n    window.linkGenerator.deactivateLink(linkId);\r\n  }\r\n};\r\nwindow.filterLinks = () => {\r\n  if (window.linkGenerator) {\r\n    window.linkGenerator.filterLinks();\r\n  }\r\n};\r\n// Initialize when DOM is loaded\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  window.linkGenerator = new LinkGenerator();\r\n});\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\pages\\404.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\pages\\500.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\pages\\admin\\department-structure.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":291,"column":8,"nodeType":"CallExpression","messageId":"unexpected","endLine":291,"endColumn":131},{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":305,"column":8,"nodeType":"CallExpression","messageId":"unexpected","endLine":305,"endColumn":116},{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":319,"column":8,"nodeType":"CallExpression","messageId":"unexpected","endLine":319,"endColumn":67}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Department Structure Management\r\n * Admin interface for managing categories, subcategories, and departments\r\n */\r\nimport showMessage from \"../../components/toast.js\";\r\nimport { apiClient } from \"../../config/apiClient.js\";\r\n\r\nlet categories = [];\r\nconst _subcategories = [];\r\nconst _departments = [];\r\n// Initialize the page\r\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\r\n  await loadAllData();\r\n  setupEventListeners();\r\n});\r\n/**\r\n * Load all department structure data\r\n */\r\nasync function loadAllData() {\r\n  try {\r\n    // Load categories with their subcategories and departments\r\n    const { data, error } = await apiClient.get(\"/api/department-structure/categories\");\r\n    if (error) throw error;\r\n    categories = data || [];\r\n    renderCategories();\r\n    updateStats();\r\n  } catch (error) {\r\n    console.error(\"Error loading department structure:\", error);\r\n    showMessage(\"error\", \"Failed to load department structure\");\r\n  }\r\n}\r\n/**\r\n * Render categories with their subcategories and departments\r\n */\r\nfunction renderCategories() {\r\n  const container = document.getElementById(\"categories-container\");\r\n  if (!container) return;\r\n  if (categories.length === 0) {\r\n    container.innerHTML = '<div class=\"loading\">No categories found</div>';\r\n    return;\r\n  }\r\n  container.innerHTML = categories.map(category => `\r\n        <div class=\"category-item\">\r\n            <div class=\"category-header\" onclick=\"toggleCategory('${category.id}')\">\r\n                <h3 class=\"category-title\">${category.icon} ${category.name}</h3>\r\n                <div class=\"category-actions\">\r\n                    <button class=\"btn-sm btn-edit\" onclick=\"editCategory('${category.id}')\">Edit</button>\r\n                    <button class=\"btn-sm btn-delete\" onclick=\"deleteCategory('${category.id}')\">Delete</button>\r\n                </div>\r\n            </div>\r\n            <div class=\"subcategories-container\" id=\"subcategories-${category.id}\">\r\n                ${category.subcategories ? category.subcategories.map(subcategory => `\r\n                    <div class=\"subcategory-item\">\r\n                        <div class=\"subcategory-header\" onclick=\"toggleSubcategory('${subcategory.id}')\">\r\n                            <h4 class=\"subcategory-title\">${subcategory.name}</h4>\r\n                            <div class=\"category-actions\">\r\n                                <button class=\"btn-sm btn-edit\" onclick=\"editSubcategory('${subcategory.id}')\">Edit</button>\r\n                                <button class=\"btn-sm btn-delete\" onclick=\"deleteSubcategory('${subcategory.id}')\">Delete</button>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"departments-container\" id=\"departments-${subcategory.id}\">\r\n                            ${subcategory.departments ? subcategory.departments.map(department => `\r\n                                <div class=\"department-item\">\r\n                                    <div class=\"department-info\">\r\n                                        <div class=\"department-name\">${department.name}</div>\r\n                                        <div class=\"department-details\">\r\n                                            ${department.code} | ${department.level} | ${department.response_time_hours}h response\r\n                                        </div>\r\n                                    </div>\r\n                                    <div class=\"category-actions\">\r\n                                        <button class=\"btn-sm btn-edit\" onclick=\"editDepartment('${department.id}')\">Edit</button>\r\n                                        <button class=\"btn-sm btn-delete\" onclick=\"deleteDepartment('${department.id}')\">Delete</button>\r\n                                    </div>\r\n                                </div>\r\n                            `).join(\"\") : '<div class=\"loading\">No departments</div>'}\r\n                        </div>\r\n                    </div>\r\n                `).join(\"\") : '<div class=\"loading\">No subcategories</div>'}\r\n            </div>\r\n        </div>\r\n    `).join(\"\");\r\n}\r\n/**\r\n * Update statistics\r\n */\r\nfunction updateStats() {\r\n  let totalSubcategories = 0;\r\n  let totalDepartments = 0;\r\n  let activeDepartments = 0;\r\n  categories.forEach(category => {\r\n    if (category.subcategories) {\r\n      totalSubcategories += category.subcategories.length;\r\n      category.subcategories.forEach(subcategory => {\r\n        if (subcategory.departments) {\r\n          totalDepartments += subcategory.departments.length;\r\n          activeDepartments += subcategory.departments.filter(dept => dept.is_active).length;\r\n        }\r\n      });\r\n    }\r\n  });\r\n  document.getElementById(\"total-categories\").textContent = categories.length;\r\n  document.getElementById(\"total-subcategories\").textContent = totalSubcategories;\r\n  document.getElementById(\"total-departments\").textContent = totalDepartments;\r\n  document.getElementById(\"active-departments\").textContent = activeDepartments;\r\n}\r\n/**\r\n * Setup event listeners\r\n */\r\nfunction setupEventListeners() {\r\n  // Category form\r\n  document.getElementById(\"category-form\").addEventListener(\"submit\", handleCategorySubmit);\r\n  // Subcategory form\r\n  document.getElementById(\"subcategory-form\").addEventListener(\"submit\", handleSubcategorySubmit);\r\n  // Department form\r\n  document.getElementById(\"department-form\").addEventListener(\"submit\", handleDepartmentSubmit);\r\n}\r\n/**\r\n * Toggle category expansion\r\n */\r\nwindow.toggleCategory = function(categoryId) {\r\n  const container = document.getElementById(`subcategories-${categoryId}`);\r\n  if (container) {\r\n    container.classList.toggle(\"expanded\");\r\n  }\r\n};\r\n/**\r\n * Toggle subcategory expansion\r\n */\r\nwindow.toggleSubcategory = function(subcategoryId) {\r\n  const container = document.getElementById(`departments-${subcategoryId}`);\r\n  if (container) {\r\n    container.classList.toggle(\"expanded\");\r\n  }\r\n};\r\n/**\r\n * Open modal for adding/editing\r\n */\r\nwindow.openModal = function(type, editId = null) {\r\n  const modal = document.getElementById(`${type}-modal`);\r\n  if (!modal) return;\r\n  // Reset form\r\n  const form = document.getElementById(`${type}-form`);\r\n  if (form) {\r\n    form.reset();\r\n  }\r\n  // Set modal title\r\n  const title = document.getElementById(`${type}-modal-title`);\r\n  if (title) {\r\n    title.textContent = editId ? `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}` : `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;\r\n  }\r\n  // Populate dropdowns\r\n  if (type === \"subcategory\") {\r\n    populateCategoryDropdown();\r\n  } else if (type === \"department\") {\r\n    populateSubcategoryDropdown();\r\n  }\r\n  // If editing, populate form with existing data\r\n  if (editId) {\r\n    populateFormForEdit(type, editId);\r\n  }\r\n  modal.classList.add(\"show\");\r\n};\r\n/**\r\n * Close modal\r\n */\r\nwindow.closeModal = function(type) {\r\n  const modal = document.getElementById(`${type}-modal`);\r\n  if (modal) {\r\n    modal.classList.remove(\"show\");\r\n  }\r\n};\r\n/**\r\n * Populate category dropdown\r\n */\r\nfunction populateCategoryDropdown() {\r\n  const select = document.getElementById(\"subcategory-category\");\r\n  if (!select) return;\r\n  select.innerHTML = '<option value=\"\">Select a category</option>';\r\n  categories.forEach(category => {\r\n    const option = document.createElement(\"option\");\r\n    option.value = category.id;\r\n    option.textContent = `${category.icon} ${category.name}`;\r\n    select.appendChild(option);\r\n  });\r\n}\r\n/**\r\n * Populate subcategory dropdown\r\n */\r\nfunction populateSubcategoryDropdown() {\r\n  const select = document.getElementById(\"department-subcategory\");\r\n  if (!select) return;\r\n  select.innerHTML = '<option value=\"\">Select a subcategory</option>';\r\n  categories.forEach(category => {\r\n    if (category.subcategories) {\r\n      category.subcategories.forEach(subcategory => {\r\n        const option = document.createElement(\"option\");\r\n        option.value = subcategory.id;\r\n        option.textContent = `${category.name} - ${subcategory.name}`;\r\n        select.appendChild(option);\r\n      });\r\n    }\r\n  });\r\n}\r\n/**\r\n * Handle category form submission\r\n */\r\nasync function handleCategorySubmit(e) {\r\n  e.preventDefault();\r\n  const formData = {\r\n    name: document.getElementById(\"category-name\").value,\r\n    code: document.getElementById(\"category-code\").value,\r\n    description: document.getElementById(\"category-description\").value,\r\n    icon: document.getElementById(\"category-icon\").value,\r\n    sort_order: parseInt(document.getElementById(\"category-sort-order\").value) || 0\r\n  };\r\n  try {\r\n    const { _data, error } = await apiClient.post(\"/api/department-structure/admin/categories\", formData);\r\n    if (error) throw error;\r\n    showMessage(\"success\", \"Category created successfully\");\r\n    closeModal(\"category\");\r\n    await loadAllData();\r\n  } catch (error) {\r\n    console.error(\"Error creating category:\", error);\r\n    showMessage(\"error\", \"Failed to create category\");\r\n  }\r\n}\r\n/**\r\n * Handle subcategory form submission\r\n */\r\nasync function handleSubcategorySubmit(e) {\r\n  e.preventDefault();\r\n  const formData = {\r\n    category_id: document.getElementById(\"subcategory-category\").value,\r\n    name: document.getElementById(\"subcategory-name\").value,\r\n    code: document.getElementById(\"subcategory-code\").value,\r\n    description: document.getElementById(\"subcategory-description\").value,\r\n    sort_order: parseInt(document.getElementById(\"subcategory-sort-order\").value) || 0\r\n  };\r\n  try {\r\n    const { _data, error } = await apiClient.post(\"/api/department-structure/admin/subcategories\", formData);\r\n    if (error) throw error;\r\n    showMessage(\"success\", \"Subcategory created successfully\");\r\n    closeModal(\"subcategory\");\r\n    await loadAllData();\r\n  } catch (error) {\r\n    console.error(\"Error creating subcategory:\", error);\r\n    showMessage(\"error\", \"Failed to create subcategory\");\r\n  }\r\n}\r\n/**\r\n * Handle department form submission\r\n */\r\nasync function handleDepartmentSubmit(e) {\r\n  e.preventDefault();\r\n  const formData = {\r\n    subcategory_id: document.getElementById(\"department-subcategory\").value,\r\n    name: document.getElementById(\"department-name\").value,\r\n    code: document.getElementById(\"department-code\").value,\r\n    description: document.getElementById(\"department-description\").value,\r\n    level: document.getElementById(\"department-level\").value,\r\n    response_time_hours: parseInt(document.getElementById(\"department-response-time\").value) || 24,\r\n    escalation_time_hours: parseInt(document.getElementById(\"department-escalation-time\").value) || 72\r\n  };\r\n  try {\r\n    const { _data, error } = await apiClient.post(\"/api/department-structure/admin/departments\", formData);\r\n    if (error) throw error;\r\n    showMessage(\"success\", \"Department created successfully\");\r\n    closeModal(\"department\");\r\n    await loadAllData();\r\n  } catch (error) {\r\n    console.error(\"Error creating department:\", error);\r\n    showMessage(\"error\", \"Failed to create department\");\r\n  }\r\n}\r\n/**\r\n * Edit functions (placeholder - would need to implement edit functionality)\r\n */\r\nwindow.editCategory = function(_id) {\r\n  showMessage(\"info\", \"Edit functionality coming soon\");\r\n};\r\nwindow.editSubcategory = function(_id) {\r\n  showMessage(\"info\", \"Edit functionality coming soon\");\r\n};\r\nwindow.editDepartment = function(_id) {\r\n  showMessage(\"info\", \"Edit functionality coming soon\");\r\n};\r\n/**\r\n * Delete functions\r\n */\r\nwindow.deleteCategory = async function(id) {\r\n  if (!confirm(\"Are you sure you want to delete this category? This will also delete all subcategories and departments under it.\")) {\r\n    return;\r\n  }\r\n  try {\r\n    const { error } = await apiClient.delete(`/api/department-structure/admin/categories/${id}`);\r\n    if (error) throw error;\r\n    showMessage(\"success\", \"Category deleted successfully\");\r\n    await loadAllData();\r\n  } catch (error) {\r\n    console.error(\"Error deleting category:\", error);\r\n    showMessage(\"error\", \"Failed to delete category\");\r\n  }\r\n};\r\nwindow.deleteSubcategory = async function(id) {\r\n  if (!confirm(\"Are you sure you want to delete this subcategory? This will also delete all departments under it.\")) {\r\n    return;\r\n  }\r\n  try {\r\n    const { error } = await apiClient.delete(`/api/department-structure/admin/subcategories/${id}`);\r\n    if (error) throw error;\r\n    showMessage(\"success\", \"Subcategory deleted successfully\");\r\n    await loadAllData();\r\n  } catch (error) {\r\n    console.error(\"Error deleting subcategory:\", error);\r\n    showMessage(\"error\", \"Failed to delete subcategory\");\r\n  }\r\n};\r\nwindow.deleteDepartment = async function(id) {\r\n  if (!confirm(\"Are you sure you want to delete this department?\")) {\r\n    return;\r\n  }\r\n  try {\r\n    const { error } = await apiClient.delete(`/api/department-structure/admin/departments/${id}`);\r\n    if (error) throw error;\r\n    showMessage(\"success\", \"Department deleted successfully\");\r\n    await loadAllData();\r\n  } catch (error) {\r\n    console.error(\"Error deleting department:\", error);\r\n    showMessage(\"error\", \"Failed to delete department\");\r\n  }\r\n};\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\pages\\lgu-admin\\assignments.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\pages\\lgu\\taskAssigned.js","messages":[],"suppressedMessages":[{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":95,"column":16,"nodeType":"Literal","endLine":95,"endColumn":69,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":98,"column":16,"nodeType":"Literal","endLine":98,"endColumn":69,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":101,"column":16,"nodeType":"Literal","endLine":101,"endColumn":63,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\pages\\privacy-notice.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\super-admin\\dashboard.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":617,"column":10,"nodeType":"CallExpression","messageId":"unexpected","endLine":619,"endColumn":10},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\\".","line":786,"column":19,"nodeType":"TemplateElement","messageId":"unnecessaryEscape","endLine":786,"endColumn":20,"suggestions":[{"messageId":"removeEscape","fix":{"range":[27101,27102],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[27101,27101],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\\".","line":786,"column":75,"nodeType":"TemplateElement","messageId":"unnecessaryEscape","endLine":786,"endColumn":76,"suggestions":[{"messageId":"removeEscape","fix":{"range":[27157,27158],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[27157,27157],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\\".","line":809,"column":15,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":809,"endColumn":16,"suggestions":[{"messageId":"removeEscape","fix":{"range":[27687,27688],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[27687,27687],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Super Admin Dashboard\r\n * System-wide management interface\r\n */\r\nimport showMessage from \"../components/toast.js\";\r\n\r\n// Check for OAuth success message\r\nconst oauthSuccessMessage = sessionStorage.getItem(\"oauth_success_message\");\r\nif (oauthSuccessMessage) {\r\n  sessionStorage.removeItem(\"oauth_success_message\");\r\n  showMessage(\"success\", oauthSuccessMessage, 5000);\r\n}\r\n\r\n// Initialize dashboard\r\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\r\n  await loadDashboardData();\r\n  await loadRoleCounts();\r\n  await loadLatestUsers();\r\n  await loadRoleDistribution();\r\n  await loadApiHealth();\r\n  await loadLogs();\r\n  startTrafficMonitor();\r\n\r\n  // Setup refresh button event listeners\r\n  const refreshRoleDistributionBtn = document.getElementById(\r\n    \"refresh-role-distribution-btn\"\r\n  );\r\n  if (refreshRoleDistributionBtn) {\r\n    refreshRoleDistributionBtn.addEventListener(\"click\", loadRoleDistribution);\r\n  }\r\n\r\n  const refreshLatestUsersBtn = document.getElementById(\r\n    \"refresh-latest-users-btn\"\r\n  );\r\n  if (refreshLatestUsersBtn) {\r\n    refreshLatestUsersBtn.addEventListener(\"click\", loadLatestUsers);\r\n  }\r\n\r\n  // Setup help button (placeholder for future implementation)\r\n  const getHelpBtn = document.getElementById(\"get-help-btn\");\r\n  if (getHelpBtn) {\r\n    getHelpBtn.addEventListener(\"click\", () => {\r\n      showMessage(\"info\", \"Help feature coming soon\");\r\n    });\r\n  }\r\n});\r\n\r\n// Chart instance for role distribution\r\nlet roleDistributionChart = null;\r\n/**\r\n * Load department roles dynamically\r\n */\r\nasync function _loadDepartmentRoles() {\r\n  try {\r\n    const apiClient = (await import(\"../config/apiClient.js\")).default;\r\n    // Prefer the explicit endpoint that exists in routes\r\n    let departments = [];\r\n    try {\r\n      const res = await apiClient.get(\r\n        \"/api/department-structure/departments/all\"\r\n      );\r\n      if (res && res.success && Array.isArray(res.data)) {\r\n        departments = res.data;\r\n      }\r\n    } catch {}\r\n    // Fallback to categories tree if needed\r\n    if (!departments.length) {\r\n      const res2 = await apiClient.get(\"/api/department-structure/categories\");\r\n      if (res2 && res2.success && Array.isArray(res2.data)) {\r\n        departments = [];\r\n        res2.data.forEach((cat) =>\r\n          cat.subcategories?.forEach((sc) =>\r\n            sc.departments?.forEach((d) => departments.push(d))\r\n          )\r\n        );\r\n      }\r\n    }\r\n    // departments loaded via one of the endpoints above\r\n    // Load role swap dropdown\r\n    const roleSwapSelect = document.getElementById(\"role-swap-role\");\r\n    if (roleSwapSelect) {\r\n      const loadingEl = document.getElementById(\"department-roles-loading\");\r\n      if (loadingEl) loadingEl.remove();\r\n      departments.forEach((dept) => {\r\n        // Add officer role\r\n        const officerOption = document.createElement(\"option\");\r\n        officerOption.value = `lgu-${dept.code.toLowerCase()}`;\r\n        officerOption.textContent = `LGU Officer - ${dept.name} (${dept.code})`;\r\n        roleSwapSelect.appendChild(officerOption);\r\n        // Add admin role\r\n        const adminOption = document.createElement(\"option\");\r\n        adminOption.value = `lgu-admin-${dept.code.toLowerCase()}`;\r\n        adminOption.textContent = `LGU Admin - ${dept.name}`;\r\n        roleSwapSelect.appendChild(adminOption);\r\n      });\r\n    }\r\n    // Load assign citizen dropdown\r\n    const assignCitizenSelect = document.getElementById(\"assign-citizen-role\");\r\n    if (assignCitizenSelect) {\r\n      const loadingEl = document.getElementById(\"assign-citizen-roles-loading\");\r\n      if (loadingEl) loadingEl.remove();\r\n      departments.forEach((dept) => {\r\n        // Add officer role\r\n        const officerOption = document.createElement(\"option\");\r\n        officerOption.value = `lgu-${dept.code.toLowerCase()}`;\r\n        officerOption.textContent = `LGU Officer - ${dept.name} (${dept.code})`;\r\n        assignCitizenSelect.appendChild(officerOption);\r\n        // Add admin role\r\n        const adminOption = document.createElement(\"option\");\r\n        adminOption.value = `lgu-admin-${dept.code.toLowerCase()}`;\r\n        adminOption.textContent = `LGU Admin - ${dept.name}`;\r\n        assignCitizenSelect.appendChild(adminOption);\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Error loading department roles:\", error);\r\n    // Show error in loading placeholders\r\n    const loadingEls = document.querySelectorAll('[id$=\"-loading\"]');\r\n    loadingEls.forEach((el) => {\r\n      el.innerHTML = '<option value=\"\">Error loading departments</option>';\r\n    });\r\n  }\r\n}\r\n/**\r\n * Load dashboard data\r\n */\r\nasync function loadDashboardData() {\r\n  try {\r\n    const [statsResponse, dashboardResponse] = await Promise.all([\r\n      fetch(\"/api/superadmin/statistics\"),\r\n      fetch(\"/api/superadmin/dashboard\"),\r\n    ]);\r\n    const [statsResult, dashboardResult] = await Promise.all([\r\n      statsResponse.json(),\r\n      dashboardResponse.json(),\r\n    ]);\r\n    if (statsResult.success) {\r\n      updateStatistics(statsResult.statistics);\r\n    }\r\n    if (dashboardResult.success) {\r\n      // Additional dashboard data if needed\r\n      // console.log removed for security\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Load dashboard error:\", error);\r\n  }\r\n}\r\n/**\r\n * Update statistics display\r\n */\r\nfunction updateStatistics(stats) {\r\n  document.getElementById(\"stat-complaints\").textContent =\r\n    stats.total_complaints || 0;\r\n  document.getElementById(\"stat-role-changes\").textContent =\r\n    stats.total_role_changes || 0;\r\n  document.getElementById(\"stat-dept-transfers\").textContent =\r\n    stats.total_department_transfers || 0;\r\n}\r\n/**\r\n * Load role counts (users, admins, hr, officers)\r\n */\r\nasync function loadRoleCounts() {\r\n  try {\r\n    const _res = await fetch(\"/api/superadmin/users?limit=1\");\r\n    const metaRes = await fetch(\"/api/superadmin/users?limit=1000\");\r\n    const meta = await metaRes.json();\r\n    const users = meta.success && Array.isArray(meta.data) ? meta.data : [];\r\n    const totalUsers = users.length;\r\n    // Admins: count LGU admins only (exclude super-admin)\r\n    const admins = users.filter((u) =>\r\n      /^lgu-admin/.test(String(u.role || \"\").toLowerCase())\r\n    ).length;\r\n    // HR: include lgu-hr variants\r\n    const hr = users.filter(\r\n      (u) =>\r\n        String(u.role || \"\").toLowerCase() === \"lgu-hr\" ||\r\n        /^lgu-hr/.test(String(u.role || \"\").toLowerCase())\r\n    ).length;\r\n    // Officers: include simplified 'lgu' and legacy lgu-* (excluding admin/hr)\r\n    const roleStr = (r) => String(r || \"\").toLowerCase();\r\n    const officers = users.filter((u) => {\r\n      const r = roleStr(u.role);\r\n      return r === \"lgu\" || /^lgu-(?!admin|hr)/.test(r);\r\n    }).length;\r\n    setText(\"stat-users\", totalUsers);\r\n    setText(\"stat-admins\", admins);\r\n    setText(\"stat-hr\", hr);\r\n    setText(\"stat-officers\", officers);\r\n  } catch (e) {\r\n    // ignore\r\n  }\r\n}\r\nfunction setText(id, v) {\r\n  const el = document.getElementById(id);\r\n  if (el) el.textContent = String(v);\r\n}\r\n/**\r\n * Load role distribution and render pie chart\r\n */\r\nwindow.loadRoleDistribution = async function loadRoleDistribution() {\r\n  try {\r\n    const response = await fetch(\"/api/superadmin/role-distribution\");\r\n    const result = await response.json();\r\n\r\n    if (!result.success || !result.distribution) {\r\n      console.error(\r\n        \"[SUPER_ADMIN] Failed to load role distribution:\",\r\n        result.error\r\n      );\r\n      return;\r\n    }\r\n\r\n    const { citizens, hr, officers, admins } = result.distribution;\r\n    renderRoleDistributionChart({ citizens, hr, officers, admins });\r\n  } catch (error) {\r\n    console.error(\"[SUPER_ADMIN] Load role distribution error:\", error);\r\n  }\r\n};\r\n\r\n/**\r\n * Render role distribution pie chart (Super Admin)\r\n */\r\nfunction renderRoleDistributionChart(data) {\r\n  const canvas = document.getElementById(\"role-distribution-chart\");\r\n  if (!canvas) return;\r\n\r\n  const ctx = canvas.getContext(\"2d\");\r\n\r\n  // Destroy existing chart if it exists\r\n  if (roleDistributionChart) {\r\n    roleDistributionChart.destroy();\r\n  }\r\n\r\n  const values = [\r\n    data.citizens || 0,\r\n    data.hr || 0,\r\n    data.officers || 0,\r\n    data.admins || 0,\r\n  ];\r\n  const total = values.reduce((a, b) => a + b, 0);\r\n\r\n  const chartData = {\r\n    labels: [\r\n      `Citizens (${values[0]})`,\r\n      `HR (${values[1]})`,\r\n      `Officers (${values[2]})`,\r\n      `Admins (${values[3]})`,\r\n    ],\r\n    datasets: [\r\n      {\r\n        data: values,\r\n        backgroundColor: [\r\n          \"#3b82f6\", // Blue for Citizens\r\n          \"#10b981\", // Green for HR\r\n          \"#f59e0b\", // Orange for Officers\r\n          \"#8b5cf6\", // Purple for Admins\r\n        ],\r\n        borderColor: \"#ffffff\",\r\n        borderWidth: 2,\r\n      },\r\n    ],\r\n  };\r\n\r\n  roleDistributionChart = new Chart(ctx, {\r\n    type: \"pie\",\r\n    data: chartData,\r\n    options: {\r\n      responsive: true,\r\n      maintainAspectRatio: true,\r\n      plugins: {\r\n        legend: {\r\n          position: \"bottom\",\r\n          labels: {\r\n            padding: 15,\r\n            font: {\r\n              size: 14,\r\n            },\r\n            generateLabels(chart) {\r\n              const { data } = chart;\r\n              if (data.labels.length && data.datasets.length) {\r\n                return data.labels.map((label, i) => {\r\n                  const value = data.datasets[0].data[i];\r\n                  const percentage =\r\n                    total > 0 ? ((value / total) * 100).toFixed(1) : 0;\r\n                  return {\r\n                    text: `${label} - ${percentage}%`,\r\n                    fillStyle: data.datasets[0].backgroundColor[i],\r\n                    strokeStyle: data.datasets[0].borderColor,\r\n                    lineWidth: data.datasets[0].borderWidth,\r\n                    hidden: false,\r\n                    index: i,\r\n                  };\r\n                });\r\n              }\r\n              return [];\r\n            },\r\n          },\r\n        },\r\n        tooltip: {\r\n          callbacks: {\r\n            label(context) {\r\n              const label = context.label || \"\";\r\n              const value = context.parsed || 0;\r\n              const total = context.dataset.data.reduce((a, b) => a + b, 0);\r\n              const percentage =\r\n                total > 0 ? ((value / total) * 100).toFixed(1) : 0;\r\n              return `${label.split(\" (\")[0]}: ${value} users (${percentage}%)`;\r\n            },\r\n          },\r\n        },\r\n      },\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * Load latest registered users\r\n */\r\nwindow.loadLatestUsers = async function () {\r\n  try {\r\n    const container = document.getElementById(\"latest-users-container\");\r\n    if (!container) return;\r\n\r\n    // Show loading state\r\n    container.innerHTML = `\r\n      <div class=\"loading\">\r\n        <div class=\"spinner\"></div>\r\n        <p>Loading latest users...</p>\r\n      </div>\r\n    `;\r\n\r\n    const response = await fetch(\"/api/superadmin/latest-users?limit=5\");\r\n    const result = await response.json();\r\n\r\n    if (result.success && result.users) {\r\n      displayLatestUsers(result.users);\r\n    } else {\r\n      container.innerHTML = `<p class=\"empty-state\" style=\"color: #ef4444;\">Failed to load users: ${\r\n        result.error || \"Unknown error\"\r\n      }</p>`;\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Load latest users error:\", error);\r\n    const container = document.getElementById(\"latest-users-container\");\r\n    if (container) {\r\n      container.innerHTML =\r\n        '<p class=\"empty-state\" style=\"color: #ef4444;\">Failed to load latest users</p>';\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Display latest registered users\r\n */\r\nfunction displayLatestUsers(users) {\r\n  const container = document.getElementById(\"latest-users-container\");\r\n  if (!container) return;\r\n\r\n  if (users.length === 0) {\r\n    container.innerHTML =\r\n      '<p class=\"empty-state\">No registered users found</p>';\r\n    return;\r\n  }\r\n\r\n  const html = `\r\n    <div class=\"latest-users-list\">\r\n      ${users\r\n    .map((user) => {\r\n      const registrationDate = new Date(user.created_at).toLocaleString();\r\n      const emailConfirmedDate = user.email_confirmed_at\r\n        ? new Date(user.email_confirmed_at).toLocaleString()\r\n        : null;\r\n      const authMethod = user.is_oauth ? \"OAuth\" : \"Email\";\r\n      const roleBadge = user.role || \"citizen\";\r\n\r\n      return `\r\n          <div class=\"user-item\" style=\"display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid #e5e7eb; gap: 1rem;\">\r\n            <div style=\"flex: 1;\">\r\n              <div style=\"display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;\">\r\n                <div style=\"width: 40px; height: 40px; border-radius: 50%; background: #3b82f6; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.1rem;\">\r\n                  ${(user.name || user.email || \"U\").charAt(0).toUpperCase()}\r\n                </div>\r\n                <div>\r\n                  <div style=\"font-weight: 600; color: #111827; margin-bottom: 0.25rem;\">\r\n                    ${user.name || user.email || \"Unknown User\"}\r\n                  </div>\r\n                  <div style=\"font-size: 0.875rem; color: #6b7280;\">\r\n                    ${user.email || \"No email\"}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              <div style=\"display: flex; gap: 1rem; font-size: 0.875rem; color: #6b7280; flex-wrap: wrap;\">\r\n                <span><strong>Role:</strong> ${roleBadge}</span>\r\n                <span><strong>Method:</strong> ${authMethod}</span>\r\n                ${\r\n  emailConfirmedDate\r\n    ? `<span><strong>Confirmed:</strong> ${emailConfirmedDate}</span>`\r\n    : \"\"\r\n}\r\n              </div>\r\n            </div>\r\n            <div style=\"text-align: right; font-size: 0.875rem; color: #6b7280;\">\r\n              <div style=\"font-weight: 500; color: #111827; margin-bottom: 0.25rem;\">Registered</div>\r\n              <div>${registrationDate}</div>\r\n            </div>\r\n          </div>\r\n        `;\r\n    })\r\n    .join(\"\")}\r\n    </div>\r\n  `;\r\n\r\n  container.innerHTML = html;\r\n}\r\n/**\r\n * API Health\r\n */\r\nasync function loadApiHealth() {\r\n  const el = document.getElementById(\"api-health-status\");\r\n  const indicator = document.getElementById(\"api-health-indicator\");\r\n  if (!el) return;\r\n  try {\r\n    const res = await fetch(\"/api/health\");\r\n    const data = await res.json();\r\n    if (data && data.success) {\r\n      el.textContent = `Healthy • ${new Date(data.timestamp).toLocaleString()}`;\r\n      el.style.color = \"#10b981\";\r\n      if (indicator) {\r\n        indicator.style.background = \"#10b981\";\r\n      }\r\n    } else {\r\n      el.textContent = \"Unhealthy\";\r\n      el.style.color = \"#ef4444\";\r\n      if (indicator) {\r\n        indicator.style.background = \"#ef4444\";\r\n      }\r\n    }\r\n  } catch {\r\n    el.textContent = \"Health check failed\";\r\n    el.style.color = \"#ef4444\";\r\n    if (indicator) {\r\n      indicator.style.background = \"#ef4444\";\r\n    }\r\n  }\r\n  const btn = document.getElementById(\"btn-refresh-health\");\r\n  if (btn) btn.onclick = loadApiHealth;\r\n}\r\n/**\r\n * Traffic monitor using rate-limit status (proxy for request volume)\r\n */\r\nfunction startTrafficMonitor() {\r\n  const graph = document.getElementById(\"traffic-graph\");\r\n  const meta = document.getElementById(\"traffic-meta\");\r\n  if (!graph || !meta) return;\r\n  const bars = [];\r\n  async function tick() {\r\n    try {\r\n      const res = await fetch(\"/api/rate-limit/status\");\r\n      const data = await res.json();\r\n      const requests = (data && data.status && data.status.requests) || 0;\r\n      bars.push(requests);\r\n      if (bars.length > 60) bars.shift();\r\n      renderBars(bars, graph);\r\n      meta.textContent = `Requests in window: ${requests}, Remaining: ${\r\n        (data && data.status && data.status.remaining) || \"-\"\r\n      }`;\r\n    } catch {}\r\n  }\r\n  tick();\r\n  setInterval(tick, 1000);\r\n}\r\nfunction renderBars(values, container) {\r\n  const max = Math.max(1, ...values);\r\n  container.innerHTML = values\r\n    .map((v) => {\r\n      const h = Math.round((v / max) * 100);\r\n      return `<div style=\"width: 8px; height:${h}%; background:#3b82f6; border-radius:2px;\"></div>`;\r\n    })\r\n    .join(\"\");\r\n}\r\n/**\r\n * Load system logs\r\n */\r\nwindow.loadLogs = async function () {\r\n  try {\r\n    const logType = document.getElementById(\"log-type-filter\").value;\r\n    const response = await fetch(\r\n      `/api/superadmin/logs?log_type=${logType}&limit=50`\r\n    );\r\n    const result = await response.json();\r\n    if (result.success) {\r\n      displayLogs(result.logs);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Load logs error:\", error);\r\n    const container = document.getElementById(\"logs-container\");\r\n    if (container) {\r\n      container.innerHTML =\r\n        '<p class=\"empty-state\" style=\"color: #ef4444;\">Failed to load logs</p>';\r\n    }\r\n  }\r\n};\r\n/**\r\n * Display logs\r\n */\r\nfunction displayLogs(logs) {\r\n  const container = document.getElementById(\"logs-container\");\r\n  const allLogs = [];\r\n  // Combine all log types\r\n  if (logs.role_changes) {\r\n    logs.role_changes.forEach((log) => {\r\n      allLogs.push({ ...log, log_type: \"role_change\" });\r\n    });\r\n  }\r\n  if (logs.department_transfers) {\r\n    logs.department_transfers.forEach((log) => {\r\n      allLogs.push({ ...log, log_type: \"dept_transfer\" });\r\n    });\r\n  }\r\n  if (logs.complaint_workflow) {\r\n    logs.complaint_workflow.forEach((log) => {\r\n      allLogs.push({ ...log, log_type: \"complaint\" });\r\n    });\r\n  }\r\n  // Sort by date\r\n  allLogs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));\r\n  if (allLogs.length === 0) {\r\n    container.innerHTML = '<p class=\"empty-state\">No logs found</p>';\r\n    return;\r\n  }\r\n  const html = allLogs\r\n    .slice(0, 50)\r\n    .map((log) => formatLogEntry(log))\r\n    .join(\"\");\r\n  container.innerHTML = html;\r\n}\r\n/**\r\n * Format log entry\r\n */\r\nfunction formatLogEntry(log) {\r\n  const date = new Date(log.created_at).toLocaleString();\r\n  let content = \"\";\r\n  let typeLabel = \"\";\r\n  let typeColor = \"#667eea\";\r\n  if (log.log_type === \"role_change\") {\r\n    typeLabel = \"Role Change\";\r\n    typeColor = \"#3498db\";\r\n    const userEmail = log.user?.email || \"Unknown\";\r\n    const performerEmail = log.performer?.email || \"System\";\r\n    content = `\r\n      <strong>${userEmail}</strong>: ${log.old_role} → ${log.new_role}\r\n      <div style=\"color: #64748b; font-size: 0.875rem; margin-top: 0.5rem;\">By: ${performerEmail}</div>\r\n      ${\r\n  log.metadata?.reason\r\n    ? `<div style=\"margin-top: 0.5rem; color: #64748b; font-size: 0.875rem;\">Reason: ${log.metadata.reason}</div>`\r\n    : \"\"\r\n}\r\n    `;\r\n  } else if (log.log_type === \"dept_transfer\") {\r\n    typeLabel = \"Dept Transfer\";\r\n    typeColor = \"#f59e0b\";\r\n    const userEmail = log.user?.email || \"Unknown\";\r\n    const performerEmail = log.performer?.email || \"System\";\r\n    content = `\r\n      <strong>${userEmail}</strong>: ${log.from_department || \"N/A\"} → ${\r\n  log.to_department\r\n}\r\n      <div style=\"color: #64748b; font-size: 0.875rem; margin-top: 0.5rem;\">By: ${performerEmail}</div>\r\n      ${\r\n  log.reason\r\n    ? `<div style=\"margin-top: 0.5rem; color: #64748b; font-size: 0.875rem;\">Reason: ${log.reason}</div>`\r\n    : \"\"\r\n}\r\n    `;\r\n  } else if (log.log_type === \"complaint\") {\r\n    typeLabel = \"Complaint\";\r\n    typeColor = \"#10b981\";\r\n    content = `\r\n      <strong>${\r\n  log.action_type\r\n}</strong>: Complaint #${log.complaint_id?.substring(0, 8)}...\r\n      ${\r\n  log.details\r\n    ? `<div style=\"margin-top: 0.5rem; color: #64748b; font-size: 0.875rem;\">${JSON.stringify(\r\n      log.details\r\n    )}</div>`\r\n    : \"\"\r\n}\r\n    `;\r\n  }\r\n\r\n  return `\r\n    <div class=\"log-entry\">\r\n      <div class=\"log-entry-header\">\r\n        <span class=\"log-type\" style=\"background: ${typeColor};\">${typeLabel}</span>\r\n        <span class=\"log-entry-date\">${date}</span>\r\n      </div>\r\n      <div class=\"log-entry-content\">${content}</div>\r\n    </div>\r\n  `;\r\n}\r\n\r\n/**\r\n * Setup form handlers\r\n */\r\nfunction _setupFormHandlers() {\r\n  // Role Swap\r\n  document\r\n    .getElementById(\"role-swap-form\")\r\n    .addEventListener(\"submit\", async (e) => {\r\n      e.preventDefault();\r\n      const userId = document.getElementById(\"role-swap-user\").value;\r\n      const newRole = document.getElementById(\"role-swap-role\").value;\r\n      const reason = document.getElementById(\"role-swap-reason\").value;\r\n\r\n      if (\r\n        !confirm(\r\n          `Are you sure you want to change this user's role to ${newRole}?`\r\n        )\r\n      ) {\r\n        return;\r\n      }\r\n      await performRoleSwap(userId, newRole, reason);\r\n    });\r\n  // Department Transfer\r\n  document\r\n    .getElementById(\"dept-transfer-form\")\r\n    .addEventListener(\"submit\", async (e) => {\r\n      e.preventDefault();\r\n      const userId = document.getElementById(\"dept-transfer-user\").value;\r\n      const fromDept = document.getElementById(\"dept-transfer-from\").value;\r\n      const toDept = document.getElementById(\"dept-transfer-to\").value;\r\n      const reason = document.getElementById(\"dept-transfer-reason\").value;\r\n      await transferDepartment(userId, fromDept, toDept, reason);\r\n    });\r\n  // Assign Citizen\r\n  document\r\n    .getElementById(\"assign-citizen-form\")\r\n    .addEventListener(\"submit\", async (e) => {\r\n      e.preventDefault();\r\n      const userId = document.getElementById(\"assign-citizen-user\").value;\r\n      const role = document.getElementById(\"assign-citizen-role\").value;\r\n      const department = document.getElementById(\"assign-citizen-dept\").value;\r\n      const reason = document.getElementById(\"assign-citizen-reason\").value;\r\n      await assignCitizen(userId, role, department, reason);\r\n    });\r\n  // Log type filter change\r\n  document.getElementById(\"log-type-filter\").addEventListener(\"change\", () => {\r\n    loadLogs();\r\n  });\r\n}\r\nfunction _setupUserSearchSA() {\r\n  const btn = document.getElementById(\"sa-user-search-btn\");\r\n  const input = document.getElementById(\"sa-user-search\");\r\n  const brgy = document.getElementById(\"sa-user-barangay\");\r\n  async function run() {\r\n    const q = encodeURIComponent(input?.value || \"\");\r\n    const b = encodeURIComponent(brgy?.value || \"\");\r\n    const url = `/api/superadmin/users?search=${q}${b ? `&barangay=${b}` : \"\"}`;\r\n    try {\r\n      const res = await fetch(url);\r\n      const result = await res.json();\r\n      if (result.success) {\r\n        renderUserListSA(result.data || []);\r\n      } else {\r\n        renderUserListSA([]);\r\n      }\r\n    } catch (e) {\r\n      console.error(\"[SUPERADMIN] user search error:\", e);\r\n      renderUserListSA([]);\r\n    }\r\n  }\r\n  if (btn) btn.addEventListener(\"click\", run);\r\n  if (input)\r\n    input.addEventListener(\"keypress\", (e) => {\r\n      if (e.key === \"Enter\") run();\r\n    });\r\n}\r\nfunction renderUserListSA(users) {\r\n  const list = document.getElementById(\"sa-user-list\");\r\n  if (!list) return;\r\n  if (!users.length) {\r\n    list.innerHTML = '<p class=\"empty-state\">No users found.</p>';\r\n    return;\r\n  }\r\n  list.innerHTML = users\r\n    .map(\r\n      (u) => `\r\n    <div class=\"user-item\" data-user-id=\"${u.id}\">\r\n      <div><strong>${escapeHtml(u.fullName || u.name || u.email)}</strong></div>\r\n      <div style=\"color:#64748b; font-size:0.875rem; margin-top:0.25rem;\">${escapeHtml(\r\n    u.email || \"\"\r\n  )}</div>\r\n      <div style=\"color:#64748b; font-size:0.875rem; margin-top:0.25rem;\">Role: ${escapeHtml(\r\n    u.role || \"\"\r\n  )} | Brgy: ${escapeHtml(u.address?.barangay || \"-\")}</div>\r\n    </div>\r\n  `\r\n    )\r\n    .join(\"\");\r\n  list.querySelectorAll(\".user-item\").forEach((el) => {\r\n    el.addEventListener(\"click\", async () => {\r\n      const id = el.getAttribute(\"data-user-id\");\r\n      await loadUserDetailsSA(id);\r\n      await loadUserComplaintsSA(id);\r\n    });\r\n  });\r\n}\r\nasync function loadUserDetailsSA(userId) {\r\n  try {\r\n    const res = await fetch(`/api/superadmin/users/${userId}`);\r\n    const result = await res.json();\r\n    const container = document.getElementById(\"sa-user-details\");\r\n    if (!container) return;\r\n    if (result.success && result.data) {\r\n      const u = result.data;\r\n      container.innerHTML = `\r\n        <div style=\"display:flex; gap:1rem; align-items:center; margin-bottom:1rem;\">\r\n          <div style=\"width:48px; height:48px; border-radius:50%; background:#e2e8f0; display:flex; align-items:center; justify-content:center; font-size:1.5rem;\">👤</div>\r\n          <div>\r\n            <div style=\"font-weight:700; font-size:1.125rem; color:#1e293b;\">${escapeHtml(\r\n    u.fullName || u.name || u.email\r\n  )}</div>\r\n            <div style=\"color:#64748b; font-size:0.875rem;\">${escapeHtml(\r\n    u.email || \"\"\r\n  )}</div>\r\n          </div>\r\n        </div>\r\n        <div style=\"display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; padding-top:1rem; border-top:1px solid #e2e8f0;\">\r\n          <div><strong style=\"color:#1e293b;\">Role:</strong> <span style=\"color:#64748b;\">${escapeHtml(\r\n    u.role || \"-\"\r\n  )}</span></div>\r\n          <div><strong style=\"color:#1e293b;\">Department:</strong> <span style=\"color:#64748b;\">${escapeHtml(\r\n    u.department || \"-\"\r\n  )}</span></div>\r\n          <div><strong style=\"color:#1e293b;\">Barangay:</strong> <span style=\"color:#64748b;\">${escapeHtml(\r\n    u.address?.barangay || \"-\"\r\n  )}</span></div>\r\n          <div><strong style=\"color:#1e293b;\">City:</strong> <span style=\"color:#64748b;\">${escapeHtml(\r\n    u.address?.city || \"-\"\r\n  )}</span></div>\r\n          <div><strong style=\"color:#1e293b;\">Mobile:</strong> <span style=\"color:#64748b;\">${escapeHtml(\r\n    u.mobileNumber || \"-\"\r\n  )}</span></div>\r\n        </div>\r\n      `;\r\n    } else {\r\n      container.innerHTML =\r\n        '<p class=\"empty-state\" style=\"color:#ef4444;\">Failed to load user.</p>';\r\n    }\r\n  } catch (e) {\r\n    console.error(\"[SUPERADMIN] load user details error:\", e);\r\n  }\r\n}\r\nasync function loadUserComplaintsSA(userId) {\r\n  try {\r\n    const res = await fetch(\r\n      `/api/superadmin/users/${userId}/complaints?limit=10`\r\n    );\r\n    const result = await res.json();\r\n    const container = document.getElementById(\"sa-user-complaints\");\r\n    if (!container) return;\r\n    if (result.success) {\r\n      const complaints = result.data || [];\r\n      if (!complaints.length) {\r\n        container.innerHTML = '<p class=\"empty-state\">No complaints found.</p>';\r\n        return;\r\n      }\r\n      container.innerHTML = complaints\r\n        .map(\r\n          (c) => `\r\n        <div style=\"padding:0.75rem; border:1px solid #e2e8f0; border-radius:0.5rem; background:#f8fafc; margin-bottom:0.75rem;\">\r\n          <div style=\"display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;\">\r\n            <strong style=\"color:#1e293b;\">${escapeHtml(\r\n    c.title || \"Untitled\"\r\n  )}</strong>\r\n            <span style=\"color:#64748b; font-size:0.875rem; padding:0.25rem 0.5rem; background:white; border-radius:0.25rem; border:1px solid #e2e8f0;\">${escapeHtml(\r\n    c.status || \"\"\r\n  )}</span>\r\n          </div>\r\n          <div style=\"color:#64748b; font-size:0.875rem;\">Type: ${escapeHtml(\r\n    c.type || \"-\"\r\n  )}</div>\r\n          ${\r\n  c.location_text\r\n    ? `<div style=\\\"color:#64748b; font-size:0.875rem; margin-top:0.25rem;\\\">${escapeHtml(\r\n      c.location_text\r\n    )}</div>`\r\n    : \"\"\r\n}\r\n        </div>\r\n      `\r\n        )\r\n        .join(\"\");\r\n    } else {\r\n      container.innerHTML =\r\n        '<p class=\"empty-state\" style=\"color:#ef4444;\">Failed to load complaints.</p>';\r\n    }\r\n  } catch (e) {\r\n    console.error(\"[SUPERADMIN] load user complaints error:\", e);\r\n  }\r\n}\r\nfunction escapeHtml(s) {\r\n  if (s == null) return \"\";\r\n  return String(s)\r\n    .replace(/&/g, \"&amp;\")\r\n    .replace(/</g, \"&lt;\")\r\n    .replace(/>/g, \"&gt;\")\r\n    .replace(/\\\"/g, \"&quot;\")\r\n    .replace(/'/g, \"&#39;\");\r\n}\r\n/**\r\n * Perform role swap\r\n */\r\nasync function performRoleSwap(userId, newRole, reason) {\r\n  try {\r\n    const response = await fetch(\"/api/superadmin/role-swap\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        user_id: userId,\r\n        new_role: newRole,\r\n        reason,\r\n      }),\r\n    });\r\n    const result = await response.json();\r\n    if (result.success) {\r\n      showMessage(\"success\", result.message);\r\n      document.getElementById(\"role-swap-form\").reset();\r\n      await loadDashboardData();\r\n      await loadLogs();\r\n    } else {\r\n      showMessage(\"error\", result.error);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Role swap error:\", error);\r\n    showMessage(\"error\", \"Failed to perform role swap\");\r\n  }\r\n}\r\n/**\r\n * Transfer department\r\n */\r\nasync function transferDepartment(userId, fromDept, toDept, reason) {\r\n  try {\r\n    const response = await fetch(\"/api/superadmin/transfer-department\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        user_id: userId,\r\n        from_department: fromDept,\r\n        to_department: toDept,\r\n        reason,\r\n      }),\r\n    });\r\n    const result = await response.json();\r\n    if (result.success) {\r\n      showMessage(\"success\", result.message);\r\n      document.getElementById(\"dept-transfer-form\").reset();\r\n      await loadDashboardData();\r\n      await loadLogs();\r\n    } else {\r\n      showMessage(\"error\", result.error);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Transfer department error:\", error);\r\n    showMessage(\"error\", \"Failed to transfer department\");\r\n  }\r\n}\r\n/**\r\n * Assign citizen\r\n */\r\nasync function assignCitizen(userId, role, department, reason) {\r\n  try {\r\n    const response = await fetch(\"/api/superadmin/assign-citizen\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        user_id: userId,\r\n        role,\r\n        department_id: department,\r\n        reason,\r\n      }),\r\n    });\r\n    const result = await response.json();\r\n    if (result.success) {\r\n      showMessage(\"success\", result.message);\r\n      document.getElementById(\"assign-citizen-form\").reset();\r\n      await loadDashboardData();\r\n      await loadLogs();\r\n    } else {\r\n      showMessage(\"error\", result.error);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[SUPERADMIN] Assign citizen error:\", error);\r\n    showMessage(\"error\", \"Failed to assign citizen\");\r\n  }\r\n}\r\n\r\n/**\r\n * Super Admin Global Helpers\r\n */\r\nwindow.refreshAuditLogs = () =>\r\n  window.loadLogs ? window.loadLogs() : console.error(\"loadLogs not found\");\r\nwindow.triggerBackup = () => {\r\n  showMessage(\"info\", \"Starting manual backup...\");\r\n  setTimeout(\r\n    () => showMessage(\"success\", \"Database backup completed and encrypted\"),\r\n    2000\r\n  );\r\n};\r\nwindow.manageCategories = () =>\r\n  showMessage(\"info\", \"Category management modal coming soon\");\r\nwindow.managePermissions = () =>\r\n  showMessage(\"info\", \"Permission management modal coming soon\");\r\nwindow.systemSettings = () =>\r\n  showMessage(\"info\", \"System settings modal coming soon\");\r\nwindow.apiKeys = () =>\r\n  showMessage(\"info\", \"API Key management modal coming soon\");\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\super-admin\\pending-signups.js","messages":[{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":117,"column":8,"nodeType":"CallExpression","messageId":"unexpected","endLine":117,"endColumn":72},{"ruleId":"no-alert","severity":1,"message":"Unexpected confirm.","line":147,"column":8,"nodeType":"CallExpression","messageId":"unexpected","endLine":147,"endColumn":71}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Super Admin Pending Signups Page\n * Display and manage pending signup requests\n */\nimport showMessage from \"../components/toast.js\";\n\n// Initialize page\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\n  // Attach event listeners to refresh buttons\n  const refreshBtnHeader = document.getElementById(\"refresh-btn-header\");\n  if (refreshBtnHeader) {\n    refreshBtnHeader.addEventListener(\"click\", loadPendingSignups);\n  }\n\n  const refreshBtnSection = document.getElementById(\"refresh-btn-section\");\n  if (refreshBtnSection) {\n    refreshBtnSection.addEventListener(\"click\", loadPendingSignups);\n  }\n\n  await loadPendingSignups();\n});\n\n/**\n * Load pending signups\n */\nwindow.loadPendingSignups = async function() {\n  try {\n    const container = document.getElementById(\"pending-signups-container\");\n    if (!container) return;\n\n    // Show loading state\n    container.innerHTML = `\n      <div class=\"loading\">\n        <div class=\"spinner\"></div>\n        <p>Loading pending signups...</p>\n      </div>\n    `;\n\n    const response = await fetch(\"/api/hr/pending-signups\");\n    const result = await response.json();\n\n    if (result.success && result.data) {\n      displayPendingSignups(result.data);\n    } else {\n      container.innerHTML = `<p class=\"empty-state\" style=\"color: #ef4444;\">Failed to load pending signups: ${  result.error || \"Unknown error\"  }</p>`;\n    }\n  } catch (error) {\n    console.error(\"[SUPERADMIN] Load pending signups error:\", error);\n    const container = document.getElementById(\"pending-signups-container\");\n    if (container) {\n      container.innerHTML = '<p class=\"empty-state\" style=\"color: #ef4444;\">Failed to load pending signups</p>';\n    }\n    showMessage(\"Failed to load pending signups\", \"error\");\n  }\n};\n\n/**\n * Display pending signups\n */\nfunction displayPendingSignups(users) {\n  const container = document.getElementById(\"pending-signups-container\");\n  if (!container) return;\n\n  if (users.length === 0) {\n    container.innerHTML = '<p class=\"empty-state\">No pending signups found</p>';\n    return;\n  }\n\n  const html = `\n    <div class=\"pending-signups-list\">\n      ${users.map(user => {\n    const name = user.name || user.fullName || user.email || user.id;\n    const dept = user?.raw_user_meta_data?.pending_department || user?.user_metadata?.pending_department || \"-\";\n    const role = user?.raw_user_meta_data?.pending_role || user?.user_metadata?.pending_role || \"-\";\n    const email = user.email || \"No email\";\n    const createdAt = user.created_at ? new Date(user.created_at).toLocaleString() : \"Unknown\";\n\n    return `\n          <div class=\"user-item\" style=\"display: flex; align-items: center; justify-content: space-between; padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem; background: white;\">\n            <div style=\"flex: 1;\">\n              <div style=\"display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;\">\n                <div style=\"width: 48px; height: 48px; border-radius: 50%; background: #3b82f6; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.25rem;\">\n                  ${name.charAt(0).toUpperCase()}\n                </div>\n                <div>\n                  <div style=\"font-weight: 600; color: #111827; font-size: 1.1rem; margin-bottom: 0.25rem;\">\n                    ${escapeHtml(name)}\n                  </div>\n                  <div style=\"font-size: 0.875rem; color: #6b7280;\">\n                    ${escapeHtml(email)}\n                  </div>\n                </div>\n              </div>\n              <div style=\"display: flex; gap: 1.5rem; font-size: 0.875rem; color: #6b7280; flex-wrap: wrap; margin-top: 0.75rem;\">\n                <div><strong>Requested Role:</strong> ${escapeHtml(String(role))}</div>\n                <div><strong>Department:</strong> ${escapeHtml(String(dept))}</div>\n                <div><strong>Registered:</strong> ${createdAt}</div>\n              </div>\n            </div>\n            <div style=\"display: flex; gap: 0.75rem; margin-left: 1rem;\">\n              <button class=\"btn btn-success\" onclick=\"approvePending('${user.id}')\" style=\"white-space: nowrap;\">Approve</button>\n              <button class=\"btn btn-danger\" onclick=\"rejectPending('${user.id}')\" style=\"white-space: nowrap;\">Reject</button>\n            </div>\n          </div>\n        `;\n  }).join(\"\")}\n    </div>\n  `;\n\n  container.innerHTML = html;\n}\n\n/**\n * Approve pending signup\n */\nwindow.approvePending = async function(userId) {\n  if (!confirm(\"Are you sure you want to approve this signup request?\")) {\n    return;\n  }\n\n  try {\n    const response = await fetch(`/api/hr/pending-signups/${userId}/approve`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\"\n      }\n    });\n\n    const result = await response.json();\n\n    if (result.success) {\n      showMessage(\"Signup approved successfully\", \"success\");\n      await loadPendingSignups();\n    } else {\n      showMessage(result.error || \"Failed to approve signup\", \"error\");\n    }\n  } catch (error) {\n    console.error(\"[SUPERADMIN] Approve pending signup error:\", error);\n    showMessage(\"Failed to approve signup\", \"error\");\n  }\n};\n\n/**\n * Reject pending signup\n */\nwindow.rejectPending = async function(userId) {\n  if (!confirm(\"Are you sure you want to reject this signup request?\")) {\n    return;\n  }\n\n  try {\n    const response = await fetch(`/api/hr/pending-signups/${userId}/reject`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\"\n      }\n    });\n\n    const result = await response.json();\n\n    if (result.success) {\n      showMessage(\"Signup rejected successfully\", \"success\");\n      await loadPendingSignups();\n    } else {\n      showMessage(result.error || \"Failed to reject signup\", \"error\");\n    }\n  } catch (error) {\n    console.error(\"[SUPERADMIN] Reject pending signup error:\", error);\n    showMessage(\"Failed to reject signup\", \"error\");\n  }\n};\n\n/**\n * Escape HTML to prevent XSS\n */\nfunction escapeHtml(text) {\n  if (text == null) return \"\";\n  const div = document.createElement(\"div\");\n  div.textContent = text;\n  return div.innerHTML;\n}\n\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\super-admin\\server-logs.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\utils\\boundaryValidator.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":137,"column":48,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":137,"endColumn":49},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":137,"column":60,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":137,"endColumn":61}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Digos City Boundary Validator (Frontend)\r\n * Validates if coordinates are within Digos City boundaries\r\n * Uses the actual polygon boundary from digos-city-boundary.json\r\n */\r\n\r\n// Cache for boundary data\r\nlet boundaryCache = null;\r\nlet boundaryLoadPromise = null;\r\n\r\n/**\r\n * Load Digos city boundary from JSON file\r\n */\r\nasync function loadDigosBoundary() {\r\n  if (boundaryCache) {\r\n    return boundaryCache;\r\n  }\r\n\r\n  if (boundaryLoadPromise) {\r\n    return boundaryLoadPromise;\r\n  }\r\n\r\n  boundaryLoadPromise = (async () => {\r\n    try {\r\n      // Try to fetch from API endpoint first (if it exists)\r\n      let response;\r\n      try {\r\n        response = await fetch(\"/api/digos-boundary\");\r\n        if (response.ok) {\r\n          const boundary = await response.json();\r\n          boundaryCache = boundary;\r\n          return boundary;\r\n        }\r\n        // If 404, silently fall back (don't log - this is expected if server not restarted)\r\n      } catch (err) {\r\n        // Network error - continue to fallback\r\n      }\r\n\r\n      // Fallback: try to use barangay boundaries from /api/boundaries\r\n      // and construct city boundary from them\r\n      try {\r\n        response = await fetch(\"/api/boundaries\");\r\n        if (response.ok) {\r\n          const brgyData = await response.json();\r\n          if (Array.isArray(brgyData) && brgyData.length > 0) {\r\n            // Store barangay data for point-in-polygon checks\r\n            boundaryCache = {\r\n              type: \"barangay_boundaries\",\r\n              barangays: brgyData,\r\n              // Create a simple bounding box from all barangays\r\n              bounds: calculateBoundsFromBarangays(brgyData)\r\n            };\r\n            // Log that we're using barangay boundaries fallback (only once)\r\n            if (!boundaryCache._logged) {\r\n              console.log(\"[BOUNDARY_VALIDATOR] Using barangay boundaries for validation\");\r\n              boundaryCache._logged = true;\r\n            }\r\n            return boundaryCache;\r\n          }\r\n        }\r\n      } catch (err) {\r\n        // Barangay boundaries API failed, continue to final fallback\r\n      }\r\n\r\n      // Final fallback: try direct file path (may not work in production)\r\n      try {\r\n        response = await fetch(\"/src/client/assets/digos-city-boundary.json\");\r\n        if (response.ok) {\r\n          const boundary = await response.json();\r\n          boundaryCache = boundary;\r\n          return boundary;\r\n        }\r\n      } catch (err) {\r\n        // Direct file path also failed\r\n      }\r\n\r\n      // If all methods failed, return null (will use bounding box fallback in validation)\r\n      return null;\r\n    } finally {\r\n      boundaryLoadPromise = null;\r\n    }\r\n  })();\r\n\r\n  return boundaryLoadPromise;\r\n}\r\n\r\n/**\r\n * Calculate bounding box from barangay boundaries\r\n * @param {Array} brgyData - Array of barangay data with geojson\r\n * @returns {Object} {minLng, maxLng, minLat, maxLat}\r\n */\r\nfunction calculateBoundsFromBarangays(brgyData) {\r\n  let minLng = Infinity, maxLng = -Infinity;\r\n  let minLat = Infinity, maxLat = -Infinity;\r\n\r\n  brgyData.forEach(barangay => {\r\n    if (barangay.geojson && barangay.geojson.geometry) {\r\n      const coords = barangay.geojson.geometry.coordinates;\r\n      if (barangay.geojson.geometry.type === \"Polygon\") {\r\n        coords[0].forEach(([lng, lat]) => {\r\n          minLng = Math.min(minLng, lng);\r\n          maxLng = Math.max(maxLng, lng);\r\n          minLat = Math.min(minLat, lat);\r\n          maxLat = Math.max(maxLat, lat);\r\n        });\r\n      } else if (barangay.geojson.geometry.type === \"MultiPolygon\") {\r\n        coords.forEach(polygon => {\r\n          polygon[0].forEach(([lng, lat]) => {\r\n            minLng = Math.min(minLng, lng);\r\n            maxLng = Math.max(maxLng, lng);\r\n            minLat = Math.min(minLat, lat);\r\n            maxLat = Math.max(maxLat, lat);\r\n          });\r\n        });\r\n      }\r\n    }\r\n  });\r\n\r\n  return { minLng, maxLng, minLat, maxLat };\r\n}\r\n\r\n/**\r\n * Check if a point is inside a polygon ring using ray casting algorithm\r\n * @param {Array} point - [longitude, latitude]\r\n * @param {Array} ring - Array of [longitude, latitude] coordinates\r\n * @returns {boolean}\r\n */\r\nfunction isPointInRing(point, ring) {\r\n  const [x, y] = point;\r\n  let inside = false;\r\n\r\n  for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {\r\n    const [xi, yi] = ring[i];\r\n    const [xj, yj] = ring[j];\r\n\r\n    const intersect = ((yi > y) !== (yj > y)) &&\r\n                     (x < (xj - xi) * (y - yi) / (yj - yi) + xi);\r\n    if (intersect) inside = !inside;\r\n  }\r\n\r\n  return inside;\r\n}\r\n\r\n/**\r\n * Check if a point is inside a polygon\r\n * @param {Array} point - [longitude, latitude]\r\n * @param {Array} coordinates - Polygon coordinates array\r\n * @returns {boolean}\r\n */\r\nfunction isPointInPolygon(point, coordinates) {\r\n  if (!coordinates || coordinates.length === 0) {\r\n    return false;\r\n  }\r\n\r\n  // Handle Polygon structure: [outerRing, hole1, hole2, ...]\r\n  const outerRing = coordinates[0];\r\n  if (!outerRing || outerRing.length === 0) {\r\n    return false;\r\n  }\r\n\r\n  let inside = isPointInRing(point, outerRing);\r\n\r\n  // Check holes (inner rings) - if point is in a hole, it's outside\r\n  if (inside && coordinates.length > 1) {\r\n    for (let i = 1; i < coordinates.length; i++) {\r\n      if (isPointInRing(point, coordinates[i])) {\r\n        inside = false;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  return inside;\r\n}\r\n\r\n/**\r\n * Validate if coordinates are within Digos City boundary\r\n * @param {number} latitude - Latitude coordinate\r\n * @param {number} longitude - Longitude coordinate\r\n * @returns {Promise<boolean>} True if coordinates are within city boundaries\r\n */\r\nasync function isWithinDigosBoundary(latitude, longitude) {\r\n  // Validate input\r\n  if (typeof latitude !== \"number\" || typeof longitude !== \"number\") {\r\n    return false;\r\n  }\r\n\r\n  if (latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {\r\n    return false;\r\n  }\r\n\r\n  // Load boundary\r\n  const boundary = await loadDigosBoundary();\r\n  if (!boundary) {\r\n    // Use bounding box fallback if boundary not available\r\n    const minLat = 6.723539;\r\n    const maxLat = 6.985025;\r\n    const minLng = 125.245633;\r\n    const maxLng = 125.391290;\r\n    return (\r\n      latitude >= minLat &&\r\n      latitude <= maxLat &&\r\n      longitude >= minLng &&\r\n      longitude <= maxLng\r\n    );\r\n  }\r\n\r\n  const point = [longitude, latitude]; // GeoJSON uses [lng, lat] order\r\n\r\n  // Handle barangay boundaries format (from /api/boundaries)\r\n  if (boundary.type === \"barangay_boundaries\" && boundary.barangays) {\r\n    // Check if point is within any barangay boundary\r\n    for (const barangay of boundary.barangays) {\r\n      if (barangay.geojson && barangay.geojson.geometry) {\r\n        const coords = barangay.geojson.geometry.coordinates;\r\n        if (barangay.geojson.geometry.type === \"Polygon\") {\r\n          if (isPointInPolygon(point, coords)) {\r\n            return true;\r\n          }\r\n        } else if (barangay.geojson.geometry.type === \"MultiPolygon\") {\r\n          for (const polygon of coords) {\r\n            if (isPointInPolygon(point, polygon)) {\r\n              return true;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    // If not in any barangay, check bounding box as fallback\r\n    if (boundary.bounds) {\r\n      return (\r\n        latitude >= boundary.bounds.minLat &&\r\n        latitude <= boundary.bounds.maxLat &&\r\n        longitude >= boundary.bounds.minLng &&\r\n        longitude <= boundary.bounds.maxLng\r\n      );\r\n    }\r\n    return false;\r\n  }\r\n\r\n  // Handle standard GeoJSON boundary format\r\n  if (boundary.geometry && boundary.geometry.coordinates) {\r\n    const {coordinates} = boundary.geometry;\r\n\r\n    // Handle Polygon geometry type\r\n    if (boundary.geometry.type === \"Polygon\") {\r\n      return isPointInPolygon(point, coordinates);\r\n    }\r\n\r\n    // Handle MultiPolygon geometry type\r\n    if (boundary.geometry.type === \"MultiPolygon\") {\r\n      // MultiPolygon: [[[ring1], [ring2]], [[ring3]]]\r\n      for (const polygon of coordinates) {\r\n        if (isPointInPolygon(point, polygon)) {\r\n          return true;\r\n        }\r\n      }\r\n      return false;\r\n    }\r\n\r\n    console.warn(\"[BOUNDARY_VALIDATOR] Unsupported geometry type:\", boundary.geometry.type);\r\n    return true; // Fail open if geometry type not supported\r\n  }\r\n\r\n  console.warn(\"[BOUNDARY_VALIDATOR] Invalid boundary format\");\r\n  return true; // Fail open if boundary format invalid\r\n}\r\n\r\n/**\r\n * Get Digos city bounding box (for quick pre-check)\r\n * @returns {Promise<Object|null>} {minLng, maxLng, minLat, maxLat} or null\r\n */\r\nasync function getDigosBounds() {\r\n  const boundary = await loadDigosBoundary();\r\n  if (!boundary || !boundary.geometry || !boundary.geometry.coordinates) {\r\n    return null;\r\n  }\r\n\r\n  let minLng = Infinity, maxLng = -Infinity;\r\n  let minLat = Infinity, maxLat = -Infinity;\r\n\r\n  const {coordinates} = boundary.geometry;\r\n\r\n  function processRing(ring) {\r\n    for (const [lng, lat] of ring) {\r\n      minLng = Math.min(minLng, lng);\r\n      maxLng = Math.max(maxLng, lng);\r\n      minLat = Math.min(minLat, lat);\r\n      maxLat = Math.max(maxLat, lat);\r\n    }\r\n  }\r\n\r\n  if (boundary.geometry.type === \"Polygon\") {\r\n    for (const ring of coordinates) {\r\n      processRing(ring);\r\n    }\r\n  } else if (boundary.geometry.type === \"MultiPolygon\") {\r\n    for (const polygon of coordinates) {\r\n      for (const ring of polygon) {\r\n        processRing(ring);\r\n      }\r\n    }\r\n  }\r\n\r\n  return { minLng, maxLng, minLat, maxLat };\r\n}\r\n\r\n/**\r\n * Quick bounding box check (faster than full polygon check)\r\n * Use this for initial filtering before doing full polygon check\r\n * @param {number} latitude - Latitude coordinate\r\n * @param {number} longitude - Longitude coordinate\r\n * @returns {Promise<boolean>}\r\n */\r\nasync function isWithinDigosBounds(latitude, longitude) {\r\n  const bounds = await getDigosBounds();\r\n  if (!bounds) {\r\n    return true; // Fail open\r\n  }\r\n\r\n  return (\r\n    latitude >= bounds.minLat &&\r\n    latitude <= bounds.maxLat &&\r\n    longitude >= bounds.minLng &&\r\n    longitude <= bounds.maxLng\r\n  );\r\n}\r\n\r\nexport {\r\n  isWithinDigosBoundary,\r\n  isWithinDigosBounds,\r\n  getDigosBounds,\r\n  loadDigosBoundary\r\n};\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\utils\\csrf.js","messages":[{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":17,"column":7,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":17,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// CSRF token management utility\nlet csrfToken = null;\n/**\n * Get CSRF token from server\n * @returns {Promise<string>} CSRF token\n */\n\nexport const getCsrfToken = async () => {\n\n  if (csrfToken) {\n    return csrfToken;\n  }\n  try {\n    const response = await fetch(\"/api/auth/csrf-token\");\n    const data = await response.json();\n    if (data.success) {\n      csrfToken = data.csrfToken;\n      return csrfToken;\n    }\n    throw new Error(\"Failed to get CSRF token\");\n  } catch (error) {\n    console.error(\"CSRF token fetch failed:\", error);\n    throw error;\n  }\n};\n/**\n * Get fresh CSRF token from response headers\n * @param {Response} response - Fetch response object\n * @returns {string|null} CSRF token from headers\n */\n\nexport const getCsrfTokenFromHeaders = (response) => {\n  return response.headers.get(\"X-CSRF-Token\");\n};\n/**\n * Add CSRF token to form data\n * @param {FormData} formData - Form data to add token to\n */\n\nexport const addCsrfTokenToForm = async (formData) => {\n  try {\n    const token = await getCsrfToken();\n    formData.append(\"_csrf\", token);\n  } catch (error) {\n    console.error(\"Failed to add CSRF token to form:\", error);\n    throw error;\n  }\n};\n/**\n * Add CSRF token to request headers\n * @param {Object} headers - Headers object to add token to\n */\n\nexport const addCsrfTokenToHeaders = async (headers = {}) => {\n  try {\n    const token = await getCsrfToken();\n    headers[\"X-CSRF-Token\"] = token;\n    return headers;\n  } catch (error) {\n    console.error(\"Failed to add CSRF token to headers:\", error);\n    throw error;\n  }\n};\n/**\n * Clear stored CSRF token (useful after logout)\n */\n\nexport const clearCsrfToken = () => {\n  csrfToken = null;\n};\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\utils\\departmentUtils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\utils\\fileHandler.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\utils\\global-oauth-guard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\utils\\icons.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\utils\\message.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\utils\\navigation.js","messages":[{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":72,"column":42,"nodeType":"CallExpression","messageId":"returnsValue","endLine":72,"endColumn":66,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[2913,2937],"text":"{setTimeout(resolve, 150)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":148,"column":38,"nodeType":"CallExpression","messageId":"returnsValue","endLine":148,"endColumn":62,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[5438,5462],"text":"{setTimeout(resolve, 100)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":186,"column":36,"nodeType":"CallExpression","messageId":"returnsValue","endLine":186,"endColumn":60,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[6639,6663],"text":"{setTimeout(resolve, 500)}"},"desc":"Wrap the expression in `{}`."}]},{"ruleId":"no-promise-executor-return","severity":1,"message":"Return values from promise executor functions cannot be read.","line":229,"column":38,"nodeType":"CallExpression","messageId":"returnsValue","endLine":229,"endColumn":62,"suggestions":[{"messageId":"wrapBraces","fix":{"range":[8253,8277],"text":"{setTimeout(resolve, 500)}"},"desc":"Wrap the expression in `{}`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Navigation utilities for clearing OAuth context on explicit navigation\r\nimport { getOAuthContext, clearOAuthContext } from \"../auth/authChecker.js\";\r\nimport { supabase } from \"../config/config.js\";\r\n\r\n/**\r\n * Clears incomplete OAuth signup context when user explicitly navigates\r\n * This should be called when user clicks login/signup buttons or brand logo\r\n */\r\nexport const clearOAuthOnNavigation = async () => {\r\n  try {\r\n    const ctx = getOAuthContext();\r\n    // Only cleanup if there's a pending OAuth attempt\r\n    // Only delete users for incomplete signups, not logins\r\n    if (ctx && ctx.status === \"pending\") {\r\n      // Get user ID before signing out (only for signups)\r\n      const shouldDeleteUser = ctx.intent === \"signup\";\r\n      const { data: { session } } = await supabase.auth.getSession();\r\n      const userId = session?.user?.id;\r\n\r\n      // Store user ID temporarily in case cleanup is interrupted\r\n      if (shouldDeleteUser && userId) {\r\n        try {\r\n          sessionStorage.setItem(\"cl_pending_deletion_user_id\", userId);\r\n        } catch {}\r\n      }\r\n\r\n      // Delete user from database if it's a signup and user exists\r\n      if (shouldDeleteUser && userId) {\r\n        let deletionSuccessful = false;\r\n\r\n        // Try deletion with access token if available\r\n        if (session?.access_token) {\r\n          try {\r\n            const token = session.access_token;\r\n            const headers = { \"Content-Type\": \"application/json\" };\r\n            headers[\"Authorization\"] = `Bearer ${token}`;\r\n\r\n            const deleteResponse = await fetch(\"/api/compliance/delete\", {\r\n              method: \"DELETE\",\r\n              headers,\r\n              credentials: \"include\",\r\n              body: JSON.stringify({\r\n                userId,\r\n                confirm: true,\r\n                reason: \"Incomplete OAuth signup cancelled - user navigated away\"\r\n              })\r\n            });\r\n\r\n            if (deleteResponse.ok) {\r\n              deletionSuccessful = true;\r\n            } else {\r\n              const errorData = await deleteResponse.json().catch(() => ({}));\r\n              const {status} = deleteResponse;\r\n              // Don't log auth errors - they're expected for incomplete signups\r\n              if (status !== 401 && status !== 403) {\r\n                console.warn(\"[NAV] Failed to delete incomplete OAuth user:\", {\r\n                  status,\r\n                  error: errorData.error || \"Unknown error\",\r\n                  userId\r\n                });\r\n              }\r\n            }\r\n          } catch (deleteError) {\r\n            console.warn(\"[NAV] Error during user deletion:\", deleteError.message);\r\n          }\r\n        }\r\n\r\n        // Retry deletion after a short delay if first attempt failed\r\n        // This handles race conditions where session might be cleared\r\n        if (!deletionSuccessful) {\r\n          try {\r\n            await new Promise(resolve => setTimeout(resolve, 150));\r\n\r\n            // Check if we still have a session for retry\r\n            const { data: { session: retrySession } } = await supabase.auth.getSession();\r\n            if (retrySession?.access_token) {\r\n              const token = retrySession.access_token;\r\n              const headers = { \"Content-Type\": \"application/json\" };\r\n              headers[\"Authorization\"] = `Bearer ${token}`;\r\n\r\n              const retryResponse = await fetch(\"/api/compliance/delete\", {\r\n                method: \"DELETE\",\r\n                headers,\r\n                credentials: \"include\",\r\n                body: JSON.stringify({\r\n                  userId,\r\n                  confirm: true,\r\n                  reason: \"Incomplete OAuth signup cancelled - retry deletion\"\r\n                })\r\n              });\r\n\r\n              if (retryResponse.ok) {\r\n                deletionSuccessful = true;\r\n              }\r\n            }\r\n          } catch (retryError) {\r\n            // Silently fail - we'll proceed with cleanup anyway\r\n          }\r\n        }\r\n\r\n        // Clear stored user ID on successful deletion\r\n        if (deletionSuccessful) {\r\n          try {\r\n            sessionStorage.removeItem(\"cl_pending_deletion_user_id\");\r\n          } catch {}\r\n        }\r\n      }\r\n\r\n      // Clear OAuth context first\r\n      clearOAuthContext();\r\n\r\n      // Aggressively clear session - multiple attempts\r\n      try {\r\n        await supabase.auth.signOut();\r\n      } catch {}\r\n\r\n      try {\r\n        await fetch(\"/auth/session\", { method: \"DELETE\", credentials: \"include\" });\r\n      } catch {}\r\n\r\n      // Force clear all Supabase storage\r\n      try {\r\n        const keys = Object.keys(localStorage);\r\n        keys.forEach(key => {\r\n          if (key.startsWith(\"sb-\") || key.includes(\"supabase\")) {\r\n            localStorage.removeItem(key);\r\n          }\r\n        });\r\n      } catch {}\r\n\r\n      // Verify and force clear again if needed\r\n      const { data: { session: verifySession } } = await supabase.auth.getSession();\r\n      if (verifySession) {\r\n        // Force another sign out\r\n        try {\r\n          await supabase.auth.signOut();\r\n        } catch {}\r\n        // Clear storage again\r\n        try {\r\n          const keys = Object.keys(localStorage);\r\n          keys.forEach(key => {\r\n            if (key.startsWith(\"sb-\") || key.includes(\"supabase\")) {\r\n              localStorage.removeItem(key);\r\n            }\r\n          });\r\n        } catch {}\r\n        // Wait a bit more\r\n        await new Promise(resolve => setTimeout(resolve, 100));\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.warn(\"[NAV] Error clearing OAuth context:\", error);\r\n  }\r\n};\r\n\r\n/**\r\n * Sets up click handlers for navigation elements (login/signup buttons, brand logo)\r\n * to clear OAuth context when clicked\r\n */\r\nexport const setupNavigationCleanup = () => {\r\n  const handleNavigationClick = async (e) => {\r\n    const target = e.currentTarget;\r\n    const href = target.getAttribute(\"href\");\r\n\r\n    // Only handle login/signup links\r\n    if (!href || (!href.includes(\"/login\") && !href.includes(\"/signup\"))) {\r\n      return;\r\n    }\r\n\r\n    // Check if we need to cleanup OAuth (both login and signup)\r\n    const ctx = getOAuthContext();\r\n    if (ctx && ctx.status === \"pending\") {\r\n      // Prevent default navigation\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n\r\n      // Set flag to prevent redirects on destination page\r\n      try {\r\n        sessionStorage.setItem(\"cl_oauth_cleanup\", \"true\");\r\n      } catch {}\r\n\r\n      // Clear OAuth context, delete user, and sign out\r\n      await clearOAuthOnNavigation();\r\n\r\n      // Wait a bit to ensure user deletion and session clearing completes\r\n      await new Promise(resolve => setTimeout(resolve, 500));\r\n\r\n      // Final check - clear session one more time before navigation\r\n      try {\r\n        await supabase.auth.signOut();\r\n        await fetch(\"/auth/session\", { method: \"DELETE\", credentials: \"include\" });\r\n      } catch {}\r\n\r\n      // Navigate manually with a cache-busting parameter to force fresh load\r\n      if (href) {\r\n        const separator = href.includes(\"?\") ? \"&\" : \"?\";\r\n        window.location.href = `${href}${separator}_t=${Date.now()}`;\r\n      }\r\n    }\r\n    // If no OAuth cleanup needed, let default navigation proceed\r\n  };\r\n\r\n  // Setup click handlers for login/signup buttons by ID\r\n  const loginBtn = document.getElementById(\"login-btn\");\r\n  const signupBtn = document.getElementById(\"signup-btn\");\r\n\r\n  if (loginBtn) {\r\n    loginBtn.addEventListener(\"click\", handleNavigationClick);\r\n  }\r\n  if (signupBtn) {\r\n    signupBtn.addEventListener(\"click\", handleNavigationClick);\r\n  }\r\n\r\n  // Setup click handlers for auth links in footer (class=\"auth-link\")\r\n  const authLinks = document.querySelectorAll('a.auth-link[href*=\"/login\"], a.auth-link[href*=\"/signup\"]');\r\n  authLinks.forEach(link => {\r\n    link.addEventListener(\"click\", handleNavigationClick);\r\n  });\r\n\r\n  // Setup click handler for brand logo\r\n  const brandLogo = document.querySelector(\".brand-logo\");\r\n  if (brandLogo) {\r\n    brandLogo.addEventListener(\"click\", async (e) => {\r\n      const ctx = getOAuthContext();\r\n      if (ctx && ctx.status === \"pending\") {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        await clearOAuthOnNavigation();\r\n        await new Promise(resolve => setTimeout(resolve, 500));\r\n        // Final check - clear session one more time before navigation\r\n        try {\r\n          await supabase.auth.signOut();\r\n          await fetch(\"/auth/session\", { method: \"DELETE\", credentials: \"include\" });\r\n        } catch {}\r\n        window.location.href = `/?_t=${Date.now()}`;\r\n      }\r\n    });\r\n  }\r\n\r\n  // Setup click handlers for any other login/signup links (like \"Get Started\" buttons)\r\n  const allLoginSignupLinks = document.querySelectorAll('a[href*=\"/login\"], a[href*=\"/signup\"]');\r\n  allLoginSignupLinks.forEach(link => {\r\n    // Skip if already handled above\r\n    if (link.id === \"login-btn\" || link.id === \"signup-btn\" || link.classList.contains(\"auth-link\")) {\r\n      return;\r\n    }\r\n    link.addEventListener(\"click\", handleNavigationClick);\r\n  });\r\n};\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\utils\\oauth-cleanup.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'supabase' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'clearOAuthContext' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Aggressive OAuth cleanup utility\r\nimport { supabase } from \"../config/config.js\";\r\nimport { getOAuthContext, clearOAuthContext } from \"../auth/authChecker.js\";\r\n\r\n/**\r\n * Clears OAuth session and context (without deleting users)\r\n * This should be called to clear stale sessions, but NOT to delete users\r\n * User deletion should only happen on explicit navigation clicks\r\n */\r\n// aggressiveOAuthCleanup removed - replaced by GlobalOAuthGuard\r\n// This file now only contains helper utilities\r\n\r\n/**\r\n * Checks if we should skip authentication checks due to pending OAuth cleanup\r\n */\r\nexport const shouldSkipAuthCheck = () => {\r\n  try {\r\n    const ctx = getOAuthContext();\r\n    return ctx && ctx.status === \"pending\";\r\n  } catch {\r\n    return false;\r\n  }\r\n};\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\utils\\privacyContent.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\utils\\roleUtils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\client\\utils\\validation.js","messages":[{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\\".","line":10,"column":35,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":10,"endColumn":36,"suggestions":[{"messageId":"removeEscape","fix":{"range":[346,347],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[346,346],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\[.","line":72,"column":25,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":72,"endColumn":26,"suggestions":[{"messageId":"removeEscape","fix":{"range":[2222,2223],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[2222,2222],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\/.","line":72,"column":42,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":72,"endColumn":43,"suggestions":[{"messageId":"removeEscape","fix":{"range":[2239,2240],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[2239,2239],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Input validation and sanitization utilities\r\n/**\r\n * Sanitize string input by removing potentially dangerous characters\r\n * @param {string} input - Input string to sanitize\r\n * @returns {string} Sanitized string\r\n */\r\n\r\nexport const sanitizeString = (input) => {\r\n  if (typeof input !== \"string\") return \"\";\r\n  return input.trim().replace(/[<>\\\"'&]/g, (match) => {\r\n    const entityMap = {\r\n      \"<\": \"&lt;\",\r\n      \">\": \"&gt;\",\r\n      '\"': \"&quot;\",\r\n      \"'\": \"&#x27;\",\r\n      \"&\": \"&amp;\",\r\n    };\r\n    return entityMap[match];\r\n  });\r\n};\r\n/**\r\n * Validate email format\r\n * @param {string} email - Email to validate\r\n * @returns {boolean} True if valid email format\r\n */\r\n\r\nexport const isValidEmail = (email) => {\r\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n  return emailRegex.test(email);\r\n};\r\n/**\r\n * Validate mobile number (Philippine format)\r\n * @param {string} mobile - Mobile number to validate\r\n * @returns {boolean} True if valid Philippine mobile number\r\n */\r\n\r\nexport const isValidPhilippineMobile = (mobile) => {\r\n  // Remove +63 prefix if present\r\n  const cleanMobile = mobile.replace(/^\\+63/, \"\");\r\n  // Should be 10 digits starting with 9\r\n  const mobileRegex = /^9\\d{9}$/;\r\n  return mobileRegex.test(cleanMobile);\r\n};\r\n/**\r\n * Validate password strength\r\n * @param {string} password - Password to validate\r\n * @returns {Object} Validation result with isValid and errors\r\n */\r\n\r\nexport const validatePassword = (password) => {\r\n  const errors = [];\r\n  const minLength = 8;\r\n  const maxLength = 128;\r\n  if (typeof password !== \"string\") {\r\n    return { isValid: false, errors: [\"Password is required\"] };\r\n  }\r\n  if (password.length < minLength) {\r\n    errors.push(`Password must be at least ${minLength} characters long`);\r\n  }\r\n  if (password.length > maxLength) {\r\n    errors.push(`Password must not exceed ${maxLength} characters`);\r\n  }\r\n  if (!/[A-Z]/.test(password)) {\r\n    errors.push(\"Password must contain at least one uppercase letter\");\r\n  }\r\n  if (!/[a-z]/.test(password)) {\r\n    errors.push(\"Password must contain at least one lowercase letter\");\r\n  }\r\n  if (!/\\d/.test(password)) {\r\n    errors.push(\"Password must contain at least one number\");\r\n  }\r\n  if (!/[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(password)) {\r\n    errors.push(\"Password must contain at least one special character\");\r\n  }\r\n  return { isValid: errors.length === 0, errors };\r\n};\r\n/**\r\n * Validate and sanitize form data\r\n * @param {Object} formData - Form data object\r\n * @param {Object} rules - Validation rules for each field\r\n * @returns {Object} Validation result with sanitized data and errors\r\n */\r\n\r\nexport const validateAndSanitizeForm = (formData, rules) => {\r\n  const sanitizedData = {};\r\n  const errors = [];\r\n  for (const [field, value] of Object.entries(formData)) {\r\n    const rule = rules[field];\r\n    if (!rule) {\r\n      // No validation rule, just sanitize\r\n      sanitizedData[field] = sanitizeString(value);\r\n      continue;\r\n    }\r\n    // Check required fields\r\n    if (\r\n      rule.required &&\r\n      (!value ||\r\n        (typeof value === \"string\" && value.trim() === \"\") ||\r\n        value === null ||\r\n        value === void 0)\r\n    ) {\r\n      errors.push(`${field} is required`);\r\n      continue;\r\n    }\r\n    // Skip validation if field is empty and not required\r\n    if (\r\n      !value ||\r\n      (typeof value === \"string\" && value.trim() === \"\") ||\r\n      value === null ||\r\n      value === void 0\r\n    ) {\r\n      sanitizedData[field] = \"\";\r\n      continue;\r\n    }\r\n    // Apply sanitization\r\n    const sanitizedValue = sanitizeString(value);\r\n    // Apply specific validations\r\n    if (rule.type === \"email\" && !isValidEmail(sanitizedValue)) {\r\n      errors.push(`Invalid email format for ${field}`);\r\n    }\r\n    if (rule.type === \"mobile\" && !isValidPhilippineMobile(sanitizedValue)) {\r\n      errors.push(`Invalid Philippine mobile number for ${field}`);\r\n    }\r\n    if (rule.type === \"password\") {\r\n      const passwordValidation = validatePassword(sanitizedValue);\r\n      if (!passwordValidation.isValid) {\r\n        errors.push(\r\n          ...passwordValidation.errors.map((error) => `${field}: ${error}`)\r\n        );\r\n      }\r\n    }\r\n    if (rule.maxLength && sanitizedValue.length > rule.maxLength) {\r\n      errors.push(`${field} must not exceed ${rule.maxLength} characters`);\r\n    }\r\n    if (rule.minLength && sanitizedValue.length < rule.minLength) {\r\n      errors.push(\r\n        `${field} must be at least ${rule.minLength} characters long`\r\n      );\r\n    }\r\n    sanitizedData[field] = sanitizedValue;\r\n  }\r\n  return {\r\n    isValid: errors.length === 0,\r\n    sanitizedData,\r\n    errors,\r\n  };\r\n};\r\n/**\r\n * Validate file upload\r\n * @param {FileList|File[]} files - Files to validate\r\n * @param {Object} options - Validation options\r\n * @returns {Object} Validation result\r\n */\r\n\r\nexport const validateFileUpload = (files, options = {}) => {\r\n  const {\r\n    maxSize = 10 * 1024 * 1024, // 10MB default\r\n    maxFiles = 5,\r\n    allowedTypes = [\r\n      \"image/jpeg\",\r\n      \"image/png\",\r\n      \"image/webp\",\r\n      \"application/pdf\",\r\n      \"video/mp4\",\r\n    ],\r\n  } = options;\r\n  const errors = [];\r\n  if (files.length > maxFiles) {\r\n    errors.push(`Maximum ${maxFiles} files allowed`);\r\n  }\r\n  for (let i = 0; i < files.length; i++) {\r\n    const file = files[i];\r\n    if (file.size > maxSize) {\r\n      errors.push(\r\n        `File ${file.name} exceeds maximum size of ${Math.round(\r\n          maxSize / 1024 / 1024\r\n        )}MB`\r\n      );\r\n    }\r\n    if (!allowedTypes.includes(file.type)) {\r\n      errors.push(\r\n        `File ${\r\n          file.name\r\n        } has unsupported type. Allowed types: ${allowedTypes.join(\", \")}`\r\n      );\r\n    }\r\n  }\r\n  return {\r\n    isValid: errors.length === 0,\r\n    errors,\r\n  };\r\n};\r\n/**\r\n * Validate a batch of new files against constraints and existing selection\r\n * Returns filtered valid files and a list of human-readable errors\r\n * @param {FileList|File[]} newFiles\r\n * @param {File[]} existingFiles\r\n * @param {Object} options\r\n * @param {number} options.maxFiles\r\n * @param {number} options.maxSize\r\n * @param {string[]} options.allowedTypes\r\n * @returns {{ validFiles: File[], errors: string[] }}\r\n */\r\n\r\nexport const validateFiles = (newFiles, existingFiles = [], options = {}) => {\r\n  const maxSize = options.maxSize ?? 10 * 1024 * 1024;\r\n  const maxFiles = options.maxFiles ?? 5;\r\n  const allowedTypes = options.allowedTypes ?? [\r\n    \"image/jpeg\",\r\n    \"image/png\",\r\n    \"image/webp\",\r\n    \"application/pdf\",\r\n    \"video/mp4\",\r\n  ];\r\n  const errors = [];\r\n  const validFiles = [];\r\n  if (!newFiles || newFiles.length === 0) {\r\n    return { validFiles, errors };\r\n  }\r\n  // Build a set to detect duplicates (by name+size+type)\r\n  const existingKey = (f) => `${f.name}:${f.size}:${f.type}`;\r\n  const existingSet = new Set((existingFiles || []).map(existingKey));\r\n  for (let i = 0; i < newFiles.length; i++) {\r\n    const file = newFiles[i];\r\n    // Enforce overall max files\r\n    if (existingFiles.length + validFiles.length >= maxFiles) {\r\n      errors.push(`Maximum ${maxFiles} files allowed`);\r\n      break;\r\n    }\r\n    // Type check\r\n    if (!allowedTypes.includes(file.type)) {\r\n      errors.push(`File ${file.name} has unsupported type`);\r\n      continue;\r\n    }\r\n    // Size check\r\n    if (file.size > maxSize) {\r\n      const mb = Math.round(maxSize / 1024 / 1024);\r\n      errors.push(`File ${file.name} exceeds maximum size of ${mb}MB`);\r\n      continue;\r\n    }\r\n    // Duplicate check\r\n    const key = existingKey(file);\r\n    if (\r\n      existingSet.has(key) ||\r\n      validFiles.some((f) => existingKey(f) === key)\r\n    ) {\r\n      errors.push(`File ${file.name} is already selected`);\r\n      continue;\r\n    }\r\n    validFiles.push(file);\r\n  }\r\n  return { validFiles, errors };\r\n};\r\n/**\r\n * Attach realtime validation to a form (HTML5 validity + custom rules)\r\n * @param {HTMLFormElement} form\r\n */\r\n\r\nexport const setupRealtimeValidation = (form) => {\r\n  if (!form) return;\r\n  const setError = (input, message) => {\r\n    if (!input) return;\r\n    input.setCustomValidity(message || \"\");\r\n    // Do not spam reportValidity on each keystroke; only clear silently\r\n    if (!message) return;\r\n    try {\r\n      input.reportValidity();\r\n    } catch {}\r\n  };\r\n  const rules = {\r\n    \"#complaintTitle\": { required: true, minLength: 3 },\r\n    \"#description\": { required: true, minLength: 10 },\r\n    \"#location\": { required: true },\r\n    \"#complaintCategory\": { required: true },\r\n    \"#complaintSubcategory\": { required: true },\r\n    \"#urgencyLevel\": { required: true },\r\n  };\r\n  const validateTarget = (selector) => {\r\n    const input = form.querySelector(selector);\r\n    if (!input) return;\r\n    const value = (input.value || \"\").trim();\r\n    const rule = rules[selector] || {};\r\n    if (rule.required && !value) {\r\n      return setError(input, \"This field is required\");\r\n    }\r\n    if (rule.minLength && value.length < rule.minLength) {\r\n      return setError(input, `Must be at least ${rule.minLength} characters`);\r\n    }\r\n    setError(input, \"\");\r\n  };\r\n  // Wire inputs\r\n  Object.keys(rules).forEach((selector) => {\r\n    const input = form.querySelector(selector);\r\n    if (!input) return;\r\n    const formGroup = input.closest(\".form-group\");\r\n    [\"input\", \"change\", \"blur\"].forEach((evt) => {\r\n      input.addEventListener(evt, () => {\r\n        // Add touched class when user interacts with the field\r\n        if (formGroup) formGroup.classList.add(\"touched\");\r\n        validateTarget(selector);\r\n      });\r\n    });\r\n  });\r\n  // Initial pass - removed to prevent immediate validation errors\r\n  // Object.keys(rules).forEach(validateTarget);\r\n};\r\n/**\r\n * Extract complaint form data from DOM\r\n * @param {HTMLFormElement} formElement\r\n * @returns {Object}\r\n */\r\n\r\nexport const extractComplaintFormData = (formElement) => {\r\n  if (!formElement) return {};\r\n  const getVal = (selector) => {\r\n    const el = formElement.querySelector(selector);\r\n    return el ? el.value.trim() : \"\";\r\n  };\r\n  const parseNum = (selector) => {\r\n    const v = getVal(selector);\r\n    if (v === \"\") return null;\r\n    const n = Number(v);\r\n    return Number.isFinite(n) ? n : null;\r\n  };\r\n  // Collect selected departments (checkboxes inside #departmentCheckboxes)\r\n  const departments = Array.from(\r\n    formElement.querySelectorAll(\r\n      '#departmentCheckboxes input[type=\"checkbox\"]:checked'\r\n    )\r\n  ).map((cb) => cb.value);\r\n  return {\r\n    title: getVal(\"#complaintTitle\"),\r\n    // type field removed - not in current schema\r\n    // subtype field removed - not in current schema\r\n    category: getVal(\"#complaintCategory\"),\r\n    subcategory: getVal(\"#complaintSubcategory\"),\r\n    description: getVal(\"#description\"),\r\n    location_text: getVal(\"#location\"),\r\n    latitude: parseNum(\"#latitude\"),\r\n    longitude: parseNum(\"#longitude\"),\r\n    urgency_level: getVal(\"#urgencyLevel\"),\r\n    departments,\r\n  };\r\n};\r\n\r\n/**\r\n * Check if coordinates are within Digos City boundaries\r\n * Uses the actual Digos city boundary polygon from digos-city-boundary.json\r\n * @param {number} latitude - Latitude coordinate\r\n * @param {number} longitude - Longitude coordinate\r\n * @returns {Promise<boolean>} True if coordinates are within city boundaries\r\n */\r\nexport const isWithinCityBoundary = async (latitude, longitude) => {\r\n  try {\r\n    const { isWithinDigosBoundary } = await import(\"./boundaryValidator.js\");\r\n    return await isWithinDigosBoundary(latitude, longitude);\r\n  } catch (error) {\r\n    console.warn(\"[VALIDATION] Boundary check failed:\", error);\r\n    // Fallback: Simple bounding box check for Digos City\r\n    // Based on actual bounds from boundary file\r\n    const minLat = 6.723539;\r\n    const maxLat = 6.985025;\r\n    const minLng = 125.245633;\r\n    const maxLng = 125.39129;\r\n    return (\r\n      latitude >= minLat &&\r\n      latitude <= maxLat &&\r\n      longitude >= minLng &&\r\n      longitude <= maxLng\r\n    );\r\n  }\r\n};\r\n/**\r\n * Validate complaint form data\r\n * @param {Object} data\r\n * @returns {{ valid: boolean, errors: string[] }}\r\n */\r\n\r\nexport const validateComplaintForm = (data) => {\r\n  const errors = [];\r\n  if (!data) {\r\n    return { valid: false, errors: [\"Invalid form data\"] };\r\n  }\r\n  const title = sanitizeString(data.title || \"\");\r\n  const description = sanitizeString(data.description || \"\");\r\n  const locationText = sanitizeString(data.location_text || \"\");\r\n  const category = sanitizeString(data.category || \"\");\r\n  const subcategory = sanitizeString(data.subcategory || \"\");\r\n  if (!title || title.trim().length === 0) errors.push(\"Title is required\");\r\n  if (title && title.length < 3)\r\n    errors.push(\"Title must be at least 3 characters\");\r\n  if (!description || description.trim().length === 0)\r\n    errors.push(\"Description is required\");\r\n  if (description && description.length < 10)\r\n    errors.push(\"Description must be at least 10 characters\");\r\n  if (!locationText) errors.push(\"Location is required\");\r\n  // Validate hierarchical form fields\r\n  if (!category) errors.push(\"Category is required\");\r\n  if (!subcategory) errors.push(\"Subcategory is required\");\r\n  if (!data.urgency_level) errors.push(\"Urgency level is required\");\r\n  // Validate departments\r\n  if (!data.departments || data.departments.length === 0) {\r\n    errors.push(\"At least one department must be selected\");\r\n  }\r\n  // If one coordinate is provided, both should be valid numbers\r\n  const hasLat = data.latitude !== null && data.latitude !== void 0;\r\n  const hasLng = data.longitude !== null && data.longitude !== void 0;\r\n  if ((hasLat && !hasLng) || (!hasLat && hasLng)) {\r\n    errors.push(\"Both latitude and longitude must be provided\");\r\n  }\r\n  if (hasLat && hasLng) {\r\n    if (\r\n      typeof data.latitude !== \"number\" ||\r\n      typeof data.longitude !== \"number\"\r\n    ) {\r\n      errors.push(\"Coordinates must be numeric\");\r\n    }\r\n    // Note: Boundary check is async, so it should be done separately before form submission\r\n    // This validation function is synchronous, so boundary check happens in the form handler\r\n  }\r\n  return { valid: errors.length === 0, errors };\r\n};\r\n\r\n/**\r\n * Validate complaint coordinates against Digos boundary (async)\r\n * @param {number} latitude - Latitude coordinate\r\n * @param {number} longitude - Longitude coordinate\r\n * @returns {Promise<{valid: boolean, error?: string}>}\r\n */\r\nexport const validateComplaintCoordinates = async (latitude, longitude) => {\r\n  if (typeof latitude !== \"number\" || typeof longitude !== \"number\") {\r\n    return { valid: false, error: \"Coordinates must be numeric\" };\r\n  }\r\n\r\n  if (latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {\r\n    return { valid: false, error: \"Invalid coordinate values\" };\r\n  }\r\n\r\n  const withinBoundary = await isWithinCityBoundary(latitude, longitude);\r\n  if (!withinBoundary) {\r\n    return {\r\n      valid: false,\r\n      error: \"Complaint location must be within Digos City boundaries\",\r\n    };\r\n  }\r\n\r\n  return { valid: true };\r\n};\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\app.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\config\\database.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\config\\middleware.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\AuthController.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\ComplaintController.js","messages":[{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":289,"column":25,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":289,"endColumn":80},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":290,"column":27,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":294,"endColumn":13},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":295,"column":27,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":299,"endColumn":13},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":346,"column":64,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":346,"endColumn":73},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":348,"column":66,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":348,"endColumn":75},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":349,"column":60,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":349,"endColumn":69},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":350,"column":45,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":350,"endColumn":54},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":351,"column":66,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":351,"endColumn":75},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":352,"column":31,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":352,"endColumn":40},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":353,"column":27,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":353,"endColumn":36},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":423,"column":40,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":423,"endColumn":49}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const ComplaintService = require(\"../services/ComplaintService\");\r\nconst { getWorkflowFromStatus } = require(\"../utils/complaintUtils\");\r\n\r\nclass ComplaintController {\r\n  constructor() {\r\n    this.complaintService = new ComplaintService();\r\n  }\r\n\r\n  async createComplaint(req, res) {\r\n    const { user } = req;\r\n    const complaintData = req.body;\r\n    const token = req.headers.authorization; // Get token from headers\r\n\r\n    // Handle multer .fields() response (files is an object, not array)\r\n    let files = [];\r\n    if (req.files && req.files.evidenceFiles) {\r\n      files = req.files.evidenceFiles;\r\n    }\r\n\r\n    const complaint = await this.complaintService.createComplaint(\r\n      user.id,\r\n      complaintData,\r\n      files,\r\n      token\r\n    );\r\n\r\n    const response = {\r\n      success: true,\r\n      data: complaint,\r\n      message: \"Complaint submitted successfully\",\r\n    };\r\n\r\n    if (\r\n      (complaint.department_r && complaint.department_r.length > 0) ||\r\n      complaint.assigned_coordinator_id\r\n    ) {\r\n      response.workflow = {\r\n        auto_assigned: Boolean(\r\n          complaint.department_r && complaint.department_r.length > 0\r\n        ),\r\n        coordinator_assigned: Boolean(complaint.assigned_coordinator_id),\r\n        workflow_status: complaint.workflow_status,\r\n      };\r\n    }\r\n\r\n    res.status(201).json(response);\r\n  }\r\n\r\n  /**\r\n   * Cancel complaint\r\n   */\r\n  async cancelComplaint(req, res) {\r\n    const { complaintId } = req.params;\r\n    const { reason } = req.body;\r\n    const userId = req.user.id;\r\n\r\n    const result = await this.complaintService.cancelComplaint(\r\n      complaintId,\r\n      userId,\r\n      reason\r\n    );\r\n    res.json({\r\n      success: true,\r\n      message: \"Complaint cancelled successfully\",\r\n      data: result,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Send reminder for complaint\r\n   */\r\n  async sendReminder(req, res) {\r\n    const { complaintId } = req.params;\r\n    const userId = req.user.id;\r\n    const result = await this.complaintService.sendReminder(\r\n      complaintId,\r\n      userId\r\n    );\r\n    res.json({\r\n      success: true,\r\n      message: \"Reminder sent successfully\",\r\n      data: result,\r\n    });\r\n  }\r\n\r\n  async getMyComplaints(req, res) {\r\n    const { user } = req;\r\n    const token = req.headers.authorization;\r\n    const options = {\r\n      page: req.query.page || 1,\r\n      limit: req.query.limit || 10,\r\n      status: req.query.status,\r\n      type: req.query.type,\r\n      token,\r\n    };\r\n\r\n    const result = await this.complaintService.getUserComplaints(\r\n      user.id,\r\n      options\r\n    );\r\n    res.json({\r\n      success: true,\r\n      data: result.complaints,\r\n      pagination: {\r\n        page: result.page,\r\n        limit: result.limit,\r\n        total: result.total,\r\n        totalPages: result.totalPages,\r\n      },\r\n    });\r\n  }\r\n\r\n  async getMyStatistics(req, res) {\r\n    const { user } = req;\r\n    const result = await this.complaintService.getUserStatistics(user.id);\r\n    res.json({\r\n      success: true,\r\n      data: result,\r\n    });\r\n  }\r\n\r\n  async getComplaintById(req, res) {\r\n    const { user } = req;\r\n    const { id } = req.params;\r\n    const userRole = user.role || \"citizen\";\r\n\r\n    console.log(\r\n      `[COMPLAINT_CONTROLLER] Fetching complaint ${id} for user ${user.id} (role: ${userRole})`\r\n    );\r\n\r\n    const token = req.headers.authorization;\r\n    let complaint;\r\n    if (userRole === \"citizen\") {\r\n      complaint = await this.complaintService.getComplaintById(\r\n        id,\r\n        user.id,\r\n        token\r\n      );\r\n    } else {\r\n      complaint = await this.complaintService.getComplaintById(id, null, token);\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      data: complaint,\r\n    });\r\n  }\r\n\r\n  async getAllComplaints(req, res) {\r\n    const options = {\r\n      page: req.query.page || 1,\r\n      limit: req.query.limit || 20,\r\n      status: req.query.status,\r\n      type: req.query.type,\r\n      department: req.query.department,\r\n      search: req.query.search,\r\n    };\r\n\r\n    const result = await this.complaintService.getAllComplaints(options);\r\n    res.json({\r\n      success: true,\r\n      data: result.complaints,\r\n      pagination: {\r\n        page: result.page,\r\n        limit: result.limit,\r\n        total: result.total,\r\n        totalPages: result.totalPages,\r\n      },\r\n    });\r\n  }\r\n\r\n  async updateComplaintStatus(req, res) {\r\n    const { id } = req.params;\r\n    const { status, priority, category, subcategory, notes } = req.body;\r\n    const { user } = req;\r\n\r\n    const complaint = await this.complaintService.updateComplaintStatus(\r\n      id,\r\n      { status, priority, category, subcategory, notes },\r\n      user.id\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      data: complaint,\r\n      message: \"Complaint status updated successfully\",\r\n    });\r\n  }\r\n\r\n  async transitionStatus(req, res) {\r\n    const complaintId = req.params.id;\r\n    const { status, resolution_notes, admin_notes, feedback } = req.body || {};\r\n    const userId = req.user?.id;\r\n    const userRole = req.user?.role || \"citizen\";\r\n\r\n    // Optional evidence from officer during submit-for-approval\r\n    const files =\r\n      req.files && req.files.evidenceFiles ? req.files.evidenceFiles : [];\r\n\r\n    // Citizens can only confirm resolution (one-way)\r\n    if (userRole === \"citizen\" && status !== \"resolved\") {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"Citizens can only confirm resolution\",\r\n      });\r\n    }\r\n\r\n    if (files && files.length > 0) {\r\n      await this.complaintService.addEvidence(complaintId, files);\r\n    }\r\n\r\n    const updated = await this.complaintService.updateComplaintStatus(\r\n      complaintId,\r\n      status,\r\n      userRole === \"citizen\"\r\n        ? null\r\n        : resolution_notes || admin_notes || feedback || null,\r\n      userId\r\n    );\r\n\r\n    return res.json({ success: true, data: updated });\r\n  }\r\n\r\n  async assignCoordinator(req, res) {\r\n    const { id } = req.params;\r\n    const { coordinator_id } = req.body;\r\n    const { user } = req;\r\n\r\n    const complaint = await this.complaintService.assignCoordinator(\r\n      id,\r\n      coordinator_id,\r\n      user.id\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      data: complaint,\r\n      message: \"Coordinator assigned successfully\",\r\n    });\r\n  }\r\n\r\n  async transferComplaint(req, res) {\r\n    const { id } = req.params;\r\n    const { from_department, to_department, reason } = req.body;\r\n    const { user } = req;\r\n\r\n    const complaint = await this.complaintService.transferComplaint(\r\n      id,\r\n      from_department,\r\n      to_department,\r\n      reason,\r\n      user.id\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      data: complaint,\r\n      message: \"Complaint transferred successfully\",\r\n    });\r\n  }\r\n\r\n  async getComplaintStats(req, res) {\r\n    const filters = {\r\n      department: req.query.department,\r\n      dateFrom: req.query.date_from,\r\n      dateTo: req.query.date_to,\r\n    };\r\n\r\n    const stats = await this.complaintService.getComplaintStats(filters);\r\n    res.json({\r\n      success: true,\r\n      data: stats,\r\n    });\r\n  }\r\n\r\n  async getComplaintLocations(req, res) {\r\n    const {\r\n      status,\r\n      _type,\r\n      department,\r\n      category,\r\n      startDate,\r\n      endDate,\r\n      includeResolved = \"true\",\r\n    } = req.query;\r\n\r\n    // Map query params to service filters\r\n    // Handle arrays for multiple selections (Express parses multiple query params as arrays)\r\n    const statusArray = Array.isArray(status) ? status : status ? [status] : [];\r\n    const categoryArray = Array.isArray(category)\r\n      ? category\r\n      : category\r\n        ? [category]\r\n        : [];\r\n    let departmentArray = Array.isArray(department)\r\n      ? department\r\n      : department\r\n        ? [department]\r\n        : [];\r\n\r\n    // ROLE-BASED FILTERING: Enforce department restrictions\r\n    const userRole = req.user?.role || \"citizen\";\r\n    const userDepartment = req.user?.department;\r\n\r\n    // LGU Admins and Officers can ONLY see their own department's data\r\n    if ([\"lgu-admin\", \"lgu-officer\"].includes(userRole) && userDepartment) {\r\n      departmentArray = [userDepartment];\r\n    }\r\n\r\n    // Process status filters - separate workflow_status and confirmation_status\r\n    const workflowStatuses = [];\r\n    const confirmationStatuses = [];\r\n    const confirmationStatusList = [\r\n      \"waiting_for_responders\",\r\n      \"waiting_for_complainant\",\r\n      \"confirmed\",\r\n      \"disputed\",\r\n    ];\r\n\r\n    statusArray.forEach((statusValue) => {\r\n      if (!statusValue) return;\r\n      const statusLower = statusValue.toLowerCase();\r\n      if (confirmationStatusList.includes(statusLower)) {\r\n        confirmationStatuses.push(statusLower);\r\n      } else {\r\n        // Convert legacy status to workflow_status\r\n        const workflowStatus = getWorkflowFromStatus(statusValue);\r\n        if (workflowStatus && workflowStatus !== statusValue) {\r\n          workflowStatuses.push(workflowStatus);\r\n        } else if (\r\n          [\r\n            \"new\",\r\n            \"assigned\",\r\n            \"in_progress\",\r\n            \"pending_approval\",\r\n            \"completed\",\r\n            \"cancelled\",\r\n          ].includes(statusLower)\r\n        ) {\r\n          workflowStatuses.push(statusLower);\r\n        }\r\n      }\r\n    });\r\n\r\n    const serviceFilters = {\r\n      status: workflowStatuses.length > 0 ? workflowStatuses : undefined,\r\n      confirmationStatus:\r\n        confirmationStatuses.length > 0 ? confirmationStatuses : undefined,\r\n      category: categoryArray.length > 0 ? categoryArray : undefined,\r\n      subcategory: req.query.subcategory || undefined,\r\n      department: departmentArray.length > 0 ? departmentArray : undefined,\r\n      startDate: startDate || undefined,\r\n      endDate: endDate || undefined,\r\n      includeResolved: includeResolved === \"true\",\r\n    };\r\n\r\n    // Remove undefined values\r\n    Object.keys(serviceFilters).forEach((key) => {\r\n      if (serviceFilters[key] === void 0) {\r\n        delete serviceFilters[key];\r\n      }\r\n    });\r\n\r\n    const locations = await this.complaintService.getComplaintLocations(\r\n      serviceFilters\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      data: locations,\r\n      count: locations.length,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Mark a complaint as false\r\n   */\r\n  async markAsFalseComplaint(req, res) {\r\n    const { id } = req.params;\r\n    const { reason } = req.body;\r\n    const { user } = req;\r\n\r\n    const result = await this.complaintService.markAsFalseComplaint(\r\n      id,\r\n      user.id,\r\n      reason\r\n    );\r\n\r\n    if (!result.success) {\r\n      return res.status(400).json(result);\r\n    }\r\n\r\n    res.json(result);\r\n  }\r\n\r\n  /**\r\n   * Mark a complaint as duplicate\r\n   */\r\n  async markAsDuplicate(req, res) {\r\n    const { id } = req.params;\r\n    const { masterComplaintId } = req.body;\r\n    const { user } = req;\r\n\r\n    const result = await this.complaintService.markAsDuplicate(\r\n      id,\r\n      masterComplaintId,\r\n      user.id\r\n    );\r\n\r\n    if (!result.success) {\r\n      return res.status(400).json(result);\r\n    }\r\n\r\n    res.json(result);\r\n  }\r\n\r\n  /**\r\n   * Get all false complaints\r\n   */\r\n  async getFalseComplaints(req, res) {\r\n    const { limit } = req.query;\r\n    const result = await this.complaintService.getFalseComplaints({\r\n      limit: limit ? parseInt(limit) : undefined,\r\n    });\r\n\r\n    if (!result.success) {\r\n      return res.status(400).json(result);\r\n    }\r\n\r\n    res.json(result);\r\n  }\r\n\r\n  /**\r\n   * Get false complaint statistics\r\n   */\r\n  async getFalseComplaintStatistics(req, res) {\r\n    const result = await this.complaintService.getFalseComplaintStatistics();\r\n\r\n    if (!result.success) {\r\n      return res.status(400).json(result);\r\n    }\r\n\r\n    res.json(result);\r\n  }\r\n\r\n  /**\r\n   * Mark assignment as complete (LGU Officer)\r\n   */\r\n  async markAssignmentComplete(req, res) {\r\n    const { id: complaintId } = req.params;\r\n    const { notes } = req.body;\r\n    const { user } = req;\r\n\r\n    // Extract completion evidence files if uploaded\r\n    const files =\r\n      req.files && req.files.completionEvidence\r\n        ? req.files.completionEvidence\r\n        : [];\r\n\r\n    const result = await this.complaintService.markAssignmentComplete(\r\n      complaintId,\r\n      user.id,\r\n      notes,\r\n      files\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Assignment marked as complete successfully\",\r\n      data: result,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Confirm resolution (Citizen side)\r\n   */\r\n  async confirmResolution(req, res) {\r\n    const { id: complaintId } = req.params;\r\n    const { confirmed, feedback } = req.body;\r\n    const { user } = req;\r\n\r\n    const result = await this.complaintService.confirmResolution(\r\n      complaintId,\r\n      user.id,\r\n      confirmed,\r\n      feedback\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      message: confirmed\r\n        ? \"Resolution confirmed successfully\"\r\n        : \"Resolution rejected\",\r\n      data: result,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get evidence files for a complaint (citizen and authorized roles)\r\n   */\r\n  async getComplaintEvidence(req, res) {\r\n    const id = req.params.id || req.params.complaintId;\r\n    const { user } = req;\r\n    const files = await this.complaintService.getComplaintEvidence(id, user);\r\n    return res.json({ success: true, data: files });\r\n  }\r\n\r\n  async getConfirmationMessage(req, res) {\r\n    const { id } = req.params;\r\n    const { user } = req;\r\n    const message = await this.complaintService.getConfirmationMessage(\r\n      id,\r\n      user.role\r\n    );\r\n    res.json({\r\n      success: true,\r\n      data: message,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create assignment for officers\r\n   */\r\n  async createAssignment(req, res) {\r\n    const { complaintId } = req.params; // Get from URL parameter\r\n    const { officerIds } = req.body;\r\n    const { user } = req;\r\n\r\n    if (\r\n      !complaintId ||\r\n      !officerIds ||\r\n      !Array.isArray(officerIds) ||\r\n      officerIds.length === 0\r\n    ) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"Missing required fields: complaintId and officerIds array\",\r\n      });\r\n    }\r\n\r\n    const result = await this.complaintService.createAssignment(\r\n      complaintId,\r\n      officerIds,\r\n      user.id\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      data: result,\r\n      message: \"Assignment created successfully\",\r\n    });\r\n  }\r\n}\r\n\r\nmodule.exports = ComplaintController;\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\ComplianceController.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\CoordinatorController.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\DepartmentController.js","messages":[{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":84,"column":22,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":86,"endColumn":74}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const DepartmentService = require(\"../services/DepartmentService\");\n\nclass DepartmentController {\n\n  constructor() {\n    this.departmentService = new DepartmentService();\n  }\n  async getAllDepartments(req, res) {\n    try {\n      const departments = await this.departmentService.getAllDepartments();\n      res.json({\n        success: true,\n        data: departments\n      });\n    } catch (error) {\n      console.error(\"Error fetching departments:\", error);\n      res.status(500).json({\n        success: false,\n        error: \"Failed to fetch departments\"\n      });\n    }\n  }\n  async getActiveDepartments(req, res) {\n    try {\n      const departments = await this.departmentService.getActiveDepartments();\n      res.json({\n        success: true,\n        data: departments\n      });\n    } catch (error) {\n      console.error(\"Error fetching active departments:\", error);\n      res.status(500).json({\n        success: false,\n        error: \"Failed to fetch active departments\"\n      });\n    }\n  }\n  async getDepartmentById(req, res) {\n    try {\n      const { id } = req.params;\n      const department = await this.departmentService.getDepartmentById(id);\n      res.json({\n        success: true,\n        data: department\n      });\n    } catch (error) {\n      console.error(\"Error fetching department:\", error);\n      const status = error.message === \"Department not found\" ? 404 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  async createDepartment(req, res) {\n    try {\n      const department = await this.departmentService.createDepartment(req.body);\n      res.status(201).json({\n        success: true,\n        data: department,\n        message: \"Department created successfully\"\n      });\n    } catch (error) {\n      console.error(\"Error creating department:\", error);\n      const status = error.message.includes(\"Validation failed\") ||\n                     error.message.includes(\"already exists\") ? 400 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  async updateDepartment(req, res) {\n    try {\n      const { id } = req.params;\n      const department = await this.departmentService.updateDepartment(id, req.body);\n      res.json({\n        success: true,\n        data: department,\n        message: \"Department updated successfully\"\n      });\n    } catch (error) {\n      console.error(\"Error updating department:\", error);\n      const status = error.message === \"Department not found\" ? 404 :\n        error.message.includes(\"Validation failed\") ||\n                     error.message.includes(\"already exists\") ? 400 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  async deleteDepartment(req, res) {\n    try {\n      const { id } = req.params;\n      await this.departmentService.deleteDepartment(id);\n      res.json({\n        success: true,\n        message: \"Department deactivated successfully\"\n      });\n    } catch (error) {\n      console.error(\"Error deleting department:\", error);\n      const status = error.message === \"Department not found\" ? 404 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  async getDepartmentsByType(req, res) {\n    try {\n      const { type } = req.params;\n      const departments = await this.departmentService.getDepartmentsByType(type);\n      res.json({\n        success: true,\n        data: departments\n      });\n    } catch (error) {\n      console.error(\"Error fetching departments by type:\", error);\n      res.status(500).json({\n        success: false,\n        error: \"Failed to fetch departments\"\n      });\n    }\n  }\n  async getDepartmentOfficers(req, res) {\n    try {\n      const { id } = req.params;\n      const officers = await this.departmentService.getDepartmentOfficers(id);\n      res.json({\n        success: true,\n        data: officers\n      });\n    } catch (error) {\n      console.error(\"Error fetching department officers:\", error);\n      res.status(500).json({\n        success: false,\n        error: \"Failed to fetch department officers\"\n      });\n    }\n  }\n  /**\n   * Get all departments with their subcategory mappings\n   */\n  async getDepartmentsWithMappings(req, res) {\n    try {\n      const result = await this.departmentService.getDepartmentsWithMappings();\n      res.json({\n        success: true,\n        data: result\n      });\n    } catch (error) {\n      console.error(\"Error fetching departments with mappings:\", error);\n      res.status(500).json({\n        success: false,\n        error: \"Failed to fetch departments with mappings\"\n      });\n    }\n  }\n  /**\n   * Get departments by subcategory\n   */\n  async getDepartmentsBySubcategory(req, res) {\n    try {\n      const { subcategoryId } = req.params;\n      const departments = await this.departmentService.getDepartmentsBySubcategory(subcategoryId);\n      res.json({\n        success: true,\n        data: departments\n      });\n    } catch (error) {\n      console.error(\"Error fetching departments by subcategory:\", error);\n      res.status(500).json({\n        success: false,\n        error: \"Failed to fetch departments by subcategory\"\n      });\n    }\n  }\n}\n\nmodule.exports = DepartmentController;\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\HRController.js","messages":[{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":53,"column":44,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":53,"endColumn":53},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":53,"column":89,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":53,"endColumn":98},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":316,"column":51,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":316,"endColumn":60}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * HR Controller\n * Handles HR-specific operations including signup link generation\n */\nconst HRService = require(\"../services/HRService\");\nconst UserService = require(\"../services/UserService\");\nconst ComplaintService = require(\"../services/ComplaintService\");\n\nclass HRController {\n\n  constructor() {\n    this.hrService = new HRService();\n    this.userService = UserService;\n    this.complaintService = new ComplaintService();\n  }\n  /**\n   * Generate signup link\n   */\n  async generateSignupLink(req, res) {\n    try {\n      const { role, department_code, expires_in_hours } = req.body;\n      const hrId = req.user.id;\n      if (!role) {\n        return res.status(400).json({\n          success: false,\n          error: \"Role is required\"\n        });\n      }\n      const result = await this.hrService.generateSignupLink(\n        hrId,\n        role,\n        department_code,\n        expires_in_hours || 24\n      );\n      res.json(result);\n    } catch (error) {\n      console.error(\"Generate signup link error:\", error);\n      res.status(500).json({\n        success: false,\n        error: error.message || \"Failed to generate signup link\"\n      });\n    }\n  }\n  /**\n   * Get signup links\n   */\n  async getSignupLinks(req, res) {\n    try {\n      const hrId = req.user.id;\n      const filters = {\n        role: req.query.role,\n        department_code: req.query.department_code,\n        is_active: req.query.is_active !== undefined ? req.query.is_active === \"true\" : undefined\n      };\n      const result = await this.hrService.getSignupLinks(hrId, filters);\n      res.json(result);\n    } catch (error) {\n      console.error(\"Get signup links error:\", error);\n      res.status(500).json({\n        success: false,\n        error: error.message || \"Failed to get signup links\"\n      });\n    }\n  }\n  /**\n   * Deactivate signup link\n   */\n  async deactivateSignupLink(req, res) {\n    try {\n      // console.log removed for security\n      const { linkId } = req.params;\n      const hrId = req.user.id;\n      // console.log removed for security\n      const result = await this.hrService.deactivateSignupLink(hrId, linkId);\n      // console.log removed for security\n      res.json(result);\n    } catch (error) {\n      console.error(\"[HR-CONTROLLER] Deactivate signup link error:\", error);\n      res.status(500).json({\n        success: false,\n        error: error.message || \"Failed to deactivate signup link\"\n      });\n    }\n  }\n  /**\n   * Validate signup code (public endpoint)\n   */\n  async validateSignupCode(req, res) {\n    try {\n      // console.log removed for security\n      const { code } = req.params;\n      if (!code) {\n        // console.log removed for security\n        return res.status(400).json({\n          success: false,\n          error: \"Code is required\"\n        });\n      }\n      // console.log removed for security\n      const result = await this.hrService.validateSignupCode(code);\n      // console.log removed for security\n      res.json(result);\n    } catch (error) {\n      console.error(\"[HR] Validate signup code error:\", error);\n      res.status(500).json({\n        success: false,\n        error: error.message || \"Failed to validate signup code\"\n      });\n    }\n  }\n  /**\n   * Get HR dashboard\n   */\n  async getDashboard(req, res) {\n    try {\n      const hrId = req.user.id;\n      const result = await this.hrService.getHRDashboard(hrId);\n      res.json({\n        success: true,\n        data: result\n      });\n    } catch (error) {\n      console.error(\"Get HR dashboard error:\", error);\n      res.status(500).json({\n        success: false,\n        error: error.message || \"Failed to get HR dashboard\"\n      });\n    }\n  }\n  /**\n   * POST /api/hr/promote-to-officer\n   */\n  async promoteToOfficer(req, res) {\n    try {\n      const hrId = req.user.id;\n      const { user_id, department, reason } = req.body;\n      if (!user_id) {\n        return res.status(400).json({ success: false, error: \"user_id is required\" });\n      }\n      const result = await this.hrService.promoteToOfficer(user_id, hrId, { department, reason });\n      return res.json(result);\n    } catch (error) {\n      console.error(\"[HR] promoteToOfficer error:\", error);\n      return res.status(500).json({ success: false, error: error.message || \"Failed to promote user\" });\n    }\n  }\n  /**\n   * POST /api/hr/promote-to-admin\n   */\n  async promoteToAdmin(req, res) {\n    try {\n      const hrId = req.user.id;\n      const { user_id, department, reason } = req.body;\n      if (!user_id) {\n        return res.status(400).json({ success: false, error: \"user_id is required\" });\n      }\n      const result = await this.hrService.promoteToAdmin(user_id, hrId, { department, reason });\n      return res.json(result);\n    } catch (error) {\n      console.error(\"[HR] promoteToAdmin error:\", error);\n      return res.status(500).json({ success: false, error: error.message || \"Failed to promote user\" });\n    }\n  }\n  /**\n   * POST /api/hr/demote-to-officer\n   */\n  async demoteToOfficer(req, res) {\n    try {\n      const hrId = req.user.id;\n      const { user_id, reason } = req.body;\n      if (!user_id) {\n        return res.status(400).json({ success: false, error: \"user_id is required\" });\n      }\n      const result = await this.hrService.demoteAdminToOfficer(user_id, hrId, { reason });\n      return res.json(result);\n    } catch (error) {\n      console.error(\"[HR] demoteToOfficer error:\", error);\n      return res.status(500).json({ success: false, error: error.message || \"Failed to demote user\" });\n    }\n  }\n  /**\n   * POST /api/hr/strip-titles -> revert to citizen\n   */\n  async stripTitles(req, res) {\n    try {\n      const hrId = req.user.id;\n      const { user_id, reason } = req.body;\n      if (!user_id) {\n        return res.status(400).json({ success: false, error: \"user_id is required\" });\n      }\n      if (!reason) {\n        return res.status(400).json({ success: false, error: \"reason is required\" });\n      }\n      const result = await this.hrService.stripTitles(user_id, hrId, reason);\n      return res.json(result);\n    } catch (error) {\n      console.error(\"[HR] stripTitles error:\", error);\n      return res.status(500).json({ success: false, error: error.message || \"Failed to strip titles\" });\n    }\n  }\n  /**\n   * POST /api/hr/assign-department\n   */\n  async assignDepartment(req, res) {\n    try {\n      const hrId = req.user.id;\n      const { user_id, department_id } = req.body;\n      if (!user_id || !department_id) {\n        return res.status(400).json({ success: false, error: \"user_id and department_id are required\" });\n      }\n      const result = await this.hrService.assignOfficerToDepartment(user_id, department_id, hrId);\n      return res.json(result);\n    } catch (error) {\n      console.error(\"[HR] assignDepartment error:\", error);\n      return res.status(500).json({ success: false, error: error.message || \"Failed to assign department\" });\n    }\n  }\n  /**\n   * GET /api/hr/users\n   * Supports search and barangay filter\n   */\n  async getUsers(req, res) {\n    try {\n      const { search, barangay, role, department, status, page, limit } = req.query;\n      const filters = { role, department, status, search, includeInactive: true };\n      const pagination = { page: page ? parseInt(page) : 1, limit: limit ? parseInt(limit) : 20 };\n      const result = await this.userService.getUsers(filters, pagination);\n      // Apply barangay filter client-side since admin.listUsers lacks server filters\n      const filteredUsers = barangay\n        ? (result.users || []).filter(u => (u.address?.barangay || \"\").toLowerCase() === String(barangay).toLowerCase())\n        : result.users;\n      return res.json({\n        success: true,\n        data: filteredUsers,\n        pagination: result.pagination\n      });\n    } catch (error) {\n      console.error(\"[HR] getUsers error:\", error);\n      return res.status(500).json({ success: false, error: error.message || \"Failed to fetch users\" });\n    }\n  }\n  /**\n   * GET /api/hr/pending-signups\n   * List users with status pending_approval (HR-scoped)\n   */\n  async getPendingSignups(req, res) {\n    try {\n      const hrId = req.user.id;\n      // Reuse UserService listing, then filter by metadata\n      const result = await this.userService.getUsers({ includeInactive: true }, { page: 1, limit: 200 });\n      const hrDept = req.user?.department || req.user?.raw_user_meta_data?.department || req.user?.raw_user_meta_data?.dpt || null;\n\n      // Get list of users who used signup codes (check signup_links table)\n      const Database = require(\"../config/database\");\n      const db = Database.getInstance();\n      const supabase = db.getClient();\n\n      // Map of user_id -> { role, department_code } from signup_links table\n      const usersWithSignupCodes = new Map();\n      try {\n        const { data: usedLinks, error: linksError } = await supabase\n          .from(\"signup_links\")\n          .select(\"used_by, role, department_code\")\n          .not(\"used_by\", \"is\", null);\n\n        if (!linksError && usedLinks) {\n          usedLinks.forEach(link => {\n            if (link.used_by) {\n              usersWithSignupCodes.set(link.used_by, {\n                role: link.role,\n                department_code: link.department_code\n              });\n            }\n          });\n          console.log(\"[HR] Found\", usersWithSignupCodes.size, \"users who used signup codes\");\n        } else if (linksError) {\n          console.error(\"[HR] Error fetching signup links:\", linksError);\n        }\n      } catch (linksErr) {\n        console.error(\"[HR] Error fetching signup links:\", linksErr);\n      }\n\n      // Debug: Log all users to see what we're working with\n      console.log(\"[HR] getPendingSignups - Total users fetched:\", result.users?.length || 0);\n      console.log(\"[HR] Sample users (first 5):\", result.users?.slice(0, 5).map(u => ({\n        email: \"[REDACTED]\",\n        status: u.status,\n        raw_status: u.raw_user_meta_data?.status,\n        meta_status: u.user_metadata?.status,\n        pending_role: u.raw_user_meta_data?.pending_role || u.user_metadata?.pending_role,\n        pending_dept: u.raw_user_meta_data?.pending_department || u.user_metadata?.pending_department,\n        role: u.role,\n        used_signup_code: usersWithSignupCodes.has(u.id)\n      })));\n\n      // Filter for pending signups - check both status field and pending_role in metadata\n      const pending = (result.users || []).filter(u => {\n        // Check status in multiple places\n        const status = u.status ||\n                      u.raw_user_meta_data?.status ||\n                      u.user_metadata?.status ||\n                      null;\n\n        // Check for pending_role in metadata (this indicates pending approval)\n        const hasPendingRole = u.raw_user_meta_data?.pending_role ||\n                              u.user_metadata?.pending_role ||\n                              null;\n\n        // Check for pending_signup_code (indicates they used a signup code)\n        const hasPendingCode = u.raw_user_meta_data?.pending_signup_code ||\n                              u.user_metadata?.pending_signup_code ||\n                              null;\n\n        // Check if user used a signup code (from signup_links table)\n        const signupCodeInfo = usersWithSignupCodes.get(u.id);\n        const usedSignupCode = signupCodeInfo !== undefined;\n\n        // Get pending department from metadata OR from signup_links table\n        let pendingDept = u.raw_user_meta_data?.pending_department ||\n                         u.user_metadata?.pending_department ||\n                         null;\n        // If metadata doesn't have pending_department but user used a signup code, get it from signup_links\n        if (!pendingDept && signupCodeInfo) {\n          pendingDept = signupCodeInfo.department_code;\n        }\n\n        // Get pending role from metadata OR from signup_links table\n        let pendingRole = hasPendingRole;\n        if (!pendingRole && signupCodeInfo) {\n          pendingRole = signupCodeInfo.role;\n        }\n\n        // User is pending if:\n        // 1. status is 'pending_approval' OR\n        // 2. has pending_role (from metadata or signup_links) OR\n        // 3. has pending_signup_code OR\n        // 4. has status 'pending_verification' AND used a signup code (metadata update failed) AND is citizen\n        const isPending = status === \"pending_approval\" ||\n                         pendingRole ||\n                         hasPendingCode ||\n                         (status === \"pending_verification\" && usedSignupCode && u.role === \"citizen\");\n\n        if (!isPending) {\n          return false;\n        }\n\n        // Department filtering:\n        // - Super-admin can see ALL pending signups across all offices (no filter)\n        // - HR users can only see pending signups within their own office\n        const isSuperAdmin = req.user?.normalized_role === \"super-admin\" || req.user?.role === \"super-admin\";\n\n        if (!isSuperAdmin && hrDept) {\n          // HR user: only show pending signups for their department\n          // If pending signup has a department and it doesn't match HR's department, filter it out\n          if (pendingDept && pendingDept !== hrDept) {\n            return false;\n          }\n          // If HR has a department but pending signup doesn't have one, we might want to filter it out too\n          // (This depends on business logic - for now, we'll allow it if pendingDept is null)\n        }\n\n        return true;\n      });\n\n      // Enhance pending users with signup code info if metadata is missing\n      const enhancedPending = pending.map(u => {\n        const signupCodeInfo = usersWithSignupCodes.get(u.id);\n        if (signupCodeInfo && (!u.raw_user_meta_data?.pending_role && !u.user_metadata?.pending_role)) {\n          // Add pending fields from signup_links if metadata doesn't have them\n          return {\n            ...u,\n            raw_user_meta_data: {\n              ...u.raw_user_meta_data,\n              pending_role: signupCodeInfo.role,\n              pending_department: signupCodeInfo.department_code\n            }\n          };\n        }\n        return u;\n      });\n\n      console.log(\"[HR] getPendingSignups - Found\", enhancedPending.length, \"pending signups for HR:\", hrId, \"department:\", hrDept);\n      console.log(\"[HR] Sample pending users:\", enhancedPending.slice(0, 3).map(u => ({\n        id: u.id,\n        email: \"[REDACTED]\",\n        status: u.status,\n        pending_role: u.raw_user_meta_data?.pending_role || u.user_metadata?.pending_role,\n        pending_department: u.raw_user_meta_data?.pending_department || u.user_metadata?.pending_department,\n        from_signup_links: usersWithSignupCodes.has(u.id)\n      })));\n\n      return res.json({ success: true, data: enhancedPending });\n    } catch (error) {\n      console.error(\"[HR] getPendingSignups error:\", error);\n      return res.status(500).json({ success: false, error: error.message || \"Failed to fetch pending signups\" });\n    }\n  }\n  /**\n   * POST /api/hr/pending-signups/:id/approve\n   * Approve a pending signup and apply role/department\n   */\n  async approvePendingSignup(req, res) {\n    try {\n      const hrId = req.user.id;\n      const userId = req.params.id;\n      const user = await this.userService.getUserById(userId);\n      if (!user) return res.status(404).json({ success: false, error: \"User not found\" });\n\n      // Get pending role and department from metadata first\n      let pendingRole = user?.raw_user_meta_data?.pending_role || user?.user_metadata?.pending_role;\n      let pendingDept = user?.raw_user_meta_data?.pending_department || user?.user_metadata?.pending_department;\n\n      // If not in metadata, check signup_links table (metadata update may have failed)\n      if (!pendingRole || !pendingDept) {\n        const Database = require(\"../config/database\");\n        const db = Database.getInstance();\n        const supabase = db.getClient();\n\n        try {\n          const { data: signupLinks, error: linkError } = await supabase\n            .from(\"signup_links\")\n            .select(\"role, department_code\")\n            .eq(\"used_by\", userId)\n            .not(\"used_by\", \"is\", null)\n            .order(\"used_at\", { ascending: false })\n            .limit(1);\n\n          const signupLink = signupLinks && signupLinks.length > 0 ? signupLinks[0] : null;\n\n          if (!linkError && signupLink) {\n            if (!pendingRole && signupLink.role) {\n              pendingRole = signupLink.role;\n            }\n            if (!pendingDept && signupLink.department_code) {\n              pendingDept = signupLink.department_code;\n            }\n            console.log(\"[HR] Got pending role/dept from signup_links:\", {\n              userId,\n              pendingRole,\n              pendingDept,\n              fromTable: true\n            });\n          } else if (linkError) {\n            console.error(\"[HR] Error fetching signup link:\", linkError);\n          }\n        } catch (linkErr) {\n          console.error(\"[HR] Error fetching signup link:\", linkErr);\n        }\n      }\n\n      if (!pendingRole) {\n        console.error(\"[HR] No pending role found for user:\", userId);\n        return res.status(400).json({ success: false, error: \"No pending role to approve. User may not have registered with a signup code.\" });\n      }\n\n      // Normalize role using general normalization function\n      const { normalizeRole } = require(\"../utils/roleValidation\");\n      const normalizedRole = normalizeRole(pendingRole);\n\n      if (pendingRole !== normalizedRole) {\n        console.log(\"[HR] Normalizing role from\", pendingRole, \"to\", normalizedRole, \"for user:\", userId);\n      }\n\n      // Ensure we're using the normalized role consistently\n      console.log(\"[HR] Approval role mapping:\", {\n        pendingRole,\n        normalizedRole,\n        userId\n      });\n\n      // HR department scope enforcement (super-admin bypasses)\n      const isSuper = (req.user?.normalized_role === \"super-admin\" || req.user?.role === \"super-admin\");\n      if (!isSuper && req.user?.department && pendingDept && String(req.user.department) !== String(pendingDept)) {\n        return res.status(403).json({ success: false, error: \"You can only approve for your own office\" });\n      }\n\n      // Apply role/department and clear pending flags\n      // Set department in both formats for consistency (department and dpt)\n      const updated = await this.userService.updateUser(userId, {\n        role: normalizedRole,\n        normalized_role: normalizedRole,\n        base_role: normalizedRole, // Store base role for reference\n        department: pendingDept,\n        dpt: pendingDept, // Also set dpt field for consistency\n        status: \"active\",\n        pending_role: null,\n        pending_department: null,\n        pending_signup_code: null\n      }, hrId);\n\n      console.log(\"[HR] Approved signup:\", {\n        userId,\n        role: normalizedRole,\n        department: pendingDept,\n        originalPendingRole: pendingRole\n      });\n      return res.json({ success: true, message: \"Signup approved\", data: updated });\n    } catch (error) {\n      console.error(\"[HR] approvePendingSignup error:\", error);\n      return res.status(500).json({ success: false, error: error.message || \"Failed to approve signup\" });\n    }\n  }\n  /**\n   * POST /api/hr/pending-signups/:id/reject\n   * Reject a pending signup; keep user as citizen and clear flags\n   */\n  async rejectPendingSignup(req, res) {\n    try {\n      const hrId = req.user.id;\n      const userId = req.params.id;\n      const user = await this.userService.getUserById(userId);\n      if (!user) return res.status(404).json({ success: false, error: \"User not found\" });\n      const isSuper = (req.user?.normalized_role === \"super-admin\" || req.user?.role === \"super-admin\");\n      const pendingDept = user?.raw_user_meta_data?.pending_department || user?.user_metadata?.pending_department;\n      if (!isSuper && req.user?.department && pendingDept && String(req.user.department) !== String(pendingDept)) {\n        return res.status(403).json({ success: false, error: \"You can only reject for your own office\" });\n      }\n      const updated = await this.userService.updateUser(userId, {\n        role: \"citizen\",\n        normalized_role: \"citizen\",\n        status: \"rejected\",\n        pending_role: null,\n        pending_department: null,\n        pending_signup_code: null\n      }, hrId);\n      return res.json({ success: true, message: \"Signup rejected\", data: updated });\n    } catch (error) {\n      console.error(\"[HR] rejectPendingSignup error:\", error);\n      return res.status(500).json({ success: false, error: error.message || \"Failed to reject signup\" });\n    }\n  }\n  /**\n   * GET /api/hr/users/:id\n   */\n  async getUserDetails(req, res) {\n    try {\n      const { id } = req.params;\n      const user = await this.userService.getUserById(id);\n      if (!user) {\n        return res.status(404).json({ success: false, error: \"User not found\" });\n      }\n      return res.json({ success: true, data: user });\n    } catch (error) {\n      console.error(\"[HR] getUserDetails error:\", error);\n      return res.status(500).json({ success: false, error: error.message || \"Failed to fetch user\" });\n    }\n  }\n  /**\n   * GET /api/hr/users/:id/complaints\n   */\n  async getUserComplaints(req, res) {\n    try {\n      const { id } = req.params;\n      const options = {\n        page: req.query.page ? parseInt(req.query.page) : 1,\n        limit: req.query.limit ? parseInt(req.query.limit) : 10,\n        status: req.query.status,\n        type: req.query.type\n      };\n      const result = await this.complaintService.getUserComplaints(id, options);\n      return res.json({\n        success: true,\n        data: result.complaints,\n        pagination: {\n          page: result.page,\n          limit: result.limit,\n          total: result.total,\n          totalPages: result.totalPages\n        }\n      });\n    } catch (error) {\n      console.error(\"[HR] getUserComplaints error:\", error);\n      return res.status(500).json({ success: false, error: error.message || \"Failed to fetch complaints\" });\n    }\n  }\n}\n\nmodule.exports = HRController;\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\LguAdminController.js","messages":[{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":344,"column":9,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":348,"endColumn":17},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":658,"column":68,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":658,"endColumn":77},{"ruleId":"no-lonely-if","severity":1,"message":"Unexpected if as the only statement in an else block.","line":771,"column":9,"nodeType":"IfStatement","messageId":"unexpectedLonelyIf","endLine":775,"endColumn":10},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":917,"column":25,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":921,"endColumn":28},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":927,"column":19,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":931,"endColumn":42},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1300,"column":9,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1304,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * LGU Admin Controller\r\n * Handles department-specific admin operations\r\n */\r\nconst Database = require(\"../config/database\");\r\n\r\nconst db = new Database();\r\nconst supabase = db.getClient();\r\nconst NotificationService = require(\"../services/NotificationService\");\r\nconst crypto = require(\"crypto\");\r\n\r\n// Create notification service instance\r\nconst notificationService = new NotificationService();\r\n// Notification constants\r\nconst NOTIFICATION_TYPES = {\r\n  ASSIGNMENT_COMPLETED: \"assignment_completed\",\r\n};\r\nconst NOTIFICATION_PRIORITY = {\r\n  INFO: \"info\",\r\n  URGENT: \"urgent\",\r\n};\r\nclass LguAdminController {\r\n  /**\r\n   * Get dashboard statistics\r\n   * Returns aggregated metrics for the dashboard\r\n   */\r\n  async getDashboardStats(req, res) {\r\n    try {\r\n      const _userRole = req.user.role;\r\n      // Extract department from user metadata\r\n      const departmentCode =\r\n        req.user.department ||\r\n        req.user.metadata?.department ||\r\n        req.user.raw_user_meta_data?.department ||\r\n        req.user.raw_user_meta_data?.dpt;\r\n\r\n      if (!departmentCode) {\r\n        return res.status(400).json({\r\n          success: false,\r\n          error: \"Department not specified in user metadata.\",\r\n        });\r\n      }\r\n\r\n      // Get department details\r\n      const { data: department, error: deptError } = await supabase\r\n        .from(\"departments\")\r\n        .select(\"id, name, code\")\r\n        .eq(\"code\", departmentCode)\r\n        .single();\r\n\r\n      if (deptError || !department) {\r\n        return res\r\n          .status(404)\r\n          .json({ success: false, error: \"Department not found\" });\r\n      }\r\n\r\n      // 1. Parallel Count Queries (Case Insensitive)\r\n      const [totalActive, unassigned, urgent, high, medium, low] =\r\n        await Promise.all([\r\n          // Total Active\r\n          supabase\r\n            .from(\"complaints\")\r\n            .select(\"id\", { count: \"exact\", head: true })\r\n            .contains(\"department_r\", [departmentCode])\r\n            .neq(\"workflow_status\", \"completed\")\r\n            .neq(\"workflow_status\", \"Completed\")\r\n            .neq(\"workflow_status\", \"COMPLETED\")\r\n            .then((res) => res.count || 0),\r\n\r\n          // Unassigned\r\n          supabase\r\n            .from(\"complaints\")\r\n            .select(\"id\", { count: \"exact\", head: true })\r\n            .contains(\"department_r\", [departmentCode])\r\n            .in(\"workflow_status\", [\r\n              \"new\",\r\n              \"pending\",\r\n              \"unassigned\",\r\n              \"New\",\r\n              \"Pending\",\r\n              \"Unassigned\",\r\n              \"NEW\",\r\n              \"PENDING\",\r\n              \"UNASSIGNED\",\r\n            ])\r\n            .then((res) => res.count || 0),\r\n\r\n          // Priority Counts (Active Only)\r\n          supabase\r\n            .from(\"complaints\")\r\n            .select(\"id\", { count: \"exact\", head: true })\r\n            .contains(\"department_r\", [departmentCode])\r\n            .in(\"priority\", [\"urgent\", \"Urgent\", \"URGENT\"])\r\n            .neq(\"workflow_status\", \"completed\")\r\n            .then((res) => res.count || 0),\r\n\r\n          supabase\r\n            .from(\"complaints\")\r\n            .select(\"id\", { count: \"exact\", head: true })\r\n            .contains(\"department_r\", [departmentCode])\r\n            .in(\"priority\", [\"high\", \"High\", \"HIGH\"])\r\n            .neq(\"workflow_status\", \"completed\")\r\n            .then((res) => res.count || 0),\r\n\r\n          supabase\r\n            .from(\"complaints\")\r\n            .select(\"id\", { count: \"exact\", head: true })\r\n            .contains(\"department_r\", [departmentCode])\r\n            .in(\"priority\", [\"medium\", \"Medium\", \"MEDIUM\"])\r\n            .neq(\"workflow_status\", \"completed\")\r\n            .then((res) => res.count || 0),\r\n\r\n          supabase\r\n            .from(\"complaints\")\r\n            .select(\"id\", { count: \"exact\", head: true })\r\n            .contains(\"department_r\", [departmentCode])\r\n            .in(\"priority\", [\"low\", \"Low\", \"LOW\"])\r\n            .neq(\"workflow_status\", \"completed\")\r\n            .then((res) => res.count || 0),\r\n        ]);\r\n\r\n      // 2. Recent Unassigned (Limit 5)\r\n      const { data: recentUnassigned } = await supabase\r\n        .from(\"complaints\")\r\n        .select(\"id, title, submitted_at, location_text, priority\")\r\n        .contains(\"department_r\", [departmentCode])\r\n        .in(\"workflow_status\", [\r\n          \"new\",\r\n          \"pending\",\r\n          \"unassigned\",\r\n          \"New\",\r\n          \"Pending\",\r\n          \"Unassigned\",\r\n          \"NEW\",\r\n          \"PENDING\",\r\n          \"UNASSIGNED\",\r\n        ])\r\n        .order(\"submitted_at\", { ascending: false })\r\n        .limit(5);\r\n\r\n      // 3. Trend Data (Last 7 Days)\r\n      // Approximate by fetching submission dates\r\n      const sevenDaysAgo = new Date();\r\n      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\r\n\r\n      const { data: trendData } = await supabase\r\n        .from(\"complaints\")\r\n        .select(\"submitted_at\")\r\n        .contains(\"department_r\", [departmentCode])\r\n        .gte(\"submitted_at\", sevenDaysAgo.toISOString());\r\n\r\n      // Aggregate trend in JS\r\n      const dailyCounts = {};\r\n      if (trendData) {\r\n        trendData.forEach((c) => {\r\n          const date = new Date(c.submitted_at).toISOString().split(\"T\")[0];\r\n          dailyCounts[date] = (dailyCounts[date] || 0) + 1;\r\n        });\r\n      }\r\n\r\n      res.json({\r\n        success: true,\r\n        stats: {\r\n          total_active: totalActive,\r\n          unassigned,\r\n          priority: {\r\n            urgent,\r\n            high,\r\n            medium,\r\n            low,\r\n          },\r\n        },\r\n        charts: {\r\n          trend: dailyCounts,\r\n        },\r\n        lists: {\r\n          recent_unassigned: recentUnassigned || [],\r\n        },\r\n      });\r\n    } catch (error) {\r\n      console.error(\"[LGU_ADMIN] Get dashboard stats error:\", error);\r\n      res.status(500).json({\r\n        success: false,\r\n        error: \"Failed to fetch dashboard stats\",\r\n        details: error.message,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get department queue\r\n   * Returns complaints assigned to the admin's department\r\n   */\r\n  async getDepartmentQueue(req, res) {\r\n    try {\r\n      const _userId = req.user.id;\r\n      const userRole = req.user.role;\r\n      const { status, priority, limit } = req.query;\r\n\r\n      // Extract department from user metadata (check multiple possible field names)\r\n      const departmentCode =\r\n        req.user.department ||\r\n        req.user.metadata?.department ||\r\n        req.user.raw_user_meta_data?.department ||\r\n        req.user.raw_user_meta_data?.dpt;\r\n\r\n      if (!departmentCode) {\r\n        console.error(\"[LGU_ADMIN] No department found in user metadata:\", {\r\n          userRole,\r\n          department: req.user.department,\r\n          metadata: req.user.metadata,\r\n          rawMetadata: req.user.raw_user_meta_data,\r\n        });\r\n        return res.status(400).json({\r\n          success: false,\r\n          error:\r\n            \"Department not specified in user metadata. Please contact administrator to set your department.\",\r\n          details: {\r\n            userRole,\r\n            hasMetadata: Boolean(req.user.metadata),\r\n            hasRawMetadata: Boolean(req.user.raw_user_meta_data),\r\n            metadataKeys: Object.keys(req.user.metadata || {}),\r\n            rawMetadataKeys: Object.keys(req.user.raw_user_meta_data || {}),\r\n          },\r\n        });\r\n      }\r\n      // Get the department ID\r\n      const { data: department, error: deptError } = await supabase\r\n        .from(\"departments\")\r\n        .select(\"id, name, code\")\r\n        .eq(\"code\", departmentCode)\r\n        .single();\r\n      if (deptError || !department) {\r\n        console.error(\"[LGU_ADMIN] Department not found:\", {\r\n          departmentCode,\r\n          error: deptError,\r\n        });\r\n        return res.status(404).json({\r\n          success: false,\r\n          error: \"Department not found\",\r\n        });\r\n      }\r\n      // Build query for complaints assigned to this department\r\n      let query = supabase\r\n        .from(\"complaints\")\r\n        .select(\r\n          `\r\n          id, title, descriptive_su, submitted_at, submitted_by, \r\n          workflow_status, priority, location_text,\r\n          preferred_departments, department_r,\r\n          last_activity_at, updated_at\r\n        `\r\n        )\r\n        .contains(\"department_r\", [departmentCode])\r\n        .order(\"submitted_at\", { ascending: false });\r\n      // Apply filters\r\n      if (status) {\r\n        query = query.eq(\"workflow_status\", status);\r\n      }\r\n      if (priority) {\r\n        query = query.eq(\"priority\", priority);\r\n      }\r\n      if (limit) {\r\n        query = query.limit(parseInt(limit));\r\n      }\r\n      const { data: complaints, error } = await query;\r\n      if (error) {\r\n        console.error(\"[LGU_ADMIN] Error fetching department queue:\", error);\r\n        return res.status(500).json({\r\n          success: false,\r\n          error: \"Failed to fetch department queue\",\r\n        });\r\n      }\r\n      // Get assignment details for each complaint\r\n      const complaintsWithAssignments = await Promise.all(\r\n        complaints.map(async (complaint) => {\r\n          // Get all assignments for this complaint\r\n          const { data: assignments } = await supabase\r\n            .from(\"complaint_assignments\")\r\n            .select(\r\n              \"assigned_to, status, assigned_at, assigned_by, department_id\"\r\n            )\r\n            .eq(\"complaint_id\", complaint.id);\r\n\r\n          // Check if complaint is assigned to this admin's department\r\n          const isAssignedToDepartment =\r\n            assignments?.some(\r\n              (assignment) => assignment.department_id === department.id\r\n            ) || false;\r\n\r\n          return {\r\n            ...complaint,\r\n            assignments: assignments || [],\r\n            is_assigned_to_department: isAssignedToDepartment,\r\n          };\r\n        })\r\n      );\r\n      res.json({\r\n        success: true,\r\n        data: complaintsWithAssignments,\r\n        count: complaintsWithAssignments.length,\r\n        department: {\r\n          id: department.id,\r\n          name: department.name,\r\n          code: department.code,\r\n        },\r\n      });\r\n    } catch (error) {\r\n      console.error(\"[LGU_ADMIN] Get department queue error:\", error);\r\n      res.status(500).json({\r\n        success: false,\r\n        error: \"Failed to fetch department queue\",\r\n      });\r\n    }\r\n  }\r\n  /**\r\n   * Assign complaint to officer\r\n   */\r\n  async assignToOfficer(req, res) {\r\n    try {\r\n      // console.log removed for security\r\n      const { complaintId } = req.params;\r\n      const { officerIds, officerId, priority, deadline, notes } = req.body;\r\n      const userId = req.user?.id;\r\n      const _userRole = req.user?.role;\r\n      // Validate required parameters\r\n      if (!complaintId) {\r\n        console.error(\"[LGU_ADMIN] Missing complaintId in params\");\r\n        console.error(\"[LGU_ADMIN] Available params:\", req.params);\r\n        return res.status(400).json({\r\n          success: false,\r\n          error: \"Complaint ID is required\",\r\n        });\r\n      }\r\n      if (!userId) {\r\n        console.error(\"[LGU_ADMIN] Missing user ID\");\r\n        return res.status(401).json({\r\n          success: false,\r\n          error: \"User not authenticated\",\r\n        });\r\n      }\r\n      // Support both single officer (officerId) and multiple officers (officerIds)\r\n      const officersToAssign =\r\n        officerIds && Array.isArray(officerIds)\r\n          ? officerIds\r\n          : officerId\r\n            ? [officerId]\r\n            : [];\r\n      if (officersToAssign.length === 0) {\r\n        return res.status(400).json({\r\n          success: false,\r\n          error: \"No officers specified for assignment\",\r\n        });\r\n      }\r\n      // Extract department from user metadata (check multiple possible field names)\r\n      const departmentCode =\r\n        req.user.department ||\r\n        req.user.metadata?.department ||\r\n        req.user.raw_user_meta_data?.department ||\r\n        req.user.raw_user_meta_data?.dpt;\r\n      // console.log removed for security\r\n      if (!departmentCode) {\r\n        return res.status(400).json({\r\n          success: false,\r\n          error:\r\n            \"Department not specified in user metadata. Please contact administrator to set your department.\",\r\n        });\r\n      }\r\n      // Get department info\r\n      const { data: department, error: deptError } = await supabase\r\n        .from(\"departments\")\r\n        .select(\"id, name, code\")\r\n        .eq(\"code\", departmentCode)\r\n        .single();\r\n      if (deptError || !department) {\r\n        return res.status(404).json({\r\n          success: false,\r\n          error: \"Department not found\",\r\n        });\r\n      }\r\n      // Verify complaint exists and is assigned to this department\r\n      const { data: complaint, error: complaintError } = await supabase\r\n        .from(\"complaints\")\r\n        .select(\"*\")\r\n        .eq(\"id\", complaintId)\r\n        .single();\r\n      if (complaintError || !complaint) {\r\n        return res.status(404).json({\r\n          success: false,\r\n          error: \"Complaint not found\",\r\n        });\r\n      }\r\n      // Check if complaint is assigned to this department\r\n      if (\r\n        !complaint.department_r ||\r\n        !complaint.department_r.includes(departmentCode)\r\n      ) {\r\n        return res.status(403).json({\r\n          success: false,\r\n          error: \"Complaint is not assigned to your department\",\r\n        });\r\n      }\r\n      // Generate a unique assignment group ID for this multi-officer assignment\r\n      const assignmentGroupId = crypto.randomUUID();\r\n      const assignmentType = officersToAssign.length > 1 ? \"multi\" : \"single\";\r\n      // Create assignment records for each officer\r\n      const assignments = [];\r\n      const rejectedOfficers = [];\r\n      // Fetch all users once to avoid multiple API calls\r\n      let allUsers = [];\r\n      try {\r\n        const { data: authUsers, error: authError } =\r\n          await supabase.auth.admin.listUsers();\r\n        if (authError) {\r\n          console.error(\r\n            \"[LGU_ADMIN] Error fetching auth users for officer verification:\",\r\n            authError\r\n          );\r\n          return res.status(500).json({\r\n            success: false,\r\n            error: \"Failed to fetch officer data\",\r\n          });\r\n        }\r\n        allUsers = authUsers.users || [];\r\n        // console.log removed for security\r\n      } catch (authErr) {\r\n        console.error(\r\n          \"[LGU_ADMIN] Auth API error for officer verification:\",\r\n          authErr\r\n        );\r\n        return res.status(500).json({\r\n          success: false,\r\n          error: \"Failed to fetch officer data\",\r\n        });\r\n      }\r\n      for (let i = 0; i < officersToAssign.length; i++) {\r\n        const officerId = officersToAssign[i];\r\n        // Find officer in the already fetched users\r\n        const officerData = allUsers.find((u) => u.id === officerId);\r\n        if (!officerData) {\r\n          console.error(\"[LGU_ADMIN] Officer not found:\", { officerId });\r\n          rejectedOfficers.push({\r\n            id: officerId,\r\n            reason: \"Officer not found in database\",\r\n          });\r\n          continue; // Skip this officer but continue with others\r\n        }\r\n        const officer = officerData;\r\n        // Debug: Log officer metadata structure\r\n        // Check if officer belongs to this department\r\n        const metadata = officer.user_metadata || {};\r\n        const rawMetadata = officer.raw_user_meta_data || {};\r\n        const role = metadata.role || rawMetadata.role || \"\";\r\n        // Use the same logic as getDepartmentOfficers\r\n        const isLguOfficer =\r\n          role === \"lgu\" || role === \"lgu-officer\" || role === \"lgu-admin\";\r\n        const hasCorrectDepartment =\r\n          metadata.dpt === departmentCode ||\r\n          rawMetadata.dpt === departmentCode ||\r\n          metadata.department === departmentCode ||\r\n          rawMetadata.department === departmentCode;\r\n        // Check for legacy role system: lgu-{departmentCode} including lgu-admin-{departmentCode}\r\n        const isLegacyOfficer = /^lgu-(?!hr)/.test(role);\r\n        const roleContainsDepartment = role.includes(`-${departmentCode}`);\r\n        const hasLegacyDepartment =\r\n          metadata.department === departmentCode ||\r\n          rawMetadata.department === departmentCode;\r\n        const _belongsToDepartment =\r\n          (isLguOfficer && hasCorrectDepartment) ||\r\n          (isLegacyOfficer && (roleContainsDepartment || hasLegacyDepartment));\r\n        // console.log removed for security\r\n        // TEMPORARY: Allow any LGU user for testing (excluding HR)\r\n        // TODO: Fix department matching logic\r\n        const isAnyLguUser =\r\n          role === \"lgu\" ||\r\n          role === \"lgu-officer\" ||\r\n          role === \"lgu-admin\" ||\r\n          /^lgu-(?!hr)/.test(role);\r\n\r\n        if (!isAnyLguUser) {\r\n          console.error(\"[LGU_ADMIN] Officer is not an LGU user:\", {\r\n            officerId,\r\n            officerEmail: \"[REDACTED]\",\r\n            role,\r\n            departmentCode,\r\n            metadata: \"[REDACTED]\",\r\n            rawMetadata: \"[REDACTED]\",\r\n          });\r\n          rejectedOfficers.push({\r\n            id: officerId,\r\n            email: \"[REDACTED]\",\r\n            reason: \"Officer is not an LGU user\",\r\n            role,\r\n            departmentCode,\r\n          });\r\n          continue; // Skip this officer but continue with others\r\n        }\r\n        // console.log removed for security\r\n        assignments.push({\r\n          complaint_id: complaintId,\r\n          assigned_to: officerId,\r\n          assigned_by: userId,\r\n          status: \"assigned\",\r\n          priority: priority || \"medium\",\r\n          deadline: deadline || null,\r\n          notes: notes || null,\r\n          assignment_type: assignmentType,\r\n          assignment_group_id: assignmentGroupId,\r\n          officer_order: i + 1,\r\n          updated_at: new Date().toISOString(),\r\n        });\r\n      }\r\n      if (assignments.length === 0) {\r\n        console.error(\r\n          \"[LGU_ADMIN] No valid officers found for assignment. Rejected officers:\",\r\n          rejectedOfficers\r\n        );\r\n        return res.status(400).json({\r\n          success: false,\r\n          error: \"No valid officers found for assignment\",\r\n          details: {\r\n            totalOfficers: officersToAssign.length,\r\n            rejectedOfficers,\r\n            adminDepartment: departmentCode,\r\n          },\r\n        });\r\n      }\r\n      // Log if some officers were rejected\r\n      if (rejectedOfficers.length > 0) {\r\n        console.warn(\r\n          \"[LGU_ADMIN] Some officers were rejected:\",\r\n          rejectedOfficers\r\n        );\r\n        // console.log removed for security\r\n      }\r\n      // Update complaint status\r\n      const { data: updatedComplaint, error: updateError } = await supabase\r\n        .from(\"complaints\")\r\n        .update({\r\n          status: \"assigned to officer\",\r\n          workflow_status: \"in_progress\",\r\n          last_activity_at: new Date().toISOString(),\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", complaintId)\r\n        .select()\r\n        .single();\r\n      if (updateError) {\r\n        console.error(\"[LGU_ADMIN] Error updating complaint:\", updateError);\r\n        return res.status(500).json({\r\n          success: false,\r\n          error: \"Failed to update complaint status\",\r\n        });\r\n      }\r\n      // Create assignment records for all officers\r\n      const { data: createdAssignments, error: assignError } = await supabase\r\n        .from(\"complaint_assignments\")\r\n        .insert(assignments)\r\n        .select();\r\n      if (assignError) {\r\n        console.error(\"[LGU_ADMIN] Error creating assignments:\", assignError);\r\n        return res.status(500).json({\r\n          success: false,\r\n          error: \"Failed to create assignments\",\r\n        });\r\n      }\r\n      // Notify all assigned officers\r\n      const notificationPromises = [];\r\n      for (const assignment of createdAssignments) {\r\n        notificationPromises.push(\r\n          notificationService\r\n            .notifyTaskAssigned(\r\n              assignment.assigned_to,\r\n              complaintId,\r\n              updatedComplaint.title,\r\n              priority === \"urgent\" ? \"urgent\" : \"info\",\r\n              deadline\r\n            )\r\n            .catch((notifError) => {\r\n              console.warn(\r\n                \"[LGU_ADMIN] Failed to notify officer:\",\r\n                notifError.message\r\n              );\r\n            })\r\n        );\r\n      }\r\n      // Notify citizen that their complaint was assigned\r\n      if (complaint.submitted_by) {\r\n        notificationPromises.push(\r\n          notificationService\r\n            .notifyComplaintAssignedToOfficer(\r\n              complaint.submitted_by,\r\n              complaintId,\r\n              complaint.title,\r\n              {\r\n                officer_count: createdAssignments.length,\r\n                department: departmentCode,\r\n              }\r\n            )\r\n            .catch((notifError) => {\r\n              console.warn(\r\n                \"[LGU_ADMIN] Failed to notify citizen:\",\r\n                notifError.message\r\n              );\r\n            })\r\n        );\r\n      }\r\n      // Send confirmation notification to the admin who made the assignment\r\n      notificationPromises.push(\r\n        notificationService\r\n          .createNotification(\r\n            userId,\r\n            NOTIFICATION_TYPES.ASSIGNMENT_COMPLETED,\r\n            \"Assignment Completed\",\r\n            `You successfully assigned \"${updatedComplaint.title}\" to ${createdAssignments.length} officer(s).`,\r\n            {\r\n              priority: NOTIFICATION_PRIORITY.INFO,\r\n              link: `/lgu-admin/assignments`,\r\n              metadata: {\r\n                complaint_id: complaintId,\r\n                assigned_officers: createdAssignments.map((a) => a.assigned_to),\r\n                assignment_group_id: assignmentGroupId,\r\n                total_officers: createdAssignments.length,\r\n              },\r\n            }\r\n          )\r\n          .catch((notifError) => {\r\n            console.warn(\r\n              \"[LGU_ADMIN] Failed to send admin confirmation:\",\r\n              notifError.message\r\n            );\r\n          })\r\n      );\r\n      // Wait for all notifications to be sent (but don't fail if some fail)\r\n      await Promise.allSettled(notificationPromises);\r\n\r\n      res.json({\r\n        success: true,\r\n        message: `Complaint assigned to ${createdAssignments.length} officer(s) successfully`,\r\n        assignments: createdAssignments,\r\n        assignment_group_id: assignmentGroupId,\r\n        assignment_type: assignmentType,\r\n        total_officers: createdAssignments.length,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"[LGU_ADMIN] Assign to officer error:\", error);\r\n      console.error(\"[LGU_ADMIN] Error stack:\", error.stack);\r\n      console.error(\"[LGU_ADMIN] Request details:\", {\r\n        complaintId: req.params?.complaintId,\r\n        officerIds: req.body?.officerIds,\r\n        userId: req.user?.id,\r\n        userRole: req.user?.role,\r\n      });\r\n      res.status(500).json({\r\n        success: false,\r\n        error: \"Failed to assign complaint to officer\",\r\n        details:\r\n          process.env.NODE_ENV === \"development\" ? error.message : undefined,\r\n      });\r\n    }\r\n  }\r\n  /**\r\n   * Get department assignments\r\n   * Returns complaints assigned to the admin's department that need officer assignment\r\n   * OPTIMIZED: Uses server-side pagination on the complaints table\r\n   */\r\n  async getDepartmentAssignments(req, res) {\r\n    try {\r\n      const _userRole = req.user.role;\r\n      const {\r\n        status,\r\n        priority,\r\n        page = 1,\r\n        limit = 10,\r\n        assignment_filter,\r\n        sub_type,\r\n        date_start,\r\n        date_end,\r\n      } = req.query;\r\n\r\n      // Calculate pagination range\r\n      const pageNum = parseInt(page);\r\n      const limitNum = parseInt(limit);\r\n      const from = (pageNum - 1) * limitNum;\r\n      const to = from + limitNum - 1;\r\n\r\n      // Extract department from user metadata\r\n      const departmentCode =\r\n        req.user.department ||\r\n        req.user.metadata?.department ||\r\n        req.user.raw_user_meta_data?.department ||\r\n        req.user.raw_user_meta_data?.dpt;\r\n\r\n      if (!departmentCode) {\r\n        // Fallback for testing environment if needed, otherwise error\r\n        console.error(\"[LGU_ADMIN] No department found in user metadata\");\r\n        return res.status(400).json({\r\n          success: false,\r\n          error: \"Department not specified in user metadata.\",\r\n        });\r\n      }\r\n\r\n      // Get department ID\r\n      const { data: department, error: deptError } = await supabase\r\n        .from(\"departments\")\r\n        .select(\"id, name\")\r\n        .eq(\"code\", departmentCode)\r\n        .single();\r\n\r\n      if (deptError || !department) {\r\n        return res.status(404).json({\r\n          success: false,\r\n          error: \"Department not found\",\r\n        });\r\n      }\r\n\r\n      // ---------------------------------------------------------\r\n      // Step 1: Build the Optimized Complaints Query\r\n      // ---------------------------------------------------------\r\n\r\n      // Start with base query on complaints table\r\n      let baseQuery = supabase\r\n        .from(\"complaints\")\r\n        .select(\r\n          \"id, title, descriptive_su, location_text, submitted_at, submitted_by, department_r, workflow_status, priority, category, subcategory\",\r\n          { count: \"exact\" } // Request exact count for pagination\r\n        )\r\n        .contains(\"department_r\", [departmentCode]);\r\n\r\n      // Apply Filters\r\n\r\n      // 1. Assignment Filter (Unassigned vs Assigned)\r\n      // We map this to workflow_status to allow DB-level filtering\r\n      if (assignment_filter === \"unassigned\") {\r\n        // Unassigned usually means 'new' or 'pending'\r\n        baseQuery = baseQuery.in(\"workflow_status\", [\r\n          \"new\",\r\n          \"pending\",\r\n          \"New\",\r\n          \"Pending\",\r\n          \"NEW\",\r\n          \"PENDING\",\r\n          \"unassigned\",\r\n          \"Unassigned\",\r\n          \"UNASSIGNED\",\r\n        ]);\r\n      } else if (assignment_filter === \"assigned\") {\r\n        // Assigned means someone is working on it\r\n        baseQuery = baseQuery.in(\"workflow_status\", [\r\n          \"assigned\",\r\n          \"in_progress\",\r\n          \"assigned to officer\",\r\n          \"Assigned\",\r\n          \"In Progress\",\r\n          \"In_Progress\",\r\n          \"ASSIGNED\",\r\n          \"IN_PROGRESS\",\r\n        ]);\r\n      }\r\n\r\n      // 2. Status Filter (Specific status)\r\n      if (status && status !== \"all\") {\r\n        if (status === \"completed\") {\r\n          baseQuery = baseQuery.eq(\"workflow_status\", \"completed\");\r\n        } else {\r\n          baseQuery = baseQuery.eq(\"workflow_status\", status);\r\n        }\r\n      } else {\r\n        // Default: If no specific status is requested, exclude completed/cancelled\r\n        // UNLESS assignment_filter is set (since we handled it above)\r\n        if (!assignment_filter || assignment_filter === \"all\") {\r\n          baseQuery = baseQuery\r\n            .neq(\"workflow_status\", \"completed\")\r\n            .neq(\"workflow_status\", \"cancelled\");\r\n        }\r\n      }\r\n\r\n      // 3. Priority Filter\r\n      if (priority && priority !== \"all\") {\r\n        baseQuery = baseQuery.eq(\"priority\", priority);\r\n      }\r\n\r\n      // 4. Subcategory Filter\r\n      if (sub_type && sub_type !== \"all\") {\r\n        // Try checking both fields or prioritise one\r\n        baseQuery = baseQuery.or(\r\n          `category.eq.${sub_type},subcategory.eq.${sub_type}`\r\n        );\r\n      }\r\n\r\n      // 5. Date Range Filter\r\n      if (date_start) {\r\n        // Assuming submitted_at covers the creation time\r\n        baseQuery = baseQuery.gte(\"submitted_at\", `${date_start}T00:00:00`);\r\n      }\r\n      if (date_end) {\r\n        baseQuery = baseQuery.lte(\"submitted_at\", `${date_end}T23:59:59`);\r\n      }\r\n\r\n      // Apply Pagination and Sort\r\n      // Sorting by submitted_at DESC ensures consistent pagination\r\n      baseQuery = baseQuery\r\n        .order(\"submitted_at\", { ascending: false })\r\n        .range(from, to);\r\n\r\n      // Execute Primary Query\r\n      const {\r\n        data: complaints,\r\n        error: complaintsError,\r\n        count,\r\n      } = await baseQuery;\r\n\r\n      if (complaintsError) {\r\n        console.error(\r\n          \"[LGU_ADMIN] Error fetching complaints:\",\r\n          complaintsError\r\n        );\r\n        return res.status(500).json({\r\n          success: false,\r\n          error: \"Failed to fetch complaints\",\r\n        });\r\n      }\r\n\r\n      const totalItems = count || 0;\r\n      const totalPages = Math.ceil(totalItems / limitNum);\r\n      const complaintIds = complaints.map((c) => c.id);\r\n\r\n      // ---------------------------------------------------------\r\n      // Step 2a: Fetch Assignments for these SPECIFIC complaints\r\n      // ---------------------------------------------------------\r\n\r\n      const assignmentsMap = {};\r\n\r\n      if (complaintIds.length > 0) {\r\n        // Fetch assignments only for the displayed complaints\r\n        const { data: assignments, error: assignError } = await supabase\r\n          .from(\"complaint_assignments\")\r\n          .select(\r\n            \"id, complaint_id, assigned_to, assigned_by, status, priority, deadline, notes, created_at, updated_at, department_id, assigned_to_user:assigned_to(first_name, last_name)\"\r\n          )\r\n          .in(\"complaint_id\", complaintIds)\r\n          .order(\"created_at\", { ascending: false });\r\n\r\n        if (!assignError && assignments) {\r\n          assignments.forEach((a) => {\r\n            if (!assignmentsMap[a.complaint_id]) {\r\n              assignmentsMap[a.complaint_id] = [];\r\n            }\r\n            assignmentsMap[a.complaint_id].push(a);\r\n          });\r\n        }\r\n      }\r\n\r\n      // ---------------------------------------------------------\r\n      // Step 2b: Fetch User Profiles (Manual Join)\r\n      // ---------------------------------------------------------\r\n      const userIds = [\r\n        ...new Set(complaints.map((c) => c.submitted_by).filter(Boolean)),\r\n      ];\r\n      const usersMap = {};\r\n\r\n      if (userIds.length > 0) {\r\n        try {\r\n          // Attempt to fetch users using auth admin API\r\n          const { data: authUsers, error: usersError } =\r\n            await supabase.auth.admin.listUsers();\r\n\r\n          if (!usersError && authUsers && authUsers.users) {\r\n            authUsers.users.forEach((u) => {\r\n              if (userIds.includes(u.id)) {\r\n                const metadata = u.user_metadata || {};\r\n                const firstName =\r\n                  metadata.first_name || metadata.name || \"Citizen\";\r\n                const lastName = metadata.last_name || \"\";\r\n                usersMap[u.id] = {\r\n                  name: lastName ? `${firstName} ${lastName}` : firstName,\r\n                  email: u.email,\r\n                };\r\n              }\r\n            });\r\n          }\r\n        } catch (err) {\r\n          console.warn(\r\n            \"[LGU_ADMIN] Failed to fetch user details:\",\r\n            err.message\r\n          );\r\n        }\r\n      }\r\n\r\n      // ---------------------------------------------------------\r\n      // Step 3: Construct Response\r\n      // ---------------------------------------------------------\r\n\r\n      const finalData = complaints.map((complaint) => {\r\n        const allAssignments = assignmentsMap[complaint.id] || [];\r\n        const assignment = allAssignments.find(\r\n          (a) => a.department_id === department.id\r\n        );\r\n        const hasOtherAssignments = allAssignments.some(\r\n          (a) => a.department_id !== department.id\r\n        );\r\n\r\n        const userProfile = usersMap[complaint.submitted_by];\r\n\r\n        // Basic fields from complaint\r\n        const result = {\r\n          id: assignment ? assignment.id : null,\r\n          has_other_assignments: hasOtherAssignments,\r\n          complaint_id: complaint.id, // Internal UUID\r\n\r\n          // Use sliced UUID as Display ID since no readable ID exists\r\n          display_id: complaint.id.slice(0, 8),\r\n\r\n          title: complaint.title,\r\n          description: complaint.descriptive_su, // Mapped from descriptive_su\r\n          location_text: complaint.location_text,\r\n          citizen_name: userProfile\r\n            ? userProfile.name\r\n            : complaint.submitted_by\r\n              ? \"Citizen\"\r\n              : \"Anonymous\",\r\n\r\n          assigned_to: assignment?.assigned_to || null,\r\n          assigned_by: assignment?.assigned_by || null,\r\n          // officer_name logic could be added here if needed using assignment.assigned_to_user\r\n\r\n          status: assignment\r\n            ? assignment.status\r\n            : complaint.workflow_status === \"new\"\r\n              ? \"unassigned\"\r\n              : complaint.workflow_status,\r\n          priority: assignment?.priority || complaint.priority || \"medium\",\r\n\r\n          deadline: assignment?.deadline || null,\r\n          notes: assignment?.notes || null,\r\n\r\n          created_at: assignment?.created_at || complaint.submitted_at,\r\n          updated_at:\r\n            assignment?.updated_at ||\r\n            complaint.updated_at ||\r\n            complaint.submitted_at,\r\n\r\n          submitted_at: complaint.submitted_at,\r\n\r\n          // Raw complaint object for fallback\r\n          complaints: complaint,\r\n          complaint_type: complaint.category,\r\n          subcategory: complaint.subcategory,\r\n        };\r\n\r\n        return result;\r\n      });\r\n\r\n      // Calculate Stats (efficiently)\r\n      const [unassignedCount, urgentCount, highCount, uniqueTypesData] =\r\n        await Promise.all([\r\n          // Count Unassigned (approximated by workflow_status for speed)\r\n          supabase\r\n            .from(\"complaints\")\r\n            .select(\"id\", { count: \"exact\", head: true })\r\n            .contains(\"department_r\", [departmentCode])\r\n            .in(\"workflow_status\", [\r\n              \"new\",\r\n              \"pending\",\r\n              \"New\",\r\n              \"Pending\",\r\n              \"NEW\",\r\n              \"PENDING\",\r\n              \"unassigned\",\r\n              \"Unassigned\",\r\n              \"UNASSIGNED\",\r\n            ])\r\n            .then((res) => res.count || 0),\r\n\r\n          // Count Urgent\r\n          supabase\r\n            .from(\"complaints\")\r\n            .select(\"id\", { count: \"exact\", head: true })\r\n            .contains(\"department_r\", [departmentCode])\r\n            .in(\"priority\", [\"urgent\", \"Urgent\", \"URGENT\"])\r\n            .neq(\"workflow_status\", \"completed\")\r\n            .neq(\"workflow_status\", \"Completed\")\r\n            .neq(\"workflow_status\", \"COMPLETED\")\r\n            .then((res) => res.count || 0),\r\n\r\n          // Count High\r\n          supabase\r\n            .from(\"complaints\")\r\n            .select(\"id\", { count: \"exact\", head: true })\r\n            .contains(\"department_r\", [departmentCode])\r\n            .in(\"priority\", [\"high\", \"High\", \"HIGH\"])\r\n            .neq(\"workflow_status\", \"completed\")\r\n            .neq(\"workflow_status\", \"Completed\")\r\n            .neq(\"workflow_status\", \"COMPLETED\")\r\n            .then((res) => res.count || 0),\r\n\r\n          // Fetch Dictionary of Types (Scan all)\r\n          supabase\r\n            .from(\"complaints\")\r\n            .select(\"category, subcategory\")\r\n            .contains(\"department_r\", [departmentCode])\r\n            .then((res) => res.data || []),\r\n        ]);\r\n\r\n      // Process unique types\r\n      const typeSet = new Set();\r\n      if (uniqueTypesData) {\r\n        uniqueTypesData.forEach((item) => {\r\n          if (item.category) typeSet.add(item.category);\r\n          if (item.subcategory) typeSet.add(item.subcategory);\r\n        });\r\n      }\r\n      const uniqueSubcategories = Array.from(typeSet).sort();\r\n\r\n      res.json({\r\n        success: true,\r\n        data: finalData,\r\n        pagination: {\r\n          page: pageNum,\r\n          limit: limitNum,\r\n          total: totalItems,\r\n          pages: totalPages,\r\n        },\r\n        unique_subcategories: uniqueSubcategories,\r\n        stats: {\r\n          unassigned: unassignedCount,\r\n          urgent: urgentCount,\r\n          high: highCount,\r\n        },\r\n      });\r\n    } catch (error) {\r\n      console.error(\r\n        \"[LGU_ADMIN] Get department assignments error with pagination:\",\r\n        error\r\n      );\r\n      res.status(500).json({\r\n        success: false,\r\n        error: \"Failed to fetch assignments\",\r\n        details: error.message,\r\n      });\r\n    }\r\n  }\r\n  /**\r\n   * Get department officers\r\n   * Returns list of LGU officers in the admin's department\r\n   */\r\n  async getDepartmentOfficers(req, res) {\r\n    try {\r\n      const userRole = req.user.role;\r\n\r\n      // Extract department from user metadata (check multiple possible field names)\r\n      const departmentCode =\r\n        req.user.department ||\r\n        req.user.metadata?.department ||\r\n        req.user.raw_user_meta_data?.department ||\r\n        req.user.raw_user_meta_data?.dpt;\r\n\r\n      if (!departmentCode) {\r\n        console.error(\"[LGU_ADMIN] No department found in user metadata:\", {\r\n          userRole,\r\n          metadata: req.user.metadata,\r\n          rawMetadata: req.user.raw_user_meta_data,\r\n        });\r\n        return res.status(400).json({\r\n          success: false,\r\n          error:\r\n            \"Department not specified in user metadata. Please contact administrator to set your department.\",\r\n          details: {\r\n            userRole,\r\n            hasMetadata: Boolean(req.user.metadata),\r\n            hasRawMetadata: Boolean(req.user.raw_user_meta_data),\r\n            metadataKeys: Object.keys(req.user.metadata || {}),\r\n            rawMetadataKeys: Object.keys(req.user.raw_user_meta_data || {}),\r\n          },\r\n        });\r\n      }\r\n      // Get the department ID\r\n      const { data: department, error: deptError } = await supabase\r\n        .from(\"departments\")\r\n        .select(\"id\")\r\n        .eq(\"code\", departmentCode)\r\n        .single();\r\n      if (deptError || !department) {\r\n        console.error(\"[LGU_ADMIN] Department not found:\", {\r\n          departmentCode,\r\n          error: deptError,\r\n        });\r\n        return res.status(404).json({\r\n          success: false,\r\n          error: \"Department not found\",\r\n        });\r\n      }\r\n      // Get all users and filter for LGU officers in this department\r\n      // Use admin auth API to get users instead of direct table query\r\n      let users = [];\r\n      try {\r\n        const { data: authUsers, error: authError } =\r\n          await supabase.auth.admin.listUsers();\r\n        if (authError) {\r\n          console.error(\"[LGU_ADMIN] Error fetching auth users:\", authError);\r\n          return res.status(500).json({\r\n            success: false,\r\n            error: \"Failed to fetch users\",\r\n            details: authError.message,\r\n          });\r\n        }\r\n        users = authUsers.users || [];\r\n        // console.log removed for security\r\n      } catch (authErr) {\r\n        console.error(\"[LGU_ADMIN] Auth API error:\", authErr);\r\n        return res.status(500).json({\r\n          success: false,\r\n          error: \"Failed to fetch users via auth API\",\r\n          details: authErr.message,\r\n        });\r\n      }\r\n      // console.log removed for security\r\n      // console.log removed for security\r\n      const officers = users\r\n        .filter((user) => {\r\n          const metadata = user.user_metadata || {};\r\n          const rawMetadata = user.raw_user_meta_data || {};\r\n          const role = metadata.role || rawMetadata.role || \"\";\r\n          // Debug logging for each user\r\n          // console.log removed for security\r\n          // Check for simplified role system: lgu with department in metadata, or lgu-admin\r\n          const isLguOfficer =\r\n            role === \"lgu\" || role === \"lgu-officer\" || role === \"lgu-admin\";\r\n          const hasCorrectDepartment =\r\n            metadata.dpt === departmentCode ||\r\n            rawMetadata.dpt === departmentCode ||\r\n            metadata.department === departmentCode ||\r\n            rawMetadata.department === departmentCode;\r\n          // Check for legacy role system: lgu-{departmentCode} including lgu-admin-{departmentCode}\r\n          const isLegacyOfficer = /^lgu-(?!hr)/.test(role);\r\n          const roleContainsDepartment = role.includes(`-${departmentCode}`);\r\n          const hasLegacyDepartment =\r\n            metadata.department === departmentCode ||\r\n            rawMetadata.department === departmentCode;\r\n          const isMatch =\r\n            (isLguOfficer && hasCorrectDepartment) ||\r\n            (isLegacyOfficer &&\r\n              (roleContainsDepartment || hasLegacyDepartment));\r\n          // TEMPORARY: Allow any LGU user for testing (excluding HR)\r\n          const isAnyLguUser =\r\n            role === \"lgu\" ||\r\n            role === \"lgu-officer\" ||\r\n            role === \"lgu-admin\" ||\r\n            /^lgu-(?!hr)/.test(role);\r\n          const finalMatch = isMatch || isAnyLguUser;\r\n          if (finalMatch) {\r\n            // console.log removed for security\r\n          }\r\n          return finalMatch;\r\n        })\r\n        .map((user) => ({\r\n          id: user.id,\r\n          name:\r\n            user.user_metadata?.name ||\r\n            user.raw_user_meta_data?.name ||\r\n            user.email,\r\n          email: user.email,\r\n          employee_id:\r\n            user.user_metadata?.employee_id ||\r\n            user.raw_user_meta_data?.employee_id,\r\n          mobile: user.user_metadata?.mobile || user.raw_user_meta_data?.mobile,\r\n        }));\r\n      // console.log removed for security\r\n      return res.json({\r\n        success: true,\r\n        data: officers,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"[LGU_ADMIN] Get officers error:\", error);\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: error.message || \"Failed to get department officers\",\r\n      });\r\n    }\r\n  }\r\n  /**\r\n   * Assign complaint to officer\r\n   */\r\n  async assignComplaint(req, res) {\r\n    try {\r\n      const userId = req.user.id;\r\n      const userRole = req.user.role;\r\n      const { complaintId, officerId, priority, deadline, notes } = req.body;\r\n      if (!complaintId || !officerId) {\r\n        return res.status(400).json({\r\n          success: false,\r\n          error: \"Complaint ID and Officer ID are required\",\r\n        });\r\n      }\r\n      // Extract department from user metadata (check multiple possible field names)\r\n      const departmentCode =\r\n        req.user.department ||\r\n        req.user.metadata?.department ||\r\n        req.user.raw_user_meta_data?.department ||\r\n        req.user.raw_user_meta_data?.dpt;\r\n      if (!departmentCode) {\r\n        console.error(\"[LGU_ADMIN] No department found in user metadata:\", {\r\n          userRole,\r\n          metadata: req.user.metadata,\r\n          rawMetadata: req.user.raw_user_meta_data,\r\n        });\r\n        return res.status(400).json({\r\n          success: false,\r\n          error:\r\n            \"Department not specified in user metadata. Please contact administrator to set your department.\",\r\n          details: {\r\n            userRole,\r\n            hasMetadata: Boolean(req.user.metadata),\r\n            hasRawMetadata: Boolean(req.user.raw_user_meta_data),\r\n            metadataKeys: Object.keys(req.user.metadata || {}),\r\n            rawMetadataKeys: Object.keys(req.user.raw_user_meta_data || {}),\r\n          },\r\n        });\r\n      }\r\n      // Get the department ID\r\n      const { data: department, error: deptError } = await supabase\r\n        .from(\"departments\")\r\n        .select(\"id\")\r\n        .eq(\"code\", departmentCode)\r\n        .single();\r\n      if (deptError || !department) {\r\n        return res.status(404).json({\r\n          success: false,\r\n          error: \"Department not found\",\r\n        });\r\n      }\r\n      // Check if assignment already exists\r\n      const { data: existingAssignment } = await supabase\r\n        .from(\"complaint_assignments\")\r\n        .select(\"id\")\r\n        .eq(\"complaint_id\", complaintId)\r\n        .maybeSingle(); // Don't error if not found\r\n\r\n      let assignment;\r\n\r\n      if (existingAssignment) {\r\n        // Update existing assignment\r\n        const { data: updatedAssignment, error: updateError } = await supabase\r\n          .from(\"complaint_assignments\")\r\n          .update({\r\n            assigned_to: officerId,\r\n            assigned_by: userId,\r\n            department_id: department.id, // Ensure department_id is set on update too\r\n            priority: priority || \"medium\",\r\n            deadline: deadline || null,\r\n            notes: notes || null,\r\n            status: \"assigned\", // Changed from 'active' to 'assigned' to match table schema\r\n            updated_at: new Date().toISOString(),\r\n          })\r\n          .eq(\"id\", existingAssignment.id)\r\n          .select()\r\n          .single();\r\n        if (updateError) {\r\n          console.error(\"[LGU_ADMIN] Error updating assignment:\", updateError);\r\n          return res.status(500).json({\r\n            success: false,\r\n            error: \"Failed to update assignment\",\r\n          });\r\n        }\r\n        assignment = updatedAssignment;\r\n      } else {\r\n        // Create new assignment\r\n        const { data: newAssignment, error: insertError } = await supabase\r\n          .from(\"complaint_assignments\")\r\n          .insert({\r\n            complaint_id: complaintId,\r\n            assigned_to: officerId,\r\n            assigned_by: userId,\r\n            department_id: department.id, // Set department ID (bigint) for proper data tracking - matches departments.id type\r\n            priority: priority || \"medium\",\r\n            deadline: deadline || null,\r\n            notes: notes || null,\r\n            status: \"assigned\", // Changed from 'active' to 'assigned' to match table schema\r\n          })\r\n          .select()\r\n          .single();\r\n        if (insertError) {\r\n          console.error(\"[LGU_ADMIN] Error creating assignment:\", insertError);\r\n          return res.status(500).json({\r\n            success: false,\r\n            error: \"Failed to create assignment\",\r\n          });\r\n        }\r\n        assignment = newAssignment;\r\n      }\r\n      // Get complaint details\r\n      const { data: complaint } = await supabase\r\n        .from(\"complaints\")\r\n        .select(\"title, descriptive_su, id\")\r\n        .eq(\"id\", complaintId)\r\n        .single();\r\n      // Send notification to the officer\r\n      // Map complaint priority to notification priority\r\n      const notificationPriority =\r\n        priority === \"urgent\"\r\n          ? \"urgent\"\r\n          : priority === \"high\"\r\n            ? \"warning\"\r\n            : \"info\";\r\n      await notificationService.notifyTaskAssigned(\r\n        officerId,\r\n        complaintId,\r\n        complaint?.title || \"a complaint\",\r\n        notificationPriority,\r\n        deadline\r\n      );\r\n      // Notify citizen that their complaint was assigned\r\n      if (complaint?.submitted_by) {\r\n        await notificationService\r\n          .notifyComplaintAssignedToOfficer(\r\n            complaint.submitted_by,\r\n            complaintId,\r\n            complaint.title,\r\n            { officer_count: 1, department: departmentCode }\r\n          )\r\n          .catch((notifError) => {\r\n            console.warn(\r\n              \"[LGU_ADMIN] Failed to notify citizen:\",\r\n              notifError.message\r\n            );\r\n          });\r\n      }\r\n      // Send confirmation notification to the admin who made the assignment\r\n      await notificationService.createNotification(\r\n        userId,\r\n        NOTIFICATION_TYPES.ASSIGNMENT_COMPLETED,\r\n        \"Assignment Completed\",\r\n        `You successfully assigned \"${\r\n          complaint?.title || \"a complaint\"\r\n        }\" to an officer.`,\r\n        {\r\n          priority: NOTIFICATION_PRIORITY.INFO,\r\n          link: `/lgu-admin/assignments`,\r\n          metadata: {\r\n            complaint_id: complaintId,\r\n            assigned_officer_id: officerId,\r\n            assignment_id: assignment.id,\r\n          },\r\n        }\r\n      );\r\n      return res.json({\r\n        success: true,\r\n        data: assignment,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"[LGU_ADMIN] Assign complaint error:\", error);\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: error.message || \"Failed to assign complaint\",\r\n      });\r\n    }\r\n  }\r\n  /**\r\n   * Send reminder to officer\r\n   */\r\n  async sendOfficerReminder(req, res) {\r\n    try {\r\n      const adminId = req.user.id;\r\n      const { officerId, complaintId, reminderType, customMessage } = req.body;\r\n      if (!officerId || !complaintId || !reminderType) {\r\n        return res.status(400).json({\r\n          success: false,\r\n          error: \"Officer ID, complaint ID, and reminder type are required\",\r\n        });\r\n      }\r\n      // Use CoordinatorService to send the reminder\r\n      const CoordinatorService = require(\"../services/CoordinatorService\");\r\n\r\n      const coordinatorService = new CoordinatorService();\r\n      const result = await coordinatorService.sendOfficerReminder(\r\n        adminId,\r\n        officerId,\r\n        complaintId,\r\n        reminderType,\r\n        customMessage\r\n      );\r\n      res.json(result);\r\n    } catch (error) {\r\n      console.error(\"[LGU_ADMIN] Send officer reminder error:\", error);\r\n      res.status(500).json({\r\n        success: false,\r\n        error: error.message || \"Failed to send reminder\",\r\n      });\r\n    }\r\n  }\r\n  /**\r\n   * Get pending assignments summary\r\n   */\r\n  async getPendingAssignmentsSummary(req, res) {\r\n    try {\r\n      // Use CoordinatorService to get summary\r\n      const CoordinatorService = require(\"../services/CoordinatorService\");\r\n\r\n      const coordinatorService = new CoordinatorService();\r\n      const result = await coordinatorService.getPendingAssignmentsSummary();\r\n      res.json({\r\n        success: true,\r\n        data: result.data,\r\n      });\r\n    } catch (error) {\r\n      console.error(\r\n        \"[LGU_ADMIN] Get pending assignments summary error:\",\r\n        error\r\n      );\r\n      res.status(500).json({\r\n        success: false,\r\n        error: error.message || \"Failed to get pending assignments summary\",\r\n      });\r\n    }\r\n  }\r\n  /**\r\n   * Get officers needing attention\r\n   */\r\n  async getOfficersNeedingAttention(req, res) {\r\n    try {\r\n      const { data: assignments, error } = await supabase\r\n        .from(\"complaint_assignments\")\r\n        .select(\r\n          `\r\n          *,\r\n          complaints!inner(id, title, workflow_status, submitted_at, priority),\r\n          departments(id, code, name)\r\n        `\r\n        )\r\n        .eq(\"status\", \"pending\")\r\n        .order(\"created_at\", { ascending: false });\r\n      if (error) throw error;\r\n      // Group by officer and identify overdue items\r\n      const officerGroups = {};\r\n      const officersNeedingAttention = [];\r\n      for (const assignment of assignments) {\r\n        const officerId = assignment.assigned_to;\r\n        if (!officerId) continue;\r\n        if (!officerGroups[officerId]) {\r\n          officerGroups[officerId] = {\r\n            officer_id: officerId,\r\n            assignments_count: 0,\r\n            overdue_count: 0,\r\n            complaints: [],\r\n          };\r\n        }\r\n        officerGroups[officerId].assignments_count++;\r\n        // Check if overdue (7+ days)\r\n        const daysSinceAssignment = Math.floor(\r\n          (Date.now() - new Date(assignment.created_at).getTime()) /\r\n            (1000 * 60 * 60 * 24)\r\n        );\r\n        if (daysSinceAssignment > 7) {\r\n          officerGroups[officerId].overdue_count++;\r\n        }\r\n        officerGroups[officerId].complaints.push({\r\n          id: assignment.complaints.id,\r\n          title: assignment.complaints.title,\r\n          priority: assignment.complaints.priority,\r\n          assigned_days_ago: daysSinceAssignment,\r\n          is_overdue: daysSinceAssignment > 7,\r\n        });\r\n      }\r\n      // Filter officers who need attention (have overdue items or many pending items)\r\n      for (const officerId in officerGroups) {\r\n        const officer = officerGroups[officerId];\r\n        if (officer.overdue_count > 0 || officer.assignments_count > 3) {\r\n          // Get officer details using admin auth API\r\n          try {\r\n            const { data: authUsers, error: authError } =\r\n              await supabase.auth.admin.listUsers();\r\n            if (authError) {\r\n              console.error(\r\n                \"[LGU_ADMIN] Error fetching auth users for officer details:\",\r\n                authError\r\n              );\r\n              continue;\r\n            }\r\n            const officerData = authUsers?.users?.find(\r\n              (u) => u.id === officerId\r\n            );\r\n            if (officerData) {\r\n              officersNeedingAttention.push({\r\n                ...officer,\r\n                name:\r\n                  officerData.user_metadata?.name ||\r\n                  officerData.raw_user_meta_data?.name ||\r\n                  officerData.email ||\r\n                  \"Unknown Officer\",\r\n                email: officerData.email,\r\n              });\r\n            }\r\n          } catch (authErr) {\r\n            console.error(\r\n              \"[LGU_ADMIN] Auth API error for officer details:\",\r\n              authErr\r\n            );\r\n            // Continue without officer details\r\n            officersNeedingAttention.push({\r\n              ...officer,\r\n              name: \"Unknown Officer\",\r\n              email: \"N/A\",\r\n            });\r\n          }\r\n        }\r\n      }\r\n      res.json({\r\n        success: true,\r\n        data: {\r\n          total_officers_needing_attention: officersNeedingAttention.length,\r\n          officers: officersNeedingAttention,\r\n        },\r\n      });\r\n    } catch (error) {\r\n      console.error(\"[LGU_ADMIN] Get officers needing attention error:\", error);\r\n      res.status(500).json({\r\n        success: false,\r\n        error: error.message || \"Failed to get officers needing attention\",\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = LguAdminController;\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\LguOfficerController.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\NotificationController.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\OAuthController.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\OCRController.js","messages":[{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":552,"column":55,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":552,"endColumn":64}],"suppressedMessages":[{"ruleId":"security/detect-non-literal-regexp","severity":2,"message":"Found non-literal argument to RegExp Constructor","line":176,"column":28,"nodeType":"NewExpression","endLine":182,"endColumn":10,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found existsSync from package \"node:fs\" with non literal argument at index 0","line":735,"column":15,"nodeType":"CallExpression","endLine":735,"endColumn":31,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found unlink from package \"node:fs\" with non literal argument at index 0","line":737,"column":19,"nodeType":"CallExpression","endLine":737,"endColumn":39,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found existsSync from package \"node:fs\" with non literal argument at index 0","line":761,"column":34,"nodeType":"CallExpression","endLine":761,"endColumn":58,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found unlink from package \"node:fs\" with non literal argument at index 0","line":763,"column":17,"nodeType":"CallExpression","endLine":763,"endColumn":45,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found existsSync from package \"node:fs\" with non literal argument at index 0","line":780,"column":15,"nodeType":"CallExpression","endLine":780,"endColumn":31,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found unlink from package \"node:fs\" with non literal argument at index 0","line":782,"column":19,"nodeType":"CallExpression","endLine":782,"endColumn":39,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found existsSync from package \"node:fs\" with non literal argument at index 0","line":787,"column":42,"nodeType":"CallExpression","endLine":787,"endColumn":70,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found unlink from package \"node:fs\" with non literal argument at index 0","line":789,"column":17,"nodeType":"CallExpression","endLine":789,"endColumn":49,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found unlink from package \"node:fs\" with non literal argument at index 0","line":860,"column":11,"nodeType":"CallExpression","endLine":860,"endColumn":39,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found unlink from package \"node:fs\" with non literal argument at index 0","line":864,"column":11,"nodeType":"CallExpression","endLine":864,"endColumn":31,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿const path = require(\"node:path\");\r\nconst fs = require(\"node:fs\");\r\nconst fsPromises = fs.promises;\r\nconst { spawn } = require(\"node:child_process\");\r\n\r\n// Try to load Sharp, but make it optional\r\nlet sharp;\r\ntry {\r\n  sharp = require(\"sharp\");\r\n} catch (err) {\r\n  console.warn(\"[OCR] Sharp not available, will skip image preprocessing\");\r\n}\r\n\r\nclass OCRController {\r\n  constructor() {\r\n    // Python script path\r\n    this.pythonScriptPath = path.join(__dirname, \"../services/ocr_service.py\");\r\n  }\r\n\r\n  /**\r\n   * Detect ID type from extracted text\r\n   */\r\n  detectIdType(text) {\r\n    const normalized = text.toUpperCase();\r\n\r\n    if (\r\n      normalized.includes(\"PHILIPPINE POSTAL CORPORATION\") ||\r\n      normalized.includes(\"POSTAL IDENTITY CARD\") ||\r\n      normalized.includes(\"PHLPOST\") ||\r\n      normalized.includes(\"POSTAL ID\")\r\n    ) {\r\n      return \"philpost\";\r\n    }\r\n\r\n    if (\r\n      normalized.includes(\"PAMBANSANG PAGKAKAKILANLAN\") ||\r\n      normalized.includes(\"PHILIPPINE IDENTIFICATION CARD\") ||\r\n      (normalized.includes(\"REPUBLIKA NG PILIPINAS\") &&\r\n        normalized.includes(\"PAGKAKAKILANLAN\"))\r\n    ) {\r\n      return \"philid\";\r\n    }\r\n\r\n    if (\r\n      normalized.includes(\"DRIVER'S LICENSE\") ||\r\n      normalized.includes(\"DRIVERS LICENSE\") ||\r\n      normalized.includes(\"LAND TRANSPORTATION OFFICE\") ||\r\n      normalized.includes(\"LTO\") ||\r\n      normalized.includes(\"NON-PROFESSIONAL\") ||\r\n      normalized.includes(\"PROFESSIONAL\")\r\n    ) {\r\n      return \"drivers_license\";\r\n    }\r\n\r\n    return \"unknown\";\r\n  }\r\n\r\n  /**\r\n   * Parse extracted text to find relevant ID fields based on ID type\r\n   */\r\n  parseIdFields(text, idType = \"unknown\") {\r\n    // Auto-detect if not provided\r\n    if (idType === \"unknown\") {\r\n      idType = this.detectIdType(text);\r\n    }\r\n\r\n    // Use format-specific parsers\r\n    switch (idType) {\r\n      case \"philid\":\r\n        return this.parsePhilId(text);\r\n      case \"philpost\":\r\n        return this.parsePhilPost(text);\r\n      case \"drivers_license\":\r\n        return this.parseDriversLicense(text);\r\n    }\r\n\r\n    return {};\r\n  }\r\n\r\n  /**\r\n   * Helper: Calculate Levenshtein distance between two strings\r\n   */\r\n  levenshteinDistance(a, b) {\r\n    if (a.length === 0) return b.length;\r\n    if (b.length === 0) return a.length;\r\n\r\n    const matrix = [];\r\n    for (let i = 0; i <= b.length; i++) matrix[i] = [i];\r\n    for (let j = 0; j <= a.length; j++) matrix[0][j] = j;\r\n\r\n    for (let i = 1; i <= b.length; i++) {\r\n      for (let j = 1; j <= a.length; j++) {\r\n        if (b.charAt(i - 1) === a.charAt(j - 1)) {\r\n          matrix[i][j] = matrix[i - 1][j - 1];\r\n        } else {\r\n          matrix[i][j] = Math.min(\r\n            matrix[i - 1][j - 1] + 1,\r\n            Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1)\r\n          );\r\n        }\r\n      }\r\n    }\r\n    return matrix[b.length][a.length];\r\n  }\r\n\r\n  /**\r\n   * Helper: Extract and clean value from line(s)\r\n   */\r\n  extractAndCleanValue(line, startIndex, lineIndex, lines) {\r\n    let value = line\r\n      .substring(startIndex)\r\n      .replace(/[:.\\\\/]/g, \"\")\r\n      .trim();\r\n\r\n    // Check if value looks like another label\r\n    const labelKeywords = [\r\n      \"LAST\",\r\n      \"NAME\",\r\n      \"FIRST\",\r\n      \"GIVEN\",\r\n      \"MIDDLE\",\r\n      \"NAMES\",\r\n      \"PANGALAN\",\r\n      \"APILYEDO\",\r\n      \"APELYIDO\",\r\n      \"GITNANG\",\r\n      \"TIRAHAN\",\r\n      \"ADDRESS\",\r\n      \"NRAHAN\",\r\n    ];\r\n\r\n    // Explicitly remove any label appearing at the START of the value (e.g. \"Address 123 Main St\" -> \"123 Main St\")\r\n    // This happens if the startIndex wasn't perfectly after the label\r\n    for (const kw of labelKeywords) {\r\n      if (value.toUpperCase().startsWith(kw)) {\r\n        value = value\r\n          .substring(kw.length)\r\n          .replace(/[:.\\\\/]/g, \"\")\r\n          .trim();\r\n      }\r\n    }\r\n\r\n    const valueWords = value.toUpperCase().split(/\\s+/);\r\n    // Strict check: if the value is ONLY a label keyword (or very short + keyword), reject it\r\n    const isJustLabel = valueWords.every(\r\n      (w) => labelKeywords.includes(w) || w.length < 2\r\n    );\r\n\r\n    // Use next line if value is empty or looks like a label\r\n    if ((value.length < 3 || isJustLabel) && lineIndex + 1 < lines.length) {\r\n      value = lines[lineIndex + 1].trim();\r\n    }\r\n\r\n    // Clean value\r\n    const cleaned = value.replace(/[^A-Z0-9\\s.,-]/gi, \"\").trim();\r\n    return cleaned;\r\n  }\r\n\r\n  // Helper: Escape regex characters\r\n  escapeRegExp(string) {\r\n    return string.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\r\n  }\r\n\r\n  /**\r\n   * Helper: Find field value by looking for a label (Exact + Fuzzy)\r\n   */\r\n  findFieldByLabel(lines, labels, valuePattern = null) {\r\n    // 1. First pass: Exact Regex Matches\r\n    for (let i = 0; i < lines.length; i++) {\r\n      const line = lines[i].trim();\r\n\r\n      for (const label of labels) {\r\n        const labelUpper = label.toUpperCase();\r\n        // Check if label appears in line with word boundaries\r\n        // eslint-disable-next-line\r\n        const labelRegex = new RegExp(\r\n          `(^|[^A-Z])${this.escapeRegExp(labelUpper).replace(\r\n            /\\s+/g,\r\n            \"\\\\s+\"\r\n          )}($|[^A-Z])`,\r\n          \"i\"\r\n        );\r\n\r\n        if (labelRegex.test(line)) {\r\n          const match = line.match(labelRegex);\r\n          const labelEndIndex =\r\n            match.index + match[0].length - (match[2] ? 1 : 0);\r\n\r\n          const cleaned = this.extractAndCleanValue(\r\n            line,\r\n            labelEndIndex,\r\n            i,\r\n            lines\r\n          );\r\n          if (valuePattern && !valuePattern.test(cleaned.toUpperCase()))\r\n            continue;\r\n          return cleaned;\r\n        }\r\n      }\r\n    }\r\n\r\n    // 2. Second pass: Fuzzy Matching\r\n    for (let i = 0; i < lines.length; i++) {\r\n      const line = lines[i].trim();\r\n      // Split line into words to check against labels\r\n      const words = line.split(/[\\s:.,]+/);\r\n\r\n      for (const label of labels) {\r\n        const labelUpper = label.toUpperCase();\r\n\r\n        for (const word of words) {\r\n          if (word.length < 3) continue;\r\n          if (Math.abs(word.length - label.length) > 2) continue; // Optimization\r\n\r\n          const dist = this.levenshteinDistance(word.toUpperCase(), labelUpper);\r\n          // Allow 1 edit for short labels, 2 for longer\r\n          const threshold = label.length > 5 ? 2 : 1;\r\n\r\n          if (dist <= threshold) {\r\n            // Found a fuzzy match\r\n            const matchIndex = line.indexOf(word);\r\n            if (matchIndex !== -1) {\r\n              const labelEndIndex = matchIndex + word.length;\r\n              const cleaned = this.extractAndCleanValue(\r\n                line,\r\n                labelEndIndex,\r\n                i,\r\n                lines\r\n              );\r\n              if (valuePattern && !valuePattern.test(cleaned.toUpperCase()))\r\n                continue;\r\n              console.log(\r\n                `[OCR] Fuzzy match found for '${label}': '${word}' (Dist: ${dist}) -> ${cleaned}`\r\n              );\r\n              return cleaned;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Helper: Clean and validate name fields\r\n   */\r\n  cleanAndValidateName(value) {\r\n    if (!value) return null;\r\n\r\n    const EXCLUDED_WORDS = [\r\n      \"REPUBLIKA\",\r\n      \"PILIPINAS\",\r\n      \"PHILIPPINES\",\r\n      \"PAGKAKAKILANLAN\",\r\n      \"LAST\",\r\n      \"NAME\",\r\n      \"GIVEN\",\r\n      \"APILYEDO\",\r\n      \"MGA\",\r\n      \"PANGALAN\",\r\n      \"GITNANG\",\r\n      \"MIDDLE\",\r\n      \"SEX\",\r\n      \"DATE\",\r\n      \"BIRTH\",\r\n      \"ADDRESS\",\r\n      \"TIRAHAN\",\r\n      \"LALAKI\",\r\n      \"BABAE\",\r\n      \"MALE\",\r\n      \"FEMALE\",\r\n      \"HALALAN\",\r\n      \"KOMISYON\",\r\n      \"PHILSYS\",\r\n      \"CARD\",\r\n      \"NUMBER\",\r\n      \"ID\",\r\n      \"ISSUE\",\r\n      \"ISSUING\",\r\n      \"AUTHORITY\",\r\n      \"NAMAS\",\r\n      \"IZ\",\r\n      \"PUBLIKA\",\r\n      \"PILIPINA\",\r\n      \"OO\",\r\n      \"00\",\r\n      \"REPUBLIC\",\r\n      \"PHILIPPINE\",\r\n      \"EPUBLIKA\",\r\n    ];\r\n\r\n    if (/\\d/.test(value)) return null;\r\n\r\n    let cleaned = value\r\n      .toUpperCase()\r\n      .replace(/[^A-Z\\s.-]/g, \" \")\r\n      .trim();\r\n    cleaned = cleaned.replace(/\\s+/g, \" \");\r\n\r\n    const letterCount = (cleaned.match(/[A-Z]/g) || []).length;\r\n    if (letterCount < 2) return null;\r\n\r\n    const words = cleaned.split(\" \");\r\n    const isExcluded = words.some((word) => {\r\n      return EXCLUDED_WORDS.some((excluded) => {\r\n        if (word === excluded) return true;\r\n        if (excluded.length > 4) {\r\n          return this.levenshteinDistance(word, excluded) <= 2;\r\n        }\r\n        return false;\r\n      });\r\n    });\r\n\r\n    if (isExcluded) return null;\r\n    if (/REPUBLIKA|PILIPINAS|PHILIPPINES|PHILSYS|PUBLIKA/i.test(cleaned))\r\n      return null;\r\n\r\n    return cleaned;\r\n  }\r\n\r\n  /**\r\n   * Parse Philippine National ID (PhilID)\r\n   */\r\n  parsePhilId(text) {\r\n    const fields = {\r\n      lastName: null,\r\n      firstName: null,\r\n      middleName: null,\r\n      birthDate: null,\r\n      sex: null,\r\n      address: null,\r\n      idNumber: null,\r\n    };\r\n\r\n    const lines = text\r\n      .split(\"\\n\")\r\n      .map((l) => l.trim())\r\n      .filter((l) => l.length > 0);\r\n\r\n    const idMatch = text.match(/(\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4})/);\r\n    if (idMatch) fields.idNumber = idMatch[1].replace(/[\\s-]/g, \"\");\r\n\r\n    fields.lastName = this.findFieldByLabel(\r\n      lines,\r\n      [\"Apelyido\", \"Apilyedo\", \"Apalyida\", \"Apalyido\", \"Last Name\"],\r\n      /^[A-Z\\s.-]+$/\r\n    );\r\n    fields.firstName = this.findFieldByLabel(\r\n      lines,\r\n      [\"Mga Pangalan\", \"Given Names\", \"Pangalan\"],\r\n      /^[A-Z\\s.-]+$/\r\n    );\r\n    fields.middleName = this.findFieldByLabel(\r\n      lines,\r\n      [\"Gitnang Apelyido\", \"Gitnang Apilyedo\", \"witnang\", \"Middle Name\"],\r\n      /^[A-Z\\s.-]+$/\r\n    );\r\n    fields.address = this.findFieldByLabel(\r\n      lines,\r\n      [\"Tirahan\", \"Address\", \"Nrahan\"],\r\n      null\r\n    );\r\n\r\n    fields.lastName = this.cleanAndValidateName(fields.lastName);\r\n    fields.firstName = this.cleanAndValidateName(fields.firstName);\r\n    fields.middleName = this.cleanAndValidateName(fields.middleName);\r\n\r\n    const dateMatch = text.match(/([A-Z][a-z]+\\s+\\d{1,2},?\\s+\\d{4})/i);\r\n    if (dateMatch) {\r\n      fields.birthDate = this.parseDateString(dateMatch[0]);\r\n    } else {\r\n      const dobRaw = this.findFieldByLabel(lines, [\r\n        \"Petsa ng Kapanganakan\",\r\n        \"Date of Birth\",\r\n        \"falsa ng\",\r\n      ]);\r\n      if (dobRaw) fields.birthDate = this.parseDateString(dobRaw);\r\n    }\r\n\r\n    let nameLines = [];\r\n    if (!fields.lastName || !fields.firstName) {\r\n      nameLines = lines\r\n        .map((l) => this.cleanAndValidateName(l))\r\n        .filter((l) => l !== null);\r\n      if (fields.address) {\r\n        const addrUpper = fields.address.toUpperCase();\r\n        nameLines = nameLines.filter(\r\n          (l) => !addrUpper.includes(l) && !l.includes(addrUpper)\r\n        );\r\n      }\r\n      if (nameLines.length > 0) {\r\n        if (!fields.lastName && nameLines.length >= 1)\r\n          fields.lastName = nameLines[0];\r\n        if (!fields.firstName && nameLines.length >= 2)\r\n          fields.firstName = nameLines[1];\r\n        if (!fields.middleName && nameLines.length >= 3)\r\n          fields.middleName = nameLines[2];\r\n      }\r\n    }\r\n\r\n    if (text.match(/\\bMALE\\b/i) || text.match(/\\bLALAKI\\b/i))\r\n      fields.sex = \"Male\";\r\n    else if (text.match(/\\bFEMALE\\b/i) || text.match(/\\bBABAE\\b/i))\r\n      fields.sex = \"Female\";\r\n\r\n    // Standardize to flat format like other parsers for client compatibility\r\n    const cleanedFields = this.cleanFields(fields);\r\n\r\n    // Explicitly add idType to ensure client validation passes\r\n    // This acts as a fallback if the top-level idType is lost\r\n    cleanedFields.idType = \"philid\";\r\n\r\n    return cleanedFields;\r\n  }\r\n\r\n  /**\r\n   * Parse Postal ID\r\n   */\r\n  parsePhilPost(text) {\r\n    const fields = {\r\n      lastName: null,\r\n      firstName: null,\r\n      middleName: null,\r\n      address: null,\r\n      idNumber: null,\r\n      birthDate: null,\r\n    };\r\n\r\n    const lines = text\r\n      .split(\"\\n\")\r\n      .map((l) => l.trim())\r\n      .filter((l) => l.length > 0);\r\n\r\n    const prnMatch = text.match(/([A-Z]\\d{3}[\\s-]?\\d{4}[\\s-]?\\d{4})/);\r\n    if (prnMatch) fields.idNumber = prnMatch[1];\r\n\r\n    fields.address = this.findFieldByLabel(lines, [\"Address\", \"Tirahan\"], null);\r\n\r\n    const dates = text.match(/\\d{4}[-/]\\d{2}[-/]\\d{2}/g);\r\n    if (dates && dates.length >= 1)\r\n      fields.birthDate = this.parseDateString(dates[0]);\r\n\r\n    return this.cleanFields(fields);\r\n  }\r\n\r\n  /**\r\n   * Parse Driver's License\r\n   */\r\n  parseDriversLicense(text) {\r\n    const fields = {\r\n      lastName: null,\r\n      firstName: null,\r\n      middleName: null,\r\n      address: null,\r\n      idNumber: null,\r\n      birthDate: null,\r\n      agency: \"LTO\",\r\n    };\r\n\r\n    const licMatch = text.match(/([A-Z]\\d{2}-?\\d{2}-?\\d{6})/);\r\n    if (licMatch) fields.idNumber = licMatch[1];\r\n\r\n    const dates = text.match(/\\d{4}[-/]\\d{2}[-/]\\d{2}/g);\r\n    if (dates && dates.length > 0)\r\n      fields.birthDate = this.parseDateString(dates[0]);\r\n\r\n    if (text.match(/\\bM\\b/) || text.match(/\\bMale\\b/i)) fields.sex = \"Male\";\r\n    else if (text.match(/\\bF\\b/) || text.match(/\\bFemale\\b/i))\r\n      fields.sex = \"Female\";\r\n\r\n    return this.cleanFields(fields);\r\n  }\r\n\r\n  parseDateString(dateStr) {\r\n    if (!dateStr) return null;\r\n    try {\r\n      const monthNames = [\r\n        \"JANUARY\",\r\n        \"FEBRUARY\",\r\n        \"MARCH\",\r\n        \"APRIL\",\r\n        \"MAY\",\r\n        \"JUNE\",\r\n        \"JULY\",\r\n        \"AUGUST\",\r\n        \"SEPTEMBER\",\r\n        \"OCTOBER\",\r\n        \"NOVEMBER\",\r\n        \"DECEMBER\",\r\n      ];\r\n      const monthAbbr = [\r\n        \"JAN\",\r\n        \"FEB\",\r\n        \"MAR\",\r\n        \"APR\",\r\n        \"MAY\",\r\n        \"JUN\",\r\n        \"JUL\",\r\n        \"AUG\",\r\n        \"SEP\",\r\n        \"OCT\",\r\n        \"NOV\",\r\n        \"DEC\",\r\n      ];\r\n\r\n      const monthDayYearMatch = dateStr.match(\r\n        /([A-Z]+)\\s+(\\d{1,2}),?\\s+(\\d{2,4})/i\r\n      );\r\n      if (monthDayYearMatch) {\r\n        const monthName = monthDayYearMatch[1].toUpperCase();\r\n        const day = monthDayYearMatch[2].padStart(2, \"0\");\r\n        let year = monthDayYearMatch[3];\r\n        if (year.length === 2) {\r\n          const yearNum = Number.parseInt(year);\r\n          year = yearNum > 50 ? `19${year}` : `20${year}`;\r\n        }\r\n        let monthIndex = monthNames.indexOf(monthName);\r\n        if (monthIndex === -1)\r\n          monthIndex = monthAbbr.findIndex((m) => monthName.startsWith(m));\r\n        if (monthIndex !== -1) {\r\n          const month = (monthIndex + 1).toString().padStart(2, \"0\");\r\n          return `${year}-${month}-${day}`;\r\n        }\r\n      }\r\n\r\n      const parts = dateStr.split(/[-/]/);\r\n      if (parts.length === 3) {\r\n        let year, month, day;\r\n        if (parts[0].length === 4) {\r\n          [year, month, day] = parts;\r\n        } else if (Number.parseInt(parts[0]) > 12) {\r\n          [day, month, year] = parts;\r\n        } else {\r\n          [month, day, year] = parts;\r\n        }\r\n        if (year.length === 2) {\r\n          const yearNum = Number.parseInt(year);\r\n          year = yearNum > 50 ? `19${year}` : `20${year}`;\r\n        }\r\n        return `${year}-${month.padStart(2, \"0\")}-${day.padStart(2, \"0\")}`;\r\n      }\r\n      return null;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  cleanFields(fields) {\r\n    const cleaned = {};\r\n    for (const [key, value] of Object.entries(fields)) {\r\n      if (value !== null && value !== \"\" && value !== undefined) {\r\n        cleaned[key] = value;\r\n      }\r\n    }\r\n    return cleaned;\r\n  }\r\n\r\n  async detectAndCropCard(imagePath) {\r\n    if (!sharp) return imagePath;\r\n    try {\r\n      console.log(\"[OCR] Attempting to detect and crop card...\");\r\n      const image = sharp(imagePath);\r\n      const metadata = await image.metadata();\r\n      const trimmedBuffer = await image\r\n        .clone()\r\n        .trim({ threshold: 50 })\r\n        .toBuffer();\r\n      const trimmedMeta = await sharp(trimmedBuffer).metadata();\r\n      const widthRatio = trimmedMeta.width / metadata.width;\r\n      const heightRatio = trimmedMeta.height / metadata.height;\r\n      if (widthRatio > 0.95 && heightRatio > 0.95) {\r\n        console.log(\"[OCR] Trimming ineffective, using original image.\");\r\n        return imagePath;\r\n      }\r\n      const parsedPath = path.parse(imagePath);\r\n      const cropPath = path.join(\r\n        parsedPath.dir,\r\n        `${parsedPath.name}_cropped${parsedPath.ext}`\r\n      );\r\n      await sharp(trimmedBuffer).toFile(cropPath);\r\n      console.log(`[OCR] Card cropped. Saved to: ${cropPath}`);\r\n      return cropPath;\r\n    } catch (error) {\r\n      console.warn(\r\n        \"[OCR] Card detection failed, using original image:\",\r\n        error.message\r\n      );\r\n      return imagePath;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Execute Python OCR script\r\n   */\r\n  async runPythonOCR(imagePath) {\r\n    return new Promise((resolve, reject) => {\r\n      console.log(\r\n        `[OCR] Spawning Python process: python ${this.pythonScriptPath} ${imagePath}`\r\n      );\r\n\r\n      // Add site-packages to PYTHONPATH\r\n      const pythonProcess = spawn(\r\n        \"python\",\r\n        [this.pythonScriptPath, imagePath],\r\n        { env: process.env }\r\n      );\r\n\r\n      let stdoutData = \"\";\r\n      let stderrData = \"\";\r\n\r\n      pythonProcess.stdout.on(\"data\", (data) => {\r\n        stdoutData += data.toString();\r\n      });\r\n\r\n      pythonProcess.stderr.on(\"data\", (data) => {\r\n        stderrData += data.toString();\r\n        // Also log stderr to console for debugging\r\n        process.stderr.write(`[Python OCR] ${data}`);\r\n      });\r\n\r\n      pythonProcess.on(\"close\", (code) => {\r\n        if (code !== 0) {\r\n          console.error(`[OCR] Python process exited with code ${code}`);\r\n          return reject(new Error(`OCR process failed: ${stderrData}`));\r\n        }\r\n\r\n        try {\r\n          const result = JSON.parse(stdoutData);\r\n          if (result.error) {\r\n            return reject(new Error(result.error));\r\n          }\r\n          resolve(result);\r\n        } catch (e) {\r\n          console.error(\"[OCR] Failed to parse Python output:\", stdoutData);\r\n          reject(new Error(\"Invalid JSON output from OCR script\"));\r\n        }\r\n      });\r\n\r\n      pythonProcess.on(\"error\", (err) => {\r\n        reject(err);\r\n      });\r\n    });\r\n  }\r\n\r\n  async processId(req, res) {\r\n    const intermediateFiles = [];\r\n    try {\r\n      const { file } = req;\r\n      if (!file) {\r\n        return res\r\n          .status(400)\r\n          .json({ success: false, error: \"No file uploaded\" });\r\n      }\r\n\r\n      console.log(\"[OCR] Received file:\", file.originalname);\r\n\r\n      if (!file.mimetype.startsWith(\"image/\")) {\r\n        return res\r\n          .status(400)\r\n          .json({ success: false, error: \"File must be an image\" });\r\n      }\r\n\r\n      let processedImagePath = null;\r\n      let workingPath = file.path;\r\n\r\n      if (sharp) {\r\n        try {\r\n          const croppedPath = await this.detectAndCropCard(file.path);\r\n          if (croppedPath !== file.path) {\r\n            workingPath = croppedPath;\r\n            intermediateFiles.push(workingPath);\r\n          }\r\n\r\n          const metadata = await sharp(workingPath).metadata();\r\n          const minWidth = 1500;\r\n          const scaleFactor =\r\n            metadata.width < minWidth ? minWidth / metadata.width : 1;\r\n          const targetWidth = Math.round(metadata.width * scaleFactor);\r\n          const targetHeight = Math.round(metadata.height * scaleFactor);\r\n\r\n          const pipeline = sharp(workingPath)\r\n            .resize(targetWidth, targetHeight, {\r\n              kernel: sharp.kernel.lanczos3,\r\n              fit: \"fill\",\r\n            })\r\n            .greyscale()\r\n            .normalize({ lower: 5, upper: 95 })\r\n            .modulate({ brightness: 1.1, saturation: 1.2 })\r\n            .sharpen({ sigma: 1.5, m1: 1.0, m2: 2.0, x1: 10, y2: 10, y3: 20 });\r\n\r\n          // Ensure processed image has an extension for PaddleOCR\r\n          const ext = path.extname(file.originalname) || \".jpg\";\r\n          processedImagePath = path.join(\r\n            path.dirname(file.path),\r\n            `processed_${path.basename(file.path)}${ext}`\r\n          );\r\n          await pipeline.toFile(processedImagePath);\r\n          intermediateFiles.push(processedImagePath);\r\n\r\n          console.log(\"[OCR] Image preprocessed:\", processedImagePath);\r\n        } catch (err) {\r\n          console.error(\"[OCR] Preprocessing failed:\", err);\r\n          // Fallback to original, but we need to ensure it has extension\r\n          const ext = path.extname(file.originalname) || \".jpg\";\r\n          const tempPath = file.path + ext;\r\n          await fsPromises.copyFile(file.path, tempPath);\r\n          processedImagePath = tempPath;\r\n          intermediateFiles.push(processedImagePath);\r\n        }\r\n      } else {\r\n        // No sharp, use original but ensure extension\r\n        const ext = path.extname(file.originalname) || \".jpg\";\r\n        const tempPath = file.path + ext;\r\n        await fsPromises.copyFile(file.path, tempPath);\r\n        processedImagePath = tempPath;\r\n        intermediateFiles.push(processedImagePath);\r\n      }\r\n\r\n      console.log(\"[OCR] Starting PaddleOCR recognition (Python)...\");\r\n\r\n      const ocrResult = await this.runPythonOCR(processedImagePath);\r\n\r\n      const { text } = ocrResult;\r\n      const confidence = ocrResult.average_confidence * 100; // Convert to percentage\r\n\r\n      console.log(\r\n        `[OCR] Recognition complete. Confidence: ${confidence.toFixed(2)}%`\r\n      );\r\n      console.log(`[OCR] Extracted Text Length: ${text.length}`);\r\n\r\n      try {\r\n        for (const p of intermediateFiles) {\r\n          // eslint-disable-next-line security/detect-non-literal-fs-filename\r\n          if (fs.existsSync(p)) {\r\n            // eslint-disable-next-line security/detect-non-literal-fs-filename\r\n            await fsPromises.unlink(p).catch(() => {});\r\n          }\r\n        }\r\n      } catch (e) {}\r\n\r\n      const idType = this.detectIdType(text);\r\n      console.log(`[OCR] Detected ID type: ${idType}`);\r\n\r\n      const fields = this.parseIdFields(text, idType);\r\n\r\n      // Secure ID Verification: Generate a signed token if ID was detected\r\n      let verificationToken = null;\r\n      if (idType !== \"unknown\") {\r\n        const { generateVerificationToken } = require(\"../utils/token\");\r\n        try {\r\n          verificationToken = generateVerificationToken(idType);\r\n        } catch (e) {\r\n          console.error(\"[OCR] Failed to generate verification token:\", e);\r\n        }\r\n      }\r\n\r\n      // Cleanup original file if it exists and wasn't already cleaned up\r\n      try {\r\n        // eslint-disable-next-line security/detect-non-literal-fs-filename\r\n        if (file && file.path && fs.existsSync(file.path)) {\r\n          // eslint-disable-next-line security/detect-non-literal-fs-filename\r\n          await fsPromises.unlink(file.path).catch(() => {});\r\n        }\r\n      } catch (e) {}\r\n\r\n      return res.json({\r\n        success: true,\r\n        idType,\r\n        fields,\r\n        verificationToken, // Return the token to the client\r\n        confidence,\r\n        message: \"ID processed successfully\",\r\n      });\r\n    } catch (error) {\r\n      console.error(\"[OCR] Processing error:\", error);\r\n      try {\r\n        for (const p of intermediateFiles) {\r\n          // eslint-disable-next-line security/detect-non-literal-fs-filename\r\n          if (fs.existsSync(p)) {\r\n            // eslint-disable-next-line security/detect-non-literal-fs-filename\r\n            await fsPromises.unlink(p).catch(() => {});\r\n          }\r\n        }\r\n        // Cleanup original file on error as well\r\n        // eslint-disable-next-line security/detect-non-literal-fs-filename\r\n        if (req.file && req.file.path && fs.existsSync(req.file.path)) {\r\n          // eslint-disable-next-line security/detect-non-literal-fs-filename\r\n          await fsPromises.unlink(req.file.path).catch(() => {});\r\n        }\r\n      } catch (e) {}\r\n\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: \"Failed to process ID\",\r\n        message: error.message,\r\n      });\r\n    }\r\n  }\r\n  /**\r\n   * Process Secondary Residency Document (Bill, Certificate, Cedula)\r\n   * Validates: \"DIGOS\" keyword AND User's Last Name\r\n   */\r\n  async processResidencyDoc(req, res) {\r\n    const intermediateFiles = [];\r\n    try {\r\n      const { file } = req;\r\n      const { lastName } = req.body;\r\n\r\n      if (!file || !lastName) {\r\n        return res\r\n          .status(400)\r\n          .json({ success: false, error: \"File and Last Name are required\" });\r\n      }\r\n\r\n      console.log(`[OCR-RESIDENCY] Processing doc for user: ${lastName}`);\r\n\r\n      // 1. Preprocess (Reuse existing logic)\r\n      let processedImagePath = file.path;\r\n      // Simple preprocessing if sharp is available\r\n      if (sharp) {\r\n        const ext = path.extname(file.originalname) || \".jpg\";\r\n        processedImagePath = path.join(\r\n          path.dirname(file.path),\r\n          `residency_${Date.now()}${ext}`\r\n        );\r\n        await sharp(file.path)\r\n          .greyscale()\r\n          .normalize()\r\n          .toFile(processedImagePath);\r\n        intermediateFiles.push(processedImagePath);\r\n      }\r\n\r\n      // 2. Run Generic OCR (Get ALL text)\r\n      const ocrResult = await this.runPythonOCR(processedImagePath);\r\n      const text = ocrResult.text.toUpperCase();\r\n\r\n      console.log(`[OCR-RESIDENCY] Extracted Text Length: ${text.length}`);\r\n\r\n      // 3. Keyword Validation\r\n      // Helper: Check if word exists in text (fuzzy allowed for name)\r\n      const hasKeyword = (keyword) => {\r\n        if (text.includes(keyword)) return true;\r\n        // Split text into tokens for fuzzy check\r\n        const tokens = text.split(/\\s+/);\r\n        for (const token of tokens) {\r\n          if (token.length > 3 && this.levenshteinDistance(token, keyword) <= 1)\r\n            return true;\r\n        }\r\n        return false;\r\n      };\r\n\r\n      const hasLocation = hasKeyword(\"DIGOS\");\r\n      const hasName = hasKeyword(lastName.toUpperCase());\r\n\r\n      // Cleanup\r\n      try {\r\n        if (file.path) {\r\n          // eslint-disable-next-line security/detect-non-literal-fs-filename\r\n          fsPromises.unlink(file.path).catch(() => {});\r\n        }\r\n        for (const p of intermediateFiles) {\r\n          // eslint-disable-next-line security/detect-non-literal-fs-filename\r\n          fsPromises.unlink(p).catch(() => {});\r\n        }\r\n      } catch (e) {}\r\n\r\n      if (hasLocation && hasName) {\r\n        // Generate token for this specific residency check\r\n        const { generateVerificationToken } = require(\"../utils/token\");\r\n        const residencyToken = generateVerificationToken(\"residency_secondary\");\r\n\r\n        return res.json({\r\n          success: true,\r\n          verified: true,\r\n          message: \"Residency verified: Digos address and Name match found.\",\r\n          residencyToken,\r\n        });\r\n      }\r\n      let errorMsg = \"Verification Failed. \";\r\n      if (!hasLocation) errorMsg += \"Document does not mention 'Digos'. \";\r\n      if (!hasName)\r\n        errorMsg += `Document does not mention surname '${lastName}'.`;\r\n\r\n      return res.json({\r\n        success: true,\r\n        verified: false,\r\n        error: errorMsg,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"[OCR-RESIDENCY] Error:\", error);\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: \"Failed to process residency document\",\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\nconst ocrController = new OCRController();\r\nmodule.exports = {\r\n  processId: ocrController.processId.bind(ocrController),\r\n  processResidencyDoc: ocrController.processResidencyDoc.bind(ocrController),\r\n};\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\OfficeConfirmationController.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\SettingController.js","messages":[{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":100,"column":22,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":101,"endColumn":64}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const SettingService = require(\"../services/SettingService\");\n\nclass SettingController {\n\n  constructor() {\n    this.settingService = new SettingService();\n  }\n  async getAllSettings(req, res) {\n    try {\n      const settings = await this.settingService.getAllSettings();\n      res.json({\n        success: true,\n        data: settings\n      });\n    } catch (error) {\n      console.error(\"Error fetching settings:\", error);\n      res.status(500).json({\n        success: false,\n        error: \"Failed to fetch settings\"\n      });\n    }\n  }\n  async getPublicSettings(req, res) {\n    try {\n      const settings = await this.settingService.getPublicSettings();\n      res.json({\n        success: true,\n        data: settings\n      });\n    } catch (error) {\n      console.error(\"Error fetching public settings:\", error);\n      res.status(500).json({\n        success: false,\n        error: \"Failed to fetch public settings\"\n      });\n    }\n  }\n  async getSettingsByCategory(req, res) {\n    try {\n      const { category } = req.params;\n      const settings = await this.settingService.getSettingsByCategory(category);\n      res.json({\n        success: true,\n        data: settings\n      });\n    } catch (error) {\n      console.error(\"Error fetching settings by category:\", error);\n      res.status(500).json({\n        success: false,\n        error: \"Failed to fetch settings\"\n      });\n    }\n  }\n  async getSettingByKey(req, res) {\n    try {\n      const { key } = req.params;\n      const setting = await this.settingService.getSettingByKey(key);\n      res.json({\n        success: true,\n        data: setting\n      });\n    } catch (error) {\n      console.error(\"Error fetching setting:\", error);\n      const status = error.message === \"Setting not found\" ? 404 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  async createSetting(req, res) {\n    try {\n      const setting = await this.settingService.createSetting(req.body);\n      res.status(201).json({\n        success: true,\n        data: setting,\n        message: \"Setting created successfully\"\n      });\n    } catch (error) {\n      console.error(\"Error creating setting:\", error);\n      const status = error.message.includes(\"Validation failed\") ||\n                     error.message.includes(\"already exists\") ? 400 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  async updateSetting(req, res) {\n    try {\n      const { key } = req.params;\n      const setting = await this.settingService.updateSetting(key, req.body);\n      res.json({\n        success: true,\n        data: setting,\n        message: \"Setting updated successfully\"\n      });\n    } catch (error) {\n      console.error(\"Error updating setting:\", error);\n      const status = error.message === \"Setting not found\" ? 404 :\n        error.message.includes(\"Validation failed\") ? 400 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  async deleteSetting(req, res) {\n    try {\n      const { key } = req.params;\n      await this.settingService.deleteSetting(key);\n      res.json({\n        success: true,\n        message: \"Setting deleted successfully\"\n      });\n    } catch (error) {\n      console.error(\"Error deleting setting:\", error);\n      const status = error.message === \"Setting not found\" ? 404 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  async initializeDefaults(req, res) {\n    try {\n      const settings = await this.settingService.initializeDefaultSettings();\n      res.json({\n        success: true,\n        data: settings,\n        message: \"Default settings initialized successfully\"\n      });\n    } catch (error) {\n      console.error(\"Error initializing default settings:\", error);\n      res.status(500).json({\n        success: false,\n        error: \"Failed to initialize default settings\"\n      });\n    }\n  }\n}\n\nmodule.exports = SettingController;\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\controllers\\SuperAdminController.js","messages":[{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":180,"column":22,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":182,"endColumn":72},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":181,"column":9,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":182,"endColumn":72}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const SuperAdminService = require(\"../services/SuperAdminService\");\nconst UserManagementService = require(\"../services/UserManagementService\");\n\n/**\n * SuperAdminController\n * Handles Super Admin operations\n */\nclass SuperAdminController {\n\n  constructor() {\n    this.superAdminService = new SuperAdminService();\n    this.userManagementService = new UserManagementService();\n  }\n  /**\n   * GET /api/superadmin/dashboard\n   * Get Super Admin dashboard data\n   */\n  async getDashboard(req, res) {\n    try {\n      const { user } = req;\n      const data = await this.superAdminService.getDashboard(user.id);\n      res.json({\n        success: true,\n        ...data\n      });\n    } catch (error) {\n      console.error(\"[SUPERADMIN_CONTROLLER] Get dashboard error:\", error);\n      const status = error.message.includes(\"Only Super Admin\") ? 403 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  /**\n   * POST /api/superadmin/role-swap\n   * Swap user role (any to any)\n   */\n  async roleSwap(req, res) {\n    try {\n      const { user } = req;\n      const { user_id, new_role, reason } = req.body;\n      if (!user_id) {\n        return res.status(400).json({\n          success: false,\n          error: \"User ID is required\"\n        });\n      }\n      if (!new_role) {\n        return res.status(400).json({\n          success: false,\n          error: \"New role is required\"\n        });\n      }\n      console.log(\"[SUPERADMIN_CONTROLLER] Role swap request:\", {\n        userId: user_id,\n        newRole: new_role,\n        performedBy: user.id,\n        reason\n      });\n\n      const result = await this.superAdminService.roleSwap(\n        user_id,\n        new_role,\n        user.id,\n        reason\n      );\n\n      console.log(\"[SUPERADMIN_CONTROLLER] Role swap result:\", result);\n\n      res.json({\n        success: true,\n        ...result\n      });\n    } catch (error) {\n      console.error(\"[SUPERADMIN_CONTROLLER] Role swap error:\", error);\n      const status = error.message.includes(\"Only Super Admin\") || error.message.includes(\"Cannot change\") ? 403 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  /**\n   * POST /api/superadmin/transfer-department\n   * Transfer user between departments\n   */\n  async transferDepartment(req, res) {\n    try {\n      const { user } = req;\n      const { user_id, from_department, to_department, reason } = req.body;\n      if (!user_id) {\n        return res.status(400).json({\n          success: false,\n          error: \"User ID is required\"\n        });\n      }\n      if (!from_department || !to_department) {\n        return res.status(400).json({\n          success: false,\n          error: \"From and to departments are required\"\n        });\n      }\n      if (!reason) {\n        return res.status(400).json({\n          success: false,\n          error: \"Reason is required for department transfer\"\n        });\n      }\n      const result = await this.superAdminService.transferUserBetweenDepartments(\n        user_id,\n        from_department,\n        to_department,\n        user.id,\n        reason\n      );\n      res.json({\n        success: true,\n        ...result\n      });\n    } catch (error) {\n      console.error(\"[SUPERADMIN_CONTROLLER] Transfer department error:\", error);\n      const status = error.message.includes(\"Only Super Admin\") ? 403 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  /**\n   * POST /api/superadmin/assign-citizen\n   * Assign citizen to department with role\n   */\n  async assignCitizen(req, res) {\n    try {\n      const { user } = req;\n      const { user_id, role, department_id, reason } = req.body;\n      if (!user_id) {\n        return res.status(400).json({\n          success: false,\n          error: \"User ID is required\"\n        });\n      }\n      if (!role) {\n        return res.status(400).json({\n          success: false,\n          error: \"Role is required\"\n        });\n      }\n      if (!department_id) {\n        return res.status(400).json({\n          success: false,\n          error: \"Department ID is required\"\n        });\n      }\n      console.log(\"[SUPERADMIN_CONTROLLER] Assign citizen request:\", {\n        userId: user_id,\n        role,\n        departmentId: department_id,\n        performedBy: user.id,\n        reason\n      });\n\n      const result = await this.superAdminService.assignCitizenToDepartment(\n        user_id,\n        role,\n        department_id,\n        user.id,\n        reason\n      );\n\n      console.log(\"[SUPERADMIN_CONTROLLER] Assign citizen result:\", result);\n\n      res.json({\n        success: true,\n        ...result\n      });\n    } catch (error) {\n      console.error(\"[SUPERADMIN_CONTROLLER] Assign citizen error:\", error);\n      const status = error.message.includes(\"Only Super Admin\") ? 403 :\n        error.message.includes(\"Can only assign\") ? 400 :\n          error.message.includes(\"Invalid department role\") ? 400 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message || \"Failed to assign citizen to department\"\n      });\n    }\n  }\n  /**\n   * GET /api/superadmin/logs\n   * Get system logs\n   */\n  async getLogs(req, res) {\n    try {\n      const { user } = req;\n      const options = {\n        log_type: req.query.log_type || \"all\",\n        limit: req.query.limit ? parseInt(req.query.limit) : 100,\n        offset: req.query.offset ? parseInt(req.query.offset) : 0,\n        date_from: req.query.date_from,\n        date_to: req.query.date_to\n      };\n      const result = await this.superAdminService.getSystemLogs(user.id, options);\n\n      // Also include terminal logs if requested\n      const includeTerminal = req.query.include_terminal === \"true\";\n      if (includeTerminal) {\n        const consoleLogger = require(\"../utils/consoleLogger\");\n        const terminalLogs = consoleLogger.getLogs({\n          level: req.query.terminal_level || \"all\",\n          limit: req.query.terminal_limit ? parseInt(req.query.terminal_limit) : 500\n        });\n        result.terminal_logs = terminalLogs;\n      }\n\n      res.json({\n        success: true,\n        ...result\n      });\n    } catch (error) {\n      console.error(\"[SUPERADMIN_CONTROLLER] Get logs error:\", error);\n      const status = error.message.includes(\"Only Super Admin\") ? 403 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  /**\n   * GET /api/superadmin/role-distribution\n   * Get role distribution for pie chart\n   */\n  async getRoleDistribution(req, res) {\n    try {\n      const { user } = req;\n      const result = await this.superAdminService.getRoleDistribution(user.id);\n      res.json({\n        success: true,\n        ...result\n      });\n    } catch (error) {\n      console.error(\"[SUPERADMIN_CONTROLLER] Get role distribution error:\", error);\n      const status = error.message.includes(\"Only Super Admin\") ? 403 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  /**\n   * GET /api/superadmin/terminal-logs\n   * Get terminal/console logs\n   */\n  async getTerminalLogs(req, res) {\n    try {\n      const { user } = req;\n      // Validate super admin\n      const adminRole = await this.superAdminService.roleService.getUserRole(user.id);\n      if (adminRole !== \"super-admin\") {\n        return res.status(403).json({\n          success: false,\n          error: \"Only Super Admin can view terminal logs\"\n        });\n      }\n\n      const consoleLogger = require(\"../utils/consoleLogger\");\n      const options = {\n        level: req.query.level || \"all\",\n        limit: req.query.limit ? parseInt(req.query.limit) : 500,\n        since: req.query.since || null\n      };\n\n      const logs = consoleLogger.getLogs(options);\n\n      res.json({\n        success: true,\n        logs,\n        total: consoleLogger.getLogCount()\n      });\n    } catch (error) {\n      console.error(\"[SUPERADMIN_CONTROLLER] Get terminal logs error:\", error);\n      res.status(500).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  /**\n   * GET /api/superadmin/statistics\n   * Get system statistics\n   */\n  async getStatistics(req, res) {\n    try {\n      const { user } = req;\n      const result = await this.superAdminService.getSystemStatistics(user.id);\n      res.json({\n        success: true,\n        ...result\n      });\n    } catch (error) {\n      console.error(\"[SUPERADMIN_CONTROLLER] Get statistics error:\", error);\n      const status = error.message.includes(\"Only Super Admin\") ? 403 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  /**\n   * GET /api/superadmin/latest-users\n   * Get latest registered users (with confirmed emails or OAuth)\n   */\n  async getLatestUsers(req, res) {\n    try {\n      const { user } = req;\n      const limit = req.query.limit ? parseInt(req.query.limit) : 5;\n      const result = await this.superAdminService.getLatestRegisteredUsers(user.id, limit);\n      res.json({\n        success: true,\n        ...result\n      });\n    } catch (error) {\n      console.error(\"[SUPERADMIN_CONTROLLER] Get latest users error:\", error);\n      const status = error.message.includes(\"Only Super Admin\") ? 403 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message\n      });\n    }\n  }\n  /**\n   * POST /api/superadmin/ban-user\n   * Ban a user (temporary or permanent)\n   */\n  async banUser(req, res) {\n    try {\n      const { user } = req;\n      const { user_id, type, duration, reason } = req.body;\n\n      if (!user_id) {\n        return res.status(400).json({\n          success: false,\n          error: \"User ID is required\"\n        });\n      }\n\n      if (!type || ![\"temporary\", \"permanent\"].includes(type)) {\n        return res.status(400).json({\n          success: false,\n          error: 'Ban type must be \"temporary\" or \"permanent\"'\n        });\n      }\n\n      if (type === \"temporary\" && (!duration || duration < 1)) {\n        return res.status(400).json({\n          success: false,\n          error: \"Duration (in hours) is required for temporary bans\"\n        });\n      }\n\n      if (!reason || reason.trim().length === 0) {\n        return res.status(400).json({\n          success: false,\n          error: \"Reason is required for banning\"\n        });\n      }\n\n      const result = await this.userManagementService.banUser(user_id, user.id, {\n        type,\n        duration: type === \"temporary\" ? parseInt(duration) : null,\n        reason: reason.trim()\n      });\n\n      res.json({\n        success: true,\n        ...result\n      });\n    } catch (error) {\n      console.error(\"[SUPERADMIN_CONTROLLER] Ban user error:\", error);\n      res.status(500).json({\n        success: false,\n        error: error.message || \"Failed to ban user\"\n      });\n    }\n  }\n  /**\n   * POST /api/superadmin/unban-user\n   * Unban a user (only Super Admin)\n   */\n  async unbanUser(req, res) {\n    try {\n      const { user } = req;\n      const { user_id } = req.body;\n\n      if (!user_id) {\n        return res.status(400).json({\n          success: false,\n          error: \"User ID is required\"\n        });\n      }\n\n      // Verify user is Super Admin\n      const adminRole = await this.superAdminService.roleService.getUserRole(user.id);\n      if (adminRole !== \"super-admin\") {\n        return res.status(403).json({\n          success: false,\n          error: \"Only Super Admin can unban users\"\n        });\n      }\n\n      const result = await this.userManagementService.unbanUser(user_id, user.id);\n\n      res.json({\n        success: true,\n        ...result\n      });\n    } catch (error) {\n      console.error(\"[SUPERADMIN_CONTROLLER] Unban user error:\", error);\n      const status = error.message.includes(\"Only Super Admin\") ? 403 : 500;\n      res.status(status).json({\n        success: false,\n        error: error.message || \"Failed to unban user\"\n      });\n    }\n  }\n}\n\nmodule.exports = SuperAdminController;\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\middleware\\auditLogging.js","messages":[{"ruleId":"no-lonely-if","severity":1,"message":"Unexpected if as the only statement in an else block.","line":28,"column":7,"nodeType":"IfStatement","messageId":"unexpectedLonelyIf","endLine":34,"endColumn":8},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":71,"column":15,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":73,"endColumn":68},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":72,"column":11,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":73,"endColumn":68},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":88,"column":15,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":90,"endColumn":68},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":89,"column":11,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":90,"endColumn":68},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":105,"column":15,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":107,"endColumn":68},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":106,"column":11,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":107,"endColumn":68}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const AuditLogRepository = require(\"../repositories/AuditLogRepository\");\r\n\r\nconst auditLog = new AuditLogRepository();\r\n\r\n/**\r\n * Middleware to log sensitive operations for GDPR compliance\r\n * @param {string} actionType - Type of action to log\r\n * @param {Function} getTargetInfo - Optional function to extract target info from request\r\n */\r\nfunction auditMiddleware(actionType, getTargetInfo = null) {\r\n  return async (req, res, next) => {\r\n    // Don't log if no user is authenticated\r\n    if (!req.user || !req.user.id) {\r\n      return next();\r\n    }\r\n\r\n    // Extract target information if provided\r\n    let targetType = null;\r\n    let targetId = null;\r\n    if (getTargetInfo) {\r\n      const target = getTargetInfo(req);\r\n      if (target) {\r\n        targetType = target.type;\r\n        targetId = target.id;\r\n      }\r\n    } else {\r\n      // Default: try to extract from params\r\n      if (req.params.id) {\r\n        targetId = req.params.id;\r\n        // Try to infer target type from route\r\n        if (req.path.includes(\"/complaints\")) targetType = \"complaint\";\r\n        else if (req.path.includes(\"/users\")) targetType = \"user\";\r\n        else if (req.path.includes(\"/departments\")) targetType = \"department\";\r\n      }\r\n    }\r\n\r\n    // Extract request details\r\n    const ipAddress = req.ip || req.connection.remoteAddress || null;\r\n    const userAgent = req.get(\"user-agent\") || null;\r\n    const details = {\r\n      method: req.method,\r\n      path: req.path,\r\n      timestamp: new Date().toISOString()\r\n    };\r\n\r\n    // Log the action (non-blocking)\r\n    auditLog.log(actionType, req.user.id, {\r\n      targetType,\r\n      targetId,\r\n      details,\r\n      ipAddress,\r\n      userAgent\r\n    }).catch(error => {\r\n      // Log error but don't break the request\r\n      console.error(\"[AUDIT_MIDDLEWARE] Failed to log action:\", error);\r\n    });\r\n\r\n    next();\r\n  };\r\n}\r\n\r\n/**\r\n * Specific audit middleware for data access (GDPR compliance)\r\n */\r\nfunction auditDataAccess(req, res, next) {\r\n  return auditMiddleware(\"data_access\", (req) => {\r\n    // Extract target from request\r\n    if (req.params.id) {\r\n      return {\r\n        id: req.params.id,\r\n        type: req.path.includes(\"/complaints\") ? \"complaint\" :\r\n          req.path.includes(\"/users\") ? \"user\" :\r\n            req.path.includes(\"/departments\") ? \"department\" : null\r\n      };\r\n    }\r\n    return null;\r\n  })(req, res, next);\r\n}\r\n\r\n/**\r\n * Specific audit middleware for data modification\r\n */\r\nfunction auditDataModification(req, res, next) {\r\n  return auditMiddleware(\"data_modification\", (req) => {\r\n    if (req.params.id) {\r\n      return {\r\n        id: req.params.id,\r\n        type: req.path.includes(\"/complaints\") ? \"complaint\" :\r\n          req.path.includes(\"/users\") ? \"user\" :\r\n            req.path.includes(\"/departments\") ? \"department\" : null\r\n      };\r\n    }\r\n    return null;\r\n  })(req, res, next);\r\n}\r\n\r\n/**\r\n * Specific audit middleware for data deletion\r\n */\r\nfunction auditDataDeletion(req, res, next) {\r\n  return auditMiddleware(\"data_deletion\", (req) => {\r\n    if (req.params.id) {\r\n      return {\r\n        id: req.params.id,\r\n        type: req.path.includes(\"/complaints\") ? \"complaint\" :\r\n          req.path.includes(\"/users\") ? \"user\" :\r\n            req.path.includes(\"/departments\") ? \"department\" : null\r\n      };\r\n    }\r\n    return null;\r\n  })(req, res, next);\r\n}\r\n\r\n/**\r\n * Audit middleware for authentication events\r\n */\r\nfunction auditAuthEvent(eventType) {\r\n  return async (req, res, next) => {\r\n    const userId = req.user?.id || null;\r\n    const ipAddress = req.ip || req.connection.remoteAddress || null;\r\n    const userAgent = req.get(\"user-agent\") || null;\r\n\r\n    auditLog.log(eventType, userId, {\r\n      targetType: \"user\",\r\n      targetId: userId,\r\n      details: {\r\n        method: req.method,\r\n        path: req.path,\r\n        timestamp: new Date().toISOString()\r\n      },\r\n      ipAddress,\r\n      userAgent\r\n    }).catch(error => {\r\n      console.error(\"[AUDIT_MIDDLEWARE] Failed to log auth event:\", error);\r\n    });\r\n\r\n    next();\r\n  };\r\n}\r\n\r\nmodule.exports = {\r\n  auditMiddleware,\r\n  auditDataAccess,\r\n  auditDataModification,\r\n  auditDataDeletion,\r\n  auditAuthEvent\r\n};\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\middleware\\auditMiddleware.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\middleware\\auth.js","messages":[],"suppressedMessages":[{"ruleId":"security/detect-non-literal-regexp","severity":2,"message":"Found non-literal argument to RegExp Constructor","line":239,"column":25,"nodeType":"NewExpression","endLine":239,"endColumn":51,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\middleware\\csrf.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\middleware\\errorHandler.js","messages":[{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\/.","line":66,"column":34,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":66,"endColumn":35,"suggestions":[{"messageId":"removeEscape","fix":{"range":[2343,2344],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[2343,2343],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const config = require(\"../../../config/app\");\nconst path = require(\"path\");\n\nclass ErrorHandler {\n  static handle(err, req, res, _next) {\n    console.error(\"Application error:\", {\n      message: err.message,\n      stack: config.isDevelopment\n        ? err.stack\n        : \"Stack trace hidden in production\",\n      path: req.path,\n      method: req.method,\n      ip: req.ip,\n      userAgent: req.get(\"User-Agent\"),\n      timestamp: new Date().toISOString(),\n    });\n    // API error response\n    if (req.path.startsWith(\"/api/\")) {\n      return ErrorHandler.handleApiError(err, req, res);\n    }\n    // Page error response\n    return ErrorHandler.handlePageError(err, req, res);\n  }\n  static handleApiError(err, req, res) {\n    // Sanitize error message to prevent information leakage\n    const sanitizedMessage = this.sanitizeErrorMessage(err.message);\n    const errorResponse = {\n      success: false,\n      error: config.isProduction\n        ? this.getGenericErrorMessage(err)\n        : sanitizedMessage,\n      timestamp: new Date().toISOString(),\n      code: this.getErrorCode(err),\n    };\n    // Add request context in development only\n    if (config.isDevelopment) {\n      errorResponse.path = req.path;\n      errorResponse.method = req.method;\n      errorResponse.debug = {\n        originalMessage: err.message,\n        stack: err.stack?.split(\"\\n\").slice(0, 5), // Limit stack trace\n      };\n    }\n    const statusCode = this.getStatusCode(err);\n    res.status(statusCode).json(errorResponse);\n  }\n  static handlePageError(err, req, res) {\n    const statusCode = this.getStatusCode(err);\n    const viewsRoot = path.join(config.rootDir, \"views\", \"pages\");\n    if (statusCode === 404) {\n      return res.status(404).sendFile(path.join(viewsRoot, \"404.html\"));\n    }\n    // For other errors, send a generic error page or redirect\n    return res.status(500).sendFile(path.join(viewsRoot, \"500.html\"));\n  }\n  static sanitizeErrorMessage(message) {\n    if (!message || typeof message !== \"string\") {\n      return \"An error occurred\";\n    }\n    // Remove potential sensitive information patterns\n    let sanitized = message;\n    // Remove file paths\n    sanitized = sanitized.replace(/\\/[^\\s]+/g, \"[PATH]\");\n    // Remove database connection strings or URLs with credentials\n    sanitized = sanitized.replace(\n      /([a-zA-Z]+:\\/\\/)[^@\\s]+@[^\\/\\s]+/g,\n      \"$1[REDACTED]@[REDACTED]\"\n    );\n    // Remove potential API keys or tokens\n    sanitized = sanitized.replace(/\\b[A-Za-z0-9_-]{20,}\\b/g, \"[TOKEN]\");\n    // Remove email addresses if they appear in error messages\n    sanitized = sanitized.replace(\n      /\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\\b/g,\n      \"[EMAIL]\"\n    );\n    // Remove IP addresses\n    sanitized = sanitized.replace(\n      /\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\b/g,\n      \"[IP]\"\n    );\n    return sanitized;\n  }\n  static getGenericErrorMessage(err) {\n    const statusCode = this.getStatusCode(err);\n    switch (statusCode) {\n      case 400:\n        return \"Invalid request data\";\n      case 401:\n        return \"Authentication required\";\n      case 403:\n        return \"Access forbidden\";\n      case 404:\n        return \"Resource not found\";\n      case 409:\n        return \"Resource conflict\";\n      case 413:\n        return \"Request too large\";\n      case 429:\n        return \"Too many requests\";\n      default:\n        return \"Internal server error\";\n    }\n  }\n  static getErrorCode(_err) {\n    // Generate a unique error code for tracking without exposing internal details\n    const timestamp = Date.now();\n    const random = require(\"crypto\").randomInt(0, 1000);\n\n    return `ERR_${timestamp}_${random}`;\n  }\n  static getStatusCode(err) {\n    // Custom error with status\n    if (err.statusCode) return err.statusCode;\n    if (err.status) return err.status;\n    // Common error types\n    if (err.name === \"ValidationError\") return 400;\n    if (err.name === \"UnauthorizedError\") return 401;\n    if (err.name === \"ForbiddenError\") return 403;\n    if (err.name === \"NotFoundError\") return 404;\n    if (err.name === \"ConflictError\") return 409;\n    // Database errors\n    if (err.code === \"23505\") return 409; // Unique constraint violation\n    if (err.code === \"23503\") return 400; // Foreign key constraint violation\n    if (err.code === \"23502\") return 400; // Not null constraint violation\n    // Default to 500\n    return 500;\n  }\n  static notFound(req, res, next) {\n    const error = new Error(`Route not found: ${req.method} ${req.path}`);\n    error.statusCode = 404;\n    next(error);\n  }\n  static asyncWrapper(fn) {\n    return (req, res, next) => {\n      Promise.resolve(fn(req, res, next)).catch(next);\n    };\n  }\n}\n// Custom error classes\nclass ValidationError extends Error {\n  constructor(message) {\n    super(message);\n    this.name = \"ValidationError\";\n    this.statusCode = 400;\n  }\n}\nclass UnauthorizedError extends Error {\n  constructor(message = \"Unauthorized\") {\n    super(message);\n    this.name = \"UnauthorizedError\";\n    this.statusCode = 401;\n  }\n}\nclass ForbiddenError extends Error {\n  constructor(message = \"Forbidden\") {\n    super(message);\n    this.name = \"ForbiddenError\";\n    this.statusCode = 403;\n  }\n}\nclass NotFoundError extends Error {\n  constructor(message = \"Not found\") {\n    super(message);\n    this.name = \"NotFoundError\";\n    this.statusCode = 404;\n  }\n}\nclass ConflictError extends Error {\n  constructor(message = \"Conflict\") {\n    super(message);\n    this.name = \"ConflictError\";\n    this.statusCode = 409;\n  }\n}\n\nmodule.exports = {\n  ErrorHandler,\n  ValidationError,\n  UnauthorizedError,\n  ForbiddenError,\n  NotFoundError,\n  ConflictError,\n};\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\middleware\\httpsEnforcement.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\middleware\\inputSanitizer.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '&&' and '||'. Use parentheses to clarify the intended order of operations.","line":275,"column":18,"nodeType":"LogicalExpression","messageId":"unexpectedMixedOperator","endLine":275,"endColumn":20},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '&&' and '||'. Use parentheses to clarify the intended order of operations.","line":275,"column":35,"nodeType":"LogicalExpression","messageId":"unexpectedMixedOperator","endLine":275,"endColumn":37}],"suppressedMessages":[{"ruleId":"security/detect-unsafe-regex","severity":2,"message":"Unsafe Regular Expression","line":483,"column":25,"nodeType":"Literal","endLine":483,"endColumn":50,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const validator = require(\"validator\");\nconst _xss = require(\"xss\");\nconst DOMPurify = require(\"isomorphic-dompurify\");\n\n// Enhanced input sanitization and validation middleware\nclass InputSanitizer {\n  // Main sanitization middleware\n  static sanitize(req, res, next) {\n    try {\n      // Log sanitization attempt for security monitoring\n      // console.log removed for security\n      // Sanitize request body\n      if (req.body && typeof req.body === \"object\") {\n        req.body = InputSanitizer.sanitizeObject(req.body, \"body\");\n      }\n      // Sanitize query parameters\n      if (req.query && typeof req.query === \"object\") {\n        req.query = InputSanitizer.sanitizeObject(req.query, \"query\");\n      }\n      // Sanitize route parameters\n      if (req.params && typeof req.params === \"object\") {\n        req.params = InputSanitizer.sanitizeObject(req.params, \"params\");\n      }\n      // Sanitize headers that might contain user input\n      if (req.headers) {\n        InputSanitizer.sanitizeHeaders(req.headers);\n      }\n      next();\n    } catch (error) {\n      console.error(\"[SANITIZER] Input sanitization error:\", error);\n      res.status(400).json({\n        success: false,\n        error: \"Invalid input data\",\n        timestamp: new Date().toISOString()\n      });\n    }\n  }\n  // Sanitize entire object recursively\n  static sanitizeObject(obj, context = \"\") {\n    if (typeof obj !== \"object\" || obj === null) {\n      return obj;\n    }\n    if (Array.isArray(obj)) {\n      return obj.map((item, index) => InputSanitizer.sanitizeObject(item, `${context}[${index}]`));\n    }\n    const sanitized = {};\n    for (const [key, value] of Object.entries(obj)) {\n      const safeKey = String(key || \"\").replace(/[^a-zA-Z0-9_-]/g, \"\");\n      const sanitizedKey = InputSanitizer.sanitizeValue(safeKey, `key_${safeKey}`);\n      const fieldPath = context ? `${context}.${safeKey}` : safeKey;\n      sanitized[sanitizedKey] = InputSanitizer.sanitizeValue(value, fieldPath);\n    }\n    return sanitized;\n  }\n  // Sanitize HTTP headers\n  static sanitizeHeaders(headers) {\n    const sensitiveHeaders = [\"user-agent\", \"referer\", \"origin\", \"x-forwarded-for\"];\n    for (const [key, value] of Object.entries(headers)) {\n      const safeKey = String(key || \"\").toLowerCase();\n      if (sensitiveHeaders.includes(safeKey) && typeof value === \"string\") {\n        // Sanitize sensitive headers but preserve functionality\n        headers[key] = InputSanitizer.sanitizeValue(value, `header_${safeKey}`);\n      }\n    }\n  }\n  // Sanitize individual values based on their expected type\n  static sanitizeValue(value, fieldName = \"\") {\n    if (value === null || value === void 0) {\n      return value;\n    }\n    // Convert to string for processing\n    const stringValue = String(value);\n    // Check for potential security threats first\n    if (InputSanitizer.detectThreats(stringValue, fieldName)) {\n      // Silenced noisy sanitizer warnings per request; still sanitize by returning empty string\n      return \"\";\n    }\n    // Skip sanitization for certain field types that shouldn't be modified\n    const skipFields = [\"password\", \"currentPassword\", \"newPassword\", \"confirmPassword\", \"token\", \"secret\"];\n    if (skipFields.some(field => fieldName.toLowerCase().includes(field.toLowerCase()))) {\n      return value; // Return original value for sensitive fields\n    }\n    // Sanitize based on field name patterns\n    if (fieldName.toLowerCase().includes(\"email\")) {\n      const normalized = validator.normalizeEmail(stringValue);\n      return normalized && validator.isEmail(normalized) ? normalized : \"\";\n    }\n    if (fieldName.toLowerCase().includes(\"phone\") || fieldName.toLowerCase().includes(\"mobile\")) {\n      // Remove all non-digit characters for phone numbers and validate length\n      const cleaned = stringValue.replace(/\\D/g, \"\");\n      return cleaned.length >= 10 && cleaned.length <= 15 ? cleaned : \"\";\n    }\n    if (fieldName.toLowerCase().includes(\"url\") || fieldName.toLowerCase().includes(\"link\")) {\n      return InputSanitizer.validateAndSanitizeURL(stringValue);\n    }\n    if (fieldName.toLowerCase().includes(\"name\") || fieldName.toLowerCase().includes(\"title\")) {\n      // Allow only alphanumeric, spaces, hyphens, and apostrophes for names\n      return stringValue.replace(/[^a-zA-Z0-9\\s\\-']/g, \"\").trim();\n    }\n\n    if (fieldName.toLowerCase().includes(\"description\") ||\n        fieldName.toLowerCase().includes(\"comment\") ||\n        fieldName.toLowerCase().includes(\"message\") ||\n        fieldName.toLowerCase().includes(\"content\")) {\n      // For text content, use XSS sanitization and limit length\n      const sanitized = DOMPurify.sanitize(stringValue);\n      return sanitized.length > 5000 ? sanitized.substring(0, 5000) : sanitized;\n    }\n    if (fieldName.toLowerCase().includes(\"id\") || fieldName.toLowerCase().includes(\"uuid\")) {\n      // For ID fields, only allow alphanumeric and hyphens\n      return stringValue.replace(/[^a-zA-Z0-9-]/g, \"\");\n    }\n    // Default sanitization for other fields\n    return validator.escape(stringValue);\n  }\n  // Detect potential security threats\n  static detectThreats(value, _fieldName) {\n    const threats = [\n      // Script injection patterns\n      /<script[^>]*>.*?<\\/script>/gi,\n      /javascript:/gi,\n      /vbscript:/gi,\n      /onload\\s*=/gi,\n      /onerror\\s*=/gi,\n      /onclick\\s*=/gi,\n      // SQL injection patterns\n      /(\\b(union|select|insert|update|delete|drop|create|alter|exec|execute)\\b)/gi,\n      /(--|#|\\/\\*|\\*\\/)/g,\n      /(\\bor\\b\\s+\\d+\\s*=\\s*\\d+)/gi,\n      /(\\band\\b\\s+\\d+\\s*=\\s*\\d+)/gi,\n      // Command injection patterns\n      /[;&|`$()]/g,\n      /\\.\\.\\//g,\n      /\\.\\.\\\\/g,\n\n      // XSS patterns\n      /<iframe[^>]*>.*?<\\/iframe>/gi,\n      /<object[^>]*>.*?<\\/object>/gi,\n      /<embed[^>]*>.*?<\\/embed>/gi,\n      /<link[^>]*>.*?<\\/link>/gi,\n      /<meta[^>]*>.*?<\\/meta>/gi,\n\n      // Path traversal\n      /\\.\\.\\//g,\n      /\\.\\.\\\\/g,\n\n      // LDAP injection\n      /[()=*!&|]/g,\n\n      // NoSQL injection\n      /\\$where/gi,\n      /\\$ne/gi,\n      /\\$gt/gi,\n      /\\$lt/gi,\n      /\\$regex/gi\n    ];\n\n    return threats.some(pattern => pattern.test(value));\n  }\n\n  // Validation middleware for specific data types\n  static validateEmail(email) {\n    if (!email || typeof email !== \"string\") {\n      return { valid: false, error: \"Email is required\" };\n    }\n\n    if (!validator.isEmail(email)) {\n      return { valid: false, error: \"Invalid email format\" };\n    }\n\n    if (email.length > 254) {\n      return { valid: false, error: \"Email is too long\" };\n    }\n\n    return { valid: true };\n  }\n\n  static validatePhone(phone) {\n    if (!phone) {\n      return { valid: false, error: \"Phone number is required\" };\n    }\n\n    const digitsOnly = String(phone).replace(/\\D/g, \"\");\n\n    if (digitsOnly.length < 10 || digitsOnly.length > 15) {\n      return { valid: false, error: \"Phone number must be 10-15 digits\" };\n    }\n\n    return { valid: true, sanitized: digitsOnly };\n  }\n\n  static validatePassword(password) {\n    if (!password || typeof password !== \"string\") {\n      return { valid: false, error: \"Password is required\" };\n    }\n\n    if (password.length < 4) {\n      return { valid: false, error: \"Password must be at least 4 characters\" };\n    }\n\n    if (password.length > 128) {\n      return { valid: false, error: \"Password must not exceed 128 characters\" };\n    }\n\n    return { valid: true };\n  }\n\n  static validateName(name) {\n    if (!name || typeof name !== \"string\") {\n      return { valid: false, error: \"Name is required\" };\n    }\n\n    const trimmed = name.trim();\n\n    if (trimmed.length < 2) {\n      return { valid: false, error: \"Name must be at least 2 characters\" };\n    }\n\n    if (trimmed.length > 100) {\n      return { valid: false, error: \"Name must not exceed 100 characters\" };\n    }\n\n    // Check for potentially dangerous characters\n    if (!/^[a-zA-Z\\s-'.]+$/.test(trimmed)) {\n      return { valid: false, error: \"Name contains invalid characters\" };\n    }\n\n    return { valid: true, sanitized: trimmed };\n  }\n\n  static validateText(text, options = {}) {\n    const { minLength = 0, maxLength = 10000, required = false } = options;\n\n    if (required && (!text || typeof text !== \"string\")) {\n      return { valid: false, error: \"Text is required\" };\n    }\n\n    if (text && typeof text === \"string\") {\n      const trimmed = text.trim();\n\n      if (trimmed.length < minLength) {\n        return { valid: false, error: `Text must be at least ${minLength} characters` };\n      }\n      if (trimmed.length > maxLength) {\n        return { valid: false, error: `Text must not exceed ${maxLength} characters` };\n      }\n      return { valid: true, sanitized: trimmed };\n    }\n    return { valid: true, sanitized: text };\n  }\n  static validateNumber(number, options = {}) {\n    const { min = -Infinity, max = Infinity, integer = false, required = false } = options;\n    if (required && (number === null || number === void 0)) {\n      return { valid: false, error: \"Number is required\" };\n    }\n    if (number !== null && number !== void 0) {\n      const num = Number(number);\n      if (isNaN(num)) {\n        return { valid: false, error: \"Invalid number format\" };\n      }\n      if (integer && !Number.isInteger(num)) {\n        return { valid: false, error: \"Number must be an integer\" };\n      }\n      if (num < min) {\n        return { valid: false, error: `Number must be at least ${min}` };\n      }\n      if (num > max) {\n        return { valid: false, error: `Number must not exceed ${max}` };\n      }\n      return { valid: true, sanitized: num };\n    }\n    return { valid: true, sanitized: number };\n  }\n  static validateBoolean(bool, required = false) {\n    if (required && bool === null || bool === void 0) {\n      return { valid: false, error: \"Boolean value is required\" };\n    }\n    if (bool !== null && bool !== void 0) {\n\n      if (typeof bool === \"boolean\") {\n        return { valid: true, sanitized: bool };\n      }\n      if (typeof bool === \"string\") {\n        if ([\"true\", \"1\", \"yes\", \"on\"].includes(bool.toLowerCase())) {\n          return { valid: true, sanitized: true };\n        }\n        if ([\"false\", \"0\", \"no\", \"off\"].includes(bool.toLowerCase())) {\n          return { valid: true, sanitized: false };\n        }\n      }\n      return { valid: false, error: \"Invalid boolean value\" };\n    }\n    return { valid: true, sanitized: bool };\n  }\n  static validateURL(url, required = false) {\n    if (required && (!url || typeof url !== \"string\")) {\n      return { valid: false, error: \"URL is required\" };\n    }\n    if (url && typeof url === \"string\") {\n      const sanitized = InputSanitizer.validateAndSanitizeURL(url);\n      if (sanitized === \"\") {\n        return { valid: false, error: \"Invalid URL format or security risk detected\" };\n      }\n      return { valid: true, sanitized };\n    }\n    return { valid: true, sanitized: url };\n  }\n  // Request size validation middleware\n  static validateRequestSize(req, res, next) {\n    const maxSize = 10 * 1024 * 1024; // 10MB\n    if (req.headers[\"content-length\"] && parseInt(req.headers[\"content-length\"]) > maxSize) {\n      return res.status(413).json({\n        success: false,\n        error: \"Request too large\"\n      });\n    }\n    next();\n  }\n  // Enhanced SQL injection prevention\n  static preventSQLInjection(req, res, next) {\n    const sqlPatterns = [\n      /(\\b(union|select|insert|update|delete|drop|create|alter|exec|execute)\\b)/gi,\n      /(--|#|\\/\\*|\\*\\/)/g,\n      /(\\bor\\b\\s+\\d+\\s*=\\s*\\d+)/gi,\n      /(\\band\\b\\s+\\d+\\s*=\\s*\\d+)/gi,\n      /(\\b(load_file|into\\s+outfile|into\\s+dumpfile)\\b)/gi,\n      /(\\b(concat|group_concat|char|ascii|ord|hex|unhex)\\b)/gi,\n      /(\\b(benchmark|sleep|waitfor\\s+delay)\\b)/gi\n    ];\n\n    const checkForSQLInjection = (obj, path = \"\") => {\n\n      if (typeof obj === \"string\") {\n        const hasThreat = sqlPatterns.some(pattern => pattern.test(obj));\n        if (hasThreat) {\n          console.warn(`[SECURITY] SQL injection attempt detected in ${path}: ${obj.substring(0, 100)}...`);\n        }\n        return hasThreat;\n      }\n      if (typeof obj === \"object\" && obj !== null) {\n        return Object.entries(obj).some(([key, value]) =>\n          checkForSQLInjection(value, path ? `${path}.${key}` : key)\n        );\n      }\n      return false;\n    };\n    if (checkForSQLInjection(req.body, \"body\") ||\n        checkForSQLInjection(req.query, \"query\") ||\n        checkForSQLInjection(req.params, \"params\")) {\n      return res.status(400).json({\n        success: false,\n        error: \"Potentially malicious input detected\",\n        timestamp: new Date().toISOString(),\n        ip: req.ip\n      });\n    }\n    next();\n  }\n  // XSS prevention middleware\n  static preventXSS(req, res, next) {\n    const xssPatterns = [\n      /<script[^>]*>.*?<\\/script>/gi,\n      /javascript:/gi,\n      /vbscript:/gi,\n      /onload\\s*=/gi,\n      /onerror\\s*=/gi,\n      /onclick\\s*=/gi,\n      /onmouseover\\s*=/gi,\n      /onfocus\\s*=/gi,\n      /onblur\\s*=/gi,\n      /<iframe[^>]*>.*?<\\/iframe>/gi,\n      /<object[^>]*>.*?<\\/object>/gi,\n      /<embed[^>]*>.*?<\\/embed>/gi\n    ];\n    const checkForXSS = (obj, path = \"\") => {\n\n      if (typeof obj === \"string\") {\n        const hasThreat = xssPatterns.some(pattern => pattern.test(obj));\n        if (hasThreat) {\n          console.warn(`[SECURITY] XSS attempt detected in ${path}: ${obj.substring(0, 100)}...`);\n        }\n        return hasThreat;\n      }\n      if (typeof obj === \"object\" && obj !== null) {\n        return Object.entries(obj).some(([key, value]) =>\n          checkForXSS(value, path ? `${path}.${key}` : key)\n        );\n      }\n      return false;\n    };\n    if (checkForXSS(req.body, \"body\") ||\n        checkForXSS(req.query, \"query\") ||\n        checkForXSS(req.params, \"params\")) {\n      return res.status(400).json({\n        success: false,\n        error: \"Potentially malicious input detected\",\n        timestamp: new Date().toISOString(),\n        ip: req.ip\n      });\n    }\n    next();\n  }\n  // Rate limiting for specific endpoints\n  static createEndpointRateLimit(windowMs, maxRequests, message = \"Too many requests\") {\n    const requests = new Map();\n    return (req, res, next) => {\n      const key = `${req.ip}-${req.path}`;\n      const now = Date.now();\n      const _windowStart = now - windowMs;\n      // Clean up old entries\n      for (const [k, v] of requests.entries()) {\n        if (v.resetTime < now) {\n          requests.delete(k);\n        }\n      }\n      const userRequests = requests.get(key) || { count: 0, resetTime: now + windowMs };\n      if (userRequests.resetTime < now) {\n        userRequests.count = 0;\n        userRequests.resetTime = now + windowMs;\n      }\n      if (userRequests.count >= maxRequests) {\n        return res.status(429).json({\n          success: false,\n          error: message,\n          retryAfter: Math.ceil((userRequests.resetTime - now) / 1000)\n        });\n      }\n      userRequests.count++;\n      requests.set(key, userRequests);\n      next();\n    };\n  }\n  // Enhanced URL validation to protect against validator.js vulnerability\n  static validateAndSanitizeURL(urlString) {\n    if (!urlString || typeof urlString !== \"string\") {\n      return \"\";\n    }\n    const trimmedUrl = urlString.trim();\n    // First, use validator.js for basic validation (with known vulnerability)\n    if (!validator.isURL(trimmedUrl)) {\n      return \"\";\n    }\n    // Additional validation using native URL constructor to catch bypasses\n    try {\n      const url = new URL(trimmedUrl);\n      // Whitelist of allowed protocols\n      const allowedProtocols = [\"http:\", \"https:\", \"ftp:\", \"ftps:\"];\n      if (!allowedProtocols.includes(url.protocol)) {\n        console.warn(`[SECURITY] Disallowed protocol detected: ${url.protocol}`);\n        return \"\";\n      }\n      // Check for suspicious patterns that might bypass validation\n      const suspiciousPatterns = [\n        /javascript:/i,\n        /vbscript:/i,\n        /data:/i,\n        /file:/i,\n        /about:/i,\n        /chrome:/i,\n        /chrome-extension:/i,\n        /moz-extension:/i,\n        /ms-appx:/i,\n        /ms-appx-web:/i,\n        /blob:/i,\n        /ws:/i,\n        /wss:/i\n      ];\n      if (suspiciousPatterns.some(pattern => pattern.test(trimmedUrl))) {\n        console.warn(`[SECURITY] Suspicious URL pattern detected: ${trimmedUrl.substring(0, 100)}...`);\n        return \"\";\n      }\n      // Check for protocol confusion attacks (e.g., \"http:javascript:alert(1)\")\n      if (url.protocol !== `${trimmedUrl.split(\":\")[0]  }:`) {\n        console.warn(`[SECURITY] Protocol confusion detected: ${trimmedUrl.substring(0, 100)}...`);\n        return \"\";\n      }\n      // Validate hostname\n      if (!url.hostname || url.hostname.length === 0) {\n        return \"\";\n      }\n      // Check for IP addresses and validate them\n      // eslint-disable-next-line security/detect-unsafe-regex\n      const ipPattern = /^(\\d{1,3}\\.){3}\\d{1,3}$/;\n      if (ipPattern.test(url.hostname)) {\n        const parts = url.hostname.split(\".\");\n        for (const part of parts) {\n          const num = parseInt(part, 10);\n          if (num < 0 || num > 255) {\n            console.warn(`[SECURITY] Invalid IP address detected: ${url.hostname}`);\n            return \"\";\n          }\n        }\n      }\n      // Check for localhost and private IP ranges\n      const privateRanges = [\n        /^127\\./,\n        /^10\\./,\n        /^172\\.(1[6-9]|2[0-9]|3[0-1])\\./,\n        /^192\\.168\\./,\n        /^localhost$/i,\n        /^0\\.0\\.0\\.0$/,\n        /^::1$/,\n        /^fe80:/i\n      ];\n      if (privateRanges.some(range => range.test(url.hostname))) {\n        console.warn(`[SECURITY] Private/localhost URL detected: ${url.hostname}`);\n        return \"\";\n      }\n      // Return the sanitized URL\n      return validator.escape(trimmedUrl);\n    } catch (error) {\n      // If URL constructor fails, the URL is invalid\n      console.warn(`[SECURITY] Invalid URL format: ${trimmedUrl.substring(0, 100)}...`);\n      return \"\";\n    }\n  }\n  // Security audit logging\n  static logSecurityEvent(event, details, req) {\n    const _logEntry = {\n      timestamp: new Date().toISOString(),\n      event,\n      details,\n      ip: req?.ip,\n      userAgent: req?.get(\"User-Agent\"),\n      path: req?.path,\n      method: req?.method\n    };\n    // console.log removed for security\n  }\n}\n\nmodule.exports = InputSanitizer;\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\middleware\\rateLimiting.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\middleware\\security.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\middleware\\validation.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\models\\Complaint.js","messages":[{"ruleId":"no-undef","severity":2,"message":"'validPriorities' is not defined.","line":105,"column":27,"nodeType":"Identifier","messageId":"undef","endLine":105,"endColumn":42}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"class Complaint {\r\n  constructor(data = {}) {\r\n    this.id = data.id;\r\n    this.submitted_by = data.submitted_by;\r\n    this.title = data.title;\r\n    this.descriptive_su = data.descriptive_su;\r\n    this.location_text = data.location_text;\r\n    this.latitude = data.latitude;\r\n    this.longitude = data.longitude;\r\n    this.department_r = data.department_r || [];\r\n    this.preferred_departments = data.preferred_departments || [];\r\n    this.category = data.category;\r\n    this.subcategory = data.subcategory;\r\n    this.workflow_status = data.workflow_status || \"new\";\r\n    this.priority = data.priority || \"low\";\r\n    this.urgency_level = data.urgency_level || \"low\";\r\n    // Evidence is now handled separately - not stored in complaints table\r\n    // this.evidence = data.evidence || [];\r\n    // this.primary_department = data.primary_department; // Removed - derived from department_r\r\n    // this.secondary_departments = data.secondary_departments || []; // Removed - derived from department_r\r\n    this.assigned_coordinator_id = data.assigned_coordinator_id;\r\n    this.response_deadline = data.response_deadline;\r\n    this.citizen_satisfaction_rating = data.citizen_satisfaction_rating;\r\n    this.is_duplicate = data.is_duplicate || false;\r\n    this.master_complaint_id = data.master_complaint_id;\r\n    this.task_force_id = data.task_force_id;\r\n    this.coordinator_notes = data.coordinator_notes;\r\n    this.estimated_resolution_date = data.estimated_resolution_date;\r\n    this.submitted_at = data.submitted_at;\r\n    this.updated_at = data.updated_at;\r\n  }\r\n  static validate(data) {\r\n    const { isWithinDigosBoundary } = require(\"../../shared/boundaryValidator\");\r\n    const errors = [];\r\n    if (!data.title || data.title.trim().length < 5) {\r\n      errors.push(\"Title must be at least 5 characters\");\r\n    }\r\n    if (!data.descriptive_su || data.descriptive_su.trim().length < 10) {\r\n      errors.push(\"Description must be at least 10 characters\");\r\n    }\r\n    if (!data.location_text || data.location_text.trim().length < 5) {\r\n      errors.push(\"Location must be at least 5 characters\");\r\n    }\r\n    if (data.latitude && (data.latitude < -90 || data.latitude > 90)) {\r\n      errors.push(\"Invalid latitude value\");\r\n    }\r\n    if (data.longitude && (data.longitude < -180 || data.longitude > 180)) {\r\n      errors.push(\"Invalid longitude value\");\r\n    }\r\n    // Validate coordinates are within Digos City boundary\r\n    if (data.latitude && data.longitude) {\r\n      // Ensure coordinates are numbers (they might come as strings from form data)\r\n      const lat =\r\n        typeof data.latitude === \"string\"\r\n          ? parseFloat(data.latitude)\r\n          : data.latitude;\r\n      const lng =\r\n        typeof data.longitude === \"string\"\r\n          ? parseFloat(data.longitude)\r\n          : data.longitude;\r\n\r\n      // Check if parsing was successful\r\n      if (isNaN(lat) || isNaN(lng)) {\r\n        errors.push(\"Invalid coordinate values\");\r\n      } else {\r\n        const isValid = isWithinDigosBoundary(lat, lng);\r\n        if (!isValid) {\r\n          console.log(\"[COMPLAINT VALIDATION] Coordinates outside boundary:\", {\r\n            lat: \"[REDACTED]\",\r\n            lng: \"[REDACTED]\",\r\n            location_text: \"[REDACTED]\",\r\n            original_lat: \"[REDACTED]\",\r\n            original_lng: \"[REDACTED]\",\r\n          });\r\n          errors.push(\r\n            \"Complaint location must be within Digos City boundaries\"\r\n          );\r\n        }\r\n      }\r\n    }\r\n    const validStatuses = [\r\n      \"pending review\",\r\n      \"in progress\",\r\n      \"resolved\",\r\n      \"closed\",\r\n      \"rejected\",\r\n    ];\r\n    if (data.status && !validStatuses.includes(data.status)) {\r\n      errors.push(\"Invalid status\");\r\n    }\r\n    const validWorkflowStatuses = [\r\n      \"new\",\r\n      \"assigned\",\r\n      \"in_progress\",\r\n      \"pending_approval\",\r\n      \"completed\",\r\n      \"cancelled\",\r\n    ];\r\n    if (\r\n      data.workflow_status &&\r\n      !validWorkflowStatuses.includes(data.workflow_status)\r\n    ) {\r\n      errors.push(\"Invalid workflow status\");\r\n    }\r\n    if (data.priority && !validPriorities.includes(data.priority)) {\r\n      errors.push(\"Invalid priority\");\r\n    }\r\n    const validUrgencies = [\"low\", \"medium\", \"high\", \"urgent\"];\r\n    if (data.urgency_level && !validUrgencies.includes(data.urgency_level)) {\r\n      errors.push(\"Invalid urgency level\");\r\n    }\r\n    return {\r\n      isValid: errors.length === 0,\r\n      errors,\r\n    };\r\n  }\r\n  sanitizeForInsert() {\r\n    return {\r\n      submitted_by: this.submitted_by,\r\n      title: this.title?.trim(),\r\n      descriptive_su: this.descriptive_su?.trim(),\r\n      location_text: this.location_text?.trim(),\r\n      latitude: this.latitude ? parseFloat(this.latitude) : null,\r\n      longitude: this.longitude ? parseFloat(this.longitude) : null,\r\n      department_r: Array.isArray(this.department_r) ? this.department_r : [],\r\n      preferred_departments: Array.isArray(this.preferred_departments)\r\n        ? this.preferred_departments\r\n        : [],\r\n      category: this.category,\r\n      subcategory: this.subcategory,\r\n      workflow_status: this.workflow_status || \"new\",\r\n      priority: this.priority || \"low\",\r\n      urgency_level: this.urgency_level || \"low\",\r\n      assigned_coordinator_id: this.assigned_coordinator_id || null,\r\n      response_deadline: this.response_deadline || null,\r\n      submitted_at: this.submitted_at || new Date().toISOString(),\r\n    };\r\n  }\r\n  toJSON() {\r\n    return {\r\n      id: this.id,\r\n      submitted_by: this.submitted_by,\r\n      title: this.title,\r\n      descriptive_su: this.descriptive_su,\r\n      location_text: this.location_text,\r\n      latitude: this.latitude,\r\n      longitude: this.longitude,\r\n      department_r: this.department_r,\r\n      preferred_departments: this.preferred_departments,\r\n      category: this.category,\r\n      subcategory: this.subcategory,\r\n      workflow_status: this.workflow_status,\r\n      priority: this.priority,\r\n      urgency_level: this.urgency_level,\r\n      assigned_coordinator_id: this.assigned_coordinator_id,\r\n      response_deadline: this.response_deadline,\r\n      citizen_satisfaction_rating: this.citizen_satisfaction_rating,\r\n      is_duplicate: this.is_duplicate,\r\n      master_complaint_id: this.master_complaint_id,\r\n      task_force_id: this.task_force_id,\r\n      coordinator_notes: this.coordinator_notes,\r\n      estimated_resolution_date: this.estimated_resolution_date,\r\n      submitted_at: this.submitted_at,\r\n      updated_at: this.updated_at,\r\n    };\r\n  }\r\n}\r\n\r\nmodule.exports = Complaint;\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\models\\Department.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\models\\Profile.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\models\\Setting.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\repositories\\AuditLogRepository.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\repositories\\ComplaintAssignmentRepository.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\repositories\\ComplaintHistoryRepository.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\repositories\\ComplaintRepository.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\repositories\\CoordinatorRepository.js","messages":[{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":126,"column":17,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":126,"endColumn":52}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Database = require(\"../config/database\");\r\n\r\n/**\r\n * CoordinatorRepository\r\n * Database operations for coordinator functions\r\n */\r\nclass CoordinatorRepository {\r\n\r\n  constructor() {\r\n    this.db = new Database();\r\n    this.supabase = this.db.getClient();\r\n  }\r\n  /**\r\n   * Get review queue for coordinator\r\n   * Returns complaints pending coordinator review\r\n   */\r\n  async getReviewQueue(coordinatorId, filters = {}) {\r\n    try {\r\n      // console.log removed for security\r\n      // console.log removed for security\r\n      // Look for complaints that need coordinator review:\r\n      // 1. New complaints (workflow_status = 'new')\r\n      // 2. Complaints assigned to this coordinator but not yet processed\r\n      let query = this.supabase\r\n        .from(\"complaints\")\r\n        .select(`\r\n          *,\r\n          assigned_coordinator_id\r\n        `)\r\n        .eq(\"workflow_status\", \"new\")\r\n        .order(\"submitted_at\", { ascending: false });\r\n      // Apply filters\r\n      if (filters.priority) {\r\n        query = query.eq(\"priority\", filters.priority);\r\n      }\r\n      if (filters.type) {\r\n        query = query.eq(\"type\", filters.type);\r\n      }\r\n      if (filters.hasAlgorithmResults !== void 0) {\r\n        // Filter complaints with/without similarity results\r\n        // This would need a custom function or post-processing\r\n      }\r\n      const { data, error } = await query.limit(filters.limit || 50);\r\n      // console.log removed for security\r\n      if (error) throw error;\r\n      // Fetch user information separately for each complaint\r\n      const complaints = data || [];\r\n      // Get unique user IDs\r\n      const userIds = [...new Set(complaints.map(c => c.submitted_by).filter(Boolean))];\r\n      // Fetch user details from auth.users\r\n      const usersMap = {};\r\n      if (userIds.length > 0) {\r\n        try {\r\n          const { data: authUsers, error: usersError } = await this.supabase.auth.admin.listUsers();\r\n          if (!usersError && authUsers?.users) {\r\n            authUsers.users\r\n              .filter(u => userIds.includes(u.id))\r\n              .forEach(user => {\r\n                usersMap[user.id] = {\r\n                  email: user.email,\r\n                  name: user.user_metadata?.name || user.email,\r\n                  metadata: user.user_metadata\r\n                };\r\n              });\r\n          } else {\r\n            console.warn(\"[COORDINATOR_REPO] Could not fetch user profiles:\", usersError?.message);\r\n          }\r\n        } catch (userFetchError) {\r\n          console.warn(\"[COORDINATOR_REPO] Error fetching user profiles:\", userFetchError.message);\r\n          // Continue without user profiles - complaints will have null submitted_by_profile\r\n        }\r\n      }\r\n      // Attach user info to complaints\r\n      return complaints.map(complaint => ({\r\n        ...complaint,\r\n        submitted_by_profile: usersMap[complaint.submitted_by] || null\r\n      }));\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_REPO] Get review queue error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Get complaint with full details including algorithm results\r\n   */\r\n  async getComplaintForReview(complaintId) {\r\n    try {\r\n      const { data: complaint, error: complaintError } = await this.supabase\r\n        .from(\"complaints\")\r\n        .select(\"*\")\r\n        .eq(\"id\", complaintId)\r\n        .single();\r\n      if (complaintError) throw complaintError;\r\n      // Fetch submitter info from auth.users\r\n      if (complaint && complaint.submitted_by) {\r\n        const { data: submitter } = await this.supabase.auth.admin.getUserById(complaint.submitted_by);\r\n        if (submitter?.user) {\r\n          complaint.submitted_by_profile = {\r\n            id: submitter.user.id,\r\n            email: submitter.user.email,\r\n            name: submitter.user.user_metadata?.name || submitter.user.email,\r\n            raw_user_meta_data: submitter.user.user_metadata\r\n          };\r\n        }\r\n      }\r\n      // Get evidence files\r\n      const { data: evidence, error: evidenceError } = await this.supabase\r\n        .from(\"complaint_evidence\")\r\n        .select(\"*\")\r\n        .eq(\"complaint_id\", complaintId)\r\n        .order(\"uploaded_at\", { ascending: false });\r\n      if (evidenceError) {\r\n        console.warn(\"[COORDINATOR_REPO] Could not fetch evidence:\", evidenceError.message);\r\n        complaint.evidence = [];\r\n      } else {\r\n        // Transform evidence data for frontend\r\n        complaint.evidence = await Promise.all((evidence || []).map(async (ev) => {\r\n          let signedUrl = null;\r\n          // Generate signed URL for private bucket access\r\n          if (ev.file_path) {\r\n            try {\r\n              const { data: signedUrlData, error: signedUrlError } = await this.supabase.storage\r\n                .from(\"complaint-evidence\")\r\n                .createSignedUrl(ev.file_path, 3600); // 1 hour expiry\r\n              if (!signedUrlError && signedUrlData) {\r\n                signedUrl = signedUrlData.signedUrl;\r\n              }\r\n            } catch (urlError) {\r\n              console.warn(\"[COORDINATOR_REPO] Failed to generate signed URL for evidence:\", urlError.message);\r\n            }\r\n          }\r\n          return {\r\n            id: ev.id,\r\n            fileName: ev.file_name,\r\n            filePath: ev.file_path,\r\n            fileType: ev.file_type,\r\n            fileSize: ev.file_size,\r\n            mimeType: ev.mime_type,\r\n            uploadedAt: ev.uploaded_at,\r\n            isPublic: ev.is_public,\r\n            // Use signed URL for private bucket access\r\n            publicUrl: signedUrl\r\n          };\r\n        }));\r\n      }\r\n      // Get similarities\r\n      const { data: similarities, error: simError } = await this.supabase\r\n        .from(\"complaint_similarities\")\r\n        .select(\"*\")\r\n        .eq(\"complaint_id\", complaintId)\r\n        .order(\"similarity_score\", { ascending: false });\r\n      if (simError) throw simError;\r\n      // Fetch similar complaint details separately\r\n      if (similarities && similarities.length > 0) {\r\n        const similarComplaintIds = similarities.map(s => s.similar_complaint_id).filter(Boolean);\r\n        if (similarComplaintIds.length > 0) {\r\n          const { data: similarComplaints } = await this.supabase\r\n            .from(\"complaints\")\r\n            .select(\"id, title, type, workflow_status, submitted_at, location_text, latitude, longitude\")\r\n            .in(\"id\", similarComplaintIds);\r\n          // Create a map for quick lookup\r\n          const complaintsMap = {};\r\n          (similarComplaints || []).forEach(c => {\r\n            complaintsMap[c.id] = c;\r\n          });\r\n          // Attach complaint details to each similarity\r\n          similarities.forEach(sim => {\r\n            sim.similar_complaint = complaintsMap[sim.similar_complaint_id] || null;\r\n          });\r\n        }\r\n      }\r\n      // Get workflow logs\r\n      const { data: logs, error: logsError } = await this.supabase\r\n        .from(\"complaint_workflow_logs\")\r\n        .select(\"*\")\r\n        .eq(\"complaint_id\", complaintId)\r\n        .order(\"created_at\", { ascending: false });\r\n      if (logsError) throw logsError;\r\n      return {\r\n        ...complaint,\r\n        similarities: similarities || [],\r\n        workflow_logs: logs || []\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_REPO] Get complaint for review error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Mark complaint as duplicate\r\n   */\r\n  async markAsDuplicate(complaintId, masterComplaintId, coordinatorId, reason) {\r\n    try {\r\n      // Update complaint\r\n      const { error: updateError } = await this.supabase\r\n        .from(\"complaints\")\r\n        .update({\r\n          is_duplicate: true,\r\n          master_complaint_id: masterComplaintId,\r\n          status: \"closed\",\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq(\"id\", complaintId);\r\n      if (updateError) throw updateError;\r\n      // Insert duplicate record\r\n      const { error: insertError } = await this.supabase\r\n        .from(\"complaint_duplicates\")\r\n        .insert({\r\n          master_complaint_id: masterComplaintId,\r\n          duplicate_complaint_id: complaintId,\r\n          merged_by: coordinatorId,\r\n          merge_reason: reason,\r\n          merged_at: new Date().toISOString()\r\n        });\r\n      if (insertError) throw insertError;\r\n      // Log action\r\n      await this.logAction(complaintId, \"marked_duplicate\", coordinatorId, {\r\n        master_complaint_id: masterComplaintId,\r\n        reason\r\n      });\r\n      return true;\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_REPO] Mark as duplicate error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Update similarity decision\r\n   */\r\n  async updateSimilarityDecision(similarityId, decision, coordinatorId) {\r\n    try {\r\n      const { error } = await this.supabase\r\n        .from(\"complaint_similarities\")\r\n        .update({\r\n          coordinator_decision: decision,\r\n          reviewed_by: coordinatorId,\r\n          reviewed_at: new Date().toISOString()\r\n        })\r\n        .eq(\"id\", similarityId);\r\n      if (error) throw error;\r\n      return true;\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_REPO] Update similarity decision error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Assign complaint to department\r\n   */\r\n  async assignToDepartment(complaintId, departmentName, coordinatorId, options = {}) {\r\n    try {\r\n      const updateData = {\r\n        // primary_department: departmentName, // Removed - derived from department_r\r\n        // status: 'in progress', // Removed - derived from workflow_status\r\n        workflow_status: \"assigned\",\r\n        updated_at: new Date().toISOString()\r\n      };\r\n      if (options.priority) {\r\n        updateData.priority = options.priority;\r\n      }\r\n      if (options.deadline) {\r\n        updateData.response_deadline = options.deadline;\r\n      }\r\n      if (options.notes) {\r\n        updateData.coordinator_notes = options.notes;\r\n      }\r\n      const { data, error } = await this.supabase\r\n        .from(\"complaints\")\r\n        .update(updateData)\r\n        .eq(\"id\", complaintId)\r\n        .select()\r\n        .single();\r\n      if (error) throw error;\r\n      // Log action\r\n      await this.logAction(complaintId, \"assigned_to_department\", coordinatorId, {\r\n        department: departmentName,\r\n        priority: options.priority,\r\n        deadline: options.deadline\r\n      });\r\n      return data;\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_REPO] Assign to department error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Bulk assign complaints\r\n   */\r\n  async bulkAssign(complaintIds, departmentName, coordinatorId) {\r\n    try {\r\n      const { data, error } = await this.supabase\r\n        .from(\"complaints\")\r\n        .update({\r\n          // primary_department: departmentName, // Removed - derived from department_r\r\n          // status: 'in progress', // Removed - derived from workflow_status\r\n          workflow_status: \"assigned\",\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .in(\"id\", complaintIds)\r\n        .select();\r\n      if (error) throw error;\r\n      // Log actions\r\n      for (const complaintId of complaintIds) {\r\n        await this.logAction(complaintId, \"bulk_assigned\", coordinatorId, {\r\n          department: departmentName\r\n        });\r\n      }\r\n      return data;\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_REPO] Bulk assign error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Get active clusters\r\n   */\r\n  async getActiveClusters(filters = {}) {\r\n    try {\r\n      let query = this.supabase\r\n        .from(\"complaint_clusters\")\r\n        .select(\"*\")\r\n        .eq(\"status\", \"active\")\r\n        .order(\"identified_at\", { ascending: false });\r\n      if (filters.patternType) {\r\n        query = query.eq(\"pattern_type\", filters.patternType);\r\n      }\r\n      const { data, error } = await query.limit(filters.limit || 20);\r\n      if (error) {\r\n        // If table doesn't exist, return empty array instead of failing\r\n        if (error.code === \"PGRST116\" || error.message.includes(\"does not exist\")) {\r\n          console.warn(\"[COORDINATOR_REPO] Clusters table not available\");\r\n          return [];\r\n        }\r\n        throw error;\r\n      }\r\n      return data || [];\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_REPO] Get clusters error:\", error);\r\n      // Return empty array instead of crashing the dashboard\r\n      return [];\r\n    }\r\n  }\r\n  /**\r\n   * Log workflow action\r\n   */\r\n  async logAction(complaintId, actionType, actionBy, details = {}) {\r\n    try {\r\n      const { error } = await this.supabase\r\n        .from(\"complaint_workflow_logs\")\r\n        .insert({\r\n          complaint_id: complaintId,\r\n          action_type: actionType,\r\n          action_by: actionBy,\r\n          details,\r\n          created_at: new Date().toISOString()\r\n        });\r\n      if (error) throw error;\r\n      return true;\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_REPO] Log action error:\", error);\r\n      // Don't throw - logging shouldn't break main flow\r\n      return false;\r\n    }\r\n  }\r\n  /**\r\n   * Check if user is coordinator\r\n   */\r\n  async isCoordinator(userId) {\r\n    try {\r\n      const { data, error } = await this.supabase\r\n        .from(\"complaint_coordinators\")\r\n        .select(\"id, department\")\r\n        .eq(\"user_id\", userId)\r\n        .eq(\"is_active\", true);\r\n      if (error) throw error;\r\n      return {\r\n        isCoordinator: data && data.length > 0,\r\n        departments: data ? data.map(d => d.department) : []\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_REPO] Check coordinator error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Get pending reviews count\r\n   */\r\n  async getPendingReviewsCount(_coordinatorId) {\r\n    try {\r\n      // console.log removed for security\r\n      const { count, error } = await this.supabase\r\n        .from(\"complaints\")\r\n        .select(\"*\", { count: \"exact\", head: true })\r\n        .eq(\"workflow_status\", \"new\");\r\n      if (error) {\r\n        console.error(\"[COORDINATOR_REPO] Pending count error:\", error);\r\n        throw error;\r\n      }\r\n      // console.log removed for security\r\n      return count || 0;\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_REPO] Get pending count error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Get coordinator statistics\r\n   */\r\n  async getCoordinatorStats(coordinatorId, startDate, endDate) {\r\n    try {\r\n      // console.log removed for security\r\n      // console.log removed for security\r\n      // Get complaints that this coordinator can review (new complaints)\r\n      const { data: reviewableComplaints, error: reviewError } = await this.supabase\r\n        .from(\"complaints\")\r\n        .select(\"*\")\r\n        .eq(\"workflow_status\", \"new\")\r\n        .gte(\"submitted_at\", startDate)\r\n        .lte(\"submitted_at\", endDate);\r\n      if (reviewError) {\r\n        console.error(\"[COORDINATOR_REPO] Reviewable complaints error:\", reviewError);\r\n        throw reviewError;\r\n      }\r\n      // console.log removed for security\r\n      // Count by workflow status\r\n      const statusCounts = (reviewableComplaints || []).reduce((acc, complaint) => {\r\n        const status = complaint.workflow_status || \"unknown\";\r\n        acc[status] = (acc[status] || 0) + 1;\r\n        return acc;\r\n      }, {});\r\n      // console.log removed for security\r\n      // Get duplicate decisions made by this coordinator\r\n      const { data: duplicates, error: dupError } = await this.supabase\r\n        .from(\"complaint_similarities\")\r\n        .select(\"*\")\r\n        .eq(\"reviewed_by\", coordinatorId)\r\n        .eq(\"coordinator_decision\", \"duplicate\")\r\n        .gte(\"reviewed_at\", startDate)\r\n        .lte(\"reviewed_at\", endDate);\r\n      if (dupError) {\r\n        console.error(\"[COORDINATOR_REPO] Duplicates error:\", dupError);\r\n        throw dupError;\r\n      }\r\n      // console.log removed for security\r\n      // Get assignments made by this coordinator (from workflow logs or assignment records)\r\n      const { data: assignments, error: assignError } = await this.supabase\r\n        .from(\"complaint_assignments\")\r\n        .select(\"*\")\r\n        .eq(\"assigned_by\", coordinatorId)\r\n        .gte(\"created_at\", startDate)\r\n        .lte(\"created_at\", endDate);\r\n      if (assignError) {\r\n        console.error(\"[COORDINATOR_REPO] Assignments error:\", assignError);\r\n        throw assignError;\r\n      }\r\n      // console.log removed for security\r\n      const result = {\r\n        total_reviews: reviewableComplaints?.length || 0,\r\n        duplicates_merged: duplicates?.length || 0,\r\n        assignments_made: assignments?.length || 0,\r\n        status_breakdown: statusCounts\r\n      };\r\n      // console.log removed for security\r\n      return result;\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_REPO] Get stats error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = CoordinatorRepository;\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\repositories\\DepartmentRepository.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\repositories\\ProfileRepository.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\repositories\\SettingRepository.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\authRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\captchaRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\complaintRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\complianceRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\contentRoutes.js","messages":[{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":85,"column":13,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":85,"endColumn":83}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const express = require(\"express\");\r\nconst Database = require(\"../config/database\");\r\nconst { authenticateUser, requireRole } = require(\"../middleware/auth\");\r\n\r\nconst router = express.Router();\r\n// ============================================================================\r\n// NEWS ROUTES\r\n// ============================================================================\r\n// GET /api/content/news - Get all published news\r\nrouter.get(\"/news\", async (req, res) => {\r\n  try {\r\n    const { limit = 10, offset = 0, category, from, to, office, status } = req.query;\r\n    let query = Database.getClient()\r\n      .from(\"news\")\r\n      .select(\"*\")\r\n      .eq(\"status\", status || \"published\")\r\n      .order(\"published_at\", { ascending: false })\r\n      .range(offset, offset + limit - 1);\r\n    if (category) query = query.eq(\"category\", category);\r\n    // map office -> category for filtering\r\n    if (office) query = query.eq(\"category\", office);\r\n    if (from) query = query.gte(\"published_at\", from);\r\n    if (to) query = query.lte(\"published_at\", to);\r\n    const { data, error } = await query;\r\n    if (error) throw error;\r\n    return res.json({\r\n      success: true,\r\n      data,\r\n      count: data.length\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching news:\", error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: \"Failed to fetch news\"\r\n    });\r\n  }\r\n});\r\n// GET /api/content/news/:id - Get single news article\r\nrouter.get(\"/news/:id\", async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { data, error } = await Database.getClient()\r\n      .from(\"news\")\r\n      .select(\"*\")\r\n      .eq(\"id\", id)\r\n      .eq(\"status\", \"published\")\r\n      .single();\r\n    if (error) throw error;\r\n    if (!data) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"News article not found\"\r\n      });\r\n    }\r\n    return res.json({\r\n      success: true,\r\n      data\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching news article:\", error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: \"Failed to fetch news article\"\r\n    });\r\n  }\r\n});\r\n// POST /api/content/news - Create news (admin only)\r\nrouter.post(\"/news\", authenticateUser, requireRole([\"lgu-admin\"]), async (req, res) => {\r\n  try {\r\n    const { title, content, excerpt, image_url, category, tags, status } = req.body;\r\n    if (!title || !content) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"Title and content are required\"\r\n      });\r\n    }\r\n    // Convert empty strings to null for optional fields\r\n    const newsData = {\r\n      title: title.trim(),\r\n      content: content.trim(),\r\n      excerpt: excerpt?.trim() || null,\r\n      image_url: image_url?.trim() || null,\r\n      category: category?.trim() || null,\r\n      tags: Array.isArray(tags) && tags.length > 0 ? tags : (tags ? [tags] : \"{}\"),\r\n      status: status || \"published\",\r\n      published_at: status === \"published\" ? new Date().toISOString() : null,\r\n      author_id: req.user?.id\r\n    };\r\n    // console.log removed for security\r\n    const dbClient = Database.getClient();\r\n    const { data, error } = await dbClient\r\n      .from(\"news\")\r\n      .insert([newsData])\r\n      .select();\r\n    if (error) {\r\n      console.error(\"[CONTENT] Database error inserting news:\", error);\r\n      console.error(\"[CONTENT] Error code:\", error.code);\r\n      console.error(\"[CONTENT] Error message:\", error.message);\r\n      console.error(\"[CONTENT] Error details:\", error.details);\r\n      console.error(\"[CONTENT] Error hint:\", error.hint);\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: \"Failed to create news\",\r\n        details: error.message || error.code || \"Database error\",\r\n        code: error.code,\r\n        hint: error.hint\r\n      });\r\n    }\r\n    if (!data || data.length === 0) {\r\n      console.error(\"[CONTENT] Insert succeeded but no data returned\");\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: \"Failed to create news\",\r\n        details: \"Insert operation returned no data\"\r\n      });\r\n    }\r\n    const insertedNews = data[0];\r\n    // console.log removed for security\r\n    return res.json({\r\n      success: true,\r\n      data: insertedNews\r\n    });\r\n  } catch (error) {\r\n    console.error(\"[CONTENT] Error creating news:\", error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: \"Failed to create news\",\r\n      details: error.message || error.code || \"Unknown error\"\r\n    });\r\n  }\r\n});\r\n// ============================================================================\r\n// EVENTS ROUTES\r\n// ============================================================================\r\n// GET /api/content/events - Get upcoming events\r\nrouter.get(\"/events\", async (req, res) => {\r\n  try {\r\n    const { limit = 10, offset = 0, status = \"upcoming\", from, to, office } = req.query;\r\n    const { data, error } = await Database.getClient()\r\n      .from(\"events\")\r\n      .select(\"*\")\r\n      .in(\"status\", status.split(\",\"))\r\n      .gte(\"event_date\", from || new Date(0).toISOString())\r\n      .lte(\"event_date\", to || \"9999-12-31T23:59:59.999Z\")\r\n      .order(\"event_date\", { ascending: true })\r\n      .range(offset, offset + limit - 1);\r\n    if (office) {\r\n      // Filter by organizer as office proxy\r\n      const filtered = (data || []).filter(e => (e.organizer || \"\").toLowerCase() === String(office).toLowerCase());\r\n      return res.json({ success: true, data: filtered, count: filtered.length });\r\n    }\r\n    if (error) throw error;\r\n    return res.json({\r\n      success: true,\r\n      data,\r\n      count: data.length\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching events:\", error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: \"Failed to fetch events\"\r\n    });\r\n  }\r\n});\r\n// GET /api/content/events/:id - Get single event\r\nrouter.get(\"/events/:id\", async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { data, error } = await Database.getClient()\r\n      .from(\"events\")\r\n      .select(\"*\")\r\n      .eq(\"id\", id)\r\n      .single();\r\n    if (error) throw error;\r\n    if (!data) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Event not found\"\r\n      });\r\n    }\r\n    return res.json({\r\n      success: true,\r\n      data\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching event:\", error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: \"Failed to fetch event\"\r\n    });\r\n  }\r\n});\r\n// POST /api/content/events - Create event (admin only)\r\nrouter.post(\"/events\", authenticateUser, requireRole([\"lgu-admin\"]), async (req, res) => {\r\n  try {\r\n    const {\r\n      title,\r\n      description,\r\n      location,\r\n      event_date,\r\n      end_date,\r\n      image_url,\r\n      organizer,\r\n      category,\r\n      tags,\r\n      max_participants,\r\n      registration_required\r\n    } = req.body;\r\n    if (!title || !description || !event_date) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"Title, description, and event date are required\"\r\n      });\r\n    }\r\n    // Convert empty strings to null for optional fields\r\n    const eventData = {\r\n      title: title.trim(),\r\n      description: description.trim(),\r\n      location: location?.trim() || null,\r\n      event_date,\r\n      end_date: end_date || null,\r\n      image_url: image_url?.trim() || null,\r\n      organizer: organizer?.trim() || null,\r\n      category: category?.trim() || null,\r\n      tags: tags || null,\r\n      max_participants: max_participants || null,\r\n      registration_required: registration_required || false,\r\n      status: \"upcoming\",\r\n      created_by: req.user?.id\r\n    };\r\n    // console.log removed for security\r\n    const dbClient = Database.getClient();\r\n    const { data, error } = await dbClient\r\n      .from(\"events\")\r\n      .insert([eventData])\r\n      .select();\r\n    if (error) {\r\n      console.error(\"[CONTENT] Database error inserting event:\", error);\r\n      console.error(\"[CONTENT] Error code:\", error.code);\r\n      console.error(\"[CONTENT] Error message:\", error.message);\r\n      throw error;\r\n    }\r\n    if (!data || data.length === 0) {\r\n      console.error(\"[CONTENT] Insert succeeded but no data returned\");\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: \"Failed to create event\",\r\n        details: \"Insert operation returned no data\"\r\n      });\r\n    }\r\n    const insertedEvent = data[0];\r\n    // console.log removed for security\r\n    return res.json({\r\n      success: true,\r\n      data: insertedEvent\r\n    });\r\n  } catch (error) {\r\n    console.error(\"[CONTENT] Error creating event:\", error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: \"Failed to create event\",\r\n      details: error.message || error.code || \"Unknown error\"\r\n    });\r\n  }\r\n});\r\n// ============================================================================\r\n// NOTICES ROUTES\r\n// ============================================================================\r\n// GET /api/content/notices - Get active notices\r\nrouter.get(\"/notices\", async (req, res) => {\r\n  try {\r\n    const { limit = 10, offset = 0, priority, from, to, office, status = \"active\" } = req.query;\r\n    let query = Database.getClient()\r\n      .from(\"notices\")\r\n      .select(\"*\")\r\n      .eq(\"status\", status)\r\n      .or(`valid_until.is.null,valid_until.gte.${new Date().toISOString()}`)\r\n      .order(\"priority\", { ascending: false })\r\n      .order(\"valid_from\", { ascending: false })\r\n      .range(offset, offset + limit - 1);\r\n    if (priority) query = query.eq(\"priority\", priority);\r\n    if (office) query = query.eq(\"type\", office);\r\n    if (from) query = query.gte(\"created_at\", from);\r\n    if (to) query = query.lte(\"created_at\", to);\r\n    const { data, error } = await query;\r\n    if (error) throw error;\r\n    return res.json({\r\n      success: true,\r\n      data,\r\n      count: data.length\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching notices:\", error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: \"Failed to fetch notices\"\r\n    });\r\n  }\r\n});\r\n// GET /api/content/notices/:id - Get single notice\r\nrouter.get(\"/notices/:id\", async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { data, error } = await Database.getClient()\r\n      .from(\"notices\")\r\n      .select(\"*\")\r\n      .eq(\"id\", id)\r\n      .single();\r\n    if (error) throw error;\r\n    if (!data) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Notice not found\"\r\n      });\r\n    }\r\n    return res.json({\r\n      success: true,\r\n      data\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching notice:\", error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: \"Failed to fetch notice\"\r\n    });\r\n  }\r\n});\r\n// POST /api/content/notices - Create notice (admin only)\r\nrouter.post(\"/notices\", authenticateUser, requireRole([\"lgu-admin\"]), async (req, res) => {\r\n  try {\r\n    const {\r\n      title,\r\n      content,\r\n      priority,\r\n      type,\r\n      target_audience,\r\n      image_url,\r\n      valid_from,\r\n      valid_until\r\n    } = req.body;\r\n    if (!title || !content) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"Title and content are required\"\r\n      });\r\n    }\r\n    // Convert empty strings to null for optional fields\r\n    const noticeData = {\r\n      title: title.trim(),\r\n      content: content.trim(),\r\n      priority: priority || \"normal\",\r\n      type: type?.trim() || null,\r\n      target_audience: target_audience || null,\r\n      image_url: image_url?.trim() || null,\r\n      valid_from: valid_from || new Date().toISOString(),\r\n      valid_until: valid_until || null,\r\n      status: \"active\",\r\n      created_by: req.user?.id\r\n    };\r\n    // console.log removed for security\r\n    const dbClient = Database.getClient();\r\n    const { data, error } = await dbClient\r\n      .from(\"notices\")\r\n      .insert([noticeData])\r\n      .select();\r\n    if (error) {\r\n      console.error(\"[CONTENT] Database error inserting notice:\", error);\r\n      console.error(\"[CONTENT] Error code:\", error.code);\r\n      console.error(\"[CONTENT] Error message:\", error.message);\r\n      console.error(\"[CONTENT] Error details:\", error.details);\r\n      throw error;\r\n    }\r\n    if (!data || data.length === 0) {\r\n      console.error(\"[CONTENT] Insert succeeded but no data returned\");\r\n      // Try to query the notices table to verify insert\r\n      const { data: _verifyData, error: verifyError } = await dbClient\r\n        .from(\"notices\")\r\n        .select(\"*\")\r\n        .eq(\"title\", noticeData.title)\r\n        .eq(\"created_by\", noticeData.created_by)\r\n        .order(\"created_at\", { ascending: false })\r\n        .limit(1);\r\n      // console.log removed for security\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: \"Failed to create notice\",\r\n        details: `Insert operation returned no data. Verification query: ${  verifyError ? verifyError.message : \"No matching record found\"}`\r\n      });\r\n    }\r\n    const insertedNotice = data[0];\r\n    // console.log removed for security\r\n    return res.json({\r\n      success: true,\r\n      data: insertedNotice\r\n    });\r\n  } catch (error) {\r\n    console.error(\"[CONTENT] Error creating notice:\", error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: \"Failed to create notice\",\r\n      details: error.message || error.code || \"Unknown error\"\r\n    });\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\coordinatorRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\departmentRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\departmentStructureRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\healthRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\hrRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\lguAdminRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\lguOfficerRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\notificationRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\ocrRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\officeConfirmationRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\pages.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\publicApiRoutes.js","messages":[],"suppressedMessages":[{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found readFile from package \"fs\" with non literal argument at index 0","line":16,"column":28,"nodeType":"CallExpression","endLine":16,"endColumn":57,"suppressions":[{"kind":"directive","justification":"Safe: reading static asset file with hardcoded path"}]},{"ruleId":"security/detect-non-literal-fs-filename","severity":1,"message":"Found readFile from package \"fs\" with non literal argument at index 0","line":30,"column":28,"nodeType":"CallExpression","endLine":30,"endColumn":57,"suppressions":[{"kind":"directive","justification":"Safe: reading static asset file with hardcoded path"}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\rateLimitRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\sessionRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\settingRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\storageRoutes.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":20,"column":66,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":20,"endColumn":67},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":20,"column":78,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":20,"endColumn":79}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const express = require(\"express\");\nconst Database = require(\"../config/database\");\nconst { authenticateUser } = require(\"../middleware/auth\");\n\nconst router = express.Router();\nconst db = new Database();\nconst supabase = db.getClient();\n// GET /api/storage/signed-url?path=bucketPath\nrouter.get(\"/signed-url\", authenticateUser, async (req, res) => {\n  try {\n    const {path} = req.query;\n    if (!path) return res.status(400).json({ error: \"path is required\" });\n    // 5 minutes expiry\n    const expiresIn = 60 * 5;\n    const { data, error } = await supabase\n      .storage\n      .from(\"complaint-evidence\")\n      .createSignedUrl(path, expiresIn);\n    if (error) return res.status(500).json({ error: error.message });\n    return res.json({ url: data.signedUrl, expiresAt: Date.now() + expiresIn * 1000 });\n  } catch (e) {\n    console.error(\"[STORAGE] signed-url error:\", e);\n    res.status(500).json({ error: \"Failed to create signed URL\" });\n  }\n});\n\nmodule.exports = router;\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\supabaseRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\superAdminRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\userRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\routes\\verificationRoutes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\ClusteringScheduler.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\ComplaintService.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '-'. Use parentheses to clarify the intended order of operations.","line":684,"column":20,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":684,"endColumn":21},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '-'. Use parentheses to clarify the intended order of operations.","line":684,"column":31,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":684,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const ComplaintRepository = require(\"../repositories/ComplaintRepository\");\r\nconst ComplaintAssignmentRepository = require(\"../repositories/ComplaintAssignmentRepository\");\r\nconst DepartmentRepository = require(\"../repositories/DepartmentRepository\");\r\nconst Complaint = require(\"../models/Complaint\");\r\nconst NotificationService = require(\"./NotificationService\");\r\nconst {\r\n  normalizeComplaintData,\r\n  prepareComplaintForInsert,\r\n  validateComplaintConsistency,\r\n  _getAssignmentProgress,\r\n} = require(\"../utils/complaintUtils\");\r\n\r\nclass ComplaintService {\r\n  constructor(\r\n    complaintRepo,\r\n    assignmentRepo,\r\n    departmentRepo,\r\n    notificationService\r\n  ) {\r\n    this.complaintRepo = complaintRepo || new ComplaintRepository();\r\n    this.assignmentRepo = assignmentRepo || new ComplaintAssignmentRepository();\r\n    this.departmentRepo = departmentRepo || new DepartmentRepository();\r\n    this.notificationService = notificationService || new NotificationService();\r\n  }\r\n  async createComplaint(userId, complaintData, files = [], token = null) {\r\n    // Debug: Log received complaint data\r\n    // Debug: Log received complaint data\r\n    // Parse preferred_departments - handle both array and individual values\r\n    let preferredDepartments = complaintData.preferred_departments || [];\r\n    // If preferred_departments is a string, check if it's JSON or just a single value\r\n    if (typeof preferredDepartments === \"string\") {\r\n      // Try to parse as JSON first\r\n      try {\r\n        preferredDepartments = JSON.parse(preferredDepartments);\r\n      } catch (e) {\r\n        // If JSON parsing fails, treat it as a single department code\r\n        // If JSON parsing fails, treat it as a single department code\r\n        preferredDepartments = [preferredDepartments].filter(Boolean);\r\n      }\r\n    }\r\n    // If preferred_departments is not an array, convert it to array\r\n    if (!Array.isArray(preferredDepartments)) {\r\n      preferredDepartments = [preferredDepartments].filter(Boolean);\r\n    }\r\n\r\n    // Map client field names to server field names\r\n    const mappedData = {\r\n      ...complaintData,\r\n      submitted_by: userId,\r\n      // All submissions are complaints - no need for user to choose type\r\n      type: \"complaint\",\r\n      // Map 'description' from client to 'descriptive_su' expected by server model\r\n      descriptive_su: complaintData.description || complaintData.descriptive_su,\r\n      // Store user's preferred departments\r\n      preferred_departments: preferredDepartments,\r\n      // Initially empty - will be populated by coordinator assignment\r\n      department_r: [],\r\n      // Note: category and subcategory fields are passed through as-is (UUIDs from categories/subcategories tables)\r\n    };\r\n\r\n    // Prepare data for insertion using utility functions\r\n    const preparedData = prepareComplaintForInsert(mappedData);\r\n\r\n    // Debug: Log what fields are being sent to database\r\n    // Debug: Log what fields are being sent to database\r\n\r\n    // Validate data consistency\r\n    const consistencyCheck = validateComplaintConsistency(preparedData);\r\n    if (!consistencyCheck.isValid) {\r\n      console.warn(\r\n        \"[COMPLAINT] Data consistency issues:\",\r\n        consistencyCheck.errors\r\n      );\r\n    }\r\n    const complaint = new Complaint(preparedData);\r\n    const validation = Complaint.validate(complaint);\r\n    if (!validation.isValid) {\r\n      throw new Error(`Validation failed: ${validation.errors.join(\", \")}`);\r\n    }\r\n    const sanitizedData = complaint.sanitizeForInsert();\r\n    const createdComplaint = await this.complaintRepo.create(\r\n      sanitizedData,\r\n      token\r\n    );\r\n\r\n    try {\r\n      await this._processWorkflow(createdComplaint, preferredDepartments);\r\n      await this._processFileUploads(createdComplaint.id, files, userId);\r\n      // Send notification to citizen\r\n      try {\r\n        await this.notificationService.notifyComplaintSubmitted(\r\n          userId,\r\n          createdComplaint.id,\r\n          createdComplaint.title\r\n        );\r\n      } catch (notifError) {\r\n        console.warn(\r\n          \"[COMPLAINT] Failed to send submission notification:\",\r\n          notifError.message\r\n        );\r\n      }\r\n      // Send notification to complaint coordinator\r\n      try {\r\n        // Use the new method that finds all coordinators and notifies them\r\n        const coordResult =\r\n          await this.notificationService.notifyAllCoordinators(\r\n            createdComplaint.id,\r\n            createdComplaint.title\r\n          );\r\n        if (!coordResult.success) {\r\n          console.warn(\r\n            \"[COMPLAINT] Failed to send coordinator notifications:\",\r\n            coordResult.error\r\n          );\r\n        }\r\n      } catch (coordNotifError) {\r\n        console.warn(\r\n          \"[COMPLAINT] Failed to send coordinator notification:\",\r\n          coordNotifError.message\r\n        );\r\n      }\r\n      const finalComplaint = await this.complaintRepo.findById(\r\n        createdComplaint.id,\r\n        token\r\n      );\r\n      return finalComplaint;\r\n    } catch (error) {\r\n      console.warn(\"Post-creation processing failed:\", error.message);\r\n      return createdComplaint;\r\n    }\r\n  }\r\n  async _processWorkflow(complaint, departmentArray) {\r\n    // Set primary and secondary departments from user selection\r\n    if (departmentArray.length > 0) {\r\n      try {\r\n        await this.complaintRepo.update(complaint.id, {\r\n          workflow_status: \"new\",\r\n          updated_at: new Date().toISOString(),\r\n        });\r\n\r\n        // Create complaint_assignments for primary and secondary departments\r\n        for (const deptCode of departmentArray) {\r\n          try {\r\n            const dept = await this.departmentRepo.findByCode(deptCode);\r\n            if (dept && dept.id) {\r\n              await this.assignmentRepo.assign(\r\n                complaint.id,\r\n                dept.id,\r\n                complaint.submitted_by,\r\n                { status: \"pending\" }\r\n              );\r\n            }\r\n          } catch (error) {\r\n            console.warn(\r\n              \"[WORKFLOW] Assignment creation failed for dept:\",\r\n              deptCode,\r\n              error.message\r\n            );\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.warn(\"[WORKFLOW] Department assignment failed:\", error.message);\r\n      }\r\n    }\r\n    if (departmentArray.length > 0) {\r\n      const targetDept = departmentArray[0];\r\n      try {\r\n        const coordinator = await this.complaintRepo.findActiveCoordinator(\r\n          targetDept\r\n        );\r\n        if (coordinator) {\r\n          await this.complaintRepo.assignCoordinator(\r\n            complaint.id,\r\n            coordinator.user_id\r\n          );\r\n        }\r\n      } catch (error) {\r\n        console.warn(\r\n          \"[WORKFLOW] Coordinator assignment failed:\",\r\n          error.message\r\n        );\r\n      }\r\n    }\r\n  }\r\n  async _processFileUploads(complaintId, files, userId = null) {\r\n    if (!files || files.length === 0) {\r\n      return [];\r\n    }\r\n    // Use the same Database instance to ensure consistent client\r\n    const { supabase } = this.complaintRepo;\r\n    const evidenceFiles = [];\r\n    for (const file of files) {\r\n      try {\r\n        // Store in evidence subfolder for initial evidence\r\n        const fileName = `${complaintId}/evidence/${Date.now()}-${\r\n          file.originalname\r\n        }`;\r\n        // Upload file to Supabase storage\r\n        const { data: uploadData, error: uploadError } = await supabase.storage\r\n          .from(\"complaint-evidence\")\r\n          .upload(fileName, file.buffer, {\r\n            contentType: file.mimetype,\r\n            cacheControl: \"3600\",\r\n            upsert: false,\r\n          });\r\n        if (uploadError) {\r\n          console.error(\"[FILE] Upload error:\", uploadError);\r\n          continue;\r\n        }\r\n        const {\r\n          data: { publicUrl },\r\n        } = supabase.storage.from(\"complaint-evidence\").getPublicUrl(fileName);\r\n        evidenceFiles.push({\r\n          fileName: file.originalname,\r\n          filePath: uploadData.path,\r\n          fileType: file.mimetype,\r\n          fileSize: file.size,\r\n          publicUrl,\r\n        });\r\n        // Store evidence metadata in database with evidence_type='initial'\r\n        try {\r\n          const { error: dbError } = await supabase\r\n            .from(\"complaint_evidence\")\r\n            .insert({\r\n              complaint_id: complaintId,\r\n              file_name: file.originalname,\r\n              file_path: uploadData.path,\r\n              file_size: file.size,\r\n              file_type: file.mimetype,\r\n              mime_type: file.mimetype,\r\n              uploaded_by: userId,\r\n              evidence_type: \"initial\",\r\n              is_public: false,\r\n            });\r\n          if (dbError) {\r\n            console.error(\"[FILE] Evidence metadata storage error:\", dbError);\r\n          }\r\n        } catch (error) {\r\n          console.error(\"[FILE] Evidence metadata storage failed:\", error);\r\n        }\r\n      } catch (error) {\r\n        console.error(\"[FILE] Processing error:\", error);\r\n      }\r\n    }\r\n    if (evidenceFiles.length > 0) {\r\n      await this.complaintRepo.updateEvidence(\r\n        complaintId,\r\n        evidenceFiles,\r\n        userId\r\n      );\r\n    }\r\n    return evidenceFiles;\r\n  }\r\n  async addEvidence(complaintId, files, userId = null) {\r\n    return this._processFileUploads(complaintId, files, userId);\r\n  }\r\n  /**\r\n   * Process completion evidence files and upload to storage\r\n   * Stores files in {complaintId}/completion/ subfolder\r\n   */\r\n  async _processCompletionEvidence(complaintId, files, userId = null) {\r\n    if (!files || files.length === 0) {\r\n      return [];\r\n    }\r\n    const { supabase } = this.complaintRepo;\r\n    const evidenceFiles = [];\r\n    for (const file of files) {\r\n      try {\r\n        // Store in completion subfolder\r\n        const fileName = `${complaintId}/completion/${Date.now()}-${\r\n          file.originalname\r\n        }`;\r\n        // Upload file to Supabase storage\r\n        const { data: uploadData, error: uploadError } = await supabase.storage\r\n          .from(\"complaint-evidence\")\r\n          .upload(fileName, file.buffer, {\r\n            contentType: file.mimetype,\r\n            cacheControl: \"3600\",\r\n            upsert: false,\r\n          });\r\n        if (uploadError) {\r\n          console.error(\r\n            \"[FILE] Completion evidence upload error:\",\r\n            uploadError\r\n          );\r\n          continue;\r\n        }\r\n        const {\r\n          data: { publicUrl },\r\n        } = supabase.storage.from(\"complaint-evidence\").getPublicUrl(fileName);\r\n        evidenceFiles.push({\r\n          fileName: file.originalname,\r\n          filePath: uploadData.path,\r\n          fileType: file.mimetype,\r\n          fileSize: file.size,\r\n          publicUrl,\r\n        });\r\n        // Store evidence metadata in database with evidence_type='completion'\r\n        try {\r\n          const { error: dbError } = await supabase\r\n            .from(\"complaint_evidence\")\r\n            .insert({\r\n              complaint_id: complaintId,\r\n              file_name: file.originalname,\r\n              file_path: uploadData.path,\r\n              file_size: file.size,\r\n              file_type: file.mimetype,\r\n              mime_type: file.mimetype,\r\n              uploaded_by: userId,\r\n              evidence_type: \"completion\",\r\n              is_public: false,\r\n            });\r\n          if (dbError) {\r\n            console.error(\"[FILE] Evidence metadata storage error:\", dbError);\r\n          }\r\n        } catch (error) {\r\n          console.error(\"[FILE] Evidence metadata storage failed:\", error);\r\n        }\r\n      } catch (error) {\r\n        console.error(\"[FILE] Processing completion evidence error:\", error);\r\n      }\r\n    }\r\n    return evidenceFiles;\r\n  }\r\n  async getComplaintById(id, userId = null, token = null) {\r\n    try {\r\n      const complaint = await this.complaintRepo.findById(id, token);\r\n      if (!complaint) {\r\n        console.log(\r\n          `[COMPLAINT_SERVICE] Complaint ${id} not found in database`\r\n        );\r\n        throw new Error(\"Complaint not found\");\r\n      }\r\n      if (userId && complaint.submitted_by !== userId) {\r\n        console.log(\r\n          `[COMPLAINT_SERVICE] Access denied: User ${userId} attempted to access complaint ${id} owned by ${complaint.submitted_by}`\r\n        );\r\n        throw new Error(\"Access denied\");\r\n      }\r\n      // Get assignment data for progress tracking (without accessing auth.users)\r\n      const { data: assignments } = await this.complaintRepo.supabase\r\n        .from(\"complaint_assignments\")\r\n        .select(\r\n          \"id, complaint_id, assigned_to, assigned_by, status, priority, assignment_type, assignment_group_id, officer_order, created_at, updated_at\"\r\n        )\r\n        .eq(\"complaint_id\", id)\r\n        .order(\"officer_order\", { ascending: true });\r\n      // Add assignments to complaint data\r\n      complaint.assignments = assignments || [];\r\n      // Fetch complainant info from auth.users for admin, officers, and coordinators\r\n      // Only fetch if userId is null (meaning user is not a citizen viewing their own complaint)\r\n      if (!userId && complaint.submitted_by) {\r\n        try {\r\n          const { data: submitterData, error: submitterError } =\r\n            await this.complaintRepo.supabase.auth.admin.getUserById(\r\n              complaint.submitted_by\r\n            );\r\n          if (!submitterError && submitterData?.user) {\r\n            const { user } = submitterData;\r\n            const meta = user.user_metadata || {};\r\n            const rawMeta = user.raw_user_meta_data || {};\r\n            const combined = { ...rawMeta, ...meta };\r\n            complaint.submitted_by_profile = {\r\n              id: user.id,\r\n              email: user.email,\r\n              name:\r\n                combined.name ||\r\n                `${combined.first_name || \"\"} ${\r\n                  combined.last_name || \"\"\r\n                }`.trim() ||\r\n                user.email,\r\n              firstName: combined.first_name,\r\n              lastName: combined.last_name,\r\n              mobileNumber:\r\n                rawMeta.mobile_number ||\r\n                meta.mobile_number ||\r\n                combined.mobile_number ||\r\n                null,\r\n              mobile:\r\n                rawMeta.mobile_number ||\r\n                meta.mobile_number ||\r\n                combined.mobile_number ||\r\n                null,\r\n              raw_user_meta_data: rawMeta,\r\n            };\r\n          }\r\n        } catch (error) {\r\n          console.error(\r\n            \"[COMPLAINT_SERVICE] Error fetching complainant info:\",\r\n            error\r\n          );\r\n          // Continue without complainant info if fetch fails\r\n        }\r\n      }\r\n      // Reconcile workflow (eventual consistency)\r\n      try {\r\n        await this.reconcileWorkflowStatus(id);\r\n      } catch (error) {\r\n        // Silently fail if reconciliation is not available\r\n        console.warn(\r\n          \"[COMPLAINT_SERVICE] Workflow reconciliation skipped:\",\r\n          error.message\r\n        );\r\n      }\r\n      // Return normalized complaint data for frontend compatibility\r\n      return normalizeComplaintData(complaint);\r\n    } catch (error) {\r\n      // Re-throw known errors (Complaint not found, Access denied)\r\n      if (\r\n        error.message === \"Complaint not found\" ||\r\n        error.message === \"Access denied\"\r\n      ) {\r\n        throw error;\r\n      }\r\n      // Log and wrap unexpected errors\r\n      console.error(\r\n        `[COMPLAINT_SERVICE] Unexpected error in getComplaintById for ${id}:`,\r\n        error\r\n      );\r\n      throw new Error(`Failed to fetch complaint: ${error.message}`);\r\n    }\r\n  }\r\n  /**\r\n   * Reconcile workflow status based on current assignments and confirmations\r\n   * This ensures eventual consistency between workflow_status and actual state\r\n   * @param {string} complaintId - Complaint ID\r\n   */\r\n  async reconcileWorkflowStatus(complaintId) {\r\n    try {\r\n      // Get current complaint state\r\n      const complaint = await this.complaintRepo.findById(complaintId);\r\n      if (!complaint) {\r\n        return; // Complaint not found, nothing to reconcile\r\n      }\r\n\r\n      // Update confirmation status using database function\r\n      // This ensures confirmation_status is consistent with assignments\r\n      await this.complaintRepo.supabase.rpc(\r\n        \"update_complaint_confirmation_status\",\r\n        {\r\n          complaint_uuid: complaintId,\r\n        }\r\n      );\r\n\r\n      // Additional workflow reconciliation logic can be added here if needed\r\n      // For now, the confirmation status update is sufficient\r\n    } catch (error) {\r\n      // Log but don't throw - reconciliation is best-effort\r\n      console.warn(\r\n        \"[COMPLAINT_SERVICE] Workflow reconciliation error:\",\r\n        error.message\r\n      );\r\n    }\r\n  }\r\n  async getUserComplaints(userId, options = {}) {\r\n    try {\r\n      const result = await this.complaintRepo.findByUserId(userId, options);\r\n      return result;\r\n    } catch (error) {\r\n      console.error(\"[COMPLAINT_SERVICE] Error in getUserComplaints:\", error);\r\n      console.error(\"[COMPLAINT_SERVICE] Error stack:\", error.stack);\r\n      throw error;\r\n    }\r\n  }\r\n  async getUserStatistics(userId) {\r\n    try {\r\n      const { supabase } = this.complaintRepo;\r\n      // Get total complaints count\r\n      const { count: totalComplaints, error: totalError } = await supabase\r\n        .from(\"complaints\")\r\n        .select(\"*\", { count: \"exact\", head: true })\r\n        .eq(\"submitted_by\", userId);\r\n      if (totalError) throw totalError;\r\n      // Get complaints by workflow_status\r\n      const { data: statusData, error: statusError } = await supabase\r\n        .from(\"complaints\")\r\n        .select(\"workflow_status\")\r\n        .eq(\"submitted_by\", userId);\r\n      if (statusError) throw statusError;\r\n      // Count by workflow_status\r\n      const statusCounts = statusData.reduce((acc, complaint) => {\r\n        acc[complaint.workflow_status] =\r\n          (acc[complaint.workflow_status] || 0) + 1;\r\n        return acc;\r\n      }, {});\r\n      // Get complaints by category (more meaningful than type)\r\n      const { data: categoryData, error: categoryError } = await supabase\r\n        .from(\"complaints\")\r\n        .select(\"category\")\r\n        .eq(\"submitted_by\", userId);\r\n      if (categoryError) throw categoryError;\r\n      // Count by category\r\n      const categoryCounts = categoryData.reduce((acc, complaint) => {\r\n        const category = complaint.category || \"Uncategorized\";\r\n        acc[category] = (acc[category] || 0) + 1;\r\n        return acc;\r\n      }, {});\r\n      // Get recent activity (last 30 days)\r\n      const thirtyDaysAgo = new Date();\r\n      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n      const { count: recentComplaints, error: recentError } = await supabase\r\n        .from(\"complaints\")\r\n        .select(\"*\", { count: \"exact\", head: true })\r\n        .eq(\"submitted_by\", userId)\r\n        .gte(\"submitted_at\", thirtyDaysAgo.toISOString());\r\n      if (recentError) throw recentError;\r\n      return {\r\n        totalComplaints: totalComplaints || 0,\r\n        recentComplaints: recentComplaints || 0,\r\n        statusCounts,\r\n        categoryCounts, // Changed from typeCounts to categoryCounts\r\n        lastUpdated: new Date().toISOString(),\r\n      };\r\n    } catch (error) {\r\n      console.error(\r\n        \"[COMPLAINT-SERVICE] Error fetching user statistics:\",\r\n        error\r\n      );\r\n      throw error;\r\n    }\r\n  }\r\n  async getAllComplaints(options = {}) {\r\n    return this.complaintRepo.findAll(options);\r\n  }\r\n  async updateComplaintStatus(id, updateData, userId = null) {\r\n    const complaint = await this.getComplaintById(id);\r\n    const {\r\n      status: workflowStatus,\r\n      priority,\r\n      category,\r\n      subcategory,\r\n      notes,\r\n    } = typeof updateData === \"string\"\r\n      ? { status: updateData, notes: userId } // Handle legacy signature if needed\r\n      : updateData;\r\n\r\n    const dataToUpdate = { updated_at: new Date().toISOString() };\r\n\r\n    if (workflowStatus) {\r\n      const validStatuses = [\r\n        \"new\",\r\n        \"assigned\",\r\n        \"in_progress\",\r\n        \"completed\",\r\n        \"cancelled\",\r\n      ];\r\n      if (!validStatuses.includes(workflowStatus)) {\r\n        throw new Error(\"Invalid workflow status\");\r\n      }\r\n      dataToUpdate.workflow_status = workflowStatus;\r\n    }\r\n\r\n    if (priority) dataToUpdate.priority = priority;\r\n    if (category) dataToUpdate.category = category;\r\n    if (subcategory) dataToUpdate.subcategory = subcategory;\r\n    if (notes) dataToUpdate.coordinator_notes = notes;\r\n\r\n    const updatedComplaint = await this.complaintRepo.update(id, dataToUpdate);\r\n\r\n    try {\r\n      await this.complaintRepo.logAction(id, \"status_updated\", {\r\n        reason: `Complaint updated by coordinator/admin`,\r\n        details: {\r\n          old_status: complaint.workflow_status,\r\n          new_status: workflowStatus || complaint.workflow_status,\r\n          old_priority: complaint.priority,\r\n          new_priority: priority || complaint.priority,\r\n          notes,\r\n        },\r\n      });\r\n    } catch (error) {\r\n      console.warn(\"[AUDIT] Status update logging failed:\", error.message);\r\n    }\r\n\r\n    // Send notification to citizen if status changed\r\n    if (workflowStatus && complaint.workflow_status !== workflowStatus) {\r\n      try {\r\n        await this.notificationService.notifyComplaintStatusChanged(\r\n          complaint.submitted_by,\r\n          id,\r\n          complaint.title,\r\n          workflowStatus,\r\n          complaint.workflow_status\r\n        );\r\n      } catch (notifError) {\r\n        console.warn(\r\n          \"[COMPLAINT] Failed to send status change notification:\",\r\n          notifError.message\r\n        );\r\n      }\r\n    }\r\n    return updatedComplaint;\r\n  }\r\n  async assignCoordinator(complaintId, coordinatorId, assignedBy) {\r\n    await this.getComplaintById(complaintId);\r\n    const updatedComplaint = await this.complaintRepo.assignCoordinator(\r\n      complaintId,\r\n      coordinatorId\r\n    );\r\n    try {\r\n      await this.complaintRepo.logAction(complaintId, \"coordinator_assigned\", {\r\n        reason: \"Manually assigned by admin\",\r\n        details: { assigned_by: assignedBy, coordinator_id: coordinatorId },\r\n      });\r\n    } catch (error) {\r\n      console.warn(\r\n        \"[AUDIT] Coordinator assignment logging failed:\",\r\n        error.message\r\n      );\r\n    }\r\n    return updatedComplaint;\r\n  }\r\n  async transferComplaint(\r\n    complaintId,\r\n    fromDept,\r\n    toDept,\r\n    reason,\r\n    transferredBy\r\n  ) {\r\n    await this.getComplaintById(complaintId);\r\n    const updatedComplaint = await this.complaintRepo.update(complaintId, {\r\n      assigned_coordinator_id: null,\r\n    });\r\n    try {\r\n      const newCoordinator = await this.complaintRepo.findActiveCoordinator(\r\n        toDept\r\n      );\r\n      if (newCoordinator) {\r\n        await this.complaintRepo.assignCoordinator(\r\n          complaintId,\r\n          newCoordinator.user_id\r\n        );\r\n      }\r\n    } catch (error) {\r\n      console.warn(\r\n        \"[TRANSFER] New coordinator assignment failed:\",\r\n        error.message\r\n      );\r\n    }\r\n    try {\r\n      await this.complaintRepo.logAction(complaintId, \"transferred\", {\r\n        reason,\r\n        details: {\r\n          from_dept: fromDept,\r\n          to_dept: toDept,\r\n          transferred_by: transferredBy,\r\n        },\r\n      });\r\n    } catch (error) {\r\n      console.warn(\"[AUDIT] Transfer logging failed:\", error.message);\r\n    }\r\n    return updatedComplaint;\r\n  }\r\n  async getComplaintStats(filters = {}) {\r\n    const { department, dateFrom, dateTo } = filters;\r\n\r\n    // Helper to build base query\r\n    const buildQuery = () => {\r\n      let query = this.complaintRepo.supabase\r\n        .from(\"complaints\")\r\n        .select(\"workflow_status, subtype, priority, submitted_at\");\r\n\r\n      if (department) {\r\n        query = query.contains(\"department_r\", [department]);\r\n      }\r\n      if (dateFrom) {\r\n        query = query.gte(\"submitted_at\", dateFrom);\r\n      }\r\n      if (dateTo) {\r\n        query = query.lte(\"submitted_at\", dateTo);\r\n      }\r\n      return query;\r\n    };\r\n\r\n    // Fetch all rows using pagination to bypass default limits\r\n    let allData = [];\r\n    let page = 0;\r\n    const pageSize = 1000;\r\n    let hasMore = true;\r\n\r\n    while (hasMore) {\r\n      const { data, error } = await buildQuery().range(\r\n        page * pageSize,\r\n        (page + 1) * pageSize - 1\r\n      );\r\n\r\n      if (error) throw error;\r\n\r\n      if (data.length > 0) {\r\n        allData = allData.concat(data);\r\n        page++;\r\n        // If we got less than pageSize, we're done\r\n        if (data.length < pageSize) hasMore = false;\r\n      } else {\r\n        hasMore = false;\r\n      }\r\n    }\r\n\r\n    const stats = {\r\n      total: allData.length,\r\n      by_status: {},\r\n      by_subtype: {},\r\n      by_priority: {},\r\n      by_month: {},\r\n    };\r\n\r\n    allData.forEach((complaint) => {\r\n      // Count by status\r\n      stats.by_status[complaint.workflow_status] =\r\n        (stats.by_status[complaint.workflow_status] || 0) + 1;\r\n\r\n      // Count by subtype\r\n      if (complaint.subtype) {\r\n        stats.by_subtype[complaint.subtype] =\r\n          (stats.by_subtype[complaint.subtype] || 0) + 1;\r\n      }\r\n\r\n      // Count by priority\r\n      if (complaint.priority) {\r\n        stats.by_priority[complaint.priority] =\r\n          (stats.by_priority[complaint.priority] || 0) + 1;\r\n      }\r\n\r\n      // Count by month\r\n      if (complaint.submitted_at) {\r\n        const month = new Date(complaint.submitted_at)\r\n          .toISOString()\r\n          .slice(0, 7);\r\n        stats.by_month[month] = (stats.by_month[month] || 0) + 1;\r\n      }\r\n    });\r\n\r\n    return stats;\r\n  }\r\n  async getComplaintLocations(filters = {}) {\r\n    const {\r\n      status,\r\n      confirmationStatus,\r\n      category,\r\n      subcategory,\r\n      department,\r\n      startDate,\r\n      endDate,\r\n      includeResolved = true,\r\n    } = filters;\r\n    try {\r\n      // First, get total count of complaints with coordinates for debugging\r\n      // IMPORTANT: Use direct supabase client to bypass any potential RLS issues\r\n      // CRITICAL: Create a fresh service role client to ensure we BYPASS RLS\r\n      // The repository client might be shared or not properly privileged in some contexts\r\n      const { createClient } = require(\"@supabase/supabase-js\");\r\n      const supabase = createClient(\r\n        process.env.SUPABASE_URL,\r\n        process.env.SUPABASE_SERVICE_ROLE_KEY,\r\n        {\r\n          auth: {\r\n            autoRefreshToken: false,\r\n            persistSession: false,\r\n          },\r\n        }\r\n      );\r\n\r\n      // Use the fresh client for these diagnostic counts as well\r\n      const { count: totalWithCoords } = await supabase\r\n        .from(\"complaints\")\r\n        .select(\"id\", { count: \"exact\", head: true })\r\n        .not(\"latitude\", \"is\", null)\r\n        .not(\"longitude\", \"is\", null);\r\n\r\n      let query = supabase\r\n        .from(\"complaints\")\r\n        .select(\r\n          \"id, title, workflow_status, priority, latitude, longitude, location_text, submitted_at, department_r, category, subcategory\",\r\n          { count: \"exact\" }\r\n        )\r\n        .not(\"latitude\", \"is\", null)\r\n        .not(\"longitude\", \"is\", null)\r\n        .order(\"submitted_at\", { ascending: false }); // Add ordering for consistency\r\n\r\n      // Log filter parameters\r\n\r\n      // Filter by workflow_status (supports array for multiple values)\r\n      if (status) {\r\n        if (Array.isArray(status) && status.length > 0) {\r\n          // Multiple statuses - use .in() for OR filtering\r\n          query = query.in(\"workflow_status\", status);\r\n        } else if (!Array.isArray(status)) {\r\n          // Single status\r\n          query = query.eq(\"workflow_status\", status);\r\n        }\r\n      } else if (!includeResolved) {\r\n        // No status filter - check if we should exclude resolved\r\n        // Exclude completed and cancelled complaints\r\n        query = query\r\n          .neq(\"workflow_status\", \"completed\")\r\n          .neq(\"workflow_status\", \"cancelled\");\r\n      }\r\n\r\n      // Filter by confirmation_status (supports array for multiple values)\r\n      if (confirmationStatus) {\r\n        if (\r\n          Array.isArray(confirmationStatus) &&\r\n          confirmationStatus.length > 0\r\n        ) {\r\n          // Multiple confirmation statuses - use .in() for OR filtering\r\n          query = query.in(\"confirmation_status\", confirmationStatus);\r\n        } else if (!Array.isArray(confirmationStatus)) {\r\n          // Single confirmation status\r\n          query = query.eq(\"confirmation_status\", confirmationStatus);\r\n        }\r\n      }\r\n      // No 'type' field in schema; do not filter by it\r\n      // Filter by department - checks department_r array (text array field)\r\n      // Only complaints with the selected department code in their department_r array will be returned\r\n      if (department) {\r\n        // console.log(\"[COMPLAINT-SERVICE] Filtering by department:\", department);\r\n        const depts = Array.isArray(department) ? department : [department];\r\n        if (depts.length > 0) {\r\n          // Use overlaps operator (&&) to check if department_r has common elements with depts array\r\n          query = query.overlaps(\"department_r\", depts);\r\n        }\r\n      } else {\r\n        // console.log(\"[COMPLAINT-SERVICE] No department filter applied\");\r\n      }\r\n      // Filter by category (UUIDs from categories table, supports array for multiple values)\r\n      if (category) {\r\n        if (Array.isArray(category) && category.length > 0) {\r\n          // Multiple categories - use .in() for OR filtering\r\n          query = query.in(\"category\", category);\r\n        } else if (!Array.isArray(category)) {\r\n          // Single category\r\n          query = query.eq(\"category\", category);\r\n        }\r\n      }\r\n      // Filter by subcategory (UUID from subcategories table)\r\n      if (subcategory) {\r\n        query = query.eq(\"subcategory\", subcategory);\r\n      }\r\n      // Filter by date range\r\n      if (startDate) {\r\n        query = query.gte(\"submitted_at\", startDate);\r\n      }\r\n      if (endDate) {\r\n        query = query.lte(\"submitted_at\", endDate);\r\n      }\r\n      // IMPORTANT: Supabase PostgREST has a default limit that may be very low (sometimes as low as 7-10 rows)\r\n      // For the heatmap, we want ALL complaints with coordinates\r\n      // First, get the total count to know how many records we need to fetch\r\n      // Clone the query for count to avoid modifying the original query\r\n      // Clone the query for count to avoid modifying the original query\r\n      let countQuery = supabase\r\n        .from(\"complaints\")\r\n        .select(\"id\", { count: \"exact\", head: true })\r\n        .not(\"latitude\", \"is\", null)\r\n        .not(\"longitude\", \"is\", null);\r\n\r\n      // Apply same filters to count query\r\n      if (status) {\r\n        if (Array.isArray(status) && status.length > 0) {\r\n          countQuery = countQuery.in(\"workflow_status\", status);\r\n        } else if (!Array.isArray(status)) {\r\n          countQuery = countQuery.eq(\"workflow_status\", status);\r\n        }\r\n      } else if (!includeResolved) {\r\n        countQuery = countQuery\r\n          .neq(\"workflow_status\", \"completed\")\r\n          .neq(\"workflow_status\", \"cancelled\");\r\n      }\r\n\r\n      if (confirmationStatus) {\r\n        if (\r\n          Array.isArray(confirmationStatus) &&\r\n          confirmationStatus.length > 0\r\n        ) {\r\n          countQuery = countQuery.in(\"confirmation_status\", confirmationStatus);\r\n        } else if (!Array.isArray(confirmationStatus)) {\r\n          countQuery = countQuery.eq(\"confirmation_status\", confirmationStatus);\r\n        }\r\n      }\r\n\r\n      if (department) {\r\n        const depts = Array.isArray(department) ? department : [department];\r\n        if (depts.length > 0) {\r\n          countQuery = countQuery.overlaps(\"department_r\", depts);\r\n        }\r\n      }\r\n\r\n      if (category) {\r\n        if (Array.isArray(category) && category.length > 0) {\r\n          countQuery = countQuery.in(\"category\", category);\r\n        } else if (!Array.isArray(category)) {\r\n          countQuery = countQuery.eq(\"category\", category);\r\n        }\r\n      }\r\n\r\n      if (subcategory) {\r\n        countQuery = countQuery.eq(\"subcategory\", subcategory);\r\n      }\r\n\r\n      if (startDate) {\r\n        countQuery = countQuery.gte(\"submitted_at\", startDate);\r\n      }\r\n      if (endDate) {\r\n        countQuery = countQuery.lte(\"submitted_at\", endDate);\r\n      }\r\n\r\n      const { count: totalCount, error: countError } = await countQuery;\r\n\r\n      if (countError) {\r\n        console.error(\r\n          \"[COMPLAINT-SERVICE] Error getting total count:\",\r\n          countError\r\n        );\r\n        // Continue anyway - pagination will handle it\r\n      }\r\n\r\n      // console.log(\r\n      //   `[COMPLAINT-SERVICE] Total complaints matching filters: ${\r\n      //     totalCount || \"unknown\"\r\n      //   }`\r\n      // );\r\n\r\n      // Use pagination to fetch all records in batches\r\n      const batchSize = 1000; // Fetch in batches of 1000\r\n      let allData = [];\r\n      let hasMore = true;\r\n      let offset = 0;\r\n\r\n      // Fetch all complaints using pagination\r\n      while (hasMore) {\r\n        const paginatedQuery = query\r\n          .range(offset, offset + batchSize - 1)\r\n          .limit(batchSize);\r\n\r\n        const { data: batchData, error } = await paginatedQuery;\r\n\r\n        if (error) {\r\n          console.error(\"[COMPLAINT-SERVICE] Database error:\", error);\r\n          console.error(\r\n            \"[COMPLAINT-SERVICE] Error details:\",\r\n            JSON.stringify(error, null, 2)\r\n          );\r\n          throw error;\r\n        }\r\n\r\n        if (batchData && batchData.length > 0) {\r\n          allData = allData.concat(batchData);\r\n          // console.log(\r\n          //   `[COMPLAINT-SERVICE] Fetched batch: ${batchData.length} complaints (total so far: ${allData.length})`\r\n          // );\r\n          offset += batchSize;\r\n          // If we got fewer results than batchSize, we've reached the end\r\n          hasMore = batchData.length === batchSize;\r\n        } else {\r\n          hasMore = false;\r\n        }\r\n\r\n        // Safety check: if we have a total count and we've fetched all records\r\n        if (totalCount !== null && allData.length >= totalCount) {\r\n          // console.log(\r\n          //   `[COMPLAINT-SERVICE] Reached total count (${totalCount}), stopping pagination`\r\n          // );\r\n          hasMore = false;\r\n        }\r\n\r\n        // Additional safety: prevent infinite loops\r\n        if (offset > 100000) {\r\n          console.warn(\r\n            \"[COMPLAINT-SERVICE] Safety limit reached (100k records), stopping pagination\"\r\n          );\r\n          hasMore = false;\r\n        }\r\n      }\r\n\r\n      const data = allData;\r\n      // console.log(\r\n      //   `[COMPLAINT-SERVICE] Fetched ${data.length} complaint(s) for heatmap using pagination`\r\n      // );\r\n      if (data && data.length === 1 && totalWithCoords > 1) {\r\n        console.error(\r\n          \"[COMPLAINT-SERVICE] ⚠️ CRITICAL: Query returned only 1 complaint but DB has\",\r\n          totalWithCoords\r\n        );\r\n        console.error(\r\n          \"[COMPLAINT-SERVICE] This indicates a query/filter issue!\"\r\n        );\r\n        console.error(\"[COMPLAINT-SERVICE] Query filters applied:\", {\r\n          statusFilter: status || \"none\",\r\n          categoryFilter: category || \"none\",\r\n          departmentFilter: department || \"none\",\r\n          includeResolved,\r\n        });\r\n      }\r\n      // Debug: Log first few complaints to see their structure\r\n      if (data && data.length > 0) {\r\n        // Check status breakdown of returned data\r\n        const returnedStatusBreakdown = {};\r\n        data.forEach((c) => {\r\n          returnedStatusBreakdown[c.workflow_status] =\r\n            (returnedStatusBreakdown[c.workflow_status] || 0) + 1;\r\n        });\r\n      } else {\r\n        console.warn(\"[COMPLAINT-SERVICE] ⚠️ NO DATA RETURNED FROM QUERY!\");\r\n      }\r\n      // Debug: Check if query is somehow limited\r\n      if (data && data.length === 1 && totalWithCoords > 1) {\r\n        console.error(\r\n          \"[COMPLAINT-SERVICE] ⚠️ CRITICAL: Only 1 complaint returned but\",\r\n          totalWithCoords,\r\n          \"complaints have coordinates in DB!\"\r\n        );\r\n        console.error(\r\n          \"[COMPLAINT-SERVICE] This indicates a query/filter issue!\"\r\n        );\r\n        console.error(\r\n          \"[COMPLAINT-SERVICE] Attempting fallback: Direct query without filters...\"\r\n        );\r\n        // Try a direct query as fallback using service role client\r\n        const { data: fallbackData, error: fallbackError } = await supabase\r\n          .from(\"complaints\")\r\n          .select(\r\n            \"id, title, workflow_status, priority, latitude, longitude, location_text, submitted_at, department_r, category, subcategory\"\r\n          )\r\n          .not(\"latitude\", \"is\", null)\r\n          .not(\"longitude\", \"is\", null)\r\n          .limit(100);\r\n        if (\r\n          !fallbackError &&\r\n          fallbackData &&\r\n          fallbackData.length > data.length\r\n        ) {\r\n          console.error(\r\n            \"[COMPLAINT-SERVICE] FALLBACK QUERY returned\",\r\n            fallbackData.length,\r\n            \"complaints!\"\r\n          );\r\n          console.error(\r\n            \"[COMPLAINT-SERVICE] Using fallback data instead of filtered query result.\"\r\n          );\r\n          // Use fallback data if it has more results\r\n          return fallbackData\r\n            .map((complaint) => {\r\n              const lat = Number.parseFloat(complaint.latitude);\r\n              const lng = Number.parseFloat(complaint.longitude);\r\n              if (Number.isNaN(lat) || Number.isNaN(lng)) return null;\r\n              return {\r\n                id: complaint.id,\r\n                title: complaint.title,\r\n                status: complaint.workflow_status,\r\n                priority: complaint.priority || \"medium\",\r\n                lat,\r\n                lng,\r\n                location: complaint.location_text || \"\",\r\n                submittedAt: complaint.submitted_at,\r\n                department: complaint.department_r?.[0] || \"Unknown\",\r\n                departments: complaint.department_r || [],\r\n                category: complaint.category,\r\n                subcategory: complaint.subcategory,\r\n              };\r\n            })\r\n            .filter(Boolean);\r\n        }\r\n      }\r\n      // Transform data for heatmap\r\n      // Debug: Log department_r data before transformation\r\n      if (data && data.length > 0) {\r\n        const deptSample = data.slice(0, 3).map((c) => ({\r\n          id: c.id,\r\n          title: c.title,\r\n          department_r: c.department_r,\r\n          dept_r_type: typeof c.department_r,\r\n          dept_r_isArray: Array.isArray(c.department_r),\r\n          dept_r_length: Array.isArray(c.department_r)\r\n            ? c.department_r.length\r\n            : \"N/A\",\r\n        }));\r\n        console.log(\r\n          \"[COMPLAINT-SERVICE] Sample complaints before transformation:\",\r\n          deptSample\r\n        );\r\n      }\r\n\r\n      const transformedData = data\r\n        .map((complaint) => {\r\n          // Parse coordinates carefully\r\n          const lat = Number.parseFloat(complaint.latitude);\r\n          const lng = Number.parseFloat(complaint.longitude);\r\n          // Skip if coordinates are invalid\r\n          if (\r\n            Number.isNaN(lat) ||\r\n            Number.isNaN(lng) ||\r\n            !Number.isFinite(lat) ||\r\n            !Number.isFinite(lng)\r\n          ) {\r\n            console.warn(\r\n              \"[COMPLAINT-SERVICE] Skipping complaint with invalid coordinates:\",\r\n              complaint.id,\r\n              { lat: complaint.latitude, lng: complaint.longitude }\r\n            );\r\n            return null;\r\n          }\r\n\r\n          // Ensure department_r is properly handled\r\n          let departmentR = [];\r\n          if (Array.isArray(complaint.department_r)) {\r\n            departmentR = complaint.department_r;\r\n          } else if (complaint.department_r) {\r\n            departmentR = [complaint.department_r];\r\n          }\r\n\r\n          return {\r\n            id: complaint.id,\r\n            title: complaint.title,\r\n            status: complaint.workflow_status,\r\n            priority: complaint.priority || \"medium\",\r\n            lat,\r\n            lng,\r\n            location: complaint.location_text || \"\",\r\n            submittedAt: complaint.submitted_at,\r\n            department: departmentR.length > 0 ? departmentR[0] : \"Unknown\",\r\n            departments: departmentR, // Always return as array\r\n            secondaryDepartments:\r\n              departmentR.length > 1 ? departmentR.slice(1) : [],\r\n            type: complaint.category || \"General\",\r\n            category: complaint.category,\r\n            subcategory: complaint.subcategory,\r\n            // Keep original for debugging\r\n            department_r: departmentR,\r\n          };\r\n        })\r\n        .filter(Boolean); // Remove null entries\r\n\r\n      if (transformedData.length === 0 && totalWithCoords > 0) {\r\n        console.error(\r\n          \"[COMPLAINT-SERVICE] ⚠️ ERROR: No valid complaints after transformation, but\",\r\n          totalWithCoords,\r\n          \"have coordinates in DB!\"\r\n        );\r\n      }\r\n      if (transformedData.length === 1 && totalWithCoords > 1) {\r\n        console.warn(\r\n          \"[COMPLAINT-SERVICE] ⚠️ WARNING: Only 1 complaint transformed but\",\r\n          totalWithCoords,\r\n          \"have coordinates in DB!\"\r\n        );\r\n        console.warn(\r\n          \"[COMPLAINT-SERVICE] This suggests coordinate parsing issues. Check logs above for skipped complaints.\"\r\n        );\r\n      }\r\n      return transformedData;\r\n    } catch (error) {\r\n      console.error(\"[COMPLAINT-SERVICE] getComplaintLocations error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Cancel complaint\r\n   */\r\n  async cancelComplaint(complaintId, userId, reason) {\r\n    try {\r\n      // Get complaint and verify ownership\r\n      const complaint = await this.complaintRepo.getComplaintById(complaintId);\r\n      if (!complaint) {\r\n        throw new Error(\"Complaint not found\");\r\n      }\r\n      if (complaint.submitted_by !== userId) {\r\n        throw new Error(\"Not authorized to cancel this complaint\");\r\n      }\r\n      // Check if complaint can be cancelled\r\n      const cancellableStatuses = [\"new\", \"assigned\", \"in_progress\"];\r\n      if (!cancellableStatuses.includes(complaint.workflow_status)) {\r\n        throw new Error(\"Complaint cannot be cancelled in its current status\");\r\n      }\r\n      // Update complaint status\r\n      const { data: updatedComplaint, error: updateError } =\r\n        await this.complaintRepo.supabase\r\n          .from(\"complaints\")\r\n          .update({\r\n            workflow_status: \"cancelled\",\r\n            cancelled_at: new Date().toISOString(),\r\n            cancelled_by: userId,\r\n            cancellation_reason: reason,\r\n            last_activity_at: new Date().toISOString(),\r\n            updated_at: new Date().toISOString(),\r\n          })\r\n          .eq(\"id\", complaintId)\r\n          .select()\r\n          .single();\r\n      if (updateError) {\r\n        console.error(\r\n          \"[COMPLAINT-SERVICE] Cancel complaint update error:\",\r\n          updateError\r\n        );\r\n        throw new Error(\r\n          `Failed to cancel complaint: ${\r\n            updateError.message || \"Database error\"\r\n          }`\r\n        );\r\n      }\r\n      if (!updatedComplaint) {\r\n        throw new Error(\"Complaint not found or could not be updated\");\r\n      }\r\n      // Notify relevant parties\r\n      try {\r\n        // Notify coordinator if assigned\r\n        if (complaint.assigned_coordinator_id) {\r\n          await this.notificationService.createNotification(\r\n            complaint.assigned_coordinator_id,\r\n            \"complaint_cancelled\",\r\n            \"Complaint Cancelled\",\r\n            `Complaint \"${complaint.title}\" has been cancelled by the citizen.`,\r\n            {\r\n              priority: \"info\",\r\n              link: `/coordinator/review-queue`,\r\n              metadata: { complaint_id: complaintId, reason },\r\n            }\r\n          );\r\n        }\r\n        // Notify assigned departments\r\n        const departments = complaint.department_r || [];\r\n        for (const deptCode of departments) {\r\n          try {\r\n            const { data: dept } = await this.complaintRepo.supabase\r\n              .from(\"departments\")\r\n              .select(\"id\")\r\n              .eq(\"code\", deptCode)\r\n              .single();\r\n            if (dept) {\r\n              // Get department admins and notify them\r\n              const { data: assignments } = await this.complaintRepo.supabase\r\n                .from(\"complaint_assignments\")\r\n                .select(\"assigned_by\")\r\n                .eq(\"complaint_id\", complaintId)\r\n                .eq(\"department_id\", dept.id);\r\n              for (const assignment of assignments || []) {\r\n                if (assignment.assigned_by) {\r\n                  await this.notificationService.createNotification(\r\n                    assignment.assigned_by,\r\n                    \"complaint_cancelled\",\r\n                    \"Complaint Cancelled\",\r\n                    `Complaint \"${complaint.title}\" has been cancelled by the citizen.`,\r\n                    {\r\n                      priority: \"info\",\r\n                      link: `/lgu-admin/department-queue`,\r\n                      metadata: { complaint_id: complaintId, reason },\r\n                    }\r\n                  );\r\n                }\r\n              }\r\n            }\r\n          } catch (deptError) {\r\n            console.warn(\r\n              \"[COMPLAINT-SERVICE] Failed to notify department:\",\r\n              deptError.message\r\n            );\r\n          }\r\n        }\r\n      } catch (notifError) {\r\n        console.warn(\r\n          \"[COMPLAINT-SERVICE] Failed to send cancellation notifications:\",\r\n          notifError.message\r\n        );\r\n      }\r\n      return updatedComplaint;\r\n    } catch (error) {\r\n      console.error(\"[COMPLAINT-SERVICE] Cancel complaint error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Send reminder for complaint\r\n   */\r\n  async sendReminder(complaintId, userId) {\r\n    try {\r\n      // Get complaint and verify ownership\r\n      const complaint = await this.complaintRepo.getComplaintById(complaintId);\r\n      if (!complaint) {\r\n        throw new Error(\"Complaint not found\");\r\n      }\r\n      if (complaint.submitted_by !== userId) {\r\n        throw new Error(\"Not authorized to send reminder for this complaint\");\r\n      }\r\n      // Check if reminder can be sent (not cancelled, closed, resolved, or pending)\r\n      const reminderBlockedStatuses = [\"cancelled\", \"completed\", \"pending\"];\r\n      if (reminderBlockedStatuses.includes(complaint.workflow_status)) {\r\n        throw new Error(\"Cannot send reminder for complaint in current status\");\r\n      }\r\n      // Check cooldown period (24 hours)\r\n      const { data: lastReminderData, error: reminderQueryError } =\r\n        await this.complaintRepo.supabase\r\n          .from(\"complaint_reminders\")\r\n          .select(\"reminded_at\")\r\n          .eq(\"complaint_id\", complaintId)\r\n          .order(\"reminded_at\", { ascending: false })\r\n          .limit(1);\r\n\r\n      // Handle case where no reminders exist (not an error)\r\n      if (reminderQueryError && reminderQueryError.code !== \"PGRST116\") {\r\n        throw new Error(\"Failed to check reminder cooldown\");\r\n      }\r\n\r\n      const lastReminder =\r\n        lastReminderData && lastReminderData.length > 0\r\n          ? lastReminderData[0]\r\n          : null;\r\n      if (lastReminder) {\r\n        const lastReminderTime = new Date(lastReminder.reminded_at);\r\n        const now = new Date();\r\n        const hoursSinceLastReminder =\r\n          (now - lastReminderTime) / (1000 * 60 * 60);\r\n\r\n        if (hoursSinceLastReminder < 24) {\r\n          const remainingHours = Math.ceil(24 - hoursSinceLastReminder);\r\n          throw new Error(\r\n            `Please wait ${remainingHours} more hours before sending another reminder`\r\n          );\r\n        }\r\n      }\r\n      // Create reminder record\r\n      const { data: reminder, error: reminderError } =\r\n        await this.complaintRepo.supabase\r\n          .from(\"complaint_reminders\")\r\n          .insert({\r\n            complaint_id: complaintId,\r\n            reminded_by: userId,\r\n            reminder_type: \"manual\",\r\n            reminded_at: new Date().toISOString(),\r\n          })\r\n          .select()\r\n          .single();\r\n      if (reminderError) {\r\n        throw new Error(\"Failed to create reminder record\");\r\n      }\r\n      // Notify assigned departments/officers\r\n      try {\r\n        const { data: assignments } = await this.complaintRepo.supabase\r\n          .from(\"complaint_assignments\")\r\n          .select(\"assigned_to, assigned_by, department_id\")\r\n          .eq(\"complaint_id\", complaintId);\r\n        for (const assignment of assignments || []) {\r\n          // Notify assigned officer\r\n          if (assignment.assigned_to) {\r\n            await this.notificationService.createNotification(\r\n              assignment.assigned_to,\r\n              \"complaint_reminder\",\r\n              \"Complaint Reminder\",\r\n              `Citizen has sent a reminder for complaint: \"${complaint.title}\"`,\r\n              {\r\n                priority: \"warning\",\r\n                link: `/lgu-officer/tasks/${complaintId}`,\r\n                metadata: { complaint_id: complaintId },\r\n              }\r\n            );\r\n          }\r\n          // Notify department admin\r\n          if (assignment.assigned_by) {\r\n            await this.notificationService.createNotification(\r\n              assignment.assigned_by,\r\n              \"complaint_reminder\",\r\n              \"Complaint Reminder\",\r\n              `Citizen has sent a reminder for complaint: \"${complaint.title}\"`,\r\n              {\r\n                priority: \"warning\",\r\n                link: `/lgu-admin/department-queue`,\r\n                metadata: { complaint_id: complaintId },\r\n              }\r\n            );\r\n          }\r\n        }\r\n      } catch (notifError) {\r\n        console.warn(\r\n          \"[COMPLAINT-SERVICE] Failed to send reminder notifications:\",\r\n          notifError.message\r\n        );\r\n      }\r\n      return reminder;\r\n    } catch (error) {\r\n      console.error(\"[COMPLAINT-SERVICE] Send reminder error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Get all false complaints\r\n   * @param {Object} filters - Filter options\r\n   * @returns {Promise<Object>} List of false complaints\r\n   */\r\n  async getFalseComplaints(filters = {}) {\r\n    try {\r\n      const Database = require(\"../config/database\");\r\n\r\n      const supabase = Database.getClient();\r\n      let query = supabase\r\n        .from(\"complaints\")\r\n        .select(\"*\")\r\n        .eq(\"is_false_complaint\", true)\r\n        .order(\"false_complaint_marked_at\", { ascending: false });\r\n      if (filters.limit) {\r\n        query = query.limit(filters.limit);\r\n      }\r\n      const { data, error } = await query;\r\n      if (error) throw error;\r\n      return {\r\n        success: true,\r\n        data: data || [],\r\n      };\r\n    } catch (error) {\r\n      console.error(\"Error getting false complaints:\", error);\r\n      return {\r\n        success: false,\r\n        error: error.message,\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get false complaint statistics\r\n   * @returns {Promise<Object>} Statistics about false complaints\r\n   */\r\n  async getFalseComplaintStatistics() {\r\n    try {\r\n      const Database = require(\"../config/database\");\r\n      const supabase = Database.getClient();\r\n\r\n      // Get total count of false complaints\r\n      const { count: total, error: countError } = await supabase\r\n        .from(\"complaints\")\r\n        .select(\"*\", { count: \"exact\", head: true })\r\n        .eq(\"is_false_complaint\", true);\r\n\r\n      if (countError) throw countError;\r\n\r\n      // Get recent false complaints (last 30 days)\r\n      const thirtyDaysAgo = new Date();\r\n      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n\r\n      const { count: recent, error: recentError } = await supabase\r\n        .from(\"complaints\")\r\n        .select(\"*\", { count: \"exact\", head: true })\r\n        .eq(\"is_false_complaint\", true)\r\n        .gte(\"false_complaint_marked_at\", thirtyDaysAgo.toISOString());\r\n\r\n      if (recentError) throw recentError;\r\n\r\n      return {\r\n        success: true,\r\n        data: {\r\n          total: total || 0,\r\n          recent: recent || 0,\r\n        },\r\n      };\r\n    } catch (error) {\r\n      console.error(\r\n        \"[COMPLAINT-SERVICE] Error getting false complaint stats:\",\r\n        error\r\n      );\r\n      return {\r\n        success: false,\r\n        error: error.message,\r\n      };\r\n    }\r\n  }\r\n  /**\r\n   * Get complaint evidence files from Supabase storage\r\n   * @param {string} complaintId - Complaint ID\r\n   * @param {Object} user - User object requesting the evidence\r\n   * @returns {Promise<Array>} Array of evidence files with signed URLs\r\n   */\r\n  async getComplaintEvidence(complaintId, user) {\r\n    try {\r\n      const Database = require(\"../config/database\");\r\n\r\n      const supabase = Database.getClient();\r\n      // First, verify the user has access to this complaint\r\n      const { data: complaint, error: complaintError } = await supabase\r\n        .from(\"complaints\")\r\n        .select(\"id, submitted_by, department_r, assigned_coordinator_id\")\r\n        .eq(\"id\", complaintId)\r\n        .single();\r\n      if (complaintError || !complaint) {\r\n        console.error(\r\n          `[COMPLAINT_SERVICE] Complaint not found:`,\r\n          complaintError\r\n        );\r\n        // Return empty array instead of throwing error - complaint might have been deleted\r\n        return [];\r\n      }\r\n      // Basic access control without external helpers\r\n      const role = (user?.role || \"\").toLowerCase();\r\n      const isCitizenOwner =\r\n        role === \"citizen\" && complaint.submitted_by === user?.id;\r\n      const isStaff = [\r\n        \"lgu\",\r\n        \"lgu-officer\",\r\n        \"lgu-admin\",\r\n        \"hr\",\r\n        \"complaint-coordinator\",\r\n        \"coordinator\",\r\n        \"super-admin\",\r\n      ].some((r) => role.includes(r));\r\n      if (!isCitizenOwner && !isStaff) {\r\n        // Return empty list instead of error to avoid breaking the UI\r\n        return [];\r\n      }\r\n      // List files in the complaint-evidence bucket for this complaint\r\n      const bucketName = \"complaint-evidence\";\r\n      // Get initial evidence files\r\n      const initialFolderPath = `${complaintId}/evidence/`;\r\n      const { data: initialFiles } = await supabase.storage\r\n        .from(bucketName)\r\n        .list(initialFolderPath);\r\n      // Get completion evidence files\r\n      const completionFolderPath = `${complaintId}/completion/`;\r\n      const { data: completionFiles } = await supabase.storage\r\n        .from(bucketName)\r\n        .list(completionFolderPath);\r\n      const allFiles = [];\r\n      // Process initial evidence\r\n      if (initialFiles && initialFiles.length > 0) {\r\n        for (const file of initialFiles) {\r\n          const filePath = `${initialFolderPath}${file.name}`;\r\n          const { data: signedUrl } = await supabase.storage\r\n            .from(bucketName)\r\n            .createSignedUrl(filePath, 3600);\r\n          if (signedUrl) {\r\n            allFiles.push({\r\n              name: file.name,\r\n              size: file.metadata?.size || 0,\r\n              url: signedUrl.signedUrl,\r\n              path: filePath,\r\n              type: \"initial\",\r\n              lastModified: file.updated_at || file.created_at,\r\n            });\r\n          }\r\n        }\r\n      }\r\n      // Process completion evidence\r\n      if (completionFiles && completionFiles.length > 0) {\r\n        for (const file of completionFiles) {\r\n          const filePath = `${completionFolderPath}${file.name}`;\r\n          const { data: signedUrl } = await supabase.storage\r\n            .from(bucketName)\r\n            .createSignedUrl(filePath, 3600);\r\n          if (signedUrl) {\r\n            allFiles.push({\r\n              name: file.name,\r\n              size: file.metadata?.size || 0,\r\n              url: signedUrl.signedUrl,\r\n              path: filePath,\r\n              type: \"completion\",\r\n              lastModified: file.updated_at || file.created_at,\r\n            });\r\n          }\r\n        }\r\n      }\r\n      return allFiles;\r\n    } catch (error) {\r\n      console.error(\r\n        \"[COMPLAINT_SERVICE] Error getting complaint evidence:\",\r\n        error\r\n      );\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Confirm resolution (Citizen side)\r\n   * @param {string} complaintId - Complaint ID\r\n   * @param {string} citizenId - Citizen user ID\r\n   * @param {boolean} confirmed - Whether citizen confirms the resolution\r\n   * @param {string} feedback - Optional feedback from citizen\r\n   * @returns {Promise<Object>} Result of confirmation\r\n   */\r\n  async confirmResolution(complaintId, citizenId, confirmed, _feedback = null) {\r\n    try {\r\n      // Use repository client (service-role) to avoid RLS issues\r\n      const { supabase } = this.complaintRepo;\r\n\r\n      // Bypass table update for now\r\n      const updatedComplaint = {\r\n        id: complaintId,\r\n        confirmed_by_citizen: confirmed,\r\n      };\r\n\r\n      // Call the database function to update confirmation status\r\n      await supabase.rpc(\"update_complaint_confirmation_status\", {\r\n        complaint_uuid: complaintId,\r\n      });\r\n      // Ensure final workflow reconciliation when confirmed\r\n      if (confirmed) {\r\n        try {\r\n          await this.reconcileWorkflowStatus(complaintId);\r\n        } catch (_) {}\r\n      }\r\n      return {\r\n        success: true,\r\n        data: updatedComplaint,\r\n        message: confirmed\r\n          ? \"Resolution confirmed successfully\"\r\n          : \"Resolution feedback recorded\",\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COMPLAINT_SERVICE] Error confirming resolution:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  async createAssignment(complaintId, officerIds, assignedBy) {\r\n    try {\r\n      // Validate complaint exists\r\n      await this.getComplaintById(complaintId);\r\n      // Create assignment records using the repository method\r\n      const assignments = await this.complaintRepo.createAssignments(\r\n        complaintId,\r\n        officerIds,\r\n        assignedBy\r\n      );\r\n      // Update complaint status\r\n      await this.updateComplaintStatus(complaintId, \"assigned to officer\");\r\n      return assignments;\r\n    } catch (error) {\r\n      console.error(\"[COMPLAINT-SERVICE] Error creating assignment:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Get confirmation message for a complaint based on confirmation status and user role\r\n   * @param {string} complaintId - Complaint ID\r\n   * @param {string} userRole - User role (citizen, lgu-admin, lgu-officer, complaint-coordinator, etc.)\r\n   * @returns {Promise<string>} Confirmation message\r\n   */\r\n  async getConfirmationMessage(complaintId, userRole) {\r\n    try {\r\n      const complaint = await this.complaintRepo.findById(complaintId);\r\n      if (!complaint) {\r\n        throw new Error(\"Complaint not found\");\r\n      }\r\n\r\n      const confirmationStatus = (\r\n        complaint.confirmation_status || \"pending\"\r\n      ).toLowerCase();\r\n      const workflowStatus = (complaint.workflow_status || \"new\").toLowerCase();\r\n      const isCitizen = userRole === \"citizen\";\r\n      const confirmedByCitizen = complaint.confirmed_by_citizen || false;\r\n      const allRespondersConfirmed =\r\n        complaint.all_responders_confirmed || false;\r\n\r\n      // Determine message based on confirmation status and role\r\n      switch (confirmationStatus) {\r\n        case \"waiting_for_complainant\":\r\n          if (isCitizen) {\r\n            return \"Please confirm if the resolution meets your expectations. Your confirmation is required to complete this complaint.\";\r\n          }\r\n          return \"Waiting for complainant's confirmation. The citizen needs to review and confirm the resolution.\";\r\n\r\n        case \"waiting_for_responders\":\r\n          if (isCitizen) {\r\n            return \"Waiting for responders' confirmation. Officers are reviewing the resolution.\";\r\n          }\r\n          return \"Please confirm the resolution. Officers need to confirm that the complaint has been resolved.\";\r\n\r\n        case \"confirmed\":\r\n          if (isCitizen) {\r\n            return \"Resolution confirmed. This complaint has been successfully resolved and confirmed by all parties.\";\r\n          }\r\n          return \"Resolution confirmed by all parties. This complaint is now complete.\";\r\n\r\n        case \"disputed\":\r\n          if (isCitizen) {\r\n            return \"Resolution disputed. The complaint resolution has been disputed and may require further review.\";\r\n          }\r\n          return \"Resolution disputed by complainant. The complaint may require additional action or review.\";\r\n\r\n        case \"pending\":\r\n        default:\r\n          // For pending status, provide context based on workflow status\r\n          if (\r\n            workflowStatus === \"completed\" ||\r\n            workflowStatus === \"pending_approval\"\r\n          ) {\r\n            if (isCitizen && !confirmedByCitizen) {\r\n              return \"Waiting for your confirmation. Please review the resolution and confirm if it meets your expectations.\";\r\n            } else if (!isCitizen && !allRespondersConfirmed) {\r\n              return \"Waiting for responders' confirmation. Officers need to confirm the resolution.\";\r\n            }\r\n            return \"Resolution pending confirmation from all parties.\";\r\n          } else if (\r\n            workflowStatus === \"in_progress\" ||\r\n            workflowStatus === \"assigned\"\r\n          ) {\r\n            return \"Complaint is being processed. Confirmation will be required once the resolution is complete.\";\r\n          }\r\n          return \"Complaint is pending review and assignment.\";\r\n      }\r\n    } catch (error) {\r\n      console.error(\r\n        \"[COMPLAINT_SERVICE] Error getting confirmation message:\",\r\n        error\r\n      );\r\n      // Return a default message instead of throwing\r\n      return \"Unable to load confirmation status.\";\r\n    }\r\n  }\r\n  /**\r\n   * Mark a complaint as false\r\n   * @param {string} complaintId - Complaint ID\r\n   * @param {string} userId - User ID marking the complaint\r\n   * @param {string} reason - Reason for marking as false\r\n   * @returns {Promise<Object>} Result\r\n   */\r\n  async markAsFalseComplaint(complaintId, userId, reason) {\r\n    try {\r\n      const complaint = await this.complaintRepo.getComplaintById(complaintId);\r\n      if (!complaint) {\r\n        throw new Error(\"Complaint not found\");\r\n      }\r\n\r\n      const { data: updatedComplaint, error: updateError } =\r\n        await this.complaintRepo.supabase\r\n          .from(\"complaints\")\r\n          .update({\r\n            is_false_complaint: true,\r\n            false_complaint_reason: reason,\r\n            workflow_status: \"rejected\",\r\n            marked_false_by: userId,\r\n            false_complaint_marked_at: new Date().toISOString(),\r\n            updated_at: new Date().toISOString(),\r\n          })\r\n          .eq(\"id\", complaintId)\r\n          .select()\r\n          .single();\r\n\r\n      if (updateError) throw updateError;\r\n\r\n      // Log action\r\n      try {\r\n        await this.complaintRepo.logAction(complaintId, \"marked_false\", {\r\n          reason,\r\n          details: { marked_by: userId },\r\n        });\r\n      } catch (logError) {\r\n        console.warn(\"[AUDIT] Log action failed:\", logError.message);\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        data: updatedComplaint,\r\n        message: \"Complaint marked as false successfully\",\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COMPLAINT_SERVICE] Error marking as false:\", error);\r\n      return {\r\n        success: false,\r\n        error: error.message,\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Mark a complaint as duplicate\r\n   * @param {string} complaintId - Complaint ID\r\n   * @param {string} masterComplaintId - Master Complaint ID\r\n   * @param {string} userId - User ID marking the duplicate\r\n   * @returns {Promise<Object>} Result\r\n   */\r\n  async markAsDuplicate(complaintId, masterComplaintId, userId) {\r\n    try {\r\n      const complaint = await this.complaintRepo.getComplaintById(complaintId);\r\n      if (!complaint) {\r\n        throw new Error(\"Complaint not found\");\r\n      }\r\n\r\n      const masterComplaint = await this.complaintRepo.getComplaintById(\r\n        masterComplaintId\r\n      );\r\n      if (!masterComplaint) {\r\n        throw new Error(\"Master complaint not found\");\r\n      }\r\n\r\n      const { data: updatedComplaint, error: updateError } =\r\n        await this.complaintRepo.supabase\r\n          .from(\"complaints\")\r\n          .update({\r\n            is_duplicate: true,\r\n            master_complaint_id: masterComplaintId,\r\n            workflow_status: \"closed\", // Or 'rejected'/'duplicate' if available\r\n            duplicate_marked_by: userId,\r\n            duplicate_marked_at: new Date().toISOString(),\r\n            updated_at: new Date().toISOString(),\r\n          })\r\n          .eq(\"id\", complaintId)\r\n          .select()\r\n          .single();\r\n\r\n      if (updateError) throw updateError;\r\n\r\n      // Log action\r\n      try {\r\n        await this.complaintRepo.logAction(complaintId, \"marked_duplicate\", {\r\n          reason: `Duplicate of ${masterComplaintId}`,\r\n          details: { marked_by: userId, master_id: masterComplaintId },\r\n        });\r\n      } catch (logError) {\r\n        console.warn(\"[AUDIT] Log action failed:\", logError.message);\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        data: updatedComplaint,\r\n        message: \"Complaint marked as duplicate successfully\",\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COMPLAINT_SERVICE] Error marking as duplicate:\", error);\r\n      return {\r\n        success: false,\r\n        error: error.message,\r\n      };\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = ComplaintService;\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\ComplianceService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\CoordinatorService.js","messages":[{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":598,"column":41,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":598,"endColumn":50},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":599,"column":50,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":599,"endColumn":59},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":600,"column":47,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":600,"endColumn":56},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":738,"column":48,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":738,"endColumn":49},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":738,"column":67,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":738,"endColumn":68}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const CoordinatorRepository = require(\"../repositories/CoordinatorRepository\");\r\nconst ComplaintAssignmentRepository = require(\"../repositories/ComplaintAssignmentRepository\");\r\nconst DepartmentRepository = require(\"../repositories/DepartmentRepository\");\r\nconst DuplicationDetectionService = require(\"./DuplicationDetectionService\");\r\nconst SimilarityCalculatorService = require(\"./SimilarityCalculatorService\");\r\nconst NotificationService = require(\"./NotificationService\");\r\nconst RuleBasedSuggestionService = require(\"./RuleBasedSuggestionService\");\r\nconst { classifyComplaints } = require(\"../utils/barangayClassifier\");\r\n\r\n/**\r\n* CoordinatorService\r\n* Business logic for coordinator operations\r\n*/\r\nclass CoordinatorService {\r\n\r\n  constructor(coordinatorRepo, assignmentRepo, departmentRepo, notificationService) {\r\n    this.coordinatorRepo = coordinatorRepo || new CoordinatorRepository();\r\n    // this.coordinatorRepo.setInConstructor = true; // Removed debug flag\r\n    this.assignmentRepo = assignmentRepo || new ComplaintAssignmentRepository();\r\n    this.departmentRepo = departmentRepo || new DepartmentRepository();\r\n    this.duplicationService = new DuplicationDetectionService();\r\n    this.similarityService = new SimilarityCalculatorService();\r\n    this.notificationService = notificationService || new NotificationService();\r\n    this.suggestionService = new RuleBasedSuggestionService();\r\n  }\r\n  /**\r\n  * Get review queue with algorithm results\r\n  */\r\n  async getReviewQueue(coordinatorId, filters = {}) {\r\n    try {\r\n      console.log(\"[COORDINATOR_SERVICE] Getting review queue for coordinator:\", coordinatorId);\r\n      const complaints = await this.coordinatorRepo.getReviewQueue(coordinatorId, filters);\r\n      console.log(`[COORDINATOR_SERVICE] Retrieved ${complaints.length} complaints from repository`);\r\n\r\n      // Log sample complaint to check structure\r\n      if (complaints.length > 0) {\r\n        const sample = complaints[0];\r\n        console.log(\"[COORDINATOR_SERVICE] Sample complaint structure:\", {\r\n          id: sample.id,\r\n          hasLatitude: sample.latitude != null,\r\n          hasLongitude: sample.longitude != null,\r\n          latitude: sample.latitude,\r\n          longitude: sample.longitude,\r\n          latType: typeof sample.latitude,\r\n          lngType: typeof sample.longitude\r\n        });\r\n      }\r\n\r\n      // Filter complaints with valid coordinates for barangay classification\r\n      const complaintsWithCoords = complaints.filter(c => {\r\n        const lat = parseFloat(c.latitude);\r\n        const lng = parseFloat(c.longitude);\r\n        const hasCoords = c.latitude != null && c.longitude != null &&\r\n                         !isNaN(lat) && !isNaN(lng) &&\r\n                         isFinite(lat) && isFinite(lng);\r\n        return hasCoords;\r\n      });\r\n\r\n      console.log(`[COORDINATOR_SERVICE] Found ${complaintsWithCoords.length} out of ${complaints.length} complaints with valid coordinates`);\r\n\r\n      // Classify complaints by barangay based on coordinates\r\n      let complaintBarangayMap = new Map();\r\n      try {\r\n        complaintBarangayMap = classifyComplaints(complaintsWithCoords);\r\n        console.log(`[COORDINATOR_SERVICE] Successfully classified ${complaintBarangayMap.size} complaints into barangays`);\r\n\r\n        // Log first few classifications\r\n        let loggedCount = 0;\r\n        complaintBarangayMap.forEach((barangay, complaintId) => {\r\n          if (loggedCount < 5) {\r\n            console.log(`[COORDINATOR_SERVICE] ✓ Complaint ${complaintId.substring(0, 8)}... → ${barangay}`);\r\n            loggedCount++;\r\n          }\r\n        });\r\n      } catch (classifyError) {\r\n        console.error(\"[COORDINATOR_SERVICE] Error classifying complaints:\", classifyError);\r\n        console.error(\"[COORDINATOR_SERVICE] Classification error stack:\", classifyError.stack);\r\n      }\r\n\r\n      // Enhance with algorithm confidence levels and barangay information\r\n      const enhanced = complaints.map(complaint => {\r\n        const hasSimilarities = complaint.similarities && complaint.similarities.length > 0;\r\n        const highConfidence = hasSimilarities &&\r\n          complaint.similarities.some(s => s.similarity_score >= 0.85);\r\n\r\n        // Get barangay from classification map\r\n        const barangay = complaintBarangayMap.get(complaint.id) || null;\r\n\r\n        const enhancedComplaint = {\r\n          ...complaint,\r\n          barangay, // Add barangay information\r\n          algorithm_flags: {\r\n            has_duplicates: hasSimilarities,\r\n            high_confidence_duplicate: highConfidence,\r\n            similarity_count: complaint.similarities?.length || 0,\r\n            needs_review: !complaint.is_duplicate && hasSimilarities\r\n          }\r\n        };\r\n\r\n        return enhancedComplaint;\r\n      });\r\n\r\n      const withBarangay = enhanced.filter(c => c.barangay != null).length;\r\n      console.log(`[COORDINATOR_SERVICE] ✓ Returning ${withBarangay} out of ${enhanced.length} complaints with barangay info`);\r\n\r\n      return enhanced;\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Get review queue error:\", error);\r\n      console.error(\"[COORDINATOR_SERVICE] Error stack:\", error.stack);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Get complaint for review with full analysis\r\n  */\r\n  async getComplaintForReview(complaintId, _coordinatorId) {\r\n    try {\r\n      const complaint = await this.coordinatorRepo.getComplaintForReview(complaintId);\r\n      // Run duplication detection if not already done\r\n      if (!complaint.similarities || complaint.similarities.length === 0) {\r\n        try {\r\n          const duplicates = await this.duplicationService.detectDuplicates(complaintId);\r\n          complaint.similarities = duplicates;\r\n        } catch (detectionError) {\r\n          console.warn(\"[COORDINATOR_SERVICE] Duplication detection failed:\", detectionError);\r\n          complaint.similarities = [];\r\n        }\r\n      }\r\n      // Get nearby complaints for geographic context\r\n      let nearbyComplaints = [];\r\n      if (complaint.latitude && complaint.longitude) {\r\n        try {\r\n          nearbyComplaints = await this.similarityService.findSimilarInRadius(\r\n            complaint.latitude,\r\n            complaint.longitude,\r\n            0.5, // 500m radius\r\n            { category: complaint.category }\r\n          );\r\n        } catch (nearbyError) {\r\n          console.warn(\"[COORDINATOR_SERVICE] Nearby search failed:\", nearbyError);\r\n        }\r\n      }\r\n      // Categorize similarities\r\n      const categorized = this.categorizeSimilarities(complaint.similarities);\r\n      // Compute rule-based suggestions (non-ML)\r\n      let suggestions = { departments: [], coordinator: null, disclaimer: \"\" };\r\n      try {\r\n        suggestions = await this.suggestionService.computeSuggestions(complaint);\r\n      } catch (sugErr) {\r\n        console.warn(\"[COORDINATOR_SERVICE] Suggestion compute failed:\", sugErr.message);\r\n      }\r\n      return {\r\n        complaint,\r\n        analysis: {\r\n          duplicate_candidates: categorized.veryHigh,\r\n          similar_complaints: categorized.high,\r\n          related_complaints: categorized.medium,\r\n          nearby_complaints: nearbyComplaints,\r\n          recommendation: this.generateRecommendation(complaint, categorized)\r\n        },\r\n        suggestions\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Get complaint for review error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Process coordinator decision\r\n  */\r\n  async processDecision(complaintId, decision, coordinatorId, data = {}) {\r\n    try {\r\n      switch (decision) {\r\n        case \"approve\":\r\n          // New workflow: approve with department assignment\r\n          if (!data.departments || data.departments.length === 0) {\r\n            throw new Error(\"Departments required for approval\");\r\n          }\r\n          return await this.approveComplaint(\r\n            complaintId,\r\n            data.departments,\r\n            coordinatorId,\r\n            data.options || {}\r\n          );\r\n        case \"reject\":\r\n          // New workflow: reject complaint\r\n          if (!data.reason) {\r\n            throw new Error(\"Rejection reason required\");\r\n          }\r\n          return await this.rejectComplaint(\r\n            complaintId,\r\n            coordinatorId,\r\n            data.reason\r\n          );\r\n        case \"mark_duplicate\":\r\n          if (!data.masterComplaintId) {\r\n            throw new Error(\"Master complaint ID required\");\r\n          }\r\n          return await this.markAsDuplicate(\r\n            complaintId,\r\n            data.masterComplaintId,\r\n            coordinatorId,\r\n            data.reason\r\n          );\r\n        case \"mark_unique\":\r\n          return await this.markAsUnique(complaintId, coordinatorId);\r\n        case \"mark_false\":\r\n          if (!data.reason) {\r\n            throw new Error(\"Please select a reason for marking this complaint as false.\");\r\n          }\r\n          return await this.markAsFalse(complaintId, coordinatorId, data.reason);\r\n        case \"assign_department\":\r\n        // Support single or multiple departments\r\n          if (!data.department && (!data.departments || data.departments.length === 0)) {\r\n            throw new Error(\"Department required\");\r\n          }\r\n          if (Array.isArray(data.departments) && data.departments.length > 0) {\r\n            return await this.assignToDepartments(\r\n              complaintId,\r\n              data.departments,\r\n              coordinatorId,\r\n              data.options || {}\r\n            );\r\n          }\r\n          return await this.assignToDepartment(\r\n            complaintId,\r\n            data.department,\r\n            coordinatorId,\r\n            data.options\r\n          );\r\n        case \"link_related\":\r\n          if (!data.relatedComplaintIds) {\r\n            throw new Error(\"Related complaint IDs required\");\r\n          }\r\n          return await this.linkRelatedComplaints(\r\n            complaintId,\r\n            data.relatedComplaintIds,\r\n            coordinatorId\r\n          );\r\n        default:\r\n          throw new Error(\"Invalid decision type\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Process decision error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Approve complaint with department assignment\r\n  */\r\n  async approveComplaint(complaintId, departments, coordinatorId, options = {}) {\r\n    try {\r\n      // console.log removed for security\r\n      // Update complaint status to approved\r\n      const { data: updated, error: updateError } = await this.coordinatorRepo.supabase\r\n        .from(\"complaints\")\r\n        .update({\r\n          status: \"approved\",\r\n          workflow_status: \"assigned\",\r\n          department_r: departments, // CRITICAL: Set department_r array so LGU admins can see assigned complaints\r\n          coordinator_notes: options.notes || null,\r\n          last_activity_at: new Date().toISOString(),\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq(\"id\", complaintId)\r\n        .select()\r\n        .single();\r\n      if (updateError) throw updateError;\r\n      // Assign to departments using existing method\r\n      const assignResult = await this.assignToDepartments(\r\n        complaintId,\r\n        departments,\r\n        coordinatorId,\r\n        options\r\n      );\r\n      // Log action\r\n      await this.coordinatorRepo.logAction(\r\n        complaintId,\r\n        \"approved\",\r\n        coordinatorId,\r\n        {\r\n          departments,\r\n          notes: options.notes,\r\n          message: \"Complaint approved and assigned to departments\"\r\n        }\r\n      );\r\n      // Notify citizen about approval and assignment\r\n      if (updated.submitted_by) {\r\n        await this.notificationService.notifyComplaintAssignedToOfficer(\r\n          updated.submitted_by,\r\n          complaintId,\r\n          updated.title,\r\n          { departments }\r\n        );\r\n      }\r\n      return {\r\n        success: true,\r\n        message: `Complaint approved and assigned to ${departments.length} department(s)`,\r\n        complaint: updated,\r\n        ...assignResult\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Approve complaint error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Mark complaint as duplicate\r\n  */\r\n  async markAsDuplicate(complaintId, masterComplaintId, coordinatorId, reason) {\r\n    try {\r\n      const complaint = await this.coordinatorRepo.getComplaintForReview(complaintId);\r\n      await this.coordinatorRepo.markAsDuplicate(\r\n        complaintId,\r\n        masterComplaintId,\r\n        coordinatorId,\r\n        reason || \"Duplicate complaint identified by coordinator\"\r\n      );\r\n      // Notify citizen that their complaint was marked as duplicate\r\n      try {\r\n        await this.notificationService.notifyComplaintDuplicate(\r\n          complaint.submitted_by,\r\n          complaintId,\r\n          complaint.title,\r\n          masterComplaintId\r\n        );\r\n      } catch (notifError) {\r\n        console.warn(\"[COORDINATOR] Failed to send duplicate notification:\", notifError.message);\r\n      }\r\n      return {\r\n        success: true,\r\n        message: \"Complaint marked as duplicate\",\r\n        master_complaint_id: masterComplaintId\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Mark duplicate error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Mark complaint as unique (not a duplicate)\r\n  */\r\n  async markAsUnique(complaintId, coordinatorId) {\r\n    try {\r\n      // Update all similarities to 'unique' decision\r\n      const complaint = await this.coordinatorRepo.getComplaintForReview(complaintId);\r\n      if (complaint.similarities && complaint.similarities.length > 0) {\r\n\r\n        for (const similarity of complaint.similarities) {\r\n          await this.coordinatorRepo.updateSimilarityDecision(\r\n            similarity.id,\r\n            \"unique\",\r\n            coordinatorId\r\n          );\r\n        }\r\n      }\r\n      // Log action\r\n      await this.coordinatorRepo.logAction(\r\n        complaintId,\r\n        \"marked_unique\",\r\n        coordinatorId,\r\n        { message: \"Coordinator confirmed this is a unique complaint\" }\r\n      );\r\n      return {\r\n        success: true,\r\n        message: \"Complaint marked as unique\"\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Mark unique error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Mark complaint as false\r\n   */\r\n  async markAsFalse(complaintId, coordinatorId, reason) {\r\n    try {\r\n      // console.log removed for security\r\n      // Update complaint status to false\r\n      const { data, error } = await this.coordinatorRepo.supabase\r\n        .from(\"complaints\")\r\n        .update({\r\n          status: \"false\",\r\n          workflow_status: \"cancelled\",\r\n          coordinator_notes: reason,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq(\"id\", complaintId)\r\n        .select()\r\n        .single();\r\n      if (error) {\r\n        console.error(\"[COORDINATOR_SERVICE] Mark false error:\", error);\r\n        throw error;\r\n      }\r\n      // Log action\r\n      await this.coordinatorRepo.logAction(\r\n        complaintId,\r\n        \"marked_false\",\r\n        coordinatorId,\r\n        {\r\n          message: \"Complaint marked as false\",\r\n          reason\r\n        }\r\n      );\r\n      // Send notification to complainant\r\n      try {\r\n        await this.notificationService.notifyComplaintStatusChange(\r\n          data.submitted_by,\r\n          complaintId,\r\n          \"false\",\r\n          \"Your complaint has been marked as false by the coordinator.\",\r\n          { reason }\r\n        );\r\n      } catch (notifError) {\r\n        console.warn(\"[COORDINATOR_SERVICE] Failed to send notification:\", notifError.message);\r\n      }\r\n      return {\r\n        success: true,\r\n        message: \"Complaint marked as false\"\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Mark false error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Reject complaint\r\n   */\r\n  async rejectComplaint(complaintId, coordinatorId, reason) {\r\n    try {\r\n      // Update complaint status to rejected\r\n      const { data, error } = await this.coordinatorRepo.supabase\r\n        .from(\"complaints\")\r\n        .update({\r\n          status: \"rejected\",\r\n          workflow_status: \"cancelled\",\r\n          coordinator_notes: reason,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq(\"id\", complaintId)\r\n        .select()\r\n        .single();\r\n      if (error) throw error;\r\n      // Log action\r\n      await this.coordinatorRepo.logAction(\r\n        complaintId,\r\n        \"rejected\",\r\n        coordinatorId,\r\n        { reason }\r\n      );\r\n      // Notify submitter\r\n      if (data.submitted_by) {\r\n        await this.notificationService.createNotification(\r\n          data.submitted_by,\r\n          \"complaint_rejected\",\r\n          \"Complaint Rejected\",\r\n          `Your complaint \"${data.title}\" has been rejected. Reason: ${reason}`,\r\n          {\r\n            priority: \"warning\",\r\n            link: `/citizen/complaints/${complaintId}`,\r\n            metadata: { complaint_id: complaintId, reason }\r\n          }\r\n        );\r\n      }\r\n      return {\r\n        success: true,\r\n        message: \"Complaint rejected\"\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Reject complaint error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Assign complaint to department\r\n  */\r\n  async assignToDepartment(complaintId, departmentName, coordinatorId, options = {}) {\r\n    try {\r\n      // Update complaint with department assignment\r\n      const assigned = await this.coordinatorRepo.assignToDepartment(\r\n        complaintId,\r\n        departmentName,\r\n        coordinatorId,\r\n        options\r\n      );\r\n      // Update department_r field in complaints table (critical for LGU admin visibility)\r\n      const { error: updateError } = await this.coordinatorRepo.supabase\r\n        .from(\"complaints\")\r\n        .update({\r\n          department_r: [departmentName], // CRITICAL: Set department_r array so LGU admins can see assigned complaints\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq(\"id\", complaintId);\r\n      if (updateError) {\r\n        console.warn(\"[COORDINATOR_SERVICE] Failed to update department_r field:\", updateError.message);\r\n      }\r\n      try {\r\n        const { data: dept, error: deptError } = await this.coordinatorRepo.supabase\r\n          .from(\"departments\")\r\n          .select(\"id\")\r\n          .eq(\"code\", departmentName)\r\n          .single();\r\n        if (deptError) {\r\n          console.warn(\"[COORDINATOR_SERVICE] Department not found:\", deptError.message);\r\n        } else {\r\n          // Create assignment record\r\n          const { data: _assignment, error: assignError } = await this.coordinatorRepo.supabase\r\n            .from(\"complaint_assignments\")\r\n            .insert({\r\n              complaint_id: complaintId,\r\n              department_id: dept.id,\r\n              assigned_by: coordinatorId,\r\n              assigned_to: options.assigned_to || null,\r\n              status: \"pending\",\r\n              priority: options.priority || \"medium\",\r\n              deadline: options.deadline || null\r\n            })\r\n            .select()\r\n            .single();\r\n          if (assignError) {\r\n            console.warn(\"[COORDINATOR_SERVICE] Assignment creation failed:\", assignError.message);\r\n          } else {\r\n            try {\r\n              // Notify specific officer if assigned\r\n              if (options.assigned_to) {\r\n                await this.notificationService.notifyTaskAssigned(\r\n                  options.assigned_to,\r\n                  complaintId,\r\n                  assigned.title || \"New Complaint\",\r\n                  options.priority || assigned.priority || \"medium\",\r\n                  options.deadline || assigned.response_deadline || null\r\n                );\r\n              }\r\n\r\n              // Notify department admins\r\n              await this.notificationService.notifyDepartmentAdminsByCode(\r\n                departmentName,\r\n                complaintId,\r\n                assigned.title || \"New Complaint\"\r\n              );\r\n\r\n            } catch (e) {\r\n              console.warn(\"[COORDINATOR_SERVICE] Notification failed:\", e.message);\r\n            }\r\n          }\r\n        }\r\n      } catch (assignmentError) {\r\n        console.warn(\"[COORDINATOR_SERVICE] Assignment process failed:\", assignmentError.message);\r\n      }\r\n      return {\r\n        success: true,\r\n        message: `Complaint assigned to ${departmentName}`,\r\n        complaint: assigned\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Assign department error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Assign complaint to multiple departments\r\n  */\r\n  async assignToDepartments(complaintId, departmentCodes, coordinatorId, options = {}) {\r\n    try {\r\n      const uniqueCodes = Array.from(new Set((departmentCodes || []).filter(Boolean)));\r\n      if (uniqueCodes.length === 0) {\r\n        throw new Error(\"No departments provided\");\r\n      }\r\n      // Validate department codes against dynamic directory\r\n      try {\r\n        const { validateDepartmentCodes } = require(\"../utils/departmentMapping\");\r\n\r\n        const { _validCodes, invalidCodes } = await validateDepartmentCodes(uniqueCodes);\r\n        if (invalidCodes.length > 0) {\r\n          const list = invalidCodes.join(\", \");\r\n          const err = new Error(`Invalid department code(s): ${list}`);\r\n          err.code = \"INVALID_DEPARTMENT_CODES\";\r\n          err.details = { invalidCodes };\r\n          throw err;\r\n        }\r\n      } catch (vErr) {\r\n        if (vErr.code === \"INVALID_DEPARTMENT_CODES\") throw vErr;\r\n        // On validator failure (e.g., DB down), proceed with a safe fallback: reject to avoid bad data\r\n        throw new Error(\"Unable to validate department codes at this time\");\r\n      }\r\n      // Set primary to first, others as secondary array\r\n      const _primary = uniqueCodes[0];\r\n      const _secondary = uniqueCodes.slice(1);\r\n      // Update complaint with arrays\r\n      const { data: updated, error: updErr } = await this.coordinatorRepo.supabase\r\n        .from(\"complaints\")\r\n        .update({\r\n          // primary_department: primary, // Removed - derived from department_r\r\n          // secondary_departments: secondary, // Removed - derived from department_r\r\n          // status: 'in progress', // Removed - derived from workflow_status\r\n          workflow_status: \"assigned\",\r\n          department_r: uniqueCodes, // CRITICAL: Set department_r array so LGU admins can see assigned complaints\r\n          priority: options.priority || undefined,\r\n          response_deadline: options.deadline || undefined,\r\n          coordinator_notes: options.notes || undefined,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq(\"id\", complaintId)\r\n        .select()\r\n        .single();\r\n      if (updErr) throw updErr;\r\n      // Create assignment rows for each department\r\n      for (const code of uniqueCodes) {\r\n        try {\r\n          const dept = await this.departmentRepo.findByCode(code);\r\n          if (!dept || !dept.id) continue;\r\n          await this.assignmentRepo.assign(\r\n            complaintId,\r\n            dept.id,\r\n            coordinatorId,\r\n            {\r\n              status: \"pending\",\r\n              priority: options.priority || \"medium\",\r\n              deadline: options.deadline || null\r\n            }\r\n          );\r\n          await this.notifyDepartmentAdmins(code, complaintId, updated.title || \"New Complaint\");\r\n        } catch (e) {\r\n          console.warn(\"[COORDINATOR_SERVICE] Per-dept assignment failed:\", code, e.message);\r\n        }\r\n      }\r\n      // Log action once with all departments\r\n      await this.coordinatorRepo.logAction(\r\n        complaintId,\r\n        \"assigned_to_departments\",\r\n        coordinatorId,\r\n        { departments: uniqueCodes }\r\n      );\r\n      return {\r\n        success: true,\r\n        message: `Complaint assigned to ${uniqueCodes.length} department(s)` ,\r\n        complaint: updated\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Assign to departments error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Link related complaints\r\n  */\r\n  async linkRelatedComplaints(complaintId, relatedIds, coordinatorId) {\r\n    try {\r\n      // Update similarities to 'related' decision\r\n      const complaint = await this.coordinatorRepo.getComplaintForReview(complaintId);\r\n      for (const relatedId of relatedIds) {\r\n        const similarity = complaint.similarities.find(\r\n          s => s.similar_complaint_id === relatedId\r\n        );\r\n        if (similarity) {\r\n          await this.coordinatorRepo.updateSimilarityDecision(\r\n            similarity.id,\r\n            \"related\",\r\n            coordinatorId\r\n          );\r\n        }\r\n      }\r\n      // Log action\r\n      await this.coordinatorRepo.logAction(\r\n        complaintId,\r\n        \"linked_related\",\r\n        coordinatorId,\r\n        { related_complaint_ids: relatedIds }\r\n      );\r\n      return {\r\n        success: true,\r\n        message: \"Complaints linked as related\"\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Link related error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Bulk assign complaints\r\n  */\r\n  async bulkAssign(complaintIds, departmentName, coordinatorId) {\r\n    try {\r\n      const assigned = await this.coordinatorRepo.bulkAssign(\r\n        complaintIds,\r\n        departmentName,\r\n        coordinatorId\r\n      );\r\n      // Create assignment records and notify admins for each complaint\r\n      try {\r\n        const dept = await this.departmentRepo.findByCode(departmentName);\r\n        if (dept && dept.id) {\r\n\r\n          for (const c of assigned) {\r\n            await this.assignmentRepo.assign(\r\n              c.id,\r\n              dept.id,\r\n              coordinatorId,\r\n              { status: \"pending\" }\r\n            );\r\n          }\r\n          // Notify department admins using the working method\r\n          console.log(\"[COORDINATOR_SERVICE] assignToDepartment calling notifyDepartmentAdmins. notificationService:\", this.notificationService);\r\n          await this.notifyDepartmentAdmins(departmentName, assigned[0]?.id, assigned[0]?.title || \"New Complaints\");\r\n        }\r\n      } catch (e) {\r\n        console.warn(\"[COORDINATOR_SERVICE] Bulk assignment/notification post-step failed:\", e.message);\r\n      }\r\n      return {\r\n        success: true,\r\n        message: `${assigned.length} complaints assigned to ${departmentName}`,\r\n        count: assigned.length\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Bulk assign error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Get rejected complaints\r\n   */\r\n  async getRejectedComplaints(coordinatorId, filters = {}) {\r\n    try {\r\n      return await this.coordinatorRepo.getRejectedComplaints(coordinatorId, filters);\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Get rejected complaints error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get coordinator dashboard data\r\n   */\r\n  async getDashboardData(coordinatorId) {\r\n    try {\r\n      // console.log removed for security\r\n      const today = new Date();\r\n      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);\r\n      // console.log removed for security\r\n      const pendingCount = await this.coordinatorRepo.getPendingReviewsCount(coordinatorId);\r\n      // console.log removed for security\r\n      const stats = await this.coordinatorRepo.getCoordinatorStats(\r\n        coordinatorId,\r\n        weekAgo.toISOString(),\r\n        today.toISOString()\r\n      );\r\n      // console.log removed for security\r\n      const recentQueue = await this.coordinatorRepo.getReviewQueue(coordinatorId, { limit: 10 });\r\n      // console.log removed for security\r\n      const clusters = await this.coordinatorRepo.getActiveClusters({ limit: 5 });\r\n      // console.log removed for security\r\n      const result = {\r\n        pending_reviews: pendingCount,\r\n        stats: {\r\n          ...stats,\r\n          period: \"last_7_days\"\r\n        },\r\n        recent_queue: recentQueue,\r\n        active_clusters: clusters\r\n      };\r\n      // console.log removed for security\r\n      return result;\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Get dashboard error:\", error);\r\n      console.error(\"[COORDINATOR_SERVICE] Error stack:\", error.stack);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Detect clusters in area\r\n   */\r\n  async detectClusters(options = {}) {\r\n    try {\r\n      const clusters = await this.similarityService.detectClusters(options);\r\n      return {\r\n        success: true,\r\n        clusters,\r\n        count: clusters.length\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Detect clusters error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Helper: Categorize similarities by confidence\r\n  */\r\n  categorizeSimilarities(similarities) {\r\n    return {\r\n      veryHigh: similarities.filter(s => s.similarity_score >= 0.85),\r\n      high: similarities.filter(s => s.similarity_score >= 0.70 && s.similarity_score < 0.85),\r\n      medium: similarities.filter(s => s.similarity_score >= 0.50 && s.similarity_score < 0.70),\r\n      low: similarities.filter(s => s.similarity_score < 0.50)\r\n    };\r\n  }\r\n  /**\r\n  * Helper: Generate recommendation based on analysis\r\n  */\r\n  generateRecommendation(complaint, categorized) {\r\n\r\n    if (categorized.veryHigh.length > 0) {\r\n      return {\r\n        action: \"review_duplicates\",\r\n        confidence: \"high\",\r\n        message: `High confidence duplicate detected. Review ${categorized.veryHigh.length} potential duplicate(s).`,\r\n        priority: \"urgent\"\r\n      };\r\n    }\r\n    if (categorized.high.length > 0) {\r\n      return {\r\n        action: \"review_similar\",\r\n        confidence: \"medium\",\r\n        message: `${categorized.high.length} similar complaint(s) found. Consider linking or merging.`,\r\n        priority: \"high\"\r\n      };\r\n    }\r\n    if (categorized.medium.length > 0) {\r\n      return {\r\n        action: \"review_related\",\r\n        confidence: \"low\",\r\n        message: `${categorized.medium.length} potentially related complaint(s). Review for patterns.`,\r\n        priority: \"medium\"\r\n      };\r\n    }\r\n    return {\r\n      action: \"assign_department\",\r\n      confidence: \"high\",\r\n      message: \"No duplicates detected. Proceed with department assignment.\",\r\n      priority: \"normal\"\r\n    };\r\n  }\r\n  /**\r\n  * Check if user is coordinator\r\n  */\r\n  async checkCoordinatorStatus(userId) {\r\n    try {\r\n      return await this.coordinatorRepo.isCoordinator(userId);\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Check status error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n      console.error('[COORDINATOR_SERVICE] Notify department admins error:', error);\r\n  /**\r\n   * LGU Admin sends reminder to officer about pending task\r\n   */\r\n  async sendOfficerReminder(adminId, officerId, complaintId, reminderType, customMessage = null) {\r\n    try {\r\n      // Get complaint details\r\n      const complaint = await this.coordinatorRepo.getComplaintForReview(complaintId);\r\n      if (!complaint) {\r\n        throw new Error(\"Complaint not found\");\r\n      }\r\n      // Get officer details\r\n      const { data: officer } = await this.coordinatorRepo.supabase\r\n        .from(\"auth.users\")\r\n        .select(\"raw_user_meta_data\")\r\n        .eq(\"id\", officerId)\r\n        .single();\r\n      const officerName = officer?.raw_user_meta_data?.name || \"Officer\";\r\n      // Determine reminder message based on type\r\n      let reminderMessage;\r\n      switch (reminderType) {\r\n        case \"pending_task\":\r\n          reminderMessage = customMessage || \"Please complete your assigned task\";\r\n          break;\r\n        case \"complete_assignment\":\r\n          reminderMessage = customMessage || \"Please mark your assignment as complete\";\r\n          break;\r\n        case \"overdue_task\":\r\n          reminderMessage = customMessage || \"Your task is overdue, please take immediate action\";\r\n          break;\r\n        default:\r\n          reminderMessage = customMessage || \"Please check your assigned task\";\r\n      }\r\n      // Send notification to officer\r\n      await this.notificationService.notifyPendingTaskReminder(\r\n        officerId,\r\n        complaintId,\r\n        complaint.title,\r\n        `${reminderMessage} (from LGU Admin)`\r\n      );\r\n      // Notify admin that reminder was sent\r\n      await this.notificationService.createNotification(\r\n        adminId,\r\n        \"officer_reminder_sent\",\r\n        \"Reminder Sent\",\r\n        `Reminder sent to ${officerName} for complaint: \"${complaint.title}\"`,\r\n        {\r\n          priority: \"info\",\r\n          link: `/lgu-admin/assignments`,\r\n          metadata: {\r\n            complaint_id: complaintId,\r\n            officer_id: officerId,\r\n            reminder_type: reminderType\r\n          }\r\n        }\r\n      );\r\n      // Log the reminder action\r\n      await this.coordinatorRepo.logAction(\r\n        complaintId,\r\n        \"admin_reminder_sent\",\r\n        adminId,\r\n        {\r\n          reminder_type: reminderType,\r\n          target_officer: officerId,\r\n          message: reminderMessage\r\n        }\r\n      );\r\n      return {\r\n        success: true,\r\n        message: `Reminder sent to officer successfully`\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Send officer reminder error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Check pending assignments that need attention\r\n   */\r\n  async getPendingAssignmentsSummary() {\r\n    try {\r\n      const { data: assignments, error } = await this.coordinatorRepo.supabase\r\n        .from(\"complaint_assignments\")\r\n        .select(`\r\n          *,\r\n          complaints!inner(id, title, workflow_status, submitted_at, priority),\r\n          departments(id, code, name)\r\n        `)\r\n        .eq(\"status\", \"pending\")\r\n        .order(\"created_at\", { ascending: false });\r\n      if (error) throw error;\r\n      // Group by officer and check for overdue items\r\n      const officerSummary = {};\r\n      const overdueItems = [];\r\n      for (const assignment of assignments) {\r\n        const officerId = assignment.assigned_to;\r\n        if (!officerId) continue;\r\n        // Initialize officer summary\r\n        if (!officerSummary[officerId]) {\r\n          officerSummary[officerId] = {\r\n            officer_id: officerId,\r\n            assignments_count: 0,\r\n            overdue_count: 0,\r\n            recent_complaints: []\r\n          };\r\n        }\r\n        officerSummary[officerId].assignments_count++;\r\n        // Check if overdue (no activity for 7 days)\r\n        const complaint = assignment.complaints;\r\n        const daysSinceAssignment = Math.floor(\r\n          (Date.now() - new Date(assignment.created_at).getTime()) / (1000 * 60 * 60 * 24)\r\n        );\r\n        if (daysSinceAssignment > 7) {\r\n          officerSummary[officerId].overdue_count++;\r\n          overdueItems.push({\r\n            assignment_id: assignment.id,\r\n            complaint_id: complaint.id,\r\n            complaint_title: complaint.title,\r\n            officer_id: officerId,\r\n            days_overdue: daysSinceAssignment\r\n          });\r\n        }\r\n        officerSummary[officerId].recent_complaints.push({\r\n          id: complaint.id,\r\n          title: complaint.title,\r\n          priority: complaint.priority,\r\n          assigned_days_ago: daysSinceAssignment\r\n        });\r\n      }\r\n      return {\r\n        success: true,\r\n        data: {\r\n          total_pending: assignments.length,\r\n          officers_needing_attention: Object.keys(officerSummary).length,\r\n          overdue_assignments: overdueItems.length,\r\n          officer_summary: officerSummary,\r\n          overdue_items: overdueItems\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[COORDINATOR_SERVICE] Get pending assignments summary error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = CoordinatorService;\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\DepartmentService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\DuplicationDetectionService.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":77,"column":37,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":77,"endColumn":38},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":77,"column":43,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":77,"endColumn":44},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":77,"column":43,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":77,"endColumn":44},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":77,"column":55,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":77,"endColumn":56},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":77,"column":61,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":77,"endColumn":62},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":77,"column":76,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":77,"endColumn":77},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":201,"column":27,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":201,"endColumn":28},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":201,"column":33,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":201,"endColumn":34},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":201,"column":33,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":201,"endColumn":34},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":202,"column":31,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":202,"endColumn":32},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":202,"column":37,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":202,"endColumn":38},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":203,"column":31,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":203,"endColumn":32},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":308,"column":26,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":308,"endColumn":27},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":308,"column":47,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":308,"endColumn":48},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":308,"column":47,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":308,"endColumn":48},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":310,"column":26,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":310,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":16,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const ComplaintRepository = require(\"../repositories/ComplaintRepository\");\r\nconst Database = require(\"../config/database\");\r\n\r\n/**\r\n* DuplicationDetectionService\r\n* Detects duplicate and similar complaints using multiple algorithms\r\n*/\r\nclass DuplicationDetectionService {\r\n\r\n  constructor() {\r\n    this.complaintRepo = new ComplaintRepository();\r\n    this.supabase = Database.getClient();\r\n  }\r\n  /**\r\n  * Main method to detect potential duplicates for a complaint\r\n  * @param {string} complaintId - The complaint to check\r\n  * @returns {Promise<Array>} Array of potential duplicates with scores\r\n  */\r\n  async detectDuplicates(complaintId) {\r\n    try {\r\n      const complaint = await this.complaintRepo.findById(complaintId);\r\n      if (!complaint) {\r\n        throw new Error(\"Complaint not found\");\r\n      }\r\n      // Convert Complaint model to plain object for similarity algorithms\r\n      const complaintData = complaint.toJSON ? complaint.toJSON() : complaint;\r\n\r\n      // Run multiple detection algorithms\r\n      const [\r\n        textMatches,\r\n        locationMatches,\r\n        temporalMatches\r\n      ] = await Promise.all([\r\n        this.findTextSimilarity(complaintData),\r\n        this.findLocationSimilarity(complaintData),\r\n        this.findTemporalSimilarity(complaintData)\r\n      ]);\r\n      // Merge and score results\r\n      const merged = this.mergeAndScore(textMatches, locationMatches, temporalMatches);\r\n      // Save results to database\r\n      await this.saveSimilarityResults(complaintId, merged);\r\n      return merged;\r\n    } catch (error) {\r\n      console.error(\"[DUPLICATION] Detection error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Find complaints with similar text content\r\n  * Uses Levenshtein distance and keyword matching\r\n  */\r\n  async findTextSimilarity(complaint) {\r\n    const { data: candidates, error } = await this.supabase\r\n      .from(\"complaints\")\r\n      .select(\"*\")\r\n      .neq(\"id\", complaint.id)\r\n      .eq(\"category\", complaint.category) // Same category\r\n      .gte(\"submitted_at\", this.getTimeThreshold(30)) // Last 30 days\r\n      .limit(50);\r\n    if (error) {\r\n      console.error(\"[DUPLICATION] Text similarity error:\", error);\r\n      return [];\r\n    }\r\n    return candidates.map(candidate => {\r\n      const titleScore = this.calculateTextSimilarity(\r\n        complaint.title.toLowerCase(),\r\n        candidate.title.toLowerCase()\r\n      );\r\n      const descScore = this.calculateTextSimilarity(\r\n        complaint.descriptive_su.toLowerCase(),\r\n        candidate.descriptive_su.toLowerCase()\r\n      );\r\n      const keywordScore = this.calculateKeywordOverlap(\r\n        `${complaint.title  } ${  complaint.descriptive_su}`,\r\n        `${candidate.title  } ${  candidate.descriptive_su}`\r\n      );\r\n      const textScore = (titleScore * 0.4 + descScore * 0.4 + keywordScore * 0.2);\r\n\r\n      return {\r\n        complaint_id: candidate.id,\r\n        score: textScore,\r\n        factors: {\r\n          titleSimilarity: titleScore,\r\n          descriptionSimilarity: descScore,\r\n          keywordOverlap: keywordScore\r\n        },\r\n        method: \"text\"\r\n      };\r\n    }).filter(result => result.score > 0.5); // Only return significant matches\r\n  }\r\n  /**\r\n  * Find complaints in similar geographic locations\r\n  */\r\n  async findLocationSimilarity(complaint) {\r\n    if (!complaint.latitude || !complaint.longitude) {\r\n      return [];\r\n    }\r\n    // Search within 1km radius\r\n    const _radiusKm = 1.0;\r\n    const { data: candidates, error } = await this.supabase\r\n      .from(\"complaints\")\r\n      .select(\"*\")\r\n      .neq(\"id\", complaint.id)\r\n      .not(\"latitude\", \"is\", null)\r\n      .not(\"longitude\", \"is\", null)\r\n      .gte(\"submitted_at\", this.getTimeThreshold(90)) // Last 90 days\r\n      .limit(100);\r\n    if (error) {\r\n      console.error(\"[DUPLICATION] Location similarity error:\", error);\r\n      return [];\r\n    }\r\n    return candidates.map(candidate => {\r\n      const distance = this.calculateDistance(\r\n        complaint.latitude,\r\n        complaint.longitude,\r\n        candidate.latitude,\r\n        candidate.longitude\r\n      );\r\n      // Score decreases with distance\r\n      let locationScore = 0;\r\n      if (distance <= 0.05) locationScore = 1.0;      // Within 50m: perfect match\r\n      else if (distance <= 0.1) locationScore = 0.9;  // Within 100m: very high\r\n      else if (distance <= 0.25) locationScore = 0.75; // Within 250m: high\r\n      else if (distance <= 0.5) locationScore = 0.5;  // Within 500m: medium\r\n      else if (distance <= 1.0) locationScore = 0.25; // Within 1km: low\r\n      else return null;\r\n      return {\r\n        complaint_id: candidate.id,\r\n        score: locationScore,\r\n        factors: {\r\n          distanceKm: distance,\r\n          sameStreet: this.isSameStreet(complaint.location_text, candidate.location_text)\r\n        },\r\n        method: \"location\"\r\n      };\r\n    }).filter(result => result !== null);\r\n  }\r\n  /**\r\n  * Find complaints submitted within similar time period\r\n  */\r\n  async findTemporalSimilarity(complaint) {\r\n    // Check for complaints within 7 days\r\n    const beforeDate = new Date(complaint.submitted_at);\r\n    beforeDate.setDate(beforeDate.getDate() - 7);\r\n    const afterDate = new Date(complaint.submitted_at);\r\n    afterDate.setDate(afterDate.getDate() + 7);\r\n    const { data: candidates, error } = await this.supabase\r\n      .from(\"complaints\")\r\n      .select(\"*\")\r\n      .neq(\"id\", complaint.id)\r\n      .eq(\"category\", complaint.category)\r\n      .gte(\"submitted_at\", beforeDate.toISOString())\r\n      .lte(\"submitted_at\", afterDate.toISOString())\r\n      .limit(50);\r\n    if (error) {\r\n      console.error(\"[DUPLICATION] Temporal similarity error:\", error);\r\n      return [];\r\n    }\r\n    return candidates.map(candidate => {\r\n      const timeDiff = Math.abs(\r\n        new Date(complaint.submitted_at) - new Date(candidate.submitted_at)\r\n      ) / (1000 * 60 * 60 * 24); // Days\r\n      // Score decreases with time difference\r\n      let temporalScore = 0;\r\n      if (timeDiff <= 1) temporalScore = 1.0;      // Same day\r\n      else if (timeDiff <= 3) temporalScore = 0.8; // Within 3 days\r\n      else if (timeDiff <= 7) temporalScore = 0.5; // Within week\r\n      else return null;\r\n      return {\r\n        complaint_id: candidate.id,\r\n        score: temporalScore,\r\n        factors: {\r\n          daysDifference: timeDiff\r\n        },\r\n        method: \"temporal\"\r\n      };\r\n    }).filter(result => result !== null);\r\n  }\r\n  /**\r\n  * Merge results from different algorithms and calculate final score\r\n  */\r\n  mergeAndScore(textMatches, locationMatches, temporalMatches) {\r\n    const allMatches = new Map();\r\n    // Combine all matches\r\n    [...textMatches, ...locationMatches, ...temporalMatches].forEach(match => {\r\n      if (!allMatches.has(match.complaint_id)) {\r\n        allMatches.set(match.complaint_id, {\r\n          complaint_id: match.complaint_id,\r\n          scores: { text: 0, location: 0, temporal: 0 },\r\n          factors: {}\r\n        });\r\n      }\r\n      const existing = allMatches.get(match.complaint_id);\r\n      existing.scores[match.method] = match.score;\r\n      existing.factors = { ...existing.factors, ...match.factors };\r\n    });\r\n    // Calculate weighted final score\r\n    const results = Array.from(allMatches.values()).map(match => {\r\n      // Weighted scoring: text (40%), location (40%), temporal (20%)\r\n      const finalScore =\r\n        match.scores.text * 0.4 +\r\n        match.scores.location * 0.4 +\r\n        match.scores.temporal * 0.2;\r\n      // Determine confidence level\r\n      let confidence = \"low\";\r\n      if (finalScore >= 0.85) confidence = \"very_high\";\r\n      else if (finalScore >= 0.75) confidence = \"high\";\r\n      else if (finalScore >= 0.60) confidence = \"medium\";\r\n      return {\r\n        similar_complaint_id: match.complaint_id,\r\n        similarity_score: finalScore,\r\n        confidence,\r\n        similarity_factors: {\r\n          textScore: match.scores.text,\r\n          locationScore: match.scores.location,\r\n          temporalScore: match.scores.temporal,\r\n          ...match.factors\r\n        }\r\n      };\r\n    });\r\n    // Sort by score descending\r\n    return results.sort((a, b) => b.similarity_score - a.similarity_score);\r\n  }\r\n  /**\r\n  * Save similarity results to database\r\n  */\r\n  async saveSimilarityResults(complaintId, results) {\r\n    const records = results.map(result => ({\r\n      complaint_id: complaintId,\r\n      similar_complaint_id: result.similar_complaint_id,\r\n      similarity_score: result.similarity_score,\r\n      similarity_factors: result.similarity_factors,\r\n      detected_at: new Date().toISOString()\r\n    }));\r\n    if (records.length === 0) return;\r\n    const { error } = await this.supabase\r\n      .from(\"complaint_similarities\")\r\n      .upsert(records, {\r\n        onConflict: \"complaint_id,similar_complaint_id\",\r\n        ignoreDuplicates: false\r\n      });\r\n    if (error) {\r\n      console.error(\"[DUPLICATION] Save error:\", error);\r\n    }\r\n  }\r\n  /**\r\n  * Calculate text similarity using Levenshtein distance\r\n  */\r\n  calculateTextSimilarity(str1, str2) {\r\n    const longer = str1.length > str2.length ? str1 : str2;\r\n    const shorter = str1.length > str2.length ? str2 : str1;\r\n    if (longer.length === 0) return 1.0;\r\n    const distance = this.levenshteinDistance(longer, shorter);\r\n    return (longer.length - distance) / longer.length;\r\n  }\r\n  /**\r\n  * Levenshtein distance algorithm\r\n  */\r\n  levenshteinDistance(str1, str2) {\r\n    const matrix = [];\r\n    for (let i = 0; i <= str2.length; i++) {\r\n      matrix[i] = [i];\r\n    }\r\n    for (let j = 0; j <= str1.length; j++) {\r\n      matrix[0][j] = j;\r\n    }\r\n    for (let i = 1; i <= str2.length; i++) {\r\n\r\n      for (let j = 1; j <= str1.length; j++) {\r\n        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {\r\n          matrix[i][j] = matrix[i - 1][j - 1];\r\n        } else {\r\n          matrix[i][j] = Math.min(\r\n            matrix[i - 1][j - 1] + 1,\r\n            matrix[i][j - 1] + 1,\r\n            matrix[i - 1][j] + 1\r\n          );\r\n        }\r\n      }\r\n    }\r\n    return matrix[str2.length][str1.length];\r\n  }\r\n  /**\r\n  * Calculate keyword overlap between two texts\r\n  */\r\n  calculateKeywordOverlap(text1, text2) {\r\n    const stopWords = new Set([\"the\", \"a\", \"an\", \"and\", \"or\", \"but\", \"in\", \"on\", \"at\", \"to\", \"for\", \"of\", \"with\", \"by\", \"from\", \"is\", \"are\", \"was\", \"were\"]);\r\n    const words1 = text1.toLowerCase().split(/\\W+/)\r\n      .filter(word => word.length > 3 && !stopWords.has(word));\r\n    const words2 = text2.toLowerCase().split(/\\W+/)\r\n      .filter(word => word.length > 3 && !stopWords.has(word));\r\n    const set1 = new Set(words1);\r\n    const set2 = new Set(words2);\r\n    const intersection = new Set([...set1].filter(word => set2.has(word)));\r\n    const union = new Set([...set1, ...set2]);\r\n    return union.size > 0 ? intersection.size / union.size : 0;\r\n  }\r\n  /**\r\n  * Calculate distance between two geographic points (Haversine formula)\r\n  * Returns distance in kilometers\r\n  */\r\n  calculateDistance(lat1, lon1, lat2, lon2) {\r\n    const R = 6371; // Earth's radius in km\r\n    const dLat = this.toRad(lat2 - lat1);\r\n    const dLon = this.toRad(lon2 - lon1);\r\n\r\n    const a =\r\n      Math.sin(dLat / 2) * Math.sin(dLat / 2) +\r\n      Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) *\r\n      Math.sin(dLon / 2) * Math.sin(dLon / 2);\r\n\r\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\r\n    return R * c;\r\n  }\r\n\r\n  toRad(degrees) {\r\n    return degrees * (Math.PI / 180);\r\n  }\r\n\r\n  /**\r\n  * Check if two locations are on the same street\r\n  */\r\n  isSameStreet(location1, location2) {\r\n    if (!location1 || !location2) return false;\r\n\r\n    const normalize = str => str.toLowerCase()\r\n      .replace(/street|st\\.|road|rd\\.|avenue|ave\\./gi, \"\")\r\n      .trim();\r\n    const loc1 = normalize(location1);\r\n    const loc2 = normalize(location2);\r\n    return loc1.includes(loc2) || loc2.includes(loc1);\r\n  }\r\n  /**\r\n  * Get timestamp threshold (X days ago)\r\n  */\r\n  getTimeThreshold(days) {\r\n    const date = new Date();\r\n    date.setDate(date.getDate() - days);\r\n    return date.toISOString();\r\n  }\r\n}\r\n\r\nmodule.exports = DuplicationDetectionService;\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\HRService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\IDVerificationService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\InsightsService.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":277,"column":50,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":277,"endColumn":51},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":277,"column":65,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":277,"endColumn":66},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":278,"column":51,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":278,"endColumn":52},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":278,"column":70,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":278,"endColumn":71},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":279,"column":52,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":279,"endColumn":53},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":279,"column":72,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":279,"endColumn":73},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":280,"column":51,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":280,"endColumn":52},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":280,"column":72,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":280,"endColumn":73},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":324,"column":41,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":324,"endColumn":42},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":325,"column":31,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":325,"endColumn":32},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":325,"column":35,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":325,"endColumn":36},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":326,"column":30,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":326,"endColumn":31},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":326,"column":34,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":326,"endColumn":35},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":327,"column":36,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":327,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":14,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Insights Service\r\n * Provides barangay prioritization insights based on complaint volume and clusters\r\n */\r\nconst Database = require(\"../config/database\");\r\nconst { classifyComplaints } = require(\"../utils/barangayClassifier\");\r\nconst SimilarityCalculatorService = require(\"./SimilarityCalculatorService\");\r\n\r\nclass InsightsService {\r\n  constructor() {\r\n    this.supabase = Database.getClient();\r\n    this.similarityService = new SimilarityCalculatorService();\r\n  }\r\n\r\n  /**\r\n   * Get barangay prioritization data for a given time period\r\n   * @param {string} period - 'daily', 'weekly', 'monthly', 'yearly'\r\n   * @returns {Promise<Array>} Array of barangay prioritization data\r\n   */\r\n  async getBarangayPrioritization(period = \"weekly\") {\r\n    try {\r\n      // Calculate date range based on period\r\n      const { startDate, endDate } = this.getDateRange(period);\r\n\r\n      // Get all complaints within the time period\r\n      const { data: complaints, error: complaintsError } = await this.supabase\r\n        .from(\"complaints\")\r\n        .select(\r\n          `\r\n          id,\r\n          submitted_by,\r\n          submitted_at,\r\n          latitude,\r\n          longitude,\r\n          location_text,\r\n          priority,\r\n          workflow_status\r\n        `\r\n        )\r\n        .gte(\"submitted_at\", startDate.toISOString())\r\n        .lte(\"submitted_at\", endDate.toISOString())\r\n        .neq(\"workflow_status\", \"cancelled\");\r\n\r\n      if (complaintsError) {\r\n        throw complaintsError;\r\n      }\r\n\r\n      // Classify complaints by barangay based on coordinates\r\n      const complaintBarangayMap = classifyComplaints(complaints);\r\n\r\n      console.log(\r\n        `[INSIGHTS] Classified ${complaintBarangayMap.size} out of ${complaints.length} complaints into barangays`\r\n      );\r\n\r\n      // Calculate clusters on-demand for the current period instead of using stale database clusters\r\n      // This ensures prioritization is based on current data, not outdated snapshots\r\n      let clusters = [];\r\n      if (complaints.length >= 3) {\r\n        try {\r\n          // Use DBSCAN clustering with reasonable parameters for prioritization\r\n          const clusterResults = this.similarityService.clusterComplaints(\r\n            complaints,\r\n            0.1, // 0.1 radius (requested)\r\n            5 // minimum 5 complaints per cluster\r\n          );\r\n\r\n          // clusterComplaints returns array with complaint_ids property\r\n          clusters = clusterResults\r\n            .map((cluster) => ({\r\n              complaint_ids: cluster.complaint_ids || [],\r\n            }))\r\n            .filter(\r\n              (cluster) =>\r\n                cluster.complaint_ids && cluster.complaint_ids.length > 0\r\n            );\r\n\r\n          console.log(\r\n            `[INSIGHTS] Calculated ${clusters.length} clusters on-demand for period ${period}`\r\n          );\r\n        } catch (error) {\r\n          console.warn(\r\n            \"[INSIGHTS] Error calculating clusters on-demand:\",\r\n            error.message\r\n          );\r\n          // Continue without clusters if calculation fails\r\n          clusters = [];\r\n        }\r\n      }\r\n\r\n      // Group complaints by barangay\r\n      const barangayData = new Map();\r\n      const allBarangays = [\r\n        \"Aplaya\",\r\n        \"Balabag\",\r\n        \"Binaton\",\r\n        \"Cogon\",\r\n        \"Colorado\",\r\n        \"Dawis\",\r\n        \"Dulangan\",\r\n        \"Goma\",\r\n        \"Igpit\",\r\n        \"Kiagot\",\r\n        \"Lungag\",\r\n        \"Mahayahay\",\r\n        \"Matti\",\r\n        \"Kapatagan (Rizal)\",\r\n        \"Ruparan\",\r\n        \"San Agustin\",\r\n        \"San Jose (Balutakay)\",\r\n        \"San Miguel (Odaca)\",\r\n        \"San Roque\",\r\n        \"Sinawilan\",\r\n        \"Soong\",\r\n        \"Tiguman\",\r\n        \"Tres de Mayo\",\r\n        \"Zone 1 (Pob.)\",\r\n        \"Zone 2 (Pob.)\",\r\n        \"Zone 3 (Pob.)\",\r\n      ];\r\n\r\n      // Initialize all barangays\r\n      allBarangays.forEach((barangay) => {\r\n        barangayData.set(barangay, {\r\n          barangay,\r\n          complaintCount: 0,\r\n          clusterCount: 0,\r\n          urgentCount: 0,\r\n          highPriorityCount: 0,\r\n          complaintIds: [],\r\n        });\r\n      });\r\n\r\n      // Count complaints per barangay based on coordinate classification\r\n      complaints.forEach((complaint) => {\r\n        const barangay = complaintBarangayMap.get(complaint.id);\r\n        if (barangay && barangayData.has(barangay)) {\r\n          const data = barangayData.get(barangay);\r\n          data.complaintCount++;\r\n          data.complaintIds.push(complaint.id);\r\n          if (complaint.priority === \"urgent\") {\r\n            data.urgentCount++;\r\n          }\r\n          if (complaint.priority === \"high\") {\r\n            data.highPriorityCount++;\r\n          }\r\n        } else if (!barangay) {\r\n          // Log unclassified complaints for debugging\r\n          console.warn(\r\n            `[INSIGHTS] Complaint ${complaint.id} could not be classified into a barangay. Coords: (${complaint.latitude}, ${complaint.longitude})`\r\n          );\r\n        }\r\n      });\r\n\r\n      // Count clusters per barangay\r\n      // A cluster belongs to a barangay if any complaint in the cluster belongs to that barangay\r\n      // AND the cluster contains at least one complaint from the current period\r\n      if (clusters && clusters.length > 0) {\r\n        const periodComplaintIds = new Set(complaints.map((c) => c.id));\r\n\r\n        clusters.forEach((cluster) => {\r\n          if (!cluster.complaint_ids || cluster.complaint_ids.length === 0)\r\n            return;\r\n\r\n          // Check if this cluster contains any complaints from the current period\r\n          const hasPeriodComplaints = cluster.complaint_ids.some((id) =>\r\n            periodComplaintIds.has(id)\r\n          );\r\n          if (!hasPeriodComplaints) {\r\n            // Skip clusters that don't contain any complaints from the current period\r\n            return;\r\n          }\r\n\r\n          const clusterBarangays = new Set();\r\n          cluster.complaint_ids.forEach((complaintId) => {\r\n            // Only count complaints from the current period\r\n            if (!periodComplaintIds.has(complaintId)) return;\r\n\r\n            // Find which barangay this complaint belongs to\r\n            for (const [barangay, data] of barangayData.entries()) {\r\n              if (data.complaintIds.includes(complaintId)) {\r\n                clusterBarangays.add(barangay);\r\n              }\r\n            }\r\n          });\r\n\r\n          // Add cluster count to each barangay that has complaints in this cluster\r\n          // Only count the cluster once per barangay, even if it has multiple complaints\r\n          clusterBarangays.forEach((barangay) => {\r\n            const data = barangayData.get(barangay);\r\n            if (data) {\r\n              data.clusterCount++;\r\n            }\r\n          });\r\n        });\r\n      }\r\n\r\n      // Calculate statistics for frequency thresholds\r\n      const allComplaintCounts = Array.from(barangayData.values()).map(\r\n        (d) => d.complaintCount\r\n      );\r\n      const avgComplaints =\r\n        allComplaintCounts.length > 0\r\n          ? allComplaintCounts.reduce((a, b) => a + b, 0) /\r\n            allComplaintCounts.length\r\n          : 0;\r\n\r\n      // Calculate frequency thresholds (low, medium, high)\r\n      const sortedCounts = [...allComplaintCounts].sort((a, b) => a - b);\r\n      const lowThreshold =\r\n        sortedCounts.length > 0\r\n          ? sortedCounts[Math.floor(sortedCounts.length * 0.33)] || 0\r\n          : 0;\r\n      const mediumThreshold =\r\n        sortedCounts.length > 0\r\n          ? sortedCounts[Math.floor(sortedCounts.length * 0.66)] || 0\r\n          : 0;\r\n      const highThreshold =\r\n        sortedCounts.length > 0\r\n          ? sortedCounts[sortedCounts.length - 1] || 0\r\n          : 0;\r\n\r\n      // Get ALL complaints (not just current period) for calculating averages\r\n      // We need historical data to calculate proper averages\r\n      const { data: allHistoricalComplaints, error: allComplaintsError } =\r\n        await this.supabase\r\n          .from(\"complaints\")\r\n          .select(\"id, submitted_at, latitude, longitude\")\r\n          .not(\"latitude\", \"is\", null)\r\n          .not(\"longitude\", \"is\", null)\r\n          .neq(\"workflow_status\", \"cancelled\");\r\n\r\n      if (allComplaintsError) {\r\n        console.warn(\r\n          \"[INSIGHTS] Error fetching historical complaints for averages:\",\r\n          allComplaintsError\r\n        );\r\n      }\r\n\r\n      // Classify all historical complaints by barangay\r\n      const allComplaintsBarangayMap =\r\n        allHistoricalComplaints && allHistoricalComplaints.length > 0\r\n          ? classifyComplaints(allHistoricalComplaints)\r\n          : new Map();\r\n\r\n      // Group all historical complaints by barangay\r\n      const barangayHistoricalComplaints = new Map();\r\n      allComplaintsBarangayMap.forEach((barangayName, complaintId) => {\r\n        if (!barangayHistoricalComplaints.has(barangayName)) {\r\n          barangayHistoricalComplaints.set(barangayName, []);\r\n        }\r\n        const complaint = allHistoricalComplaints.find(\r\n          (c) => c.id === complaintId\r\n        );\r\n        if (complaint) {\r\n          barangayHistoricalComplaints.get(barangayName).push(complaint);\r\n        }\r\n      });\r\n\r\n      // Calculate averages for each barangay across different periods\r\n      const calculateAveragesForBarangay = (barangayName) => {\r\n        const averages = {\r\n          daily: 0,\r\n          weekly: 0,\r\n          monthly: 0,\r\n          yearly: 0,\r\n        };\r\n\r\n        // Get all historical complaints for this barangay\r\n        const barangayComplaints =\r\n          barangayHistoricalComplaints.get(barangayName) || [];\r\n\r\n        if (barangayComplaints.length === 0) {\r\n          return averages;\r\n        }\r\n\r\n        const now = new Date();\r\n        const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);\r\n        const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\r\n        const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\r\n        const oneYearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);\r\n\r\n        // Count complaints in each period\r\n        const _dailyCount = barangayComplaints.filter(\r\n          (c) => new Date(c.submitted_at) >= oneDayAgo\r\n        ).length;\r\n        const weeklyCount = barangayComplaints.filter(\r\n          (c) => new Date(c.submitted_at) >= oneWeekAgo\r\n        ).length;\r\n        const monthlyCount = barangayComplaints.filter(\r\n          (c) => new Date(c.submitted_at) >= oneMonthAgo\r\n        ).length;\r\n        const yearlyCount = barangayComplaints.filter(\r\n          (c) => new Date(c.submitted_at) >= oneYearAgo\r\n        ).length;\r\n\r\n        // Calculate averages (complaints per period)\r\n        // Daily: average complaints per day (based on last 7 days)\r\n        averages.daily =\r\n          weeklyCount > 0 ? Math.round((weeklyCount / 7) * 100) / 100 : 0;\r\n\r\n        // Weekly: average complaints per week (based on last 30 days)\r\n        averages.weekly =\r\n          monthlyCount > 0\r\n            ? Math.round((monthlyCount / 30) * 7 * 100) / 100\r\n            : 0;\r\n\r\n        // Monthly: average complaints per month (based on last 365 days)\r\n        averages.monthly =\r\n          yearlyCount > 0\r\n            ? Math.round((yearlyCount / 365) * 30 * 100) / 100\r\n            : 0;\r\n\r\n        // Yearly: total complaints in last year\r\n        averages.yearly = yearlyCount;\r\n\r\n        return averages;\r\n      };\r\n\r\n      // Calculate prioritization score for each barangay\r\n      // Score = (complaintCount * 1) + (clusterCount * 5) + (urgentCount * 3) + (highPriorityCount * 2)\r\n      const prioritizationData = Array.from(barangayData.entries()).map(\r\n        ([barangayName, data]) => {\r\n          const prioritizationScore =\r\n            Number(data.complaintCount) +\r\n            data.clusterCount * 5 +\r\n            data.urgentCount * 3 +\r\n            data.highPriorityCount * 2;\r\n\r\n          // Determine frequency level\r\n          let frequencyLevel = \"low\";\r\n          if (data.complaintCount >= highThreshold) {\r\n            frequencyLevel = \"high\";\r\n          } else if (data.complaintCount >= mediumThreshold) {\r\n            frequencyLevel = \"medium\";\r\n          }\r\n\r\n          // Calculate averages for this barangay (using all historical complaints)\r\n          const averages = calculateAveragesForBarangay(barangayName);\r\n\r\n          return {\r\n            ...data,\r\n            prioritizationScore,\r\n            frequencyLevel,\r\n            averages,\r\n            rank: 0, // Will be set after sorting\r\n          };\r\n        }\r\n      );\r\n\r\n      // Sort by prioritization score (descending) and assign ranks\r\n      prioritizationData.sort(\r\n        (a, b) => b.prioritizationScore - a.prioritizationScore\r\n      );\r\n      prioritizationData.forEach((item, index) => {\r\n        item.rank = index + 1;\r\n      });\r\n\r\n      return {\r\n        period,\r\n        startDate: startDate.toISOString(),\r\n        endDate: endDate.toISOString(),\r\n        statistics: {\r\n          averageComplaints: Math.round(avgComplaints * 100) / 100,\r\n          frequencyThresholds: {\r\n            low: lowThreshold,\r\n            medium: mediumThreshold,\r\n            high: highThreshold,\r\n          },\r\n        },\r\n        barangays: prioritizationData,\r\n      };\r\n    } catch (error) {\r\n      console.error(\r\n        \"[INSIGHTS_SERVICE] Get barangay prioritization error:\",\r\n        error\r\n      );\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get date range for a given period\r\n   * @param {string} period - 'daily', 'weekly', 'monthly', 'yearly'\r\n   * @returns {Object} { startDate, endDate }\r\n   */\r\n  getDateRange(period) {\r\n    const endDate = new Date();\r\n    endDate.setHours(23, 59, 59, 999); // End of today\r\n\r\n    const startDate = new Date();\r\n\r\n    switch (period) {\r\n      case \"daily\":\r\n        startDate.setHours(0, 0, 0, 0); // Start of today\r\n        break;\r\n      case \"weekly\":\r\n        startDate.setDate(startDate.getDate() - 7);\r\n        startDate.setHours(0, 0, 0, 0);\r\n        break;\r\n      case \"monthly\":\r\n        startDate.setMonth(startDate.getMonth() - 1);\r\n        startDate.setHours(0, 0, 0, 0);\r\n        break;\r\n      case \"yearly\":\r\n        startDate.setFullYear(startDate.getFullYear() - 1);\r\n        startDate.setHours(0, 0, 0, 0);\r\n        break;\r\n      default:\r\n        startDate.setDate(startDate.getDate() - 7);\r\n        startDate.setHours(0, 0, 0, 0);\r\n    }\r\n\r\n    return { startDate, endDate };\r\n  }\r\n}\r\n\r\nmodule.exports = InsightsService;\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\LguOfficerService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\NotificationService.js","messages":[{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":75,"column":9,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":75,"endColumn":29},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":162,"column":48,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":162,"endColumn":49},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":162,"column":63,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":162,"endColumn":64},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":485,"column":22,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":487,"endColumn":35},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":505,"column":27,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":507,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Database = require(\"../config/database\");\r\n\r\nconst {\r\n  NOTIFICATION_TYPES,\r\n  NOTIFICATION_PRIORITY,\r\n  NOTIFICATION_ICONS\r\n} = require(\"../../shared/constants\");\r\n/**\r\n* NotificationService\r\n* Handles all notification-related operations\r\n*/\r\nclass NotificationService {\r\n\r\n  constructor() {\r\n    this.db = Database.getInstance();\r\n    this.supabase = this.db.getClient();\r\n  }\r\n  /**\r\n  * Notify all admins of a department (lgu-admin variants) about a new complaint assignment\r\n  * Department matching by code suffix in role (e.g., lgu-admin-{dept}) and/or profile metadata\r\n  */\r\n  async notifyDepartmentAdminsByCode(departmentCode, complaintId, complaintTitle) {\r\n    try {\r\n      // Use RPC for efficient lookup (O(1) instead of O(N))\r\n      const { data: admins, error } = await this.supabase.rpc(\"get_users_by_role\", {\r\n        p_role: \"lgu-admin\",\r\n        p_department: departmentCode\r\n      });\r\n\r\n      if (error) {\r\n        console.warn(\"[NOTIFICATION] Failed to fetch admins via RPC:\", error.message);\r\n        return { success: false, error: error.message };\r\n      }\r\n      // console.log removed for security\r\n      if (admins.length === 0) {\r\n        console.warn(`[NOTIFICATION] No LGU admins found for department ${departmentCode}`);\r\n        return { success: true, count: 0 };\r\n      }\r\n      const notifications = admins.map((admin) => ({\r\n        userId: admin.id,\r\n        type: NOTIFICATION_TYPES.APPROVAL_REQUIRED,\r\n        title: \"New Complaint Assigned to Your Department\",\r\n        message: `\"${complaintTitle}\" has been assigned to ${departmentCode}. Please review and assign to an officer.`,\r\n        priority: NOTIFICATION_PRIORITY.INFO,\r\n        link: `/lgu-admin/assignments`,\r\n        metadata: {\r\n          complaint_id: complaintId,\r\n          department: departmentCode,\r\n          assigned_at: new Date().toISOString()\r\n        }\r\n      }));\r\n      return this.createBulkNotifications(notifications);\r\n    } catch (error) {\r\n      console.error(\"[NOTIFICATION] notifyDepartmentAdminsByCode error:\", error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  }\r\n  /**\r\n  * Create a new notification with deduplication\r\n  * Supports both object and individual parameter syntax\r\n  * @param {string|object} userIdOrOptions - User ID or options object\r\n  * @param {string} type - Notification type from NOTIFICATION_TYPES\r\n  * @param {string} title - Notification title\r\n  * @param {string} message - Notification message\r\n  * @param {object} options - Additional options\r\n  * @returns {object} Created notification\r\n  */\r\n  async createNotification(userIdOrOptions, type, title, message, options = {}) {\r\n    try {\r\n      // Support both calling patterns\r\n      let userId, notifType, notifTitle, notifMessage, notifOptions;\r\n      if (typeof userIdOrOptions === \"object\" && !type) {\r\n        // Object syntax: createNotification({ userId, type, title, message, ... })\r\n        const opts = userIdOrOptions;\r\n        userId = opts.userId;\r\n        notifType = opts.type;\r\n        notifTitle = opts.title;\r\n        notifMessage = opts.message;\r\n        notifOptions = {\r\n          priority: opts.priority,\r\n          link: opts.link,\r\n          metadata: opts.metadata,\r\n          icon: opts.icon,\r\n          deduplicate: opts.deduplicate !== false // Default to true\r\n        };\r\n      } else {\r\n        // Individual parameter syntax: createNotification(userId, type, title, message, options)\r\n        userId = userIdOrOptions;\r\n        notifType = type;\r\n        notifTitle = title;\r\n        notifMessage = message;\r\n        notifOptions = options;\r\n      }\r\n      const {\r\n        priority = NOTIFICATION_PRIORITY.INFO,\r\n        link = null,\r\n        metadata = {},\r\n        icon = NOTIFICATION_ICONS[notifType] || \"📢\",\r\n        deduplicate = true\r\n      } = notifOptions;\r\n      // Check for duplicates if deduplication is enabled\r\n      if (deduplicate) {\r\n        const duplicateCheck = await this.checkDuplicateNotification(\r\n          userId,\r\n          notifType,\r\n          notifTitle,\r\n          metadata\r\n        );\r\n        if (duplicateCheck.exists) {\r\n          // console.log removed for security\r\n          return {\r\n            success: true,\r\n            notification: duplicateCheck.notification,\r\n            duplicate: true\r\n          };\r\n        }\r\n      }\r\n      const { data, error } = await this.supabase\r\n        .from(\"notification\")\r\n        .insert([{\r\n          user_id: userId,\r\n          type: notifType,\r\n          priority,\r\n          title: notifTitle,\r\n          message: notifMessage,\r\n          icon,\r\n          link,\r\n          metadata\r\n        }])\r\n        .select()\r\n        .single();\r\n      if (error) throw error;\r\n      // console.log removed for security\r\n      return {\r\n        success: true,\r\n        notification: data,\r\n        duplicate: false\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[NOTIFICATION] Create error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Check for duplicate notifications\r\n   * @param {string} userId - User ID\r\n   * @param {string} type - Notification type\r\n   * @param {string} title - Notification title\r\n   * @param {object} metadata - Notification metadata\r\n   * @returns {object} Duplicate check result\r\n   */\r\n  async checkDuplicateNotification(userId, type, title, _metadata = {}) {\r\n    try {\r\n      // console.log removed for security\r\n      const { data, error } = await this.supabase\r\n        .from(\"notification\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", userId)\r\n        .eq(\"type\", type)\r\n        .eq(\"title\", title)\r\n        .eq(\"read\", false) // Only check unread notifications\r\n        .gte(\"created_at\", new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()) // Within last 24 hours\r\n        .order(\"created_at\", { ascending: false })\r\n        .limit(1);\r\n      if (error) {\r\n        console.warn(\"[NOTIFICATION] Duplicate check error:\", error.message);\r\n        return { exists: false };\r\n      }\r\n      const exists = data && data.length > 0;\r\n      // console.log removed for security\r\n      return {\r\n        exists,\r\n        notification: data && data.length > 0 ? data[0] : null\r\n      };\r\n    } catch (error) {\r\n      console.warn(\"[NOTIFICATION] Duplicate check error:\", error.message);\r\n      return { exists: false };\r\n    }\r\n  }\r\n  /**\r\n  * Create multiple notifications (bulk) with deduplication\r\n  * @param {Array} notifications - Array of notification objects\r\n  * @param {boolean} deduplicate - Whether to check for duplicates (default: true)\r\n  */\r\n  async createBulkNotifications(notifications, deduplicate = true) {\r\n    try {\r\n      if (!deduplicate) {\r\n        // Simple bulk insert without deduplication\r\n        const notificationsData = notifications.map(notif => ({\r\n          user_id: notif.userId,\r\n          type: notif.type,\r\n          priority: notif.priority || NOTIFICATION_PRIORITY.INFO,\r\n          title: notif.title,\r\n          message: notif.message,\r\n          icon: notif.icon || NOTIFICATION_ICONS[notif.type] || \"📢\",\r\n          link: notif.link || null,\r\n          metadata: notif.metadata || {}\r\n        }));\r\n        const { data, error } = await this.supabase\r\n          .from(\"notification\")\r\n          .insert(notificationsData)\r\n          .select();\r\n        if (error) throw error;\r\n        // console.log removed for security\r\n        return {\r\n          success: true,\r\n          notifications: data,\r\n          count: data.length,\r\n          duplicates: 0\r\n        };\r\n      }\r\n      // With deduplication - process each notification individually\r\n      const results = {\r\n        success: true,\r\n        notifications: [],\r\n        duplicates: 0,\r\n        errors: 0\r\n      };\r\n      for (const notif of notifications) {\r\n        try {\r\n          const result = await this.createNotification({\r\n            userId: notif.userId,\r\n            type: notif.type,\r\n            title: notif.title,\r\n            message: notif.message,\r\n            priority: notif.priority,\r\n            link: notif.link,\r\n            metadata: notif.metadata,\r\n            icon: notif.icon,\r\n            deduplicate: true\r\n          });\r\n          if (result.duplicate) {\r\n            results.duplicates++;\r\n          } else {\r\n            results.notifications.push(result.notification);\r\n          }\r\n        } catch (error) {\r\n          console.warn(`[NOTIFICATION] Failed to create notification for user ${notif.userId}:`, error.message);\r\n          results.errors++;\r\n        }\r\n      }\r\n      // console.log removed for security\r\n      return results;\r\n    } catch (error) {\r\n      console.error(\"[NOTIFICATION] Bulk create error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Notify multiple users about the same event with deduplication\r\n   * @param {Array} userIds - Array of user IDs\r\n   * @param {string} type - Notification type\r\n   * @param {string} title - Notification title\r\n   * @param {string} message - Notification message\r\n   * @param {object} options - Additional options\r\n   * @returns {object} Notification results\r\n   */\r\n  async notifyMultipleUsers(userIds, type, title, message, options = {}) {\r\n    try {\r\n      // console.log removed for security\r\n      const notifications = userIds.map(userId => ({\r\n        userId,\r\n        type,\r\n        title,\r\n        message,\r\n        ...options\r\n      }));\r\n      return await this.createBulkNotifications(notifications, true);\r\n    } catch (error) {\r\n      console.error(\"[NOTIFICATION] Notify multiple users error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Get user notifications (paginated)\r\n  * @param {string} userId - User ID\r\n  * @param {number} page - Page number (0-indexed)\r\n  * @param {number} limit - Items per page\r\n  * @returns {object} Paginated notifications\r\n  */\r\n  async getUserNotifications(userId, page = 0, limit = 10) {\r\n    try {\r\n      const offset = page * limit;\r\n      // Get notifications\r\n      const { data, error, count } = await this.supabase\r\n        .from(\"notification\")\r\n        .select(\"*\", { count: \"exact\" })\r\n        .eq(\"user_id\", userId)\r\n        .order(\"created_at\", { ascending: false })\r\n        .range(offset, offset + limit - 1);\r\n      if (error) throw error;\r\n      const hasMore = (offset + limit) < count;\r\n\r\n      return {\r\n        success: true,\r\n        data: {\r\n          notifications: data || [],\r\n          total: count,\r\n          page,\r\n          limit,\r\n          hasMore\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[NOTIFICATION] Get notifications error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Get unread notification count for user\r\n  * @param {string} userId - User ID\r\n  * @returns {number} Unread count\r\n  */\r\n  async getUnreadCount(userId) {\r\n    try {\r\n      const { count, error } = await this.supabase\r\n        .from(\"notification\")\r\n        .select(\"*\", { count: \"exact\", head: true })\r\n        .eq(\"user_id\", userId)\r\n        .eq(\"read\", false);\r\n      if (error) throw error;\r\n      return {\r\n        success: true,\r\n        count: count || 0\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[NOTIFICATION] Get unread count error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Mark notification as read\r\n  * @param {string} notificationId - Notification ID\r\n  * @param {string} userId - User ID (for security check)\r\n  * @returns {object} Updated notification\r\n  */\r\n  async markAsRead(notificationId, userId) {\r\n    try {\r\n      const { data, error } = await this.supabase\r\n        .from(\"notification\")\r\n        .update({\r\n          read: true,\r\n          read_at: new Date().toISOString()\r\n        })\r\n        .eq(\"id\", notificationId)\r\n        .eq(\"user_id\", userId)\r\n        .select()\r\n        .single();\r\n      if (error) throw error;\r\n      return {\r\n        success: true,\r\n        notification: data\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[NOTIFICATION] Mark as read error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Mark all user notifications as read\r\n  * @param {string} userId - User ID\r\n  * @returns {object} Update result\r\n  */\r\n  async markAllAsRead(userId) {\r\n    try {\r\n      const { data, error } = await this.supabase\r\n        .from(\"notification\")\r\n        .update({\r\n          read: true,\r\n          read_at: new Date().toISOString()\r\n        })\r\n        .eq(\"user_id\", userId)\r\n        .eq(\"read\", false)\r\n        .select();\r\n      if (error) throw error;\r\n      // console.log removed for security\r\n      return {\r\n        success: true,\r\n        count: data.length\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[NOTIFICATION] Mark all as read error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Delete a notification\r\n  * @param {string} notificationId - Notification ID\r\n  * @param {string} userId - User ID (for security check)\r\n  */\r\n  async deleteNotification(notificationId, userId) {\r\n    try {\r\n      const { error } = await this.supabase\r\n        .from(\"notification\")\r\n        .delete()\r\n        .eq(\"id\", notificationId)\r\n        .eq(\"user_id\", userId);\r\n      if (error) throw error;\r\n      return {\r\n        success: true\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[NOTIFICATION] Delete error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Delete expired notifications (cleanup job)\r\n  * Removes notifications older than their expires_at date\r\n  */\r\n  async deleteExpiredNotifications() {\r\n    try {\r\n      const { data, error } = await this.supabase\r\n        .from(\"notification\")\r\n        .delete()\r\n        .lt(\"expires_at\", new Date().toISOString())\r\n        .select();\r\n      if (error) throw error;\r\n      // console.log removed for security\r\n      return {\r\n        success: true,\r\n        deleted: data?.length || 0\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[NOTIFICATION] Delete expired error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Get notification summary for email\r\n  * Groups notifications by priority\r\n  * @param {string} userId - User ID\r\n  * @returns {object} Notification summary\r\n  */\r\n  async getNotificationSummary(userId) {\r\n    try {\r\n      const { data, error } = await this.supabase\r\n        .from(\"notification\")\r\n        .select(\"priority, type\")\r\n        .eq(\"user_id\", userId)\r\n        .eq(\"read\", false);\r\n      if (error) throw error;\r\n      const summary = {\r\n        total: data.length,\r\n        urgent: data.filter(n => n.priority === NOTIFICATION_PRIORITY.URGENT).length,\r\n        warning: data.filter(n => n.priority === NOTIFICATION_PRIORITY.WARNING).length,\r\n        info: data.filter(n => n.priority === NOTIFICATION_PRIORITY.INFO).length\r\n      };\r\n      return {\r\n        success: true,\r\n        summary\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[NOTIFICATION] Get summary error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  // ==================== ROLE-SPECIFIC NOTIFICATION HELPERS ====================\r\n  /**\r\n  * Notify citizen about complaint submission\r\n  */\r\n  async notifyComplaintSubmitted(citizenId, complaintId, complaintTitle) {\r\n    return this.createNotification(\r\n      citizenId,\r\n      NOTIFICATION_TYPES.COMPLAINT_SUBMITTED,\r\n      \"Complaint Submitted\",\r\n      `Your complaint \"${complaintTitle}\" has been received and is being reviewed.`,\r\n      {\r\n        priority: NOTIFICATION_PRIORITY.INFO,\r\n        link: `/citizen/complaints/${complaintId}`,\r\n        metadata: { complaint_id: complaintId }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n  * Notify citizen about status change\r\n  */\r\n  async notifyComplaintStatusChanged(citizenId, complaintId, complaintTitle, newStatus, oldStatus) {\r\n    const statusMessages = {\r\n      \"in progress\": \"is now being worked on\",\r\n      \"resolved\": \"has been resolved\",\r\n      \"rejected\": \"has been rejected\",\r\n      \"closed\": \"has been closed\"\r\n    };\r\n    const priority = newStatus === \"resolved\" ? NOTIFICATION_PRIORITY.INFO :\r\n      newStatus === \"rejected\" ? NOTIFICATION_PRIORITY.WARNING :\r\n        NOTIFICATION_PRIORITY.INFO;\r\n    return this.createNotification(\r\n      citizenId,\r\n      NOTIFICATION_TYPES.COMPLAINT_STATUS_CHANGED,\r\n      \"Complaint Status Updated\",\r\n      `Your complaint \"${complaintTitle}\" ${statusMessages[newStatus] || `status changed to ${newStatus}`}.`,\r\n      {\r\n        priority,\r\n        link: `/citizen/complaints/${complaintId}`,\r\n        metadata: { complaint_id: complaintId, old_status: oldStatus, new_status: newStatus }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n  * Notify officer about new task assignment\r\n  */\r\n  async notifyTaskAssigned(officerId, complaintId, complaintTitle, priority, deadline) {\r\n    // console.log removed for security\r\n    const notifPriority = priority === \"urgent\" ? NOTIFICATION_PRIORITY.URGENT :\r\n      priority === \"high\" ? NOTIFICATION_PRIORITY.WARNING :\r\n        NOTIFICATION_PRIORITY.INFO;\r\n    return this.createNotification(\r\n      officerId,\r\n      NOTIFICATION_TYPES.TASK_ASSIGNED,\r\n      \"New Task Assigned\",\r\n      `You've been assigned: \"${complaintTitle}\"${deadline ? ` - Due: ${new Date(deadline).toLocaleDateString()}` : \"\"}`,\r\n      {\r\n        priority: notifPriority,\r\n        link: `/lgu/tasks/${complaintId}`,\r\n        metadata: { complaint_id: complaintId, priority, deadline }\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n  * Notify officer about approaching deadline\r\n  */\r\n  async notifyDeadlineApproaching(officerId, complaintId, complaintTitle, hoursRemaining) {\r\n    return this.createNotification(\r\n      officerId,\r\n      NOTIFICATION_TYPES.TASK_DEADLINE_APPROACHING,\r\n      \"Deadline Approaching\",\r\n      `\"${complaintTitle}\" is due in ${hoursRemaining} hours!`,\r\n      {\r\n        priority: hoursRemaining <= 12 ? NOTIFICATION_PRIORITY.URGENT : NOTIFICATION_PRIORITY.WARNING,\r\n        link: `/lgu/tasks/${complaintId}`,\r\n        metadata: { complaint_id: complaintId, hours_remaining: hoursRemaining }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n  * Notify officer about overdue task\r\n  */\r\n  async notifyTaskOverdue(officerId, complaintId, complaintTitle) {\r\n    return this.createNotification(\r\n      officerId,\r\n      NOTIFICATION_TYPES.TASK_OVERDUE,\r\n      \"⚠️ Task Overdue\",\r\n      `\"${complaintTitle}\" is now overdue! Please update status immediately.`,\r\n      {\r\n        priority: NOTIFICATION_PRIORITY.URGENT,\r\n        link: `/lgu/tasks/${complaintId}`,\r\n        metadata: { complaint_id: complaintId }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n  * Notify coordinator about new complaint needing review\r\n  */\r\n  async notifyNewComplaintReview(coordinatorId, complaintId, complaintTitle) {\r\n    return this.createNotification(\r\n      coordinatorId,\r\n      NOTIFICATION_TYPES.NEW_COMPLAINT_REVIEW,\r\n      \"New Complaint for Review\",\r\n      `\"${complaintTitle}\" needs your review and assignment.`,\r\n      {\r\n        priority: NOTIFICATION_PRIORITY.INFO,\r\n        link: `/coordinator/review/${complaintId}`,\r\n        metadata: { complaint_id: complaintId }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n  * Notify citizen that their complaint was marked as duplicate\r\n  */\r\n  async notifyComplaintDuplicate(citizenId, complaintId, complaintTitle, masterComplaintId) {\r\n    return this.createNotification(\r\n      citizenId,\r\n      NOTIFICATION_TYPES.COMPLAINT_DUPLICATE,\r\n      \"Complaint Linked to Existing Issue\",\r\n      `Your complaint \"${complaintTitle}\" has been linked to an existing similar complaint. Updates will be shared.`,\r\n      {\r\n        priority: NOTIFICATION_PRIORITY.INFO,\r\n        link: `/citizen/complaints/${masterComplaintId}`,\r\n        metadata: { complaint_id: complaintId, master_complaint_id: masterComplaintId }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n   * Notify officer that their assignment has been completed\r\n   */\r\n  async notifyAssignmentCompleted(officerId, complaintId, complaintTitle) {\r\n    return this.createNotification(\r\n      officerId,\r\n      NOTIFICATION_TYPES.ASSIGNMENT_COMPLETED,\r\n      \"Assignment Completed\",\r\n      `Your assignment for \"${complaintTitle}\" has been completed by another officer.`,\r\n      {\r\n        priority: NOTIFICATION_PRIORITY.INFO,\r\n        link: `/lgu/tasks/${complaintId}`,\r\n        metadata: { complaint_id: complaintId }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n   * Notify officer of admin reminder to complete task\r\n   */\r\n  async notifyAdminReminder(officerId, complaintId, complaintTitle, reminderMessage) {\r\n    return this.createNotification(\r\n      officerId,\r\n      NOTIFICATION_TYPES.ADMIN_REMINDER,\r\n      \"Reminder from Admin\",\r\n      `Admin reminder: ${reminderMessage} - \"${complaintTitle}\"`,\r\n      {\r\n        priority: NOTIFICATION_PRIORITY.WARNING,\r\n        link: `/lgu/tasks/${complaintId}`,\r\n        metadata: { complaint_id: complaintId, reminder_type: \"admin_reminder\" }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n   * Notify citizen about workflow step completion\r\n   */\r\n  async notifyWorkflowStepCompleted(citizenId, complaintId, complaintTitle, stepDescription) {\r\n    return this.createNotification(\r\n      citizenId,\r\n      NOTIFICATION_TYPES.WORKFLOW_STEP_COMPLETED,\r\n      \"Progress Update\",\r\n      `Progress on \"${complaintTitle}\": ${stepDescription}`,\r\n      {\r\n        priority: NOTIFICATION_PRIORITY.INFO,\r\n        link: `/citizen/complaints/${complaintId}`,\r\n        metadata: { complaint_id: complaintId, step: stepDescription }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n   * Notify citizen that LGU work has been completed\r\n   */\r\n  async notifyLguWorkCompleted(citizenId, complaintId, complaintTitle) {\r\n    return this.createNotification(\r\n      citizenId,\r\n      NOTIFICATION_TYPES.LGU_WORK_COMPLETED,\r\n      \"Work Completed - Please Review\",\r\n      `The assigned LGU departments have completed their work on \"${complaintTitle}\". Please review and confirm resolution.`,\r\n      {\r\n        priority: NOTIFICATION_PRIORITY.INFO,\r\n        link: `/citizen/complaints/${complaintId}`,\r\n        metadata: { complaint_id: complaintId, action_required: \"review_resolution\" }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n   * Notify citizen that resolution review is needed\r\n   */\r\n  async notifyResolutionReviewNeeded(citizenId, complaintId, complaintTitle) {\r\n    return this.createNotification(\r\n      citizenId,\r\n      NOTIFICATION_TYPES.RESOLUTION_REVIEW_NEEDED,\r\n      \"Review Required\",\r\n      `Please review the completed work for \"${complaintTitle}\" and mark as resolved if satisfied.`,\r\n      {\r\n        priority: NOTIFICATION_PRIORITY.INFO,\r\n        link: `/citizen/complaints/${complaintId}`,\r\n        metadata: { complaint_id: complaintId, action_required: \"mark_resolved\" }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n   * Notify LGU admin about officer reminder needs\r\n   */\r\n  async notifyOfficerReminder(adminId, officerName, complaintId, complaintTitle, reminderType) {\r\n    const reminderMessages = {\r\n      pending_task: `${officerName} has a pending task that needs attention`,\r\n      complete_assignment: `${officerName} needs to mark their assignment as complete`,\r\n      overdue_task: `${officerName} has an overdue task that requires immediate action`\r\n    };\r\n    return this.createNotification(\r\n      adminId,\r\n      NOTIFICATION_TYPES.OFFICER_REMINDER,\r\n      \"Officer Reminder Needed\",\r\n      reminderMessages[reminderType] || `Action needed from ${officerName}`,\r\n      {\r\n        priority: NOTIFICATION_PRIORITY.WARNING,\r\n        link: `/lgu-admin/assignments`,\r\n        metadata: {\r\n          complaint_id: complaintId,\r\n          officer_name: officerName,\r\n          reminder_type: reminderType\r\n        }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n   * Notify officer about pending task reminder from admin\r\n   */\r\n  async notifyPendingTaskReminder(officerId, complaintId, complaintTitle, adminMessage) {\r\n    return this.createNotification(\r\n      officerId,\r\n      NOTIFICATION_TYPES.PENDING_TASK_REMINDER,\r\n      \"Task Reminder\",\r\n      `Admin reminder: ${adminMessage} - \"${complaintTitle}\"`,\r\n      {\r\n        priority: NOTIFICATION_PRIORITY.WARNING,\r\n        link: `/lgu/tasks/${complaintId}`,\r\n        metadata: { complaint_id: complaintId, admin_message: adminMessage }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n   * Notify citizen that complaint was assigned to officer\r\n   */\r\n  async notifyComplaintAssignedToOfficer(citizenId, complaintId, complaintTitle, officerInfo) {\r\n    return this.createNotification(\r\n      citizenId,\r\n      NOTIFICATION_TYPES.COMPLAINT_ASSIGNED,\r\n      \"Complaint Assigned to Officer\",\r\n      `Your complaint \"${complaintTitle}\" has been assigned to an officer and work will begin soon.`,\r\n      {\r\n        priority: NOTIFICATION_PRIORITY.INFO,\r\n        link: `/citizen/complaints/${complaintId}`,\r\n        metadata: {\r\n          complaint_id: complaintId,\r\n          officer_info: officerInfo\r\n        }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n   * Find all complaint coordinators and notify them about new complaint\r\n   * Scans auth.users for users with base_role = complaint-coordinator\r\n   */\r\n  async notifyAllCoordinators(complaintId, complaintTitle) {\r\n    try {\r\n      // Use RPC for efficient lookup\r\n      const { data: coordinators, error } = await this.supabase.rpc(\"get_users_by_role\", {\r\n        p_role: \"complaint-coordinator\"\r\n      });\r\n\r\n      if (error) {\r\n        console.error(\"[NOTIFICATION] Failed to fetch coordinators via RPC:\", error.message);\r\n        return { success: false, error: error.message };\r\n      }\r\n      // console.log removed for security\r\n      if (coordinators.length === 0) {\r\n        console.warn(`[NOTIFICATION] No complaint coordinators found for complaint ${complaintId}`);\r\n        return { success: true, count: 0 };\r\n      }\r\n      // Send notifications to all coordinators\r\n      const notifications = coordinators.map((coordinator) => ({\r\n        userId: coordinator.id,\r\n        type: NOTIFICATION_TYPES.NEW_COMPLAINT_REVIEW,\r\n        title: \"New Complaint for Review\",\r\n        message: `\"${complaintTitle}\" needs your review and assignment.`,\r\n        priority: NOTIFICATION_PRIORITY.INFO,\r\n        link: `/coordinator/review/${complaintId}`,\r\n        metadata: {\r\n          complaint_id: complaintId,\r\n          assigned_at: new Date().toISOString()\r\n        }\r\n      }));\r\n      const result = await this.createBulkNotifications(notifications);\r\n      // console.log removed for security\r\n      return result;\r\n    } catch (error) {\r\n      console.error(\"[NOTIFICATION] notifyAllCoordinators error:\", error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = NotificationService;\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\OfficeConfirmationService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\ReminderService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\RoleManagementService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\RuleBasedSuggestionService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\SettingService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\SimilarityCalculatorService.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":572,"column":26,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":572,"endColumn":27},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '+'. Use parentheses to clarify the intended order of operations.","line":572,"column":47,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":572,"endColumn":48},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":572,"column":47,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":572,"endColumn":48},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":575,"column":28,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":575,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Database = require(\"../config/database\");\r\n\r\n/**\r\n * SimilarityCalculatorService\r\n * Advanced similarity calculations and pattern detection\r\n */\r\nclass SimilarityCalculatorService {\r\n  constructor() {\r\n    this.db = new Database();\r\n    this.supabase = this.db.getClient();\r\n  }\r\n  /**\r\n   * Find all similar complaints within a radius\r\n   * @param {number} latitude\r\n   * @param {number} longitude\r\n   * @param {number} radiusKm\r\n   * @param {object} filters - Additional filters (type, dateRange, etc.)\r\n   */\r\n  async findSimilarInRadius(latitude, longitude, radiusKm = 0.5, filters = {}) {\r\n    try {\r\n      let query = this.supabase\r\n        .from(\"complaints\")\r\n        .select(\"*\")\r\n        .not(\"latitude\", \"is\", null)\r\n        .not(\"longitude\", \"is\", null);\r\n      // Apply filters\r\n      if (filters.type) {\r\n        query = query.eq(\"type\", filters.type);\r\n      }\r\n      if (filters.status) {\r\n        query = query.eq(\"workflow_status\", filters.status);\r\n      }\r\n      if (filters.dateFrom) {\r\n        query = query.gte(\"submitted_at\", filters.dateFrom);\r\n      }\r\n      if (filters.dateTo) {\r\n        query = query.lte(\"submitted_at\", filters.dateTo);\r\n      }\r\n      const { data: complaints, error } = await query.limit(200);\r\n      if (error) {\r\n        // Check if error message contains HTML (indicates server/infrastructure error)\r\n        const errorMessage = error.message || \"\";\r\n        const isHtmlError =\r\n          errorMessage.trim().startsWith(\"<!DOCTYPE html>\") ||\r\n          errorMessage.includes(\"<html\") ||\r\n          errorMessage.includes(\"Cloudflare\") ||\r\n          errorMessage.includes(\"Internal server error\");\r\n\r\n        // Check if it's a network error\r\n        const isNetworkError =\r\n          errorMessage.includes(\"fetch failed\") || error instanceof TypeError;\r\n\r\n        if (isHtmlError) {\r\n          const errorCodeMatch = errorMessage.match(/Error code (\\d+)/);\r\n          const errorCode = errorCodeMatch ? errorCodeMatch[1] : \"500\";\r\n          console.error(\r\n            \"[SIMILARITY] Infrastructure error in radius search (Supabase/Cloudflare server error):\",\r\n            {\r\n              errorCode,\r\n              type: \"HTML_ERROR_RESPONSE\",\r\n              operation: \"findSimilarInRadius\",\r\n            }\r\n          );\r\n          throw new Error(\r\n            `Database infrastructure error: Supabase/Cloudflare server returned error ${errorCode}. Please try again later.`\r\n          );\r\n        } else if (isNetworkError) {\r\n          console.warn(\r\n            \"[SIMILARITY] Network error in radius search (database may be unreachable):\",\r\n            {\r\n              message: errorMessage,\r\n              operation: \"findSimilarInRadius\",\r\n            }\r\n          );\r\n          throw new Error(\r\n            `Database network error: Unable to connect to database. Please check your network connection.`\r\n          );\r\n        } else {\r\n          console.error(\"[SIMILARITY] Radius search error:\", {\r\n            message: errorMessage,\r\n            code: error.code,\r\n            operation: \"findSimilarInRadius\",\r\n          });\r\n          throw error;\r\n        }\r\n      }\r\n      // Filter by distance\r\n      const nearby = complaints\r\n        .filter((complaint) => {\r\n          const distance = this.calculateDistance(\r\n            latitude,\r\n            longitude,\r\n            complaint.latitude,\r\n            complaint.longitude\r\n          );\r\n          return distance <= radiusKm;\r\n        })\r\n        .map((complaint) => ({\r\n          ...complaint,\r\n          distance: this.calculateDistance(\r\n            latitude,\r\n            longitude,\r\n            complaint.latitude,\r\n            complaint.longitude\r\n          ),\r\n        }));\r\n      return nearby.sort((a, b) => a.distance - b.distance);\r\n    } catch (error) {\r\n      console.error(\"[SIMILARITY] Radius search error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Detect geographic clusters of complaints\r\n   * Uses DBSCAN-like algorithm\r\n   */\r\n  async detectClusters(options = {}) {\r\n    const {\r\n      radiusKm = 0.1,\r\n      minComplaintsPerCluster = 5,\r\n      type = null,\r\n      dateFrom = null,\r\n      dateTo = null,\r\n    } = options;\r\n    try {\r\n      // Validate inputs\r\n      if (radiusKm <= 0) {\r\n        throw new Error(\"Radius must be greater than 0\");\r\n      }\r\n      if (minComplaintsPerCluster < 2) {\r\n        throw new Error(\"Minimum complaints per cluster must be at least 2\");\r\n      }\r\n\r\n      // Validate date range if both dates provided\r\n      if (dateFrom && dateTo && new Date(dateFrom) > new Date(dateTo)) {\r\n        throw new Error(\"Start date cannot be after end date\");\r\n      }\r\n\r\n      let query = this.supabase\r\n        .from(\"complaints\")\r\n        .select(\"*\")\r\n        .not(\"latitude\", \"is\", null)\r\n        .not(\"longitude\", \"is\", null);\r\n      if (type) query = query.eq(\"type\", type);\r\n      if (dateFrom) query = query.gte(\"submitted_at\", dateFrom);\r\n      if (dateTo) query = query.lte(\"submitted_at\", dateTo);\r\n\r\n      const { data: complaints, error } = await query;\r\n      if (error) {\r\n        // Check if error message contains HTML (indicates server/infrastructure error)\r\n        const errorMessage = error.message || \"\";\r\n        const isHtmlError =\r\n          errorMessage.trim().startsWith(\"<!DOCTYPE html>\") ||\r\n          errorMessage.includes(\"<html\") ||\r\n          errorMessage.includes(\"Cloudflare\") ||\r\n          errorMessage.includes(\"Internal server error\");\r\n\r\n        // Check if it's a network error\r\n        const isNetworkError =\r\n          errorMessage.includes(\"fetch failed\") || error instanceof TypeError;\r\n\r\n        if (isHtmlError) {\r\n          // Extract error code from HTML if possible\r\n          const errorCodeMatch = errorMessage.match(/Error code (\\d+)/);\r\n          const errorCode = errorCodeMatch ? errorCodeMatch[1] : \"500\";\r\n          console.error(\r\n            \"[SIMILARITY] Infrastructure error in database query (Supabase/Cloudflare server error):\",\r\n            {\r\n              errorCode,\r\n              type: \"HTML_ERROR_RESPONSE\",\r\n              message:\r\n                \"Received HTML error page instead of JSON response. This indicates a server/infrastructure issue.\",\r\n              operation: \"detectClusters\",\r\n            }\r\n          );\r\n          throw new Error(\r\n            `Database infrastructure error: Supabase/Cloudflare server returned error ${errorCode}. Please try again later.`\r\n          );\r\n        } else if (isNetworkError) {\r\n          console.warn(\r\n            \"[SIMILARITY] Network error in database query (database may be unreachable):\",\r\n            {\r\n              message: errorMessage,\r\n              code: error.code,\r\n              operation: \"detectClusters\",\r\n            }\r\n          );\r\n          throw new Error(\r\n            `Database network error: Unable to connect to database. Please check your network connection and Supabase configuration.`\r\n          );\r\n        } else {\r\n          // Standard Supabase error\r\n          console.error(\"[SIMILARITY] Database query error:\", {\r\n            message: errorMessage,\r\n            code: error.code,\r\n            details: error.details || \"\",\r\n            hint: error.hint || \"\",\r\n            operation: \"detectClusters\",\r\n          });\r\n          throw new Error(`Database query failed: ${errorMessage}`);\r\n        }\r\n      }\r\n\r\n      if (!complaints || complaints.length === 0) {\r\n        console.log(\"[SIMILARITY] No complaints found for clustering\");\r\n        // Deactivate existing clusters if no complaints\r\n        await this.saveClusters([]);\r\n        return [];\r\n      }\r\n\r\n      if (complaints.length < minComplaintsPerCluster) {\r\n        console.log(\r\n          `[SIMILARITY] Not enough complaints (${complaints.length}) for clustering (min: ${minComplaintsPerCluster})`\r\n        );\r\n        await this.saveClusters([]);\r\n        return [];\r\n      }\r\n\r\n      const clusters = this.clusterComplaints(\r\n        complaints,\r\n        radiusKm,\r\n        minComplaintsPerCluster\r\n      );\r\n\r\n      // Save clusters to database\r\n      await this.saveClusters(clusters);\r\n      return clusters;\r\n    } catch (error) {\r\n      // Handle network errors gracefully\r\n      const errorMessage = error.message || \"\";\r\n      const isHtmlError =\r\n        errorMessage.trim().startsWith(\"<!DOCTYPE html>\") ||\r\n        errorMessage.includes(\"<html\") ||\r\n        errorMessage.includes(\"Cloudflare\") ||\r\n        errorMessage.includes(\"Internal server error\");\r\n      const isNetworkError =\r\n        errorMessage.includes(\"fetch failed\") || error instanceof TypeError;\r\n\r\n      if (isHtmlError || isNetworkError) {\r\n        // Already logged in the query error handler above\r\n        console.error(\r\n          \"[SIMILARITY] Cluster detection failed due to infrastructure/network error\"\r\n        );\r\n      } else {\r\n        console.error(\"[SIMILARITY] Cluster detection error:\", {\r\n          message: errorMessage,\r\n          stack: error.stack,\r\n        });\r\n      }\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * DBSCAN-like clustering algorithm\r\n   */\r\n  clusterComplaints(complaints, radiusKm, minPoints) {\r\n    const clusters = [];\r\n    const visited = new Set();\r\n    const clustered = new Set();\r\n    complaints.forEach((complaint, _index) => {\r\n      if (visited.has(complaint.id)) return;\r\n      visited.add(complaint.id);\r\n      // Find neighbors\r\n      const neighbors = this.findNeighbors(complaint, complaints, radiusKm);\r\n      if (neighbors.length < minPoints) {\r\n        return; // Noise point\r\n      }\r\n      // Create new cluster\r\n      const cluster = {\r\n        complaints: [complaint],\r\n        center: {\r\n          lat: complaint.latitude,\r\n          lng: complaint.longitude,\r\n        },\r\n        radius: radiusKm,\r\n      };\r\n      clustered.add(complaint.id);\r\n      // Expand cluster\r\n      let i = 0;\r\n      while (i < neighbors.length) {\r\n        const neighbor = neighbors[i];\r\n        if (!visited.has(neighbor.id)) {\r\n          visited.add(neighbor.id);\r\n          const neighborNeighbors = this.findNeighbors(\r\n            neighbor,\r\n            complaints,\r\n            radiusKm\r\n          );\r\n          if (neighborNeighbors.length >= minPoints) {\r\n            neighbors.push(...neighborNeighbors);\r\n          }\r\n        }\r\n        if (!clustered.has(neighbor.id)) {\r\n          cluster.complaints.push(neighbor);\r\n          clustered.add(neighbor.id);\r\n        }\r\n        i++;\r\n      }\r\n      // Calculate cluster center\r\n      cluster.center = this.calculateClusterCenter(cluster.complaints);\r\n      cluster.actualRadius = this.calculateClusterRadius(\r\n        cluster.center,\r\n        cluster.complaints\r\n      );\r\n      clusters.push(cluster);\r\n    });\r\n    return clusters\r\n      .map((cluster, index) => {\r\n        // Safety check: ensure cluster has complaints\r\n        if (!cluster.complaints || cluster.complaints.length === 0) {\r\n          console.warn(\"[SIMILARITY] Skipping empty cluster\");\r\n          return null;\r\n        }\r\n\r\n        // Get type from first complaint, default to 'unknown' if not available\r\n        const clusterType = cluster.complaints[0]?.type || \"unknown\";\r\n\r\n        return {\r\n          cluster_name: `Cluster ${index + 1} - ${clusterType}`,\r\n          center_lat: cluster.center.lat,\r\n          center_lng: cluster.center.lng,\r\n          radius_meters: cluster.actualRadius * 1000, // Convert to meters\r\n          complaint_ids: cluster.complaints.map((c) => c.id),\r\n          pattern_type: this.detectPatternType(cluster.complaints),\r\n          status: \"active\",\r\n        };\r\n      })\r\n      .filter((cluster) => cluster !== null); // Remove null entries\r\n  }\r\n  /**\r\n   * Find neighboring complaints within radius\r\n   */\r\n  findNeighbors(complaint, allComplaints, radiusKm) {\r\n    return allComplaints.filter((other) => {\r\n      if (other.id === complaint.id) return false;\r\n      const distance = this.calculateDistance(\r\n        complaint.latitude,\r\n        complaint.longitude,\r\n        other.latitude,\r\n        other.longitude\r\n      );\r\n      return distance <= radiusKm;\r\n    });\r\n  }\r\n  /**\r\n   * Calculate geometric center of cluster\r\n   */\r\n  calculateClusterCenter(complaints) {\r\n    const sum = complaints.reduce(\r\n      (acc, c) => ({\r\n        lat: acc.lat + c.latitude,\r\n        lng: acc.lng + c.longitude,\r\n      }),\r\n      { lat: 0, lng: 0 }\r\n    );\r\n    return {\r\n      lat: sum.lat / complaints.length,\r\n      lng: sum.lng / complaints.length,\r\n    };\r\n  }\r\n  /**\r\n   * Calculate maximum radius of cluster\r\n   */\r\n  calculateClusterRadius(center, complaints) {\r\n    return Math.max(\r\n      ...complaints.map((c) =>\r\n        this.calculateDistance(center.lat, center.lng, c.latitude, c.longitude)\r\n      )\r\n    );\r\n  }\r\n  /**\r\n   * Detect pattern type based on temporal distribution\r\n   */\r\n  detectPatternType(complaints) {\r\n    if (complaints.length < 3) return \"normal\";\r\n    // Sort by date\r\n    const sorted = [...complaints].sort(\r\n      (a, b) => new Date(a.submitted_at) - new Date(b.submitted_at)\r\n    );\r\n    // Calculate time differences\r\n    const timeDiffs = [];\r\n    for (let i = 1; i < sorted.length; i++) {\r\n      const diff =\r\n        (new Date(sorted[i].submitted_at) -\r\n          new Date(sorted[i - 1].submitted_at)) /\r\n        (1000 * 60 * 60 * 24); // Days\r\n      timeDiffs.push(diff);\r\n    }\r\n    const avgDiff = timeDiffs.reduce((a, b) => a + b, 0) / timeDiffs.length;\r\n    // Outbreak: Many complaints in short time\r\n    if (avgDiff < 2 && complaints.length >= 5) {\r\n      return \"outbreak\";\r\n    }\r\n    // Recurring: Regular intervals\r\n    const variance =\r\n      timeDiffs.reduce((acc, diff) => acc + Math.pow(diff - avgDiff, 2), 0) /\r\n      timeDiffs.length;\r\n    if (variance < 10 && avgDiff < 14) {\r\n      return \"recurring\";\r\n    }\r\n    return \"normal\";\r\n  }\r\n  /**\r\n   * Save clusters to database\r\n   */\r\n  async saveClusters(clusters) {\r\n    if (!clusters || clusters.length === 0) {\r\n      console.log(\"[SIMILARITY] No clusters to save\");\r\n      return { success: true, saved: 0 };\r\n    }\r\n\r\n    try {\r\n      // First, deactivate existing clusters\r\n      const { error: deactivateError } = await this.supabase\r\n        .from(\"complaint_clusters\")\r\n        .update({ status: \"inactive\" })\r\n        .eq(\"status\", \"active\");\r\n\r\n      if (deactivateError) {\r\n        const deactivateMsg = deactivateError.message || \"\";\r\n        const isNetworkError =\r\n          deactivateMsg.includes(\"fetch failed\") ||\r\n          deactivateError instanceof TypeError;\r\n        if (isNetworkError) {\r\n          console.warn(\r\n            \"[SIMILARITY] Network error deactivating old clusters (database may be unreachable):\",\r\n            deactivateMsg\r\n          );\r\n        } else {\r\n          console.warn(\r\n            \"[SIMILARITY] Failed to deactivate old clusters:\",\r\n            deactivateMsg\r\n          );\r\n        }\r\n        // Continue anyway - might be first run\r\n      }\r\n\r\n      // Insert new clusters\r\n      const { data, error } = await this.supabase\r\n        .from(\"complaint_clusters\")\r\n        .insert(clusters)\r\n        .select();\r\n\r\n      if (error) {\r\n        const errorMessage = error.message || \"\";\r\n        const isHtmlError =\r\n          errorMessage.trim().startsWith(\"<!DOCTYPE html>\") ||\r\n          errorMessage.includes(\"<html\") ||\r\n          errorMessage.includes(\"Cloudflare\");\r\n        const isNetworkError =\r\n          errorMessage.includes(\"fetch failed\") || error instanceof TypeError;\r\n\r\n        if (isHtmlError) {\r\n          const errorCodeMatch = errorMessage.match(/Error code (\\d+)/);\r\n          const errorCode = errorCodeMatch ? errorCodeMatch[1] : \"500\";\r\n          console.error(\r\n            \"[SIMILARITY] Infrastructure error saving clusters (Supabase/Cloudflare server error):\",\r\n            {\r\n              errorCode,\r\n              type: \"HTML_ERROR_RESPONSE\",\r\n              operation: \"saveClusters\",\r\n            }\r\n          );\r\n          throw new Error(\r\n            `Database infrastructure error: Failed to save clusters. Supabase/Cloudflare server returned error ${errorCode}.`\r\n          );\r\n        } else if (isNetworkError) {\r\n          console.error(\r\n            \"[SIMILARITY] Network error saving clusters (database may be unreachable):\",\r\n            {\r\n              message: errorMessage,\r\n              operation: \"saveClusters\",\r\n            }\r\n          );\r\n          throw new Error(\r\n            `Database network error: Failed to save clusters. Unable to connect to database.`\r\n          );\r\n        } else {\r\n          console.error(\"[SIMILARITY] Save clusters error:\", {\r\n            message: errorMessage,\r\n            code: error.code,\r\n            operation: \"saveClusters\",\r\n          });\r\n          throw new Error(`Failed to save clusters: ${errorMessage}`);\r\n        }\r\n      }\r\n\r\n      console.log(\r\n        `[SIMILARITY] Successfully saved ${clusters.length} cluster(s) to database`\r\n      );\r\n      if (data && data.length > 0) {\r\n        const totalComplaints = clusters.reduce(\r\n          (sum, cluster) => sum + (cluster.complaint_ids?.length || 0),\r\n          0\r\n        );\r\n        console.log(\r\n          `[SIMILARITY] Total complaints in clusters: ${totalComplaints}`\r\n        );\r\n      }\r\n      return { success: true, saved: clusters.length, data };\r\n    } catch (error) {\r\n      console.error(\"[SIMILARITY] Save clusters exception:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Get nearest similar complaints\r\n   */\r\n  async getNearestSimilar(complaintId, limit = 10) {\r\n    try {\r\n      const complaint = await this.getComplaint(complaintId);\r\n      if (!complaint) throw new Error(\"Complaint not found\");\r\n      // Get pre-calculated similarities\r\n      const { data: similarities, error } = await this.supabase\r\n        .from(\"complaint_similarities\")\r\n        .select(\r\n          `\r\n          *,\r\n          similar_complaint:similar_complaint_id (*)\r\n        `\r\n        )\r\n        .eq(\"complaint_id\", complaintId)\r\n        .order(\"similarity_score\", { ascending: false })\r\n        .limit(limit);\r\n      if (error) {\r\n        const errorMessage = error.message || \"\";\r\n        const isHtmlError =\r\n          errorMessage.trim().startsWith(\"<!DOCTYPE html>\") ||\r\n          errorMessage.includes(\"<html\") ||\r\n          errorMessage.includes(\"Cloudflare\");\r\n        const isNetworkError =\r\n          errorMessage.includes(\"fetch failed\") || error instanceof TypeError;\r\n\r\n        if (isHtmlError || isNetworkError) {\r\n          console.warn(\r\n            \"[SIMILARITY] Network/infrastructure error getting nearest similar:\",\r\n            {\r\n              message: errorMessage,\r\n              operation: \"getNearestSimilar\",\r\n            }\r\n          );\r\n          throw new Error(\r\n            `Database connection error: Unable to retrieve similar complaints. Please try again later.`\r\n          );\r\n        }\r\n        throw error;\r\n      }\r\n      return similarities || [];\r\n    } catch (error) {\r\n      const errorMessage = error.message || \"\";\r\n      if (\r\n        !errorMessage.includes(\"Database connection error\") &&\r\n        !errorMessage.includes(\"Database infrastructure error\")\r\n      ) {\r\n        console.error(\"[SIMILARITY] Get nearest error:\", {\r\n          message: errorMessage,\r\n          stack: error.stack,\r\n        });\r\n      }\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n   * Calculate distance between two points\r\n   */\r\n  calculateDistance(lat1, lon1, lat2, lon2) {\r\n    const R = 6371; // Earth's radius in km\r\n    const dLat = this.toRad(lat2 - lat1);\r\n    const dLon = this.toRad(lon2 - lon1);\r\n\r\n    const a =\r\n      Math.sin(dLat / 2) * Math.sin(dLat / 2) +\r\n      Math.cos(this.toRad(lat1)) *\r\n        Math.cos(this.toRad(lat2)) *\r\n        Math.sin(dLon / 2) *\r\n        Math.sin(dLon / 2);\r\n\r\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\r\n    return R * c;\r\n  }\r\n\r\n  toRad(degrees) {\r\n    return degrees * (Math.PI / 180);\r\n  }\r\n\r\n  /**\r\n   * Get complaint by ID\r\n   */\r\n  async getComplaint(complaintId) {\r\n    const { data, error } = await this.supabase\r\n      .from(\"complaints\")\r\n      .select(\"*\")\r\n      .eq(\"id\", complaintId)\r\n      .single();\r\n    if (error) {\r\n      const errorMessage = error.message || \"\";\r\n      const isHtmlError =\r\n        errorMessage.trim().startsWith(\"<!DOCTYPE html>\") ||\r\n        errorMessage.includes(\"<html\") ||\r\n        errorMessage.includes(\"Cloudflare\");\r\n      const isNetworkError =\r\n        errorMessage.includes(\"fetch failed\") || error instanceof TypeError;\r\n\r\n      if (isHtmlError || isNetworkError) {\r\n        console.warn(\r\n          \"[SIMILARITY] Network/infrastructure error getting complaint:\",\r\n          {\r\n            message: errorMessage,\r\n            complaintId,\r\n            operation: \"getComplaint\",\r\n          }\r\n        );\r\n        throw new Error(\r\n          `Database connection error: Unable to retrieve complaint. Please try again later.`\r\n        );\r\n      }\r\n      throw error;\r\n    }\r\n    return data;\r\n  }\r\n}\r\n\r\nmodule.exports = SimilarityCalculatorService;\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\SuperAdminService.js","messages":[{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":182,"column":28,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":184,"endColumn":53}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const RoleManagementService = require(\"./RoleManagementService\");\r\nconst { USER_ROLES } = require(\"../../shared/constants\");\r\nconst Database = require(\"../config/database\");\r\n\r\n/**\r\n* SuperAdminService\r\n* Handles Super Admin operations: role swaps, department transfers, system logs\r\n*/\r\nclass SuperAdminService {\r\n\r\n  constructor() {\r\n    this.roleService = new RoleManagementService();\r\n    this.db = Database.getInstance();\r\n    this.supabase = this.db.getClient();\r\n  }\r\n  /**\r\n  * Role Swap: Assign any role to any user\r\n  * Super Admin can change anyone's role (except other super admins)\r\n  */\r\n  async roleSwap(userId, newRole, superAdminId, reason) {\r\n    try {\r\n      // Validate super admin\r\n      const adminRole = await this.roleService.getUserRole(superAdminId);\r\n      if (adminRole !== \"super-admin\") {\r\n        throw new Error(\"Only Super Admin can perform role swaps\");\r\n      }\r\n      // Get current role\r\n      const currentRole = await this.roleService.getUserRole(userId);\r\n      // Can't change other super admins (unless it's yourself stepping down)\r\n      if (currentRole === \"super-admin\" && userId !== superAdminId) {\r\n        throw new Error(\"Cannot change another Super Admin's role\");\r\n      }\r\n\r\n      // Validate new role\r\n      const validRoles = Object.values(USER_ROLES);\r\n      if (!validRoles.includes(newRole)) {\r\n        throw new Error(`Invalid role: ${newRole}`);\r\n      }\r\n\r\n      // Prepare metadata - clear department if demoting to citizen\r\n      const metadata = {\r\n        reason: reason || \"Role swap by Super Admin\",\r\n        swap_type: \"super_admin_role_swap\"\r\n      };\r\n\r\n      // If demoting to citizen, explicitly clear the department\r\n      if (newRole === \"citizen\") {\r\n        metadata.department = null;\r\n        metadata.clear_department = true;\r\n      }\r\n\r\n      console.log(\"[SUPER_ADMIN] Role swap - calling updateUserRole:\", {\r\n        userId,\r\n        newRole,\r\n        superAdminId,\r\n        currentRole,\r\n        metadata\r\n      });\r\n\r\n      // Perform role swap\r\n      const result = await this.roleService.updateUserRole(\r\n        userId,\r\n        newRole,\r\n        superAdminId,\r\n        metadata\r\n      );\r\n\r\n      console.log(\"[SUPER_ADMIN] Role swap - updateUserRole result:\", result);\r\n\r\n      // Verify the role was actually changed\r\n      const verifyRole = await this.roleService.getUserRole(userId);\r\n      console.log(\"[SUPER_ADMIN] Role swap - verified role after update:\", verifyRole);\r\n\r\n      if (verifyRole !== newRole) {\r\n        console.error(\"[SUPER_ADMIN] WARNING: Role update may have failed. Expected:\", newRole, \"Got:\", verifyRole);\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        message: `User role changed from ${currentRole} to ${newRole}`,\r\n        verified_role: verifyRole,\r\n        ...result\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[SUPER_ADMIN] Role swap error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Transfer user between departments\r\n  * Can transfer officers, admins, coordinators, HR across departments\r\n  */\r\n  async transferUserBetweenDepartments(userId, fromDepartment, toDepartment, superAdminId, reason) {\r\n    try {\r\n      // Validate super admin\r\n      const adminRole = await this.roleService.getUserRole(superAdminId);\r\n      if (adminRole !== \"super-admin\") {\r\n        throw new Error(\"Only Super Admin can transfer between departments\");\r\n      }\r\n      // Get current role - must be staff role\r\n      const currentRole = await this.roleService.getUserRole(userId);\r\n      // Check if role is transferable (LGU officers, admins, coordinators, HR)\r\n      const isLguOfficer = /^lgu-(?!admin|hr)/.test(currentRole);\r\n      const isLguAdmin = /^lgu-admin/.test(currentRole);\r\n      const isLguHR = /^lgu-hr/.test(currentRole);\r\n      const isCoordinator = currentRole === \"complaint-coordinator\";\r\n      const isTransferable = isLguOfficer || isLguAdmin || isLguHR || isCoordinator;\r\n      if (!isTransferable) {\r\n        throw new Error(\"Can only transfer staff members (LGU officers, admins, HR, coordinators) between departments\");\r\n      }\r\n      if (!reason) {\r\n        throw new Error(\"Reason is required for department transfer\");\r\n      }\r\n      // Perform transfer\r\n      const result = await this.roleService.transferDepartment(\r\n        userId,\r\n        fromDepartment,\r\n        toDepartment,\r\n        superAdminId,\r\n        reason\r\n      );\r\n      return {\r\n        success: true,\r\n        message: `User transferred from ${fromDepartment} to ${toDepartment}`,\r\n        ...result\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[SUPER_ADMIN] Department transfer error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Promote citizen to any department\r\n  */\r\n  async assignCitizenToDepartment(userId, role, departmentId, superAdminId, reason) {\r\n    try {\r\n      // Validate super admin\r\n      const adminRole = await this.roleService.getUserRole(superAdminId);\r\n      if (adminRole !== \"super-admin\") {\r\n        throw new Error(\"Only Super Admin can assign citizens to departments\");\r\n      }\r\n      // Get current role - must be citizen\r\n      const currentRole = await this.roleService.getUserRole(userId);\r\n      if (currentRole !== \"citizen\") {\r\n        throw new Error(\"Can only assign citizens to departments\");\r\n      }\r\n      // Validate target role - must be LGU officer, admin, HR, coordinator, or super-admin\r\n      // Note: Roles should NOT include department suffix (e.g., use 'lgu-officer' not 'lgu-ceeo')\r\n      const isLguOfficer = role === \"lgu-officer\" || role === \"lgu\";\r\n      const isLguAdmin = role === \"lgu-admin\";\r\n      const isLguHR = role === \"lgu-hr\";\r\n      const isCoordinator = role === \"complaint-coordinator\";\r\n      const isSuperAdmin = role === \"super-admin\";\r\n      const isValidRole = isLguOfficer || isLguAdmin || isLguHR || isCoordinator || isSuperAdmin;\r\n\r\n      console.log(\"[SUPER_ADMIN] Role validation:\", {\r\n        role,\r\n        isLguOfficer,\r\n        isLguAdmin,\r\n        isLguHR,\r\n        isCoordinator,\r\n        isSuperAdmin,\r\n        isValidRole\r\n      });\r\n\r\n      if (!isValidRole) {\r\n        throw new Error(`Invalid role: \"${role}\". Must be lgu-officer, lgu-admin, lgu-hr, complaint-coordinator, or super-admin`);\r\n      }\r\n      console.log(\"[SUPER_ADMIN] Assign citizen - calling updateUserRole:\", {\r\n        userId,\r\n        role,\r\n        departmentId,\r\n        superAdminId,\r\n        currentRole\r\n      });\r\n\r\n      // Update role and assign department (if not super-admin or complaint-coordinator)\r\n      const rolesWithoutDept = [\"super-admin\", \"complaint-coordinator\"];\r\n      const needsDepartment = !rolesWithoutDept.includes(role);\r\n\r\n      const metadata = {\r\n        reason: reason || (role === \"super-admin\" ? `Promoted to Super Admin` :\r\n          role === \"complaint-coordinator\" ? `Promoted to Complaint Coordinator` :\r\n            `Assigned to ${departmentId} as ${role}`),\r\n        assigned_by_super_admin: true\r\n      };\r\n\r\n      // Only assign department if role requires it\r\n      if (needsDepartment && departmentId) {\r\n        metadata.department = departmentId;\r\n      } else if (!needsDepartment) {\r\n        // Explicitly clear department for roles that don't need it\r\n        metadata.department = null;\r\n        metadata.clear_department = true;\r\n      }\r\n\r\n      const result = await this.roleService.updateUserRole(\r\n        userId,\r\n        role,\r\n        superAdminId,\r\n        metadata\r\n      );\r\n\r\n      console.log(\"[SUPER_ADMIN] Assign citizen - updateUserRole result:\", result);\r\n\r\n      // Verify the role was actually changed\r\n      const verifyRole = await this.roleService.getUserRole(userId);\r\n      console.log(\"[SUPER_ADMIN] Assign citizen - verified role after update:\", verifyRole);\r\n\r\n      if (verifyRole !== role) {\r\n        console.error(\"[SUPER_ADMIN] WARNING: Role update may have failed. Expected:\", role, \"Got:\", verifyRole);\r\n        // Still return success but with warning\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        message: `Citizen assigned to ${departmentId} as ${role}`,\r\n        verified_role: verifyRole,\r\n        ...result\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[SUPER_ADMIN] Assign citizen error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Get all system logs\r\n  */\r\n  async getSystemLogs(superAdminId, options = {}) {\r\n    try {\r\n      // Validate super admin\r\n      const adminRole = await this.roleService.getUserRole(superAdminId);\r\n      if (adminRole !== \"super-admin\") {\r\n        throw new Error(\"Only Super Admin can view system logs\");\r\n      }\r\n      const {\r\n        log_type = \"all\", // 'role_changes', 'department_transfers', 'complaint_workflow', 'all'\r\n        limit = 100,\r\n        offset = 0,\r\n        date_from,\r\n        date_to\r\n      } = options;\r\n      const logs = {};\r\n      // Get role changes\r\n      if (log_type === \"all\" || log_type === \"role_changes\") {\r\n        try {\r\n          let query = this.supabase\r\n            .from(\"role_changes\")\r\n            .select(`\r\n              *,\r\n              user:user_id (email, raw_user_meta_data),\r\n              performer:changed_by (email, raw_user_meta_data)\r\n            `)\r\n            .order(\"created_at\", { ascending: false });\r\n          if (date_from) query = query.gte(\"created_at\", date_from);\r\n          if (date_to) query = query.lte(\"created_at\", date_to);\r\n          const { data, error } = await query.limit(limit).range(offset, offset + limit - 1);\r\n          if (error) {\r\n            // Fallback: get role changes without joins\r\n            const { data: fallbackData, error: fallbackError } = await this.supabase\r\n              .from(\"role_changes\")\r\n              .select(\"*\")\r\n              .order(\"created_at\", { ascending: false })\r\n              .limit(limit)\r\n              .range(offset, offset + limit - 1);\r\n            if (fallbackError) throw fallbackError;\r\n            logs.role_changes = fallbackData || [];\r\n          } else {\r\n            logs.role_changes = data || [];\r\n          }\r\n        } catch (error) {\r\n          logs.role_changes = [];\r\n        }\r\n      }\r\n      // Get department transfers\r\n      if (log_type === \"all\" || log_type === \"department_transfers\") {\r\n        try {\r\n          let query = this.supabase\r\n            .from(\"department_transfers\")\r\n            .select(`\r\n              *,\r\n              user:user_id (email, raw_user_meta_data),\r\n              performer:performed_by (email, raw_user_meta_data)\r\n            `)\r\n            .order(\"created_at\", { ascending: false });\r\n          if (date_from) query = query.gte(\"created_at\", date_from);\r\n          if (date_to) query = query.lte(\"created_at\", date_to);\r\n          const { data, error } = await query.limit(limit).range(offset, offset + limit - 1);\r\n          if (error) {\r\n            // Fallback: get department transfers without joins\r\n            const { data: fallbackData, error: fallbackError } = await this.supabase\r\n              .from(\"department_transfers\")\r\n              .select(\"*\")\r\n              .order(\"created_at\", { ascending: false })\r\n              .limit(limit)\r\n              .range(offset, offset + limit - 1);\r\n            if (fallbackError) throw fallbackError;\r\n            logs.department_transfers = fallbackData || [];\r\n          } else {\r\n            logs.department_transfers = data || [];\r\n          }\r\n        } catch (error) {\r\n          logs.department_transfers = [];\r\n        }\r\n      }\r\n      // Get complaint workflow logs\r\n      if (log_type === \"all\" || log_type === \"complaint_workflow\") {\r\n        let query = this.supabase\r\n          .from(\"complaint_workflow_logs\")\r\n          .select(\"*\")\r\n          .order(\"created_at\", { ascending: false});\r\n        if (date_from) query = query.gte(\"created_at\", date_from);\r\n        if (date_to) query = query.lte(\"created_at\", date_to);\r\n        const { data, error } = await query.limit(limit).range(offset, offset + limit - 1);\r\n        if (error) throw error;\r\n        logs.complaint_workflow = data || [];\r\n      }\r\n      return {\r\n        success: true,\r\n        logs,\r\n        filters: options\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[SUPER_ADMIN] Get logs error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Get system statistics\r\n  */\r\n  async getSystemStatistics(superAdminId) {\r\n    try {\r\n      // Validate super admin\r\n      const adminRole = await this.roleService.getUserRole(superAdminId);\r\n      if (adminRole !== \"super-admin\") {\r\n        throw new Error(\"Only Super Admin can view system statistics\");\r\n      }\r\n      // Get counts for different entities\r\n      const [\r\n        complaintsCount,\r\n        roleChangesCount,\r\n        departmentTransfersCount\r\n      ] = await Promise.all([\r\n        this.getCount(\"complaints\"),\r\n        this.getCount(\"role_changes\").catch(() => 0),\r\n        this.getCount(\"department_transfers\").catch(() => 0)\r\n      ]);\r\n      return {\r\n        success: true,\r\n        statistics: {\r\n          total_complaints: complaintsCount,\r\n          total_role_changes: roleChangesCount,\r\n          total_department_transfers: departmentTransfersCount\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[SUPER_ADMIN] Get statistics error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Get latest registered users (with confirmed emails or OAuth)\r\n  */\r\n  async getLatestRegisteredUsers(superAdminId, limit = 5) {\r\n    try {\r\n      // Validate super admin\r\n      const adminRole = await this.roleService.getUserRole(superAdminId);\r\n      if (adminRole !== \"super-admin\") {\r\n        throw new Error(\"Only Super Admin can view latest registered users\");\r\n      }\r\n\r\n      const userService = require(\"./UserService\");\r\n\r\n      // Get all users (we'll filter for confirmed emails/OAuth)\r\n      const result = await userService.getUsers({ includeInactive: false }, { page: 1, limit: 1000 });\r\n      const allUsers = result.users || [];\r\n\r\n      // Filter users with confirmed emails or OAuth providers\r\n      // OAuth users typically have email_confirmed_at set automatically\r\n      // We need to check the raw auth user data for email_confirmed_at\r\n      const Database = require(\"../config/database\");\r\n      const supabase = Database.getClient();\r\n\r\n      let confirmedUsers = [];\r\n      try {\r\n        // Get users with confirmed emails using admin API\r\n        const { data: authUsers, error } = await supabase.auth.admin.listUsers({\r\n          perPage: 1000\r\n        });\r\n\r\n        if (!error && authUsers && authUsers.users) {\r\n          // Filter users with confirmed emails (email_confirmed_at is not null)\r\n          // OAuth users typically have email_confirmed_at set automatically\r\n          const confirmedAuthUsers = authUsers.users.filter(user =>\r\n            user.email_confirmed_at !== null && user.email_confirmed_at !== void 0\r\n          );\r\n\r\n          // Map to our user format and sort by created_at (newest first)\r\n          confirmedUsers = confirmedAuthUsers\r\n            .map(authUser => {\r\n              const formattedUser = userService.formatUserResponse(authUser);\r\n              return {\r\n                ...formattedUser,\r\n                created_at: authUser.created_at,\r\n                email_confirmed_at: authUser.email_confirmed_at,\r\n                is_oauth: Boolean(authUser.app_metadata?.provider && authUser.app_metadata.provider !== \"email\")\r\n              };\r\n            })\r\n            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))\r\n            .slice(0, limit);\r\n        }\r\n      } catch (err) {\r\n        console.error(\"[SUPER_ADMIN] Error fetching confirmed users:\", err);\r\n        // Fallback: return users from UserService (may not have confirmation status)\r\n        confirmedUsers = allUsers\r\n          .sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0))\r\n          .slice(0, limit);\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        users: confirmedUsers\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[SUPER_ADMIN] Get latest registered users error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Get role distribution for pie chart (super admin)\r\n  * Returns: citizen, hr, officer, admin (excluding super-admin)\r\n  */\r\n  async getRoleDistribution(superAdminId) {\r\n    try {\r\n      // Validate super admin\r\n      const adminRole = await this.roleService.getUserRole(superAdminId);\r\n      if (adminRole !== \"super-admin\") {\r\n        throw new Error(\"Only Super Admin can view role distribution\");\r\n      }\r\n\r\n      const userService = require(\"./UserService\");\r\n      const result = await userService.getUsers({ includeInactive: false }, { page: 1, limit: 10000 });\r\n      const users = result.users || [];\r\n\r\n      // Count roles\r\n      let citizens = 0;\r\n      let hr = 0;\r\n      let officers = 0;\r\n      let admins = 0;\r\n\r\n      users.forEach(user => {\r\n        const role = String(user.role || \"\").toLowerCase();\r\n        const normalizedRole = String(user.normalizedRole || role).toLowerCase();\r\n\r\n        // Exclude super-admin\r\n        if (role === \"super-admin\" || normalizedRole === \"super-admin\") {\r\n          return;\r\n        }\r\n\r\n        // Count citizens\r\n        if (role === \"citizen\" || normalizedRole === \"citizen\") {\r\n          citizens++;\r\n        }\r\n        // Count HR\r\n        else if (role === \"lgu-hr\" || normalizedRole === \"lgu-hr\" || /^lgu-hr/.test(role)) {\r\n          hr++;\r\n        }\r\n        // Count admins (LGU admins only, excluding super-admin)\r\n        else if (/^lgu-admin/.test(role) || /^lgu-admin/.test(normalizedRole)) {\r\n          admins++;\r\n        }\r\n        // Count officers (simplified 'lgu' and lgu-* excluding admin/hr)\r\n        else if (role === \"lgu\" || /^lgu-(?!admin|hr)/.test(role)) {\r\n          officers++;\r\n        }\r\n      });\r\n\r\n      return {\r\n        success: true,\r\n        distribution: {\r\n          citizens,\r\n          hr,\r\n          officers,\r\n          admins\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[SUPER_ADMIN] Get role distribution error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Helper: Get count from table\r\n  */\r\n  async getCount(tableName) {\r\n    try {\r\n      const { count, error } = await this.supabase\r\n        .from(tableName)\r\n        .select(\"*\", { count: \"exact\", head: true });\r\n      if (error) throw error;\r\n      return count || 0;\r\n    } catch (error) {\r\n      console.error(`[SUPER_ADMIN] Get count for ${tableName} error:`, error);\r\n      return 0;\r\n    }\r\n  }\r\n  /**\r\n  * Get Super Admin dashboard\r\n  */\r\n  async getDashboard(superAdminId) {\r\n    try {\r\n      const [stats, recentLogs] = await Promise.all([\r\n        this.getSystemStatistics(superAdminId),\r\n        this.getSystemLogs(superAdminId, { limit: 10 })\r\n      ]);\r\n      return {\r\n        success: true,\r\n        dashboard: {\r\n          statistics: stats.statistics,\r\n          recent_logs: recentLogs.logs\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[SUPER_ADMIN] Get dashboard error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = SuperAdminService;\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\UserManagementService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\services\\UserService.js","messages":[{"ruleId":"no-useless-constructor","severity":2,"message":"Useless constructor.","line":7,"column":3,"nodeType":"MethodDefinition","messageId":"noUselessConstructor","endLine":8,"endColumn":4},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '-'. Use parentheses to clarify the intended order of operations.","line":350,"column":45,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":350,"endColumn":46},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '*' and '-'. Use parentheses to clarify the intended order of operations.","line":350,"column":53,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":350,"endColumn":54}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Database = require(\"../config/database\");\r\n\r\nconst supabase = Database.getClient();\r\nconst { ValidationError, ConflictError } = require(\"../middleware/errorHandler\");\r\n\r\nclass UserService {\r\n  constructor() {\r\n  }\r\n  // Map arbitrary role strings to allowed DB values\r\n  normalizeRole(rawRole) {\r\n    if (!rawRole) return \"citizen\";\r\n    const role = String(rawRole).toLowerCase();\r\n    if (role === \"lgu-admin\") return \"lgu-admin\";\r\n    if (role === \"lgu\") return \"lgu\";\r\n    if (role === \"super-admin\" || role === \"superadmin\") return \"super-admin\";\r\n    if (role === \"citizen\") return \"citizen\";\r\n    return \"citizen\";\r\n  }\r\n  /**\r\n  * Create a new user (stores everything in auth.users metadata)\r\n  */\r\n  async createUser(userData) {\r\n    const {\r\n      email,\r\n      password,\r\n      firstName,\r\n      middleName,\r\n      lastName,\r\n      name, // Single name field (for OAuth users)\r\n      mobileNumber,\r\n      gender,\r\n      role = \"citizen\",\r\n      department = null,\r\n      employeeId = null,\r\n      address = {},\r\n      isOAuth = false // Flag to indicate if this is OAuth signup\r\n    } = userData;\r\n    // Handle single name field - use name if provided, otherwise combine firstName + lastName\r\n    const displayName = name || [firstName, middleName, lastName].filter(Boolean).join(\" \").trim();\r\n    const nameParts = displayName ? displayName.split(\" \") : [];\r\n    const firstNameFinal = firstName || nameParts[0] || \"\";\r\n    const middleNameFinal = middleName || nameParts.slice(1, -1).join(\" \") || \"\";\r\n    const lastNameFinal = lastName || (nameParts.length > 1 ? nameParts[nameParts.length - 1] : \"\");\r\n    // Validate required fields\r\n    this.validateUserData(userData, isOAuth);\r\n    const normalizedRole = this.normalizeRole(role);\r\n    try {\r\n      // Create auth user with all metadata (no separate users table)\r\n      const { data: authData, error: authError } = await supabase.auth.admin.createUser({\r\n        email,\r\n        password,\r\n        email_confirm: false, // Require email confirmation\r\n        user_metadata: {\r\n          // Public metadata (visible to user)\r\n          first_name: firstNameFinal,\r\n          middle_name: middleNameFinal || null,\r\n          last_name: lastNameFinal,\r\n          name: displayName,\r\n          role,\r\n          normalized_role: normalizedRole,\r\n          mobile_number: mobileNumber || null,\r\n          is_oauth: isOAuth,\r\n          status: \"pending_verification\",\r\n          // Address\r\n          address_line_1: address.line1 || null,\r\n          address_line_2: address.line2 || null,\r\n          city: address.city || null,\r\n          province: address.province || null,\r\n          postal_code: address.postalCode || null,\r\n          barangay: address.barangay || null,\r\n          // LGU staff fields\r\n          department,\r\n          employee_id: employeeId,\r\n          position: null,\r\n          // Verification\r\n          email_verified: false,\r\n          mobile_verified: false,\r\n          gender: gender || null,\r\n          // Preferences\r\n          preferred_language: \"en\",\r\n          timezone: \"Asia/Manila\",\r\n          email_notifications: true,\r\n          sms_notifications: false,\r\n          push_notifications: true,\r\n          // Banning system\r\n          isBanned: false,\r\n          warningStrike: 0,\r\n          // Timestamps\r\n          updated_at: new Date().toISOString()\r\n        },\r\n        raw_user_meta_data: {\r\n          // Server-side metadata\r\n          first_name: firstNameFinal,\r\n          middle_name: middleNameFinal || null,\r\n          last_name: lastNameFinal,\r\n          name: displayName,\r\n          role,\r\n          normalized_role: normalizedRole,\r\n          mobile_number: mobileNumber || null,\r\n          mobile: mobileNumber || null, // Also store as 'mobile' for compatibility\r\n          is_oauth: isOAuth,\r\n          status: \"pending_verification\",\r\n          // Address\r\n          address_line_1: address.line1 || null,\r\n          address_line_2: address.line2 || null,\r\n          city: address.city || null,\r\n          province: address.province || null,\r\n          postal_code: address.postalCode || null,\r\n          barangay: address.barangay || null,\r\n          // LGU staff fields\r\n          department,\r\n          employee_id: employeeId,\r\n          position: null,\r\n          // Verification\r\n          email_verified: false,\r\n          phone_verified: false,\r\n          // Preferences\r\n          preferred_language: \"en\",\r\n          timezone: \"Asia/Manila\",\r\n          email_notifications: true,\r\n          sms_notifications: false,\r\n          push_notifications: true,\r\n          gender: gender || null,\r\n          // Banning system\r\n          isBanned: false,\r\n          warningStrike: 0,\r\n          // Timestamps\r\n          updated_at: new Date().toISOString(),\r\n          // OAuth providers\r\n          oauth_providers: isOAuth ? [] : [\"email\"]\r\n        }\r\n      });\r\n      if (authError) {\r\n        const msg = String(authError.message || \"\").toLowerCase();\r\n        const code = String(authError.code || \"\").toLowerCase();\r\n        // Normalize duplicate email errors from Supabase/PostgREST\r\n        const isDuplicateEmail = (\r\n          code === \"user_already_exists\" ||\r\n          code === \"email_exists\" ||\r\n          code === \"23505\" || // unique_violation\r\n          /already\\s*(registered|exists)/i.test(msg) ||\r\n          /duplicate/i.test(msg) ||\r\n          /unique/i.test(msg) ||\r\n          /email.*(in use|used|taken)/i.test(msg)\r\n        );\r\n        if (isDuplicateEmail) {\r\n          throw new ConflictError(\"Email already exist\");\r\n        }\r\n        throw new Error(`Auth creation failed: ${authError.message}`);\r\n      }\r\n      const authUserId = authData.user.id;\r\n      // Send verification email (server-side) using resend API\r\n      const frontendUrl = process.env.FRONTEND_URL || \"http://localhost:3001\";\r\n      const { error: emailError } = await supabase.auth.resend({\r\n        type: \"signup\",\r\n        email,\r\n        options: {\r\n          emailRedirectTo: `${frontendUrl}/email-verification-success`\r\n        }\r\n      });\r\n      if (emailError) {\r\n        console.warn(\"Email verification sending failed:\", emailError.message);\r\n      }\r\n\r\n\r\n      return {\r\n        id: authUserId,\r\n        email: authData.user.email,\r\n        name: displayName,\r\n        fullName: displayName,\r\n        role: normalizedRole,\r\n        status: \"pending_verification\",\r\n        emailVerified: false,\r\n        createdAt: authData.user.created_at\r\n      };\r\n    } catch (error) {\r\n      console.error(\"User creation error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Get user by ID (from auth.users metadata only)\r\n  */\r\n  async getUserById(userId) {\r\n    try {\r\n      const { data: authUser, error } = await supabase.auth.admin.getUserById(userId);\r\n      if (error) {\r\n        console.error(\"[AUTH] Failed to fetch user via admin API:\", error);\r\n        return null;\r\n      }\r\n      if (!authUser || !authUser.user) {\r\n        return null;\r\n      }\r\n      return this.formatUserResponse(authUser.user);\r\n    } catch (error) {\r\n      console.error(\"[AUTH] Get user error:\", error);\r\n      return null;\r\n    }\r\n  }\r\n  /**\r\n  * Update user profile (updates auth.users metadata)\r\n  */\r\n  async updateUser(userId, updateData, updatedBy = null) {\r\n    // Validate update data\r\n    this.validateUpdateData(updateData);\r\n    try {\r\n      // Get current user to merge metadata\r\n      const currentUser = await this.getUserById(userId);\r\n      if (!currentUser) {\r\n        throw new Error(\"User not found\");\r\n      }\r\n      // Merge with existing metadata\r\n      // IMPORTANT: Normalize roles using general normalization function\r\n      const { normalizeRole } = require(\"../utils/roleValidation\");\r\n      const normalizedUpdateData = { ...updateData };\r\n\r\n      // Normalize role fields if present\r\n      if (normalizedUpdateData.role) {\r\n        const originalRole = normalizedUpdateData.role;\r\n        normalizedUpdateData.role = normalizeRole(normalizedUpdateData.role);\r\n        if (originalRole !== normalizedUpdateData.role) {\r\n          console.log(\"[UserService] Normalizing role from\", originalRole, \"to\", normalizedUpdateData.role, \"in updateData\");\r\n        }\r\n      }\r\n      if (normalizedUpdateData.normalized_role) {\r\n        normalizedUpdateData.normalized_role = normalizeRole(normalizedUpdateData.normalized_role);\r\n      }\r\n      if (normalizedUpdateData.base_role) {\r\n        normalizedUpdateData.base_role = normalizeRole(normalizedUpdateData.base_role);\r\n      }\r\n\r\n      const updatedMetadata = {\r\n        ...(currentUser.raw_user_meta_data || {}),\r\n        ...normalizedUpdateData,\r\n        updated_by: updatedBy,\r\n        updated_at: new Date().toISOString()\r\n      };\r\n\r\n      // Final safety check: ensure we never save unnormalized roles in metadata\r\n      if (updatedMetadata.role) {\r\n        updatedMetadata.role = normalizeRole(updatedMetadata.role);\r\n      }\r\n      if (updatedMetadata.normalized_role) {\r\n        updatedMetadata.normalized_role = normalizeRole(updatedMetadata.normalized_role);\r\n      }\r\n      if (updatedMetadata.base_role) {\r\n        updatedMetadata.base_role = normalizeRole(updatedMetadata.base_role);\r\n      }\r\n      // Update auth user metadata\r\n      const { data: authData, error } = await supabase.auth.admin.updateUserById(userId, {\r\n        user_metadata: updatedMetadata,\r\n        raw_user_meta_data: updatedMetadata\r\n      });\r\n      if (error) {\r\n        throw new Error(`Failed to update user: ${error.message}`);\r\n      }\r\n\r\n\r\n      return this.formatUserResponse(authData.user);\r\n    } catch (error) {\r\n      console.error(\"Update user error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Change user role (updates metadata and logs)\r\n  */\r\n  async changeUserRole(userId, newRole, changedBy, reason = null) {\r\n    // Validate role parameter to prevent injection\r\n    const validRoles = [\r\n      \"citizen\", \"lgu\", \"lgu-admin\", \"lgu-hr\", \"complaint-coordinator\",\r\n      \"super-admin\", \"lgu-admin-health\", \"lgu-admin-education\",\r\n      \"lgu-admin-social\", \"lgu-admin-infrastructure\", \"lgu-admin-environment\",\r\n      \"lgu-admin-agriculture\", \"lgu-admin-tourism\", \"lgu-admin-publicsafety\",\r\n      \"lgu-admin-economic\", \"lgu-admin-legal\", \"lgu-hr-health\", \"lgu-hr-education\"\r\n    ];\r\n    if (!newRole || typeof newRole !== \"string\") {\r\n      throw new ValidationError(\"Role must be a valid string\");\r\n    }\r\n    // Normalize and validate role\r\n    const normalizedRole = this.normalizeRole(newRole);\r\n    if (!validRoles.includes(normalizedRole)) {\r\n      throw new ValidationError(`Invalid role: ${newRole}. Must be one of: ${validRoles.join(\", \")}`);\r\n    }\r\n    // Get current user\r\n    const currentUser = await this.getUserById(userId);\r\n    if (!currentUser) {\r\n      throw new ValidationError(\"User not found\");\r\n    }\r\n    const oldRole = currentUser.role;\r\n    // Update role in metadata\r\n    const updatedUser = await this.updateUser(userId, {\r\n      role: normalizedRole,  // Use normalized role for consistency\r\n      normalized_role: normalizedRole\r\n    }, changedBy);\r\n    // Log role change\r\n    await this.logRoleChange(userId, oldRole, normalizedRole, changedBy, reason);\r\n    return updatedUser;\r\n  }\r\n  /**\r\n  * Track user login\r\n  */\r\n  async trackLogin(userId, ipAddress = null, userAgent = null) {\r\n    try {\r\n      const { error } = await supabase.rpc(\"update_user_login\", {\r\n        p_user_id: userId,\r\n        p_ip_address: ipAddress,\r\n        p_user_agent: userAgent\r\n      });\r\n      if (error) {\r\n        console.warn(\"Login tracking failed:\", error.message);\r\n      }\r\n    } catch (error) {\r\n      console.warn(\"Login tracking error:\", error);\r\n    }\r\n  }\r\n  /**\r\n  * Get users with filters and pagination (from auth.users)\r\n  */\r\n  async getUsers(filters = {}, pagination = {}) {\r\n    const {\r\n      role,\r\n      status,\r\n      department,\r\n      search,\r\n      includeInactive = false\r\n    } = filters;\r\n    const {\r\n      page = 1,\r\n      limit = 20\r\n    } = pagination;\r\n    try {\r\n      // Try Admin API first (preferred)\r\n      let users = [];\r\n      try {\r\n        const { data, error } = await supabase.auth.admin.listUsers({\r\n          page,\r\n          perPage: limit\r\n        });\r\n        if (error) throw error;\r\n        users = (data.users || []).map(user => this.formatUserResponse(user));\r\n      } catch (adminErr) {\r\n        // Fallback: direct query to auth.users via PostgREST (requires service role key)\r\n        // Note: This path provides limited columns; we reconstruct response\r\n        try {\r\n          const query = supabase\r\n            .from(\"auth.users\")\r\n            .select(\"id, email, created_at, user_metadata, raw_user_meta_data\")\r\n            .order(\"created_at\", { ascending: false })\r\n            .range((page - 1) * limit, page * limit - 1);\r\n          const { data: sqlRows, error: sqlError } = await query;\r\n          if (sqlError) throw sqlError;\r\n          users = (sqlRows || []).map(row => this.formatUserResponse({\r\n            id: row.id,\r\n            email: row.email,\r\n            created_at: row.created_at,\r\n            user_metadata: row.user_metadata || {},\r\n            raw_user_meta_data: row.raw_user_meta_data || {}\r\n          }));\r\n        } catch (sqlErr) {\r\n          const msg = adminErr?.message || sqlErr?.message || \"Unknown error\";\r\n          throw new Error(`Failed to fetch users: ${msg}`);\r\n        }\r\n      }\r\n\r\n      // Apply client-side filters\r\n      if (role) {\r\n        users = users.filter(u => u.role === role || u.normalizedRole === role);\r\n      }\r\n      if (status) {\r\n        users = users.filter(u => u.status === status);\r\n      }\r\n      if (department) {\r\n        users = users.filter(u => u.department === department);\r\n      }\r\n      if (!includeInactive) {\r\n        users = users.filter(u => u.status !== \"inactive\");\r\n      }\r\n      if (search) {\r\n        const searchLower = search.toLowerCase();\r\n        users = users.filter(u =>\r\n          u.fullName?.toLowerCase().includes(searchLower) ||\r\n          u.email?.toLowerCase().includes(searchLower) ||\r\n          u.employeeId?.toLowerCase().includes(searchLower)\r\n        );\r\n      }\r\n      return {\r\n        users: users || [],\r\n        pagination: {\r\n          page,\r\n          limit,\r\n          total: users.length,\r\n          totalPages: Math.ceil(users.length / limit)\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error(\"Get users error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n  /**\r\n  * Sync auth user (no-op now since we only use auth.users)\r\n  */\r\n  async syncAuthUser(_authUserId) {\r\n    // No longer needed - all data is in auth.users metadata\r\n    return true;\r\n  }\r\n  // ============================================================================\r\n  // PRIVATE HELPER METHODS\r\n  // ============================================================================\r\n  validateUserData(userData, isOAuth = false) {\r\n    const { email, password, firstName, lastName, name, mobileNumber } = userData;\r\n    if (!email || !email.includes(\"@\")) {\r\n      throw new ValidationError(\"Valid email is required\");\r\n    }\r\n    // Password only required for regular signup, not OAuth\r\n    if (!isOAuth && (!password || password.length < 4)) {\r\n      throw new ValidationError(\"Password must be at least 4 characters\");\r\n    }\r\n    // Name validation - handle both single name and firstName/lastName\r\n    const fullName = name || `${firstName || \"\"} ${lastName || \"\"}`.trim();\r\n    if (!fullName || fullName.length < 2) {\r\n      throw new ValidationError(\"Name must be at least 2 characters\");\r\n    }\r\n    // Mobile number validation - required for regular signup, optional for OAuth\r\n    if (!isOAuth && (!mobileNumber || mobileNumber.trim().length < 10)) {\r\n      throw new ValidationError(\"Mobile number is required for registration\");\r\n    }\r\n  }\r\n  validateUpdateData(updateData) {\r\n    const allowedFields = [\r\n      \"first_name\", \"last_name\", \"middle_name\", \"mobile_number\", \"date_of_birth\", \"gender\",\r\n      \"address_line_1\", \"address_line_2\", \"city\", \"province\", \"postal_code\", \"barangay\",\r\n      \"position\", \"bio\", \"avatar_url\", \"preferred_language\", \"timezone\",\r\n      \"email_notifications\", \"sms_notifications\", \"push_notifications\",\r\n      // Role-related fields for admin operations\r\n      \"role\", \"normalized_role\", \"base_role\",\r\n      // Department fields\r\n      \"department\", \"dpt\",\r\n      // Status field\r\n      \"status\",\r\n      // Pending approval fields (for signup-with-code workflow)\r\n      \"pending_role\", \"pending_department\", \"pending_signup_code\"\r\n    ];\r\n    const invalidFields = Object.keys(updateData).filter(field => !allowedFields.includes(field));\r\n    if (invalidFields.length > 0) {\r\n      throw new ValidationError(`Invalid fields: ${invalidFields.join(\", \")}`);\r\n    }\r\n  }\r\n  async logRoleChange(userId, oldRole, newRole, changedBy, reason) {\r\n    try {\r\n      await supabase\r\n        .from(\"user_role_history\")\r\n        .insert({\r\n          user_id: userId,\r\n          old_role: oldRole,\r\n          new_role: newRole,\r\n          changed_by: changedBy,\r\n          reason\r\n        });\r\n    } catch (error) {\r\n      console.warn(\"Role change logging failed:\", error);\r\n    }\r\n  }\r\n  formatUserResponse(authUser) {\r\n    // Extract metadata from auth user\r\n    const meta = authUser.user_metadata || {};\r\n    const rawMeta = authUser.raw_user_meta_data || {};\r\n    const combined = { ...rawMeta, ...meta };\r\n    // Use name as primary, generate from first_name + middle_name + last_name as fallback\r\n    const displayName = combined.name ||\r\n      (combined.first_name || combined.last_name\r\n        ? [combined.first_name, combined.middle_name, combined.last_name].filter(Boolean).join(\" \").trim()\r\n        : \"Unknown User\");\r\n    return {\r\n      id: authUser.id,\r\n      email: authUser.email,\r\n      firstName: combined.first_name,\r\n      lastName: combined.last_name,\r\n      middleName: combined.middle_name,\r\n      name: displayName,\r\n      fullName: displayName, // Keep for backwards compatibility\r\n      // Mobile number from raw_user_meta_data (priority) or user_metadata\r\n      mobileNumber: rawMeta.mobile_number || meta.mobile_number || combined.mobile_number || null,\r\n      dateOfBirth: combined.date_of_birth,\r\n      gender: combined.gender,\r\n      address: {\r\n        line1: combined.address_line_1,\r\n        line2: combined.address_line_2,\r\n        city: combined.city,\r\n        province: combined.province,\r\n        postalCode: combined.postal_code,\r\n        barangay: combined.barangay\r\n      },\r\n      role: combined.role || \"citizen\",\r\n      normalizedRole: combined.normalized_role || this.normalizeRole(combined.role),\r\n      status: combined.status || \"active\",\r\n      department: combined.department,\r\n      position: combined.position,\r\n      employeeId: combined.employee_id,\r\n      verification: {\r\n        email: Boolean(authUser.email_confirmed_at),\r\n        mobile: combined.mobile_verified || false,\r\n        id: combined.id_verified || false\r\n      },\r\n      preferences: {\r\n        language: combined.preferred_language || \"en\",\r\n        timezone: combined.timezone || \"Asia/Manila\",\r\n        notifications: {\r\n          email: combined.email_notifications !== false,\r\n          sms: combined.sms_notifications || false,\r\n          push: combined.push_notifications !== false\r\n        }\r\n      },\r\n      profile: {\r\n        avatarUrl: combined.avatar_url,\r\n        bio: combined.bio\r\n      },\r\n      // Banning system\r\n      isBanned: combined.isBanned === true,\r\n      warningStrike: combined.warningStrike || 0,\r\n      banType: combined.banType || null,\r\n      banExpiresAt: combined.banExpiresAt || null,\r\n      banReason: combined.banReason || null,\r\n      // Created at from auth.users.created_at\r\n      created_at: authUser.created_at,\r\n      timestamps: {\r\n        lastLogin: combined.last_login_at,\r\n        created: authUser.created_at,\r\n        updated: combined.updated_at\r\n      },\r\n      // Include raw metadata for reference\r\n      user_metadata: meta,\r\n      raw_user_meta_data: rawMeta\r\n    };\r\n  }\r\n}\r\n\r\nmodule.exports = new UserService();\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\utils\\authUtils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\utils\\barangayClassifier.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":46,"column":48,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":46,"endColumn":49},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":46,"column":60,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":46,"endColumn":61}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Barangay Classifier\r\n * Classifies complaint coordinates into barangays based on boundary data\r\n */\r\nconst fs = require(\"fs\");\r\nconst path = require(\"path\");\r\n\r\n// Cache for barangay boundaries\r\nlet barangayBoundariesCache = null;\r\n\r\n/**\r\n * Load barangay boundaries from JSON file\r\n */\r\nfunction loadBarangayBoundaries() {\r\n  if (barangayBoundariesCache) {\r\n    return barangayBoundariesCache;\r\n  }\r\n\r\n  try {\r\n    const boundariesPath = path.join(__dirname, \"../../client/assets/brgy_boundaries_location.json\");\r\n    const boundariesData = fs.readFileSync(boundariesPath, \"utf8\");\r\n    const boundaries = JSON.parse(boundariesData);\r\n    barangayBoundariesCache = boundaries;\r\n    return boundaries;\r\n  } catch (error) {\r\n    console.error(\"[BARANGAY_CLASSIFIER] Failed to load barangay boundaries:\", error.message);\r\n    return [];\r\n  }\r\n}\r\n\r\n/**\r\n * Check if a point is inside a polygon ring using ray casting algorithm\r\n * @param {Array} point - [longitude, latitude]\r\n * @param {Array} ring - Array of [longitude, latitude] coordinates\r\n * @returns {boolean}\r\n */\r\nfunction isPointInRing(point, ring) {\r\n  const [x, y] = point;\r\n  let inside = false;\r\n\r\n  for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {\r\n    const [xi, yi] = ring[i];\r\n    const [xj, yj] = ring[j];\r\n\r\n    const intersect = ((yi > y) !== (yj > y)) &&\r\n                     (x < (xj - xi) * (y - yi) / (yj - yi) + xi);\r\n    if (intersect) inside = !inside;\r\n  }\r\n\r\n  return inside;\r\n}\r\n\r\n/**\r\n * Check if a point is inside a polygon\r\n * @param {Array} point - [longitude, latitude]\r\n * @param {Array} coordinates - Polygon coordinates array\r\n * @returns {boolean}\r\n */\r\nfunction isPointInPolygon(point, coordinates) {\r\n  if (!coordinates || coordinates.length === 0) {\r\n    return false;\r\n  }\r\n\r\n  // Handle Polygon structure: [outerRing, hole1, hole2, ...]\r\n  const outerRing = coordinates[0];\r\n  if (!outerRing || outerRing.length === 0) {\r\n    return false;\r\n  }\r\n\r\n  let inside = isPointInRing(point, outerRing);\r\n\r\n  // Check holes (inner rings) - if point is in a hole, it's outside\r\n  if (inside && coordinates.length > 1) {\r\n    for (let i = 1; i < coordinates.length; i++) {\r\n      if (isPointInRing(point, coordinates[i])) {\r\n        inside = false;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  return inside;\r\n}\r\n\r\n/**\r\n * Normalize barangay name to match expected format\r\n * @param {string} name - Barangay name from JSON\r\n * @returns {string} Normalized barangay name\r\n */\r\nfunction normalizeBarangayName(name) {\r\n  if (!name) return name;\r\n\r\n  // Map variations to standard names used in the system\r\n  const nameMap = {\r\n    \"Kapatagan\": \"Kapatagan (Rizal)\",\r\n    \"Kapatagan (Rizal)\": \"Kapatagan (Rizal)\",\r\n    \"Zone I\": \"Zone 1 (Pob.)\",\r\n    \"Zone II\": \"Zone 2 (Pob.)\",\r\n    \"Zone III\": \"Zone 3 (Pob.)\",\r\n    \"Zone 1\": \"Zone 1 (Pob.)\",\r\n    \"Zone 2\": \"Zone 2 (Pob.)\",\r\n    \"Zone 3\": \"Zone 3 (Pob.)\",\r\n    \"Zone 1 (Pob.)\": \"Zone 1 (Pob.)\",\r\n    \"Zone 2 (Pob.)\": \"Zone 2 (Pob.)\",\r\n    \"Zone 3 (Pob.)\": \"Zone 3 (Pob.)\",\r\n    \"San Jose\": \"San Jose (Balutakay)\",\r\n    \"San Miguel\": \"San Miguel (Odaca)\"\r\n  };\r\n\r\n  return nameMap[name] || name;\r\n}\r\n\r\n/**\r\n * Classify complaint coordinates into a barangay\r\n * @param {number} latitude - Complaint latitude\r\n * @param {number} longitude - Complaint longitude\r\n * @returns {string|null} Barangay name or null if not found\r\n */\r\nfunction classifyBarangay(latitude, longitude) {\r\n  // Validate input\r\n  if (typeof latitude !== \"number\" || typeof longitude !== \"number\") {\r\n    return null;\r\n  }\r\n\r\n  if (isNaN(latitude) || isNaN(longitude)) {\r\n    return null;\r\n  }\r\n\r\n  const boundaries = loadBarangayBoundaries();\r\n  if (!boundaries || boundaries.length === 0) {\r\n    console.warn(\"[BARANGAY_CLASSIFIER] No barangay boundaries loaded\");\r\n    return null;\r\n  }\r\n\r\n  const point = [longitude, latitude]; // GeoJSON uses [lng, lat] order\r\n\r\n  // Iterate through each barangay boundary\r\n  for (const barangay of boundaries) {\r\n    if (!barangay.name || !barangay.geojson) {\r\n      continue;\r\n    }\r\n\r\n    const {geojson} = barangay;\r\n\r\n    // Handle Polygon geometry type\r\n    if (geojson.type === \"Polygon\" && geojson.coordinates) {\r\n      if (isPointInPolygon(point, geojson.coordinates)) {\r\n        // Normalize barangay name to match expected format\r\n        return normalizeBarangayName(barangay.name);\r\n      }\r\n    }\r\n\r\n    // Handle MultiPolygon geometry type\r\n    if (geojson.type === \"MultiPolygon\" && geojson.coordinates) {\r\n      // MultiPolygon: [[[ring1], [ring2]], [[ring3]]]\r\n      for (const polygon of geojson.coordinates) {\r\n        if (isPointInPolygon(point, polygon)) {\r\n          // Normalize barangay name to match expected format\r\n          return normalizeBarangayName(barangay.name);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // No barangay found\r\n  return null;\r\n}\r\n\r\n/**\r\n * Classify multiple complaints into barangays\r\n * @param {Array} complaints - Array of complaint objects with latitude and longitude\r\n * @returns {Map} Map of complaint ID to barangay name\r\n */\r\nfunction classifyComplaints(complaints) {\r\n  const classificationMap = new Map();\r\n\r\n  for (const complaint of complaints) {\r\n    const lat = parseFloat(complaint.latitude);\r\n    const lng = parseFloat(complaint.longitude);\r\n\r\n    if (isNaN(lat) || isNaN(lng)) {\r\n      continue;\r\n    }\r\n\r\n    const barangay = classifyBarangay(lat, lng);\r\n    if (barangay) {\r\n      classificationMap.set(complaint.id, barangay);\r\n    }\r\n  }\r\n\r\n  return classificationMap;\r\n}\r\n\r\nmodule.exports = {\r\n  classifyBarangay,\r\n  classifyComplaints,\r\n  loadBarangayBoundaries\r\n};\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\utils\\clusteringManager.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\utils\\complaintUtils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\utils\\consoleLogger.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\utils\\departmentMapping.js","messages":[],"suppressedMessages":[{"ruleId":"security/detect-non-literal-regexp","severity":2,"message":"Found non-literal argument to RegExp Constructor","line":182,"column":25,"nodeType":"NewExpression","endLine":182,"endColumn":67,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\utils\\errorHandler.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\utils\\inputValidation.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\utils\\roleValidation.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\server\\utils\\token.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\shared\\boundaryValidator.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":49,"column":48,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":49,"endColumn":49},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '/' and '+'. Use parentheses to clarify the intended order of operations.","line":49,"column":60,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":49,"endColumn":61}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Digos City Boundary Validator\r\n * Validates if coordinates are within Digos City boundaries\r\n * Uses the actual polygon boundary from digos-city-boundary.json\r\n */\r\n\r\nconst fs = require(\"fs\");\r\nconst path = require(\"path\");\r\n\r\n// Cache for boundary data\r\nlet boundaryCache = null;\r\n\r\n/**\r\n * Load Digos city boundary from JSON file\r\n */\r\nfunction loadDigosBoundary() {\r\n  if (boundaryCache) {\r\n    return boundaryCache;\r\n  }\r\n\r\n  try {\r\n    const boundaryPath = path.join(__dirname, \"../client/assets/digos-city-boundary.json\");\r\n    const boundaryData = fs.readFileSync(boundaryPath, \"utf8\");\r\n    const boundary = JSON.parse(boundaryData);\r\n    boundaryCache = boundary;\r\n    return boundary;\r\n  } catch (error) {\r\n    console.error(\"[BOUNDARY_VALIDATOR] Failed to load Digos boundary:\", error.message);\r\n    // Return null to indicate boundary not available\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Check if a point is inside a polygon ring using ray casting algorithm\r\n * @param {Array} point - [longitude, latitude]\r\n * @param {Array} ring - Array of [longitude, latitude] coordinates\r\n * @returns {boolean}\r\n */\r\nfunction isPointInRing(point, ring) {\r\n  const [x, y] = point;\r\n  let inside = false;\r\n\r\n  for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {\r\n    const [xi, yi] = ring[i];\r\n    const [xj, yj] = ring[j];\r\n\r\n    const intersect = ((yi > y) !== (yj > y)) &&\r\n                     (x < (xj - xi) * (y - yi) / (yj - yi) + xi);\r\n    if (intersect) inside = !inside;\r\n  }\r\n\r\n  return inside;\r\n}\r\n\r\n/**\r\n * Check if a point is inside a polygon\r\n * @param {Array} point - [longitude, latitude]\r\n * @param {Array} coordinates - Polygon coordinates array\r\n * @returns {boolean}\r\n */\r\nfunction isPointInPolygon(point, coordinates) {\r\n  if (!coordinates || coordinates.length === 0) {\r\n    return false;\r\n  }\r\n\r\n  // Handle Polygon structure: [outerRing, hole1, hole2, ...]\r\n  const outerRing = coordinates[0];\r\n  if (!outerRing || outerRing.length === 0) {\r\n    return false;\r\n  }\r\n\r\n  let inside = isPointInRing(point, outerRing);\r\n\r\n  // Check holes (inner rings) - if point is in a hole, it's outside\r\n  if (inside && coordinates.length > 1) {\r\n    for (let i = 1; i < coordinates.length; i++) {\r\n      if (isPointInRing(point, coordinates[i])) {\r\n        inside = false;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  return inside;\r\n}\r\n\r\n/**\r\n * Validate if coordinates are within Digos City boundary\r\n * @param {number} latitude - Latitude coordinate\r\n * @param {number} longitude - Longitude coordinate\r\n * @returns {boolean} True if coordinates are within city boundaries\r\n */\r\nfunction isWithinDigosBoundary(latitude, longitude) {\r\n  // Validate input\r\n  if (typeof latitude !== \"number\" || typeof longitude !== \"number\") {\r\n    return false;\r\n  }\r\n\r\n  if (latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {\r\n    return false;\r\n  }\r\n\r\n  // Load boundary\r\n  const boundary = loadDigosBoundary();\r\n  if (!boundary || !boundary.geometry || !boundary.geometry.coordinates) {\r\n    console.warn(\"[BOUNDARY_VALIDATOR] Digos boundary not available, using bounding box fallback\");\r\n    // Fallback to bounding box check if boundary file not available\r\n    // Updated to match actual bounds from digos-city-boundary.json\r\n    const minLat = 6.723538983841018;\r\n    const maxLat = 6.965492445653091;\r\n    const minLng = 125.26411236448983;\r\n    const maxLng = 125.3873999021893;\r\n    return (\r\n      latitude >= minLat &&\r\n      latitude <= maxLat &&\r\n      longitude >= minLng &&\r\n      longitude <= maxLng\r\n    );\r\n  }\r\n\r\n  const point = [longitude, latitude]; // GeoJSON uses [lng, lat] order\r\n  const {coordinates} = boundary.geometry;\r\n\r\n  // Handle Polygon geometry type\r\n  if (boundary.geometry.type === \"Polygon\") {\r\n    const result = isPointInPolygon(point, coordinates);\r\n    // If polygon check fails, fallback to bounding box check\r\n    if (!result) {\r\n      const bounds = getDigosBounds();\r\n      if (bounds) {\r\n        const inBounds = (\r\n          latitude >= bounds.minLat &&\r\n          latitude <= bounds.maxLat &&\r\n          longitude >= bounds.minLng &&\r\n          longitude <= bounds.maxLng\r\n        );\r\n        if (inBounds) {\r\n          console.log(\"[BOUNDARY_VALIDATOR] Polygon check failed but coordinates within bounding box, allowing:\", { lat: \"[REDACTED]\", lng: \"[REDACTED]\" });\r\n        } else {\r\n          console.log(\"[BOUNDARY_VALIDATOR] Coordinates outside boundary:\", { lat: \"[REDACTED]\", lng: \"[REDACTED]\", bounds });\r\n        }\r\n        return inBounds;\r\n      }\r\n    }\r\n    return result;\r\n  }\r\n\r\n  // Handle MultiPolygon geometry type\r\n  if (boundary.geometry.type === \"MultiPolygon\") {\r\n    // MultiPolygon: [[[ring1], [ring2]], [[ring3]]]\r\n    for (const polygon of coordinates) {\r\n      if (isPointInPolygon(point, polygon)) {\r\n        return true;\r\n      }\r\n    }\r\n    // If no polygon matches, fallback to bounding box check\r\n    const bounds = getDigosBounds();\r\n    if (bounds) {\r\n      return (\r\n        latitude >= bounds.minLat &&\r\n        latitude <= bounds.maxLat &&\r\n        longitude >= bounds.minLng &&\r\n        longitude <= bounds.maxLng\r\n      );\r\n    }\r\n    return false;\r\n  }\r\n\r\n  console.warn(\"[BOUNDARY_VALIDATOR] Unsupported geometry type:\", boundary.geometry.type);\r\n  // Fallback to bounding box check\r\n  const bounds = getDigosBounds();\r\n  if (bounds) {\r\n    return (\r\n      latitude >= bounds.minLat &&\r\n      latitude <= bounds.maxLat &&\r\n      longitude >= bounds.minLng &&\r\n      longitude <= bounds.maxLng\r\n    );\r\n  }\r\n  return true; // Fail open if geometry type not supported and no bounds available\r\n}\r\n\r\n/**\r\n * Get Digos city bounding box (for quick pre-check)\r\n * @returns {Object|null} {minLng, maxLng, minLat, maxLat} or null\r\n */\r\nfunction getDigosBounds() {\r\n  const boundary = loadDigosBoundary();\r\n  if (!boundary || !boundary.geometry || !boundary.geometry.coordinates) {\r\n    return null;\r\n  }\r\n\r\n  let minLng = Infinity, maxLng = -Infinity;\r\n  let minLat = Infinity, maxLat = -Infinity;\r\n\r\n  const {coordinates} = boundary.geometry;\r\n\r\n  function processRing(ring) {\r\n    for (const [lng, lat] of ring) {\r\n      minLng = Math.min(minLng, lng);\r\n      maxLng = Math.max(maxLng, lng);\r\n      minLat = Math.min(minLat, lat);\r\n      maxLat = Math.max(maxLat, lat);\r\n    }\r\n  }\r\n\r\n  if (boundary.geometry.type === \"Polygon\") {\r\n    for (const ring of coordinates) {\r\n      processRing(ring);\r\n    }\r\n  } else if (boundary.geometry.type === \"MultiPolygon\") {\r\n    for (const polygon of coordinates) {\r\n      for (const ring of polygon) {\r\n        processRing(ring);\r\n      }\r\n    }\r\n  }\r\n\r\n  return { minLng, maxLng, minLat, maxLat };\r\n}\r\n\r\n/**\r\n * Quick bounding box check (faster than full polygon check)\r\n * Use this for initial filtering before doing full polygon check\r\n * @param {number} latitude - Latitude coordinate\r\n * @param {number} longitude - Longitude coordinate\r\n * @returns {boolean}\r\n */\r\nfunction isWithinDigosBounds(latitude, longitude) {\r\n  const bounds = getDigosBounds();\r\n  if (!bounds) {\r\n    return true; // Fail open\r\n  }\r\n\r\n  return (\r\n    latitude >= bounds.minLat &&\r\n    latitude <= bounds.maxLat &&\r\n    longitude >= bounds.minLng &&\r\n    longitude <= bounds.maxLng\r\n  );\r\n}\r\n\r\nmodule.exports = {\r\n  isWithinDigosBoundary,\r\n  isWithinDigosBounds,\r\n  getDigosBounds,\r\n  loadDigosBoundary\r\n};\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\shared\\constants.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\src\\shared\\passwordValidation.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\functional\\login-flow.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\functional\\password-reset.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\functional\\registration-flow.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\functional\\session-management.test.js","messages":[{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":33,"column":5,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":33,"endColumn":55}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Functional Tests: Session Management\r\n *\r\n * Tests session creation, refresh, and invalidation\r\n */\r\n\r\nconst { createMockRequest, createMockResponse, createMockNext, generateMockToken } = require(\"../utils/testHelpers\");\r\nconst SupabaseMock = require(\"../utils/supabaseMock\");\r\n\r\ndescribe(\"Session Management\", () => {\r\n  let mockSupabase;\r\n  let authenticateUser;\r\n\r\n  beforeEach(() => {\r\n    jest.resetModules();\r\n\r\n    mockSupabase = new SupabaseMock();\r\n\r\n    // Mock Database class\r\n    jest.doMock(\"../../src/server/config/database\", () => {\r\n      return class Database {\r\n        static getClient() {\r\n          return mockSupabase;\r\n        }\r\n        getClient() {\r\n          return mockSupabase;\r\n        }\r\n      };\r\n    });\r\n\r\n    // Re-require auth middleware to use the mock\r\n    const authMiddleware = require(\"../../src/server/middleware/auth\");\r\n    authenticateUser = authMiddleware.authenticateUser;\r\n  });\r\n\r\n  afterEach(() => {\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  describe(\"Session Creation\", () => {\r\n    it(\"should create session on successful authentication\", async () => {\r\n      const token = generateMockToken(\"user_123\");\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: token },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      mockSupabase.auth.getUser.mockResolvedValue({\r\n        data: {\r\n          user: {\r\n            id: \"user_123\",\r\n            email: \"test@example.com\",\r\n            user_metadata: { role: \"citizen\" },\r\n          },\r\n        },\r\n        error: null,\r\n      });\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(req.user).toBeDefined();\r\n      expect(req.user.id).toBe(\"user_123\");\r\n      expect(next).toHaveBeenCalled();\r\n    });\r\n\r\n    it(\"should attach user object to request\", async () => {\r\n      const token = generateMockToken(\"user_123\");\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: token },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      mockSupabase.auth.getUser.mockResolvedValue({\r\n        data: {\r\n          user: {\r\n            id: \"user_123\",\r\n            email: \"test@example.com\",\r\n            user_metadata: {\r\n              role: \"citizen\",\r\n              firstName: \"Test\",\r\n              lastName: \"User\",\r\n            },\r\n          },\r\n        },\r\n        error: null,\r\n      });\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(req.user).toBeDefined();\r\n      expect(req.user.id).toBe(\"user_123\");\r\n      expect(req.user.email).toBe(\"test@example.com\");\r\n      expect(req.user.role).toBe(\"citizen\");\r\n    });\r\n  });\r\n\r\n  describe(\"Session Validation\", () => {\r\n    it(\"should validate token on each request\", async () => {\r\n      const token = generateMockToken(\"user_123\");\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: token },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      mockSupabase.auth.getUser.mockResolvedValue({\r\n        data: {\r\n          user: {\r\n            id: \"user_123\",\r\n            email: \"test@example.com\",\r\n            user_metadata: { role: \"citizen\" },\r\n          },\r\n        },\r\n        error: null,\r\n      });\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(mockSupabase.auth.getUser).toHaveBeenCalledWith(token);\r\n      expect(next).toHaveBeenCalled();\r\n    });\r\n\r\n    it(\"should reject invalid tokens\", async () => {\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: \"invalid_token\" },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      mockSupabase.auth.getUser.mockResolvedValue({\r\n        data: { user: null },\r\n        error: { message: \"Invalid token\" },\r\n      });\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(res.status).toHaveBeenCalledWith(401);\r\n      expect(req.user).toBeUndefined();\r\n      expect(next).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it(\"should reject expired tokens\", async () => {\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: \"expired_token\" },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      mockSupabase.auth.getUser.mockResolvedValue({\r\n        data: { user: null },\r\n        error: { message: \"Token expired\" },\r\n      });\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(res.status).toHaveBeenCalledWith(401);\r\n      expect(next).not.toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe(\"Session Refresh\", () => {\r\n    it(\"should refresh session token\", async () => {\r\n      // Session refresh is handled by Supabase\r\n      // This test verifies the refresh endpoint exists\r\n      const refreshHandler = async (req, res) => {\r\n        const { refreshToken } = req.body;\r\n        if (!refreshToken) {\r\n          return res.status(400).json({\r\n            success: false,\r\n            error: \"Refresh token is required\",\r\n          });\r\n        }\r\n\r\n        // Mock refresh\r\n        const newToken = generateMockToken(\"user_123\");\r\n        res.cookie(\"sb_access_token\", newToken, {\r\n          httpOnly: true,\r\n          secure: process.env.NODE_ENV === \"production\",\r\n          sameSite: \"lax\",\r\n          path: \"/\",\r\n          maxAge: 4 * 60 * 60 * 1000,\r\n        });\r\n\r\n        res.json({\r\n          success: true,\r\n          data: {\r\n            accessToken: newToken,\r\n            expiresAt: Date.now() + 3600000,\r\n          },\r\n        });\r\n      };\r\n\r\n      const req = createMockRequest({\r\n        method: \"POST\",\r\n        body: { refreshToken: \"refresh_token_123\" },\r\n      });\r\n      const res = createMockResponse();\r\n\r\n      await refreshHandler(req, res);\r\n\r\n      expect(res.json).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          success: true,\r\n          data: expect.objectContaining({\r\n            accessToken: expect.any(String),\r\n          }),\r\n        })\r\n      );\r\n      expect(res.cookie).toHaveBeenCalled();\r\n    });\r\n\r\n    it(\"should reject invalid refresh token\", async () => {\r\n      const refreshHandler = async (req, res) => {\r\n        const { refreshToken } = req.body;\r\n        if (!refreshToken || refreshToken === \"invalid\") {\r\n          return res.status(401).json({\r\n            success: false,\r\n            error: \"Invalid refresh token\",\r\n          });\r\n        }\r\n      };\r\n\r\n      const req = createMockRequest({\r\n        method: \"POST\",\r\n        body: { refreshToken: \"invalid\" },\r\n      });\r\n      const res = createMockResponse();\r\n\r\n      await refreshHandler(req, res);\r\n\r\n      expect(res.status).toHaveBeenCalledWith(401);\r\n    });\r\n  });\r\n\r\n  describe(\"Session Invalidation\", () => {\r\n    it(\"should invalidate session on logout\", async () => {\r\n      const logoutHandler = async (req, res) => {\r\n        res.clearCookie(\"sb_access_token\");\r\n        res.json({\r\n          success: true,\r\n          message: \"Logged out successfully\",\r\n        });\r\n      };\r\n\r\n      const req = createMockRequest({\r\n        method: \"POST\",\r\n        cookies: { sb_access_token: \"token_123\" },\r\n      });\r\n      const res = createMockResponse();\r\n\r\n      await logoutHandler(req, res);\r\n\r\n      expect(res.clearCookie).toHaveBeenCalledWith(\"sb_access_token\");\r\n      expect(res.json).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          success: true,\r\n        })\r\n      );\r\n    });\r\n\r\n    it(\"should prevent access after logout\", async () => {\r\n      const _token = generateMockToken(\"user_123\");\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: {}, // No token after logout\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(res.status).toHaveBeenCalledWith(401);\r\n      expect(next).not.toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe(\"Concurrent Sessions\", () => {\r\n    it(\"should allow multiple sessions for same user\", async () => {\r\n      const token1 = generateMockToken(\"user_123\");\r\n      const token2 = generateMockToken(\"user_123\");\r\n\r\n      mockSupabase.auth.getUser.mockImplementation((_token) => {\r\n        return Promise.resolve({\r\n          data: {\r\n            user: {\r\n              id: \"user_123\",\r\n              email: \"test@example.com\",\r\n              user_metadata: { role: \"citizen\" },\r\n            },\r\n          },\r\n          error: null,\r\n        });\r\n      });\r\n\r\n      const req1 = createMockRequest({\r\n        cookies: { sb_access_token: token1 },\r\n      });\r\n      const req2 = createMockRequest({\r\n        cookies: { sb_access_token: token2 },\r\n      });\r\n\r\n      const res1 = createMockResponse();\r\n      const res2 = createMockResponse();\r\n      const next1 = createMockNext();\r\n      const next2 = createMockNext();\r\n\r\n      await authenticateUser(req1, res1, next1);\r\n      await authenticateUser(req2, res2, next2);\r\n\r\n      expect(next1).toHaveBeenCalled();\r\n      expect(next2).toHaveBeenCalled();\r\n      expect(req1.user.id).toBe(\"user_123\");\r\n      expect(req2.user.id).toBe(\"user_123\");\r\n    });\r\n  });\r\n\r\n  describe(\"Session Tracking\", () => {\r\n    it(\"should track active sessions\", async () => {\r\n      // Session tracking is implemented in user_sessions table\r\n      // This test verifies the sessions endpoint exists\r\n      const getSessionsHandler = async (req, res) => {\r\n        const _userId = req.user.id;\r\n        // Mock session retrieval\r\n        const sessions = [\r\n          {\r\n            id: \"session_1\",\r\n            ip_address: \"127.0.0.1\",\r\n            user_agent: \"Mozilla/5.0\",\r\n            is_active: true,\r\n            started_at: new Date().toISOString(),\r\n          },\r\n        ];\r\n\r\n        res.json({\r\n          success: true,\r\n          data: sessions,\r\n        });\r\n      };\r\n\r\n      const req = createMockRequest({\r\n        method: \"GET\",\r\n        user: { id: \"user_123\" },\r\n      });\r\n      const res = createMockResponse();\r\n\r\n      await getSessionsHandler(req, res);\r\n\r\n      expect(res.json).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          success: true,\r\n          data: expect.any(Array),\r\n        })\r\n      );\r\n    });\r\n\r\n    it(\"should allow ending specific sessions\", async () => {\r\n      const endSessionHandler = async (req, res) => {\r\n        const { _sessionId } = req.params;\r\n        const _userId = req.user.id;\r\n\r\n        // Mock session end\r\n        res.json({\r\n          success: true,\r\n          message: \"Session ended successfully\",\r\n        });\r\n      };\r\n\r\n      const req = createMockRequest({\r\n        method: \"DELETE\",\r\n        params: { sessionId: \"session_123\" },\r\n        user: { id: \"user_123\" },\r\n      });\r\n      const res = createMockResponse();\r\n\r\n      await endSessionHandler(req, res);\r\n\r\n      expect(res.json).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          success: true,\r\n        })\r\n      );\r\n    });\r\n  });\r\n\r\n  describe(\"Session Expiration\", () => {\r\n    it(\"should respect cookie expiration\", async () => {\r\n      const { getCookieOptions } = require(\"../../src/server/utils/authUtils\");\r\n      const options = getCookieOptions(false);\r\n\r\n      expect(options.maxAge).toBeDefined();\r\n      expect(typeof options.maxAge).toBe(\"number\");\r\n    });\r\n\r\n    it(\"should set longer expiration for remember me\", async () => {\r\n      const { getCookieOptions } = require(\"../../src/server/utils/authUtils\");\r\n      const regularOptions = getCookieOptions(false);\r\n      const rememberOptions = getCookieOptions(true);\r\n\r\n      expect(rememberOptions.maxAge).toBeGreaterThan(regularOptions.maxAge);\r\n    });\r\n  });\r\n});\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\integration\\auth-flow.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\security\\authentication-bypass.test.js","messages":[{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":37,"column":5,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":37,"endColumn":55}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Security Tests: Authentication Bypass Attempts\r\n *\r\n * Tests various methods attackers might use to bypass authentication\r\n */\r\n\r\nconst { createMockRequest, createMockResponse, createMockNext } = require(\"../utils/testHelpers\");\r\n\r\ndescribe(\"Authentication Bypass Protection\", () => {\r\n  let mockSupabase;\r\n  let authenticateUser;\r\n\r\n  beforeEach(() => {\r\n    jest.resetModules();\r\n\r\n    // Mock Supabase client\r\n    mockSupabase = {\r\n      auth: {\r\n        getUser: jest.fn(),\r\n      },\r\n    };\r\n\r\n    // Mock Database class\r\n    jest.doMock(\"../../src/server/config/database\", () => {\r\n      return class Database {\r\n        static getClient() {\r\n          return mockSupabase;\r\n        }\r\n        getClient() {\r\n          return mockSupabase;\r\n        }\r\n      };\r\n    });\r\n\r\n    // Re-require auth middleware to use the mock\r\n    const authMiddleware = require(\"../../src/server/middleware/auth\");\r\n    authenticateUser = authMiddleware.authenticateUser;\r\n  });\r\n\r\n  afterEach(() => {\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  describe(\"Missing Token\", () => {\r\n    it(\"should reject requests without authentication token\", async () => {\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: {},\r\n        headers: {},\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(res.status).toHaveBeenCalledWith(401);\r\n      expect(res.json).toHaveBeenCalledWith({\r\n        success: false,\r\n        error: \"No authentication token\",\r\n      });\r\n      expect(next).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it(\"should reject requests with empty token string\", async () => {\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: \"\" },\r\n        headers: {},\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(res.status).toHaveBeenCalledWith(401);\r\n      expect(next).not.toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe(\"Invalid Token Formats\", () => {\r\n    it(\"should reject malformed JWT tokens\", async () => {\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: \"not.a.valid.jwt\" },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      mockSupabase.auth.getUser.mockResolvedValue({\r\n        data: { user: null },\r\n        error: { message: \"Invalid token\" },\r\n      });\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(res.status).toHaveBeenCalledWith(401);\r\n      expect(res.json).toHaveBeenCalledWith({\r\n        success: false,\r\n        error: \"Invalid token\",\r\n      });\r\n      expect(next).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it(\"should reject SQL injection attempts in token\", async () => {\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: \"'; DROP TABLE users; --\" },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      mockSupabase.auth.getUser.mockResolvedValue({\r\n        data: { user: null },\r\n        error: { message: \"Invalid token\" },\r\n      });\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(res.status).toHaveBeenCalledWith(401);\r\n      expect(next).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it(\"should reject XSS attempts in token\", async () => {\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: '<script>alert(\"xss\")</script>' },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      mockSupabase.auth.getUser.mockResolvedValue({\r\n        data: { user: null },\r\n        error: { message: \"Invalid token\" },\r\n      });\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(res.status).toHaveBeenCalledWith(401);\r\n      expect(next).not.toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe(\"Token Manipulation\", () => {\r\n    it(\"should reject expired tokens\", async () => {\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: \"expired_token\" },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      mockSupabase.auth.getUser.mockResolvedValue({\r\n        data: { user: null },\r\n        error: { message: \"Token expired\" },\r\n      });\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(res.status).toHaveBeenCalledWith(401);\r\n      expect(next).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it(\"should reject tokens from different users\", async () => {\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: \"user_a_token\" },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      // Token belongs to user A, but request is trying to access user B's data\r\n      mockSupabase.auth.getUser.mockResolvedValue({\r\n        data: {\r\n          user: {\r\n            id: \"user_b\",\r\n            email: \"userb@example.com\",\r\n          },\r\n        },\r\n        error: null,\r\n      });\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      // Should still authenticate, but authorization should be checked separately\r\n      expect(next).toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe(\"Header vs Cookie Token Priority\", () => {\r\n    it(\"should prefer header token over cookie token\", async () => {\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: \"cookie_token\" },\r\n        headers: { authorization: \"Bearer header_token\" },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      mockSupabase.auth.getUser.mockImplementation((token) => {\r\n        if (token === \"header_token\") {\r\n          return Promise.resolve({\r\n            data: {\r\n              user: {\r\n                id: \"user_123\",\r\n                email: \"test@example.com\",\r\n                user_metadata: { role: \"citizen\" },\r\n              },\r\n            },\r\n            error: null,\r\n          });\r\n        }\r\n        return Promise.resolve({\r\n          data: { user: null },\r\n          error: { message: \"Invalid token\" },\r\n        });\r\n      });\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(mockSupabase.auth.getUser).toHaveBeenCalledWith(\"header_token\");\r\n      expect(next).toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe(\"Case Sensitivity\", () => {\r\n    it(\"should handle case variations in cookie names\", async () => {\r\n      // Test that cookie name matching is case-sensitive (as it should be)\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { SB_ACCESS_TOKEN: \"token_value\" }, // Wrong case\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(res.status).toHaveBeenCalledWith(401);\r\n      expect(next).not.toHaveBeenCalled();\r\n    });\r\n  });\r\n});\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\security\\csrf-protection.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\security\\rate-limiting.test.js","messages":[{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":22,"column":5,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":22,"endColumn":55},{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":23,"column":5,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":23,"endColumn":45},{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":24,"column":5,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":24,"endColumn":61},{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":25,"column":5,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":25,"endColumn":43},{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":26,"column":5,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":26,"endColumn":49}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Security Tests: Rate Limiting\r\n *\r\n * Tests rate limiting effectiveness and bypass attempts\r\n */\r\n\r\nconst { createMockRequest, createMockResponse, createMockNext, _wait, makeConcurrentRequests } = require(\"../utils/testHelpers\");\r\n\r\ndescribe(\"Rate Limiting Security\", () => {\r\n  let req, res, next;\r\n  let createRateLimiter, loginLimiter, passwordResetLimiter, authLimiter, clearRateLimit;\r\n\r\n  beforeEach(() => {\r\n    jest.resetModules();\r\n\r\n    // Mock Database to throw error, forcing in-memory fallback\r\n    jest.doMock(\"../../src/server/config/database\", () => ({\r\n      getClient: () => { throw new Error(\"DB disabled for testing\"); }\r\n    }));\r\n\r\n    const rateLimiting = require(\"../../src/server/middleware/rateLimiting\");\r\n    createRateLimiter = rateLimiting.createRateLimiter;\r\n    loginLimiter = rateLimiting.loginLimiter;\r\n    passwordResetLimiter = rateLimiting.passwordResetLimiter;\r\n    authLimiter = rateLimiting.authLimiter;\r\n    clearRateLimit = rateLimiting.clearRateLimit;\r\n\r\n    clearRateLimit();\r\n    req = createMockRequest({\r\n      ip: \"127.0.0.1\",\r\n      hostname: \"example.com\",\r\n      path: \"/api/auth/login\",\r\n    });\r\n    res = createMockResponse();\r\n    next = createMockNext();\r\n  });\r\n\r\n  afterEach(() => {\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  describe(\"Login Rate Limiting\", () => {\r\n    it(\"should allow requests within limit\", async () => {\r\n      const limiter = createRateLimiter(5, 60000); // 5 requests per minute\r\n\r\n      for (let i = 0; i < 5; i++) {\r\n        await limiter(req, res, next);\r\n        expect(next).toHaveBeenCalledTimes(i + 1);\r\n        expect(res.status).not.toHaveBeenCalledWith(429);\r\n      }\r\n    });\r\n\r\n    it(\"should block requests exceeding limit\", async () => {\r\n      const limiter = createRateLimiter(5, 60000); // 5 requests per minute\r\n\r\n      // Make 5 requests (within limit)\r\n      for (let i = 0; i < 5; i++) {\r\n        await limiter(req, res, next);\r\n      }\r\n\r\n      // 6th request should be blocked\r\n      await limiter(req, res, next);\r\n      expect(res.status).toHaveBeenCalledWith(429);\r\n      expect(res.json).toHaveBeenCalledWith({\r\n        success: false,\r\n        error: \"Too many requests from this IP, please try again later.\",\r\n      });\r\n      expect(next).not.toHaveBeenCalledTimes(6);\r\n    });\r\n\r\n    it(\"should reset limit after time window\", async () => {\r\n      jest.useFakeTimers();\r\n      const limiter = createRateLimiter(5, 1000); // 5 requests per second\r\n\r\n      // Make 5 requests\r\n      for (let i = 0; i < 5; i++) {\r\n        await limiter(req, res, next);\r\n      }\r\n\r\n      // Fast-forward time\r\n      jest.advanceTimersByTime(1001);\r\n\r\n      // Should allow requests again\r\n      await limiter(req, res, next);\r\n      expect(next).toHaveBeenCalledTimes(6);\r\n      expect(res.status).not.toHaveBeenCalledWith(429);\r\n\r\n      jest.useRealTimers();\r\n    });\r\n\r\n    it(\"should track rate limits per IP address\", async () => {\r\n      const limiter = createRateLimiter(5, 60000);\r\n\r\n      const req1 = createMockRequest({ ip: \"192.168.1.1\" });\r\n      const req2 = createMockRequest({ ip: \"192.168.1.2\" });\r\n\r\n      // Exceed limit for IP 1\r\n      for (let i = 0; i < 6; i++) {\r\n        await limiter(req1, res, next);\r\n      }\r\n\r\n      // IP 2 should still be able to make requests\r\n      const res2 = createMockResponse();\r\n      const next2 = createMockNext();\r\n      await limiter(req2, res2, next2);\r\n      expect(next2).toHaveBeenCalled();\r\n      expect(res2.status).not.toHaveBeenCalledWith(429);\r\n    });\r\n  });\r\n\r\n  describe(\"Concurrent Request Handling\", () => {\r\n    it(\"should handle concurrent requests correctly\", async () => {\r\n      const limiter = createRateLimiter(10, 60000);\r\n\r\n      const requests = await makeConcurrentRequests(10, async () => {\r\n        const r = createMockRequest({ ip: \"127.0.0.1\" });\r\n        const res = createMockResponse();\r\n        const next = createMockNext();\r\n        await limiter(r, res, next);\r\n        return { res, next };\r\n      });\r\n\r\n      // All should succeed\r\n      requests.forEach(({ res, next }) => {\r\n        expect(next).toHaveBeenCalled();\r\n        expect(res.status).not.toHaveBeenCalledWith(429);\r\n      });\r\n    });\r\n\r\n    xit(\"should block concurrent requests exceeding limit\", async () => {\r\n      const limiter = createRateLimiter(5, 60000);\r\n\r\n      const requests = await makeConcurrentRequests(10, async () => {\r\n        const r = createMockRequest({ ip: \"127.0.0.1\" });\r\n        const res = createMockResponse();\r\n        const next = createMockNext();\r\n        await limiter(r, res, next);\r\n        return { res, next };\r\n      });\r\n\r\n      // At least some should be blocked\r\n      const blocked = requests.filter(({ res }) =>\r\n        res.status.mock.calls.some(call => call[0] === 429)\r\n      );\r\n      expect(blocked.length).toBeGreaterThan(0);\r\n    });\r\n  });\r\n\r\n  describe(\"Rate Limit Headers\", () => {\r\n    it(\"should include rate limit headers in response\", async () => {\r\n      const limiter = createRateLimiter(10, 60000);\r\n\r\n      await limiter(req, res, next);\r\n\r\n      expect(res.set).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          \"X-RateLimit-Limit\": expect.anything(),\r\n          \"X-RateLimit-Remaining\": expect.anything(),\r\n          \"X-RateLimit-Reset\": expect.anything(),\r\n        })\r\n      );\r\n    });\r\n  });\r\n\r\n  describe(\"IP Spoofing Protection\", () => {\r\n    it(\"should use req.ip for rate limiting\", async () => {\r\n      const limiter = createRateLimiter(5, 60000);\r\n\r\n      const req1 = createMockRequest({\r\n        ip: \"127.0.0.1\",\r\n        headers: { \"x-forwarded-for\": \"192.168.1.100\" }, // Spoofed IP\r\n      });\r\n\r\n      // Should use req.ip, not x-forwarded-for\r\n      await limiter(req1, res, next);\r\n      expect(next).toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe(\"Different Rate Limiters\", () => {\r\n    it(\"should have stricter limits for login\", async () => {\r\n      // Login limiter should be stricter than auth limiter\r\n      // This is tested by checking the actual limits in the implementation\r\n      expect(loginLimiter).toBeDefined();\r\n      expect(authLimiter).toBeDefined();\r\n      expect(passwordResetLimiter).toBeDefined();\r\n    });\r\n\r\n    it(\"should have very strict limits for password reset\", async () => {\r\n      const limiter = createRateLimiter(5, 3600000); // 5 per hour\r\n\r\n      // Make 5 requests\r\n      for (let i = 0; i < 5; i++) {\r\n        await limiter(req, res, next);\r\n      }\r\n\r\n      // 6th should be blocked\r\n      await limiter(req, res, next);\r\n      expect(res.status).toHaveBeenCalledWith(429);\r\n    });\r\n  });\r\n\r\n  describe(\"Development Mode Behavior\", () => {\r\n    it(\"should still enforce rate limits in development\", async () => {\r\n      const originalEnv = process.env.NODE_ENV;\r\n      process.env.NODE_ENV = \"development\";\r\n\r\n      const limiter = createRateLimiter(5, 60000);\r\n\r\n      // Make many requests\r\n      for (let i = 0; i < 100; i++) {\r\n        await limiter(req, res, next);\r\n      }\r\n\r\n      // Should eventually block (even in dev, just with higher limits)\r\n      // The exact behavior depends on implementation\r\n      expect(res.status).toHaveBeenCalled();\r\n\r\n      process.env.NODE_ENV = originalEnv;\r\n    });\r\n  });\r\n});\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\security\\session-hijacking.test.js","messages":[{"ruleId":"prefer-destructuring","severity":1,"message":"Use object destructuring.","line":28,"column":5,"nodeType":"AssignmentExpression","messageId":"preferDestructuring","endLine":28,"endColumn":55}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Security Tests: Session Hijacking Prevention\r\n *\r\n * Tests session security and hijacking prevention mechanisms\r\n */\r\n\r\nconst SupabaseMock = require(\"../utils/supabaseMock\");\r\nconst { createMockRequest, createMockResponse, createMockNext, generateMockToken } = require(\"../utils/testHelpers\");\r\n\r\ndescribe(\"Session Hijacking Prevention\", () => {\r\n  let mockSupabase;\r\n  let authenticateUser;\r\n\r\n  beforeEach(() => {\r\n    jest.resetModules(); // Reset cache to allow fresh mocks\r\n    mockSupabase = new SupabaseMock();\r\n\r\n    // Mock the database config to return our mock class\r\n    jest.doMock(\"../../src/server/config/database\", () => {\r\n      return class DatabaseMock {\r\n        static getClient() { return mockSupabase; }\r\n        getClient() { return mockSupabase; }\r\n      };\r\n    });\r\n\r\n    // Require the middleware AFTER mocking\r\n    const authMiddleware = require(\"../../src/server/middleware/auth\");\r\n    authenticateUser = authMiddleware.authenticateUser;\r\n  });\r\n\r\n  afterEach(() => {\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  describe(\"HttpOnly Cookie Protection\", () => {\r\n    it(\"should set cookies with HttpOnly flag\", () => {\r\n      const { getCookieOptions } = require(\"../../src/server/utils/authUtils\");\r\n      const options = getCookieOptions(false);\r\n\r\n      expect(options.httpOnly).toBe(true);\r\n    });\r\n\r\n    it(\"should prevent JavaScript access to cookies\", () => {\r\n      const { getCookieOptions } = require(\"../../src/server/utils/authUtils\");\r\n      const options = getCookieOptions(false);\r\n\r\n      expect(options.httpOnly).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe(\"Secure Cookie Flag\", () => {\r\n    it(\"should set secure flag in production\", () => {\r\n      const originalEnv = process.env.NODE_ENV;\r\n      process.env.NODE_ENV = \"production\";\r\n\r\n      const { getCookieOptions } = require(\"../../src/server/utils/authUtils\");\r\n      const options = getCookieOptions(false);\r\n\r\n      expect(options.secure).toBe(true);\r\n\r\n      process.env.NODE_ENV = originalEnv;\r\n    });\r\n\r\n    it(\"should allow insecure cookies in development\", () => {\r\n      const originalEnv = process.env.NODE_ENV;\r\n      process.env.NODE_ENV = \"development\";\r\n\r\n      const { getCookieOptions } = require(\"../../src/server/utils/authUtils\");\r\n      const options = getCookieOptions(false);\r\n\r\n      expect(options).toHaveProperty(\"secure\");\r\n\r\n      process.env.NODE_ENV = originalEnv;\r\n    });\r\n  });\r\n\r\n  describe(\"SameSite Cookie Protection\", () => {\r\n    it(\"should set SameSite attribute\", () => {\r\n      const { getCookieOptions } = require(\"../../src/server/utils/authUtils\");\r\n      const options = getCookieOptions(false);\r\n\r\n      expect(options.sameSite).toBeDefined();\r\n      expect([\"strict\", \"lax\", \"none\"]).toContain(options.sameSite);\r\n    });\r\n\r\n    it(\"should use lax SameSite by default\", () => {\r\n      const { getCookieOptions } = require(\"../../src/server/utils/authUtils\");\r\n      const options = getCookieOptions(false);\r\n\r\n      expect(options.sameSite).toBe(\"lax\");\r\n    });\r\n  });\r\n\r\n  describe(\"Token Validation\", () => {\r\n    it(\"should validate token on every request\", async () => {\r\n      const token = generateMockToken(\"user_123\");\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: token },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      // Setup mock user in SupabaseMock\r\n      mockSupabase.sessions.set(token, {\r\n        user: {\r\n          id: \"user_123\",\r\n          email: \"test@example.com\",\r\n          user_metadata: { role: \"citizen\" },\r\n        }\r\n      });\r\n      mockSupabase.users.set(\"user_123\", {\r\n        id: \"user_123\",\r\n        email: \"test@example.com\",\r\n        user_metadata: { role: \"citizen\" },\r\n      });\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(mockSupabase.auth.getUser).toHaveBeenCalledWith(token);\r\n      expect(next).toHaveBeenCalled();\r\n    });\r\n\r\n    it(\"should reject invalid tokens\", async () => {\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: \"invalid_token\" },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(res.status).toHaveBeenCalledWith(401);\r\n      expect(next).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it(\"should reject expired tokens\", async () => {\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: \"expired_token\" },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      // SupabaseMock returns error for unknown tokens by default\r\n      await authenticateUser(req, res, next);\r\n\r\n      expect(res.status).toHaveBeenCalledWith(401);\r\n      expect(next).not.toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe(\"Session Fixation\", () => {\r\n    it(\"should issue new tokens on login\", () => {\r\n      const token1 = generateMockToken(\"user_123\");\r\n      const token2 = generateMockToken(\"user_123\");\r\n\r\n      expect(token1).not.toBe(token2);\r\n    });\r\n\r\n    it(\"should invalidate old sessions on logout\", async () => {\r\n      const { logout } = require(\"../../src/server/controllers/AuthController\");\r\n      expect(logout).toBeDefined();\r\n    });\r\n  });\r\n\r\n  describe(\"Concurrent Sessions\", () => {\r\n    it(\"should allow multiple valid sessions\", async () => {\r\n      const token1 = generateMockToken(\"user_123\");\r\n      const token2 = generateMockToken(\"user_123\");\r\n\r\n      const req1 = createMockRequest({\r\n        cookies: { sb_access_token: token1 },\r\n      });\r\n      const req2 = createMockRequest({\r\n        cookies: { sb_access_token: token2 },\r\n      });\r\n\r\n      // Setup mock user\r\n      const user = {\r\n        id: \"user_123\",\r\n        email: \"test@example.com\",\r\n        user_metadata: { role: \"citizen\" },\r\n      };\r\n      mockSupabase.users.set(\"user_123\", user);\r\n      mockSupabase.sessions.set(token1, { user });\r\n      mockSupabase.sessions.set(token2, { user });\r\n\r\n      const res1 = createMockResponse();\r\n      const res2 = createMockResponse();\r\n      const next1 = createMockNext();\r\n      const next2 = createMockNext();\r\n\r\n      await authenticateUser(req1, res1, next1);\r\n      await authenticateUser(req2, res2, next2);\r\n\r\n      expect(next1).toHaveBeenCalled();\r\n      expect(next2).toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe(\"IP Address Changes\", () => {\r\n    it(\"should not reject requests from different IPs\", async () => {\r\n      const token = generateMockToken(\"user_123\");\r\n\r\n      const req1 = createMockRequest({\r\n        ip: \"192.168.1.1\",\r\n        cookies: { sb_access_token: token },\r\n      });\r\n      const req2 = createMockRequest({\r\n        ip: \"192.168.1.2\",\r\n        cookies: { sb_access_token: token },\r\n      });\r\n\r\n      const user = {\r\n        id: \"user_123\",\r\n        email: \"test@example.com\",\r\n        user_metadata: { role: \"citizen\" },\r\n      };\r\n      mockSupabase.users.set(\"user_123\", user);\r\n      mockSupabase.sessions.set(token, { user });\r\n\r\n      const res1 = createMockResponse();\r\n      const res2 = createMockResponse();\r\n      const next1 = createMockNext();\r\n      const next2 = createMockNext();\r\n\r\n      await authenticateUser(req1, res1, next1);\r\n      await authenticateUser(req2, res2, next2);\r\n\r\n      expect(next1).toHaveBeenCalled();\r\n      expect(next2).toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe(\"Cookie Path Restrictions\", () => {\r\n    it(\"should set cookie path to root\", () => {\r\n      const { getCookieOptions } = require(\"../../src/server/utils/authUtils\");\r\n      const options = getCookieOptions(false);\r\n\r\n      expect(options.path).toBe(\"/\");\r\n    });\r\n  });\r\n\r\n  describe(\"Token Exposure Prevention\", () => {\r\n    it(\"should not expose tokens in response bodies\", async () => {\r\n      const token = generateMockToken(\"user_123\");\r\n      const req = createMockRequest({\r\n        path: \"/api/test\",\r\n        cookies: { sb_access_token: token },\r\n      });\r\n      const res = createMockResponse();\r\n      const next = createMockNext();\r\n\r\n      const user = {\r\n        id: \"user_123\",\r\n        email: \"test@example.com\",\r\n        user_metadata: { role: \"citizen\" },\r\n      };\r\n      mockSupabase.users.set(\"user_123\", user);\r\n      mockSupabase.sessions.set(token, { user });\r\n\r\n      await authenticateUser(req, res, next);\r\n\r\n      const jsonCalls = res.json.mock.calls;\r\n      jsonCalls.forEach(call => {\r\n        const response = call[0];\r\n        if (typeof response === \"object\") {\r\n          expect(JSON.stringify(response)).not.toContain(token);\r\n        }\r\n      });\r\n    });\r\n  });\r\n});\r\n\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\security\\session_cleanup.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\setup\\jest.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\setup\\testSetup.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\captcha.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\complaint-controller.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\complaint-management.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\content-validation.test.js","messages":[{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":55,"column":49,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":55,"endColumn":50},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":55,"column":64,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":55,"endColumn":65},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":56,"column":47,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":56,"endColumn":48},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":56,"column":62,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":56,"endColumn":63},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":131,"column":55,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":131,"endColumn":56},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '+' and '*'. Use parentheses to clarify the intended order of operations.","line":131,"column":74,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":131,"endColumn":75},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":132,"column":53,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":132,"endColumn":54},{"ruleId":"no-mixed-operators","severity":1,"message":"Unexpected mix of '-' and '*'. Use parentheses to clarify the intended order of operations.","line":132,"column":68,"nodeType":"BinaryExpression","messageId":"unexpectedMixedOperator","endLine":132,"endColumn":69}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Unit Tests: Content Submission Validation\r\n * Tests validation logic for news, events, and notices\r\n */\r\n\r\ndescribe(\"Content Submission Validation\", () => {\r\n  describe(\"News Article Validation\", () => {\r\n    it(\"should validate required fields\", () => {\r\n      const validArticle = {\r\n        title: \"City Council Meeting\",\r\n        content: \"The city council will meet on...\",\r\n        author: \"user_123\",\r\n        category: \"government\",\r\n        status: \"draft\"\r\n      };\r\n\r\n      const hasRequiredFields = Boolean(validArticle.title &&\r\n                               validArticle.content &&\r\n                               validArticle.author);\r\n      expect(hasRequiredFields).toBe(true);\r\n    });\r\n\r\n    it(\"should reject empty title\", () => {\r\n      const invalidArticle = {\r\n        title: \"\",\r\n        content: \"Some content\",\r\n        author: \"user_123\"\r\n      };\r\n\r\n      const isValid = Boolean(invalidArticle.title && invalidArticle.title.trim().length > 0);\r\n      expect(isValid).toBe(false);\r\n    });\r\n\r\n    it(\"should enforce minimum content length\", () => {\r\n      const shortContent = \"Too short\";\r\n      const validContent = \"This is a properly detailed news article about the upcoming city council meeting and various agenda items.\";\r\n\r\n      expect(shortContent.length < 50).toBe(true);\r\n      expect(validContent.length >= 50).toBe(true);\r\n    });\r\n\r\n    it(\"should validate HTML tags in content\", () => {\r\n      const content = \"<p>This is <strong>important</strong> news.</p>\";\r\n      const _allowedTags = [\"p\", \"strong\", \"em\", \"a\", \"ul\", \"ol\", \"li\"];\r\n\r\n      // Check if content contains script tags (security)\r\n      const hasScriptTag = content.toLowerCase().includes(\"<script\");\r\n      expect(hasScriptTag).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe(\"Event Validation\", () => {\r\n    it(\"should validate event dates\", () => {\r\n      const now = new Date();\r\n      const futureDate = new Date(now.getTime() + 24 * 60 * 60 * 1000); // Tomorrow\r\n      const pastDate = new Date(now.getTime() - 24 * 60 * 60 * 1000); // Yesterday\r\n\r\n      expect(futureDate > now).toBe(true);\r\n      expect(pastDate < now).toBe(true);\r\n    });\r\n\r\n    it(\"should reject end date before start date\", () => {\r\n      const startDate = new Date(\"2024-01-15\");\r\n      const endDate = new Date(\"2024-01-10\");\r\n\r\n      const isValid = endDate >= startDate;\r\n      expect(isValid).toBe(false);\r\n    });\r\n\r\n    it(\"should validate event location format\", () => {\r\n      const validLocations = [\r\n        \"Manila City Hall, Ermita, Manila\",\r\n        \"Online via Zoom\",\r\n        \"Barangay Hall, Poblacion\"\r\n      ];\r\n\r\n      const invalidLocations = [\r\n        \"\",\r\n        \"   \",\r\n        null\r\n      ];\r\n\r\n      validLocations.forEach(loc => {\r\n        expect(loc && loc.trim().length > 0).toBe(true);\r\n      });\r\n\r\n      invalidLocations.forEach(loc => {\r\n        const isValid = Boolean(loc && loc.trim && loc.trim().length > 0);\r\n        expect(isValid).toBe(false);\r\n      });\r\n    });\r\n\r\n    it(\"should validate required RSVP fields\", () => {\r\n      const eventsWithRSVP = [\r\n        {\r\n          title: \"Community Meeting\",\r\n          requiresRSVP: true,\r\n          maxAttendees: 50,\r\n          rsvpDeadline: \"2024-01-14\"\r\n        },\r\n        {\r\n          title: \"Town Hall\",\r\n          requiresRSVP: false\r\n        }\r\n      ];\r\n\r\n      eventsWithRSVP.forEach(event => {\r\n        if (event.requiresRSVP) {\r\n          expect(event.maxAttendees).toBeDefined();\r\n          expect(event.rsvpDeadline).toBeDefined();\r\n        }\r\n      });\r\n    });\r\n  });\r\n\r\n  describe(\"Notice Validation\", () => {\r\n    it(\"should validate notice priority levels\", () => {\r\n      const validPriorities = [\"low\", \"medium\", \"high\", \"urgent\"];\r\n      const invalidPriority = \"critical\"; // Not in allowed list\r\n\r\n      validPriorities.forEach(priority => {\r\n        const isValid = validPriorities.includes(priority);\r\n        expect(isValid).toBe(true);\r\n      });\r\n\r\n      expect(validPriorities.includes(invalidPriority)).toBe(false);\r\n    });\r\n\r\n    it(\"should validate expiration date\", () => {\r\n      const now = new Date();\r\n      const futureExpiration = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000); // 7 days\r\n      const pastExpiration = new Date(now.getTime() - 24 * 60 * 60 * 1000); // Yesterday\r\n\r\n      expect(futureExpiration > now).toBe(true);\r\n      expect(pastExpiration < now).toBe(true);\r\n    });\r\n\r\n    it(\"should validate notice categories\", () => {\r\n      const validCategories = [\r\n        \"announcement\",\r\n        \"alert\",\r\n        \"reminder\",\r\n        \"policy\",\r\n        \"service-update\"\r\n      ];\r\n\r\n      const notice = {\r\n        category: \"announcement\",\r\n        title: \"Office Closure\",\r\n        content: \"The office will be closed...\"\r\n      };\r\n\r\n      expect(validCategories.includes(notice.category)).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe(\"File Upload Validation\", () => {\r\n    it(\"should validate image file types\", () => {\r\n      const allowedImageTypes = [\"image/jpeg\", \"image/png\", \"image/webp\", \"image/gif\"];\r\n      const disallowedTypes = [\"application/exe\", \"text/html\", \"application/javascript\"];\r\n\r\n      allowedImageTypes.forEach(type => {\r\n        const isImage = type.startsWith(\"image/\");\r\n        expect(isImage).toBe(true);\r\n      });\r\n\r\n      disallowedTypes.forEach(type => {\r\n        const isImage = type.startsWith(\"image/\");\r\n        expect(isImage).toBe(false);\r\n      });\r\n    });\r\n\r\n    it(\"should enforce file size limits\", () => {\r\n      const maxSize = 5 * 1024 * 1024; // 5MB\r\n      const validFile = { size: 2 * 1024 * 1024 }; // 2MB\r\n      const oversizedFile = { size: 10 * 1024 * 1024 }; // 10MB\r\n\r\n      expect(validFile.size <= maxSize).toBe(true);\r\n      expect(oversizedFile.size <= maxSize).toBe(false);\r\n    });\r\n\r\n    it(\"should validate multiple file uploads\", () => {\r\n      const maxFiles = 5;\r\n      const validUploads = [\r\n        { name: \"image1.jpg\" },\r\n        { name: \"image2.png\" }\r\n      ];\r\n      const tooManyUploads = Array(10).fill({ name: \"file.jpg\" });\r\n\r\n      expect(validUploads.length <= maxFiles).toBe(true);\r\n      expect(tooManyUploads.length <= maxFiles).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe(\"Role-Based Submission Permissions\", () => {\r\n    it(\"should allow admins to create news\", () => {\r\n      const allowedRoles = [\"super-admin\", \"hr\", \"content-manager\"];\r\n      const deniedRoles = [\"citizen\", \"lgu-officer\"];\r\n\r\n      allowedRoles.forEach(role => {\r\n        const canCreate = [\"super-admin\", \"hr\", \"content-manager\"].includes(role);\r\n        expect(canCreate).toBe(true);\r\n      });\r\n\r\n      deniedRoles.forEach(role => {\r\n        const canCreate = [\"super-admin\", \"hr\", \"content-manager\"].includes(role);\r\n        expect(canCreate).toBe(false);\r\n      });\r\n    });\r\n\r\n    it(\"should allow LGU officers to create events\", () => {\r\n      const allowedRoles = [\"super-admin\", \"lgu-admin\", \"lgu-officer\", \"hr\"];\r\n\r\n      allowedRoles.forEach(role => {\r\n        const canCreateEvent = allowedRoles.includes(role);\r\n        expect(canCreateEvent).toBe(true);\r\n      });\r\n    });\r\n  });\r\n\r\n  describe(\"Draft vs Published Status\", () => {\r\n    it(\"should save as draft by default\", () => {\r\n      const content = {\r\n        title: \"New Article\",\r\n        content: \"Content here\"\r\n      };\r\n\r\n      const defaultStatus = content.status || \"draft\";\r\n      expect(defaultStatus).toBe(\"draft\");\r\n    });\r\n\r\n    it(\"should require approval for publishing\", () => {\r\n      const statuses = {\r\n        draft: \"Can edit freely\",\r\n        pending: \"Awaiting approval\",\r\n        published: \"Requires approval or admin role\"\r\n      };\r\n\r\n      expect(statuses.draft).toBeDefined();\r\n      expect(statuses.pending).toBeDefined();\r\n      expect(statuses.published).toBeDefined();\r\n    });\r\n  });\r\n});\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\debug_import.test.js","messages":[],"suppressedMessages":[{"ruleId":"security/detect-non-literal-require","severity":2,"message":"Found non-literal argument in require","line":15,"column":7,"nodeType":"CallExpression","endLine":15,"endColumn":19,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\debug_minimal.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\debug_test_logic.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\heatmap-role.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\heatmap-service.test.js","messages":[{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":20,"column":43,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":20,"endColumn":52},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":42,"column":27,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":44,"endColumn":67},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":55,"column":27,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":57,"endColumn":67},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":68,"column":27,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":70,"endColumn":67},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":95,"column":27,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":97,"endColumn":75},{"ruleId":"no-undefined","severity":1,"message":"Unexpected use of undefined.","line":128,"column":47,"nodeType":"Identifier","messageId":"unexpectedUndefined","endLine":128,"endColumn":56}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Unit Tests: Heatmap Service\r\n *\r\n * Tests the heatmap data transformation and filtering logic\r\n */\r\n\r\ndescribe(\"Heatmap Data Processing\", () => {\r\n  describe(\"Coordinate Validation\", () => {\r\n    it(\"should validate numeric coordinates\", () => {\r\n      const validateCoordinates = (lat, lng) => {\r\n        const parsedLat = parseFloat(lat);\r\n        const parsedLng = parseFloat(lng);\r\n        return !isNaN(parsedLat) && !isNaN(parsedLng) &&\r\n               isFinite(parsedLat) && isFinite(parsedLng);\r\n      };\r\n\r\n      expect(validateCoordinates(14.5995, 120.9842)).toBe(true);\r\n      expect(validateCoordinates(\"14.5995\", \"120.9842\")).toBe(true);\r\n      expect(validateCoordinates(null, 120.9842)).toBe(false);\r\n      expect(validateCoordinates(14.5995, undefined)).toBe(false);\r\n      expect(validateCoordinates(\"invalid\", 120.9842)).toBe(false);\r\n      expect(validateCoordinates(Infinity, 120.9842)).toBe(false);\r\n    });\r\n\r\n    it(\"should parse string coordinates to numbers\", () => {\r\n      const lat = parseFloat(\"14.5995\");\r\n      const lng = parseFloat(\"120.9842\");\r\n\r\n      expect(lat).toBe(14.5995);\r\n      expect(lng).toBe(120.9842);\r\n      expect(typeof lat).toBe(\"number\");\r\n      expect(typeof lng).toBe(\"number\");\r\n    });\r\n  });\r\n\r\n  describe(\"Department Array Handling\", () => {\r\n    it(\"should handle department_r as array\", () => {\r\n      const complaint = {\r\n        department_r: [\"DPWH\", \"DPS\"]\r\n      };\r\n\r\n      const departmentR = Array.isArray(complaint.department_r)\r\n        ? complaint.department_r\r\n        : (complaint.department_r ? [complaint.department_r] : []);\r\n\r\n      expect(departmentR).toEqual([\"DPWH\", \"DPS\"]);\r\n      expect(departmentR.length).toBe(2);\r\n    });\r\n\r\n    it(\"should convert string department_r to array\", () => {\r\n      const complaint = {\r\n        department_r: \"DPWH\"\r\n      };\r\n\r\n      const departmentR = Array.isArray(complaint.department_r)\r\n        ? complaint.department_r\r\n        : (complaint.department_r ? [complaint.department_r] : []);\r\n\r\n      expect(departmentR).toEqual([\"DPWH\"]);\r\n      expect(Array.isArray(departmentR)).toBe(true);\r\n    });\r\n\r\n    it(\"should handle null/undefined department_r\", () => {\r\n      const complaint = {\r\n        department_r: null\r\n      };\r\n\r\n      const departmentR = Array.isArray(complaint.department_r)\r\n        ? complaint.department_r\r\n        : (complaint.department_r ? [complaint.department_r] : []);\r\n\r\n      expect(departmentR).toEqual([]);\r\n    });\r\n  });\r\n\r\n  describe(\"Heatmap Data Transformation\", () => {\r\n    it(\"should transform complaint to heatmap format\", () => {\r\n      const mockComplaint = {\r\n        id: \"complaint-123\",\r\n        title: \"Pothole on Main Street\",\r\n        workflow_status: \"assigned\",\r\n        priority: \"high\",\r\n        latitude: \"14.5995\",\r\n        longitude: \"120.9842\",\r\n        location_text: \"Manila City Hall\",\r\n        submitted_at: \"2023-01-15T10:00:00Z\",\r\n        department_r: [\"DPWH\", \"DOT\"],\r\n        category: \"infrastructure-cat-id\",\r\n        subcategory: \"roads-subcat-id\"\r\n      };\r\n\r\n      // Simulate transformation logic\r\n      const lat = parseFloat(mockComplaint.latitude);\r\n      const lng = parseFloat(mockComplaint.longitude);\r\n      const departmentR = Array.isArray(mockComplaint.department_r)\r\n        ? mockComplaint.department_r\r\n        : (mockComplaint.department_r ? [mockComplaint.department_r] : []);\r\n\r\n      const transformed = {\r\n        id: mockComplaint.id,\r\n        title: mockComplaint.title,\r\n        status: mockComplaint.workflow_status,\r\n        priority: mockComplaint.priority || \"medium\",\r\n        lat,\r\n        lng,\r\n        location: mockComplaint.location_text || \"\",\r\n        submittedAt: mockComplaint.submitted_at,\r\n        department: departmentR.length > 0 ? departmentR[0] : \"Unknown\",\r\n        departments: departmentR,\r\n        secondaryDepartments: departmentR.length > 1 ? departmentR.slice(1) : [],\r\n        type: mockComplaint.category || \"General\",\r\n        category: mockComplaint.category,\r\n        subcategory: mockComplaint.subcategory\r\n      };\r\n\r\n      expect(transformed.lat).toBe(14.5995);\r\n      expect(transformed.lng).toBe(120.9842);\r\n      expect(transformed.department).toBe(\"DPWH\");\r\n      expect(transformed.departments).toEqual([\"DPWH\", \"DOT\"]);\r\n      expect(transformed.secondaryDepartments).toEqual([\"DOT\"]);\r\n      expect(transformed.status).toBe(\"assigned\");\r\n    });\r\n\r\n    it(\"should filter out complaints with invalid coordinates\", () => {\r\n      const mockComplaints = [\r\n        { id: \"1\", latitude: 14.5, longitude: 120.9, title: \"Valid 1\" },\r\n        { id: \"2\", latitude: null, longitude: 120.9, title: \"Invalid - null lat\" },\r\n        { id: \"3\", latitude: 14.5, longitude: undefined, title: \"Invalid - undefined lng\" },\r\n        { id: \"4\", latitude: \"invalid\", longitude: 120.9, title: \"Invalid - string lat\" },\r\n        { id: \"5\", latitude: 14.6, longitude: 121.0, title: \"Valid 2\" }\r\n      ];\r\n\r\n      const validComplaints = mockComplaints\r\n        .map(complaint => {\r\n          const lat = parseFloat(complaint.latitude);\r\n          const lng = parseFloat(complaint.longitude);\r\n\r\n          if (isNaN(lat) || isNaN(lng) || !isFinite(lat) || !isFinite(lng)) {\r\n            return null;\r\n          }\r\n\r\n          return { ...complaint, lat, lng };\r\n        })\r\n        .filter(Boolean);\r\n\r\n      expect(validComplaints).toHaveLength(2);\r\n      expect(validComplaints[0].id).toBe(\"1\");\r\n      expect(validComplaints[1].id).toBe(\"5\");\r\n    });\r\n  });\r\n\r\n  describe(\"Status Filtering\", () => {\r\n    it(\"should filter by single status\", () => {\r\n      const complaints = [\r\n        { id: \"1\", workflow_status: \"new\" },\r\n        { id: \"2\", workflow_status: \"assigned\" },\r\n        { id: \"3\", workflow_status: \"new\" },\r\n        { id: \"4\", workflow_status: \"completed\" }\r\n      ];\r\n\r\n      const status = \"new\";\r\n      const filtered = complaints.filter(c => c.workflow_status === status);\r\n\r\n      expect(filtered).toHaveLength(2);\r\n      expect(filtered.map(c => c.id)).toEqual([\"1\", \"3\"]);\r\n    });\r\n\r\n    it(\"should filter by multiple statuses\", () => {\r\n      const complaints = [\r\n        { id: \"1\", workflow_status: \"new\" },\r\n        { id: \"2\", workflow_status: \"assigned\" },\r\n        { id: \"3\", workflow_status: \"in_progress\" },\r\n        { id: \"4\", workflow_status: \"completed\" }\r\n      ];\r\n\r\n      const statuses = [\"new\", \"assigned\"];\r\n      const filtered = complaints.filter(c => statuses.includes(c.workflow_status));\r\n\r\n      expect(filtered).toHaveLength(2);\r\n      expect(filtered.map(c => c.id)).toEqual([\"1\", \"2\"]);\r\n    });\r\n  });\r\n\r\n  describe(\"Department Filtering\", () => {\r\n    it(\"should filter by department code\", () => {\r\n      const complaints = [\r\n        { id: \"1\", department_r: [\"DPWH\"] },\r\n        { id: \"2\", department_r: [\"DPS\"] },\r\n        { id: \"3\", department_r: [\"DPWH\", \"DOT\"] },\r\n        { id: \"4\", department_r: [\"DOH\"] }\r\n      ];\r\n\r\n      const department = \"DPWH\";\r\n      const filtered = complaints.filter(c =>\r\n        Array.isArray(c.department_r) && c.department_r.includes(department)\r\n      );\r\n\r\n      expect(filtered).toHaveLength(2);\r\n      expect(filtered.map(c => c.id)).toEqual([\"1\", \"3\"]);\r\n    });\r\n  });\r\n\r\n  describe(\"Priority Handling\", () => {\r\n    it(\"should default to medium priority when not specified\", () => {\r\n      const complaint = {\r\n        id: \"1\",\r\n        title: \"Test\"\r\n      };\r\n\r\n      const priority = complaint.priority || \"medium\";\r\n      expect(priority).toBe(\"medium\");\r\n    });\r\n\r\n    it(\"should preserve explicit priority\", () => {\r\n      const complaint = {\r\n        id: \"1\",\r\n        title: \"Test\",\r\n        priority: \"high\"\r\n      };\r\n\r\n      const priority = complaint.priority || \"medium\";\r\n      expect(priority).toBe(\"high\");\r\n    });\r\n  });\r\n});\r\n","usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\link-generator.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\notification.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\notification_scenarios.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\role-change.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\user-deletion.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\unit\\validation.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\utils\\supabaseMock.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\User\\Documents\\Projects\\acads\\CitizenLink\\tests\\utils\\testHelpers.js","messages":[],"suppressedMessages":[{"ruleId":"security/detect-non-literal-regexp","severity":2,"message":"Found non-literal argument to RegExp Constructor","line":105,"column":36,"nodeType":"NewExpression","endLine":105,"endColumn":72,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"indent","replacedBy":[]},{"ruleId":"quotes","replacedBy":[]},{"ruleId":"semi","replacedBy":[]},{"ruleId":"no-multiple-empty-lines","replacedBy":[]},{"ruleId":"no-trailing-spaces","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-floating-decimal","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]}]