<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Heatmap - Complaint Visualization</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Leaflet Heat CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.css" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html, body {
        height: 100%;
        overflow: hidden;
      }

      /* Ensure sidebar styles are not overridden */
      #sidebar {
        display: flex !important;
        flex-direction: column !important;
        background: var(--sidebar-bg, #ffffff) !important;
        color: var(--sidebar-text, #1f2937) !important;
      }

      #sidebar * {
        box-sizing: border-box;
      }

      #map {
        width: 100%;
        height: 100vh;
      }

      /* Control Panel Styles */
      .map-controls-panel {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 320px;
        max-height: calc(100vh - 40px);
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 20px;
        z-index: 1000;
        overflow-y: auto;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      }

      .controls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
      }

      .controls-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
      }

      .btn-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
      }

      .btn-close:hover {
        background: #f3f4f6;
        color: #1f2937;
      }

      .control-group {
        margin-bottom: 16px;
      }

      .control-group label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 6px;
      }

      .control-group select,
      .control-group input[type="range"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 13px;
      }

      .control-group input[type="range"] {
        padding: 0;
        height: 6px;
      }

      .slider-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .slider-container input[type="range"] {
        flex: 1;
      }

      .slider-value {
        font-size: 12px;
        font-weight: 600;
        color: #667eea;
        min-width: 40px;
      }

      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .btn-primary,
      .btn-secondary {
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
      }

      .stats-display {
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        font-size: 12px;
      }

      .stats-display p {
        margin: 4px 0;
        color: #374151;
      }

      .stats-display span {
        font-weight: 600;
        color: #667eea;
      }

      .toggle-controls-btn {
        position: absolute;
        top: 20px; /* Default position when panel is hidden */
        right: 20px;
        width: 48px;
        height: 48px;
        background: white;
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        font-size: 20px;
        cursor: pointer;
        z-index: 999; /* Below control panel to avoid animation interference */
        display: flex;
        align-items: center;
        justify-content: center;
        transition: top 0.3s ease;
      }

      .toggle-controls-btn:hover {
        background: #f9fafb;
      }

      .reset-view-btn {
        position: relative !important;
        left: auto !important;
        top: auto !important;
        bottom: auto !important;
        width: 34px !important;
        height: 34px !important;
        background: white !important;
        border: 2px solid rgba(0, 0, 0, 0.2) !important;
        border-radius: 4px !important;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.4) !important;
        font-size: 18px;
        cursor: pointer;
        z-index: 1 !important;
        display: flex !important;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
        margin: 0 !important;
        flex-shrink: 0 !important;
      }

      .reset-view-btn:hover {
        background: #f9fafb;
        transform: scale(1.05);
      }

      .map-legend {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        font-size: 13px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        max-width: 240px;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
      }

      .map-legend.collapsed {
        max-height: 50px;
        padding: 0;
      }

      .map-legend.expanded {
        max-height: 500px;
        padding: 14px;
      }

      .legend-header {
        font-size: 15px;
        font-weight: 600;
        padding: 14px;
        cursor: pointer;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #1f2937;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
        transition: background 0.2s ease;
      }

      .legend-header:hover {
        background: #f3f4f6;
      }

      .legend-toggle-icon {
        transition: transform 0.3s ease;
        font-size: 12px;
        color: #6b7280;
        margin-left: 10px;
      }

      .map-legend.expanded .legend-toggle-icon {
        transform: rotate(180deg);
      }

      .legend-content {
        padding: 14px;
        max-height: 400px;
        overflow-y: auto;
      }

      .map-legend.collapsed .legend-content {
        display: none;
      }

      .legend-section {
        margin-bottom: 12px;
      }

      .legend-section:last-child {
        margin-bottom: 0;
      }

      .legend-title {
        font-size: 12px;
        font-weight: 600;
        color: #4b5563;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 6px;
        font-size: 13px;
        color: #374151;
        line-height: 1.4;
      }

      .legend-item:last-child {
        margin-bottom: 0;
      }

      .legend-marker {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        flex-shrink: 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }

      .map-controls-panel.hidden {
        display: none;
      }

      /* Custom controls container - horizontal row */
      .map-custom-controls-row {
        position: fixed !important;
        top: 10px !important;
        left: 10px !important;
        display: flex !important;
        flex-direction: row !important;
        gap: 10px !important;
        z-index: 1200 !important;
        align-items: center !important;
        flex-wrap: nowrap !important;
      }

      /* Move Leaflet controls down to avoid overlapping sidebar button */
      /* Zoom controls and layer control (tile changer) stay together below the row */
      /* Position closer to the menu/reset row to reduce gap */
      .leaflet-top.leaflet-left {
        top: 54px !important; /* Reduced from 70px to bring zoom controls closer to row above */
        left: 10px !important;
      }
      
      /* Ensure Leaflet controls have consistent width and spacing */
      /* Remove top margin from first control (zoom) to reduce gap above it */
      .leaflet-top.leaflet-left .leaflet-control {
        margin: 10px 0 0 0 !important;
      }
      
      /* Remove top margin from zoom control specifically to reduce gap above it */
      .leaflet-top.leaflet-left .leaflet-control-zoom {
        margin-top: 0 !important;
      }
      
      /* Ensure first control (zoom) has no top margin */
      .leaflet-top.leaflet-left .leaflet-control:first-child {
        margin-top: 0 !important;
      }

      /* Menu toggle button - in horizontal row */
      .menu-toggle-btn {
        position: relative !important;
        top: auto !important;
        left: auto !important;
        width: 34px !important;
        height: 34px !important;
        background: white !important;
        border: 2px solid rgba(0, 0, 0, 0.2) !important;
        border-radius: 4px !important;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.4) !important;
        font-size: 20px !important;
        cursor: pointer !important;
        z-index: 1 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
        margin: 0 !important;
        flex-shrink: 0 !important;
      }
      

      .menu-toggle-btn:hover {
        background: #f9fafb !important;
        border-color: #667eea !important;
      }
    </style>
    
    <!-- Sidebar CSS - Load after inline styles to ensure proper cascade -->
    <link rel="stylesheet" href="/css/components/sidebar.css" />
  </head>
  <body>
    <!-- Sidebar -->
    <div id="sidebar" class="collapsible"></div>
    
    <!-- Custom Controls Row (Menu, Reset View) -->
    <div class="map-custom-controls-row">
      <!-- Menu Toggle Button (for sidebar) -->
      <button id="menu-toggle" class="menu-toggle-btn" title="Toggle Sidebar">‚ò∞</button>
      
      <!-- Reset View Button -->
      <button id="reset-view-btn" class="reset-view-btn" title="Reset View to Default">üè†</button>
    </div>
    
    <!-- Toggle Controls Button -->
    <button id="toggle-controls-btn" class="toggle-controls-btn" title="Toggle Controls">‚öôÔ∏è</button>

    <!-- Map Legend -->
    <div id="map-legend" class="map-legend collapsed">
      <div class="legend-header" id="legend-toggle">
        <strong>Legend</strong>
        <span class="legend-toggle-icon">‚ñº</span>
      </div>
      <div class="legend-content">
        <div class="legend-section">
        <div class="legend-title">Status</div>
        <div class="legend-item">
          <div class="legend-marker" style="background-color: #6c757d; border: 2px solid #ffffff;"></div>
          <span>New / Pending</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker" style="background-color: #ffc107; border: 2px solid #ffffff;"></div>
          <span>Assigned</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker" style="background-color: #17a2b8; border: 2px solid #ffffff;"></div>
          <span>In Progress</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker" style="background-color: #fd7e14; border: 2px solid #ffffff;"></div>
          <span>Pending Approval</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker" style="background-color: #28a745; border: 2px solid #ffffff;"></div>
          <span>Completed / Confirmed</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker" style="background-color: #dc3545; border: 2px solid #ffffff;"></div>
          <span>Rejected / Disputed</span>
        </div>
      </div>
      <div class="legend-section">
        <div class="legend-title">Priority (Border)</div>
        <div class="legend-item">
          <div class="legend-marker" style="background-color: #6c757d; border: 3px solid #28a745;"></div>
          <span>Low</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker" style="background-color: #6c757d; border: 3px solid #ffc107;"></div>
          <span>Medium</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker" style="background-color: #6c757d; border: 3px solid #fd7e14;"></div>
          <span>High</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker" style="background-color: #6c757d; border: 3px solid #dc3545;"></div>
          <span>Urgent</span>
        </div>
      </div>
      </div>
    </div>

    <!-- Control Panel -->
    <div id="map-controls-panel" class="map-controls-panel hidden">
      <div class="controls-header">
        <h3>üéõÔ∏è Heatmap Controls</h3>
        <button class="btn-close" id="close-controls-btn">√ó</button>
      </div>
      <div class="controls-content">
        <div class="control-group">
          <button id="toggle-heatmap-btn" class="btn-secondary" style="width: 100%;">Toggle Heatmap</button>
          <button id="toggle-markers-btn" class="btn-secondary" style="width: 100%; margin-top: 8px;">Toggle Markers</button>
        </div>
        
        <!-- Status Filter -->
        <div class="control-group">
          <label>Status Filter:</label>
          <div id="status-filter-group" style="max-height: 200px; overflow-y: auto; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; background: #fafafa;">
            <div style="margin-bottom: 12px;">
              <div style="font-weight: 600; font-size: 12px; color: #495057; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Standard Status</div>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="new" id="status-new">New</label>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="pending" id="status-pending">Pending</label>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="in progress" id="status-in-progress">In Progress</label>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="resolved" id="status-resolved">Resolved</label>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="completed" id="status-completed">Completed</label>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="closed" id="status-closed">Closed</label>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="rejected" id="status-rejected">Rejected</label>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="cancelled" id="status-cancelled">Cancelled</label>
            </div>
            <div style="margin-bottom: 12px;">
              <div style="font-weight: 600; font-size: 12px; color: #495057; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Workflow Status</div>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="assigned" id="status-assigned">Assigned</label>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="in_progress" id="status-in-progress-wf">In Progress (Workflow)</label>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="pending_approval" id="status-pending-approval">Pending Approval</label>
            </div>
            <div>
              <div style="font-weight: 600; font-size: 12px; color: #495057; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Confirmation Status</div>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="waiting_for_responders" id="status-waiting-responders">Waiting for Responders</label>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="waiting_for_complainant" id="status-waiting-complainant">Waiting for Complainant</label>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="confirmed" id="status-confirmed">Confirmed</label>
              <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; padding: 2px 0; cursor: pointer;"><input type="checkbox" class="status-checkbox" value="disputed" id="status-disputed">Disputed</label>
            </div>
          </div>
        </div>

        <!-- Category Filter -->
        <div class="control-group">
          <label>Category Filter:</label>
          <div id="category-filter-group" style="max-height: 150px; overflow-y: auto; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; background: #fafafa;">
            <div id="category-loading" style="padding: 16px; text-align: center; color: #6c757d; font-size: 13px;">Loading categories...</div>
          </div>
        </div>

        <!-- Office Filter -->
        <div class="control-group">
          <label>Office Filter:</label>
          <div id="department-filter-group" style="max-height: 150px; overflow-y: auto; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; background: #fafafa;">
            <div id="department-loading" style="padding: 16px; text-align: center; color: #6c757d; font-size: 13px;">Loading departments...</div>
          </div>
        </div>

        <!-- Date Range Filter -->
        <div class="control-group">
          <label>Date Range:</label>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <input type="date" id="date-range-start" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; width: 100%; box-sizing: border-box;" placeholder="Start Date">
            <input type="date" id="date-range-end" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; width: 100%; box-sizing: border-box;" placeholder="End Date">
            <button id="clear-date-range" style="padding: 6px 12px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s ease; width: 100%;">Clear Date Range</button>
          </div>
        </div>

        <!-- Options -->
        <div class="control-group">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="include-resolved" checked style="width: 18px; height: 18px; cursor: pointer;">
            Include Resolved Complaints
          </label>
        </div>

        <div class="control-group">
          <label>Heatmap Intensity:</label>
          <div class="slider-container">
            <input type="range" id="heatmap-intensity" min="0.1" max="2.0" step="0.1" value="1.0">
            <span class="slider-value" id="heatmap-intensity-value">1.0</span>
          </div>
        </div>
        <div class="control-group">
          <label>Zoom Threshold:</label>
          <div class="slider-container">
            <input type="range" id="zoom-threshold" min="10" max="18" step="1" value="11">
            <span class="slider-value" id="zoom-threshold-value">11</span>
          </div>
          <small style="font-size: 11px; color: #6b7280;">Show markers at this zoom level</small>
        </div>
        <div class="control-group">
          <div class="action-buttons">
            <button id="reset-filters-btn" class="btn-primary">Reset Filters</button>
            <button id="fit-bounds-btn" class="btn-secondary">Fit to All Markers</button>
          </div>
        </div>
        <div class="control-group">
          <label>Statistics:</label>
          <div class="stats-display">
            <p>Total Complaints: <span id="total-complaints-stat">0</span></p>
            <p>Visible Markers: <span id="visible-markers-stat">0</span></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="/js/pages/heatmap-leaflet-check.js"></script>
    <script src="../../js/components/map/map-generator.js"></script>
    <script src="../../js/components/map/dbscan.js"></script>
    <script src="../../js/components/map/heatmapVisualization.js"></script>
    <script src="../../js/components/map/heatmapController.js"></script>
    <script type="module" src="../../js/components/sidebar.js"></script>
    <script type="module" src="../../js/auth/authChecker.js"></script>
    <script src="/js/pages/heatmap-init.js"></script>
    <script type="module" src="../../js/components/map/boundaryGenerator.js"></script>
  </body>
</html>
