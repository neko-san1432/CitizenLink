<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:ital,wght@0,300..800;1,300..800&display=swap"
    rel="stylesheet" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <title>File Complaint</title>
  <link rel="stylesheet" href="../../css/style.css" />
  <link rel="stylesheet" href="../../css/toast.css" />
  <link rel="stylesheet" href="../../css/components/sidebar.css" />
  <link rel="stylesheet" href="../../css/app.css" />
  <link rel="stylesheet" href="../../css/header-redesign.css" />
  <link rel="stylesheet" href="../../css/complaint-form.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>

<body>
  <!-- Premium Background (handled by CSS) -->

  <div class="app-container">
    <!-- Header -->
    <div class="header-container"></div>

    <!-- Sidebar -->
    <div id="sidebar" class="collapsible"></div>

    <!-- Main Content -->
    <div id="app" class="collapsible main-content-wrapper">
      <div class="complaint-wizard-container">
        <!-- Page Header -->
        <div class="page-header">
          <h1 class="page-title">File a Complaint</h1>
          <p class="page-subtitle">
            Follow the steps below to submit your report.
          </p>
        </div>

        <!-- Wizard Stepper -->
        <div class="wizard-stepper">
          <div class="progress-fill"></div>

          <div class="step-indicator active">
            <div class="step-number">1</div>
            <div class="step-label">Details</div>
          </div>
          <div class="step-indicator">
            <div class="step-number">2</div>
            <div class="step-label">Location</div>
          </div>
          <div class="step-indicator">
            <div class="step-number">3</div>
            <div class="step-label">Basic Info</div>
          </div>
          <div class="step-indicator">
            <div class="step-number">4</div>
            <div class="step-label">Review</div>
          </div>
        </div>

        <form id="complaintForm" class="complaint-form wizard-mode">
          <!-- STEP 1: Details (Formerly Step 3) -->
          <div id="step-details" class="form-step active">
            <div class="form-section card-glass">
              <div class="section-header">
                <div class="section-icon">üìé</div>
                <h3>Details & Evidence</h3>
              </div>

              <div class="form-group required-field">
                <div style="
                          display: flex;
                          justify-content: space-between;
                          align-items: center;
                          margin-bottom: 0.5rem;
                        ">
                  <label for="description" style="margin-bottom: 0">Description <span class="required">*</span></label>
                  <span class="input-hint" style="
                            font-size: 0.75rem;
                            color: #6b7280;
                            font-style: italic;
                            margin-left: 8px;
                          ">(For Taglish/Bisayish, select the main language
                    used)</span>

                  <div class="voice-controls" style="display: flex; gap: 0.5rem; align-items: center">
                    <select id="voiceLanguage" class="premium-select-small" style="
                              padding: 4px 8px;
                              border-radius: 6px;
                              border: 1px solid rgba(255, 255, 255, 0.2);
                              background: rgba(255, 255, 255, 0.05);
                              color: inherit;
                              font-size: 0.85rem;
                            ">
                      <option value="en-US">English</option>
                      <option value="ceb-PH">Bisaya (Cebuano)</option>
                      <option value="tl-PH">Tagalog</option>
                    </select>
                    <button type="button" id="startSpeech" class="btn-mic" style="
                              border: none;
                              background: rgba(255, 255, 255, 0.1);
                              padding: 6px 10px;
                              border-radius: 50%;
                              cursor: pointer;
                              transition: all 0.3s ease;
                              color: inherit;
                              display: flex;
                              align-items: center;
                              justify-content: center;
                            " title="Start Speaking">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                      </svg>
                    </button>
                  </div>
                </div>
                <textarea id="description" name="description" class="premium-textarea"
                  placeholder="Please describe the issue in detail..." rows="6" required></textarea>
              </div>

              <div class="form-group">
                <label>Evidence (Optional)</label>
                <div class="file-upload-container premium-dropzone">
                  <div class="file-drop-zone" id="fileDropZone">
                    <div class="drop-zone-content">
                      <div class="upload-icon-animated">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                          stroke-width="2">
                          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                          <polyline points="17 8 12 3 7 8"></polyline>
                          <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                      </div>
                      <p class="upload-text">
                        <strong>Click to upload</strong> or drag and drop
                      </p>
                      <p class="file-types">
                        Images, Audio, Video (Max 5 files)
                      </p>
                      <input type="file" id="evidenceFiles" name="evidenceFiles" multiple
                        accept="image/*,audio/*,video/*" style="display: none" />
                    </div>
                  </div>
                  <div class="file-preview" id="filePreview"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- STEP 2: Location -->
          <div id="step-location" class="form-step">
            <div class="form-section card-glass sticky-section">
              <div class="section-header">
                <div class="section-icon">üìç</div>
                <h3>Location</h3>
              </div>

              <div class="location-wrapper">
                <div class="map-wrapper">
                  <div id="complaint-map" class="premium-map"></div>
                  <input type="hidden" id="latitude" name="latitude" />
                  <input type="hidden" id="longitude" name="longitude" />
                </div>

                <div class="form-group location-input-group required-field">
                  <label for="location">Pinned Address <span class="required">*</span></label>
                  <div class="input-with-icon">
                    <span class="input-icon">üó∫Ô∏è</span>
                    <input type="text" id="location" name="location" class="premium-input"
                      placeholder="Pin location on map" readonly required />
                  </div>
                  <small class="form-hint">Move the map pin to update address.</small>
                </div>
                <!-- Duplicate Warning Container gets appended here by JS -->
              </div>
            </div>
          </div>

          <!-- STEP 3: Basic Information (Formerly Step 1) -->
          <div id="step-basic" class="form-step">
            <div class="form-section card-glass">
              <div class="section-header">
                <div class="section-icon">üìù</div>
                <h3>Basic Information</h3>
              </div>

              <div class="form-grid">
                <input type="hidden" id="complaintTitle" name="complaintTitle" />

                <div class="form-group required-field">
                  <label for="complaintCategory">Category <span class="required">*</span></label>
                  <div class="select-wrapper">
                    <select id="complaintCategory" name="complaintCategory" class="premium-select" required>
                      <option value="">Select Category</option>
                    </select>
                  </div>
                </div>

                <div class="form-group required-field">
                  <label for="complaintSubcategory">Subcategory <span class="required">*</span></label>
                  <div class="select-wrapper">
                    <select id="complaintSubcategory" name="complaintSubcategory" class="premium-select" required>
                      <option value="">Select Subcategory</option>
                    </select>
                  </div>
                </div>

                <div class="form-group full-width required-field">
                  <label for="urgencyLevel">Urgency Level <span class="required">*</span></label>
                  <div class="urgency-container">
                    <div class="select-wrapper">
                      <select id="urgencyLevel" name="urgencyLevel" class="premium-select urgency-select" required>
                        <option value="low">Low - Routine issue</option>
                        <option value="medium">
                          Medium - Requires attention
                        </option>
                        <option value="high">High - Serious issue</option>
                        <option value="urgent">
                          Urgent - Critical situation
                        </option>
                      </select>
                    </div>
                    <small class="form-hint">How critical is this issue?</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- STEP 4: Review & Departments -->
          <div id="step-review" class="form-step">
            <div class="form-section card-glass">
              <div class="section-header">
                <div class="section-icon">üè¢</div>
                <h3>Relevant Departments</h3>
              </div>

              <div class="department-selection-info">
                <p>
                  Select specific offices if known. Otherwise, we will route
                  it automatically.
                </p>
              </div>

              <div class="form-group">
                <div id="departmentCheckboxes" class="department-grid-compact">
                  <div class="loading-state">
                    <div class="spinner"></div>
                    <span>Loading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
      </div>

      <!-- Wizard Actions -->

      </form>
    </div>
  </div>
  </div>

  </div>

  <!-- Wizard Actions (Moved outside app-container to ensure correct fixed positioning) -->
  <div class="form-actions-sticky wizard-navigation">
    <button type="button" id="btn-back" class="btn-back">
      Back
    </button>

    <div class="submit-wrapper">
      <button type="button" id="btn-next" class="btn-submit-premium wizard-next">
        <span>Next Step</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>

      <button type="submit" id="btn-submit-final" form="complaintForm" class="btn-submit-premium"
        style="display: none;">
        <span>Submit Complaint</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="5" y1="12" x2="19" y2="12"></line>
          <polyline points="12 5 19 12 12 19"></polyline>
        </svg>
      </button>
    </div>
  </div>

  <div id="toast-container" class="toast-container"></div>

  <!-- Core Scripts -->
  <script type="module" src="/js/components/toast.js"></script>
  <script type="module" src="/js/components/header.js"></script>
  <script type="module" src="/js/components/sidebar.js"></script>
  <script type="module" src="/js/auth/authChecker.js"></script>

  <!-- Citizen-Only Access Check -->
  <script type="module" src="/js/pages/citizen-file-complaint-access.js"></script>

  <!-- Map Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/js/components/map/complaintLocationPicker.js"></script>

  <!-- Complaint Form Scripts (loaded last) -->
  <script type="module" src="/js/components/form/complaintFormHierarchical.js"></script>

  <!-- Wizard Controller -->
  <script type="module">
    import { initProgressiveForm } from "/js/components/form/progressiveForm.js";

    document.addEventListener("DOMContentLoaded", () => {
      // Need a slight delay to ensure other dynamic elements (map) are ready
      // though map init happens separately.
      setTimeout(initProgressiveForm, 100);
    });
  </script>
</body>

</html>