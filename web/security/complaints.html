<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Complaints Management - Government portal for reviewing, assigning, and resolving citizen complaints. Filter by status, type, urgency, and date for efficient complaint handling.">
    <meta name="permissions-policy" content="geolocation=(), camera=(), microphone=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=(), ambient-light-sensor=(), autoplay=(), encrypted-media=(), fullscreen=(), picture-in-picture=(), sync-xhr=()">
    <title>Complaints Management - CitizenLink</title>
    <link rel="stylesheet" href="/css/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/additional-styles.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar will be loaded dynamically by sidebar-loader.js -->

        <!-- Sidebar overlay for mobile -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <div class="main-content">
            <header class="dashboard-header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebar-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="brand-logo">
                        <a href="/lgu/dashboard" class="logo-link">
                            <i class="fas fa-shield-halved text-primary me-2"></i>
                            <span class="brand-text">CitizenLink</span>
                        </a>
                    </div>
                </div>
                <div class="header-right">
                    <span class="welcome-text">LGU Admin Portal</span>
                </div>
            </header>

            <main class="dashboard-main">
                <div class="page-header">
                    <div>
                        <h2>Complaints Management</h2>
                        <p class="text-muted">Review, assign, and resolve citizen complaints.</p>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="search-box">
                        <input type="text" id="search-complaints" placeholder="Search complaints...">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="filter-options">
                        <select id="status-filter">
                            <option value="all">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                        </select>
                        <select id="type-filter">
                            <option value="all">All Types</option>
                            <option value="infrastructure">Infrastructure</option>
                            <option value="public_safety">Public Safety</option>
                            <option value="sanitation">Sanitation</option>
                            <option value="utilities">Utilities</option>
                            <option value="noise">Noise</option>
                            <option value="other">Other</option>
                        </select>
                        
                        <select id="subcategory-filter">
                            <option value="all">All Subcategories</option>
                            <option value="Road Damage">Road Damage</option>
                            <option value="Street Lighting">Street Lighting</option>
                            <option value="Sidewalk Problems">Sidewalk Problems</option>
                            <option value="Garbage Collection">Garbage Collection</option>
                            <option value="Illegal Dumping">Illegal Dumping</option>
                            <option value="Construction Noise">Construction Noise</option>
                            <option value="Water Supply">Water Supply</option>
                            <option value="Suspicious Activity">Suspicious Activity</option>
                        </select>

                        <select id="sort-filter">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="status">Status (Pending → Resolved)</option>
                            <option value="type">Type (A–Z)</option>
                            <option value="title-asc">Title (A–Z)</option>
                            <option value="title-desc">Title (Z–A)</option>
                        </select>

                        <select id="date-filter">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                        </select>
                        
                        <button id="clear-filters" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                </div>

                <div class="complaints-table-container">
                    <table class="complaints-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Date</th>

                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="complaints-table-body">
                            <!-- Complaints will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <div id="no-complaints" class="empty-state" style="display: none;">
                    <div class="empty-state-content">
                        <div class="empty-state-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <h3>No Complaints Found</h3>
                        <p class="empty-state-description">Great news! There are no complaints matching your current filters.</p>
                        <div class="empty-state-actions">
                            <button class="btn btn-outline-primary" id="clear-filters">
                                <i class="fas fa-filter"></i>
                                Clear All Filters
                            </button>
                            <button class="btn btn-primary" id="refresh-complaints">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                        </div>
                        <div class="empty-state-tips">
                            <h5>Quick Tips:</h5>
                            <ul>
                                <li>Try adjusting your search filters</li>
                                <li>Check if you're in the right time period</li>
                                <li>Verify your status and type selections</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Debug section for sidebar testing -->
                <div id="debug-sidebar" style="display: block; background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #dee2e6;">
                    <h5>Sidebar Debug Info:</h5>
                    <p>If sidebar is not working, try these:</p>
                    <button class="btn btn-sm btn-outline-secondary" id="test-sidebar-btn">Test Sidebar Loader</button>
                    <button class="btn btn-sm btn-outline-secondary" id="manual-load-sidebar-btn">Manual Load Sidebar</button>
                    <button class="btn btn-sm btn-outline-secondary" id="check-user-data-btn">Check User Data</button>
                    <div id="debug-output" style="margin-top: 1rem; font-family: monospace; font-size: 12px;"></div>
                </div>

                <div id="pagination" class="pagination">
                    <!-- Pagination will be added here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Complaint Detail Modal -->
    <div id="complaint-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050;">
        <!-- Light backdrop -->
        <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.2); z-index: 1040;"></div>
        
        <!-- Modal content -->
        <div class="modal-dialog" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); margin: 0; max-width: 800px; width: 90%; z-index: 1055; background-color: transparent;">
            <div class="modal-content" style="background-color: transparent; color: #333333; border: 3px solid #0d6efd; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5); border-radius: 16px; max-height: 90vh; overflow: hidden;">
                <div class="modal-header" style="background-color: #0d6efd; color: #ffffff; border-radius: 13px 13px 0 0; padding: 1.5rem; border-bottom: none; margin: -3px -3px 0 -3px;">
                    <h3 id="modal-title">Complaint Details</h3>
                    <button class="modal-close" style="background: none; border: none; color: #ffffff; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                
                <div class="modal-body" style="background-color: #ffffff; color: #333333; overflow-y: auto; max-height: 60vh; padding: 2rem;">
                    <div class="detail-section">
                        <h4>Location Map</h4>
                        <div id="complaint-map" style="width: 100%; height: 300px; border: 1px solid #ddd; border-radius: 8px; background-color: #f8f9fa; position: relative; overflow: hidden;">
                            <div id="map-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; font-size: 14px; z-index: 1000;">
                                Loading map...
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            <strong>Coordinates:</strong> <span id="map-coordinates">Loading...</span><br>
                            <strong>Boundary Scope:</strong> <span id="boundary-scope">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="complaint-detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Status:</span>
                            <span id="detail-status" class="status-badge">Pending</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Complaint ID:</span>
                            <span id="detail-id">CP12345</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Date Submitted:</span>
                            <span id="detail-date">January 1, 2025</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Type:</span>
                            <span id="detail-type">Infrastructure</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Subcategory:</span>
                            <span id="detail-subcategory">Road Damage</span>
                        </div>

                        <div class="detail-item">
                            <span class="detail-label">Location:</span>
                            <span id="detail-location">123 Main Street</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Submitted By:</span>
                            <span id="detail-submitter">John Citizen</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Description</h4>
                        <p id="detail-description"></p>
                    </div>
                    
                    <div class="detail-section" id="photo-section">
                        <h4>Photo</h4>
                        <div id="detail-photo" class="complaint-photo"></div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Assignment</h4>
                        <div class="assignment-form">
                            <div class="form-group">
                                <label for="assigned-unit">Assign to Department:</label>
                                <select id="assigned-unit" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">All Departments</option>
                                    <option value="admin">City Hall (Administration)</option>
                                    <option value="pnp">Police Department (PNP)</option>
                                    <option value="bfp">Fire Department (BFP)</option>
                                    <option value="dpwh">Public Works (DPWH)</option>
                                    <option value="wst">Water, Sanitation & Transportation (WST)</option>
                                    <option value="hlt">Health, Local & Tourism (HLT)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="complaint-status">Update Status:</label>
                                <select id="complaint-status" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="pending">Pending</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="resolved">Resolved</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="admin-notes">Admin Notes:</label>
                                <textarea id="admin-notes" rows="3" placeholder="Add notes about this complaint..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Timeline</h4>
                        <div id="complaint-timeline" class="timeline">
                            <!-- Timeline will be added here -->
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer" style="background-color: #ffffff; color: #333333; padding: 1.5rem; border-top: 1px solid #e9ecef; border-radius: 0 0 13px 13px; margin: 0 -3px -3px -3px;">
                    <button class="btn btn-outline modal-close-btn">Cancel</button>
                    <button class="btn btn-primary" id="save-complaint-btn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    
    <!-- Leaflet CSS and JS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="../js/supabase-bridge.js"></script>
    <script src="../js/supabase-init.js"></script>
    <script src="../js/data-management.js"></script>
    <script src="../js/auth-check.js"></script>
    <script src="../js/user-utils.js"></script>
    <script src="../js/sidebar-loader.js"></script>
    <script src="../js/lgu-complaints.js"></script>
    <script src="../js/security-complaints-bindings.js"></script>
</body>
</html>