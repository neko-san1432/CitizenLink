<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Bridge Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h1>🔗 Supabase Bridge Test</h1>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Bridge Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="bridge-status">Checking...</div>
                        <div id="credentials-info" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2" onclick="testBridge()">
                            Test Bridge
                        </button>
                        <button class="btn btn-success mb-2" onclick="testSupabase()">
                            Test Supabase Client
                        </button>
                        <button class="btn btn-info" onclick="showCredentials()">
                            Show Credentials
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Console Output</h5>
                    </div>
                    <div class="card-body">
                        <div id="console-output"
                            style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; max-height: 300px; overflow-y: auto;">
                            Waiting for bridge to initialize...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load the Supabase Bridge first -->
    <script src="./js/supabase-bridge.js"></script>
    <!-- Load the shared Supabase manager -->
    <script src="./js/supabase-init.js"></script>

    <script>
        
        // Global functions (accessible to onclick handlers)
        async function testBridge() {
            
            log('🧪 Testing bridge...');
 
            // Wait for bridge to be ready
            if (!await waitForBridge()) {
                log('❌ Bridge never became ready');
                return false;
            }
            
            try {
                if (window.supabaseBridge.isReady()) {
                    log('✅ Bridge is ready!');
                    const supabase = window.supabaseBridge.getClient();
                    log('✅ Supabase client obtained');
                    return true;
                } else {
                    log('❌ Bridge is not ready yet');
                    return false;
                }
            } catch (error) {
                log('❌ Bridge test failed: ' + error.message);
                return false;
            }
        }
        
        async function testSupabase() {
            log('🔑 Testing Supabase client...');
            
            // Wait for bridge to be ready
            if (!await waitForBridge()) {
                log('❌ Bridge never became ready');
                return;
            }
            
            try {
                const supabase = window.supabaseBridge.getClient();
                log('✅ Got Supabase client');
                
                // Test a simple query
                const { data, error } = await supabase
                    .from('complaints')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    log('⚠️ Supabase query result: ' + error.message);
                } else {
                    log('✅ Supabase query successful');
                }
                
            } catch (error) {
                log('❌ Supabase test failed: ' + error.message);
            }
        }
        
        function showCredentials() {
            log('🔐 Checking credentials...');
            
            try {
                if (window.supabaseBridge && window.supabaseBridge.isReady()) {
                    const credentials = window.supabaseBridge.getCredentials();
                    log('✅ Credentials loaded:');
                    log('   URL: ' + credentials.url);
                    log('   Key: ' + credentials.anonKey.substring(0, 20) + '...');
                    
                    // Update UI
                    document.getElementById('credentials-info').innerHTML = `
                        <strong>URL:</strong> ${credentials.url}<br>
                        <strong>Key:</strong> ${credentials.anonKey.substring(0, 20)}...
                    `;
                } else {
                    log('❌ Bridge not ready, no credentials available');
                }
            } catch (error) {
                log('❌ Failed to get credentials: ' + error.message);
            }
        }
        
        // Wait for bridge to be ready
        async function waitForBridge() {
            let attempts = 0;
            const maxAttempts = 50; // Wait up to 5 seconds
            
            while (attempts < maxAttempts) {
                if (window.supabaseBridge && window.supabaseBridge.isReady()) {
                    log('✅ Bridge is ready!');
                    return true;
                }
                
                log(`⏳ Waiting for bridge... (attempt ${attempts + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            log('❌ Bridge never became ready after 5 seconds');
            return false;
        }
        
        function log(message) {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `[${timestamp}] ${message}<br>`;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }
        
        function updateBridgeStatus() {
            const statusDiv = document.getElementById('bridge-status');
            
            if (window.supabaseBridge && window.supabaseBridge.isReady()) {
                statusDiv.innerHTML = '<span class="text-success">✅ Bridge Ready</span>';
                statusDiv.className = 'text-success';
            } else {
                statusDiv.innerHTML = '<span class="text-warning">⏳ Bridge Loading...</span>';
                statusDiv.className = 'text-warning';
            }
        }
        
        // Wait for page to load, then check bridge status
        document.addEventListener('DOMContentLoaded', () => {
            log('🚀 Page loaded, checking bridge status...');
            // Check status every second
            setInterval(updateBridgeStatus, 1000);
            
            // Listen for bridge ready event
            window.addEventListener('supabaseReady', () => {
                log('�� Supabase bridge is ready!');
                updateBridgeStatus();
            });
            
            // Initial status check
            updateBridgeStatus();
            
            // Auto-test after a delay
            setTimeout(async () => {
                log('🧪 Auto-testing bridge after delay...');
                await testBridge();
            }, 2000);
        });
    </script>
</body>

</html>